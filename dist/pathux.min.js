"undefined"==typeof window&&"undefined"!=typeof global?global.window=global:"undefined"==typeof window&&"undefined"!=typeof globalThis?globalThis.window=globalThis:"undefined"==typeof window&&"undefined"!=typeof self&&(self.window=self),function(){let t=0;window.destroyAllCSS=function(){t++;let e=i=>{if(i.__visit!==t){if(i.__visit=t,"STYLE"===i.tagName&&(i.textContents=""),i.style)for(let t in i.style)try{i.style[t]=""}catch(t){}if(i.childNodes)for(let t of i.childNodes)e(t)}};e(document.head),e(document.body);for(let t of document.styleSheets)for(let e=0;e<t.rules.length;e++)t.removeRule(t.rules[0])}}(),window.eventDebugModule={start(){window.debugEventLists={},window.debugEventList=[],this._addEventListener=EventTarget.prototype.addEventListener,this._removeEventListener=EventTarget.prototype.removeEventListener,this._dispatchEvent=EventTarget.prototype.dispatchEvent,EventTarget.prototype.addEventListener=this.onadd,EventTarget.prototype.removeEventListener=this.onrem,EventTarget.prototype.dispatchEvent=this.ondispatch},add(t,e){t in debugEventLists||(debugEventLists[t]=[]),debugEventLists[t].push(e)},ondispatch(){let t=arguments;return eventDebugModule.add("Dispatch",{event:t[0],thisvar:t[4],line:t[5],filename:t[6].replace(/\\/g,"/"),filepath:location.origin+t[6].replace(/\\/g,"/")+":"+t[5],ownerpath:t[7]}),eventDebugModule._dispatchEvent.apply(this,arguments)},onadd(){let t=arguments;return eventDebugModule.add("Add",{type:t[0],cb:t[1],args:t[2],thisvar:t[4],line:t[5],filename:t[6].replace(/\\/g,"/"),filepath:location.origin+t[6].replace(/\\/g,"/")+":"+t[5],ownerpath:t[7]}),eventDebugModule._addEventListener.apply(this,arguments)},pruneConnected(){for(let t in debugEventLists){let e=debugEventLists[t];for(let t=0;t<e.length;t++){let i=e[t];i.thisvar&&i.thisvar instanceof Node&&(i.thisvar.isConnected||(e[t]=e[e.length-1],e[e.length-1]=void 0,e.length--,t--))}}},onrem(){let t=arguments;return eventDebugModule.add("Rem",{type:t[0],cb:t[1],args:t[2],thisvar:t[4],line:t[5],filename:t[6].replace(/\\/g,"/"),filepath:location.origin+t[6].replace(/\\/g,"/")+":"+t[5],ownerpath:t[7]}),eventDebugModule._removeEventListener.apply(this,arguments)}},"undefined"!=typeof _debug_event_listeners&&_debug_event_listeners&&eventDebugModule.start(),window._disable_all_listeners&&(console.warn("Disabling all event listeners"),EventTarget.prototype.addEventListener=()=>{},EventSource.prototype.addEventListener=()=>{}),"undefined"==typeof visualViewport&&(window.visualViewport=new class{get width(){return window.innerWidth}get height(){return window.innerHeight}get offsetLeft(){return 0}get offsetTop(){return 0}get pageLeft(){return 0}get pageTop(){return 0}get scale(){return 1}}),void 0===Array.prototype.set&&(Array.prototype.set=function(t){if(0===arguments.length)return;let e,i,s;if(0===arguments.length?(e=0,i=0,s=t.length):1===arguments.length?(s=t.length,e=arguments[1],i=0):2===arguments.length?(e=arguments[1],s=arguments[2]):3===arguments.length&&(e=arguments[1],i=arguments[2],s=arguments[3]),e=void 0===e?0:e,i=void 0===i?0:i,s=void 0===s?t.length:s,s<0)throw new RangeError("Count must be >= zero");let r=Math.min(e+s,t.length)-e;i+r>this.length&&(this.length=i+r);for(let s=0;s<r;s++)this[i+s]=t[e+s];return this},Object.defineProperty(Array.prototype,"set",{enumerable:!1,configurable:!0}),void 0===Float64Array.prototype.set&&(Float64Array.prototype.set=Array.prototype.set,Float32Array.prototype.set=Array.prototype.set,Uint8Array.prototype.set=Array.prototype.set,Uint8ClampedArray.prototype.set=Array.prototype.set,Int32Array.prototype.set=Array.prototype.set,Int16Array.prototype.set=Array.prototype.set,Int8Array.prototype.set=Array.prototype.set)),void 0===Array.prototype.reject&&(Array.prototype.reject=function(t){return this.filter((e=>!t(e)))},Object.defineProperty(Array.prototype,"reject",{enumerable:!1,configurable:!0})),null==window.Symbol?window.Symbol={iterator:"$__iterator__$",keystr:"$__keystr__$"}:void 0===Symbol.keystr&&(Symbol.keystr=Symbol("keystr")),void 0===Math.fract&&(Math.fract=function(t){return t-Math.floor(t)}),void 0===Math.tent&&(Math.tent=function(t){return 1-2*Math.abs(Math.fract(t)-.5)}),void 0===Math.sign&&(Math.sign=function(t){return 2*(t>0)-1}),void 0===Array.prototype.pop_i&&(Array.prototype.pop_i=function(t){if(t<0||t>=this.length)throw new Error("Index out of range");for(;t<this.length;)this[t]=this[t+1],t++;this.length-=1},Object.defineProperty(Array.prototype,"pop_i",{enumerable:!1,configurable:!0})),void 0===Array.prototype.remove&&(Array.prototype.remove=function(t,e){var i=this.indexOf(t);if(i<0){if(!e)throw new Error("Error: item not in array "+t);console.trace("Warning: item not in array",t)}else this.pop_i(i)},Object.defineProperty(Array.prototype,"remove",{enumerable:!1,configurable:!0})),void 0===String.prototype.contains&&(String.prototype.contains=function(t){return String.search(t)>=0}),String.prototype[Symbol.keystr]=function(){return this},Number.prototype[Symbol.keystr]=Boolean.prototype[Symbol.keystr]=function(){return""+this},Array.prototype[Symbol.keystr]=function(){let t="";for(let e of this)t+=e[Symbol.keystr]()+":";return t};let colormap$1={black:30,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,white:37,reset:0,grey:2,orange:202,pink:198,brown:314,lightred:91,peach:210};function tab(t,e=" "){let i="";for(let s=0;s<t;s++)i+=e;return i}let termColorMap$1={};for(let t in colormap$1)termColorMap$1[t]=colormap$1[t],termColorMap$1[colormap$1[t]]=t;function termColor$1(t,e){if(t="symbol"==typeof t?t.toString():""+t,e in colormap$1&&(e=colormap$1[e]),e>107){return"[38;5;"+e+"m"+t+"[0m"}return"["+e+"m"+t+"[0m"}function termPrint$1(){let t="";for(let e=0;e<arguments.length;e++)e>0&&(t+=" "),t+=arguments[e];let e=/\u001b\[[1-9][0-9]?m/,i=/\u001b\[[1-9][0-9];[0-9][0-9]?;[0-9]+m/,s=/\u001b\[0m/,r="[0m";function a(t,e){return{type:e,value:t}}let n=[[e,"start"],[i,"start"],[s,"end"]],o=t,l=[];for(;o.length>0;){let t,e,i,s,r=!1;for(let a of n){let n=o.search(a[0]);n>=0&&(void 0===e||n<e)&&(i=o.slice(n,o.length).match(a[0])[0],e=n,s=a[1],t=a,r=!0)}if(!r)break;if(e>0){let t=o.slice(0,e);l.push(a(t,"chunk"))}o=o.slice(e+i.length,o.length);let h=a(i,s);l.push(h)}o.length>0&&l.push(a(o,"chunk"));let h,c=[],d="";for(let t of l)"chunk"===t.type?d+=t.value:"start"===t.type?(c.push(h),h=t.value,d+=t.value):"end"===t.type&&(h=c.pop(),d+=h||r);return d}function list$3(t){let e=[];for(let i of t)e.push(i);return e}var util$1=Object.freeze({__proto__:null,tab:tab,termColorMap:termColorMap$1,termColor:termColor$1,termPrint:termPrint$1,list:list$3});function print_lines(t,e,i,s,r){let a="",n=t.split("\n"),o=Math.max(e-5,0),l=Math.min(e+3,n.length),h=s?t=>t:termColor$1;for(let t=o;t<l;t++){let s=""+(t+1);for(;s.length<3;)s=" "+s;if(s+=`: ${n[t]}\n`,t===e&&r&&1===r.value.length&&(s=s.slice(0,i+5)+h(s[i+5],"yellow")+s.slice(i+6,s.length)),a+=s,t===e){let t="     ";for(let e=0;e<i;e++)t+=" ";t+=h("^","red"),a+=t+"\n"}}return a="------------------\n"+a+"\n==================\n",a}class token$1{constructor(t,e,i,s,r,a,n){this.type=t,this.value=e,this.lexpos=i,this.lineno=s,this.col=n,this.lexer=r,this.parser=a}toString(){return void 0!==this.value?"token(type="+this.type+", value='"+this.value+"')":"token(type="+this.type+")"}}class tokdef$1{constructor(t,e,i,s){if(this.name=t,this.re=e,this.func=i,this.example=s,void 0===s&&e){let t=""+e;t.startsWith("/")&&t.endsWith("/")&&(t=t.slice(1,t.length-1)),t.startsWith("\\")&&(t=t.slice(1,t.length)),t=t.trim(),1===t.length&&(this.example=t)}}}class PUTIL_ParseError extends Error{constructor(t){super()}}class lexer$2{constructor(t,e){this.tokdef=t,this.tokens=new Array,this.lexpos=0,this.lexdata="",this.colmap=void 0,this.lineno=0,this.printTokens=!1,this.linestart=0,this.errfunc=e,this.linemap=void 0,this.tokints={};for(let e=0;e<t.length;e++)this.tokints[t[e].name]=e;this.statestack=[["__main__",0]],this.states={__main__:[t,e]},this.statedata=0,this.logger=function(){console.log(...arguments)}}add_state(t,e,i){void 0===i&&(i=function(t){return!0}),this.states[t]=[e,i]}tok_int(t){}push_state(t,e){this.statestack.push([t,e]),t=this.states[t],this.statedata=e,this.tokdef=t[0],this.errfunc=t[1]}pop_state(){let t=this.statestack[this.statestack.length-1],e=this.states[t[0]];this.tokdef=e[0],this.errfunc=e[1],this.statedata=t[1]}input(t){let e=this.linemap=new Array(t.length),i=0,s=0,r=this.colmap=new Array(t.length);for(let a=0;a<t.length;a++,s++){let n=t[a];e[a]=i,r[a]=s,"\n"===n&&(i++,s=0)}for(;this.statestack.length>1;)this.pop_state();this.lexdata=t,this.lexpos=0,this.lineno=0,this.tokens=new Array,this.peeked_tokens=[]}error(){if(void 0!==this.errfunc&&!this.errfunc(this))return;let t=Math.min(this.lexpos,this.lexdata.length-1),e=this.linemap[t],i=this.colmap[t],s=print_lines(this.lexdata,e,i,!0);this.logger("  "+s),this.logger("Syntax error near line "+(this.lineno+1));Math.min(this.lexpos+8,this.lexdata.length);throw new PUTIL_ParseError("Parse error")}peek(){let t=this.next(!0);if(void 0!==t)return this.peeked_tokens.push(t),t}peeknext(){return this.peeked_tokens.length>0?this.peeked_tokens[0]:this.peek()}at_end(){return this.lexpos>=this.lexdata.length&&0===this.peeked_tokens.length}next(t){if(!t&&this.peeked_tokens.length>0){let e=this.peeked_tokens[0];return this.peeked_tokens.shift(),!t&&this.printTokens&&this.logger(""+e),e}if(this.lexpos>=this.lexdata.length)return;let e=this.tokdef,i=e.length,s=this.lexdata.slice(this.lexpos,this.lexdata.length),r=[];for(var a=0;a<i;a++){let t=e[a];if(void 0===t.re)continue;let i=t.re.exec(s);null!=i&&0===i.index&&r.push([t,i])}let n,o=0;for(a=0;a<r.length;a++){let t=r[a];t[1][0].length>o&&(n=t,o=t[1][0].length)}if(void 0===n)return void this.error();let l=n[0],h=this.colmap[Math.min(this.lexpos,this.lexdata.length-1)];this.lexpos<this.lexdata.length&&(this.lineno=this.linemap[this.lexpos]);let c=new token$1(l.name,n[1][0],this.lexpos,this.lineno,this,void 0,h);return this.lexpos+=c.value.length,l.func&&(c=l.func(c),void 0===c)?this.next():(!t&&this.printTokens&&this.logger(""+c),c)}}class parser$1{constructor(t,e){this.lexer=t,this.errfunc=e,this.start=void 0,this.logger=function(){console.log(...arguments)}}parse(t,e){void 0===e&&(e=!0),void 0!==t&&this.lexer.input(t);let i=this.start(this);return e&&!this.lexer.at_end()&&void 0!==this.lexer.next()&&this.error(void 0,"parser did not consume entire input"),i}input(t){this.lexer.input(t)}error(t,e){let i;void 0===e&&(e=""),i=void 0===t?"Parse error at end of input: "+e:`Parse error at line ${t.lineno+1}:${t.col+1}: ${e}`;let s=this.lexer.lexdata,r=t?t.lineno:this.lexer.linemap[this.lexer.linemap.length-1],a=t?t.col:0;if(s=s.replace(/\r/g,""),this.logger(print_lines(s,r,a,!0,t)),this.logger(i),!this.errfunc||this.errfunc(t))throw new PUTIL_ParseError(i)}peek(){let t=this.lexer.peek();return void 0!==t&&(t.parser=this),t}peeknext(){let t=this.lexer.peeknext();return void 0!==t&&(t.parser=this),t}next(){let t=this.lexer.next();return void 0!==t&&(t.parser=this),t}optional(t){let e=this.peeknext();return void 0!==e&&(e.type===t&&(this.next(),!0))}at_end(){return this.lexer.at_end()}expect(t,e){let i=this.next();if(void 0===e){e=t;for(let i of this.lexer.tokdef)i.name===t&&i.example&&(e=i.example)}return void 0!==i&&i.type===t||this.error(i,"Expected "+e),i.value}}function test_parser$1(){let t=new Set(["int","float","double","vec2","vec3","vec4","mat4","string"]),e=new Set(["int","float","double","vec2","vec3","vec4","mat4","string","static_string","array"]);function i(t,e,i){return new tokdef$1(t,e,i)}let s=[i("ID",/[a-zA-Z]+[a-zA-Z0-9_]*/,(function(t){return e.has(t.value)&&(t.type=t.value.toUpperCase()),t})),i("OPEN",/\{/),i("CLOSE",/}/),i("COLON",/:/),i("JSCRIPT",/\|/,(function(t){let e="",i=t.lexer;for(;i.lexpos<i.lexdata.length;){let t=i.lexdata[i.lexpos];if("\n"===t)break;e+=t,i.lexpos++}return e.endsWith(";")&&(e=e.slice(0,e.length-1),i.lexpos--),t.value=e,t})),i("LPARAM",/\(/),i("RPARAM",/\)/),i("COMMA",/,/),i("NUM",/[0-9]/),i("SEMI",/;/),i("NEWLINE",/\n/,(function(t){t.lexer.lineno+=1})),i("SPACE",/ |\t/,(function(t){}))];for(let t of e)s.push(i(t.toUpperCase()));let r="\n  Loop {\n    eid : int;\n    flag : int;\n    index : int;\n    type : int;\n\n    co : vec3;\n    no : vec3;\n    loop : int | eid(loop);\n    edges : array(e, int) | e.eid;\n\n    loops :, array(Loop);\n  }\n  ";let a,n=new lexer$2(s,(function(t){return!0}));for(console.log("Testing lexical scanner..."),n.input(r);a=n.next();)console.log(a.toString());let o=new parser$1(n);function l(e){let i=e.peek();return"ID"===i.type?(e.next(),{type:"struct",data:'"'+i.value+'"'}):t.has(i.type.toLowerCase())?(e.next(),{type:i.type.toLowerCase()}):"ARRAY"===i.type?function(t){t.expect("ARRAY"),t.expect("LPARAM");let e=l(t),i="";return t.optional("COMMA")&&(i=e,e=l(t)),t.expect("RPARAM"),{type:"array",data:{type:e,iname:i}}}(e):void e.error(i,"invalid type "+i.type)}function h(t){let e={};console.log("-----",t.peek().type),e.name=t.expect("ID","struct field name"),t.expect("COLON"),e.type=l(t),e.set=void 0,e.get=void 0;let i=t.peek();return"JSCRIPT"===i.type&&(e.get=i.value,t.next()),i=t.peek(),"JSCRIPT"===i.type&&(e.set=i.value,t.next()),t.expect("SEMI"),e}o.input(r);let c=function(t){let e={};for(e.name=t.expect("ID","struct name"),e.fields=[],t.expect("OPEN");;)if(t.at_end())t.error(void 0);else{if(t.optional("CLOSE"))break;e.fields.push(h(t))}return e}(o);console.log(JSON.stringify(c))}var struct_parseutil=Object.freeze({__proto__:null,token:token$1,tokdef:tokdef$1,PUTIL_ParseError:PUTIL_ParseError,lexer:lexer$2,parser:parser$1});class NStruct{constructor(t){this.fields=[],this.id=-1,this.name=t}}const StructEnum={INT:0,FLOAT:1,DOUBLE:2,STRING:7,STATIC_STRING:8,STRUCT:9,TSTRUCT:10,ARRAY:11,ITER:12,SHORT:13,BYTE:14,BOOL:15,ITERKEYS:16,UINT:17,USHORT:18,STATIC_ARRAY:19,SIGNED_BYTE:20,OPTIONAL:21},ArrayTypes=new Set([StructEnum.STATIC_ARRAY,StructEnum.ARRAY,StructEnum.ITERKEYS,StructEnum.ITER]),ValueTypes=new Set([StructEnum.INT,StructEnum.FLOAT,StructEnum.DOUBLE,StructEnum.STRING,StructEnum.STATIC_STRING,StructEnum.SHORT,StructEnum.BYTE,StructEnum.BOOL,StructEnum.UINT,StructEnum.USHORT,StructEnum.SIGNED_BYTE]);let StructTypes={int:StructEnum.INT,uint:StructEnum.UINT,ushort:StructEnum.USHORT,float:StructEnum.FLOAT,double:StructEnum.DOUBLE,string:StructEnum.STRING,static_string:StructEnum.STATIC_STRING,struct:StructEnum.STRUCT,abstract:StructEnum.TSTRUCT,array:StructEnum.ARRAY,iter:StructEnum.ITER,short:StructEnum.SHORT,byte:StructEnum.BYTE,bool:StructEnum.BOOL,iterkeys:StructEnum.ITERKEYS,sbyte:StructEnum.SIGNED_BYTE,optional:StructEnum.OPTIONAL},StructTypeMap={};for(let t in StructTypes)StructTypeMap[StructTypes[t]]=t;function gen_tabstr$2(t){let e="";for(let i=0;i<t;i++)e+="  ";return e}function stripComments(t){let e="";let i,s=new Set(["'",'"',"`"]),r=0,a=!1;for(let n=0;n<t.length;n++){n>0&&t[n-1];let o=t[n],l=n<t.length-1?t[n+1]:void 0;switch(r){case 0:if("/"===o&&"/"===l){r=1;continue}s.has(o)&&(i=o,r=2),e+=o;break;case 1:"\n"===l&&(r=0);break;case 2:o!==i||a||(r=0),e+=o}"\\"===o?a^=!0:a=!1}return e}function StructParser(){let t=new Set(["int","float","double","string","short","byte","sbyte","bool","uint","ushort"]),e=new Set(["int","float","double","string","static_string","array","iter","abstract","short","byte","sbyte","bool","iterkeys","uint","ushort","static_array","optional"]);function i(t,e,i){return new tokdef$1(t,e,i)}let s=[i("ID",/[a-zA-Z_$]+[a-zA-Z0-9_\.$]*/,(function(t){return e.has(t.value)&&(t.type=t.value.toUpperCase()),t})),i("OPEN",/\{/),i("EQUALS",/=/),i("CLOSE",/}/),i("STRLIT",/\"[^"]*\"/,(t=>(t.value=t.value.slice(1,t.value.length-1),t))),i("STRLIT",/\'[^']*\'/,(t=>(t.value=t.value.slice(1,t.value.length-1),t))),i("COLON",/:/),i("OPT_COLON",/\?:/),i("SOPEN",/\[/),i("SCLOSE",/\]/),i("JSCRIPT",/\|/,(function(t){let e,i="",s=t.lexer;for(;s.lexpos<s.lexdata.length;){let t=s.lexdata[s.lexpos];if("\n"===t)break;if("/"===t&&"/"===e){i=i.slice(0,i.length-1),s.lexpos--;break}i+=t,s.lexpos++,e=t}for(;i.trim().endsWith(";");)i=i.slice(0,i.length-1),s.lexpos--;return t.value=i.trim(),t})),i("COMMENT",/\/\/.*[\n\r]/),i("LPARAM",/\(/),i("RPARAM",/\)/),i("COMMA",/,/),i("NUM",/[0-9]+/,void 0),i("SEMI",/;/),i("NEWLINE",/\n/,(function(t){t.lexer.lineno+=1})),i("SPACE",/ |\t/,(function(t){}))];e.forEach((function(t){s.push(i(t.toUpperCase()))}));let r=new class extends lexer$2{input(t){return super.input(t)}}(s,(function(t){return!0})),a=new parser$1(r);function n(e){let i=e.peeknext();return"ID"===i.type?(e.next(),{type:StructEnum.STRUCT,data:i.value}):t.has(i.type.toLowerCase())?(e.next(),{type:StructTypes[i.type.toLowerCase()]}):"ARRAY"===i.type?function(t){t.expect("ARRAY"),t.expect("LPARAM");let e=n(t),i="";return t.optional("COMMA")&&(i=e.data.replace(/"/g,""),e=n(t)),t.expect("RPARAM"),{type:StructEnum.ARRAY,data:{type:e,iname:i}}}(e):"ITER"===i.type?function(t){t.expect("ITER"),t.expect("LPARAM");let e=n(t),i="";return t.optional("COMMA")&&(i=e.data.replace(/"/g,""),e=n(t)),t.expect("RPARAM"),{type:StructEnum.ITER,data:{type:e,iname:i}}}(e):"ITERKEYS"===i.type?function(t){t.expect("ITERKEYS"),t.expect("LPARAM");let e=n(t),i="";return t.optional("COMMA")&&(i=e.data.replace(/"/g,""),e=n(t)),t.expect("RPARAM"),{type:StructEnum.ITERKEYS,data:{type:e,iname:i}}}(e):"STATIC_ARRAY"===i.type?function(t){t.expect("STATIC_ARRAY"),t.expect("SOPEN");let e=n(t),i="";t.expect("COMMA");let s=t.expect("NUM");return(s<0||Math.abs(s-Math.floor(s))>1e-6)&&(console.log(Math.abs(s-Math.floor(s))),t.error("Expected an integer")),s=Math.floor(s),t.optional("COMMA")&&(i=n(t).data),t.expect("SCLOSE"),{type:StructEnum.STATIC_ARRAY,data:{type:e,size:s,iname:i}}}(e):"STATIC_STRING"===i.type?function(t){t.expect("STATIC_STRING"),t.expect("SOPEN");let e=t.expect("NUM");return t.expect("SCLOSE"),{type:StructEnum.STATIC_STRING,data:{maxlength:e}}}(e):"ABSTRACT"===i.type?function(t){t.expect("ABSTRACT"),t.expect("LPARAM");let e=t.expect("ID"),i="_structName";return t.optional("COMMA")&&(i=t.expect("STRLIT")),t.expect("RPARAM"),{type:StructEnum.TSTRUCT,data:e,jsonKeyword:i}}(e):"DATAREF"===i.type?function(t){t.expect("DATAREF"),t.expect("LPARAM");let e=t.expect("ID");return t.expect("RPARAM"),{type:StructEnum.DATAREF,data:e}}(e):"OPTIONAL"===i.type?function(t){t.expect("OPTIONAL"),t.expect("LPARAM");const e=n(t);return t.expect("RPARAM"),{type:StructEnum.OPTIONAL,data:e}}(e):void e.error(i,"invalid type "+i.type)}function o(t){let e={};e.name=function(t){let e=t.peeknext();return"NUM"===e.type?(t.next(),e.value):t.expect("ID","struct field name")}(t);let i=!1;"OPT_COLON"===t.peeknext().type?(t.expect("OPT_COLON"),i=!0):t.expect("COLON"),e.type=n(t),i&&(e.type={type:StructEnum.OPTIONAL,data:e.type}),e.set=void 0,e.get=void 0;let s=0,r=t.peeknext();return r&&"JSCRIPT"===r.type&&(e.get=r.value,s=1,t.next(),r=t.peeknext()),r&&"JSCRIPT"===r.type&&(s=1,e.set=r.value,t.next()),t.expect("SEMI"),r=t.peeknext(),r&&"COMMENT"===r.type?(e.comment=r.value,t.next()):e.comment="",e}return a.start=function(t){let e=t.expect("ID","struct name"),i=new NStruct(e),s=t.peeknext();for("ID"===s.type&&"id"===s.value&&(t.next(),t.expect("EQUALS"),i.id=t.expect("NUM")),t.expect("OPEN");;)if(t.at_end())t.error(void 0);else{if(t.optional("CLOSE"))break;i.fields.push(o(t))}return i},a}const struct_parse=StructParser();var struct_parser=Object.freeze({__proto__:null,NStruct:NStruct,StructEnum:StructEnum,ArrayTypes:ArrayTypes,ValueTypes:ValueTypes,StructTypes:StructTypes,StructTypeMap:StructTypeMap,stripComments:stripComments,struct_parse:struct_parse}),struct_typesystem=Object.freeze({__proto__:null}),STRUCT_ENDIAN=!0;function setBinaryEndian(t){STRUCT_ENDIAN=!!t}let temp_dataview=new DataView(new ArrayBuffer(16)),uint8_view=new Uint8Array(temp_dataview.buffer);class unpack_context{constructor(){this.i=0}}function pack_byte(t,e){t.push(e)}function pack_sbyte(t,e){e<0&&(e=256+e),t.push(e)}function pack_bytes(t,e){for(let i=0;i<e.length;i++)t.push(e[i])}function pack_int(t,e){temp_dataview.setInt32(0,e,STRUCT_ENDIAN),t.push(uint8_view[0]),t.push(uint8_view[1]),t.push(uint8_view[2]),t.push(uint8_view[3])}function pack_uint(t,e){temp_dataview.setUint32(0,e,STRUCT_ENDIAN),t.push(uint8_view[0]),t.push(uint8_view[1]),t.push(uint8_view[2]),t.push(uint8_view[3])}function pack_ushort(t,e){temp_dataview.setUint16(0,e,STRUCT_ENDIAN),t.push(uint8_view[0]),t.push(uint8_view[1])}function pack_float(t,e){temp_dataview.setFloat32(0,e,STRUCT_ENDIAN),t.push(uint8_view[0]),t.push(uint8_view[1]),t.push(uint8_view[2]),t.push(uint8_view[3])}function pack_double(t,e){temp_dataview.setFloat64(0,e,STRUCT_ENDIAN),t.push(uint8_view[0]),t.push(uint8_view[1]),t.push(uint8_view[2]),t.push(uint8_view[3]),t.push(uint8_view[4]),t.push(uint8_view[5]),t.push(uint8_view[6]),t.push(uint8_view[7])}function pack_short(t,e){temp_dataview.setInt16(0,e,STRUCT_ENDIAN),t.push(uint8_view[0]),t.push(uint8_view[1])}function encode_utf8(t,e){for(let i=0;i<e.length;i++){let s=e.charCodeAt(i);for(;0!==s;){let e=127&s;s>>=7,0!==s&&(e|=128),t.push(e)}}}function decode_utf8(t){let e="",i=0;for(;i<t.length;){let s=t[i],r=127&s,a=0;for(;i<t.length&&128&s;)a+=7,i++,s=t[i],s=(127&s)<<a,r|=s;if(0===r)break;e+=String.fromCharCode(r),i++}return e}function test_utf8(){let t="a"+String.fromCharCode(8800)+"b",e=[];if(encode_utf8(e,t),t!==decode_utf8(e))throw new Error("UTF-8 encoding/decoding test failed");return!0}function truncate_utf8(t,e){let i=Math.min(t.length,e),s=0,r=0,a=!1,n=0;for(;n<i;)a=128&t[n],a||(r=s+1,s=n+1),n++;return t.length=s<e?s:r,t}let _static_sbuf_ss=new Array(2048);function pack_static_string(t,e,i){if(void 0===i)throw new Error("'length' paremter is not optional for pack_static_string()");let s=i<2048?_static_sbuf_ss:new Array;s.length=0,encode_utf8(s,e),truncate_utf8(s,i);for(let e=0;e<i;e++)e>=s.length?t.push(0):t.push(s[e])}let _static_sbuf=new Array(32);function pack_string(t,e){_static_sbuf.length=0,encode_utf8(_static_sbuf,e),pack_int(t,_static_sbuf.length);for(let e=0;e<_static_sbuf.length;e++)t.push(_static_sbuf[e])}function unpack_bytes(t,e,i){let s=new DataView(t.buffer.slice(e.i,e.i+i));return e.i+=i,s}function unpack_byte(t,e){return t.getUint8(e.i++)}function unpack_sbyte(t,e){return t.getInt8(e.i++)}function unpack_int(t,e){return e.i+=4,t.getInt32(e.i-4,STRUCT_ENDIAN)}function unpack_uint(t,e){return e.i+=4,t.getUint32(e.i-4,STRUCT_ENDIAN)}function unpack_ushort(t,e){return e.i+=2,t.getUint16(e.i-2,STRUCT_ENDIAN)}function unpack_float(t,e){return e.i+=4,t.getFloat32(e.i-4,STRUCT_ENDIAN)}function unpack_double(t,e){return e.i+=8,t.getFloat64(e.i-8,STRUCT_ENDIAN)}function unpack_short(t,e){return e.i+=2,t.getInt16(e.i-2,STRUCT_ENDIAN)}let _static_arr_us=new Array(32);function unpack_string(t,e){let i=unpack_int(t,e);if(!i)return"";let s=i<2048?_static_arr_us:new Array(i);s.length=i;for(let r=0;r<i;r++)s[r]=unpack_byte(t,e);return decode_utf8(s)}let _static_arr_uss=new Array(2048);function unpack_static_string(t,e,i){if(void 0===i)throw new Error("'length' cannot be undefined in unpack_static_string()");let s=i<2048?_static_arr_uss:new Array(i);s.length=0;let r=!1;for(let a=0;a<i;a++){let i=unpack_byte(t,e);0===i&&(r=!0),r||0===i||s.push(i)}return truncate_utf8(s,i),decode_utf8(s)}var struct_binpack=Object.freeze({__proto__:null,get STRUCT_ENDIAN(){return STRUCT_ENDIAN},setBinaryEndian:setBinaryEndian,temp_dataview:temp_dataview,uint8_view:uint8_view,unpack_context:unpack_context,pack_byte:pack_byte,pack_sbyte:pack_sbyte,pack_bytes:pack_bytes,pack_int:pack_int,pack_uint:pack_uint,pack_ushort:pack_ushort,pack_float:pack_float,pack_double:pack_double,pack_short:pack_short,encode_utf8:encode_utf8,decode_utf8:decode_utf8,test_utf8:test_utf8,pack_static_string:pack_static_string,pack_string:pack_string,unpack_bytes:unpack_bytes,unpack_byte:unpack_byte,unpack_sbyte:unpack_sbyte,unpack_int:unpack_int,unpack_uint:unpack_uint,unpack_ushort:unpack_ushort,unpack_float:unpack_float,unpack_double:unpack_double,unpack_short:unpack_short,unpack_string:unpack_string,unpack_static_string:unpack_static_string});let warninglvl$1=2,debug$1=0,_static_envcode_null$1="",packer_debug$1,packer_debug_start$1,packer_debug_end$1,packdebug_tablevel=0;function _get_pack_debug(){return{packer_debug:packer_debug$1,packer_debug_start:packer_debug_start$1,packer_debug_end:packer_debug_end$1,debug:debug$1,warninglvl:warninglvl$1}}class cachering$1 extends Array{constructor(t,e){super(),this.length=e,this.cur=0;for(let i=0;i<e;i++)this[i]=t()}static fromConstructor(t,e){return new cachering$1((()=>new t),e)}next(){let t=this[this.cur];return this.cur=(this.cur+1)%this.length,t}}function gen_tabstr$1(t){let e="";for(let i=0;i<t;i++)e+=" ";return e}function setWarningMode2(t){if("number"!=typeof t||isNaN(t))throw new Error("Expected a single number (>= 0) argument to setWarningMode");warninglvl$1=t}function setDebugMode2(t){debug$1=t,debug$1?(packer_debug$1=function(){let t=gen_tabstr$1(packdebug_tablevel);arguments.length>0?console.warn(t,...arguments):console.warn("Warning: undefined msg")},packer_debug_start$1=function(t){packer_debug$1("Start "+t),packdebug_tablevel++},packer_debug_end$1=function(t){packdebug_tablevel--,t&&packer_debug$1("Leave "+t)}):(packer_debug$1=function(){},packer_debug_start$1=function(){},packer_debug_end$1=function(){})}setDebugMode2(debug$1);const StructFieldTypes=[],StructFieldTypeMap={};function packNull(t,e,i,s){StructFieldTypeMap[s.type].packNull(t,e,i,s)}function toJSON(t,e,i,s,r){return StructFieldTypeMap[r.type].toJSON(t,e,i,s,r)}function fromJSON(t,e,i,s,r,a){return StructFieldTypeMap[r.type].fromJSON(t,e,i,s,r,a)}function formatJSON$1(t,e,i,s,r,a,n=0){return StructFieldTypeMap[r.type].formatJSON(t,e,i,s,r,a,n)}function validateJSON$1(t,e,i,s,r,a,n){return StructFieldTypeMap[r.type].validateJSON(t,e,i,s,r,a,n)}function unpack_field(t,e,i,s){let r;debug$1&&(r=StructFieldTypeMap[i.type].define().name,packer_debug_start$1("R "+r));let a=StructFieldTypeMap[i.type].unpack(t,e,i,s);return debug$1&&packer_debug_end$1(),a}let fakeFields=new cachering$1((()=>({type:void 0,get:void 0,set:void 0})),256);function fmt_type(t){return StructFieldTypeMap[t.type].format(t)}function do_pack(t,e,i,s,r,a){let n;debug$1&&(n=StructFieldTypeMap[a.type].define().name,packer_debug_start$1("W "+n));let o=a;"number"!=typeof o&&(o=o.type);let l=StructFieldTypeMap[o].pack(t,e,i,s,r,a);return debug$1&&packer_debug_end$1(),l}let _ws_env$1=[[void 0,void 0]];class StructFieldType{static pack(t,e,i,s,r,a){}static unpack(t,e,i,s){}static packNull(t,e,i,s){this.pack(t,e,0,0,i,s)}static format(t){return this.define().name}static toJSON(t,e,i,s,r){return e}static fromJSON(t,e,i,s,r,a){return e}static formatJSON(t,e,i,s,r,a,n){return JSON.stringify(e)}static validateJSON(t,e,i,s,r,a,n){return!0}static useHelperJS(t){return!0}static define(){return{type:-1,name:"(error)"}}static register(t){if(StructFieldTypes.indexOf(t)>=0)throw new Error("class already registered");if(t.define===StructFieldType.define)throw new Error("you forgot to make a define() static method");if(void 0===t.define().type)throw new Error("cls.define().type was undefined!");if(t.define().type in StructFieldTypeMap)throw new Error("type "+t.define().type+" is used by another StructFieldType subclass");StructFieldTypes.push(t),StructFieldTypeMap[t.define().type]=t}}class StructIntField extends StructFieldType{static pack(t,e,i,s,r,a){pack_int(e,i)}static unpack(t,e,i,s){return unpack_int(e,s)}static validateJSON(t,e,i,s,r,a){return"number"==typeof e&&e===Math.floor(e)||e+" is not an integer"}static define(){return{type:StructEnum.INT,name:"int"}}}StructFieldType.register(StructIntField);class StructFloatField extends StructFieldType{static pack(t,e,i,s,r,a){pack_float(e,i)}static unpack(t,e,i,s){return unpack_float(e,s)}static validateJSON(t,e,i,s,r,a,n){return"number"==typeof e||"Not a float: "+e}static define(){return{type:StructEnum.FLOAT,name:"float"}}}StructFieldType.register(StructFloatField);class StructDoubleField extends StructFieldType{static pack(t,e,i,s,r,a){pack_double(e,i)}static unpack(t,e,i,s){return unpack_double(e,s)}static validateJSON(t,e,i,s,r,a){return"number"==typeof e||"Not a double: "+e}static define(){return{type:StructEnum.DOUBLE,name:"double"}}}StructFieldType.register(StructDoubleField);class StructStringField extends StructFieldType{static pack(t,e,i,s,r,a){pack_string(e,i=i||"")}static validateJSON(t,e,i,s,r,a){return"string"==typeof e||"Not a string: "+e}static packNull(t,e,i,s){this.pack(t,e,"",0,i,s)}static unpack(t,e,i,s){return unpack_string(e,s)}static define(){return{type:StructEnum.STRING,name:"string"}}}StructFieldType.register(StructStringField);class StructStaticStringField extends StructFieldType{static pack(t,e,i,s,r,a){pack_static_string(e,i=i||"",a.data.maxlength)}static validateJSON(t,e,i,s,r,a){return"string"!=typeof e?"Not a string: "+e:!(e.length>r.data.maxlength)||"String is too big; limit is "+r.data.maxlength+"; string:"+e}static format(t){return`static_string[${t.data.maxlength}]`}static packNull(t,e,i,s){this.pack(t,e,"",0,i,s)}static unpack(t,e,i,s){return unpack_static_string(e,s,i.data.maxlength)}static define(){return{type:StructEnum.STATIC_STRING,name:"static_string"}}}StructFieldType.register(StructStaticStringField);class StructStructField extends StructFieldType{static pack(t,e,i,s,r,a){let n=t.get_struct(a.data);packer_debug$1("struct",n.name),t.write_struct(e,i,n)}static validateJSON(t,e,i,s,r,a,n){let o=t.get_struct(r.data);return e?t.validateJSONIntern(e,o,n):"Expected "+o.name+" object"}static format(t){return t.data}static fromJSON(t,e,i,s,r,a){let n=t.get_struct(r.data);return t.readJSON(e,n,a)}static formatJSON(t,e,i,s,r,a,n){let o=t.get_struct(r.data);return t.formatJSON_intern(e,o,s,n)}static toJSON(t,e,i,s,r){let a=t.get_struct(r.data);return t.writeJSON(e,a)}static unpackInto(t,e,i,s,r){let a=t.get_struct_cls(i.data);return packer_debug$1("struct",a?a.name:"(error)"),t.read_object(e,a,s,r)}static packNull(t,e,i,s){let r=t.get_struct(s.data);packer_debug$1("struct",s);for(let i of r.fields){packNull(t,e,i,i.type)}}static unpack(t,e,i,s){let r=t.get_struct_cls(i.data);return packer_debug$1("struct",r?r.name:"(error)"),t.read_object(e,r,s)}static define(){return{type:StructEnum.STRUCT,name:"struct"}}}StructFieldType.register(StructStructField);class StructTStructField extends StructFieldType{static pack(t,e,i,s,r,a){let n=t.get_struct_cls(a.data),o=t.get_struct(a.data);t.constructor.keywords;if(i.constructor.structName!==a.data&&i instanceof n)o=t.get_struct(i.constructor.structName);else{if(i.constructor.structName!==a.data)throw console.trace(),new Error("Bad struct "+i.constructor.structName+" passed to write_struct");o=t.get_struct(a.data)}packer_debug$1("int "+o.id),pack_int(e,o.id),t.write_struct(e,i,o)}static validateJSON(t,e,i,s,r,a,n){let o=r.jsonKeyword;if("object"!=typeof e)return typeof e+" is not an object";let l=t.get_struct(e[o]),h=t.get_struct_cls(l.name),c=t.get_struct_cls(r.data),d=!1;do{if(h===c){d=!0;break}h=h.prototype.__proto__.constructor}while(h&&h!==Object);return d?t.validateJSONIntern(e,l,r.jsonKeyword):l.name+" is not a child class off "+r.data}static fromJSON(t,e,i,s,r,a){let n=r.jsonKeyword,o=t.get_struct(e[n]);return t.readJSON(e,o,a)}static formatJSON(t,e,i,s,r,a,n){let o=r.jsonKeyword,l=t.get_struct(e[o]);return t.formatJSON_intern(e,l,s,n)}static toJSON(t,e,i,s,r){t.constructor.keywords;let a=t.get_struct(e.constructor.structName),n=t.writeJSON(e,a);return n[r.jsonKeyword]=""+a.name,n}static packNull(t,e,i,s){pack_int(e,t.get_struct(s.data).id),packNull(t,e,i,{type:StructEnum.STRUCT,data:s.data})}static format(t){return"abstract("+t.data+")"}static unpackInto(t,e,i,s,r){let a=unpack_int(e,s);if(packer_debug$1("-int "+a),!(a in t.struct_ids))throw packer_debug$1("tstruct id: "+a),console.trace(),console.log(a),console.log(t.struct_ids),new Error("Unknown struct type "+a+".");let n=t.get_struct_id(a);return packer_debug$1("struct name: "+n.name),n=t.struct_cls[n.name],t.read_object(e,n,s,r)}static unpack(t,e,i,s){let r=unpack_int(e,s);if(packer_debug$1("-int "+r),!(r in t.struct_ids))throw packer_debug$1("tstruct id: "+r),console.trace(),console.log(r),console.log(t.struct_ids),new Error("Unknown struct type "+r+".");let a=t.get_struct_id(r);return packer_debug$1("struct name: "+a.name),a=t.struct_cls[a.name],t.read_object(e,a,s)}static define(){return{type:StructEnum.TSTRUCT,name:"tstruct"}}}function formatArrayJson(t,e,i,s,r,a,n,o,l=e){if(null==l||"object"!=typeof l||!l[Symbol.iterator])throw console.log(i),console.log(l),new Error(`Expected an array for ${s.name}`);if(ValueTypes.has(a.type))return JSON.stringify(l);let h="[";t.formatCtx.addComments&&s.comment.trim()&&(h+=" "+s.comment.trim()),h+="\n";for(let i=0;i<l.length;i++){let r=l[i];h+=tab(o+1)+formatJSON$1(t,r,e,s,a,n,o+1)+",\n"}return h+=tab(o)+"]",h}StructFieldType.register(StructTStructField);class StructArrayField extends StructFieldType{static pack(t,e,i,s,r,a){if(void 0===i)return console.trace(),console.log("Undefined array fed to struct struct packer!"),console.log("Field: ",r),console.log("Type: ",a),console.log(""),packer_debug$1("int 0"),void pack_int(e,0);packer_debug$1("int "+i.length),pack_int(e,i.length);let n=a.data,o=n.iname,l=n.type,h=_ws_env$1;for(let a=0;a<i.length;a++){let n=i[a];""!==o&&void 0!==o&&r.get&&(h[0][0]=o,h[0][1]=n,n=t._env_call(r.get,s,h));let c=fakeFields.next();c.type=l,do_pack(t,e,n,s,c,l)}}static packNull(t,e,i,s){pack_int(e,0)}static format(t){return""!==t.data.iname&&void 0!==t.data.iname?"array("+t.data.iname+", "+fmt_type(t.data.type)+")":"array("+fmt_type(t.data.type)+")"}static useHelperJS(t){return!t.type.data.iname}static validateJSON(t,e,i,s,r,a,n){if(!e)return"not an array: "+e;for(let i=0;i<e.length;i++){let a=validateJSON$1(t,e[i],e,s,r.data.type,void 0,n);if("string"==typeof a||!a)return a}return!0}static fromJSON(t,e,i,s,r,a){let n=a||[];n.length=0;for(let i=0;i<e.length;i++){let a=fromJSON(t,e[i],e,s,r.data.type,void 0);void 0===a&&(console.log(a),console.error("eeek"),process.exit()),n.push(a)}return n}static formatJSON(t,e,i,s,r,a,n){return formatArrayJson(t,e,i,s,r,r.data.type,a,n)}static toJSON(t,e,i,s,r){e=e||[];let a=[],n=r.data.iname;for(let o=0;o<e.length;o++){let l=e[o],h=_ws_env$1;""!==n&&void 0!==n&&s.get&&(h[0][0]=n,h[0][1]=l,l=t._env_call(s.get,i,h)),a.push(toJSON(t,l,e,s,r.data.type))}return a}static unpackInto(t,e,i,s,r){let a=unpack_int(e,s);r.length=0;for(let n=0;n<a;n++)r.push(unpack_field(t,e,i.data.type,s))}static unpack(t,e,i,s){let r=unpack_int(e,s);packer_debug$1("-int "+r);let a=new Array(r);for(let n=0;n<r;n++)a[n]=unpack_field(t,e,i.data.type,s);return a}static define(){return{type:StructEnum.ARRAY,name:"array"}}}StructFieldType.register(StructArrayField);class StructIterField extends StructFieldType{static pack(t,e,i,s,r,a){let n=e.length;e.length+=4;let o=a.data,l=o.iname,h=o.type,c=_ws_env$1,d=0;!function(t,e){if(i&&i[Symbol.iterator])for(let s of i)t.call(e,s);else i&&i.forEach?i.forEach((function(i){t.call(e,i)})):(console.trace(),console.log("Undefined iterable list fed to struct struct packer!",i),console.log("Field: ",r),console.log("Type: ",a),console.log(""))}((function(i){""!==l&&void 0!==l&&r.get&&(c[0][0]=l,c[0][1]=i,i=t._env_call(r.get,s,c));let a=fakeFields.next();a.type=h,do_pack(t,e,i,s,a,h),d++}),this),temp_dataview.setInt32(0,d,STRUCT_ENDIAN),e[n++]=uint8_view[0],e[n++]=uint8_view[1],e[n++]=uint8_view[2],e[n++]=uint8_view[3]}static formatJSON(t,e,i,s,r,a,n){return formatArrayJson(t,e,i,s,r,r.data.type,a,n,list$3(e))}static validateJSON(t,e,i,s,r,a){return StructArrayField.validateJSON(...arguments)}static fromJSON(){return StructArrayField.fromJSON(...arguments)}static toJSON(t,e,i,s,r){e=e||[];let a=[],n=r.data.iname;for(let o of e){let l=_ws_env$1;""!==n&&void 0!==n&&s.get&&(l[0][0]=n,l[0][1]=o,o=t._env_call(s.get,i,l)),a.push(toJSON(t,o,e,s,r.data.type))}return a}static packNull(t,e,i,s){pack_int(e,0)}static useHelperJS(t){return!t.type.data.iname}static format(t){return""!==t.data.iname&&void 0!==t.data.iname?"iter("+t.data.iname+", "+fmt_type(t.data.type)+")":"iter("+fmt_type(t.data.type)+")"}static unpackInto(t,e,i,s,r){let a=unpack_int(e,s);packer_debug$1("-int "+a),r.length=0;for(let n=0;n<a;n++)r.push(unpack_field(t,e,i.data.type,s));return r}static unpack(t,e,i,s){let r=unpack_int(e,s);packer_debug$1("-int "+r);let a=new Array(r);for(let n=0;n<r;n++)a[n]=unpack_field(t,e,i.data.type,s);return a}static define(){return{type:StructEnum.ITER,name:"iter"}}}StructFieldType.register(StructIterField);class StructShortField extends StructFieldType{static pack(t,e,i,s,r,a){pack_short(e,i)}static unpack(t,e,i,s){return unpack_short(e,s)}static define(){return{type:StructEnum.SHORT,name:"short"}}}StructFieldType.register(StructShortField);class StructByteField extends StructFieldType{static pack(t,e,i,s,r,a){pack_byte(e,i)}static unpack(t,e,i,s){return unpack_byte(e,s)}static define(){return{type:StructEnum.BYTE,name:"byte"}}}StructFieldType.register(StructByteField);class StructSignedByteField extends StructFieldType{static pack(t,e,i,s,r,a){pack_sbyte(e,i)}static unpack(t,e,i,s){return unpack_sbyte(e,s)}static define(){return{type:StructEnum.SIGNED_BYTE,name:"sbyte"}}}StructFieldType.register(StructSignedByteField);class StructBoolField extends StructFieldType{static pack(t,e,i,s,r,a){pack_byte(e,!!i)}static unpack(t,e,i,s){return!!unpack_byte(e,s)}static validateJSON(t,e,i,s,r,a){return 0===e||1===e||!0===e||!1===e||"true"===e||"false"===e||e+" is not a bool"}static fromJSON(t,e,i,s,r,a){return"false"===e&&(e=!1),!!e}static toJSON(t,e,i,s,r){return!!e}static define(){return{type:StructEnum.BOOL,name:"bool"}}}StructFieldType.register(StructBoolField);class StructIterKeysField extends StructFieldType{static pack(t,e,i,s,r,a){if("object"!=typeof i&&"function"!=typeof i||null===i)return console.warn("Bad object fed to iterkeys in struct packer!",i),console.log("Field: ",r),console.log("Type: ",a),console.log(""),void pack_int(e,0);let n=0;for(let t in i)n++;packer_debug$1("int "+n),pack_int(e,n);let o=a.data,l=o.iname,h=o.type,c=_ws_env$1,d=0;for(let a in i){if(d>=n)return void(warninglvl$1>0&&console.warn("Warning: object keys magically replaced during iteration",i,d));l&&l.trim().length>0&&r.get?(c[0][0]=l,c[0][1]=a,a=t._env_call(r.get,s,c)):a=i[a],do_pack(t,e,a,s,{type:h,get:void 0,set:void 0},h),d++}}static validateJSON(t,e,i,s,r,a){return StructArrayField.validateJSON(...arguments)}static fromJSON(){return StructArrayField.fromJSON(...arguments)}static formatJSON(t,e,i,s,r,a,n){return formatArrayJson(t,e,i,s,r,r.data.type,a,n,list$3(e))}static toJSON(t,e,i,s,r){e=e||[];let a=[],n=r.data.iname;for(let o in e){let l=e[o],h=_ws_env$1;""!==n&&void 0!==n&&s.get&&(h[0][0]=n,h[0][1]=l,l=t._env_call(s.get,i,h)),a.push(toJSON(t,l,e,s,r.data.type))}return a}static packNull(t,e,i,s){pack_int(e,0)}static useHelperJS(t){return!t.type.data.iname}static format(t){return""!==t.data.iname&&void 0!==t.data.iname?"iterkeys("+t.data.iname+", "+fmt_type(t.data.type)+")":"iterkeys("+fmt_type(t.data.type)+")"}static unpackInto(t,e,i,s,r){let a=unpack_int(e,s);packer_debug$1("-int "+a),r.length=0;for(let n=0;n<a;n++)r.push(unpack_field(t,e,i.data.type,s));return r}static unpack(t,e,i,s){let r=unpack_int(e,s);packer_debug$1("-int "+r);let a=new Array(r);for(let n=0;n<r;n++)a[n]=unpack_field(t,e,i.data.type,s);return a}static define(){return{type:StructEnum.ITERKEYS,name:"iterkeys"}}}StructFieldType.register(StructIterKeysField);class StructUintField extends StructFieldType{static pack(t,e,i,s,r,a){pack_uint(e,i)}static unpack(t,e,i,s){return unpack_uint(e,s)}static validateJSON(t,e,i,s,r,a){return"number"==typeof e&&e===Math.floor(e)||e+" is not an integer"}static define(){return{type:StructEnum.UINT,name:"uint"}}}StructFieldType.register(StructUintField);class StructUshortField extends StructFieldType{static pack(t,e,i,s,r,a){pack_ushort(e,i)}static unpack(t,e,i,s){return unpack_ushort(e,s)}static validateJSON(t,e,i,s,r,a){return"number"==typeof e&&e===Math.floor(e)||e+" is not an integer"}static define(){return{type:StructEnum.USHORT,name:"ushort"}}}StructFieldType.register(StructUshortField);class StructStaticArrayField extends StructFieldType{static pack(t,e,i,s,r,a){if(void 0===a.data.size)throw new Error("type.data.size was undefined");let n=a.data.iname;if(void 0!==i&&i.length)for(let o=0;o<a.data.size;o++){let l=i[Math.min(o,Math.min(i.length-1,a.data.size))];if(""!==n&&void 0!==n&&r.get){let e=_ws_env$1;e[0][0]=n,e[0][1]=l,l=t._env_call(r.get,s,e)}do_pack(t,e,l,i,r,a.data.type)}else this.packNull(t,e,r,a)}static useHelperJS(t){return!t.type.data.iname}static validateJSON(){return StructArrayField.validateJSON(...arguments)}static fromJSON(){return StructArrayField.fromJSON(...arguments)}static formatJSON(t,e,i,s,r,a,n){return formatArrayJson(t,e,i,s,r,r.data.type,a,n,list$3(e))}static packNull(t,e,i,s){let r=s.data.size;for(let a=0;a<r;a++)packNull(t,e,i,s.data.type)}static toJSON(t,e,i,s,r){return StructArrayField.toJSON(...arguments)}static format(t){let e=`static_array[${StructFieldTypeMap[t.data.type.type].format(t.data.type)}, ${t.data.size}`;return t.data.iname&&(e+=`, ${t.data.iname}`),e+="]",e}static unpackInto(t,e,i,s,r){packer_debug$1("-size: "+i.data.size),r.length=0;for(let a=0;a<i.data.size;a++)r.push(unpack_field(t,e,i.data.type,s));return r}static unpack(t,e,i,s){packer_debug$1("-size: "+i.data.size);let r=[];for(let a=0;a<i.data.size;a++)r.push(unpack_field(t,e,i.data.type,s));return r}static define(){return{type:StructEnum.STATIC_ARRAY,name:"static_array"}}}StructFieldType.register(StructStaticArrayField);class StructOptionalField extends StructFieldType{static pack(t,e,i,s,r,a){if(pack_int(e,null!=i?1:0),null!=i){const n={...r};n.type=a.data,do_pack(t,e,i,s,n,a.data)}}static fakeField(t,e){return{...t,type:e.data}}static validateJSON(t,e,i,s,r,a,n){const o=this.fakeField(s,r);return null==e||validateJSON$1(t,e,i,o,r.data,void 0,n)}static fromJSON(t,e,i,s,r,a){const n=this.fakeField(s,r);return null!=e?fromJSON(t,e,i,n,r.data,void 0):void 0}static formatJSON(t,e,i,s,r,a,n){if(null!=e){const i=this.fakeField(s,r);return formatJSON$1(t,item,e,i,r.data,a,n+1)}return"null"}static toJSON(t,e,i,s,r){const a=this.fakeField(s,r);return null!=e?toJSON(t,e,i,a,r.data):null}static packNull(t,e,i,s){pack_int(e,0)}static format(t){return"optional("+fmt_type(t.data)+")"}static unpackInto(t,e,i,s,r){let a=unpack_int(e,s);packer_debug$1("-int "+id),packer_debug$1("optional exists: "+a),a&&unpack_field(t,e,i.data,s)}static unpack(t,e,i,s){if(unpack_int(e,s))return unpack_field(t,e,i.data,s)}static define(){return{type:StructEnum.OPTIONAL,name:"optional"}}}StructFieldType.register(StructOptionalField);var _sintern2=Object.freeze({__proto__:null,_get_pack_debug:_get_pack_debug,setWarningMode2:setWarningMode2,setDebugMode2:setDebugMode2,StructFieldTypes:StructFieldTypes,StructFieldTypeMap:StructFieldTypeMap,packNull:packNull,toJSON:toJSON,fromJSON:fromJSON,formatJSON:formatJSON$1,validateJSON:validateJSON$1,do_pack:do_pack,StructFieldType:StructFieldType,formatArrayJson:formatArrayJson}),structEval=eval;function setStructEval(t){structEval=t}var _struct_eval=Object.freeze({__proto__:null,get structEval(){return structEval},setStructEval:setStructEval});const TokSymbol=Symbol("token-info");function buildJSONParser(){let t,e=(t,e,i,s)=>new tokdef$1(t,e,i,s),i="[+-]?[0-9]+\\.[0-9]+",s="[+-]?[0-9]+\\.[0-9]+[eE][+-]?[0-9]+",r=`([+-]?[0-9]+)|(${`([+-]?[0-9]+\\.[0-9]*)|([+-]?[0-9]*\\.[0-9]+)|(${s})`})|([+-]?0x[0-9a-fA-F]+)`,a=new RegExp(r),n=new RegExp(`(${r})$`);i=new RegExp(i),s=new RegExp(s);let o=["1.234234",".23432","-234.","1e-17","-0x23423ff","+23423","-4.263256414560601e-14"];for(let t of o)n.test(t)||console.error("Error! Number regexp failed:",t);let l=[e("BOOL",/true|false/),e("WS",/[ \r\t\n]/,(t=>{})),e("STRLIT",/["']/,(t=>{let e=t.lexer,i=t.value,s=e.lexpos,r=e.lexdata,a=0;for(t.value="";s<r.length;){let e=r[s];if(t.value+=e,"\\"===e)a^=!0;else{if(!a&&e===i)break;a=!1}s++}return e.lexpos=s+1,t.value.length>0&&(t.value=t.value.slice(0,t.value.length-1)),t})),e("LSBRACKET",/\[/),e("RSBRACKET",/]/),e("LBRACE",/{/),e("RBRACE",/}/),e("NULL",/null/),e("COMMA",/,/),e("COLON",/:/),e("NUM",a,(t=>(t.value=parseFloat(t.value),t))),e("NUM",i,(t=>(t.value=parseFloat(t.value),t))),e("NUM",s,(t=>(t.value=parseFloat(t.value),t)))];function h(t){return{lexpos:t.lexpos,lineno:t.lineno,col:t.col,fields:{}}}function c(t,e=!0){let i=t.peeknext();return"LSBRACKET"===i.type?function(t){t.expect("LSBRACKET");let e=t.peeknext(),i=!0,s=[];for(s[TokSymbol]=h(e);e&&"RSBRACKET"!==e.type;)i||t.expect("COMMA"),s[TokSymbol].fields[s.length]=h(e),s.push(c(t)),i=!1,e=t.peeknext();return t.expect("RSBRACKET"),s}(t):"LBRACE"===i.type?function(t){t.expect("LBRACE");let e={},i=!0,s=t.peeknext();for(e[TokSymbol]=h(s);s&&"RBRACE"!==s.type;){i||t.expect("COMMA");let r=t.expect("STRLIT");t.expect("COLON");let a=c(t,!0);e[r]=a,i=!1,s=t.peeknext(),e[TokSymbol].fields[r]=h(s)}return t.expect("RBRACE"),e}(t):"STRLIT"===i.type||"NUM"===i.type||"NULL"===i.type||"BOOL"===i.type?t.next().value:void t.error(i,"Unknown token")}let d=new lexer$2(l);return d.linestart=0,t=new parser$1(d,(function(t,e){throw new PUTIL_ParseError("Parse Error")})),t.start=c,t}var jsonParser=buildJSONParser(),nGlobal;function printContext(t,e,i=!0){let s=t.split("\n");if(!e)return"";let r=e.lineno,a=e.col,n=Math.max(r-50,0),o=Math.min(r+2,s.length-1),l="";l+=i?termColor$1("  /* pretty-printed json */\n","blue"):"/* pretty-printed json */\n";for(let t=n;t<o;t++){let e=s[t],n=""+t;for(;n.length<3;)n=" "+n;if(l+=t===r&&i?termColor$1(`${n}: ${e}\n`,"yellow"):`${n}: ${e}\n`,t===r){let t="";for(let e=0;e<a+5;e++)t+=" ";l+=t+"^\n"}}return l}"undefined"!=typeof globalThis?nGlobal=globalThis:"undefined"!=typeof window?nGlobal=window:"undefined"!=typeof global?nGlobal=global:"undefined"!=typeof globals?nGlobal=globals:"undefined"!=typeof self&&(nGlobal=self);const DEBUG={};function updateDEBUG(){for(let t in Object.keys(DEBUG))delete DEBUG[t];if("object"==typeof nGlobal.DEBUG)for(let t in nGlobal.DEBUG)DEBUG[t]=nGlobal.DEBUG[t]}var sintern2=_sintern2,struct_eval=_struct_eval;let warninglvl=2;var truncateDollarSign$1=!0,manager$1;class JSONError extends Error{}function printCodeLines(t){let e=t.split(String.fromCharCode(10)),i="";for(let t=0;t<e.length;t++){let s=t+1+":";for(;s.length<3;)s+=" ";s+=" "+e[t],i+=s+String.fromCharCode(10)}return i}function printEvalError(code){console.log("== CODE =="),console.log(printCodeLines(code)),eval(code)}function setTruncateDollarSign(t){truncateDollarSign$1=!!t}function _truncateDollarSign(t){let e=t.search("$");return e>0?t.slice(0,e).trim():t}function unmangle(t){return truncateDollarSign$1?_truncateDollarSign(t):t}let _static_envcode_null="",packer_debug,packer_debug_start,packer_debug_end;function gen_tabstr(t){let e="";for(let i=0;i<t;i++)e+=" ";return e}function update_debug_data(){let t=_get_pack_debug();packer_debug=t.packer_debug,packer_debug_start=t.packer_debug_start,packer_debug_end=t.packer_debug_end,warninglvl=t.warninglvl}function setWarningMode(t){if(sintern2.setWarningMode2(t),"number"!=typeof t||isNaN(t))throw new Error("Expected a single number (>= 0) argument to setWarningMode");warninglvl=t}function setDebugMode(t){sintern2.setDebugMode2(t),update_debug_data()}update_debug_data();let _ws_env=[[void 0,void 0]],haveCodeGen,nbtoa,natob;function define_empty_class(t,e){let i=function(){};i.prototype=Object.create(Object.prototype),i.constructor=i.prototype.constructor=i;t.keywords;return i.STRUCT=e+" {\n  }\n",i.structName=e,i.prototype.loadSTRUCT=function(t){t(this)},i.newSTRUCT=function(){return new this},i}class STRUCT{constructor(){this.idgen=0,this.allowOverriding=!0,this.structs={},this.struct_cls={},this.struct_ids={},this.compiled_code={},this.null_natives={},this.define_null_native("Object",Object),this.jsonUseColors=!0,this.jsonBuf="",this.formatCtx={}}static inherit(t,e,i=t.name){this.keywords;if(!e.STRUCT)return i+"{\n";let s=struct_parse.parse(e.STRUCT),r=i+"{\n";return r+=STRUCT.fmt_struct(s,!0,!1,!0),r}static Super(t,e){warninglvl>0&&console.warn("deprecated"),e(t);let i=t.constructor,s=void 0===i||void 0===i.prototype||void 0===i.prototype.__proto__;if(s)return;let r=i.prototype.__proto__.constructor;s=s||void 0===r,!s&&r.prototype.loadSTRUCT&&r.prototype.loadSTRUCT!==t.loadSTRUCT&&r.prototype.loadSTRUCT.call(t,(function(t){}))}static chain_fromSTRUCT(t,e){warninglvl>0&&console.warn("Using deprecated (and evil) chain_fromSTRUCT method, eek!");t.prototype;let i=t.prototype.prototype.constructor.fromSTRUCT(e),s=new t,r=Object.keys(i).concat(Object.getOwnPropertySymbols(i));for(let t=0;t<r.length;t++){let e=r[t];try{s[e]=i[e]}catch(t){warninglvl>0&&console.warn("  failed to set property",e)}}return s}static formatStruct(t,e,i){return this.fmt_struct(t,e,i)}static fmt_struct(t,e,i,s){void 0===e&&(e=!1),void 0===i&&(i=!1);let r="";e||(r+=t.name,-1!==t.id&&(r+=" id="+t.id),r+=" {\n");function a(t){return StructFieldTypeMap[t.type].format(t)}let n=t.fields;for(let t=0;t<n.length;t++){let e=n[t];r+="  "+e.name+" : "+a(e.type),i||void 0===e.get||(r+=" | "+e.get.trim()),r+=";",s&&e.comment.trim()&&(r+=e.comment.trim()),r+="\n"}return e||(r+="}"),r}static setClassKeyword(t,e){e||(e=t.toLowerCase()+"Name"),this.keywords={script:t,name:e,load:"load"+t,new:"new"+t,after:"after"+t,from:"from"+t}}define_null_native(t,e){this.constructor.keywords;let i=define_empty_class(this.constructor,t),s=struct_parse.parse(i.STRUCT);s.id=this.idgen++,this.structs[t]=s,this.struct_cls[t]=e,this.struct_ids[s.id]=s,this.null_natives[t]=1}validateStructs(t){function e(t){switch(t.type){case StructEnum.ITERKEYS:case StructEnum.ITER:case StructEnum.STATIC_ARRAY:case StructEnum.ARRAY:return e(t.data.type);case StructEnum.TSTRUCT:case StructEnum.STRUCT:default:return t}}function i(e,i,s){let r=STRUCT.formatStruct(e);if(console.error(r+"\n\n"+s),!t)throw new Error(s);t(s,e,i)}for(let t in this.structs){let s=this.structs[t];for(let t of s.fields){if("this"===t.name){let e=t.type.type;ValueTypes.has(e)&&i(s,t,"'this' cannot be used with value types")}let r=e(t.type);if((r.type===StructEnum.STRUCT||r.type===StructEnum.TSTRUCT)&&!(r.data in this.structs)){i(s,t,s.name+":"+t.name+": Unknown struct "+r.data+".")}}}}forEach(t,e){for(let i in this.structs){let s=this.structs[i];void 0!==e?t.call(e,s):t(s)}}parse_structs(t,e){this.constructor.keywords;if(void 0===e&&(e=manager$1),e instanceof STRUCT){let t=e;e=[];for(let i in t.struct_cls)e.push(t.struct_cls[i])}if(void 0===e){e=[];for(let t in manager$1.struct_cls)e.push(manager$1.struct_cls[t])}let i={};for(let t=0;t<e.length;t++){let s=e[t];if(!s.structName&&s.STRUCT){let t=struct_parse.parse(s.STRUCT.trim());s.structName=t.name}else if(!s.structName&&"Object"!==s.name){warninglvl>0&&console.log("Warning, bad class in registered class list",unmangle(s.name),s);continue}i[s.structName]=e[t]}for(struct_parse.input(t);!struct_parse.at_end();){let t=struct_parse.parse(void 0,!1);if(t.name in i)this.struct_cls[t.name]=i[t.name],this.structs[t.name]=t,-1!==t.id&&(this.struct_ids[t.id]=t);else{t.name in this.null_natives||warninglvl>0&&console.log("WARNING: struct "+t.name+" is missing from class list.");let e=define_empty_class(this.constructor,t.name);e.STRUCT=STRUCT.fmt_struct(t),e.structName=t.name,e.prototype.structName=e.name,this.struct_cls[e.structName]=e,this.structs[e.structName]=t,-1!==t.id&&(this.struct_ids[t.id]=t)}let e=struct_parse.peek();for(;e&&("\n"===e.value||"\r"===e.value||"\t"===e.value||" "===e.value);)e=struct_parse.peek()}}registerGraph(t,e){if(!e.structName)return console.warn("class was not in srcSTRUCT"),this.register(e);let i,s=e=>{switch(e.type){case StructEnum.ARRAY:case StructEnum.ITERKEYS:case StructEnum.STATIC_ARRAY:case StructEnum.ITER:return s(e.data.type);case StructEnum.STRUCT:case StructEnum.TSTRUCT:{let s=t.structs[e.data],r=t.struct_cls[s.name];return i(s,r)}}};i=(e,r)=>{r.structName in this.structs||this.add_class(r,r.structName);for(let r of e.fields)if(r.type.type===StructEnum.STRUCT||r.type.type===StructEnum.TSTRUCT){let e=t.structs[r.type.data],s=t.struct_cls[e.name];i(e,s)}else(r.type.type===StructEnum.ARRAY||r.type.type===StructEnum.ITER||r.type.type===StructEnum.ITERKEYS||r.type.type===StructEnum.STATIC_ARRAY)&&s(r.type)};let r=t.structs[e.structName];i(r,e)}mergeScripts(t,e){let i=struct_parse.parse(t.trim()),s=struct_parse.parse(e.trim()),r=new Set;for(let t of i.fields)r.add(t.name);let a=[];for(let t of s.fields)r.has(t.name)||a.push(t);return i.fields=a.concat(i.fields),STRUCT.fmt_struct(i,!1,!1)}inlineRegister(t,e){const i=this.constructor.keywords;let s=t.__proto__;for(;s&&s!==Object;){if(s.hasOwnProperty(i.script)){e=this.mergeScripts(e,s.STRUCT);break}s=s.__proto__}return t.STRUCT=e,this.register(t),e}register(t,e){return this.add_class(t,e)}unregister(t){this.constructor.keywords;if(!t||!t.structName||!(t.structName in this.struct_cls))return void console.warn("Class not registered with nstructjs",t);let e=this.structs[t.structName];delete this.structs[t.structName],delete this.struct_cls[t.structName],delete this.struct_ids[e.id]}add_class(t,e){if(t===Object)return;const i=this.constructor.keywords;if(t.STRUCT){let s=!1,r=t;for(;r;)if(r=r.__proto__,r&&r.STRUCT&&r.STRUCT===t.STRUCT){s=!0;break}s&&(warninglvl>0&&console.warn("Generating "+i.script+" script for derived class "+unmangle(t.name)),e||(e=unmangle(t.name)),t.STRUCT=STRUCT.inherit(t,r)+"\n}")}if(!t.STRUCT)throw new Error("class "+unmangle(t.name)+" has no "+i.script+" script");let s=struct_parse.parse(t.STRUCT);if(s.name=unmangle(s.name),t.structName=s.name,void 0===t.newSTRUCT&&(t.newSTRUCT=function(){return new this}),void 0!==e?s.name=t.structName=e:void 0===t.structName?t.structName=s.name:s.name=t.structName,t.structName in this.structs){if(warninglvl>0&&console.warn("Struct "+unmangle(t.structName)+" is already registered",t),!this.allowOverriding)throw new Error("Struct "+unmangle(t.structName)+" is already registered")}else-1===s.id&&(s.id=this.idgen++),this.structs[t.structName]=s,this.struct_cls[t.structName]=t,this.struct_ids[s.id]=s}isRegistered(t){this.constructor.keywords;return!!t.hasOwnProperty("structName")&&t===this.struct_cls[t.structName]}get_struct_id(t){return this.struct_ids[t]}get_struct(t){if(!(t in this.structs))throw console.warn("Unknown struct",t),new Error("Unknown struct "+t);return this.structs[t]}get_struct_cls(t){if(!(t in this.struct_cls))throw console.trace(),new Error("Unknown struct "+t);return this.struct_cls[t]}_env_call(t,e,i){let s=_static_envcode_null;if(void 0!==i){s="";for(let t=0;t<i.length;t++)s="let "+i[t][0]+" = env["+t.toString()+"][1];\n"+s}let r,a="";if(a=s!==_static_envcode_null?s+t:t,a in this.compiled_code)r=this.compiled_code[a];else{let e="func = function(obj, env) { "+s+"return "+t+"}";try{r=struct_eval.structEval(e)}catch(t){throw console.warn(t.stack),console.warn(e),console.warn(" "),t}this.compiled_code[a]=r}try{return r.call(e,e,i)}catch(e){console.warn(e.stack);let i="func = function(obj, env) { "+s+"return "+t+"}";throw console.warn(i),console.warn(" "),e}}write_struct(t,e,i){function s(t){let e=t.type.type;return StructFieldTypeMap[e].useHelperJS(t)}let r=i.fields,a=this;for(let i=0;i<r.length;i++){let n=r[i],o=n.type;o.type;if(s(n)){let i;i=void 0!==n.get?a._env_call(n.get,e):"this"===n.name?e:e[n.name],DEBUG.tinyeval&&console.log("\n\n\n",n.get,"Helper JS Ret",i,"\n\n\n"),sintern2.do_pack(this,t,i,e,n,o)}else{let i="this"===n.name?e:e[n.name];sintern2.do_pack(this,t,i,e,n,o)}}}write_object(t,e){this.constructor.keywords;let i=e.constructor.structName,s=this.get_struct(i);return void 0===t&&(t=[]),this.write_struct(t,e,s),t}readObject(t,e,i){return t instanceof Uint8Array||t instanceof Uint8ClampedArray?t=new DataView(t.buffer):t instanceof Array&&(t=new DataView(new Uint8Array(t).buffer)),this.read_object(t,e,i)}writeObject(t,e){return this.write_object(t,e)}writeJSON(t,e){this.constructor.keywords;let i=t.constructor;function s(t){let e=t.type.type;return StructFieldTypeMap[e].useHelperJS(t)}e=e||this.get_struct(i.structName);let r=sintern2.toJSON,a=e.fields,n=this,o={};for(let e=0;e<a.length;e++){let i,l,h=a[e],c=h.type;if(s(h)?(i=void 0!==h.get?n._env_call(h.get,t):"this"===h.name?t:t[h.name],DEBUG.tinyeval&&console.log("\n\n\n",h.get,"Helper JS Ret",i,"\n\n\n"),l=r(this,i,t,h,c)):(i="this"===h.name?t:t[h.name],l=r(this,i,t,h,c)),"this"!==h.name)o[h.name]=l;else{let t=Array.isArray(l);if(t=t||h.type.type===StructTypes.ARRAY,t=t||h.type.type===StructTypes.STATIC_ARRAY,t){o.length=l.length;for(let t=0;t<l.length;t++)o[t]=l[t]}else Object.assign(o,l)}}return o}read_object(t,e,i,s){this.constructor.keywords;let r,a;if(t instanceof Array&&(t=new DataView(new Uint8Array(t).buffer)),r="number"==typeof e?this.struct_cls[this.struct_ids[e].name]:e,void 0===r)throw new Error("bad cls_or_struct_id "+e);a=this.structs[r.structName],void 0===i&&(i=new unpack_context,packer_debug("\n\n=Begin reading "+r.structName+"="));let n=this;function o(e){return StructFieldTypeMap[e.type].unpack(n,t,e,i)}let l=!1;let h=function(e){return function(s){if(l)return;l=!0;let r=e.fields,a=r.length;for(let e=0;e<a;e++){let a=r[e];"this"===a.name?(h=a.type,c=s,StructFieldTypeMap[h.type].unpackInto(n,t,h,i,c)):s[a.name]=o(a.type)}var h,c}}(a);if(void 0!==r.prototype.loadSTRUCT){let t=s;return t||void 0===r.newSTRUCT?t||(t=new r):t=r.newSTRUCT(h),t.loadSTRUCT(h),l||(console.warn(r.structName+".prototype.loadSTRUCT() did not execute its loader callback!"),h(t)),t}if(void 0!==r.fromSTRUCT)return warninglvl>1&&console.warn("Warning: class "+unmangle(r.name)+" is using deprecated fromSTRUCT interface; use newSTRUCT/loadSTRUCT instead"),r.fromSTRUCT(h);{let t=s;return t||void 0===r.newSTRUCT?t||(t=new r):t=r.newSTRUCT(h),h(t),t}}validateJSON(t,e,i=!0,s=!0,r=function(){console.log(...arguments)},a="_structName"){if(void 0===e)throw new Error(this.constructor.name+".prototype.validateJSON: Expected at least two arguments");try{t=JSON.stringify(t,void 0,2),this.jsonBuf=t,this.jsonUseColors=s,this.jsonLogger=r,jsonParser.logger=this.jsonLogger,t=i?jsonParser.parse(t):JSON.parse(t),this.validateJSONIntern(t,e,a)}catch(t){return t instanceof JSONError||console.error(t.stack),this.jsonLogger(t.message),!1}return!0}validateJSONIntern(t,e,i="_structName"){this.constructor.keywords;let s,r;if(s="number"==typeof e?this.struct_cls[this.struct_ids[e].name]:e instanceof NStruct?this.get_struct_cls(e.name):e,void 0===s)throw new Error("bad cls_or_struct_id "+e);if(r=this.structs[s.structName],void 0===r)throw new Error("unknown class "+s);let a=r.fields,n=a.length,o=new Set;o.add(i);let l=t;for(let e=0;e<n;e++){let s,n,h=a[e];if("this"===h.name)s=t,l={this:t},o.add("this"),n=t[TokSymbol];else{if(s=t[h.name],o.add(h.name),n=t[TokSymbol]?t[TokSymbol].fields[h.name]:void 0,!n){let i=a[Math.max(e-1,0)];n=TokSymbol[TokSymbol]?t[TokSymbol].fields[i.name]:void 0}n||(n=t[TokSymbol])}let c="this"===h.name?s:t,d=sintern2.validateJSON(this,s,t,h,h.type,c,i);if(!d||"string"==typeof d){let t="string"==typeof d?": "+d:"";throw n&&this.jsonLogger(printContext(this.jsonBuf,n,this.jsonUseColors)),new JSONError(void 0===s?r.name+": Missing json field "+h.name+t:r.name+": Invalid json field "+h.name+t)}}for(let e in l)if("symbol"!=typeof t[e]&&!o.has(e))throw this.jsonLogger(s.STRUCT),new JSONError(r.name+": Unknown json field "+e);return!0}readJSON(t,e,i){this.constructor.keywords;let s,r;if(s="number"==typeof e?this.struct_cls[this.struct_ids[e].name]:e instanceof NStruct?this.get_struct_cls(e.name):e,void 0===s)throw new Error("bad cls_or_struct_id "+e);r=this.structs[s.structName],packer_debug("\n\n=Begin reading "+s.structName+"=");let a=this,n=!1,o=sintern2.fromJSON;let l=function(e){return function(s){if(n)return;n=!0;let r=e.fields,l=r.length;for(let n=0;n<l;n++){let l,h=r[n];if(l="this"===h.name?t:t[h.name],void 0===l){warninglvl>1&&console.warn("nstructjs.readJSON: Missing field "+h.name+" in struct "+e.name);continue}let c="this"===h.name?s:i,d=o(a,l,s,h,h.type,c);"this"!==h.name&&(s[h.name]=d)}}}(r);if(void 0!==s.prototype.loadSTRUCT){let t=i;return t||void 0===s.newSTRUCT?t||(t=new s):t=s.newSTRUCT(l),t.loadSTRUCT(l),t}if(void 0!==s.fromSTRUCT)return warninglvl>1&&console.warn("Warning: class "+unmangle(s.name)+" is using deprecated fromSTRUCT interface; use newSTRUCT/loadSTRUCT instead"),s.fromSTRUCT(l);{let t=i;return t||void 0===s.newSTRUCT?t||(t=new s):t=s.newSTRUCT(l),l(t),t}}formatJSON_intern(t,e,i,s=0){this.constructor.keywords;const r=this.formatCtx.addComments;let a="{";r&&i&&i.comment.trim()&&(a+=" "+i.comment.trim()),a+="\n";for(let i of e.fields){let e=t[i.name];a+=tab(s+1)+i.name+": ",a+=sintern2.formatJSON(this,e,t,i,i.type,void 0,s+1),a+=",";let n=i.type.type;ArrayTypes.has(n)&&(n=i.type.data.type.type);ValueTypes.has(n)&&r&&i.comment.trim()&&(a+=" "+i.comment.trim()),a+="\n"}return a+=tab(s)+"}",a}formatJSON(t,e,i=!0,s=!0){this.constructor.keywords;s&&this.validateJSON(t,e);let r=this.structs[e.structName];return this.formatCtx={addComments:i,validate:s},this.formatJSON_intern(t,r)}}if(haveCodeGen){var StructClass;try{eval(code)}catch(error){printEvalError(code)}StructClass.keywords={name:"structName",script:"STRUCT",load:"loadSTRUCT",from:"fromSTRUCT",new:"newSTRUCT"},STRUCT=StructClass}function deriveStructManager(keywords={script:"STRUCT",name:void 0,load:void 0,new:void 0,from:void 0}){if(keywords.name||(keywords.name=keywords.script.toLowerCase()+"Name"),keywords.load||(keywords.load="load"+keywords.script),keywords.new||(keywords.new="new"+keywords.script),keywords.from||(keywords.from="from"+keywords.script),haveCodeGen){var StructClass,_json_parser=jsonParser,_util=util$1;let code2=code;code2=code2.replace(/\[keywords.script\]/g,"."+keywords.script),code2=code2.replace(/\[keywords.name\]/g,"."+keywords.name),code2=code2.replace(/\bjsonParser\b/g,"_json_parser"),code2=code2.replace(/\butil\b/g,"_util");try{eval(code2)}catch(t){printEvalError(code2)}return StructClass.keywords=keywords,StructClass}{class t extends STRUCT{}return t.keywords=keywords,t}}function write_scripts(t=manager$1,e=!1){let i="",s=String.fromCharCode(10),r=String.fromCharCode(9);t.forEach((function(t){i+=STRUCT.fmt_struct(t,!1,!e)+s}));let a=i;i="";for(let t=0;t<a.length;t++){let e=a[t];if(e===s){i+=s;let e=t;for(;t<a.length&&(" "===a[t]||a[t]===r||a[t]===s);)t++;t!==e&&t--}else i+=e}return i}function versionToInt(t){let e=64;return~~((t=versionCoerce(t)).major*e*e*e+t.minor*e*e+t.micro*e)}STRUCT.setClassKeyword("STRUCT"),manager$1=new STRUCT,"undefined"==typeof btoa?(nbtoa=function(t){return new Buffer(""+t,"binary").toString("base64")},natob=function(t){return new Buffer(t,"base64").toString("binary")}):(natob=atob,nbtoa=btoa);let ver_pat=/[0-9]+\.[0-9]+\.[0-9]+$/;function versionCoerce(t){if(!t)throw new Error("empty version: "+t);if("string"==typeof t){if(!ver_pat.exec(t))throw new Error("invalid version string "+t);let e=t.split(".");return{major:parseInt(e[0]),minor:parseInt(e[1]),micro:parseInt(e[2])}}if(Array.isArray(t))return{major:t[0],minor:t[1],micro:t[2]};if("object"==typeof t){let e=e=>e in t&&"number"==typeof t[e];if(!e("major")||!e("minor")||!e("micro"))throw new Error("invalid version object: "+t);return t}throw new Error("invalid version "+t)}function versionLessThan(t,e){return versionToInt(t)<versionToInt(e)}class FileParams{constructor(){this.magic="STRT",this.ext=".bin",this.blocktypes=["DATA"],this.version={major:0,minor:0,micro:1}}}class Block{constructor(t,e){this.type=t,this.data=e}}class FileeError extends Error{}class FileHelper{constructor(t){if(void 0===t)t=new FileParams;else{let e=new FileParams;for(let i in t)e[i]=t[i];t=e}this.version=t.version,this.blocktypes=t.blocktypes,this.magic=t.magic,this.ext=t.ext,this.struct=void 0,this.unpack_ctx=void 0}read(t){if(this.unpack_ctx=new unpack_context,unpack_static_string(t,this.unpack_ctx,4)!==this.magic)throw new FileError("corrupted file");this.version={},this.version.major=unpack_short(t,this.unpack_ctx),this.version.minor=unpack_byte(t,this.unpack_ctx),this.version.micro=unpack_byte(t,this.unpack_ctx);let e=this.struct=new STRUCT,i=unpack_string(t,this.unpack_ctx);this.struct.parse_structs(i,manager$1);let s=[],r=t.buffer.byteLength;for(;this.unpack_ctx.i<r;){let i,r=unpack_static_string(t,this.unpack_ctx,4),a=unpack_int(t,this.unpack_ctx),n=unpack_int(t,this.unpack_ctx);-2===n?i=unpack_static_string(t,this.unpack_ctx,a):(i=unpack_bytes(t,this.unpack_ctx,a),i=e.read_object(i,n,new unpack_context));let o=new Block;o.type=r,o.data=i,s.push(o)}return this.blocks=s,s}doVersions(t){this.blocks;versionLessThan(t,"0.0.1")}write(t){this.struct=manager$1,this.blocks=t;let e=[];pack_static_string(e,this.magic,4),pack_short(e,this.version.major),pack_byte(e,255&this.version.minor),pack_byte(e,255&this.version.micro),pack_string(e,write_scripts());let i=this.struct;for(let s of t){if("string"==typeof s.data){pack_static_string(e,s.type,4),pack_int(e,s.data.length),pack_int(e,-2),pack_static_string(e,s.data,s.data.length);continue}let t=s.data.constructor.structName;if(void 0===t||!(t in i.structs))throw new Error("Non-STRUCTable object "+s.data);let r=[],a=i.structs[t];i.write_object(r,s.data),pack_static_string(e,s.type,4),pack_int(e,r.length),pack_int(e,a.id),pack_bytes(e,r)}return new DataView(new Uint8Array(e).buffer)}writeBase64(t){let e=this.write(t),i="",s=new Uint8Array(e.buffer);for(let t=0;t<s.length;t++)i+=String.fromCharCode(s[t]);return nbtoa(i)}makeBlock(t,e){return new Block(t,e)}readBase64(t){let e=natob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return this.read(new DataView(i.buffer))}}var struct_filehelper=Object.freeze({__proto__:null,versionToInt:versionToInt,versionCoerce:versionCoerce,versionLessThan:versionLessThan,FileParams:FileParams,Block:Block,FileeError:FileeError,FileHelper:FileHelper});function truncateDollarSign(t=!0){setTruncateDollarSign(t)}function validateStructs(t){return manager$1.validateStructs(t)}function setEndian(t){let e=STRUCT_ENDIAN;return setBinaryEndian(t),e}function consoleLogger(){console.log(...arguments)}function validateJSON(t,e,i,s=!0,r=consoleLogger){return manager$1.validateJSON(t,e,i,s,r)}function getEndian(){return STRUCT_ENDIAN}function setAllowOverriding(t){return manager$1.allowOverriding=!!t}function isRegistered(t){return manager$1.isRegistered(t)}function inlineRegister(t,e){return manager$1.inlineRegister(t,e)}function register$1(t,e){return manager$1.register(t,e)}function unregister(t){manager$1.unregister(t)}function inherit$1(t,e,i=t.name){return STRUCT.inherit(...arguments)}function readObject(t,e,i){return manager$1.readObject(t,e,i)}function writeObject(t,e){return manager$1.writeObject(t,e)}function writeJSON(t){return manager$1.writeJSON(t)}function formatJSON(t,e,i=!0,s=!0){return manager$1.formatJSON(t,e,i,s)}function readJSON(t,e){return manager$1.readJSON(t,e)}var nstructjs=Object.freeze({__proto__:null,JSONError:JSONError,get STRUCT(){return STRUCT},_truncateDollarSign:_truncateDollarSign,binpack:struct_binpack,consoleLogger:consoleLogger,deriveStructManager:deriveStructManager,filehelper:struct_filehelper,formatJSON:formatJSON,getEndian:getEndian,inherit:inherit$1,inlineRegister:inlineRegister,isRegistered:isRegistered,get manager(){return manager$1},parser:struct_parser,parseutil:struct_parseutil,readJSON:readJSON,readObject:readObject,register:register$1,setAllowOverriding:setAllowOverriding,setDebugMode:setDebugMode,setEndian:setEndian,setTruncateDollarSign:setTruncateDollarSign,setWarningMode:setWarningMode,truncateDollarSign:truncateDollarSign,typesystem:struct_typesystem,unpack_context:unpack_context,unregister:unregister,validateJSON:validateJSON,validateStructs:validateStructs,writeJSON:writeJSON,writeObject:writeObject,write_scripts:write_scripts});
/*!mobile-detect v1.4.4 2019-09-21*/
/*!@license Copyright 2013, Heinrich Goebl, License: MIT, see https://github.com/hgoebl/mobile-detect.js*/!function(t,e){t((function(){var t,i={mobileDetectRules:{phones:{iPhone:"\\biPhone\\b|\\biPod\\b",BlackBerry:"BlackBerry|\\bBB10\\b|rim[0-9]+|\\b(BBA100|BBB100|BBD100|BBE100|BBF100|STH100)\\b-[0-9]+",HTC:"HTC|HTC.*(Sensation|Evo|Vision|Explorer|6800|8100|8900|A7272|S510e|C110e|Legend|Desire|T8282)|APX515CKT|Qtek9090|APA9292KT|HD_mini|Sensation.*Z710e|PG86100|Z715e|Desire.*(A8181|HD)|ADR6200|ADR6400L|ADR6425|001HT|Inspire 4G|Android.*\\bEVO\\b|T-Mobile G1|Z520m|Android [0-9.]+; Pixel",Nexus:"Nexus One|Nexus S|Galaxy.*Nexus|Android.*Nexus.*Mobile|Nexus 4|Nexus 5|Nexus 6",Dell:"Dell[;]? (Streak|Aero|Venue|Venue Pro|Flash|Smoke|Mini 3iX)|XCD28|XCD35|\\b001DL\\b|\\b101DL\\b|\\bGS01\\b",Motorola:"Motorola|DROIDX|DROID BIONIC|\\bDroid\\b.*Build|Android.*Xoom|HRI39|MOT-|A1260|A1680|A555|A853|A855|A953|A955|A956|Motorola.*ELECTRIFY|Motorola.*i1|i867|i940|MB200|MB300|MB501|MB502|MB508|MB511|MB520|MB525|MB526|MB611|MB612|MB632|MB810|MB855|MB860|MB861|MB865|MB870|ME501|ME502|ME511|ME525|ME600|ME632|ME722|ME811|ME860|ME863|ME865|MT620|MT710|MT716|MT720|MT810|MT870|MT917|Motorola.*TITANIUM|WX435|WX445|XT300|XT301|XT311|XT316|XT317|XT319|XT320|XT390|XT502|XT530|XT531|XT532|XT535|XT603|XT610|XT611|XT615|XT681|XT701|XT702|XT711|XT720|XT800|XT806|XT860|XT862|XT875|XT882|XT883|XT894|XT901|XT907|XT909|XT910|XT912|XT928|XT926|XT915|XT919|XT925|XT1021|\\bMoto E\\b|XT1068|XT1092|XT1052",Samsung:"\\bSamsung\\b|SM-G950F|SM-G955F|SM-G9250|GT-19300|SGH-I337|BGT-S5230|GT-B2100|GT-B2700|GT-B2710|GT-B3210|GT-B3310|GT-B3410|GT-B3730|GT-B3740|GT-B5510|GT-B5512|GT-B5722|GT-B6520|GT-B7300|GT-B7320|GT-B7330|GT-B7350|GT-B7510|GT-B7722|GT-B7800|GT-C3010|GT-C3011|GT-C3060|GT-C3200|GT-C3212|GT-C3212I|GT-C3262|GT-C3222|GT-C3300|GT-C3300K|GT-C3303|GT-C3303K|GT-C3310|GT-C3322|GT-C3330|GT-C3350|GT-C3500|GT-C3510|GT-C3530|GT-C3630|GT-C3780|GT-C5010|GT-C5212|GT-C6620|GT-C6625|GT-C6712|GT-E1050|GT-E1070|GT-E1075|GT-E1080|GT-E1081|GT-E1085|GT-E1087|GT-E1100|GT-E1107|GT-E1110|GT-E1120|GT-E1125|GT-E1130|GT-E1160|GT-E1170|GT-E1175|GT-E1180|GT-E1182|GT-E1200|GT-E1210|GT-E1225|GT-E1230|GT-E1390|GT-E2100|GT-E2120|GT-E2121|GT-E2152|GT-E2220|GT-E2222|GT-E2230|GT-E2232|GT-E2250|GT-E2370|GT-E2550|GT-E2652|GT-E3210|GT-E3213|GT-I5500|GT-I5503|GT-I5700|GT-I5800|GT-I5801|GT-I6410|GT-I6420|GT-I7110|GT-I7410|GT-I7500|GT-I8000|GT-I8150|GT-I8160|GT-I8190|GT-I8320|GT-I8330|GT-I8350|GT-I8530|GT-I8700|GT-I8703|GT-I8910|GT-I9000|GT-I9001|GT-I9003|GT-I9010|GT-I9020|GT-I9023|GT-I9070|GT-I9082|GT-I9100|GT-I9103|GT-I9220|GT-I9250|GT-I9300|GT-I9305|GT-I9500|GT-I9505|GT-M3510|GT-M5650|GT-M7500|GT-M7600|GT-M7603|GT-M8800|GT-M8910|GT-N7000|GT-S3110|GT-S3310|GT-S3350|GT-S3353|GT-S3370|GT-S3650|GT-S3653|GT-S3770|GT-S3850|GT-S5210|GT-S5220|GT-S5229|GT-S5230|GT-S5233|GT-S5250|GT-S5253|GT-S5260|GT-S5263|GT-S5270|GT-S5300|GT-S5330|GT-S5350|GT-S5360|GT-S5363|GT-S5369|GT-S5380|GT-S5380D|GT-S5560|GT-S5570|GT-S5600|GT-S5603|GT-S5610|GT-S5620|GT-S5660|GT-S5670|GT-S5690|GT-S5750|GT-S5780|GT-S5830|GT-S5839|GT-S6102|GT-S6500|GT-S7070|GT-S7200|GT-S7220|GT-S7230|GT-S7233|GT-S7250|GT-S7500|GT-S7530|GT-S7550|GT-S7562|GT-S7710|GT-S8000|GT-S8003|GT-S8500|GT-S8530|GT-S8600|SCH-A310|SCH-A530|SCH-A570|SCH-A610|SCH-A630|SCH-A650|SCH-A790|SCH-A795|SCH-A850|SCH-A870|SCH-A890|SCH-A930|SCH-A950|SCH-A970|SCH-A990|SCH-I100|SCH-I110|SCH-I400|SCH-I405|SCH-I500|SCH-I510|SCH-I515|SCH-I600|SCH-I730|SCH-I760|SCH-I770|SCH-I830|SCH-I910|SCH-I920|SCH-I959|SCH-LC11|SCH-N150|SCH-N300|SCH-R100|SCH-R300|SCH-R351|SCH-R400|SCH-R410|SCH-T300|SCH-U310|SCH-U320|SCH-U350|SCH-U360|SCH-U365|SCH-U370|SCH-U380|SCH-U410|SCH-U430|SCH-U450|SCH-U460|SCH-U470|SCH-U490|SCH-U540|SCH-U550|SCH-U620|SCH-U640|SCH-U650|SCH-U660|SCH-U700|SCH-U740|SCH-U750|SCH-U810|SCH-U820|SCH-U900|SCH-U940|SCH-U960|SCS-26UC|SGH-A107|SGH-A117|SGH-A127|SGH-A137|SGH-A157|SGH-A167|SGH-A177|SGH-A187|SGH-A197|SGH-A227|SGH-A237|SGH-A257|SGH-A437|SGH-A517|SGH-A597|SGH-A637|SGH-A657|SGH-A667|SGH-A687|SGH-A697|SGH-A707|SGH-A717|SGH-A727|SGH-A737|SGH-A747|SGH-A767|SGH-A777|SGH-A797|SGH-A817|SGH-A827|SGH-A837|SGH-A847|SGH-A867|SGH-A877|SGH-A887|SGH-A897|SGH-A927|SGH-B100|SGH-B130|SGH-B200|SGH-B220|SGH-C100|SGH-C110|SGH-C120|SGH-C130|SGH-C140|SGH-C160|SGH-C170|SGH-C180|SGH-C200|SGH-C207|SGH-C210|SGH-C225|SGH-C230|SGH-C417|SGH-C450|SGH-D307|SGH-D347|SGH-D357|SGH-D407|SGH-D415|SGH-D780|SGH-D807|SGH-D980|SGH-E105|SGH-E200|SGH-E315|SGH-E316|SGH-E317|SGH-E335|SGH-E590|SGH-E635|SGH-E715|SGH-E890|SGH-F300|SGH-F480|SGH-I200|SGH-I300|SGH-I320|SGH-I550|SGH-I577|SGH-I600|SGH-I607|SGH-I617|SGH-I627|SGH-I637|SGH-I677|SGH-I700|SGH-I717|SGH-I727|SGH-i747M|SGH-I777|SGH-I780|SGH-I827|SGH-I847|SGH-I857|SGH-I896|SGH-I897|SGH-I900|SGH-I907|SGH-I917|SGH-I927|SGH-I937|SGH-I997|SGH-J150|SGH-J200|SGH-L170|SGH-L700|SGH-M110|SGH-M150|SGH-M200|SGH-N105|SGH-N500|SGH-N600|SGH-N620|SGH-N625|SGH-N700|SGH-N710|SGH-P107|SGH-P207|SGH-P300|SGH-P310|SGH-P520|SGH-P735|SGH-P777|SGH-Q105|SGH-R210|SGH-R220|SGH-R225|SGH-S105|SGH-S307|SGH-T109|SGH-T119|SGH-T139|SGH-T209|SGH-T219|SGH-T229|SGH-T239|SGH-T249|SGH-T259|SGH-T309|SGH-T319|SGH-T329|SGH-T339|SGH-T349|SGH-T359|SGH-T369|SGH-T379|SGH-T409|SGH-T429|SGH-T439|SGH-T459|SGH-T469|SGH-T479|SGH-T499|SGH-T509|SGH-T519|SGH-T539|SGH-T559|SGH-T589|SGH-T609|SGH-T619|SGH-T629|SGH-T639|SGH-T659|SGH-T669|SGH-T679|SGH-T709|SGH-T719|SGH-T729|SGH-T739|SGH-T746|SGH-T749|SGH-T759|SGH-T769|SGH-T809|SGH-T819|SGH-T839|SGH-T919|SGH-T929|SGH-T939|SGH-T959|SGH-T989|SGH-U100|SGH-U200|SGH-U800|SGH-V205|SGH-V206|SGH-X100|SGH-X105|SGH-X120|SGH-X140|SGH-X426|SGH-X427|SGH-X475|SGH-X495|SGH-X497|SGH-X507|SGH-X600|SGH-X610|SGH-X620|SGH-X630|SGH-X700|SGH-X820|SGH-X890|SGH-Z130|SGH-Z150|SGH-Z170|SGH-ZX10|SGH-ZX20|SHW-M110|SPH-A120|SPH-A400|SPH-A420|SPH-A460|SPH-A500|SPH-A560|SPH-A600|SPH-A620|SPH-A660|SPH-A700|SPH-A740|SPH-A760|SPH-A790|SPH-A800|SPH-A820|SPH-A840|SPH-A880|SPH-A900|SPH-A940|SPH-A960|SPH-D600|SPH-D700|SPH-D710|SPH-D720|SPH-I300|SPH-I325|SPH-I330|SPH-I350|SPH-I500|SPH-I600|SPH-I700|SPH-L700|SPH-M100|SPH-M220|SPH-M240|SPH-M300|SPH-M305|SPH-M320|SPH-M330|SPH-M350|SPH-M360|SPH-M370|SPH-M380|SPH-M510|SPH-M540|SPH-M550|SPH-M560|SPH-M570|SPH-M580|SPH-M610|SPH-M620|SPH-M630|SPH-M800|SPH-M810|SPH-M850|SPH-M900|SPH-M910|SPH-M920|SPH-M930|SPH-N100|SPH-N200|SPH-N240|SPH-N300|SPH-N400|SPH-Z400|SWC-E100|SCH-i909|GT-N7100|GT-N7105|SCH-I535|SM-N900A|SGH-I317|SGH-T999L|GT-S5360B|GT-I8262|GT-S6802|GT-S6312|GT-S6310|GT-S5312|GT-S5310|GT-I9105|GT-I8510|GT-S6790N|SM-G7105|SM-N9005|GT-S5301|GT-I9295|GT-I9195|SM-C101|GT-S7392|GT-S7560|GT-B7610|GT-I5510|GT-S7582|GT-S7530E|GT-I8750|SM-G9006V|SM-G9008V|SM-G9009D|SM-G900A|SM-G900D|SM-G900F|SM-G900H|SM-G900I|SM-G900J|SM-G900K|SM-G900L|SM-G900M|SM-G900P|SM-G900R4|SM-G900S|SM-G900T|SM-G900V|SM-G900W8|SHV-E160K|SCH-P709|SCH-P729|SM-T2558|GT-I9205|SM-G9350|SM-J120F|SM-G920F|SM-G920V|SM-G930F|SM-N910C|SM-A310F|GT-I9190|SM-J500FN|SM-G903F|SM-J330F",LG:"\\bLG\\b;|LG[- ]?(C800|C900|E400|E610|E900|E-900|F160|F180K|F180L|F180S|730|855|L160|LS740|LS840|LS970|LU6200|MS690|MS695|MS770|MS840|MS870|MS910|P500|P700|P705|VM696|AS680|AS695|AX840|C729|E970|GS505|272|C395|E739BK|E960|L55C|L75C|LS696|LS860|P769BK|P350|P500|P509|P870|UN272|US730|VS840|VS950|LN272|LN510|LS670|LS855|LW690|MN270|MN510|P509|P769|P930|UN200|UN270|UN510|UN610|US670|US740|US760|UX265|UX840|VN271|VN530|VS660|VS700|VS740|VS750|VS910|VS920|VS930|VX9200|VX11000|AX840A|LW770|P506|P925|P999|E612|D955|D802|MS323|M257)|LM-G710",Sony:"SonyST|SonyLT|SonyEricsson|SonyEricssonLT15iv|LT18i|E10i|LT28h|LT26w|SonyEricssonMT27i|C5303|C6902|C6903|C6906|C6943|D2533",Asus:"Asus.*Galaxy|PadFone.*Mobile",NokiaLumia:"Lumia [0-9]{3,4}",Micromax:"Micromax.*\\b(A210|A92|A88|A72|A111|A110Q|A115|A116|A110|A90S|A26|A51|A35|A54|A25|A27|A89|A68|A65|A57|A90)\\b",Palm:"PalmSource|Palm",Vertu:"Vertu|Vertu.*Ltd|Vertu.*Ascent|Vertu.*Ayxta|Vertu.*Constellation(F|Quest)?|Vertu.*Monika|Vertu.*Signature",Pantech:"PANTECH|IM-A850S|IM-A840S|IM-A830L|IM-A830K|IM-A830S|IM-A820L|IM-A810K|IM-A810S|IM-A800S|IM-T100K|IM-A725L|IM-A780L|IM-A775C|IM-A770K|IM-A760S|IM-A750K|IM-A740S|IM-A730S|IM-A720L|IM-A710K|IM-A690L|IM-A690S|IM-A650S|IM-A630K|IM-A600S|VEGA PTL21|PT003|P8010|ADR910L|P6030|P6020|P9070|P4100|P9060|P5000|CDM8992|TXT8045|ADR8995|IS11PT|P2030|P6010|P8000|PT002|IS06|CDM8999|P9050|PT001|TXT8040|P2020|P9020|P2000|P7040|P7000|C790",Fly:"IQ230|IQ444|IQ450|IQ440|IQ442|IQ441|IQ245|IQ256|IQ236|IQ255|IQ235|IQ245|IQ275|IQ240|IQ285|IQ280|IQ270|IQ260|IQ250",Wiko:"KITE 4G|HIGHWAY|GETAWAY|STAIRWAY|DARKSIDE|DARKFULL|DARKNIGHT|DARKMOON|SLIDE|WAX 4G|RAINBOW|BLOOM|SUNSET|GOA(?!nna)|LENNY|BARRY|IGGY|OZZY|CINK FIVE|CINK PEAX|CINK PEAX 2|CINK SLIM|CINK SLIM 2|CINK +|CINK KING|CINK PEAX|CINK SLIM|SUBLIM",iMobile:"i-mobile (IQ|i-STYLE|idea|ZAA|Hitz)",SimValley:"\\b(SP-80|XT-930|SX-340|XT-930|SX-310|SP-360|SP60|SPT-800|SP-120|SPT-800|SP-140|SPX-5|SPX-8|SP-100|SPX-8|SPX-12)\\b",Wolfgang:"AT-B24D|AT-AS50HD|AT-AS40W|AT-AS55HD|AT-AS45q2|AT-B26D|AT-AS50Q",Alcatel:"Alcatel",Nintendo:"Nintendo (3DS|Switch)",Amoi:"Amoi",INQ:"INQ",OnePlus:"ONEPLUS",GenericPhone:"Tapatalk|PDA;|SAGEM|\\bmmp\\b|pocket|\\bpsp\\b|symbian|Smartphone|smartfon|treo|up.browser|up.link|vodafone|\\bwap\\b|nokia|Series40|Series60|S60|SonyEricsson|N900|MAUI.*WAP.*Browser"},tablets:{iPad:"iPad|iPad.*Mobile",NexusTablet:"Android.*Nexus[\\s]+(7|9|10)",GoogleTablet:"Android.*Pixel C",SamsungTablet:"SAMSUNG.*Tablet|Galaxy.*Tab|SC-01C|GT-P1000|GT-P1003|GT-P1010|GT-P3105|GT-P6210|GT-P6800|GT-P6810|GT-P7100|GT-P7300|GT-P7310|GT-P7500|GT-P7510|SCH-I800|SCH-I815|SCH-I905|SGH-I957|SGH-I987|SGH-T849|SGH-T859|SGH-T869|SPH-P100|GT-P3100|GT-P3108|GT-P3110|GT-P5100|GT-P5110|GT-P6200|GT-P7320|GT-P7511|GT-N8000|GT-P8510|SGH-I497|SPH-P500|SGH-T779|SCH-I705|SCH-I915|GT-N8013|GT-P3113|GT-P5113|GT-P8110|GT-N8010|GT-N8005|GT-N8020|GT-P1013|GT-P6201|GT-P7501|GT-N5100|GT-N5105|GT-N5110|SHV-E140K|SHV-E140L|SHV-E140S|SHV-E150S|SHV-E230K|SHV-E230L|SHV-E230S|SHW-M180K|SHW-M180L|SHW-M180S|SHW-M180W|SHW-M300W|SHW-M305W|SHW-M380K|SHW-M380S|SHW-M380W|SHW-M430W|SHW-M480K|SHW-M480S|SHW-M480W|SHW-M485W|SHW-M486W|SHW-M500W|GT-I9228|SCH-P739|SCH-I925|GT-I9200|GT-P5200|GT-P5210|GT-P5210X|SM-T311|SM-T310|SM-T310X|SM-T210|SM-T210R|SM-T211|SM-P600|SM-P601|SM-P605|SM-P900|SM-P901|SM-T217|SM-T217A|SM-T217S|SM-P6000|SM-T3100|SGH-I467|XE500|SM-T110|GT-P5220|GT-I9200X|GT-N5110X|GT-N5120|SM-P905|SM-T111|SM-T2105|SM-T315|SM-T320|SM-T320X|SM-T321|SM-T520|SM-T525|SM-T530NU|SM-T230NU|SM-T330NU|SM-T900|XE500T1C|SM-P605V|SM-P905V|SM-T337V|SM-T537V|SM-T707V|SM-T807V|SM-P600X|SM-P900X|SM-T210X|SM-T230|SM-T230X|SM-T325|GT-P7503|SM-T531|SM-T330|SM-T530|SM-T705|SM-T705C|SM-T535|SM-T331|SM-T800|SM-T700|SM-T537|SM-T807|SM-P907A|SM-T337A|SM-T537A|SM-T707A|SM-T807A|SM-T237|SM-T807P|SM-P607T|SM-T217T|SM-T337T|SM-T807T|SM-T116NQ|SM-T116BU|SM-P550|SM-T350|SM-T550|SM-T9000|SM-P9000|SM-T705Y|SM-T805|GT-P3113|SM-T710|SM-T810|SM-T815|SM-T360|SM-T533|SM-T113|SM-T335|SM-T715|SM-T560|SM-T670|SM-T677|SM-T377|SM-T567|SM-T357T|SM-T555|SM-T561|SM-T713|SM-T719|SM-T813|SM-T819|SM-T580|SM-T355Y?|SM-T280|SM-T817A|SM-T820|SM-W700|SM-P580|SM-T587|SM-P350|SM-P555M|SM-P355M|SM-T113NU|SM-T815Y|SM-T585|SM-T285|SM-T825|SM-W708|SM-T835|SM-T830|SM-T837V|SM-T720|SM-T510|SM-T387V",Kindle:"Kindle|Silk.*Accelerated|Android.*\\b(KFOT|KFTT|KFJWI|KFJWA|KFOTE|KFSOWI|KFTHWI|KFTHWA|KFAPWI|KFAPWA|WFJWAE|KFSAWA|KFSAWI|KFASWI|KFARWI|KFFOWI|KFGIWI|KFMEWI)\\b|Android.*Silk/[0-9.]+ like Chrome/[0-9.]+ (?!Mobile)",SurfaceTablet:"Windows NT [0-9.]+; ARM;.*(Tablet|ARMBJS)",HPTablet:"HP Slate (7|8|10)|HP ElitePad 900|hp-tablet|EliteBook.*Touch|HP 8|Slate 21|HP SlateBook 10",AsusTablet:"^.*PadFone((?!Mobile).)*$|Transformer|TF101|TF101G|TF300T|TF300TG|TF300TL|TF700T|TF700KL|TF701T|TF810C|ME171|ME301T|ME302C|ME371MG|ME370T|ME372MG|ME172V|ME173X|ME400C|Slider SL101|\\bK00F\\b|\\bK00C\\b|\\bK00E\\b|\\bK00L\\b|TX201LA|ME176C|ME102A|\\bM80TA\\b|ME372CL|ME560CG|ME372CG|ME302KL| K010 | K011 | K017 | K01E |ME572C|ME103K|ME170C|ME171C|\\bME70C\\b|ME581C|ME581CL|ME8510C|ME181C|P01Y|PO1MA|P01Z|\\bP027\\b|\\bP024\\b|\\bP00C\\b",BlackBerryTablet:"PlayBook|RIM Tablet",HTCtablet:"HTC_Flyer_P512|HTC Flyer|HTC Jetstream|HTC-P715a|HTC EVO View 4G|PG41200|PG09410",MotorolaTablet:"xoom|sholest|MZ615|MZ605|MZ505|MZ601|MZ602|MZ603|MZ604|MZ606|MZ607|MZ608|MZ609|MZ615|MZ616|MZ617",NookTablet:"Android.*Nook|NookColor|nook browser|BNRV200|BNRV200A|BNTV250|BNTV250A|BNTV400|BNTV600|LogicPD Zoom2",AcerTablet:"Android.*; \\b(A100|A101|A110|A200|A210|A211|A500|A501|A510|A511|A700|A701|W500|W500P|W501|W501P|W510|W511|W700|G100|G100W|B1-A71|B1-710|B1-711|A1-810|A1-811|A1-830)\\b|W3-810|\\bA3-A10\\b|\\bA3-A11\\b|\\bA3-A20\\b|\\bA3-A30",ToshibaTablet:"Android.*(AT100|AT105|AT200|AT205|AT270|AT275|AT300|AT305|AT1S5|AT500|AT570|AT700|AT830)|TOSHIBA.*FOLIO",LGTablet:"\\bL-06C|LG-V909|LG-V900|LG-V700|LG-V510|LG-V500|LG-V410|LG-V400|LG-VK810\\b",FujitsuTablet:"Android.*\\b(F-01D|F-02F|F-05E|F-10D|M532|Q572)\\b",PrestigioTablet:"PMP3170B|PMP3270B|PMP3470B|PMP7170B|PMP3370B|PMP3570C|PMP5870C|PMP3670B|PMP5570C|PMP5770D|PMP3970B|PMP3870C|PMP5580C|PMP5880D|PMP5780D|PMP5588C|PMP7280C|PMP7280C3G|PMP7280|PMP7880D|PMP5597D|PMP5597|PMP7100D|PER3464|PER3274|PER3574|PER3884|PER5274|PER5474|PMP5097CPRO|PMP5097|PMP7380D|PMP5297C|PMP5297C_QUAD|PMP812E|PMP812E3G|PMP812F|PMP810E|PMP880TD|PMT3017|PMT3037|PMT3047|PMT3057|PMT7008|PMT5887|PMT5001|PMT5002",LenovoTablet:"Lenovo TAB|Idea(Tab|Pad)( A1|A10| K1|)|ThinkPad([ ]+)?Tablet|YT3-850M|YT3-X90L|YT3-X90F|YT3-X90X|Lenovo.*(S2109|S2110|S5000|S6000|K3011|A3000|A3500|A1000|A2107|A2109|A1107|A5500|A7600|B6000|B8000|B8080)(-|)(FL|F|HV|H|)|TB-X103F|TB-X304X|TB-X304F|TB-X304L|TB-X505F|TB-X505L|TB-X505X|TB-X605F|TB-X605L|TB-8703F|TB-8703X|TB-8703N|TB-8704N|TB-8704F|TB-8704X|TB-8704V|TB-7304F|TB-7304I|TB-7304X|Tab2A7-10F|Tab2A7-20F|TB2-X30L|YT3-X50L|YT3-X50F|YT3-X50M|YT-X705F|YT-X703F|YT-X703L|YT-X705L|YT-X705X|TB2-X30F|TB2-X30L|TB2-X30M|A2107A-F|A2107A-H|TB3-730F|TB3-730M|TB3-730X|TB-7504F|TB-7504X",DellTablet:"Venue 11|Venue 8|Venue 7|Dell Streak 10|Dell Streak 7",YarvikTablet:"Android.*\\b(TAB210|TAB211|TAB224|TAB250|TAB260|TAB264|TAB310|TAB360|TAB364|TAB410|TAB411|TAB420|TAB424|TAB450|TAB460|TAB461|TAB464|TAB465|TAB467|TAB468|TAB07-100|TAB07-101|TAB07-150|TAB07-151|TAB07-152|TAB07-200|TAB07-201-3G|TAB07-210|TAB07-211|TAB07-212|TAB07-214|TAB07-220|TAB07-400|TAB07-485|TAB08-150|TAB08-200|TAB08-201-3G|TAB08-201-30|TAB09-100|TAB09-211|TAB09-410|TAB10-150|TAB10-201|TAB10-211|TAB10-400|TAB10-410|TAB13-201|TAB274EUK|TAB275EUK|TAB374EUK|TAB462EUK|TAB474EUK|TAB9-200)\\b",MedionTablet:"Android.*\\bOYO\\b|LIFE.*(P9212|P9514|P9516|S9512)|LIFETAB",ArnovaTablet:"97G4|AN10G2|AN7bG3|AN7fG3|AN8G3|AN8cG3|AN7G3|AN9G3|AN7dG3|AN7dG3ST|AN7dG3ChildPad|AN10bG3|AN10bG3DT|AN9G2",IntensoTablet:"INM8002KP|INM1010FP|INM805ND|Intenso Tab|TAB1004",IRUTablet:"M702pro",MegafonTablet:"MegaFon V9|\\bZTE V9\\b|Android.*\\bMT7A\\b",EbodaTablet:"E-Boda (Supreme|Impresspeed|Izzycomm|Essential)",AllViewTablet:"Allview.*(Viva|Alldro|City|Speed|All TV|Frenzy|Quasar|Shine|TX1|AX1|AX2)",ArchosTablet:"\\b(101G9|80G9|A101IT)\\b|Qilive 97R|Archos5|\\bARCHOS (70|79|80|90|97|101|FAMILYPAD|)(b|c|)(G10| Cobalt| TITANIUM(HD|)| Xenon| Neon|XSK| 2| XS 2| PLATINUM| CARBON|GAMEPAD)\\b",AinolTablet:"NOVO7|NOVO8|NOVO10|Novo7Aurora|Novo7Basic|NOVO7PALADIN|novo9-Spark",NokiaLumiaTablet:"Lumia 2520",SonyTablet:"Sony.*Tablet|Xperia Tablet|Sony Tablet S|SO-03E|SGPT12|SGPT13|SGPT114|SGPT121|SGPT122|SGPT123|SGPT111|SGPT112|SGPT113|SGPT131|SGPT132|SGPT133|SGPT211|SGPT212|SGPT213|SGP311|SGP312|SGP321|EBRD1101|EBRD1102|EBRD1201|SGP351|SGP341|SGP511|SGP512|SGP521|SGP541|SGP551|SGP621|SGP641|SGP612|SOT31|SGP771|SGP611|SGP612|SGP712",PhilipsTablet:"\\b(PI2010|PI3000|PI3100|PI3105|PI3110|PI3205|PI3210|PI3900|PI4010|PI7000|PI7100)\\b",CubeTablet:"Android.*(K8GT|U9GT|U10GT|U16GT|U17GT|U18GT|U19GT|U20GT|U23GT|U30GT)|CUBE U8GT",CobyTablet:"MID1042|MID1045|MID1125|MID1126|MID7012|MID7014|MID7015|MID7034|MID7035|MID7036|MID7042|MID7048|MID7127|MID8042|MID8048|MID8127|MID9042|MID9740|MID9742|MID7022|MID7010",MIDTablet:"M9701|M9000|M9100|M806|M1052|M806|T703|MID701|MID713|MID710|MID727|MID760|MID830|MID728|MID933|MID125|MID810|MID732|MID120|MID930|MID800|MID731|MID900|MID100|MID820|MID735|MID980|MID130|MID833|MID737|MID960|MID135|MID860|MID736|MID140|MID930|MID835|MID733|MID4X10",MSITablet:"MSI \\b(Primo 73K|Primo 73L|Primo 81L|Primo 77|Primo 93|Primo 75|Primo 76|Primo 73|Primo 81|Primo 91|Primo 90|Enjoy 71|Enjoy 7|Enjoy 10)\\b",SMiTTablet:"Android.*(\\bMID\\b|MID-560|MTV-T1200|MTV-PND531|MTV-P1101|MTV-PND530)",RockChipTablet:"Android.*(RK2818|RK2808A|RK2918|RK3066)|RK2738|RK2808A",FlyTablet:"IQ310|Fly Vision",bqTablet:"Android.*(bq)?.*\\b(Elcano|Curie|Edison|Maxwell|Kepler|Pascal|Tesla|Hypatia|Platon|Newton|Livingstone|Cervantes|Avant|Aquaris ([E|M]10|M8))\\b|Maxwell.*Lite|Maxwell.*Plus",HuaweiTablet:"MediaPad|MediaPad 7 Youth|IDEOS S7|S7-201c|S7-202u|S7-101|S7-103|S7-104|S7-105|S7-106|S7-201|S7-Slim|M2-A01L|BAH-L09|BAH-W09|AGS-L09|CMR-AL19",NecTablet:"\\bN-06D|\\bN-08D",PantechTablet:"Pantech.*P4100",BronchoTablet:"Broncho.*(N701|N708|N802|a710)",VersusTablet:"TOUCHPAD.*[78910]|\\bTOUCHTAB\\b",ZyncTablet:"z1000|Z99 2G|z930|z990|z909|Z919|z900",PositivoTablet:"TB07STA|TB10STA|TB07FTA|TB10FTA",NabiTablet:"Android.*\\bNabi",KoboTablet:"Kobo Touch|\\bK080\\b|\\bVox\\b Build|\\bArc\\b Build",DanewTablet:"DSlide.*\\b(700|701R|702|703R|704|802|970|971|972|973|974|1010|1012)\\b",TexetTablet:"NaviPad|TB-772A|TM-7045|TM-7055|TM-9750|TM-7016|TM-7024|TM-7026|TM-7041|TM-7043|TM-7047|TM-8041|TM-9741|TM-9747|TM-9748|TM-9751|TM-7022|TM-7021|TM-7020|TM-7011|TM-7010|TM-7023|TM-7025|TM-7037W|TM-7038W|TM-7027W|TM-9720|TM-9725|TM-9737W|TM-1020|TM-9738W|TM-9740|TM-9743W|TB-807A|TB-771A|TB-727A|TB-725A|TB-719A|TB-823A|TB-805A|TB-723A|TB-715A|TB-707A|TB-705A|TB-709A|TB-711A|TB-890HD|TB-880HD|TB-790HD|TB-780HD|TB-770HD|TB-721HD|TB-710HD|TB-434HD|TB-860HD|TB-840HD|TB-760HD|TB-750HD|TB-740HD|TB-730HD|TB-722HD|TB-720HD|TB-700HD|TB-500HD|TB-470HD|TB-431HD|TB-430HD|TB-506|TB-504|TB-446|TB-436|TB-416|TB-146SE|TB-126SE",PlaystationTablet:"Playstation.*(Portable|Vita)",TrekstorTablet:"ST10416-1|VT10416-1|ST70408-1|ST702xx-1|ST702xx-2|ST80208|ST97216|ST70104-2|VT10416-2|ST10216-2A|SurfTab",PyleAudioTablet:"\\b(PTBL10CEU|PTBL10C|PTBL72BC|PTBL72BCEU|PTBL7CEU|PTBL7C|PTBL92BC|PTBL92BCEU|PTBL9CEU|PTBL9CUK|PTBL9C)\\b",AdvanTablet:"Android.* \\b(E3A|T3X|T5C|T5B|T3E|T3C|T3B|T1J|T1F|T2A|T1H|T1i|E1C|T1-E|T5-A|T4|E1-B|T2Ci|T1-B|T1-D|O1-A|E1-A|T1-A|T3A|T4i)\\b ",DanyTechTablet:"Genius Tab G3|Genius Tab S2|Genius Tab Q3|Genius Tab G4|Genius Tab Q4|Genius Tab G-II|Genius TAB GII|Genius TAB GIII|Genius Tab S1",GalapadTablet:"Android.*\\bG1\\b(?!\\))",MicromaxTablet:"Funbook|Micromax.*\\b(P250|P560|P360|P362|P600|P300|P350|P500|P275)\\b",KarbonnTablet:"Android.*\\b(A39|A37|A34|ST8|ST10|ST7|Smart Tab3|Smart Tab2)\\b",AllFineTablet:"Fine7 Genius|Fine7 Shine|Fine7 Air|Fine8 Style|Fine9 More|Fine10 Joy|Fine11 Wide",PROSCANTablet:"\\b(PEM63|PLT1023G|PLT1041|PLT1044|PLT1044G|PLT1091|PLT4311|PLT4311PL|PLT4315|PLT7030|PLT7033|PLT7033D|PLT7035|PLT7035D|PLT7044K|PLT7045K|PLT7045KB|PLT7071KG|PLT7072|PLT7223G|PLT7225G|PLT7777G|PLT7810K|PLT7849G|PLT7851G|PLT7852G|PLT8015|PLT8031|PLT8034|PLT8036|PLT8080K|PLT8082|PLT8088|PLT8223G|PLT8234G|PLT8235G|PLT8816K|PLT9011|PLT9045K|PLT9233G|PLT9735|PLT9760G|PLT9770G)\\b",YONESTablet:"BQ1078|BC1003|BC1077|RK9702|BC9730|BC9001|IT9001|BC7008|BC7010|BC708|BC728|BC7012|BC7030|BC7027|BC7026",ChangJiaTablet:"TPC7102|TPC7103|TPC7105|TPC7106|TPC7107|TPC7201|TPC7203|TPC7205|TPC7210|TPC7708|TPC7709|TPC7712|TPC7110|TPC8101|TPC8103|TPC8105|TPC8106|TPC8203|TPC8205|TPC8503|TPC9106|TPC9701|TPC97101|TPC97103|TPC97105|TPC97106|TPC97111|TPC97113|TPC97203|TPC97603|TPC97809|TPC97205|TPC10101|TPC10103|TPC10106|TPC10111|TPC10203|TPC10205|TPC10503",GUTablet:"TX-A1301|TX-M9002|Q702|kf026",PointOfViewTablet:"TAB-P506|TAB-navi-7-3G-M|TAB-P517|TAB-P-527|TAB-P701|TAB-P703|TAB-P721|TAB-P731N|TAB-P741|TAB-P825|TAB-P905|TAB-P925|TAB-PR945|TAB-PL1015|TAB-P1025|TAB-PI1045|TAB-P1325|TAB-PROTAB[0-9]+|TAB-PROTAB25|TAB-PROTAB26|TAB-PROTAB27|TAB-PROTAB26XL|TAB-PROTAB2-IPS9|TAB-PROTAB30-IPS9|TAB-PROTAB25XXL|TAB-PROTAB26-IPS10|TAB-PROTAB30-IPS10",OvermaxTablet:"OV-(SteelCore|NewBase|Basecore|Baseone|Exellen|Quattor|EduTab|Solution|ACTION|BasicTab|TeddyTab|MagicTab|Stream|TB-08|TB-09)|Qualcore 1027",HCLTablet:"HCL.*Tablet|Connect-3G-2.0|Connect-2G-2.0|ME Tablet U1|ME Tablet U2|ME Tablet G1|ME Tablet X1|ME Tablet Y2|ME Tablet Sync",DPSTablet:"DPS Dream 9|DPS Dual 7",VistureTablet:"V97 HD|i75 3G|Visture V4( HD)?|Visture V5( HD)?|Visture V10",CrestaTablet:"CTP(-)?810|CTP(-)?818|CTP(-)?828|CTP(-)?838|CTP(-)?888|CTP(-)?978|CTP(-)?980|CTP(-)?987|CTP(-)?988|CTP(-)?989",MediatekTablet:"\\bMT8125|MT8389|MT8135|MT8377\\b",ConcordeTablet:"Concorde([ ]+)?Tab|ConCorde ReadMan",GoCleverTablet:"GOCLEVER TAB|A7GOCLEVER|M1042|M7841|M742|R1042BK|R1041|TAB A975|TAB A7842|TAB A741|TAB A741L|TAB M723G|TAB M721|TAB A1021|TAB I921|TAB R721|TAB I720|TAB T76|TAB R70|TAB R76.2|TAB R106|TAB R83.2|TAB M813G|TAB I721|GCTA722|TAB I70|TAB I71|TAB S73|TAB R73|TAB R74|TAB R93|TAB R75|TAB R76.1|TAB A73|TAB A93|TAB A93.2|TAB T72|TAB R83|TAB R974|TAB R973|TAB A101|TAB A103|TAB A104|TAB A104.2|R105BK|M713G|A972BK|TAB A971|TAB R974.2|TAB R104|TAB R83.3|TAB A1042",ModecomTablet:"FreeTAB 9000|FreeTAB 7.4|FreeTAB 7004|FreeTAB 7800|FreeTAB 2096|FreeTAB 7.5|FreeTAB 1014|FreeTAB 1001 |FreeTAB 8001|FreeTAB 9706|FreeTAB 9702|FreeTAB 7003|FreeTAB 7002|FreeTAB 1002|FreeTAB 7801|FreeTAB 1331|FreeTAB 1004|FreeTAB 8002|FreeTAB 8014|FreeTAB 9704|FreeTAB 1003",VoninoTablet:"\\b(Argus[ _]?S|Diamond[ _]?79HD|Emerald[ _]?78E|Luna[ _]?70C|Onyx[ _]?S|Onyx[ _]?Z|Orin[ _]?HD|Orin[ _]?S|Otis[ _]?S|SpeedStar[ _]?S|Magnet[ _]?M9|Primus[ _]?94[ _]?3G|Primus[ _]?94HD|Primus[ _]?QS|Android.*\\bQ8\\b|Sirius[ _]?EVO[ _]?QS|Sirius[ _]?QS|Spirit[ _]?S)\\b",ECSTablet:"V07OT2|TM105A|S10OT1|TR10CS1",StorexTablet:"eZee[_']?(Tab|Go)[0-9]+|TabLC7|Looney Tunes Tab",VodafoneTablet:"SmartTab([ ]+)?[0-9]+|SmartTabII10|SmartTabII7|VF-1497|VFD 1400",EssentielBTablet:"Smart[ ']?TAB[ ]+?[0-9]+|Family[ ']?TAB2",RossMoorTablet:"RM-790|RM-997|RMD-878G|RMD-974R|RMT-705A|RMT-701|RME-601|RMT-501|RMT-711",iMobileTablet:"i-mobile i-note",TolinoTablet:"tolino tab [0-9.]+|tolino shine",AudioSonicTablet:"\\bC-22Q|T7-QC|T-17B|T-17P\\b",AMPETablet:"Android.* A78 ",SkkTablet:"Android.* (SKYPAD|PHOENIX|CYCLOPS)",TecnoTablet:"TECNO P9|TECNO DP8D",JXDTablet:"Android.* \\b(F3000|A3300|JXD5000|JXD3000|JXD2000|JXD300B|JXD300|S5800|S7800|S602b|S5110b|S7300|S5300|S602|S603|S5100|S5110|S601|S7100a|P3000F|P3000s|P101|P200s|P1000m|P200m|P9100|P1000s|S6600b|S908|P1000|P300|S18|S6600|S9100)\\b",iJoyTablet:"Tablet (Spirit 7|Essentia|Galatea|Fusion|Onix 7|Landa|Titan|Scooby|Deox|Stella|Themis|Argon|Unique 7|Sygnus|Hexen|Finity 7|Cream|Cream X2|Jade|Neon 7|Neron 7|Kandy|Scape|Saphyr 7|Rebel|Biox|Rebel|Rebel 8GB|Myst|Draco 7|Myst|Tab7-004|Myst|Tadeo Jones|Tablet Boing|Arrow|Draco Dual Cam|Aurix|Mint|Amity|Revolution|Finity 9|Neon 9|T9w|Amity 4GB Dual Cam|Stone 4GB|Stone 8GB|Andromeda|Silken|X2|Andromeda II|Halley|Flame|Saphyr 9,7|Touch 8|Planet|Triton|Unique 10|Hexen 10|Memphis 4GB|Memphis 8GB|Onix 10)",FX2Tablet:"FX2 PAD7|FX2 PAD10",XoroTablet:"KidsPAD 701|PAD[ ]?712|PAD[ ]?714|PAD[ ]?716|PAD[ ]?717|PAD[ ]?718|PAD[ ]?720|PAD[ ]?721|PAD[ ]?722|PAD[ ]?790|PAD[ ]?792|PAD[ ]?900|PAD[ ]?9715D|PAD[ ]?9716DR|PAD[ ]?9718DR|PAD[ ]?9719QR|PAD[ ]?9720QR|TelePAD1030|Telepad1032|TelePAD730|TelePAD731|TelePAD732|TelePAD735Q|TelePAD830|TelePAD9730|TelePAD795|MegaPAD 1331|MegaPAD 1851|MegaPAD 2151",ViewsonicTablet:"ViewPad 10pi|ViewPad 10e|ViewPad 10s|ViewPad E72|ViewPad7|ViewPad E100|ViewPad 7e|ViewSonic VB733|VB100a",VerizonTablet:"QTAQZ3|QTAIR7|QTAQTZ3|QTASUN1|QTASUN2|QTAXIA1",OdysTablet:"LOOX|XENO10|ODYS[ -](Space|EVO|Xpress|NOON)|\\bXELIO\\b|Xelio10Pro|XELIO7PHONETAB|XELIO10EXTREME|XELIOPT2|NEO_QUAD10",CaptivaTablet:"CAPTIVA PAD",IconbitTablet:"NetTAB|NT-3702|NT-3702S|NT-3702S|NT-3603P|NT-3603P|NT-0704S|NT-0704S|NT-3805C|NT-3805C|NT-0806C|NT-0806C|NT-0909T|NT-0909T|NT-0907S|NT-0907S|NT-0902S|NT-0902S",TeclastTablet:"T98 4G|\\bP80\\b|\\bX90HD\\b|X98 Air|X98 Air 3G|\\bX89\\b|P80 3G|\\bX80h\\b|P98 Air|\\bX89HD\\b|P98 3G|\\bP90HD\\b|P89 3G|X98 3G|\\bP70h\\b|P79HD 3G|G18d 3G|\\bP79HD\\b|\\bP89s\\b|\\bA88\\b|\\bP10HD\\b|\\bP19HD\\b|G18 3G|\\bP78HD\\b|\\bA78\\b|\\bP75\\b|G17s 3G|G17h 3G|\\bP85t\\b|\\bP90\\b|\\bP11\\b|\\bP98t\\b|\\bP98HD\\b|\\bG18d\\b|\\bP85s\\b|\\bP11HD\\b|\\bP88s\\b|\\bA80HD\\b|\\bA80se\\b|\\bA10h\\b|\\bP89\\b|\\bP78s\\b|\\bG18\\b|\\bP85\\b|\\bA70h\\b|\\bA70\\b|\\bG17\\b|\\bP18\\b|\\bA80s\\b|\\bA11s\\b|\\bP88HD\\b|\\bA80h\\b|\\bP76s\\b|\\bP76h\\b|\\bP98\\b|\\bA10HD\\b|\\bP78\\b|\\bP88\\b|\\bA11\\b|\\bA10t\\b|\\bP76a\\b|\\bP76t\\b|\\bP76e\\b|\\bP85HD\\b|\\bP85a\\b|\\bP86\\b|\\bP75HD\\b|\\bP76v\\b|\\bA12\\b|\\bP75a\\b|\\bA15\\b|\\bP76Ti\\b|\\bP81HD\\b|\\bA10\\b|\\bT760VE\\b|\\bT720HD\\b|\\bP76\\b|\\bP73\\b|\\bP71\\b|\\bP72\\b|\\bT720SE\\b|\\bC520Ti\\b|\\bT760\\b|\\bT720VE\\b|T720-3GE|T720-WiFi",OndaTablet:"\\b(V975i|Vi30|VX530|V701|Vi60|V701s|Vi50|V801s|V719|Vx610w|VX610W|V819i|Vi10|VX580W|Vi10|V711s|V813|V811|V820w|V820|Vi20|V711|VI30W|V712|V891w|V972|V819w|V820w|Vi60|V820w|V711|V813s|V801|V819|V975s|V801|V819|V819|V818|V811|V712|V975m|V101w|V961w|V812|V818|V971|V971s|V919|V989|V116w|V102w|V973|Vi40)\\b[\\s]+|V10 \\b4G\\b",JaytechTablet:"TPC-PA762",BlaupunktTablet:"Endeavour 800NG|Endeavour 1010",DigmaTablet:"\\b(iDx10|iDx9|iDx8|iDx7|iDxD7|iDxD8|iDsQ8|iDsQ7|iDsQ8|iDsD10|iDnD7|3TS804H|iDsQ11|iDj7|iDs10)\\b",EvolioTablet:"ARIA_Mini_wifi|Aria[ _]Mini|Evolio X10|Evolio X7|Evolio X8|\\bEvotab\\b|\\bNeura\\b",LavaTablet:"QPAD E704|\\bIvoryS\\b|E-TAB IVORY|\\bE-TAB\\b",AocTablet:"MW0811|MW0812|MW0922|MTK8382|MW1031|MW0831|MW0821|MW0931|MW0712",MpmanTablet:"MP11 OCTA|MP10 OCTA|MPQC1114|MPQC1004|MPQC994|MPQC974|MPQC973|MPQC804|MPQC784|MPQC780|\\bMPG7\\b|MPDCG75|MPDCG71|MPDC1006|MP101DC|MPDC9000|MPDC905|MPDC706HD|MPDC706|MPDC705|MPDC110|MPDC100|MPDC99|MPDC97|MPDC88|MPDC8|MPDC77|MP709|MID701|MID711|MID170|MPDC703|MPQC1010",CelkonTablet:"CT695|CT888|CT[\\s]?910|CT7 Tab|CT9 Tab|CT3 Tab|CT2 Tab|CT1 Tab|C820|C720|\\bCT-1\\b",WolderTablet:"miTab \\b(DIAMOND|SPACE|BROOKLYN|NEO|FLY|MANHATTAN|FUNK|EVOLUTION|SKY|GOCAR|IRON|GENIUS|POP|MINT|EPSILON|BROADWAY|JUMP|HOP|LEGEND|NEW AGE|LINE|ADVANCE|FEEL|FOLLOW|LIKE|LINK|LIVE|THINK|FREEDOM|CHICAGO|CLEVELAND|BALTIMORE-GH|IOWA|BOSTON|SEATTLE|PHOENIX|DALLAS|IN 101|MasterChef)\\b",MediacomTablet:"M-MPI10C3G|M-SP10EG|M-SP10EGP|M-SP10HXAH|M-SP7HXAH|M-SP10HXBH|M-SP8HXAH|M-SP8MXA",MiTablet:"\\bMI PAD\\b|\\bHM NOTE 1W\\b",NibiruTablet:"Nibiru M1|Nibiru Jupiter One",NexoTablet:"NEXO NOVA|NEXO 10|NEXO AVIO|NEXO FREE|NEXO GO|NEXO EVO|NEXO 3G|NEXO SMART|NEXO KIDDO|NEXO MOBI",LeaderTablet:"TBLT10Q|TBLT10I|TBL-10WDKB|TBL-10WDKBO2013|TBL-W230V2|TBL-W450|TBL-W500|SV572|TBLT7I|TBA-AC7-8G|TBLT79|TBL-8W16|TBL-10W32|TBL-10WKB|TBL-W100",UbislateTablet:"UbiSlate[\\s]?7C",PocketBookTablet:"Pocketbook",KocasoTablet:"\\b(TB-1207)\\b",HisenseTablet:"\\b(F5281|E2371)\\b",Hudl:"Hudl HT7S3|Hudl 2",TelstraTablet:"T-Hub2",GenericTablet:"Android.*\\b97D\\b|Tablet(?!.*PC)|BNTV250A|MID-WCDMA|LogicPD Zoom2|\\bA7EB\\b|CatNova8|A1_07|CT704|CT1002|\\bM721\\b|rk30sdk|\\bEVOTAB\\b|M758A|ET904|ALUMIUM10|Smartfren Tab|Endeavour 1010|Tablet-PC-4|Tagi Tab|\\bM6pro\\b|CT1020W|arc 10HD|\\bTP750\\b|\\bQTAQZ3\\b|WVT101|TM1088|KT107"},oss:{AndroidOS:"Android",BlackBerryOS:"blackberry|\\bBB10\\b|rim tablet os",PalmOS:"PalmOS|avantgo|blazer|elaine|hiptop|palm|plucker|xiino",SymbianOS:"Symbian|SymbOS|Series60|Series40|SYB-[0-9]+|\\bS60\\b",WindowsMobileOS:"Windows CE.*(PPC|Smartphone|Mobile|[0-9]{3}x[0-9]{3})|Windows Mobile|Windows Phone [0-9.]+|WCE;",WindowsPhoneOS:"Windows Phone 10.0|Windows Phone 8.1|Windows Phone 8.0|Windows Phone OS|XBLWP7|ZuneWP7|Windows NT 6.[23]; ARM;",iOS:"\\biPhone.*Mobile|\\biPod|\\biPad|AppleCoreMedia",iPadOS:"CPU OS 13",MeeGoOS:"MeeGo",MaemoOS:"Maemo",JavaOS:"J2ME/|\\bMIDP\\b|\\bCLDC\\b",webOS:"webOS|hpwOS",badaOS:"\\bBada\\b",BREWOS:"BREW"},uas:{Chrome:"\\bCrMo\\b|CriOS|Android.*Chrome/[.0-9]* (Mobile)?",Dolfin:"\\bDolfin\\b",Opera:"Opera.*Mini|Opera.*Mobi|Android.*Opera|Mobile.*OPR/[0-9.]+$|Coast/[0-9.]+",Skyfire:"Skyfire",Edge:"Mobile Safari/[.0-9]* Edge",IE:"IEMobile|MSIEMobile",Firefox:"fennec|firefox.*maemo|(Mobile|Tablet).*Firefox|Firefox.*Mobile|FxiOS",Bolt:"bolt",TeaShark:"teashark",Blazer:"Blazer",Safari:"Version.*Mobile.*Safari|Safari.*Mobile|MobileSafari",WeChat:"\\bMicroMessenger\\b",UCBrowser:"UC.*Browser|UCWEB",baiduboxapp:"baiduboxapp",baidubrowser:"baidubrowser",DiigoBrowser:"DiigoBrowser",Mercury:"\\bMercury\\b",ObigoBrowser:"Obigo",NetFront:"NF-Browser",GenericBrowser:"NokiaBrowser|OviBrowser|OneBrowser|TwonkyBeamBrowser|SEMC.*Browser|FlyFlow|Minimo|NetFront|Novarra-Vision|MQQBrowser|MicroMessenger",PaleMoon:"Android.*PaleMoon|Mobile.*PaleMoon"},props:{Mobile:"Mobile/[VER]",Build:"Build/[VER]",Version:"Version/[VER]",VendorID:"VendorID/[VER]",iPad:"iPad.*CPU[a-z ]+[VER]",iPhone:"iPhone.*CPU[a-z ]+[VER]",iPod:"iPod.*CPU[a-z ]+[VER]",Kindle:"Kindle/[VER]",Chrome:["Chrome/[VER]","CriOS/[VER]","CrMo/[VER]"],Coast:["Coast/[VER]"],Dolfin:"Dolfin/[VER]",Firefox:["Firefox/[VER]","FxiOS/[VER]"],Fennec:"Fennec/[VER]",Edge:"Edge/[VER]",IE:["IEMobile/[VER];","IEMobile [VER]","MSIE [VER];","Trident/[0-9.]+;.*rv:[VER]"],NetFront:"NetFront/[VER]",NokiaBrowser:"NokiaBrowser/[VER]",Opera:[" OPR/[VER]","Opera Mini/[VER]","Version/[VER]"],"Opera Mini":"Opera Mini/[VER]","Opera Mobi":"Version/[VER]",UCBrowser:["UCWEB[VER]","UC.*Browser/[VER]"],MQQBrowser:"MQQBrowser/[VER]",MicroMessenger:"MicroMessenger/[VER]",baiduboxapp:"baiduboxapp/[VER]",baidubrowser:"baidubrowser/[VER]",SamsungBrowser:"SamsungBrowser/[VER]",Iron:"Iron/[VER]",Safari:["Version/[VER]","Safari/[VER]"],Skyfire:"Skyfire/[VER]",Tizen:"Tizen/[VER]",Webkit:"webkit[ /][VER]",PaleMoon:"PaleMoon/[VER]",Gecko:"Gecko/[VER]",Trident:"Trident/[VER]",Presto:"Presto/[VER]",Goanna:"Goanna/[VER]",iOS:" \\bi?OS\\b [VER][ ;]{1}",Android:"Android [VER]",BlackBerry:["BlackBerry[\\w]+/[VER]","BlackBerry.*Version/[VER]","Version/[VER]"],BREW:"BREW [VER]",Java:"Java/[VER]","Windows Phone OS":["Windows Phone OS [VER]","Windows Phone [VER]"],"Windows Phone":"Windows Phone [VER]","Windows CE":"Windows CE/[VER]","Windows NT":"Windows NT [VER]",Symbian:["SymbianOS/[VER]","Symbian/[VER]"],webOS:["webOS/[VER]","hpwOS/[VER];"]},utils:{Bot:"Googlebot|facebookexternalhit|Google-AMPHTML|s~amp-validator|AdsBot-Google|Google Keyword Suggestion|Facebot|YandexBot|YandexMobileBot|bingbot|ia_archiver|AhrefsBot|Ezooms|GSLFbot|WBSearchBot|Twitterbot|TweetmemeBot|Twikle|PaperLiBot|Wotbox|UnwindFetchor|Exabot|MJ12bot|YandexImages|TurnitinBot|Pingdom|contentkingapp",MobileBot:"Googlebot-Mobile|AdsBot-Google-Mobile|YahooSeeker/M1A1-R2D2",DesktopMode:"WPDesktop",TV:"SonyDTV|HbbTV",WebKit:"(webkit)[ /]([\\w.]+)",Console:"\\b(Nintendo|Nintendo WiiU|Nintendo 3DS|Nintendo Switch|PLAYSTATION|Xbox)\\b",Watch:"SM-V700"}},detectMobileBrowsers:{fullPattern:/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i,shortPattern:/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i,tabletPattern:/android|ipad|playbook|silk/i}},s=Object.prototype.hasOwnProperty;function r(t,e){return null!=t&&null!=e&&t.toLowerCase()===e.toLowerCase()}function a(t,e){var i,s,r=t.length;if(!r||!e)return!1;for(i=e.toLowerCase(),s=0;s<r;++s)if(i===t[s].toLowerCase())return!0;return!1}function n(t){for(var e in t)s.call(t,e)&&(t[e]=new RegExp(t[e],"i"))}function o(t,e){this.ua=function(t){return(t||"").substr(0,500)}(t),this._cache={},this.maxPhoneWidth=e||600}return i.FALLBACK_PHONE="UnknownPhone",i.FALLBACK_TABLET="UnknownTablet",i.FALLBACK_MOBILE="UnknownMobile",t="isArray"in Array?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},function(){var e,r,a,o,l,h,c=i.mobileDetectRules;for(e in c.props)if(s.call(c.props,e)){for(r=c.props[e],t(r)||(r=[r]),l=r.length,o=0;o<l;++o)(h=(a=r[o]).indexOf("[VER]"))>=0&&(a=a.substring(0,h)+"([\\w._\\+]+)"+a.substring(h+5)),r[o]=new RegExp(a,"i");c.props[e]=r}n(c.oss),n(c.phones),n(c.tablets),n(c.uas),n(c.utils),c.oss0={WindowsPhoneOS:c.oss.WindowsPhoneOS,WindowsMobileOS:c.oss.WindowsMobileOS}}(),i.findMatch=function(t,e){for(var i in t)if(s.call(t,i)&&t[i].test(e))return i;return null},i.findMatches=function(t,e){var i=[];for(var r in t)s.call(t,r)&&t[r].test(e)&&i.push(r);return i},i.getVersionStr=function(t,e){var r,a,n,o,l=i.mobileDetectRules.props;if(s.call(l,t))for(n=(r=l[t]).length,a=0;a<n;++a)if(null!==(o=r[a].exec(e)))return o[1];return null},i.getVersion=function(t,e){var s=i.getVersionStr(t,e);return s?i.prepareVersionNo(s):NaN},i.prepareVersionNo=function(t){var e;return 1===(e=t.split(/[a-z._ \/\-]/i)).length&&(t=e[0]),e.length>1&&(t=e[0]+".",e.shift(),t+=e.join("")),Number(t)},i.isMobileFallback=function(t){return i.detectMobileBrowsers.fullPattern.test(t)||i.detectMobileBrowsers.shortPattern.test(t.substr(0,4))},i.isTabletFallback=function(t){return i.detectMobileBrowsers.tabletPattern.test(t)},i.prepareDetectionCache=function(t,s,r){if(t.mobile===e){var a,n,l;if(n=i.findMatch(i.mobileDetectRules.tablets,s))return t.mobile=t.tablet=n,void(t.phone=null);if(a=i.findMatch(i.mobileDetectRules.phones,s))return t.mobile=t.phone=a,void(t.tablet=null);i.isMobileFallback(s)?(l=o.isPhoneSized(r))===e?(t.mobile=i.FALLBACK_MOBILE,t.tablet=t.phone=null):l?(t.mobile=t.phone=i.FALLBACK_PHONE,t.tablet=null):(t.mobile=t.tablet=i.FALLBACK_TABLET,t.phone=null):i.isTabletFallback(s)?(t.mobile=t.tablet=i.FALLBACK_TABLET,t.phone=null):t.mobile=t.tablet=t.phone=null}},i.mobileGrade=function(t){var e=null!==t.mobile();return t.os("iOS")&&t.version("iPad")>=4.3||t.os("iOS")&&t.version("iPhone")>=3.1||t.os("iOS")&&t.version("iPod")>=3.1||t.version("Android")>2.1&&t.is("Webkit")||t.version("Windows Phone OS")>=7||t.is("BlackBerry")&&t.version("BlackBerry")>=6||t.match("Playbook.*Tablet")||t.version("webOS")>=1.4&&t.match("Palm|Pre|Pixi")||t.match("hp.*TouchPad")||t.is("Firefox")&&t.version("Firefox")>=12||t.is("Chrome")&&t.is("AndroidOS")&&t.version("Android")>=4||t.is("Skyfire")&&t.version("Skyfire")>=4.1&&t.is("AndroidOS")&&t.version("Android")>=2.3||t.is("Opera")&&t.version("Opera Mobi")>11&&t.is("AndroidOS")||t.is("MeeGoOS")||t.is("Tizen")||t.is("Dolfin")&&t.version("Bada")>=2||(t.is("UC Browser")||t.is("Dolfin"))&&t.version("Android")>=2.3||t.match("Kindle Fire")||t.is("Kindle")&&t.version("Kindle")>=3||t.is("AndroidOS")&&t.is("NookTablet")||t.version("Chrome")>=11&&!e||t.version("Safari")>=5&&!e||t.version("Firefox")>=4&&!e||t.version("MSIE")>=7&&!e||t.version("Opera")>=10&&!e?"A":t.os("iOS")&&t.version("iPad")<4.3||t.os("iOS")&&t.version("iPhone")<3.1||t.os("iOS")&&t.version("iPod")<3.1||t.is("Blackberry")&&t.version("BlackBerry")>=5&&t.version("BlackBerry")<6||t.version("Opera Mini")>=5&&t.version("Opera Mini")<=6.5&&(t.version("Android")>=2.3||t.is("iOS"))||t.match("NokiaN8|NokiaC7|N97.*Series60|Symbian/3")||t.version("Opera Mobi")>=11&&t.is("SymbianOS")?"B":(t.version("BlackBerry")<5||t.match("MSIEMobile|Windows CE.*Mobile")||t.version("Windows Mobile"),"C")},i.detectOS=function(t){return i.findMatch(i.mobileDetectRules.oss0,t)||i.findMatch(i.mobileDetectRules.oss,t)},i.getDeviceSmallerSide=function(){return window.screen.width<window.screen.height?window.screen.width:window.screen.height},o.prototype={constructor:o,mobile:function(){return i.prepareDetectionCache(this._cache,this.ua,this.maxPhoneWidth),this._cache.mobile},phone:function(){return i.prepareDetectionCache(this._cache,this.ua,this.maxPhoneWidth),this._cache.phone},tablet:function(){return i.prepareDetectionCache(this._cache,this.ua,this.maxPhoneWidth),this._cache.tablet},userAgent:function(){return this._cache.userAgent===e&&(this._cache.userAgent=i.findMatch(i.mobileDetectRules.uas,this.ua)),this._cache.userAgent},userAgents:function(){return this._cache.userAgents===e&&(this._cache.userAgents=i.findMatches(i.mobileDetectRules.uas,this.ua)),this._cache.userAgents},os:function(){return this._cache.os===e&&(this._cache.os=i.detectOS(this.ua)),this._cache.os},version:function(t){return i.getVersion(t,this.ua)},versionStr:function(t){return i.getVersionStr(t,this.ua)},is:function(t){return a(this.userAgents(),t)||r(t,this.os())||r(t,this.phone())||r(t,this.tablet())||a(i.findMatches(i.mobileDetectRules.utils,this.ua),t)},match:function(t){return t instanceof RegExp||(t=new RegExp(t,"i")),t.test(this.ua)},isPhoneSized:function(t){return o.isPhoneSized(t||this.maxPhoneWidth)},mobileGrade:function(){return this._cache.grade===e&&(this._cache.grade=i.mobileGrade(this)),this._cache.grade}},"undefined"!=typeof window&&window.screen?o.isPhoneSized=function(t){return t<0?e:i.getDeviceSmallerSide()<=t}:o.isPhoneSized=function(){},o._impl=i,o.version="1.4.4 2019-09-21",o}))}(function(t){if("undefined"!=typeof module&&module.exports)return function(t){module.exports=t()};if("function"==typeof define&&define.amd)return define;if("undefined"!=typeof window)return function(t){window.MobileDetect=t()};throw new Error("unknown environment")}());let f=String.fromCharCode,keyStrBase64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",keyStrUriSafe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",baseReverseDic={};function getBaseValue(t,e){if(!baseReverseDic[t]){baseReverseDic[t]={};for(let e=0;e<t.length;e++)baseReverseDic[t][t.charAt(e)]=e}return baseReverseDic[t][e]}function getInput(t){if(null===t)return"";if(""===t)return null;if("string"==typeof t)return t;t instanceof ArrayBuffer&&(t=new Uint8Array(t));let e="";for(let i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e}var lzstring={compressToBase64:function(t){if(!(t=getInput(t)))return"";let e=this._compress(t,6,(function(t){return keyStrBase64.charAt(t)}));switch(e.length%4){default:case 0:return e;case 1:return e+"===";case 2:return e+"==";case 3:return e+"="}},decompressFromBase64:function(t){return null===t?"":""===t?null:(t=getInput(t),this._decompress(t.length,32,(function(e){return getBaseValue(keyStrBase64,t.charAt(e))})))},compressToUTF16:function(t){return null===t?"":(t=getInput(t),this._compress(t,15,(function(t){return f(t+32)}))+" ")},decompressFromUTF16:function(t){return null===t?"":""===t?null:(t=getInput(t),this._decompress(t.length,16384,(function(e){return t.charCodeAt(e)-32})))},compressToUint8Array:function(t){t=getInput(t);let e=this.compress(t),i=new Uint8Array(2*e.length);for(let t=0,s=e.length;t<s;t++){let s=e.charCodeAt(t);i[2*t]=s>>>8,i[2*t+1]=s%256}return i},decompressFromUint8Array:function(t){if(null==t)return this.decompress(t);{t=getInput(t);let e=new Array(t.length/2);for(let i=0,s=e.length;i<s;i++)e[i]=256*t[2*i]+t[2*i+1];let i=[];return e.forEach((function(t){i.push(f(t))})),this.decompress(i.join(""))}},compressToEncodedURIComponent:function(t){return null===t?"":this._compress(t,6,(function(t){return keyStrUriSafe.charAt(t)}))},decompressFromEncodedURIComponent:function(t){return null===t?"":""===t?null:(t=t.replace(/ /g,"+"),this._decompress(t.length,32,(function(e){return getBaseValue(keyStrUriSafe,t.charAt(e))})))},compress:function(t){return this._compress(t,16,(function(t){return f(t)}))},_compress:function(t,e,i){if(null===(t=getInput(t)))return"";let s,r,a,n={},o={},l="",h="",c="",d=2,u=3,p=2,m=[],f=0,g=0;for(a=0;a<t.length;a+=1)if(l=t.charAt(a),Object.prototype.hasOwnProperty.call(n,l)||(n[l]=u++,o[l]=!0),h=c+l,Object.prototype.hasOwnProperty.call(n,h))c=h;else{if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(s=0;s<p;s++)f<<=1,g===e-1?(g=0,m.push(i(f)),f=0):g++;for(r=c.charCodeAt(0),s=0;s<8;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1}else{for(r=1,s=0;s<p;s++)f=f<<1|r,g==e-1?(g=0,m.push(i(f)),f=0):g++,r=0;for(r=c.charCodeAt(0),s=0;s<16;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1}d--,0===d&&(d=Math.pow(2,p),p++),delete o[c]}else for(r=n[c],s=0;s<p;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1;d--,0===d&&(d=Math.pow(2,p),p++),n[h]=u++,c=String(l)}if(""!==c){if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(s=0;s<p;s++)f<<=1,g===e-1?(g=0,m.push(i(f)),f=0):g++;for(r=c.charCodeAt(0),s=0;s<8;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1}else{for(r=1,s=0;s<p;s++)f=f<<1|r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r=0;for(r=c.charCodeAt(0),s=0;s<16;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1}d--,0===d&&(d=Math.pow(2,p),p++),delete o[c]}else for(r=n[c],s=0;s<p;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1;d--,0===d&&(d=Math.pow(2,p),p++)}for(r=2,s=0;s<p;s++)f=f<<1|1&r,g===e-1?(g=0,m.push(i(f)),f=0):g++,r>>=1;for(;;){if(f<<=1,g===e-1){m.push(i(f));break}g++}return m.join("")},decompress:function(t){return null===t?"":""===t?null:(t=getInput(t),this._decompress(t.length,32768,(function(e){return t.charCodeAt(e)})))},_decompress:function(t,e,i){let s,r,a,n,o,l,h,c,d=[],u=4,p=4,m=3,g="",_=[],v={val:i(0),position:e,index:1};for(r=0;r<3;r+=1)d[r]=r;for(n=0,l=Math.pow(2,2),h=1;h!==l;)o=v.val&v.position,v.position>>=1,0===v.position&&(v.position=e,v.val=i(v.index++)),n|=(o>0?1:0)*h,h<<=1;switch(s=n){case 0:for(n=0,l=Math.pow(2,8),h=1;h!==l;)o=v.val&v.position,v.position>>=1,0===v.position&&(v.position=e,v.val=i(v.index++)),n|=(o>0?1:0)*h,h<<=1;c=f(n);break;case 1:for(n=0,l=Math.pow(2,16),h=1;h!==l;)o=v.val&v.position,v.position>>=1,0===v.position&&(v.position=e,v.val=i(v.index++)),n|=(o>0?1:0)*h,h<<=1;c=f(n);break;case 2:return""}for(d[3]=c,a=c,_.push(c);;){if(v.index>t)return"";for(n=0,l=Math.pow(2,m),h=1;h!==l;)o=v.val&v.position,v.position>>=1,0===v.position&&(v.position=e,v.val=i(v.index++)),n|=(o>0?1:0)*h,h<<=1;switch(c=n){case 0:for(n=0,l=Math.pow(2,8),h=1;h!==l;)o=v.val&v.position,v.position>>=1,0===v.position&&(v.position=e,v.val=i(v.index++)),n|=(o>0?1:0)*h,h<<=1;d[p++]=f(n),c=p-1,u--;break;case 1:for(n=0,l=Math.pow(2,16),h=1;h!==l;)o=v.val&v.position,v.position>>=1,0===v.position&&(v.position=e,v.val=i(v.index++)),n|=(o>0?1:0)*h,h<<=1;d[p++]=f(n),c=p-1,u--;break;case 2:return _.join("")}if(0===u&&(u=Math.pow(2,m),m++),d[c])g=d[c];else{if(c!==p)return null;g=a+a.charAt(0)}_.push(g),d[p++]=a+g.charAt(0),u--,a=g,0===u&&(u=Math.pow(2,m),m++)}}};let f64tmp=new Float64Array(1),u16tmp=new Uint16Array(f64tmp.buffer);function isDenormal(t){f64tmp[0]=t;let e=u16tmp[0],i=u16tmp[1],s=u16tmp[2],r=u16tmp[3];if(0===e&&0===i&&0===s&&(0===r||32768===r))return!1;let a=-32769&r;return a>>=4,0===a}globalThis._isDenormal=isDenormal;let colormap={black:30,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,teal:36,white:37,reset:0,grey:2,gray:2,orange:202,pink:198,brown:314,lightred:91,peach:210},termColorMap={};for(let t in colormap)termColorMap[t]=colormap[t],termColorMap[colormap[t]]=t;function termColor(t,e,i=0){if(t="symbol"==typeof t?t.toString():""+t,e in colormap&&(e=colormap[e]),e>107){return"[38;5;"+e+"m"+t+"[39m"}return"["+e+"m"+t+"[39m"}function termPrint(){let t="";for(let e=0;e<arguments.length;e++)e>0&&(t+=" "),t+=arguments[e];let e=/\u001b\[[1-9][0-9]?m/,i=/\u001b\[[1-9][0-9];[0-9][0-9]?;[0-9]+m/,s=/\u001b\[39m/,r="[39m";function a(t,e){return{type:e,value:t}}let n=[[e,"start"],[i,"start"],[s,"end"]],o=t,l=[];for(;o.length>0;){let t,e,i,s,r=!1;for(let a of n){let n=o.search(a[0]);n>=0&&(void 0===e||n<e)&&(i=o.slice(n,o.length).match(a[0])[0],e=n,s=a[1],t=a,r=!0)}if(!r)break;if(e>0){let t=o.slice(0,e);l.push(a(t,"chunk"))}o=o.slice(e+i.length,o.length);let h=a(i,s);l.push(h)}o.length>0&&l.push(a(o,"chunk"));let h,c=[],d="";for(let t of l)"chunk"===t.type?d+=t.value:"start"===t.type?(c.push(h),h=t.value,d+=t.value):"end"===t.type&&(h=c.pop(),d+=h||r);return d}globalThis.termColor=termColor;class MovingAvg extends Array{constructor(t=64){super(),this.length=t,this.cur=0,this.used=0,this.sum=0}reset(){return this.cur=this.used=this.sum=0,this}add(t){return this.used<this.length?(this[this.cur]=t,this.used++):(this.sum-=this[this.cur],this[this.cur]=t),this.sum+=t,this.cur=(this.cur+1)%this.length,this.sample()}sample(){return this.used?this.sum/this.used:0}}let timers={},mdetect,mret;function pollTimer(t,e){return t in timers||(timers[t]=time_ms()),time_ms()-timers[t]>=e&&(timers[t]=time_ms(),!0)}function isMobile(){if(window.MobileDetect){if(void 0===mret){mdetect=new MobileDetect(navigator.userAgent);let t=mdetect.mobile();"string"==typeof t&&(t=t.toLowerCase()),mret=t}return mret}}class SmartConsoleContext{constructor(t,e){this.name=t;let i=[random(),random(),random()],s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);s=255/s;let r=~~(i[0]*s),a=~~(i[1]*s),n=~~(i[2]*s);this.color=`rgb(${r},${a},${n})`,this.__console=e,this.timeInterval=375,this.timeIntervalAll=245,this._last=0,this.last=0,this.last2=0,this._data={},this._data_length=0,this.maxCache=256}hash(t){let e=0,i=524287,s=0;function r(t){t=t*i+134217727+s*i*.25&i,s++,e^=t}let a=new WeakSet,n=t=>{if("string"==typeof t)r(strhash(t));else if(null==t)r(0);else if("object"==typeof t){if(a.has(t))return;a.add(t);let e=getAllKeys(t);for(let i of e){let e;if("string"==typeof i){try{e=t[i]}catch(t){continue}n(e)}}}else"function"==typeof t&&r(strhash(""+t.name))};for(let e=0;e<t.length;e++)n(t[e]);return e}clearCache(){return this._data_length=0,this._data={},this}_getData(t){let e=this.hash(t);return e in this._data||(this._data_length>this.maxCache&&this.clearCache(),this._data[e]={time:0,count:0},this._data_length++),this._data[e]}_check(t){return!(this.timeIntervalAll>0&&time_ms()-this.last2<this.timeIntervalAll)&&(this.last2=time_ms(),!0)}log(){this._check(arguments)&&window.console.log("%c","color:"+this.color,...arguments)}warn(){this._check(arguments)&&window.console.log("%c"+this.name,"color : "+this.color,...arguments)}trace(){this._check(arguments)&&window.console.trace(...arguments)}error(){this._check(arguments)&&window.console.error(...arguments)}}class SmartConsole{constructor(){this.contexts={}}context(t){return t in this.contexts||(this.contexts[t]=new SmartConsoleContext(t,this)),this.contexts[t]}log(){return this.context("default").log(...arguments)}warn(){return this.context("default").warn(...arguments)}trace(){return this.context("default").trace(...arguments)}error(){return this.context("default").error(...arguments)}}const console$1=new SmartConsole;globalThis.tm=0;let EmptySlot={};function getClassParent(t){let e=t.prototype;return e&&(e=e.__proto__),e&&(e=e.constructor),e}function list$2(t){let e=[];for(let i of t)e.push(i);return e}function count(t,e){let i=0;if(void 0!==e)for(let s of t)s===e&&i++;else for(let e of t)i++;return i}function getAllKeys(t){let e,i=new Set;if("object"!=typeof t&&"function"!=typeof t)throw new Error("must pass an object ot getAllKeys; object was: "+t);for(;e&&e!==Object;){for(let e in Object.getOwnPropertyDescriptors(t))"__proto__"!==e&&i.add(e);for(let e of Object.getOwnPropertySymbols(t))i.add(e);e=e.__proto__}let s=t.constructor;if(!s)return i;for(;s;){let t=s.prototype;if(t){for(let e in t)i.add(e);for(let e in Object.getOwnPropertyDescriptors(t))i.add(e);s=getClassParent(s)}else s=getClassParent(s)}return i}function btoa$1(t){if(t instanceof ArrayBuffer&&(t=new Uint8Array(t)),"string"==typeof t||t instanceof String)return window.btoa(t);let e="";for(let i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return btoa$1(e)}function formatNumberUI(t,e=!1,i=5){return t=null==t?"0":isNaN(t)?"NaN":t===-1/0?"-"+String.fromCharCode(8734):t===1/0?"+"+String.fromCharCode(8734):e?""+Math.floor(t):t.toFixed(i)}function atob$1(t){let e=window.atob(t),i=[];for(let t=0;t<e.length;t++)i.push(e.charCodeAt(t));return new Uint8Array(i)}function time_ms(){return window.performance?window.performance.now():(new Date).getMilliseconds()}function color2css$2(t){let e=3===t.length?"rgb(":"rgba(";for(let i=0;i<3;i++)i>0&&(e+=","),e+=~~(255*t[i]);return 4===t.length&&(e+=","+t[3]),e+=")",e}function merge(t,e){return Object.assign({},t,e)}const debug_cacherings=!1;debug_cacherings&&(window._cacherings=[],window._clear_all_cacherings=function(t=!1){function e(t){if("function"==typeof t.copy)return t.copy();if(t.constructor===Object){let i={};for(let s of Reflect.ownKeys(t)){let r;try{r=t[s]}catch(t){continue}i[s]="object"!=typeof r?r:e(r)}return i}return new t.constructor}for(let i of window._cacherings){let s=i[0],r=i.length;if(i.length=0,i.cur=0,!t)for(let t=0;t<r;t++)i.push(e(s))}},window._nonvector_cacherings=function(){for(let t of window._cacherings){if(0===t.length)continue;let e=t[0].constructor.name,i=!e.startsWith("Vector")&&!e.startsWith("Quat");i=i&&!e.startsWith("TriEditor"),i=i&&!e.startsWith("QuadEditor"),i=i&&!e.startsWith("PointEditor"),i=i&&!e.startsWith("LineEditor"),i&&console$1.log(e,t)}},window._stale_cacherings=function(){let t=_cacherings.concat([]);return t.sort(((t,e)=>t.gen-e.gen)),t});class cachering extends Array{constructor(t,e,i=!1){super(),this.private=i,this.cur=0,!i&&debug_cacherings&&(this.gen=0,window._cacherings.push(this));for(let i=0;i<e;i++)this.push(t())}static fromConstructor(t,e,i=!1){return new cachering((function(){return new t}),e,i)}next(){debug_cacherings&&this.gen++;let t=this[this.cur];return this.cur=(this.cur+1)%this.length,t}}class SetIter{constructor(t){this.set=t,this.i=0,this.ret={done:!1,value:void 0}}[Symbol.iterator](){return this}next(){let t=this.ret;for(;this.i<this.set.items.length&&this.set.items[this.i]===EmptySlot;)this.i++;return this.i>=this.set.items.length?(t.done=!0,t.value=void 0,t):(t.value=this.set.items[this.i++],t)}}class set$2{constructor(t){if(this.items=[],this.keys={},this.freelist=[],this.length=0,"string"==typeof t&&(t=new String(t)),void 0!==t)if(Symbol.iterator in t)for(let e of t)this.add(e);else if("forEach"in t)t.forEach((function(t){this.add(t)}),this);else if(t instanceof Array)for(let e=0;e<t.length;e++)this.add(t[e])}get size(){return this.length}[Symbol.iterator](){return new SetIter(this)}equals(t){for(let e of this)if(!t.has(e))return!1;for(let e of t)if(!this.has(e))return!1;return!0}clear(){return this.items.length=0,this.keys={},this.freelist.length=0,this.length=0,this}filter(t,e){let i=0,s=new set$2;for(let r of this)t.call(e,r,i++,this)&&s.add(r);return s}map(t,e){let i=new set$2,s=0;for(let r of this)i.add(t.call(e,r,s++,this));return i}reduce(t,e){if(void 0===e)for(let t of this){e=t;break}let i=0;for(let s of this)e=t(e,s,i++,this);return e}copy(){let t=new set$2;for(let e of this)t.add(e);return t}add(t){let e=t[Symbol.keystr]();if(!(e in this.keys)){if(this.freelist.length>0){let i=this.freelist.pop();this.keys[e]=i,this.items[i]=t}else{let i=this.items.length;this.keys[e]=i,this.items.push(t)}this.length++}}delete(t,e=!0){this.remove(t,e)}remove(t,e){let i=t[Symbol.keystr]();if(!(i in this.keys))return void(e||console$1.warn("Warning, item",t,"is not in set"));let s=this.keys[i];this.freelist.push(s),this.items[s]=EmptySlot,delete this.keys[i],this.length--}has(t){return t[Symbol.keystr]()in this.keys}forEach(t,e){for(let i=0;i<this.items.length;i++){let s=this.items[i];s!==EmptySlot&&(void 0!==e?t.call(e,s):t(s))}}}class HashIter{constructor(t){this.hash=t,this.i=0,this.ret={done:!1,value:void 0}}next(){let t=this.hash._items;if(this.i>=t.length)return this.ret.done=!0,this.ret.value=void 0,this.ret;do{this.i+=2}while(this.i<t.length&&t[i]===_hash_null);return this.ret}}let _hash_null={};class hashtable{constructor(){this._items=[],this._keys={},this.length=0}[Symbol.iterator](){return new HashIter(this)}set(t,e){let i,s=t[Symbol.keystr]();if(s in this._keys)i=this._keys[s];else{i=this._items.length;try{this._items.push(0),this._items.push(0)}catch(i){throw console$1.log(":::",this._items.length,t,s,e),i}this._keys[s]=i,this.length++}this._items[i]=t,this._items[i+1]=e}remove(t){let e=t[Symbol.keystr]();if(!(e in this._keys))return void console$1.warn("Warning, key not in hashtable:",t,e);let i=this._keys[e];this._items[i]=_hash_null,this._items[i+1]=_hash_null,delete this._keys[e],this.length--}has(t){return t[Symbol.keystr]()in this._keys}get(t){let e=t[Symbol.keystr]();if(e in this._keys)return this._items[this._keys[e]+1];console$1.warn("Warning, item not in hash",t,e)}add(t,e){return this.set(t,e)}keys(){let t=[];for(let e=0;e<this._items.length;e+=2){let i=this._items[e];i!==_hash_null&&t.push(i)}return t}values(){let t=[];for(let e=0;e<this._items.length;e+=2){let i=this._items[e+1];i!==_hash_null&&t.push(i)}return t}forEach(t,e){void 0===e&&(e=self);for(let i in this._keys){let s=this._keys[i];t.call(e,i,this._items[s])}}}let IDGenInternalIDGen=0;class IDGen{constructor(){this.__cur=1,this._debug=!1,this._internalID=IDGenInternalIDGen++}get cur(){return this.__cur}set cur(t){if(isNaN(t)||!isFinite(t))throw new Error("NaN error in util.IDGen");this.__cur=t}get _cur(){return this.cur}set _cur(t){window.console.warn("Deprecated use of IDGen._cur"),this.cur=t}static fromJSON(t){let e=new IDGen;return e.cur=void 0===t.cur?t._cur:t.cur,e}next(){return this.cur++}copy(){let t=new IDGen;return t.cur=this.cur,t}max_cur(t){this.cur=Math.max(this.cur,t+1)}toJSON(){return{cur:this.cur}}loadSTRUCT(t){t(this)}}function get_callstack(t){return(""+t.stack).split("\n")}function print_stack$1(t){t?window.console.log(t.stack):window.console.trace()}function fetch_file(t){let e=location.origin+"/"+t,i=new XMLHttpRequest;return new Promise((function(t,s){i.open("GET",e),i.onreadystatechange=function(e){200===i.status&&4===i.readyState?t(i.response):i.status>=400&&s(i.status,i.statusText)},i.send()}))}function _int32(t){return~~((1<<30)-1&~~t)}IDGen.STRUCT="\nIDGen {\n  cur : int;\n}\n",nstructjs.register(IDGen),globalThis.get_callstack=get_callstack,globalThis.print_stack=print_stack$1;class MersenneRandom{constructor(t){this.index=624,this.mt=new Uint32Array(624),this.seed(t)}random(){return this.extract_number()/(1<<30)}nrandom(t=3){let e=0;for(let i=0;i<t;i++)e+=this.random();return e/t}seed(t){t=~~(8192*t),this.index=624,this.mt.fill(0,0,this.mt.length),this.mt[0]=t;for(let t=1;t<624;t++)this.mt[t]=_int32(1812433253*(this.mt[t-1]^this.mt[t-1]>>30)+t)}extract_number(){this.index>=624&&this.twist();let t=this.mt[this.index];return t^=t>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,t^=t>>18,this.index=this.index+1,_int32(t)}twist(){for(let t=0;t<624;t++){let e=_int32((2147483648&this.mt[t])+(2147483647&this.mt[(t+1)%624]));this.mt[t]=this.mt[(t+397)%624]^e>>1,e%2!=0&&(this.mt[t]=2567483615^this.mt[t])}this.index=0}}let _mt=new MersenneRandom(0);function random(){return _mt.extract_number()/(1<<30)}function seed(t){_mt.seed(t)}let smallstr_hashes={};const MAXINT=Math.pow(2,31)-1;function strhash(t){if(t.length<=64){let e=smallstr_hashes[t];if(void 0!==e)return e}let e=0;for(let i=0;i<t.length;i++){e=e<0?-e:e,e^=1103515245*t.charCodeAt(i)+12345&MAXINT}return t.length<=64&&(smallstr_hashes[t]=e),e}let hashsizes=[223,383,653,1117,1901,3251,5527,9397,15991,27191,46229,78593,133631,227177,38619,656587,1116209,1897561,3225883,5484019,9322861,15848867,26943089,45803279,77865577,132371489,225031553],FTAKEN=0,FKEY=1,FVAL=2,FTOT=3,digestcache;class FastHash extends Array{constructor(){super(),this.cursize=0,this.size=hashsizes[this.cursize],this.used=0,this.length=this.size*FTOT,this.fill(0,0,this.length)}resize(t){let e=this.slice(0,this.length);this.length=t*FTOT,this.size=t,this.fill(0,0,this.length);for(let t=0;t<e.length;t+=FTOT){if(!e[t+FTAKEN])continue;let i=e[t+FKEY],s=e[t+FVAL];this.set(i,s)}return this}get(t){let e="string"==typeof t?strhash(t):t;e="object"==typeof e?e.valueOf():e;let i=0,s=(e+i)%this.size,r=0;for(;r++<5e4&&this[s*FTOT+FTAKEN];){if(this[s*FTOT+FKEY]===t)return this[s*FTOT+FVAL];i=2*(i+1),s=(e+i)%this.size}}has(t){let e="string"==typeof t?strhash(t):t;e="object"==typeof e?e.valueOf():e;let i=0,s=(e+i)%this.size,r=0;for(;r++<5e4&&this[s*FTOT+FTAKEN];){if(this[s*FTOT+FKEY]===t)return!0;i=2*(i+1),s=(e+i)%this.size}return!1}set(t,e){let i="string"==typeof t?strhash(t):t;i="object"==typeof i?i.valueOf():i,this.used>this.size/3&&this.resize(hashsizes[this.cursize++]);let s=0,r=(i+s)%this.size,a=0;for(;a++<5e4&&this[r*FTOT+FTAKEN];){if(this[r*FTOT+FKEY]===t)return void(this[r*FTOT+FVAL]=e);s=2*(s+1),r=(i+s)%this.size}this[r*FTOT+FTAKEN]=1,this[r*FTOT+FKEY]=t,this[r*FTOT+FVAL]=e,this.used++}}function test_fasthash(){let t=new FastHash;return console$1.log("bleh hash:",strhash("bleh")),t.set("bleh",1),t.set("bleh",2),t.set("bleh",3),console$1.log(t),t}class ImageReader{load_image(){let t,e=document.createElement("input");e.type="file";let i=new Promise(((e,i)=>{t=e}));return e.addEventListener("change",(function(e){let i=this.files;if(console$1.log("got file",e,i),0===i.length)return;let s=new FileReader;s.onload=e=>{let i=e.target.result,s=new Image;s.src=i,s.onload=e=>{console$1.log("got image",s.width,s.height);let i=document.createElement("canvas"),r=i.getContext("2d");i.width=s.width,i.height=s.height,r.drawImage(s,0,0);let a=r.getImageData(0,0,s.width,s.height);t(a)}},s.readAsDataURL(i[0])})),e.click(),i}example(){this.load_image().then((t=>{console$1.log(t)}))}}class HashDigest{constructor(){this.i=0,this.hash=0}static cachedDigest(){return digestcache.next().reset()}reset(){return this.i=0,this.hash=0,this}get(){return this.hash}add(t){if("string"==typeof t&&(t=strhash(t)),"object"==typeof t&&Array.isArray(t)){for(let e=0;e<t.length;e++)this.add(t[e]);return this}t>=-5&&t<=5&&(t*=32);let e=524288*Math.fract(t);return e=~~e/524288,t=Math.floor(t)+e,this.i=1103515245*(this.i+~~t)+12345&536870911,t=~~(t|=1024*t*1024&536870911),this.hash^=t^this.i,this}}function hashjoin(t,e){let i=524287;h=h*i+134217727+0&i}window._test_hash2=()=>{let t=new HashDigest,e=[[0,0,0,0],[0,0,0],[0,0],[0],[1],[2],[3],[strhash("yay")],[strhash("yay"),strhash("yay")],[strhash("yay"),strhash("yay"),strhash("yay")]];for(let t of e){let e=new HashDigest;for(let i of t)e.add(i);window.console.log(e.get())}for(let e=0;e<50;e++)t.add(0)},digestcache=cachering.fromConstructor(HashDigest,512);let NullItem={};class MapIter{constructor(t){this.ret={done:!0,value:void 0},this.value=new Array(2),this.i=0,this.map=t,this.done=!0}finish(){this.done||(this.done=!0,this.map.itercur--)}next(){let t=this.ret,e=this.i,i=this.map._list;for(;e<i.length&&i[e]===NullItem;)e+=2;return e>=i.length?(t.done=!0,t.value=void 0,this.finish(),t):(this.i=e+2,t.value=this.value,t.value[0]=i[e],t.value[1]=i[e+1],t.done=!1,t)}return(){return this.finish(),this.ret}reset(){return this.i=0,this.value[0]=void 0,this.value[1]=void 0,this.done=!1,this}}class map$1{constructor(){this._items={},this._list=[],this.size=0,this.iterstack=new Array(8),this.itercur=0;for(let t=0;t<this.iterstack.length;t++)this.iterstack[t]=new MapIter(this);this.freelist=[]}has(t){return t[Symbol.keystr]()in this._items}set(t,e){let i=t[Symbol.keystr](),s=this._items[i];void 0===s&&(this.freelist.length>0?s=this.freelist.pop():(s=this._list.length,this._list.length+=2),this.size++),this._list[s]=t,this._list[s+1]=e,this._items[i]=s}keys(){let t=this;return function*(){for(let[e,i]of t)yield e}()}values(){let t=this;return function*(){for(let[e,i]of t)yield i}()}get(t){t=t[Symbol.keystr]();let e=this._items[t];if(void 0!==e)return this._list[e+1]}delete(t){if(!((t=t[Symbol.keystr]())in this._items))return!1;let e=this._items[t];return this.freelist.push(e),this._list[e]=NullItem,this._list[e+1]=NullItem,delete this._items[t],this.size--,!0}[Symbol.iterator](){let t=this.iterstack[this.itercur].reset();return this.itercur++,this.itercur===this.iterstack.length&&this.iterstack.push(new MapIter(this)),t}}function validateId(t){let e="number"!=typeof t;if(e=e||t!==~~t,e=e||isNaN(t),e)throw new Error("bad number "+t);return e}globalThis._test_map=function(){let t=new map$1;t.set("1",2),t.set(11,3),t.set("5",4),t.set("3",5),t.set("3",6),t.delete("3");for(let[e,i]of t){for(let[s,r]of t)window.console.log(e,i,s,r);break}return console$1.log("itercur",t.itercur),t};let UndefinedTag={};class IDMap extends Array{constructor(){super(),this._keys=new Set,this.size=0}has(t){return validateId(t),!(t<0||t>=this.length)&&void 0!==this[t]}set(t,e){if(validateId(t),t<0)return void console$1.warn("got -1 id in IDMap");t>=this.length&&(this.length=t+1),void 0===e&&(e=UndefinedTag);let i=!1;return void 0===this[t]&&(this.size++,this._keys.add(t),i=!0),this[t]=e,i}get(t){if(validateId(t),-1===t)return;if(t<0)return void console$1.warn("id was negative");let e=t<this.length?this[t]:void 0;return e=e===UndefinedTag?void 0:e,e}delete(t){return!!this.has(t)&&(this._keys.remove(t),this[t]=void 0,this.size--,!0)}keys(){let t=this;return function*(){for(let e of t._keys)yield e}()}values(){let t=this;return function*(){for(let e of t._keys)yield t[e]}()}[Symbol.iterator](){let t=this,e=[0,0];return function*(){for(let i of t._keys)e[0]=i,e[1]=t[i],e[1]===UndefinedTag&&(e[1]=void 0),yield e}()}}globalThis._test_idmap=function(){let t=new IDMap;for(let e=0;e<5;e++){let i=~~(55*Math.random());t.set(i,"yay"+e)}for(let[e,i]of t)window.console.log(e,i,t.has(e),t.get(e));return t};let HW=0,HELEM=1,HTOT=2;function heaplog(){}class MinHeapQueue{constructor(t,e=t){if(this.heap=[],this.freelist=[],this.length=0,this.end=0,t){let i=e[Symbol.iterator]();for(let e of t){let t=i.next().value;this.push(e,t)}}}push(t,e){if("number"!=typeof e)throw new Error("w must be a number");if(isNaN(e))throw new Error("NaN");this.length++;let i=Math.ceil(Math.log(this.length)/Math.log(2)),s=Math.pow(2,i)+1;if(heaplog(i,s),this.heap.length<s*HTOT){for(let t=this.heap.length/HTOT;t<s;t++)this.freelist.push(t*HTOT)}let r=this.heap;r.length=s*HTOT;let a=this.freelist.pop();for(heaplog("freelist",this.freelist),this.end=Math.max(this.end,a),r[a]=e,r[a+1]=t;a>0;){a/=HTOT;let i=a-1>>1;if(a*=HTOT,i*=HTOT,!(void 0===r[i]||r[i]>e))break;a===this.end&&(this.end=i),r[a]=r[i],r[a+1]=r[i+1],r[i]=e,r[i+1]=t,a=i}}pop(){if(0===this.length)return;let t=this.heap;if(0===this.end){let e=t[1];return this.freelist.push(0),t[0]=void 0,this.length=0,e}let e=t[1],i=this.end;function s(e,i){let s=t[e];t[e]=t[i],t[i]=s,s=t[e+1],t[e+1]=t[i+1],t[i+1]=s}heaplog("end",i),heaplog(t.concat([])),t[0]=t[i],t[1]=t[i+1],t[i]=void 0,t[i+1]=void 0;let r=0;for(;r<t.length;){r/=HTOT;let e=2*r+1,i=2*r+2;if(e=~~(e*HTOT),i=~~(i*HTOT),r=~~(r*HTOT),heaplog("  ",t[r],t[e],t[i]),void 0!==t[e]&&void 0!==t[i]){if(t[e]>t[i]){let t=e;e=i,i=t}if(t[r]>t[e])s(r,e),r=e;else{if(!(t[r]>t[i]))break;s(r,i),r=i}}else if(void 0!==t[e]){if(!(t[r]>t[e]))break;s(r,e),r=e}else{if(void 0===t[i])break;if(!(t[r]>t[i]))break;s(r,i),r=i}}for(this.freelist.push(this.end),t[this.end]=void 0,t[this.end+1]=void 0;this.end>0&&void 0===t[this.end];)this.end-=HTOT;return this.length--,e}}globalThis.testHeapQueue=function(t=[1,8,-3,11,33]){let e=new MinHeapQueue(t);window.console.log(e.heap.concat([]));let i=[],s=e.length;for(let t=0;t<s;t++)i.push(e.pop());return window.console.log(e.heap.concat([])),i};class Queue{constructor(t=32){t=Math.max(t,8),this.initialSize=t,this.queue=new Array(t),this.a=0,this.b=0,this.length=0}enqueue(t){let e=this.queue.length,i=this.b;if(this.queue[i]=t,this.b=(this.b+1)%e,this.length>=e||this.a===this.b){let t=new Array(e<<1);for(let i=0;i<e;i++){let s=(i+this.a)%e;t[i]=this.queue[s]}this.a=0,this.b=e,this.queue=t}this.length++}clear(t=!0){if(this.queue.length=this.initialSize,t)for(let t=0;t<this.queue.length;t++)this.queue[t]=void 0;return this.a=this.b=0,this.length=0,this}dequeue(){if(0===this.length)return;this.length--;let t=this.queue[this.a];return this.queue[this.a]=void 0,this.a=(this.a+1)%this.queue.length,t}}globalThis._testQueue=function(t=15,e=15){let i=new Queue(3);for(let s=0;s<t;s++){let t=[];for(let s=0;s<e;s++){let e={f:Math.random()};t.push(e),i.enqueue(e)}let s=0;for(;i.length>0;){let e=i.dequeue();if(e!==t[s])throw console$1.log(e,t),new Error("got wrong item",e);if(s++,s>1e4){console$1.error("Infinite loop error");break}}}};class ArrayPool{constructor(){this.pools=new Map,this.map=new Array(1024)}get(t,e=!1){let i;if(i=t<1024?this.map[t]:this.pools.get(t),!i){let s;return s=t>512?32:t>256?64:t>128?256:t>64?512:1024,i=new cachering((()=>new Array(t)),s),t<1024&&(this.map[t]=i),this.pools.set(t,i),this.get(t,e)}let s=i.next();if(s.length!==t&&(console$1.warn("Array length was set",t,s),s.length=t),e)for(let e=0;e<t;e++)s[e]=void 0;return s}}class DivLogger{constructor(t,e=16){this.elemId=t,this.elem=void 0,this.lines=new Array,this.maxLines=e}push(t){this.lines.length>this.maxLines?(this.lines.shift(),this.lines.push(t)):this.lines.push(t),this.update()}update(){let t=this.lines.join("<br>");t=t.replace(/[ \t]/g,"&nbsp;"),this.elem||(this.elem=document.getElementById(this.elemId)),this.elem.innerHTML=t}toString(t,e=0){let i="",s="";for(let t=0;t<e;t++)s+="$TAB";if("symbol"==typeof t)return`[${t.description}]`;if("object"==typeof t&&Array.isArray(t)){i="[$NL";for(let r=0;r<t.length;r++){let a=t[r];a=e>=1?typeof a:this.toString(a,e+1),i+=s+"$TAB",i+=a+(r!==t.length-1?",":"")+"$NL"}let r=Reflect.ownKeys(t);for(let e=0;e<r.length;e++){let a,n,o=r[e],l=this.toString(o);if(!("symbol"!=typeof o&&!isNaN(a=parseInt(o))&&a>=0&&a<t.length)){try{n=t[o]}catch(t){n="(error)"}i+=s+`$TAB${l} : ${n}`,e<r.length-1&&(i+=","),i.endsWith("$NL")||i.endsWith("\n")||(i+="$NL")}}i+="$TAB]$NL",i.length<100?(i=i.replace(/\$NL/g,""),i=i.replace(/(\$TAB)+/g," ")):(i=i.replace(/\$NL/g,"\n"),i=i.replace(/\$TAB/g,"  "))}else if("object"==typeof t){i="{$NL";let r=Reflect.ownKeys(t);for(let a=0;a<r.length;a++){let n,o=r[a],l=this.toString(o);try{n=t[o]}catch(t){n="(error)"}n=e>=1?typeof n:this.toString(n,e+1),i+=s+`$TAB${l} : ${n}`,a<r.length-1&&(i+=","),i.endsWith("$NL")||i.endsWith("\n")||(i+="$NL")}i+=s+"}$NL",i.length<100?(i=i.replace(/\$NL/g,""),i=i.replace(/(\$TAB)+/g," ")):(i=i.replace(/\$NL/g,"\n"),i=i.replace(/\$TAB/g,"  "))}else i=void 0===t?"undefined":"function"==typeof t?"function "+t.name:""+t;return i}}const PendingTimeoutPromises=new Set;class TimeoutPromise{constructor(t,e=3e3,i=!1){if(!t)return;this.silent=i,this.timeout=e;let s=this._accept2.bind(this),r=this._reject2.bind(this);this.time=time_ms(),this.rejected=!1,this._promise=new Promise(((e,i)=>{this._accept=e,this._reject=i,t(s,r)})),PendingTimeoutPromises.add(this)}_accept2(t){if(!this.bad)return this._accept(t);this.silent||this._reject(new Error("Timeout"))}static wrapPromise(t,e=3e3,i){let s=new TimeoutPromise;return s._promise=t,s._accept=i,s._reject=function(t){throw t},s.then((t=>{s._accept2(t)})).catch((t=>{s._reject2(t)})),s}_reject2(t){this._reject(t)}then(t){return this._promise.then((e=>{let i=t(e);return i instanceof Promise&&(i=TimeoutPromise.wrapPromise(i,this.timeout,t)),i})),this}catch(t){return this._promise.catch(t),this}finally(t){return this._promise.catch(t),this}get bad(){return time_ms()-this.time>this.timeout}}function compress(t){return lzstring.compressToUint8Array(t)}function decompress(t){return t instanceof DataView&&(t=t.buffer),t instanceof ArrayBuffer&&(t=new Uint8Array(t)),lzstring.decompressFromUint8Array(t)}function undefinedForGC(){}window.setInterval((()=>{let t=[];for(let e of PendingTimeoutPromises)e.bad&&t.push(e);for(let e of t)PendingTimeoutPromises.delete(e);for(let e of t)try{e._reject(new Error("Timeout"))}catch(t){print_stack$1(t)}}),250);var util=Object.freeze({__proto__:null,isDenormal:isDenormal,termColorMap:termColorMap,termColor:termColor,termPrint:termPrint,MovingAvg:MovingAvg,timers:timers,pollTimer:pollTimer,isMobile:isMobile,SmartConsoleContext:SmartConsoleContext,SmartConsole:SmartConsole,console:console$1,getClassParent:getClassParent,list:list$2,count:count,getAllKeys:getAllKeys,btoa:btoa$1,formatNumberUI:formatNumberUI,atob:atob$1,time_ms:time_ms,color2css:color2css$2,merge:merge,cachering:cachering,SetIter:SetIter,set:set$2,HashIter:HashIter,hashtable:hashtable,IDGen:IDGen,print_stack:print_stack$1,fetch_file:fetch_file,MersenneRandom:MersenneRandom,random:random,seed:seed,strhash:strhash,FastHash:FastHash,test_fasthash:test_fasthash,ImageReader:ImageReader,HashDigest:HashDigest,hashjoin:hashjoin,MapIter:MapIter,map:map$1,IDMap:IDMap,MinHeapQueue:MinHeapQueue,Queue:Queue,ArrayPool:ArrayPool,DivLogger:DivLogger,PendingTimeoutPromises:PendingTimeoutPromises,TimeoutPromise:TimeoutPromise,compress:compress,decompress:decompress,undefinedForGC:undefinedForGC});const EulerOrders={XYZ:0,XZY:1,YXZ:2,YZX:3,ZXY:4,ZYX:5};window.makeCompiledVectormathCode=function(t="es"){let e="",i="es"===t;function s(t){return i?"export":`let ${t} = exports.${t} =`}let r=[Vector2$b,Vector3$2,Vector4$2,a],n={Vector2:2,Vector3:3,Vector4:4,Quat:4},o="",l='\n  let g = typeof window !== "undefined" ? window : "undefined";\n  \n  g = g || (typeof global !== "undefined" ? global : "undefined");\n  g = g || (typeof self !== "undefined" ? self : "undefined");\n  g = g || (typeof globals !== "undefined" ? globals : "undefined");\n\n  if (typeof nstructjs === "undefined") {\n    //add nstructjs stub\n    g.nstructjs = {\n      register : function() {}\n    }\n  }\n  ';function h(t,e="  "){let i=t.split("\n"),s="";for(let t of i)s+=e+t+"\n";return s}"rjs"!==t&&("commonjs"===t&&(o='if (typeof module !== "undefined" && typeof exports === "undefined") {\n      if (module.exports === undefined) {\n        module.exports = {};\n      }\n      \n      g.exports = module.exports;\n    } else if (typeof module === "undefined") {\n      g.exports = g.vectormath = {};\n    }\n'),e+=`{\n      ${l}\n    ${o}\n  }`),e+="\nclass cachering extends Array {\n  constructor(func, size) {\n    super()\n\n    this.cur = 0;\n\n    for (let i=0; i<size; i++) {\n      this.push(func());\n    }\n  }\n\n  static fromConstructor(cls, size) {\n    let func = function() {\n      return new cls();\n    }\n\n    return new cachering(func, size);\n  }\n\n  next() {\n    let ret = this[this.cur];\n    this.cur = (this.cur+1)%this.length;\n\n    return ret;\n  }\n}\n",e+=`\n\nlet M_SQRT2 = Math.sqrt(2.0);\nlet FLT_EPSILON = 2.22e-16;  \nlet sin=Math.sin, cos=Math.cos, abs=Math.abs, log=Math.log,\n    asin=Math.asin, exp=Math.exp, acos=Math.acos, fract=Math.fract,\n    sign=Math.sign, tent=Math.tent, atan2=Math.atan2, atan=Math.atan,\n    pow=Math.pow, sqrt=Math.sqrt, floor=Math.floor, ceil=Math.ceil,\n    min=Math.min, max=Math.max, PI=Math.PI, E=2.718281828459045;\n\nlet DOT_NORM_SNAP_LIMIT = 0.00000000001;\n\n${s("BaseVector")} class BaseVector extends Array {\n  constructor() {\n    super();\n    \n    this.vec = undefined; //for compatibility with old files\n  }\n\n  copy() {\n    return new this.constructor(this);\n  }\n\n  load(data) {\n    throw new Error("Implement me!");\n  }\n  \n  vectorLength() {\n    return sqrt(this.dot(this));\n  }\n  \n  normalize() {\n    let l = this.vectorLength();\n    if (l > 0.00000001) {\n      this.mulScalar(1.0/l);\n    }\n    \n    return this;\n  }\n}\n  \n`;for(let t of r){e+=s(t.name)+" class "+t.name+" extends BaseVector {\n";let i=Reflect.ownKeys(t.prototype);for(let s of i){let i=t.prototype[s];if("function"!=typeof i)continue;"symbol"==typeof s&&(s="  ["+s.toString()+"]"),i=(""+i).trim(),i.startsWith("function(")||i.startsWith("function (")?i=s+i.slice(8,i.length).trim():i.startsWith("function")&&(i=i.slice(8,i.length).trim()),i.endsWith(";}")&&(i=i.slice(0,i.length-1)+"\n  }\n");let r="",a=n[t.name];for(let t=0;t<a;t++)t>0&&(r+=" = "),r+=`this[${t}]`;r+=" = 0.0",e+="constructor"===s?`  constructor(data) {\n    super(${a});\n        \n    this.vec = undefined; //for compatibility with old files\n    \n    if (arguments.length > 1) {\n      throw new Error("unexpected argument");\n    }\n\n    //this.length = ${a};\n    ${r};\n\n    if (data !== undefined) {\n      this.load(data);\n    }\n  }\n`:h(i),e+="\n"}e+="}\n\n",e+=`${t.name}.STRUCT = \`${t.STRUCT}\`;\n`,e+=`nstructjs.register(${t.name});\n\n`}return e+="\n\n"+(""+internal_matrix).trim()+"\n",e+="\n"+s("Matrix4")+Matrix4$2,e+=`\n  Matrix4.STRUCT = \`${Matrix4$2.STRUCT}\`;\n`,e+="nstructjs.register(Matrix4)\n",e+="\n  let _quat_vs3_temps = cachering.fromConstructor(Vector3, 64);\n  let _v3nd4_n1_normalizedDot4 = new Vector3();\n  let _v3nd4_n2_normalizedDot4 = new Vector3();\n  let _v3nd_n1_normalizedDot = new Vector3();\n  let _v3nd_n2_normalizedDot = new Vector3();\n\n  let $_v3nd4_n1_normalizedDot4 = new Vector3();\n  let $_v3nd4_n2_normalizedDot4 = new Vector3();\n  let $_v3nd_n1_normalizedDot = new Vector3();\n  let $_v3nd_n2_normalizedDot = new Vector3();\n\n  let lookat_cache_vs3 = cachering.fromConstructor(Vector3, 64);\n  let lookat_cache_vs4 = cachering.fromConstructor(Vector4, 64);\n\n  let makenormalcache = cachering.fromConstructor(Vector3, 64);\n","rjs"===t&&(e=`define([], function() {\n  "use strict";\n\n  let exports = {};\n\n  {\n    ${l}\n  }\n  ${h(e)}\n\n  return exports;\n});\n`),e};let sin$1=Math.sin,cos$1=Math.cos,abs=Math.abs,log=Math.log,asin=Math.asin,exp=Math.exp,acos=Math.acos,fract=Math.fract,sign=Math.sign,tent=Math.tent,atan2=Math.atan2,atan=Math.atan,pow=Math.pow,sqrt=Math.sqrt,floor=Math.floor,ceil=Math.ceil,min=Math.min,max=Math.max,PI=Math.PI,E=2.718281828459045,DOT_NORM_SNAP_LIMIT=1e-11,M_SQRT2=Math.sqrt(2),FLT_EPSILON=222e-18,basic_funcs={equals:[["b"],"this[X] === b[X]","&&"],zero:[[],"0.0;"],negate:[[],"-this[X];"],combine:[["b","u","v"],"this[X]*u + this[X]*v;"],interp:[["b","t"],"this[X] + (b[X] - this[X])*t;"],add:[["b"],"this[X] + b[X];"],addFac:[["b","F"],"this[X] + b[X]*F;"],fract:[[],"Math.fract(this[X]);"],sub:[["b"],"this[X] - b[X];"],mul:[["b"],"this[X] * b[X];"],div:[["b"],"this[X] / b[X];"],mulScalar:[["b"],"this[X] * b;"],divScalar:[["b"],"this[X] / b;"],addScalar:[["b"],"this[X] + b;"],subScalar:[["b"],"this[X] - b;"],minScalar:[["b"],"Math.min(this[X], b);"],maxScalar:[["b"],"Math.max(this[X], b);"],ceil:[[],"Math.ceil(this[X])"],floor:[[],"Math.floor(this[X])"],abs:[[],"Math.abs(this[X])"],min:[["b"],"Math.min(this[X], b[X])"],max:[["b"],"Math.max(this[X], b[X])"],clamp:[["MIN","MAX"],"min(max(this[X], MAX), MIN)"]};function bounded_acos(t){return t<=-1?Math.pi:t>=1?0:Math.acos(t)}function make_norm_safe_dot(t){let e=t.prototype.dot;t.prototype._dot=e,t.prototype.dot=function(t){let i=e.call(this,t);return i>=1-DOT_NORM_SNAP_LIMIT&&i<=1+DOT_NORM_SNAP_LIMIT?1:i>=-1-DOT_NORM_SNAP_LIMIT&&i<=-1+DOT_NORM_SNAP_LIMIT?-1:i}}function getBaseVector(parent){return class BaseVector extends parent{constructor(){super(...arguments),this.vec=void 0}static inherit(cls,vectorsize){var f;make_norm_safe_dot(cls);let vectorDotDistance="f = function vectorDotDistance(b) {\n";for(let t=0;t<vectorsize;t++)vectorDotDistance+="  let d"+t+" = this["+t+"]-b["+t+"];\n\n  ";vectorDotDistance+="  return ";for(let t=0;t<vectorsize;t++)t>0&&(vectorDotDistance+=" + "),vectorDotDistance+="d"+t+"*d"+t;vectorDotDistance+=";\n",vectorDotDistance+="};",cls.prototype.vectorDotDistance=eval(vectorDotDistance),f=void 0;let vectorDistance="f = function vectorDistance(b) {\n";for(let t=0;t<vectorsize;t++)vectorDistance+=`  let d${t} = this[${t}] - (b[${t}]||0);\n\n  `;vectorDistance+="  return Math.sqrt(";for(let t=0;t<vectorsize;t++)t>0&&(vectorDistance+=" + "),vectorDistance+="d"+t+"*d"+t;vectorDistance+=");\n",vectorDistance+="};",cls.prototype.vectorDistance=eval(vectorDistance);let vectorDistanceSqr="f = function vectorDistanceSqr(b) {\n";for(let t=0;t<vectorsize;t++)vectorDistanceSqr+=`  let d${t} = this[${t}] - (b[${t}]||0);\n\n  `;vectorDistanceSqr+="  return (";for(let t=0;t<vectorsize;t++)t>0&&(vectorDistanceSqr+=" + "),vectorDistanceSqr+="d"+t+"*d"+t;vectorDistanceSqr+=");\n",vectorDistanceSqr+="};",cls.prototype.vectorDistanceSqr=eval(vectorDistanceSqr);for(let k in basic_funcs){let func=basic_funcs[k],args=func[0],line=func[1];var f;let code="f = function "+k+"(";for(let t=0;t<args.length;t++)t>0&&(code+=", "),line=line.replace(args[t],args[t].toLowerCase()),code+=args[t].toLowerCase();if(code+=") {\n",func.length>2){code+="  return ";for(let t=0;t<vectorsize;t++)t>0&&(code+=func[2]),code+="("+line.replace(/X/g,""+t)+")";code+=";\n"}else{for(let t=0;t<vectorsize;t++){let e=line.replace(/X/g,""+t);code+="  this["+t+"] = "+e+";\n"}code+="  return this;\n"}code+="}\n",f=eval(code),cls.prototype[k]=f}}copy(){return new this.constructor(this)}load(t){throw new Error("Implement me!")}init_swizzle(t){let e={},i=4===t?Vector4$2:3===t?Vector3$2:Vector2$b;for(let t in i.prototype){let s=i.prototype[t];("function"==typeof s||s instanceof Function)&&(e[t]=s.bind(this))}return e}vectorLength(){return sqrt(this.dot(this))}swapAxes(t,e){let i=this[t];return this[t]=this[e],this[e]=i,this}sinterp(t,e){let i=this.vectorLength(),s=t.vectorLength();return this.interp(t,e).normalize().mulScalar(i+(s-i)*e)}perpSwap(t=0,e=1,i=1){let s=this[t];return this[t]=this[e]*i,this[e]=-s*i,this}normalize(){let t=this.vectorLength();return t>1e-8&&this.mulScalar(1/t),this}}}const BaseVector=getBaseVector(Array),F64BaseVector=getBaseVector(Float64Array),F32BaseVector=getBaseVector(Float32Array),I32BaseVector=getBaseVector(Int32Array),I16BaseVector=getBaseVector(Int16Array),I8BaseVector=getBaseVector(Int8Array),UI32BaseVector=getBaseVector(Uint32Array),UI16BaseVector=getBaseVector(Uint16Array),UI8BaseVector=getBaseVector(Uint8Array);function myclamp(t,e,i){return Math.min(Math.max(t,e),i)}function makeVector4(t,e="vec4",i="float"){let s,r,a,n;const o=class extends t{static STRUCT=nstructjs.inlineRegister(this,`\n    ${e} {\n      0 : ${i};\n      1 : ${i};\n      2 : ${i};\n      3 : ${i};\n    }`);constructor(t){if(super(4),arguments.length>1)throw new Error("unexpected argument");this[0]=this[1]=this[2]=this[3]=0,void 0!==t&&this.load(t)}toCSS(){return`rgba(${~~(255*this[0])},${~~(255*this[1])},${~~(255*this[2])},${this[3]})`}loadXYZW(t,e,i,s){return this[0]=t,this[1]=e,this[2]=i,this[3]=s,this}loadXYZ(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}static normalizedDot4(t,e,i,a){return s.load(e).sub(t).normalize(),r.load(a).sub(i).normalize(),s.dot(r)}static normalizedDot3(t,e,i){return s.load(t).sub(e).normalize(),r.load(i).sub(e).normalize(),s.dot(r)}load(t){return void 0===t||(this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]),this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3]}mulVecQuat(t){let e=-t[1]*this[0]-t[2]*this[1]-t[3]*this[2],i=t[0]*this[0]+t[2]*this[2]-t[3]*this[1],s=t[0]*this[1]+t[3]*this[0]-t[1]*this[2];return this[2]=t[0]*this[2]+t[1]*this[1]-t[2]*this[0],this[0]=i,this[1]=s,i=e*-t[1]+this[0]*t[0]-this[1]*t[3]+this[2]*t[2],s=e*-t[2]+this[1]*t[0]-this[2]*t[1]+this[0]*t[3],this[2]=e*-t[3]+this[2]*t[0]-this[0]*t[2]+this[1]*t[1],this[0]=i,this[1]=s,this}multVecMatrix(t){let e=this[0],i=this[1],s=this[2],r=this[3];return this[0]=r*t.$matrix.m41+e*t.$matrix.m11+i*t.$matrix.m21+s*t.$matrix.m31,this[1]=r*t.$matrix.m42+e*t.$matrix.m12+i*t.$matrix.m22+s*t.$matrix.m32,this[2]=r*t.$matrix.m43+e*t.$matrix.m13+i*t.$matrix.m23+s*t.$matrix.m33,this[3]=r*t.$matrix.m44+e*t.$matrix.m14+i*t.$matrix.m24+s*t.$matrix.m34,this[3]}cross(t){let e=this[1]*t[2]-this[2]*t[1],i=this[2]*t[0]-this[0]*t[2],s=this[0]*t[1]-this[1]*t[0];return this[0]=e,this[1]=i,this[2]=s,this}preNormalizedAngle(t){let e=.99999*this.dot(t);return Math.acos(e)}loadSTRUCT(t){t(this),void 0!==this.vec&&(this.load(this.vec),this.vec=void 0)}};return s=new o,r=new o,a=new o,n=new o,o}const Vector4$2=makeVector4(BaseVector);let _v3nd_n1_normalizedDot,_v3nd_n2_normalizedDot,_v3nd4_n1_normalizedDot4,_v3nd4_n2_normalizedDot4;function makeVector3(BaseVector,structName="vec3",structType="float",customConstructorCode){var Vector3,bundlehelper=[nstructjs];const constructorCode=customConstructorCode??'\n    constructor(data) {\n      super(3);\n\n      if (arguments.length > 1) {\n        throw new Error("unexpected argument");\n      }\n\n      this[0] = this[1] = this[2] = 0.0;\n\n      if (data !== undefined) {\n        this.load(data);\n      }\n\n      if (this.constructor === Vector3) {\n        Object.preventExtensions(this);\n      }\n    }\n  ',code=`\n  let temp1, temp2, temp3, temp4;\n  Vector3 = class Vector3 extends BaseVector {\n    static STRUCT = bundlehelper[0].inlineRegister(this, \`\n    ${structName} {\n      0 : ${structType};\n      1 : ${structType};\n      2 : ${structType};\n    }\`);\n\n    ${constructorCode}\n\n    static normalizedDot4(v1, v2, v3, v4) {\n      temp1.load(v2).sub(v1).normalize()\n      temp2.load(v4).sub(v3).normalize();\n\n      return temp1.dot(temp2);\n\n    }\n\n    static normalizedDot3(v1, center, v2) {\n      temp1.load(v1).sub(center).normalize();\n      temp2.load(v2).sub(center).normalize();\n\n      return temp1.dot(temp2);\n    }\n\n    toCSS() {\n      let r = ~~(this[0]*255);\n      let g = ~~(this[1]*255);\n      let b = ~~(this[2]*255);\n      return \`rgb(\${r},\${g},\${b})\`\n    }\n\n    loadXYZ(x, y, z) {\n      this[0] = x;\n      this[1] = y;\n      this[2] = z;\n\n      return this;\n    }\n\n    loadXY(x, y) {\n      this[0] = x;\n      this[1] = y;\n\n      return this;\n    }\n\n    toJSON() {\n      return [this[0], this[1], this[2]];\n    }\n\n    loadJSON(obj) {\n      return this.load(obj);\n    }\n\n    initVector3() {\n      this.length = 3;\n      this[0] = this[1] = this[2] = 0;\n      return this;\n    }\n\n    load(data) {\n      if (data === undefined)\n        return this;\n\n      //if (isNaN(data[0]) || isNaN(data[1]) || isNaN(data[2])) {\n      //  throw new Error("NaN");\n      //}\n\n      this[0] = data[0];\n      this[1] = data[1];\n      this[2] = data[2];\n\n      return this;\n    }\n\n    dot(b) {\n      return this[0]*b[0] + this[1]*b[1] + this[2]*b[2];\n    }\n\n    normalizedDot(v) {\n      $_v3nd_n1_normalizedDot.load(this);\n      $_v3nd_n2_normalizedDot.load(v);\n      $_v3nd_n1_normalizedDot.normalize();\n      $_v3nd_n2_normalizedDot.normalize();\n      return $_v3nd_n1_normalizedDot.dot($_v3nd_n2_normalizedDot);\n    }\n\n    mulVecQuat(q) {\n      let t0 = -q[1]*this[0] - q[2]*this[1] - q[3]*this[2];\n      let t1 = q[0]*this[0] + q[2]*this[2] - q[3]*this[1];\n      let t2 = q[0]*this[1] + q[3]*this[0] - q[1]*this[2];\n\n      this[2] = q[0]*this[2] + q[1]*this[1] - q[2]*this[0];\n      this[0] = t1;\n      this[1] = t2;\n\n      t1 = t0* -q[1] + this[0]*q[0] - this[1]*q[3] + this[2]*q[2];\n      t2 = t0* -q[2] + this[1]*q[0] - this[2]*q[1] + this[0]*q[3];\n\n      this[2] = t0* -q[3] + this[2]*q[0] - this[0]*q[2] + this[1]*q[1];\n      this[0] = t1;\n      this[1] = t2;\n\n      return this;\n    }\n\n    multVecMatrix(matrix, ignore_w) {\n      if (ignore_w === undefined) {\n        ignore_w = false;\n      }\n      let x = this[0];\n      let y = this[1];\n      let z = this[2];\n      this[0] = matrix.$matrix.m41 + x*matrix.$matrix.m11 + y*matrix.$matrix.m21 + z*matrix.$matrix.m31;\n      this[1] = matrix.$matrix.m42 + x*matrix.$matrix.m12 + y*matrix.$matrix.m22 + z*matrix.$matrix.m32;\n      this[2] = matrix.$matrix.m43 + x*matrix.$matrix.m13 + y*matrix.$matrix.m23 + z*matrix.$matrix.m33;\n      let w = matrix.$matrix.m44 + x*matrix.$matrix.m14 + y*matrix.$matrix.m24 + z*matrix.$matrix.m34;\n\n      if (!ignore_w && w !== 1 && w !== 0 && matrix.isPersp) {\n        this[0] /= w;\n        this[1] /= w;\n        this[2] /= w;\n      }\n      return w;\n    }\n\n    cross(v) {\n      let x = this[1]*v[2] - this[2]*v[1];\n      let y = this[2]*v[0] - this[0]*v[2];\n      let z = this[0]*v[1] - this[1]*v[0];\n\n      this[0] = x;\n      this[1] = y;\n      this[2] = z;\n\n      return this;\n    }\n\n    //axis is optional, 0\n    rot2d(A, axis = 0) {\n      let x = this[0];\n      let y = this[1];\n\n      if (axis === 1) {\n        this[0] = x*Math.cos(A) + y*Math.sin(A);\n        this[1] = y*Math.cos(A) - x*Math.sin(A);\n      } else {\n        this[0] = x*Math.cos(A) - y*Math.sin(A);\n        this[1] = y*Math.cos(A) + x*Math.sin(A);\n      }\n\n      return this;\n    }\n\n    preNormalizedAngle(v2) {\n      let th = this.dot(v2)*0.99999;\n      return Math.acos(th);\n    }\n\n    loadSTRUCT(reader) {\n      reader(this);\n\n      if (typeof this.vec !== "undefined") {\n        this.load(this.vec);\n        this.vec = undefined;\n      }\n    }\n  }\n\n  temp1 = new Vector3();\n  temp2 = new Vector3();\n  temp3 = new Vector3();\n  temp4 = new Vector3();\n  `;return eval(code),Vector3}const Vector3$2=makeVector3(F64BaseVector);function makeVector2(t,e="vec2",i="float"){let s,r,a,n;const o=class extends t{static STRUCT=nstructjs.inlineRegister(this,`\n    ${e} {\n      0 : ${i};\n      1 : ${i};\n    }`);constructor(t){if(super(2),arguments.length>1)throw new Error("unexpected argument");this[0]=this[1]=0,void 0!==t&&this.load(t)}initVector2(t){return this.length=2,void 0!==t?(this[0]=t[0],this[1]=t[1]):this[0]=this[1]=0,this}static normalizedDot4(t,e,i,a){return s.load(e).sub(t).normalize(),r.load(a).sub(i).normalize(),s.dot(r)}static normalizedDot3(t,e,i){return s.load(t).sub(e).normalize(),r.load(i).sub(e).normalize(),s.dot(r)}toJSON(){return[this[0],this[1]]}loadJSON(t){return this.load(t)}loadXY(t,e){return this[0]=t,this[1]=e,this}load(t){return void 0===t||(this[0]=t[0],this[1]=t[1]),this}rot2d(t,e){let i=this[0],s=this[1];return 1===e?(this[0]=i*Math.cos(t)+s*Math.sin(t),this[1]=s*Math.cos(t)-i*Math.sin(t)):(this[0]=i*Math.cos(t)-s*Math.sin(t),this[1]=s*Math.cos(t)+i*Math.sin(t)),this}dot(t){return this[0]*t[0]+this[1]*t[1]}multVecMatrix(t){let e=this[0],i=this[1];if(this[0]=1*t.$matrix.m41+e*t.$matrix.m11+i*t.$matrix.m21,this[1]=1*t.$matrix.m42+e*t.$matrix.m12+i*t.$matrix.m22,t.isPersp){let s=1*t.$matrix.m44+e*t.$matrix.m14+i*t.$matrix.m24;0!==s&&(this[0]/=s,this[1]/=s)}return this}mulVecQuat(t){let e=-t[1]*this[0]-t[2]*this[1],i=t[0]*this[0]-t[3]*this[1],s=t[0]*this[1]+t[3]*this[0],r=t[1]*this[1]-t[2]*this[0];return this[0]=i,this[1]=s,i=e*-t[1]+this[0]*t[0]-this[1]*t[3]+r*t[2],s=e*-t[2]+this[1]*t[0]-r*t[1]+this[0]*t[3],this[0]=i,this[1]=s,this}vectorLengthSqr(){return this.dot(this)}loadSTRUCT(t){t(this),void 0!==typeof this.vec&&(this.load(this.vec),this.vec=void 0)}};return s=new o,r=new o,a=new o,n=new o,o}const Vector2$b=makeVector2(BaseVector);let _quat_vs3_temps=cachering.fromConstructor(Vector3$2,64),lookat_cache_vs3,lookat_cache_vs4,lookat_cache_ms,euler_rotate_mats,makenormalcache,temp_mats,preMultTemp;class Quat extends Vector4$2{makeUnitQuat(){this[0]=1,this[1]=this[2]=this[3]=0}isZero(){return 0===this[0]&&0===this[1]&&0===this[2]&&0===this[3]}mulQuat(t){let e=this[0]*t[0]-this[1]*t[1]-this[2]*t[2]-this[3]*t[3],i=this[0]*t[1]+this[1]*t[0]+this[2]*t[3]-this[3]*t[2],s=this[0]*t[2]+this[2]*t[0]+this[3]*t[1]-this[1]*t[3];this[3]=this[0]*t[3]+this[3]*t[0]+this[1]*t[2]-this[2]*t[1],this[0]=e,this[1]=i,this[2]=s}conjugate(){this[1]=-this[1],this[2]=-this[2],this[3]=-this[3]}dotWithQuat(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3]}invert(){let t=this.dot(this);0!==t&&(conjugate_qt(q),this.mulscalar(1/t))}sub(t){let e=new Quat;e[0]=-t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this.mul(e)}mulScalarWithFactor(t){let e=t*bounded_acos(this[0]),i=Math.cos(e),s=Math.sin(e);this[0]=i;let r=Vector3$2([this[1],this[2],this[3]]);return r.normalize(),r.mulScalar(s),this[1]=r[0],this[2]=r[1],this[3]=r[2],this}toMatrix(t){void 0===t&&(t=new Matrix4$2);let e=M_SQRT2*this[0],i=M_SQRT2*this[1],s=M_SQRT2*this[2],r=M_SQRT2*this[3],a=e*i,n=e*s,o=e*r,l=i*i,h=i*s,c=i*r,d=s*s,u=s*r,p=r*r;return t.$matrix.m11=1-d-p,t.$matrix.m12=o+h,t.$matrix.m13=-n+c,t.$matrix.m14=0,t.$matrix.m21=-o+h,t.$matrix.m22=1-l-p,t.$matrix.m23=a+u,t.$matrix.m24=0,t.$matrix.m31=n+c,t.$matrix.m32=-a+u,t.$matrix.m33=1-l-d,t.$matrix.m34=0,t.$matrix.m41=t.$matrix.m42=t.$matrix.m43=0,t.$matrix.m44=1,t}matrixToQuat(t){let e=temp_mats.next();e.load(t),e.$matrix.m41=e.$matrix.m42=e.$matrix.m43=0,e.$matrix.m44=1;let i=new Vector3$2([e.$matrix.m11,e.$matrix.m12,e.$matrix.m13]),s=new Vector3$2([e.$matrix.m21,e.$matrix.m22,e.$matrix.m23]),r=new Vector3$2([e.$matrix.m31,e.$matrix.m32,e.$matrix.m33]);i.normalize(),s.normalize(),r.normalize(),e.$matrix.m11=i[0],e.$matrix.m12=i[1],e.$matrix.m13=i[2],e.$matrix.m21=s[0],e.$matrix.m22=s[1],e.$matrix.m23=s[2],e.$matrix.m31=r[0],e.$matrix.m32=r[1],e.$matrix.m33=r[2];let a=.25*(1+e.$matrix.m11+e.$matrix.m22+e.$matrix.m33),n=0;a>FLT_EPSILON?(n=Math.sqrt(a),this[0]=n,n=1/(4*n),this[1]=(e.$matrix.m23-e.$matrix.m32)*n,this[2]=(e.$matrix.m31-e.$matrix.m13)*n,this[3]=(e.$matrix.m12-e.$matrix.m21)*n):e.$matrix.m11>e.$matrix.m22&&e.$matrix.m11>e.$matrix.m33?(n=2*Math.sqrt(1+e.$matrix.m11-e.$matrix.m22-e.$matrix.m33),this[1]=.25*n,n=1/n,this[0]=(e.$matrix.m32-e.$matrix.m23)*n,this[2]=(e.$matrix.m21+e.$matrix.m12)*n,this[3]=(e.$matrix.m31+e.$matrix.m13)*n):e.$matrix.m22>e.$matrix.m33?(n=2*Math.sqrt(1+e.$matrix.m22-e.$matrix.m11-e.$matrix.m33),this[2]=.25*n,n=1/n,this[0]=(e.$matrix.m31-e.$matrix.m13)*n,this[1]=(e.$matrix.m21+e.$matrix.m12)*n,this[3]=(e.$matrix.m32+e.$matrix.m23)*n):(n=2*Math.sqrt(1+e.$matrix.m33-e.$matrix.m11-e.$matrix.m22),this[3]=.25*n,n=1/n,this[0]=(e.$matrix.m21-e.$matrix.m12)*n,this[1]=(e.$matrix.m31+e.$matrix.m13)*n,this[2]=(e.$matrix.m32+e.$matrix.m23)*n),this.normalize()}normalize(){let t=Math.sqrt(this.dot(this));return 0!==t?this.mulScalar(1/t):(this[1]=1,this[0]=this[2]=this[3]=0),this}axisAngleToQuat(t,e){let i=_quat_vs3_temps.next().load(t);if(i.normalize(),0!==i.dot(i)){let t=e/2,s=Math.sin(t);this[0]=Math.cos(t),this[1]=i[0]*s,this[2]=i[1]*s,this[3]=i[2]*s}else this.makeUnitQuat();return this}rotationBetweenVecs(t,e,i=1){if(t=new Vector3$2(t),e=new Vector3$2(e),t.normalize(),e.normalize(),Math.abs(t.dot(e))>.9999)return this.makeUnitQuat(),this;let s=new Vector3$2(t);s.cross(e);let r=t.preNormalizedAngle(e)*i;return this.axisAngleToQuat(s,r),this}quatInterp(t,e){let i,s,r,a,n=new Quat,o=this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3];return o<0?(o=-o,n[0]=-this[0],n[1]=-this[1],n[2]=-this[2],n[3]=-this[3]):(n[0]=this[0],n[1]=this[1],n[2]=this[2],n[3]=this[3]),1-o>1e-4?(i=Math.acos(o),s=Math.sin(i),r=Math.sin((1-e)*i)/s,a=Math.sin(e*i)/s):(r=1-e,a=e),this[0]=r*n[0]+a*t[0],this[1]=r*n[1]+a*t[1],this[2]=r*n[2]+a*t[2],this[3]=r*n[3]+a*t[3],this}}Quat.STRUCT=nstructjs.inherit(Quat,Vector4$2,"quat")+"\n}\n",nstructjs.register(Quat),_v3nd4_n1_normalizedDot4=new Vector3$2,_v3nd4_n2_normalizedDot4=new Vector3$2,_v3nd_n1_normalizedDot=new Vector3$2,_v3nd_n2_normalizedDot=new Vector3$2,BaseVector.inherit(Vector4$2,4),F64BaseVector.inherit(Vector3$2,3),BaseVector.inherit(Vector2$b,2),lookat_cache_vs3=cachering.fromConstructor(Vector3$2,64),lookat_cache_vs4=cachering.fromConstructor(Vector4$2,64),makenormalcache=cachering.fromConstructor(Vector3$2,64);let $_v3nd_n1_normalizedDot=new Vector3$2,$_v3nd_n2_normalizedDot=new Vector3$2,$_v3nd4_n1_normalizedDot4=new Vector3$2,$_v3nd4_n2_normalizedDot4=new Vector3$2,$_v3nd4_n1_normalizedDot3=new Vector3$2,$_v3nd4_n2_normalizedDot3=new Vector3$2;class internal_matrix{constructor(){this.m11=1,this.m12=0,this.m13=0,this.m14=0,this.m21=0,this.m22=1,this.m23=0,this.m24=0,this.m31=0,this.m32=0,this.m33=1,this.m34=0,this.m41=0,this.m42=0,this.m43=0,this.m44=1}}class Matrix4$2{constructor(t){this.$matrix=new internal_matrix,this.isPersp=!1,"object"==typeof t&&("length"in t&&t.length>=16||t instanceof Matrix4$2)&&this.load(t)}static fromJSON(){let t=new Matrix4$2;return t.load(json.items),t.isPersp=json.isPersp,t}copy(){return this.clone()}clone(){return new Matrix4$2(this)}addToHashDigest(t){let e=this.$matrix;return t.add(e.m11),t.add(e.m12),t.add(e.m13),t.add(e.m14),t.add(e.m21),t.add(e.m22),t.add(e.m23),t.add(e.m24),t.add(e.m31),t.add(e.m32),t.add(e.m33),t.add(e.m34),t.add(e.m41),t.add(e.m42),t.add(e.m43),t.add(e.m44),this}equals(t){let e=this.$matrix,i=t.$matrix,s=1;return s=s&&e.m11===i.m11,s=s&&e.m12===i.m12,s=s&&e.m13===i.m13,s=s&&e.m14===i.m14,s=s&&e.m21===i.m21,s=s&&e.m22===i.m22,s=s&&e.m23===i.m23,s=s&&e.m24===i.m24,s=s&&e.m31===i.m31,s=s&&e.m32===i.m32,s=s&&e.m33===i.m33,s=s&&e.m34===i.m34,s=s&&e.m41===i.m41,s=s&&e.m42===i.m42,s=s&&e.m43===i.m43,s=s&&e.m44===i.m44,s}loadColumn(t,e){let i=this.$matrix,s=e.length>3;switch(t){case 0:i.m11=e[0],i.m21=e[1],i.m31=e[2],s&&(i.m41=e[3]);break;case 1:i.m12=e[0],i.m22=e[1],i.m32=e[2],s&&(i.m42=e[3]);break;case 2:i.m13=e[0],i.m23=e[1],i.m33=e[2],s&&(i.m43=e[3]);break;case 3:i.m14=e[0],i.m24=e[1],i.m34=e[2],s&&(i.m44=e[3])}return this}copyColumnTo(t,e){let i=this.$matrix,s=e.length>3;switch(t){case 0:e[0]=i.m11,e[1]=i.m21,e[2]=i.m31,s&&(e[3]=i.m41);break;case 1:e[0]=i.m12,e[1]=i.m22,e[2]=i.m32,s&&(e[3]=i.m42);break;case 2:e[0]=i.m13,e[1]=i.m23,e[2]=i.m33,s&&(e[3]=i.m43);break;case 3:e[0]=i.m14,e[1]=i.m24,e[2]=i.m34,s&&(e[3]=i.m44)}return e}copyColumn(t){return this.copyColumnTo(t,new Vector3$2)}load(){if(1===arguments.length&&"object"==typeof arguments[0]){let t;if(arguments[0]instanceof Matrix4$2)return t=arguments[0].$matrix,this.isPersp=arguments[0].isPersp,this.$matrix.m11=t.m11,this.$matrix.m12=t.m12,this.$matrix.m13=t.m13,this.$matrix.m14=t.m14,this.$matrix.m21=t.m21,this.$matrix.m22=t.m22,this.$matrix.m23=t.m23,this.$matrix.m24=t.m24,this.$matrix.m31=t.m31,this.$matrix.m32=t.m32,this.$matrix.m33=t.m33,this.$matrix.m34=t.m34,this.$matrix.m41=t.m41,this.$matrix.m42=t.m42,this.$matrix.m43=t.m43,this.$matrix.m44=t.m44,this;if(t=arguments[0],"length"in t&&t.length>=16)return this.$matrix.m11=t[0],this.$matrix.m12=t[1],this.$matrix.m13=t[2],this.$matrix.m14=t[3],this.$matrix.m21=t[4],this.$matrix.m22=t[5],this.$matrix.m23=t[6],this.$matrix.m24=t[7],this.$matrix.m31=t[8],this.$matrix.m32=t[9],this.$matrix.m33=t[10],this.$matrix.m34=t[11],this.$matrix.m41=t[12],this.$matrix.m42=t[13],this.$matrix.m43=t[14],this.$matrix.m44=t[15],this}return this.makeIdentity(),this}toJSON(){return{isPersp:this.isPersp,items:this.getAsArray()}}getAsArray(){return[this.$matrix.m11,this.$matrix.m12,this.$matrix.m13,this.$matrix.m14,this.$matrix.m21,this.$matrix.m22,this.$matrix.m23,this.$matrix.m24,this.$matrix.m31,this.$matrix.m32,this.$matrix.m33,this.$matrix.m34,this.$matrix.m41,this.$matrix.m42,this.$matrix.m43,this.$matrix.m44]}getAsFloat32Array(){return new Float32Array(this.getAsArray())}setUniform(t,e,i){return void 0===Matrix4$2.setUniformArray&&(Matrix4$2.setUniformWebGLArray=new Float32Array(16),Matrix4$2.setUniformArray=new Array(16)),Matrix4$2.setUniformArray[0]=this.$matrix.m11,Matrix4$2.setUniformArray[1]=this.$matrix.m12,Matrix4$2.setUniformArray[2]=this.$matrix.m13,Matrix4$2.setUniformArray[3]=this.$matrix.m14,Matrix4$2.setUniformArray[4]=this.$matrix.m21,Matrix4$2.setUniformArray[5]=this.$matrix.m22,Matrix4$2.setUniformArray[6]=this.$matrix.m23,Matrix4$2.setUniformArray[7]=this.$matrix.m24,Matrix4$2.setUniformArray[8]=this.$matrix.m31,Matrix4$2.setUniformArray[9]=this.$matrix.m32,Matrix4$2.setUniformArray[10]=this.$matrix.m33,Matrix4$2.setUniformArray[11]=this.$matrix.m34,Matrix4$2.setUniformArray[12]=this.$matrix.m41,Matrix4$2.setUniformArray[13]=this.$matrix.m42,Matrix4$2.setUniformArray[14]=this.$matrix.m43,Matrix4$2.setUniformArray[15]=this.$matrix.m44,Matrix4$2.setUniformWebGLArray.set(Matrix4$2.setUniformArray),t.uniformMatrix4fv(e,i,Matrix4$2.setUniformWebGLArray),this}makeIdentity(){return this.$matrix.m11=1,this.$matrix.m12=0,this.$matrix.m13=0,this.$matrix.m14=0,this.$matrix.m21=0,this.$matrix.m22=1,this.$matrix.m23=0,this.$matrix.m24=0,this.$matrix.m31=0,this.$matrix.m32=0,this.$matrix.m33=1,this.$matrix.m34=0,this.$matrix.m41=0,this.$matrix.m42=0,this.$matrix.m43=0,this.$matrix.m44=1,this.isPersp=!1,this}transpose(){let t=this.$matrix.m12;return this.$matrix.m12=this.$matrix.m21,this.$matrix.m21=t,t=this.$matrix.m13,this.$matrix.m13=this.$matrix.m31,this.$matrix.m31=t,t=this.$matrix.m14,this.$matrix.m14=this.$matrix.m41,this.$matrix.m41=t,t=this.$matrix.m23,this.$matrix.m23=this.$matrix.m32,this.$matrix.m32=t,t=this.$matrix.m24,this.$matrix.m24=this.$matrix.m42,this.$matrix.m42=t,t=this.$matrix.m34,this.$matrix.m34=this.$matrix.m43,this.$matrix.m43=t,this}determinant(){return this._determinant4x4()}invert(){let t=this._determinant4x4();return Math.abs(t)<1e-8?null:(this._makeAdjoint(),this.$matrix.m11/=t,this.$matrix.m12/=t,this.$matrix.m13/=t,this.$matrix.m14/=t,this.$matrix.m21/=t,this.$matrix.m22/=t,this.$matrix.m23/=t,this.$matrix.m24/=t,this.$matrix.m31/=t,this.$matrix.m32/=t,this.$matrix.m33/=t,this.$matrix.m34/=t,this.$matrix.m41/=t,this.$matrix.m42/=t,this.$matrix.m43/=t,this.$matrix.m44/=t,this)}translate(t,e,i){if("object"==typeof t&&"length"in t){let s=t;t=s[0],e=s[1],i=s[2]}t=void 0===t?0:t,e=void 0===e?0:e,i=void 0===i?0:i;let s=temp_mats.next().makeIdentity();return s.$matrix.m41=t,s.$matrix.m42=e,s.$matrix.m43=i,this.multiply(s),this}preTranslate(t,e,i){if("object"==typeof t&&"length"in t){let s=t;t=s[0],e=s[1],i=s[2]}t=void 0===t?0:t,e=void 0===e?0:e,i=void 0===i?0:i;let s=temp_mats.next().makeIdentity();return s.$matrix.m41=t,s.$matrix.m42=e,s.$matrix.m43=i,this.preMultiply(s),this}scale(t,e,i,s=1){if("object"==typeof t&&"length"in t){let s=t;t=s[0],e=s[1],i=s[2]}else void 0===t&&(t=1),void 0===i?void 0===e?(e=t,i=t):i=t:void 0===e&&(e=t);let r=temp_mats.next().makeIdentity();return r.$matrix.m11=t,r.$matrix.m22=e,r.$matrix.m33=i,r.$matrix.m44=s,this.multiply(r),this}preScale(t,e,i,s=1){let r=temp_mats.next().makeIdentity();return r.scale(t,e,i,s),this.preMultiply(r),this}euler_rotate_order(t,e,i,s=EulerOrders.XYZ){void 0===e&&(e=0),void 0===i&&(i=0),t=-t,e=-e,i=-i;let r=euler_rotate_mats.next().makeIdentity(),a=r.$matrix,n=Math.cos(t),o=Math.sin(t);a.m22=n,a.m23=o,a.m32=-o,a.m33=n;let l=euler_rotate_mats.next().makeIdentity();n=Math.cos(e),o=Math.sin(e),a=l.$matrix,a.m11=n,a.m13=-o,a.m31=o,a.m33=n;let h,c,d=euler_rotate_mats.next().makeIdentity();switch(n=Math.cos(i),o=Math.sin(i),a=d.$matrix,a.m11=n,a.m12=o,a.m21=-o,a.m22=n,s){case EulerOrders.XYZ:h=r,c=l,n=d;break;case EulerOrders.XZY:h=r,c=d,n=l;break;case EulerOrders.YXZ:h=l,c=r,n=d;break;case EulerOrders.YZX:h=l,c=d,n=r;break;case EulerOrders.ZXY:h=d,c=r,n=l;break;case EulerOrders.ZYX:h=d,c=l,n=r}return c.preMultiply(n),c.multiply(h),this.preMultiply(c),this}euler_rotate(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0),window.Matrix4=Matrix4$2;let s=euler_rotate_mats.next().makeIdentity(),r=s.$matrix,a=Math.cos(t),n=Math.sin(t);r.m22=a,r.m23=n,r.m32=-n,r.m33=a;let o=euler_rotate_mats.next().makeIdentity();a=Math.cos(e),n=Math.sin(e),r=o.$matrix,r.m11=a,r.m13=-n,r.m31=n,r.m33=a,o.multiply(s);let l=euler_rotate_mats.next().makeIdentity();return a=Math.cos(i),n=Math.sin(i),r=l.$matrix,r.m11=a,r.m12=n,r.m21=-n,r.m22=a,l.multiply(o),this.preMultiply(l),this}toString(){let t="",e=this.$matrix;function i(t){let e=t.toFixed(3);return"-"!==e[0]&&(e=" "+e),e}return t=i(e.m11)+", "+i(e.m12)+", "+i(e.m13)+", "+i(e.m14)+"\n",t+=i(e.m21)+", "+i(e.m22)+", "+i(e.m23)+", "+i(e.m24)+"\n",t+=i(e.m31)+", "+i(e.m32)+", "+i(e.m33)+", "+i(e.m34)+"\n",t+=i(e.m41)+", "+i(e.m42)+", "+i(e.m43)+", "+i(e.m44)+"\n",t}rotate(t,e,i,s){if("object"==typeof e&&"length"in e){let t=e;e=t[0],i=t[1],s=t[2]}else if(1===arguments.length)e=i=0,s=1;else if(3===arguments.length)return this.rotate(t,1,0,0),this.rotate(e,0,1,0),void this.rotate(i,0,0,1);t/=2;let r=Math.sin(t),a=Math.cos(t),n=r*r,o=Math.sqrt(e*e+i*i+s*s);0===o?(e=0,i=0,s=1):1!==o&&(e/=o,i/=o,s/=o);let l=temp_mats.next().makeIdentity();if(1===e&&0===i&&0===s)l.$matrix.m11=1,l.$matrix.m12=0,l.$matrix.m13=0,l.$matrix.m21=0,l.$matrix.m22=1-2*n,l.$matrix.m23=2*r*a,l.$matrix.m31=0,l.$matrix.m32=-2*r*a,l.$matrix.m33=1-2*n,l.$matrix.m14=l.$matrix.m24=l.$matrix.m34=0,l.$matrix.m41=l.$matrix.m42=l.$matrix.m43=0,l.$matrix.m44=1;else if(0===e&&1===i&&0===s)l.$matrix.m11=1-2*n,l.$matrix.m12=0,l.$matrix.m13=-2*r*a,l.$matrix.m21=0,l.$matrix.m22=1,l.$matrix.m23=0,l.$matrix.m31=2*r*a,l.$matrix.m32=0,l.$matrix.m33=1-2*n,l.$matrix.m14=l.$matrix.m24=l.$matrix.m34=0,l.$matrix.m41=l.$matrix.m42=l.$matrix.m43=0,l.$matrix.m44=1;else if(0===e&&0===i&&1===s)l.$matrix.m11=1-2*n,l.$matrix.m12=2*r*a,l.$matrix.m13=0,l.$matrix.m21=-2*r*a,l.$matrix.m22=1-2*n,l.$matrix.m23=0,l.$matrix.m31=0,l.$matrix.m32=0,l.$matrix.m33=1,l.$matrix.m14=l.$matrix.m24=l.$matrix.m34=0,l.$matrix.m41=l.$matrix.m42=l.$matrix.m43=0,l.$matrix.m44=1;else{let t=e*e,o=i*i,h=s*s;l.$matrix.m11=1-2*(o+h)*n,l.$matrix.m12=2*(e*i*n+s*r*a),l.$matrix.m13=2*(e*s*n-i*r*a),l.$matrix.m21=2*(i*e*n-s*r*a),l.$matrix.m22=1-2*(h+t)*n,l.$matrix.m23=2*(i*s*n+e*r*a),l.$matrix.m31=2*(s*e*n+i*r*a),l.$matrix.m32=2*(s*i*n-e*r*a),l.$matrix.m33=1-2*(t+o)*n,l.$matrix.m14=l.$matrix.m24=l.$matrix.m34=0,l.$matrix.m41=l.$matrix.m42=l.$matrix.m43=0,l.$matrix.m44=1}return this.multiply(l),this}normalize(){let t=this.$matrix,e=new Vector4$2([t.m11,t.m12,t.m13,t.m14]),i=new Vector4$2([t.m21,t.m22,t.m23,t.m24]),s=new Vector4$2([t.m31,t.m32,t.m33,t.m34]),r=new Vector4$2([t.m41,t.m42,t.m43,t.m44]);e.normalize(),i.normalize(),s.normalize();let a=(new Array).concat(e).concat(i).concat(s).concat(r);return this.load(a),this}clearTranslation(t=!1){let e=this.$matrix;return e.m41=e.m42=e.m43=0,t&&(e.m44=1),this}setTranslation(t,e,i,s=!0){"object"==typeof t&&(e=t[1],i=t[2],t=t[0]);let r=this.$matrix;return r.m41=t,r.m42=e,r.m43=i,s&&(r.m44=1),this}makeNormalMatrix(t,e){if(void 0===t)throw new Error("normal cannot be undefined");let i=makenormalcache.next().load(t).normalize();if(void 0===e&&(e=makenormalcache.next().zero(),Math.abs(i[2])>.95?e[1]=1:e[2]=1),(e=makenormalcache.next().load(e)).normalize(),e.dot(t)>.99)return this.makeIdentity(),this;if(e.dot(t)<-.99)return this.makeIdentity(),this.scale(1,1,-1),this;let s=makenormalcache.next(),r=makenormalcache.next();s.load(i).cross(e).normalize(),r.load(s).cross(i).normalize(),this.makeIdentity();let a=this.$matrix;return a.m11=s[0],a.m12=s[1],a.m13=s[2],a.m21=r[0],a.m22=r[1],a.m23=r[2],a.m31=i[0],a.m32=i[1],a.m33=i[2],a.m44=1,this}preMultiply(t){return preMultTemp.load(t),preMultTemp.multiply(this),this.load(preMultTemp),this}multiply(t){let e=this.$matrix,i=t.$matrix,s=i.m11*e.m11+i.m12*e.m21+i.m13*e.m31+i.m14*e.m41,r=i.m11*e.m12+i.m12*e.m22+i.m13*e.m32+i.m14*e.m42,a=i.m11*e.m13+i.m12*e.m23+i.m13*e.m33+i.m14*e.m43,n=i.m11*e.m14+i.m12*e.m24+i.m13*e.m34+i.m14*e.m44,o=i.m21*e.m11+i.m22*e.m21+i.m23*e.m31+i.m24*e.m41,l=i.m21*e.m12+i.m22*e.m22+i.m23*e.m32+i.m24*e.m42,h=i.m21*e.m13+i.m22*e.m23+i.m23*e.m33+i.m24*e.m43,c=i.m21*e.m14+i.m22*e.m24+i.m23*e.m34+i.m24*e.m44,d=i.m31*e.m11+i.m32*e.m21+i.m33*e.m31+i.m34*e.m41,u=i.m31*e.m12+i.m32*e.m22+i.m33*e.m32+i.m34*e.m42,p=i.m31*e.m13+i.m32*e.m23+i.m33*e.m33+i.m34*e.m43,m=i.m31*e.m14+i.m32*e.m24+i.m33*e.m34+i.m34*e.m44,f=i.m41*e.m11+i.m42*e.m21+i.m43*e.m31+i.m44*e.m41,g=i.m41*e.m12+i.m42*e.m22+i.m43*e.m32+i.m44*e.m42,_=i.m41*e.m13+i.m42*e.m23+i.m43*e.m33+i.m44*e.m43,v=i.m41*e.m14+i.m42*e.m24+i.m43*e.m34+i.m44*e.m44;return e.m11=s,e.m12=r,e.m13=a,e.m14=n,e.m21=o,e.m22=l,e.m23=h,e.m24=c,e.m31=d,e.m32=u,e.m33=p,e.m34=m,e.m41=f,e.m42=g,e.m43=_,e.m44=v,this}divide(t){return this.$matrix.m11/=t,this.$matrix.m12/=t,this.$matrix.m13/=t,this.$matrix.m14/=t,this.$matrix.m21/=t,this.$matrix.m22/=t,this.$matrix.m23/=t,this.$matrix.m24/=t,this.$matrix.m31/=t,this.$matrix.m32/=t,this.$matrix.m33/=t,this.$matrix.m34/=t,this.$matrix.m41/=t,this.$matrix.m42/=t,this.$matrix.m43/=t,this.$matrix.m44/=t,this}ortho(t,e,i,s,r,a){console.warn("Matrix4.ortho() is deprecated, use .orthographic() instead");let n=(t+e)/(t-e),o=(s+i)/(s-i),l=(a+r)/(a-r),h=temp_mats.next().makeIdentity();return h.$matrix.m11=2/(t-e),h.$matrix.m12=0,h.$matrix.m13=0,h.$matrix.m14=0,h.$matrix.m21=0,h.$matrix.m22=2/(s-i),h.$matrix.m23=0,h.$matrix.m24=0,h.$matrix.m31=0,h.$matrix.m32=0,h.$matrix.m33=-2/(a-r),h.$matrix.m34=0,h.$matrix.m41=n,h.$matrix.m42=o,h.$matrix.m43=l,h.$matrix.m44=1,this.multiply(h),this}frustum(t,e,i,s,r,a){let n=temp_mats.next().makeIdentity(),o=(e+t)/(e-t),l=(s+i)/(s-i),h=-(a+r)/(a-r),c=-2*a*r/(a-r);return n.$matrix.m11=2*r/(e-t),n.$matrix.m12=0,n.$matrix.m13=0,n.$matrix.m14=0,n.$matrix.m21=0,n.$matrix.m22=2*r/(s-i),n.$matrix.m23=0,n.$matrix.m24=0,n.$matrix.m31=o,n.$matrix.m32=l,n.$matrix.m33=h,n.$matrix.m34=-1,n.$matrix.m41=0,n.$matrix.m42=0,n.$matrix.m43=c,n.$matrix.m44=0,this.isPersp=!0,this.multiply(n),this}orthographic(t,e,i,s){let r=temp_mats.next().makeIdentity(),a=s-i;return r.scale(2/e,2,-1/t/a,1/t),r.translate(0,0,.5*a-i),this.isPersp=!0,this.multiply(r),r}perspective(t,e,i,s){let r=Math.tan(t*Math.PI/360)*i,a=-r,n=e*a,o=e*r;return this.frustum(n,o,a,r,i,s),this}lookat(t,e,i){let s=lookat_cache_ms.next();s.makeIdentity();let r=lookat_cache_vs3.next().load(t).sub(e);r.vectorLength();r.normalize();let a=r,n=lookat_cache_vs3.next().load(i).normalize(),o=lookat_cache_vs3.next().load(n).cross(a).normalize(),l=s.$matrix;return l.m11=o[0],l.m12=n[0],l.m13=a[0],l.m14=0,l.m21=o[1],l.m22=n[1],l.m23=a[1],l.m24=0,l.m31=o[2],l.m32=n[2],l.m33=a[2],l.m11=o[0],l.m12=o[1],l.m13=o[2],l.m14=0,l.m21=n[0],l.m22=n[1],l.m23=n[2],l.m24=0,l.m31=a[0],l.m32=a[1],l.m33=a[2],l.m34=0,l.m41=t[0],l.m42=t[1],l.m43=t[2],l.m44=1,this.multiply(s),this}makeRotationOnly(){let t=this.$matrix;t.m41=t.m42=t.m43=0,t.m44=1;let e=Math.sqrt(t.m11*t.m11+t.m12*t.m12+t.m13*t.m13),i=Math.sqrt(t.m21*t.m21+t.m22*t.m22+t.m23*t.m23),s=Math.sqrt(t.m31*t.m31+t.m32*t.m32+t.m33*t.m33);return e&&(t.m11/=e,t.m12/=e,t.m13/=e),i&&(t.m21/=i,t.m22/=i,t.m23/=i),s&&(t.m31/=s,t.m32/=s,t.m33/=s),this}alignAxis(t,e){(e=new Vector3$2(e)).normalize();let i=this.inputs.transformMatrix.getValue(),s=i.$matrix,r=new Matrix4$2(i),a=new Vector3$2,n=new Vector3$2,o=new Vector3$2;r.decompose(a,o,n),r.makeRotationOnly();let l=r.getAsVecs(),h=(t+1)%3,c=(t+2)%3;return l[t].load(e),l[h].cross(l[t]).cross(l[t]),l[c].load(l[t]).cross(l[h]),l[0][3]=1,l[1][3]=1,l[2][3]=1,l[0].normalize(),l[1].normalize(),l[2].normalize(),this.loadFromVecs(l),this.scale(n[0],n[1],n[2]),s.m41=a[0],s.m42=a[1],s.m43=a[2],this}decompose(t,e,i,s,r,a=EulerOrders.XYZ){if(0===this.$matrix.m44)return!1;let n=temp_mats.next().load(this).$matrix,o=t,l=e,h=i;o&&(o[0]=n.m41,o[1]=n.m42,o[2]=n.m43);let c=Math.sqrt(n.m11*n.m11+n.m12*n.m12+n.m13*n.m13),d=Math.sqrt(n.m21*n.m21+n.m22*n.m22+n.m23*n.m23),u=Math.sqrt(n.m31*n.m31+n.m32*n.m32+n.m33*n.m33);if(c&&(n.m11/=c,n.m12/=c,n.m13/=c),d&&(n.m21/=d,n.m22/=d,n.m23/=d),u&&(n.m31/=u,n.m32/=u,n.m33/=u),h&&(h[0]=c,h[1]=d,h[2]=u),l){let t=myclamp,e=temp_mats.next().load(this);e.normalize(),n=e.$matrix;let i=n.m11,s=n.m12,r=n.m13,o=(n.m14,n.m21),h=n.m22,c=n.m23,d=(n.m24,n.m31),u=n.m32,p=n.m33;n.m34;a===EulerOrders.XYZ?(l[1]=Math.asin(t(r,-1,1)),Math.abs(r)<.9999999?(l[0]=Math.atan2(-c,p),l[2]=Math.atan2(-s,i)):(l[0]=Math.atan2(u,h),l[2]=0)):a===EulerOrders.YXZ?(l[0]=Math.asin(-t(c,-1,1)),Math.abs(c)<.9999999?(l[1]=Math.atan2(r,p),l[2]=Math.atan2(o,h)):(l[1]=Math.atan2(-d,i),l[2]=0)):a===EulerOrders.ZXY?(l[0]=Math.asin(t(u,-1,1)),Math.abs(u)<.9999999?(l[1]=Math.atan2(-d,p),l[2]=Math.atan2(-s,h)):(l[1]=0,l[2]=Math.atan2(o,i))):a===EulerOrders.ZYX?(l[1]=Math.asin(-t(d,-1,1)),Math.abs(d)<.9999999?(l[0]=Math.atan2(u,p),l[2]=Math.atan2(o,i)):(l[0]=0,l[2]=Math.atan2(-s,h))):a===EulerOrders.YZX?(l[2]=Math.asin(t(o,-1,1)),Math.abs(o)<.9999999?(l[0]=Math.atan2(-c,h),l[1]=Math.atan2(-d,i)):(l[0]=0,l[1]=Math.atan2(r,p))):a===EulerOrders.XZY?(l[2]=Math.asin(-t(s,-1,1)),Math.abs(s)<.9999999?(l[0]=Math.atan2(u,h),l[1]=Math.atan2(r,i)):(l[0]=Math.atan2(-c,p),l[1]=0)):console.warn("unsupported euler order:",a)}}_determinant2x2(t,e,i,s){return t*s-e*i}_determinant3x3(t,e,i,s,r,a,n,o,l){return t*this._determinant2x2(r,a,o,l)-s*this._determinant2x2(e,i,o,l)+n*this._determinant2x2(e,i,r,a)}_determinant4x4(){let t=this.$matrix.m11,e=this.$matrix.m12,i=this.$matrix.m13,s=this.$matrix.m14,r=this.$matrix.m21,a=this.$matrix.m22,n=this.$matrix.m23,o=this.$matrix.m24,l=this.$matrix.m31,h=this.$matrix.m32,c=this.$matrix.m33,d=this.$matrix.m34,u=this.$matrix.m41,p=this.$matrix.m42,m=this.$matrix.m43,f=this.$matrix.m44;return t*this._determinant3x3(a,h,p,n,c,m,o,d,f)-e*this._determinant3x3(r,l,u,n,c,m,o,d,f)+i*this._determinant3x3(r,l,u,a,h,p,o,d,f)-s*this._determinant3x3(r,l,u,a,h,p,n,c,m)}_makeAdjoint(){let t=this.$matrix.m11,e=this.$matrix.m12,i=this.$matrix.m13,s=this.$matrix.m14,r=this.$matrix.m21,a=this.$matrix.m22,n=this.$matrix.m23,o=this.$matrix.m24,l=this.$matrix.m31,h=this.$matrix.m32,c=this.$matrix.m33,d=this.$matrix.m34,u=this.$matrix.m41,p=this.$matrix.m42,m=this.$matrix.m43,f=this.$matrix.m44;this.$matrix.m11=this._determinant3x3(a,h,p,n,c,m,o,d,f),this.$matrix.m21=-this._determinant3x3(r,l,u,n,c,m,o,d,f),this.$matrix.m31=this._determinant3x3(r,l,u,a,h,p,o,d,f),this.$matrix.m41=-this._determinant3x3(r,l,u,a,h,p,n,c,m),this.$matrix.m12=-this._determinant3x3(e,h,p,i,c,m,s,d,f),this.$matrix.m22=this._determinant3x3(t,l,u,i,c,m,s,d,f),this.$matrix.m32=-this._determinant3x3(t,l,u,e,h,p,s,d,f),this.$matrix.m42=this._determinant3x3(t,l,u,e,h,p,i,c,m),this.$matrix.m13=this._determinant3x3(e,a,p,i,n,m,s,o,f),this.$matrix.m23=-this._determinant3x3(t,r,u,i,n,m,s,o,f),this.$matrix.m33=this._determinant3x3(t,r,u,e,a,p,s,o,f),this.$matrix.m43=-this._determinant3x3(t,r,u,e,a,p,i,n,m),this.$matrix.m14=-this._determinant3x3(e,a,h,i,n,c,s,o,d),this.$matrix.m24=this._determinant3x3(t,r,l,i,n,c,s,o,d),this.$matrix.m34=-this._determinant3x3(t,r,l,e,a,h,s,o,d),this.$matrix.m44=this._determinant3x3(t,r,l,e,a,h,i,n,c)}loadSTRUCT(t){t(this),this.load(this.mat),this.__mat=this.mat}}Matrix4$2.STRUCT="\nmat4 {\n  mat      : array(float) | this.getAsArray();\n  isPersp  : int          | this.isPersp;\n}\n",nstructjs.register(Matrix4$2),preMultTemp=new Matrix4$2,window.testmat=(t=0,e=0,i=.5*Math.PI)=>{let s=new Matrix4$2;s.euler_rotate(t,e,i);let r=[0,0,0],a=[0,0,0],n=[0,0,0];s.decompose(r,a,n),window.console.log("\n"),window.console.log(r),window.console.log(a),window.console.log(n);let o=s.clone();return o.transpose(),o.multiply(s),console.log(o.toString()),a},lookat_cache_ms=cachering.fromConstructor(Matrix4$2,64),euler_rotate_mats=cachering.fromConstructor(Matrix4$2,64),temp_mats=cachering.fromConstructor(Matrix4$2,64);var vectormath=Object.freeze({__proto__:null,EulerOrders:EulerOrders,BaseVector:BaseVector,F64BaseVector:F64BaseVector,F32BaseVector:F32BaseVector,I32BaseVector:I32BaseVector,I16BaseVector:I16BaseVector,I8BaseVector:I8BaseVector,UI32BaseVector:UI32BaseVector,UI16BaseVector:UI16BaseVector,UI8BaseVector:UI8BaseVector,makeVector4:makeVector4,Vector4:Vector4$2,makeVector3:makeVector3,Vector3:Vector3$2,makeVector2:makeVector2,Vector2:Vector2$b,Quat:Quat,Matrix4:Matrix4$2});let PropTypes$8={INT:1,STRING:2,BOOL:4,ENUM:8,FLAG:16,FLOAT:32,VEC2:64,VEC3:128,VEC4:256,MATRIX4:512,QUAT:1024,PROPLIST:4096,STRSET:8192,CURVE:16384,FLOAT_ARRAY:32768,REPORT:65536};const PropSubTypes$4={COLOR:1},PropFlags$3={SELECT:1,PRIVATE:2,LABEL:4,USE_ICONS:64,USE_CUSTOM_GETSET:128,SAVE_LAST_VALUE:256,READ_ONLY:512,SIMPLE_SLIDER:1024,FORCE_ROLLER_SLIDER:2048,USE_BASE_UNDO:4096,EDIT_AS_BASE_UNIT:8192,NO_UNDO:16384,USE_CUSTOM_PROP_GETTER:32768,FORCE_ENUM_CHECKBOXES:65536,NO_DEFAULT:1<<17};class ToolPropertyIF{constructor(t,e,i,s,r,a,n){this.data=void 0,this.type=t,this.subtype=e,this.apiname=i,this.uiname=s,this.description=r,this.flag=a,this.icon=n}equals(t){throw new Error("implement me")}copyTo(t){}copy(){}_fire(t,e,i){}on(t,e){}off(t,e){}getValue(){}setValue(t){}setStep(t){}setRange(t,e){}setUnit(t){}setUIRange(t,e){}setIcon(t){}}class StringPropertyIF extends ToolPropertyIF{constructor(){super(PropTypes$8.STRING)}}class NumPropertyIF extends ToolPropertyIF{}class IntPropertyIF extends ToolPropertyIF{constructor(){super(PropTypes$8.INT)}setRadix(t){throw new Error("implement me")}}class FloatPropertyIF extends ToolPropertyIF{constructor(){super(PropTypes$8.FLOAT)}setDecimalPlaces(t){}}class EnumPropertyIF extends ToolPropertyIF{constructor(t,e){if(super(PropTypes$8.ENUM),this.values={},this.keys={},this.ui_value_names={},this.iconmap={},void 0===e)return this;if(e instanceof Array||e instanceof String)for(var i=0;i<e.length;i++)this.values[e[i]]=e[i],this.keys[e[i]]=e[i];else for(var s in e)this.values[s]=e[s],this.keys[e[s]]=s;for(var s in this.values){var r=s[0].toUpperCase()+s.slice(1,s.length);r=r.replace(/\_/g," "),this.ui_value_names[s]=r}}addIcons(t){for(var e in void 0===this.iconmap&&(this.iconmap={}),t)this.iconmap[e]=t[e]}}class FlagPropertyIF extends EnumPropertyIF{constructor(t){super(PropTypes$8.FLAG)}}class Vec2PropertyIF extends ToolPropertyIF{constructor(t){super(PropTypes$8.VEC2)}}class Vec3PropertyIF extends ToolPropertyIF{constructor(t){super(PropTypes$8.VEC3)}}class Vec4PropertyIF extends ToolPropertyIF{constructor(t){super(PropTypes$8.VEC4)}}class ListPropertyIF extends ToolPropertyIF{constructor(t){super(PropTypes$8.PROPLIST),this.prop=t}get length(){}set length(t){}copyTo(t){}copy(){}clear(){}push(t=this.prop.copy()){}[Symbol.iterator](){}}class StringSetPropertyIF extends ToolPropertyIF{constructor(t,e=[]){super(PropTypes$8.STRSET)}setValue(t,e=!0,i=!0){}getValue(){}addIcons(t){}addUINames(t){}addDescriptions(t){}copyTo(t){}copy(){}}class Curve1DPropertyIF extends ToolPropertyIF{constructor(t,e){super(PropTypes$8.CURVE),this.data=t}getValue(){return this.curve}setValue(t){if(void 0===t)return;let e=JSON.parse(JSON.stringify(t));this.data.load(e)}copyTo(t){t.setValue(this.data)}}var toolprop_abstract=Object.freeze({__proto__:null,PropTypes:PropTypes$8,PropSubTypes:PropSubTypes$4,PropFlags:PropFlags$3,ToolPropertyIF:ToolPropertyIF,StringPropertyIF:StringPropertyIF,NumPropertyIF:NumPropertyIF,IntPropertyIF:IntPropertyIF,FloatPropertyIF:FloatPropertyIF,EnumPropertyIF:EnumPropertyIF,FlagPropertyIF:FlagPropertyIF,Vec2PropertyIF:Vec2PropertyIF,Vec3PropertyIF:Vec3PropertyIF,Vec4PropertyIF:Vec4PropertyIF,ListPropertyIF:ListPropertyIF,StringSetPropertyIF:StringSetPropertyIF,Curve1DPropertyIF:Curve1DPropertyIF});const FLT_EPSILONE=1.192092895507812e-7;function myfloor(t){return Math.floor(t+2*FLT_EPSILONE)}function normString(t){return(t=t.replace(/ /g,"").replace(/\t/g,"")).toLowerCase()}function myToFixed$2(t,e){if("number"!=typeof t)return"(error)";for(t=t.toFixed(e);t.endsWith("0")&&t.search(/\./)>=0;)t=t.slice(0,t.length-1);return t.endsWith(".")&&(t=t.slice(0,t.length-1)),0===t.length&&(t="0"),t.trim()}const Units=[];class Unit{static getUnit(t){if("none"!==t&&void 0!==t){for(let e of Units)if(e.unitDefine().name===t)return e;throw new Error("Unknown unit "+t)}}static register(t){Units.push(t)}static unitDefine(){return{name:"",uiname:"",type:"",icon:-1,pattern:void 0}}static parse(t){}static validate(t){t=normString(t);let e=this.unitDefine(),i=t.match(e.pattern);return!!i&&i[0]===t}static toInternal(t){}static fromInternal(t){}static buildString(t,e=2){}}class MeterUnit extends Unit{static unitDefine(){return{name:"meter",uiname:"Meter",type:"distance",icon:-1,pattern:/-?\d+(\.\d*)?m$/}}static parse(t){return(t=normString(t)).endsWith("m")&&(t=t.slice(0,t.length-1)),parseFloat(t)}static toInternal(t){return t}static fromInternal(t){return t}static buildString(t,e=2){return myToFixed$2(t,e)+" m"}}Unit.register(MeterUnit);class InchUnit extends Unit{static unitDefine(){return{name:"inch",uiname:"Inch",type:"distance",icon:-1,pattern:/-?\d+(\.\d*)?(in|inch)$/}}static parse(t){let e=(t=t.toLowerCase()).indexOf("i");return e>=0&&(t=t.slice(0,e)),parseInt(t)}static toInternal(t){return.0254*t}static fromInternal(t){return t/.0254}static buildString(t,e=2){return myToFixed$2(t,e)+"in"}}Unit.register(InchUnit);let foot_re=/((-?\d+(\.\d*)?ft)(-?\d+(\.\d*)?(in|inch))?)|(-?\d+(\.\d*)?(in|inch))$/;class FootUnit extends Unit{static unitDefine(){return{name:"foot",uiname:"Foot",type:"distance",icon:-1,pattern:foot_re}}static parse(t){let e=[],i=0,s=0;if((t=normString(t)).search("ft")>=0){e=t.split("ft"),e[1].search("in")>=0&&(e=[e[0]].concat(e[1].split("in")),s=parseFloat(e[1])),i=parseFloat(e[0])}else t=t.replace(/in/g,""),s=parseFloat(t);return s/12+i}static toInternal(t){return.3048*t}static fromInternal(t){return t/.3048}static buildString(t,e=2){let i=myfloor(t),s=12*(t+2*FLT_EPSILONE)%12;if(0===i)return myToFixed$2(s,e)+" in";let r=i+" ft";return 0!==s&&(r+=" "+myToFixed$2(s,e)+" in"),r}}Unit.register(FootUnit);let square_foot_re=/((-?\d+(\.\d*)?ft(\u00b2)?)(-?\d+(\.\d*)?(in|inch)(\u00b2)?)?)|(-?\d+(\.\d*)?(in|inch)(\u00b2)?)$/;class SquareFootUnit extends FootUnit{static unitDefine(){return{name:"square_foot",uiname:"Square Feet",type:"area",icon:-1,pattern:square_foot_re}}static parse(t){return t=t.replace(/\u00b2/g,""),super.parse(t)}static buildString(t,e=2){let i=myfloor(t),s=12*(t+2*FLT_EPSILONE)%12;if(0===i)return myToFixed$2(s,e)+" in²";let r=i+" ft²";return 0!==s&&(r+=" "+myToFixed$2(s,e)+" in²"),r}}Unit.register(SquareFootUnit);class MileUnit extends Unit{static unitDefine(){return{name:"mile",uiname:"Mile",type:"distance",icon:-1,pattern:/-?\d+(\.\d+)?miles$/}}static parse(t){return t=(t=normString(t)).replace(/miles/,""),parseFloat(t)}static toInternal(t){return 1609.34*t}static fromInternal(t){return t/1609.34}static buildString(t,e=3){return myToFixed$2(t,e)+" miles"}}Unit.register(MileUnit);class DegreeUnit extends Unit{static unitDefine(){return{name:"degree",uiname:"Degrees",type:"angle",icon:-1,pattern:/-?\d+(\.\d+)?(\u00B0|degree|deg|d|degree|degrees)$/}}static parse(t){return(t=normString(t)).search("d")>=0?t=t.slice(0,t.search("d")).trim():t.search("°")>=0&&(t=t.slice(0,t.search("°")).trim()),parseFloat(t)}static toInternal(t){return t/180*Math.PI}static fromInternal(t){return 180*t/Math.PI}static buildString(t,e=3){return myToFixed$2(t,e)+" °"}}Unit.register(DegreeUnit);class RadianUnit extends Unit{static unitDefine(){return{name:"radian",uiname:"Radians",type:"angle",icon:-1,pattern:/-?\d+(\.\d+)?(r|rad|radian|radians)$/}}static parse(t){return(t=normString(t)).search("r")>=0&&(t=t.slice(0,t.search("r")).trim()),parseFloat(t)}static toInternal(t){return t}static fromInternal(t){return t}static buildString(t,e=3){return myToFixed$2(t,e)+" r"}}function setBaseUnit(t){Unit.baseUnit=t}function setMetric(t){Unit.isMetric=t}Unit.register(RadianUnit),window._getBaseUnit=()=>Unit.baseUnit,Unit.isMetric=!0,Unit.baseUnit="meter";let numre1=/[+\-]?[0-9]+(\.[0-9]*)?$/,numre2=/[+\-]?[0-9]?(\.[0-9]*)+$/,hexre1=/[+\-]?[0-9a-fA-F]+h$/,hexre2=/[+\-]?0x[0-9a-fA-F]+$/,binre=/[+\-]?0b[01]+$/,expre=/[+\-]?[0-9]+(\.[0-9]*)?[eE]\-?[0-9]+$/,intre=/[+\-]?[0-9]+$/;function isnumber(t){function e(e){return 0===t.search(e)}return t=(""+t).trim(),e(intre)||e(numre1)||e(numre2)||e(hexre1)||e(hexre2)||e(binre)||e(expre)}function parseValueIntern(t,e){if("."===(t=t.trim())[0]&&(t="0"+t),"string"==typeof e){let t=Unit.getUnit(e);if(void 0===t&&"none"!==e)return console.warn("Unknown unit "+e),NaN;e=t}if(isnumber(t)){return parseFloat(t)}void 0===e&&console.warn("No base unit in units.js:parseValueIntern");for(let i of Units){i.unitDefine();if(i.validate(t)){console.log(i);let s=i.parse(t);return e?(s=i.toInternal(s),e.fromInternal(s)):s}}return NaN}function parseValue(t,e,i){i=Unit.getUnit(i),e=Unit.getUnit(e);let s=parseValueIntern(t,i||e);return i&&(s=i.toInternal(s)),e&&(s=e.fromInternal(s)),s}function isNumber(t){if(isnumber(t))return!0;for(let e of Units){e.unitDefine();if(e.validate(t))return!0}return!1}class PixelUnit extends Unit{static unitDefine(){return{name:"pixel",uiname:"Pixel",type:"distance",icon:-1,pattern:/-?\d+(\.\d*)?px$/}}static parse(t){return(t=normString(t)).endsWith("px")&&(t=t.slice(0,t.length-2).trim()),parseFloat(t)}static toInternal(t){return t}static fromInternal(t){return t}static buildString(t,e=2){return myToFixed$2(t,e)+"px"}}Unit.register(PixelUnit);class PercentUnit extends Unit{static unitDefine(){return{name:"percent",uiname:"Percent",type:"distance",icon:-1,pattern:/[0-9]+(\.[0-9]+)?[ \t]*%/}}static toInternal(t){return t/100}static fromInternal(t){return 100*t}static parse(t){return parseFloat(t.replace(/%/g,""))}static buildString(t,e=2){return t.toFixed(e)+"%"}}function convert(t,e,i){return"string"==typeof e&&(e=Unit.getUnit(e)),"string"==typeof i&&(i=Unit.getUnit(i)),e&&i?i.fromInternal(e.toInternal(t)):i?i.fromInternal(t):e?e.toInternal(t):t}function buildString(t,e=Unit.baseUnit,i=3,s=Unit.baseUnit){return"string"==typeof e&&"none"!==e&&(e=Unit.getUnit(e)),"string"==typeof s&&"none"!==s&&(s=Unit.getUnit(s)),s!==e&&(t=convert(t,e,s)),"none"!==s?s.buildString(t,i):myToFixed$2(t,i)}Unit.register(PercentUnit),window.unitConvert=convert,window._parseValueTest=parseValue,window._buildStringTest=buildString;const NumberConstraintsBase=new Set(["range","expRate","step","uiRange","baseUnit","displayUnit","stepIsRelative","slideSpeed","sliderDisplayExp"]),IntegerConstraints=new Set(["radix"].concat(list$2(NumberConstraintsBase))),FloatConstrinats=new Set(["decimalPlaces"].concat(list$2(NumberConstraintsBase))),NumberConstraints=new Set(list$2(IntegerConstraints).concat(list$2(FloatConstrinats))),PropSubTypes$3={COLOR:1};let first$1=t=>{if(void 0!==t)if(Symbol.iterator in t)for(let e of t)return e;else for(let e in t)return e};function setPropTypes(t){for(let e in t)PropTypes$8[e]=t[e]}let customPropertyTypes=[],PropClasses={},customPropTypeBase=17,wordmap={sel:"select",unsel:"deselect",eid:"id",props:"properties",res:"resource"};var defaultRadix=10,defaultDecimalPlaces=4;class OnceTag{constructor(t){this.cb=t}}class ToolProperty$1 extends ToolPropertyIF{constructor(t,e,i,s="",r="",a=0,n=-1){super(),this.data=void 0,void 0===t&&(t=this.constructor.PROP_TYPE_ID),this.type=t,this.subtype=e,this.wasSet=!1,this.apiname=i,this.uiname=void 0!==s?s:i,this.description=r,this.flag=a|PropFlags$3.SAVE_LAST_VALUE,this.icon=n,this.icon2=n,this.decimalPlaces=defaultDecimalPlaces,this.radix=defaultRadix,this.step=.05,this.callbacks={}}static internalRegister(t){PropClasses[(new t).type]=t}static getClass(t){return PropClasses[t]}static setDefaultRadix(t){defaultRadix=t}static setDefaultDecimalPlaces(t){defaultDecimalPlaces=t}static makeUIName(t){let e,i=[""],s=t=>{let e=(t=t.charCodeAt(0))>="A".charCodeAt(0);e=e&&t<="Z".charCodeAt(0);let i=t>="a".charCodeAt(0);return i=i&&t<="z".charCodeAt(0),e||i};for(let r=0;r<t.length;r++){let a=t[r];"_"!==a&&"-"!==a&&"$"!==a?(r>0&&a===a.toUpperCase()&&e!==e.toUpperCase()&&s(a)&&s(e)&&i.push(""),i[i.length-1]+=a,e=a):(e=a,a=" ",i.push(""))}return i=i.filter((t=>t.trim().length>0)).map((t=>{return(e=t)in wordmap?wordmap[e]:e;var e})).map((t=>t[0].toUpperCase()+t.slice(1,t.length).toLowerCase())).join(" ").trim(),i}static register(t){return t.PROP_TYPE_ID=1<<customPropTypeBase,PropTypes$8[t.name]=t.PROP_TYPE_ID,customPropTypeBase++,customPropertyTypes.push(t),PropClasses[(new t).type]=t,t.PROP_TYPE_ID}static calcRelativeStep(t,e,i=1.5){return e=Math.log(Math.abs(e)+1)/Math.log(i),e=Math.max(e,t),this.report(termColor("STEP","red"),e),e}setDescription(t){return this.description=t,this}setUIName(t){return this.uiname=t,this}calcMemSize(){function t(t){return void 0!==t?t.length+8:8}let e=0;e+=t(this.apiname)+t(this.uiname),e+=t(this.description),e+=88;for(let t in this.callbacks)e+=24;return e}equals(t){throw new Error("implement me")}private(){return this.flag|=PropFlags$3.PRIVATE,this.flag&=~PropFlags$3.SAVE_LAST_VALUE,this}saveLastValue(){return this.flag|=PropFlags$3.SAVE_LAST_VALUE,this}ignoreLastValue(){return this.flag&=~PropFlags$3.SAVE_LAST_VALUE,this}report(){console.warn(...arguments)}_fire(t,e,i){if(void 0===this.callbacks[t])return;let s=this.callbacks[t];s=s.concat([]);for(let t=0;t<s.length;t++){let r=s[t];if(r instanceof OnceTag){let a=t;for(;a<s.length-1;)s[a]=s[a+1],a++;s[a]=void 0,s.length--,t--,r.cb.call(this,e,i)}else r.call(this,e,i)}return this}clearEventCallbacks(){return this.callbacks={},this}once(t,e){void 0===this.callbacks[t]&&(this.callbacks[t]=[]);for(let i of this.callbacks[t])if(i instanceof OnceTag&&i.cb===e)return;return e=new OnceTag(e),this.callbacks[t].push(e),this}on(t,e){return void 0===this.callbacks[t]&&(this.callbacks[t]=[]),this.callbacks[t].push(e),this}off(t,e){return this.callbacks[t].remove(e),this}toJSON(){return{type:this.type,subtype:this.subtype,apiname:this.apiname,uiname:this.uiname,description:this.description,flag:this.flag,icon:this.icon,data:this.data,range:this.range,uiRange:this.uiRange,step:this.step}}loadJSON(t){return this.type=t.type,this.subtype=t.subtype,this.apiname=t.apiname,this.uiname=t.uiname,this.description=t.description,this.flag=t.flag,this.icon=t.icon,this.data=t.data,this}getValue(){return this.data}setValue(t){if(this.constructor===ToolProperty$1)throw new Error("implement me!");this.wasSet=!0,this._fire("change",t)}copyTo(t){t.apiname=this.apiname,t.uiname=this.uiname,t.description=this.description,t.icon=this.icon,t.icon2=this.icon2,t.baseUnit=this.baseUnit,t.subtype=this.subtype,t.displayUnit=this.displayUnit,t.flag=this.flag;for(let e in this.callbacks)t.callbacks[e]=this.callbacks[e]}copy(){let t=new this.constructor;return this.copyTo(t),t}setStep(t){return this.step=t,this}getStep(t=1){return this.stepIsRelative?ToolProperty$1.calcRelativeStep(this.step,t):this.step}setRelativeStep(t){this.step=t,this.stepIsRelative=!0}setRange(t,e){if(void 0===t||void 0===e)throw new Error("min and/or max cannot be undefined");return this.range=[t,e],this}noUnits(){return this.baseUnit=this.displayUnit="none",this}setBaseUnit(t){return this.baseUnit=t,this}setDisplayUnit(t){return this.displayUnit=t,this}setUnit(t){return this.baseUnit=this.displayUnit=t,this}setFlag(t,e=!1){return this.flag=e?this.flag|t:t,this}setUIRange(t,e){if(void 0===t||void 0===e)throw new Error("min and/or max cannot be undefined");return this.uiRange=[t,e],this}setIcon(t){return this.icon=t,this}setIcon2(t){return this.icon2=t,this}loadSTRUCT(t){t(this),-1e17===this.uiRange[0]&&1e17===this.uiRange[1]&&(this.uiRange=void 0),"undefined"===this.baseUnit&&(this.baseUnit=void 0),"undefined"===this.displayUnit&&(this.displayUnit=void 0)}}ToolProperty$1.STRUCT='\nToolProperty { \n  apiname        : string | ""+this.apiname;\n  type           : int;\n  flag           : int;\n  subtype        : int;\n  icon           : int;\n  icon2          : int;\n  baseUnit       : string | ""+this.baseUnit;\n  displayUnit    : string | ""+this.displayUnit;\n  range          : array(float) | this.range ? this.range : [-1e17, 1e17];\n  uiRange        : array(float) | this.uiRange ? this.uiRange : [-1e17, 1e17];\n  description    : string;\n  stepIsRelative : bool;\n  step           : float;\n  expRate        : float;\n  radix          : float;\n  decimalPlaces  : int;\n  uiname         : string | this.uiname || this.apiname || "";\n  wasSet         : bool;\n}\n',nstructjs.register(ToolProperty$1),window.ToolProperty=ToolProperty$1;class FloatArrayProperty extends ToolProperty$1{constructor(t,e,i,s,r,a){super(PropTypes$8.FLOAT_ARRAY,void 0,e,i,s,r,a),this.value=[],void 0!==t&&this.setValue(t)}[Symbol.iterator](){return this.value[Symbol.iterator]()}setValue(t){if(super.setValue(),void 0===t)throw new Error("value was undefined in FloatArrayProperty's setValue method");this.value.length=0;for(let e of t){if("number"!=typeof e&&"boolean"!=typeof e)throw console.log(t),new Error("bad item for FloatArrayProperty "+e);this.value.push(e)}}push(t){if("number"!=typeof t&&"boolean"!=typeof t)throw console.log(value),new Error("bad item for FloatArrayProperty "+t);this.value.push(t)}getValue(){return this.value}clear(){return this.value.length=0,this}}FloatArrayProperty.STRUCT=nstructjs.inherit(FloatArrayProperty,ToolProperty$1)+"\n  value : array(float);\n}",nstructjs.register(FloatArrayProperty);class StringProperty extends ToolProperty$1{constructor(t,e,i,s,r,a){super(PropTypes$8.STRING,void 0,e,i,s,r,a),this.multiLine=!1,t?this.setValue(t):this.setValue(""),this.wasSet=!1}calcMemSize(){return super.calcMemSize()+(void 0!==this.data?4*this.data.length:0)+8}equals(t){return this.data===t.data}copyTo(t){return super.copyTo(t),t.data=this.data,t.multiLine=this.multiLine,this}getValue(){return this.data}setValue(t){super.setValue(t),this.data=t}}StringProperty.STRUCT=nstructjs.inherit(StringProperty,ToolProperty$1)+"\n  data : string;\n}\n",nstructjs.register(StringProperty),ToolProperty$1.internalRegister(StringProperty);class NumProperty extends ToolProperty$1{constructor(t,e,i,s,r,a,n){super(t,void 0,i,s,r,a,n),this.data=0,this.range=[0,0]}equals(t){return this.data==t.data}loadSTRUCT(t){t(this),super.loadSTRUCT(t)}}NumProperty.STRUCT=nstructjs.inherit(NumProperty,ToolProperty$1)+"\n  range : array(float);\n  data  : float;\n}\n";class _NumberPropertyBase extends ToolProperty$1{constructor(t,e,i,s,r,a,n){super(t,null,i,s,r,a,n),this.data=0,this.sliderDisplayExp=1,this.slideSpeed=1,this.expRate=1.33,this.step=.1,this.stepIsRelative=!1,this.range=[-1e17,1e17],this.uiRange=void 0,null!=e&&(this.setValue(e),this.wasSet=!1)}get ui_range(){return this.report("NumberProperty.ui_range is deprecated"),this.uiRange}set ui_range(t){this.report("NumberProperty.ui_range is deprecated"),this.uiRange=t}calcMemSize(){return super.calcMemSize()+64}equals(t){return this.data===t.data}toJSON(){let t=super.toJSON();return t.data=this.data,t.expRate=this.expRate,t}copyTo(t){super.copyTo(t),t.displayUnit=this.displayUnit,t.baseUnit=this.baseUnit,t.expRate=this.expRate,t.step=this.step,t.range=this.range?[this.range[0],this.range[1]]:void 0,t.uiRange=this.uiRange?[this.uiRange[0],this.uiRange[1]]:void 0,t.slideSpeed=this.slideSpeed,t.sliderDisplayExp=this.sliderDisplayExp,t.data=this.data}setSliderDisplayExp(t){return this.sliderDisplayExp=t,this}setSlideSpeed(t){return this.slideSpeed=t,this}setExpRate(t){this.expRate=t}setValue(t){if(null!=t){if("number"!=typeof t)throw new Error("Invalid number "+t);return this.data=t,super.setValue(t),this}}loadJSON(t){super.loadJSON(t);let e=e=>{e in t&&(this[e]=t[e])};return e("range"),e("step"),e("expRate"),e("ui_range"),this}}_NumberPropertyBase.STRUCT=nstructjs.inherit(_NumberPropertyBase,ToolProperty$1)+"\n  range            : array(float);\n  expRate          : float;\n  data             : float;\n  step             : float;\n  slideSpeed       : float;\n  sliderDisplayExp : float;\n}\n",nstructjs.register(_NumberPropertyBase);class IntProperty extends _NumberPropertyBase{constructor(t,e,i,s,r,a){super(PropTypes$8.INT,t,e,i,s,r,a),this.baseUnit=this.displayUnit="none",this.radix=10}setValue(t){return super.setValue(Math.floor(t)),this}setRadix(t){this.radix=t}toJSON(){let t=super.toJSON();return t.data=this.data,t.radix=this.radix,t}loadJSON(t){return super.loadJSON(t),this.data=t.data||this.data,this.radix=t.radix||this.radix,this}loadSTRUCT(t){t(this),super.loadSTRUCT(t)}}IntProperty.STRUCT=nstructjs.inherit(IntProperty,_NumberPropertyBase)+"\n  data : int;\n}",nstructjs.register(IntProperty),ToolProperty$1.internalRegister(IntProperty);class ReportProperty extends StringProperty{constructor(t,e,i,s,r,a){super(t,e,i,s,r,a),this.type=PropTypes$8.REPORT}}ReportProperty.STRUCT=nstructjs.inherit(ReportProperty,StringProperty)+"\n}\n",nstructjs.register(ReportProperty),ToolProperty$1.internalRegister(ReportProperty);class BoolProperty extends ToolProperty$1{constructor(t,e,i,s,r,a){super(PropTypes$8.BOOL,void 0,e,i,s,r,a),this.data=!!t}equals(t){return this.data==t.data}copyTo(t){return super.copyTo(t),t.data=this.data,this}setValue(t){return this.data=!!t,super.setValue(t),this}getValue(){return this.data}toJSON(){return super.toJSON()}loadJSON(t){return super.loadJSON(t),this}}ToolProperty$1.internalRegister(BoolProperty),BoolProperty.STRUCT=nstructjs.inherit(BoolProperty,ToolProperty$1)+"\n  data : bool;\n}\n",nstructjs.register(BoolProperty);class FloatProperty extends _NumberPropertyBase{constructor(t,e,i,s,r,a){super(PropTypes$8.FLOAT,t,e,i,s,r,a),this.decimalPlaces=4}setDecimalPlaces(t){return this.decimalPlaces=t,this}copyTo(t){return super.copyTo(t),t.data=this.data,this}setValue(t){return this.data=t,super.setValue(t),this}toJSON(){let t=super.toJSON();return t.data=this.data,t.decimalPlaces=this.decimalPlaces,t}loadJSON(t){return super.loadJSON(t),this.data=t.data||this.data,this.decimalPlaces=t.decimalPlaces||this.decimalPlaces,this}loadSTRUCT(t){t(this),super.loadSTRUCT(t)}}ToolProperty$1.internalRegister(FloatProperty),FloatProperty.STRUCT=nstructjs.inherit(FloatProperty,_NumberPropertyBase)+"\n  decimalPlaces : int;\n  data          : float;\n}\n",nstructjs.register(FloatProperty);class EnumKeyPair{constructor(t,e){this.key=""+t,this.val=""+e,this.key_is_int="number"==typeof t||"boolean"==typeof t,this.val_is_int="number"==typeof e||"boolean"==typeof e}loadSTRUCT(t){t(this),this.val_is_int&&(this.val=parseInt(this.val)),this.key_is_int&&(this.key=parseInt(this.key))}}EnumKeyPair.STRUCT="\nEnumKeyPair {\n  key        : string;\n  val        : string;\n  key_is_int : bool;\n  val_is_int : bool; \n}\n",nstructjs.register(EnumKeyPair);class EnumProperty$9 extends ToolProperty$1{constructor(t,e,i,s,r,a,n){if(super(PropTypes$8.ENUM,void 0,i,s,r,a,n),this.values={},this.keys={},this.ui_value_names={},this.descriptions={},void 0===e)return this;if(e instanceof Array||e instanceof String)for(var o=0;o<e.length;o++)this.values[e[o]]=e[o],this.keys[e[o]]=e[o];else for(var l in e)this.values[l]=e[l],this.keys[e[l]]=l;for(var l in void 0===t?this.data=first$1(e):this.setValue(t),this.values){let t=l.replace(/[_-]/g," ").trim();t=t.split(" ");let e=ToolProperty$1.makeUIName(l);this.ui_value_names[l]=e,this.descriptions[l]=e}this.iconmap={},this.iconmap2={},this.wasSet=!1}calcHash(t=new HashDigest){for(let e in this.keys)t.add(e),t.add(this.keys[e]);return t.get()}updateDefinition(t){let e,i=this.descriptions,s=this.ui_value_names;this.values={},this.keys={},this.ui_value_names={},this.descriptions={},e=t instanceof EnumProperty$9?t.values:t;for(let t in e){let i=e[t];this.values[t]=i,this.keys[i]=t}if(t instanceof EnumProperty$9){let e=t;this.iconmap=Object.assign({},e.iconmap),this.iconmap2=Object.assign({},e.iconmap2),this.ui_value_names=Object.assign({},e.ui_value_names),this.descriptions=Object.assign({},e.descriptions)}else for(let t in this.values)this.ui_value_names[t]=t in s?s[t]:ToolProperty$1.makeUIName(t),this.descriptions[t]=t in i?i[t]:ToolProperty$1.makeUIName(t);return this._fire("metaChange",this),this}calcMemSize(){let t=super.calcMemSize();for(let e in this.values)t+=4*(4*e.length+16);if(this.descriptions)for(let e in this.descriptions)t+=4*(e.length+this.descriptions[e].length);return t+64}equals(t){return this.getValue()===t.getValue()}addUINames(t){for(let e in t)this.ui_value_names[e]=t[e];return this}addDescriptions(t){for(let e in t)this.descriptions[e]=t[e];return this}addIcons2(t){void 0===this.iconmap2&&(this.iconmap2={});for(let e in t)this.iconmap2[e]=t[e];return this}addIcons(t){void 0===this.iconmap&&(this.iconmap={});for(let e in t)this.iconmap[e]=t[e];return this}copyTo(t){return super.copyTo(t),t.data=this.data,t.keys=Object.assign({},this.keys),t.values=Object.assign({},this.values),t.ui_value_names=this.ui_value_names,t.update=this.update,t.api_update=this.api_update,t.iconmap=this.iconmap,t.iconmap2=this.iconmap2,t.descriptions=this.descriptions,t}copy(){var t=new this.constructor("dummy",{dummy:0},this.apiname,this.uiname,this.description,this.flag);return this.copyTo(t),t}getValue(){return this.data in this.values?this.values[this.data]:this.data}setValue(t){if(!(t in this.values)&&t in this.keys&&(t=this.keys[t]),t in this.values)return this.data=t,super.setValue(t),this;this.report("Invalid value for enum!",t,this.values)}_loadMap(t){if(!t)return{};let e={};for(let i of t)e[i.key]=i.val;return e}_saveMap(t){t=void 0===t?{}:t;let e=[];for(let i in t)e.push(new EnumKeyPair(i,t[i]));return e}loadSTRUCT(t){t(this),super.loadSTRUCT(t),this.keys=this._loadMap(this._keys),this.values=this._loadMap(this._values),this.ui_value_names=this._loadMap(this._ui_value_names),this.iconmap=this._loadMap(this._iconmap),this.iconmap2=this._loadMap(this._iconmap2),this.descriptions=this._loadMap(this._descriptions),this.data_is_int?(this.data=parseInt(this.data),delete this.data_is_int):this.data in this.keys&&(this.data=this.keys[this.data])}_is_data_int(){return"number"==typeof this.data}}ToolProperty$1.internalRegister(EnumProperty$9),EnumProperty$9.STRUCT=nstructjs.inherit(EnumProperty$9,ToolProperty$1)+'\n  data            : string             | ""+this.data;\n  data_is_int     : bool               | this._is_data_int();\n  _keys           : array(EnumKeyPair) | this._saveMap(this.keys) ;\n  _values         : array(EnumKeyPair) | this._saveMap(this.values) ;\n  _ui_value_names : array(EnumKeyPair) | this._saveMap(this.ui_value_names) ;\n  _iconmap        : array(EnumKeyPair) | this._saveMap(this.iconmap) ;\n  _iconmap2       : array(EnumKeyPair) | this._saveMap(this.iconmap2) ;\n  _descriptions   : array(EnumKeyPair) | this._saveMap(this.descriptions) ;  \n}\n',nstructjs.register(EnumProperty$9);class FlagProperty extends EnumProperty$9{constructor(t,e,i,s,r,a,n){super(t,e,i,s,r,a,n),this.type=PropTypes$8.FLAG,this.wasSet=!1}setValue(t){return this.data=t,ToolProperty$1.prototype.setValue.call(this,t),this}}ToolProperty$1.internalRegister(FlagProperty),FlagProperty.STRUCT=nstructjs.inherit(FlagProperty,EnumProperty$9)+"\n}\n",nstructjs.register(FlagProperty);class VecPropertyBase extends FloatProperty{constructor(t,e,i,s){super(void 0,e,i,s),this.hasUniformSlider=!1}calcMemSize(){return super.calcMemSize()+8*this.data.length}equals(t){return this.data.vectorDistance(t.data)<1e-5}uniformSlider(t=!0){return this.hasUniformSlider=t,this}copyTo(t){super.copyTo(t),t.hasUniformSlider=this.hasUniformSlider}}VecPropertyBase.STRUCT=nstructjs.inherit(VecPropertyBase,FloatProperty)+"\n  hasUniformSlider : bool | this.hasUniformSlider || false;\n}\n";class Vec2Property extends FloatProperty{constructor(t,e,i,s){super(void 0,e,i,s),this.type=PropTypes$8.VEC2,this.data=new Vector2$b(t)}setValue(t){return this.data.load(t),ToolProperty$1.prototype.setValue.call(this,t),this}getValue(){return this.data}copyTo(t){let e=t.data;super.copyTo(t),t.data=e,t.data.load(this.data)}}Vec2Property.STRUCT=nstructjs.inherit(Vec2Property,VecPropertyBase)+"\n  data : vec2;\n}\n",nstructjs.register(Vec2Property),ToolProperty$1.internalRegister(Vec2Property);class Vec3Property extends VecPropertyBase{constructor(t,e,i,s){super(void 0,e,i,s),this.type=PropTypes$8.VEC3,this.data=new Vector3$2(t)}isColor(){return this.subtype=PropSubTypes$3.COLOR,this}setValue(t){return this.data.load(t),ToolProperty$1.prototype.setValue.call(this,t),this}getValue(){return this.data}copyTo(t){let e=t.data;super.copyTo(t),t.data=e,t.data.load(this.data)}}Vec3Property.STRUCT=nstructjs.inherit(Vec3Property,VecPropertyBase)+"\n  data : vec3;\n}\n",nstructjs.register(Vec3Property),ToolProperty$1.internalRegister(Vec3Property);class Vec4Property extends FloatProperty{constructor(t,e,i,s){super(void 0,e,i,s),this.type=PropTypes$8.VEC4,this.data=new Vector4$2(t)}setValue(t,e=1){return this.data.load(t),ToolProperty$1.prototype.setValue.call(this,t),t.length<3&&(this.data[2]=0),t.length<4&&(this.data[3]=e),this}isColor(){return this.subtype=PropSubTypes$3.COLOR,this}getValue(){return this.data}copyTo(t){let e=t.data;super.copyTo(t),t.data=e,t.data.load(this.data)}}Vec4Property.STRUCT=nstructjs.inherit(Vec4Property,VecPropertyBase)+"\n  data : vec4;\n}\n",nstructjs.register(Vec4Property),ToolProperty$1.internalRegister(Vec4Property);class QuatProperty extends ToolProperty$1{constructor(t,e,i,s){super(PropTypes$8.QUAT,void 0,e,i,s),this.data=new Quat(t)}equals(t){return this.data.vectorDistance(t.data)<1e-5}setValue(t){return this.data.load(t),super.setValue(t),this}getValue(){return this.data}copyTo(t){let e=t.data;super.copyTo(t),t.data=e,t.data.load(this.data)}}QuatProperty.STRUCT=nstructjs.inherit(QuatProperty,VecPropertyBase)+"\n  data : vec4;\n}\n",nstructjs.register(QuatProperty),ToolProperty$1.internalRegister(QuatProperty);class Mat4Property extends ToolProperty$1{constructor(t,e,i,s){super(PropTypes$8.MATRIX4,void 0,e,i,s),this.data=new Matrix4$2(t)}calcMemSize(){return super.calcMemSize()+128+32}equals(t){let e=this.data.$matrix,i=t.data.$matrix;for(let t=1;t<=4;t++)for(let s=1;s<=4;s++){let r=`m${t}${s}`;if(Math.abs(e[r]-i[r])>1e-5)return!1}return!0}setValue(t){return this.data.load(t),super.setValue(t),this}getValue(){return this.data}copyTo(t){let e=t.data;super.copyTo(t),t.data=e,t.data.load(this.data)}loadSTRUCT(t){t(this),super.loadSTRUCT(t)}}Mat4Property.STRUCT=nstructjs.inherit(Mat4Property,FloatProperty)+"\n  data           : mat4;\n}\n",nstructjs.register(Mat4Property),ToolProperty$1.internalRegister(Mat4Property);class ListProperty extends ToolProperty$1{constructor(t,e=[],i=""){if(super(PropTypes$8.PROPLIST),this.uiname=i,this.flag&=~PropFlags$3.SAVE_LAST_VALUE,"number"==typeof t?void 0!==(t=PropClasses[t])&&(t=new t):void 0!==t&&(t=t instanceof ToolProperty$1?t.copy():new t),this.prop=t,this.value=[],e)for(let t of e)this.push(t);this.wasSet=!1}get length(){return this.value.length}set length(t){this.value.length=t}splice(t,e,...i){const s=this.value.splice(t,e,...i);return this.length=this.value.length,s}calcMemSize(){let t=super.calcMemSize(),e=this.prop?this.prop.calcMemSize()+8:8;return!this.prop&&this.value.length>0&&(e=this.value[0].calcMemSize()),t+=e*this.value.length+8,t+=16,t}equals(t){let e=this.value?this.value.length:0;if(e!==(t.value?t.value.length:0))return!1;for(let i=0;i<e;i++){let e=this.value[i],s=t.value[i],r=e.constructor!==s.constructor;if(r=r||!e.equals(s),r)return!1}return!0}copyTo(t){super.copyTo(t),t.prop=this.prop.copy(),t.value.length=[];for(let e of this.value)t.value.push(e.copy());return t}copy(){return this.copyTo(new ListProperty(this.prop.copy()))}push(t){if(void 0===t&&(t=this.prop.copy()),!(t instanceof ToolProperty$1)){let e=this.prop.copy();e.setValue(t),t=e}return this.value.push(t),t}clear(){return this.value.length=0,this}getListItem(t){return t<0&&(t+=this.length),this.value[t].getValue()}setListItem(t,e){t<0&&(t+=this.length),this.value[t].setValue(e)}setValue(t){this.clear();for(let e of t){let t=this.push();if("object"!=typeof e)t.setValue(e);else{if(!(e instanceof t.constructor))throw this.report(e),new Error("invalid value "+e);e.copyTo(t)}}return super.setValue(t),this}getValue(){return this.value}[Symbol.iterator](){let t=this.value;return function*(){for(let e of t)yield e.getValue()}()}}ListProperty.STRUCT=nstructjs.inherit(ListProperty,ToolProperty$1)+"\n  prop  : abstract(ToolProperty);\n  value : array(abstract(ToolProperty));\n}",nstructjs.register(ListProperty),ToolProperty$1.internalRegister(ListProperty);class StringSetProperty extends ToolProperty$1{constructor(t,e=[]){super(PropTypes$8.STRSET);let i=[];this.value=new set$2;let s=e;if(Array.isArray(s)||s instanceof set$2||s instanceof Set)for(let t of s)i.push(t);else if("object"==typeof s)for(let t in s)i.push(t);else"string"==typeof s&&i.push(s);this.values={},this.ui_value_names={},this.descriptions={},this.iconmap={},this.iconmap2={};for(let t of i){this.values[t]=t;let e=ToolProperty$1.makeUIName(t);this.ui_value_names[t]=e}void 0!==t&&this.setValue(t),this.wasSet=!1}calcMemSize(){let t=super.calcMemSize();for(let e in this.values)t+=5*(e.length+16);if(this.descriptions)for(let e in this.descriptions)t+=4*(e.length+this.descriptions[e].length+8);return t+64}equals(t){return this.value.equals(t.value)}setValue(t,e=!0,i=!0){let s="string"!=typeof t;if(s=s&&"object"!=typeof t,s=s&&null!=t,s){if(i)return void this.report("Invalid argument to StringSetProperty.prototype.setValue() "+t);throw new Error("Invalid argument to StringSetProperty.prototype.setValue() "+t)}if(t)if("string"==typeof t){if(e&&this.value.clear(),!(t in this.values)){if(i)return void this.report(`"${t}" is not in this StringSetProperty`);throw new Error(`"${t}" is not in this StringSetProperty`)}this.value.add(t)}else{let e=[];if(Array.isArray(t)||t instanceof set$2||t instanceof Set)for(let i of t)e.push(i);else for(let i in t)e.push(i);for(let t of e){if(!(t in this.values)){if(i){this.report(`"${t}" is not in this StringSetProperty`);continue}throw new Error(`"${t}" is not in this StringSetProperty`)}this.value.add(t)}}else this.value.clear();return super.setValue(),this}getValue(){return this.value}addIcons2(t){if(void 0!==t){for(let e in t)this.iconmap2[e]=t[e];return this}}addIcons(t){if(void 0!==t){for(let e in t)this.iconmap[e]=t[e];return this}}addUINames(t){for(let e in t)this.ui_value_names[e]=t[e];return this}addDescriptions(t){for(let e in t)this.descriptions[e]=t[e];return this}copyTo(t){super.copyTo(t);for(let e of this.value)t.value.add(e);t.values={};for(let e in this.values)t.values[e]=this.values[e];t.ui_value_names={};for(let e in this.ui_value_names)t.ui_value_names[e]=this.ui_value_names[e];t.iconmap={},t.iconmap2={};for(let e in this.iconmap)t.iconmap[e]=this.iconmap[e];for(let e in this.iconmap2)t.iconmap2[e]=this.iconmap2[e];t.descriptions={};for(let e in this.descriptions)t.descriptions[e]=this.descriptions[e]}loadSTRUCT(t){t(this);let e=this.values;this.values={};for(let t of e)this.values[t]=t;this.value=new set$2(this.value)}}StringSetProperty.STRUCT=nstructjs.inherit(StringSetProperty,ToolProperty$1)+"\n  value  : iter(string);\n  values : iterkeys(string);  \n}",nstructjs.register(StringSetProperty),ToolProperty$1.internalRegister(StringSetProperty);let config={doubleClickTime:500,autoLoadSplineTemplates:!0,doubleClickHoldTime:750,DEBUG:{}};function setConfig(t){for(let e in t)config[e]=t[e]}var config$1=Object.freeze({__proto__:null,config:config,setConfig:setConfig,default:config});let modalstack$1=[],singleMouseCBs={},Screen$2,ContextAreaClass;function debugDomEvents(){let t=Symbol("event-callback"),e=Symbol("debug-info"),i=0;function s(t){t[e]||(t[e]=i++)}function r(t,i,r){return s(t),t[e]+":"+i+":"+JSON.stringify(r)}let a=EventTarget.prototype.addEventListener,n=EventTarget.prototype.removeEventListener;EventTarget.prototype.addEventListener=function(e,i,n){s(this),i[t]||(i[t]=new Set);let o=r(this,e,n);return i[t].add(o),a.call(this,e,i,n)},EventTarget.prototype.removeEventListener=function(e,i,a){if(s(this),!i[t])return void console.error("Invalid callback in removeEventListener for",e,this,i);let o=r(this,e,a);if(i[t].has(o))return i[t].delete(o),n.call(this,e,i,a);console.error("Callback not in removeEventListener;",e,this,i)}}function singletonMouseEvents(){let t=["mousedown","mouseup","mousemove"];for(let e of t)singleMouseCBs[e]=new Set;let e=-1;window.testSingleMouseUpEvent=(t="mousedown")=>{let i=e++;singleMouseEvent((()=>{console.log("mouse event",i)}),t)};let i=new Vector2$b;function s(t,e){let s=singleMouseCBs[e];singleMouseCBs[e]=new Set,"touchend"!==t.type&&"touchcancel"!==t.type&&(i[0]=t.touches&&t.touches.length>0?t.touches[0].pageX:t.x,i[1]=t.touches&&t.touches.length>0?t.touches[0].pageY:t.y),t.touches&&((t=copyEvent(t)).type=e,t.touches.length>0?(t.x=t.pageX=t.touches[0].pageX,t.y=t.pageY=t.touches[0].pageY):(t.x=i[0],t.y=i[1]));for(let e of s)try{e(t)}catch(t){print_stack$1(t),console.warn("Error in event callback")}}return window.addEventListener("mouseup",(t=>{s(t,"mouseup")}),{capture:!0}),window.addEventListener("touchcancel",(t=>{s(t,"mouseup")}),{capture:!0}),document.addEventListener("touchend",(t=>{s(t,"mouseup")}),{capture:!0}),document.addEventListener("mousedown",(t=>{s(t,"mousedown")}),{capture:!0}),document.addEventListener("touchstart",(t=>{s(t,"mousedown")}),{capture:!0}),document.addEventListener("mousemove",(t=>{s(t,"mousemove")}),{capture:!0}),document.addEventListener("touchmove",(t=>{s(t,"mousemove")}),{capture:!0}),{singleMouseEvent(t,e){if(!(e in singleMouseCBs))throw new Error("not a mouse event");singleMouseCBs[e].add(t)}}}function singleMouseEvent(t,e){return singletonMouseEvents.singleMouseEvent(t,e)}function isLeftClick(t){return void 0!==t.touches?1===t.touches.length:0===t.button}singletonMouseEvents=singletonMouseEvents();class DoubleClickHandler{constructor(){this.down=0,this.last=0,this.dblEvent=void 0,this.start_mpos=new Vector2$b,this._on_mouseup=this._on_mouseup.bind(this),this._on_mousemove=this._on_mousemove.bind(this)}_on_mouseup(t){this.mdown=!1}_on_mousemove(t){let e=new Vector2$b;e[0]=t.x,e[1]=t.y,e.vectorDistance(this.start_mpos)*devicePixelRatio>11&&(this.mdown=!1),this.mdown&&singleMouseEvent(this._on_mousemove,"mousemove"),this.update()}mousedown(t){if(this.last||(this.last=0),this.down||(this.down=0),this.up||(this.up=0),isMouseDown(t)){this.mdown=!0;let e=Object.assign({},t);this.start_mpos[0]=t.x,this.start_mpos[1]=t.y,singleMouseEvent(this._on_mousemove,"mousemove"),t.type.search("touch")>=0&&t.touches.length>0?(e.x=e.pageX=t.touches[0].pageX,e.y=e.pageY=t.touches[1].pageY):(e.x=e.pageX=t.x,e.y=e.pageY=t.y),this.dblEvent=copyEvent(t),this.dblEvent.type="dblclick",this.last=this.down,this.down=time_ms(),this.down-this.last<config.doubleClickTime?(this.mdown=!1,this.ondblclick(this.dblEvent),this.down=this.last=0):singleMouseEvent(this._on_mouseup,"mouseup")}else this.mdown=!1}ondblclick(t){}update(){modalstack$1.length>0&&(this.mdown=!1),this.mdown&&time_ms()-this.down>config.doubleClickHoldTime&&(this.mdown=!1,this.ondblclick(this.dblEvent))}abort(){this.last=this.down=0}}function isMouseDown(t){let e=0;return e=void 0!==t.touches?t.touches.length>0:t.buttons,e&=1,e}function pathDebugEvent(t,e){t.__prevdef=t.preventDefault,t.__stopprop=t.stopPropagation,t.preventDefault=function(){return console.warn("preventDefault",e),this.__prevdef()},t.stopPropagation=function(){return console.warn("stopPropagation",e),this.__stopprop()}}function eventWasTouch(t){let e=t.sourceCapabilities&&t.sourceCapabilities.firesTouchEvents;return e=e||t.was_touch,e=e||t instanceof TouchEvent,e=e||void 0!==t.touches,t instanceof PointerEvent&&(e=e||"pen"===t.pointerType||"touch"===t.pointerType),e}function copyEvent(t){let e={},i=[];for(let e in t)i.push(e);i=i.concat(Object.getOwnPropertySymbols(t)),i=i.concat(Object.getOwnPropertyNames(t));for(let s of i){let i;try{i=t[s]}catch(t){console.warn("read error for event key",s);continue}e[s]="function"==typeof i?i.bind(t):i}return e.original=t,e}function _setScreenClass(t){Screen$2=t}function findScreen(){let t=e=>{for(let t of e.childNodes)if(t&&"object"==typeof t&&t instanceof Screen$2)return t;for(let i of e.childNodes){let e=t(i);if(e)return e}};return t(document.body)}function _setModalAreaClass(t){ContextAreaClass=t}function pushPointerModal(t,e,i,s=!0){return pushModalLight(t,s,e,i)}function pushModalLight(t,e=!0,i,s){let r;r=void 0===s?new Set(["keydown","keyup","mousedown","mouseup","touchstart","touchend","touchcancel","mousewheel","mousemove","mouseover","mouseout","mouseenter","mouseleave","dragstart","drag","dragend","dragexit","dragleave","dragover","dragenter","drop","pointerdown","pointermove","pointerup","pointercancel","pointerstart","pointerend","pointerleave","pointerexit","pointerenter","pointerover"]):new Set(["keydown","keyup","keypress","mousewheel"]);let a={keys:r,handlers:{},last_mpos:[0,0]},n={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",touchcancel:"mouseup"},o=[0,0],l=findScreen();function h(){let t=findScreen();if(t){let e=t.findScreenArea(o[0],o[1]);e&&e.area&&(e.area.push_ctx_active(),e.area.pop_ctx_active())}}function c(t,i){return function(i){if(config.DEBUG.domEvents&&pathDebugEvent(i),n[t]in a.handlers){let e=n[t],s=copyEvent(i);if(s.was_touch=!0,s.type=e,s.button="touchcancel"==t?1:0,s.touches=i.touches,i.touches.length>0){let t=i.touches[0];o[0]=t.pageX,o[1]=t.pageY,s.pageX=s.x=t.pageX,s.pageY=s.y=t.pageY,s.clientX=t.clientX,s.clientY=t.clientY,s.x=t.clientX,s.y=t.clientY,a.last_mpos[0]=s.x,a.last_mpos[1]=s.y}else s.x=s.clientX=s.pageX=s.screenX=a.last_mpos[0],s.y=s.clientY=s.pageY=s.screenY=a.last_mpos[1];s.was_touch=!0,h(),a.handlers[e](s)}e&&(i.preventDefault(),i.stopPropagation())}}function d(i,s){return function(i){config.DEBUG.domEvents&&pathDebugEvent(i),"string"==typeof s&&(s.startsWith("mouse")?(o[0]=i.pageX,o[1]=i.pageY):s.startsWith("pointer")&&(o[0]=i.x,o[1]=i.y),h(),void 0!==s&&t[s](i),e&&(i.preventDefault(),i.stopPropagation()))}}l&&(o[0]=l.mpos[0],o[1]=l.mpos[1],l=void 0);let u={};for(let e of r){let i;if(t[e])i=e;else if(t["on"+e])i="on"+e;else if(t["on_"+e])i="on_"+e;else{if(e in n)continue;i=void 0}if(void 0===i&&0===e.search("pointer"))continue;void 0!==i&&(u[e]=1);let s=d(0,i);a.handlers[e]=s;let r=s.settings={passive:!1,capture:!0};window.addEventListener(e,s,r)}for(let t in n)if(!(t in u)){a.handlers[t]=c(t);let e=a.handlers[t].settings={passive:!1,capture:!0};window.addEventListener(t,a.handlers[t],e)}if(void 0!==s){function p(i){let s="on_"+i;a.pointer[i]=function(i){void 0!==t[s]&&t[s](i),e&&(i.stopPropagation(),i.preventDefault())}}a.pointer={elem:i,pointerId:s},p("pointerdown"),p("pointermove"),p("pointerup"),p("pointerstart"),p("pointerend"),p("pointerleave"),p("pointerenter"),p("pointerout"),p("pointerover"),p("pointerexit"),p("pointercancel");for(let t in a.pointer)"elem"!==t&&"pointerId"!==t&&i.addEventListener(t,a.pointer[t]);try{i.setPointerCapture(s)}catch(s){print_stack$1(s),console.log("attempting fallback");for(let t in a.pointer)"elem"!==t&&"pointerId"!==t&&i.removeEventListener(t,a.pointer[t]);delete a.pointer,modalstack$1.push(a),popModalLight(a);for(let e in t)if("pointercancel"!==e&&"pointerend"!==e&&"pointerstart"!==e&&e.startsWith("pointer")){let i=e.replace(/pointer/,"mouse");if(i in t){console.warn("warning, existing mouse handler",i);continue}let s=t[e];t[e]=void 0,t[i]=s}return console.log(t),pushModalLight(t,e)}}return modalstack$1.push(a),ContextAreaClass.lock(),config.DEBUG.modalEvents&&console.warn("pushModalLight",a.pointer?"(pointer events)":""),a}function popModalLight(t){if(void 0!==t){if(t!==modalstack$1[modalstack$1.length-1]){if(modalstack$1.indexOf(t)<0)return void console.warn("Error in popModalLight; modal handler not found");console.warn("Error in popModalLight; called in wrong order")}for(let e in t.handlers)window.removeEventListener(e,t.handlers[e],t.handlers[e].settings);if(t.handlers={},modalstack$1.remove(t),ContextAreaClass.unlock(),config.DEBUG.modalEvents&&console.warn("popModalLight",modalstack$1,t.pointer?"(pointer events)":""),t.pointer){let e=t.pointer.elem;try{e.releasePointerCapture(t.pointer.pointerId)}catch(t){print_stack$1(t)}for(let i in t.pointer)"elem"!==i&&"pointerId"!==i&&e.removeEventListener(i,t.pointer[i])}}else console.warn("Bad call to popModalLight: state was undefined")}function haveModal(){return modalstack$1.length>0}window._findScreen=findScreen,window._haveModal=haveModal;for(var keymap_latin_1={Space:32,Escape:27,Enter:13,Return:13,Up:38,Down:40,Left:37,Right:39,Num0:96,Num1:97,Num2:98,Num3:99,Num4:100,Num5:101,Num6:102,Num7:103,Num8:104,Num9:105,Home:36,End:35,Delete:46,Backspace:8,Insert:45,PageUp:33,PageDown:34,Tab:9,"-":189,"=":187,".":190,"/":191,",":188,";":186,"'":222,"[":219,"]":221,NumPlus:107,NumMinus:109,Shift:16,Ctrl:17,Control:17,Alt:18},i$1=0;i$1<26;i$1++)keymap_latin_1[String.fromCharCode(i$1+65)]=i$1+65;for(var i$1=0;i$1<10;i$1++)keymap_latin_1[String.fromCharCode(i$1+48)]=i$1+48;for(var k in keymap_latin_1)k in keymap_latin_1||(keymap_latin_1[keymap_latin_1[k]]=k);var keymap_latin_1_rev={};for(var k in keymap_latin_1)keymap_latin_1_rev[keymap_latin_1[k]]=k;var keymap$4=keymap_latin_1,reverse_keymap=keymap_latin_1_rev;class HotKey{constructor(t,e,i,s){this.action=i,this.mods=e,this.key=keymap$4[t],this.uiname=s}exec(t){"string"==typeof this.action?t.api.execTool(t,this.action):this.action(t)}buildString(){let t="";for(let e=0;e<this.mods.length;e++){e>0&&(t+=" + ");let i=this.mods[e].toLowerCase();i=i[0].toUpperCase()+i.slice(1,i.length).toLowerCase(),t+=i}return this.mods.length>0&&(t+="+"),t+=reverse_keymap[this.key],t.trim()}}class KeyMap extends Array{constructor(t=[],e="undefined"){super(),this.pathid=e;for(let e of t)this.add(e)}handle(t,e){let i=new set$2;e.shiftKey&&i.add("shift"),e.altKey&&i.add("alt"),e.ctrlKey&&i.add("ctrl"),e.commandKey&&i.add("command");for(let s of this){let r=e.keyCode===s.key;if(!r)continue;let a=0;for(let t of s.mods){if(t=t.toLowerCase().trim(),!i.has(t)){r=!1;break}a++}if(a!==i.length&&(r=!1),r){try{s.exec(t)}catch(t){print_stack$1(t),console.log("failed to execute a hotkey",keymap$4[e.keyCode])}return!0}}return!1}add(t){this.push(t)}push(t){super.push(t)}}const ClassIdSymbol=Symbol("pathux-class-id");let ScreenClass;function setScreenClass$1(t){ScreenClass=t}function getAreaIntName(t){let e=0;for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);i%2==0?(e+=s<<8,e*=13,e&=32767):e+=s}return e}window.getAreaIntName=getAreaIntName;var AreaTypes={TEST_CANVAS_EDITOR:0};function setAreaTypes(t){for(let t in AreaTypes)delete AreaTypes[t];for(let e in t)AreaTypes[e]=t[e]}let areaclasses={},theWrangler;class AreaWrangler{constructor(){this.stacks=new Map,this.lasts=new Map,this.lastArea=void 0,this.stack=[],this.idgen=0,this.locked=0,this._last_screen_id=void 0,theWrangler=this}makeSafeContext(t){let e=this.copy();return new Proxy(t,{get:(t,i,s)=>(e.copyTo(contextWrangler),t[i])})}copyTo(t){for(let[e,i]of this.stacks)t.stack.set(e,list$2(i));for(let[e,i]of this.lasts)t.lasts.set(e,i);t.stack=list$2(this.stack),t.lastArea=this.lastArea}copy(t){let e=new AreaWrangler;return this.copyTo(e),e}_checkWrangler(t){return void 0===t||(void 0===this._last_screen_id?(this._last_screen_id=t.screen._id,!0):t.screen._id===this._last_screen_id||(this.reset(),this._last_screen_id=t.screen._id,console.warn("contextWrangler detected a new screen; new file?"),!1))}reset(){return theWrangler=this,this.stacks=new Map,this.lasts=new Map,this.lastArea=void 0,this.stack=[],this.locked=0,this._last_screen_id=void 0,this}static findInstance(){return theWrangler}static lock(){return this.findInstance().lock()}static unlock(){return this.findInstance().unlock()}lock(){return this.locked++,this}unlock(){return this.locked=Math.max(this.locked-1,0),this}push(t,e,i=!0){theWrangler=this,(haveModal()||this.locked)&&(i=!1),!i&&this.lasts.has(t[ClassIdSymbol])||(this.lasts.set(t[ClassIdSymbol],e),this.lastArea=e);let s=this.stacks.get(t[ClassIdSymbol]);void 0===s&&(s=[],this.stacks.set(t[ClassIdSymbol],s));let r=this.lasts.get(t[ClassIdSymbol]);s.push(r),s.push(e),this.stack.push(e)}updateLastRef(t,e){theWrangler=this,(this.locked||haveModal())&&this.lasts.has(t[ClassIdSymbol])||(this.lasts.set(t[ClassIdSymbol],e),this.lastArea=e)}pop(t,e){let i=this.stacks.get(t[ClassIdSymbol]);if(void 0!==i){if(i.length>0){i.pop();let e=i.pop();!this.locked&&e&&e.isConnected&&this.lasts.set(t[ClassIdSymbol],e)}else console.error("pop_ctx_area called in error");this.stack.length>0&&this.stack.pop()}else console.warn("pop_ctx_area called in error")}getLastArea(t){if(void 0===t)return this.stack.length>0?this.stack[this.stack.length-1]:this.lastArea;if(this.stacks.has(t[ClassIdSymbol])){let e=this.stacks.get(t[ClassIdSymbol]);if(e.length>0)return e[e.length-1]}return this.lasts.get(t[ClassIdSymbol])}}_setModalAreaClass(AreaWrangler);let contextWrangler=new AreaWrangler,dtvtmps=cachering.fromConstructor(Vector3$2,32),quad_co_rets2=cachering.fromConstructor(Vector2$b,512);function quad_bilinear(t,e,i,s,r,a){return-((t-e)*r-t-(r*t-r*e+r*i-r*s-t+s)*a)}function quad_uv_2d(t,e,i,s,r){let a,n,o=i[0]-e[0],l=i[1]-e[1],h=s[0]-e[0],c=s[1]-e[1],d=r[0]-e[0],u=r[1]-e[1],p=t[0]-e[0],m=t[1]-e[1],f=Math.sqrt,g=2*(((u+m)*p-2*d*m)*c+(d*m-u*p)*(u+m)-((d-p)*l-h*m)*(u-m))*o-2*((d*m-u*p)*(d+p)-(d-p)*c*p+((2*u-m)*p-d*m)*h)*l+(d*m-u*p+c*p-h*m)**2+(d-p)**2*l**2+(u-m)**2*o**2,_=d*m-u*p+c*p-h*m,v=2*(h-d)*l-2*(c-u)*o,b=2*(h*u-c*d+l*d)-2*o*u;if(g<0&&(console.log("A was < 0",g),g=-g,v=b=0),Math.abs(v)<1e-5){let t=o,e=l;console.log("C1 bad");let i=Math.sqrt(t*t+e*e);i>1e-6&&(t/=i*i,e/=i*i),a=n=t*p+e*m}else a=(-(_+f(g)-(u-m)*o)-(d-p)*l)/v,n=(-(_-f(g)-(u-m)*o)-(d-p)*l)/v;if(Math.abs(b)<1e-5){let t,s;t=h-o,s=c-l,console.log("C2 bad");let r=Math.sqrt(t**2+s**2);r>1e-5&&(t/=r*r,s/=r*r),e=i=p*t+m*s}else e=(-(_-f(g)+(u+m)*o)+(d+p)*l)/b,i=(-(_+f(g)+(u+m)*o)+(d+p)*l)/b;let y=quad_co_rets2.next();return(a-.5)**2+(e-.5)**2<(n-.5)**2+(i-.5)**2?(y[0]=a,y[1]=e):(y[0]=n,y[1]=i),y}const ClosestModes={CLOSEST:0,START:1,END:2,ENDPOINTS:3,ALL:4};let advs=cachering.fromConstructor(Vector4$2,128);class AbstractCurve{evaluate(t){throw new Error("implement me")}derivative(t){}curvature(t){}normal(t){}width(t){}}class ClosestCurveRets{constructor(){this.p=new Vector3$2,this.t=0}}let cvrets=cachering.fromConstructor(ClosestCurveRets,2048),cvarrays=new ArrayPool,cvtmp=new Array(1024);function closestPoint(t,e,i){let s=0;for(let t=0;t<5;t++,s+=.2){e.evaluate(s),e.evaluate(s+.2)}}let poly_normal_tmps=cachering.fromConstructor(Vector3$2,64),pncent=new Vector3$2;function normal_poly(t){if(3===t.length)return poly_normal_tmps.next().load(normal_tri(t[0],t[1],t[2]));if(4===t.length)return poly_normal_tmps.next().load(normal_quad(t[0],t[1],t[2],t[3]));if(0===t.length)return poly_normal_tmps.next().zero();let e=pncent.zero(),i=0;for(let s of t)e.add(s),i++;e.mulScalar(1/i);let s=poly_normal_tmps.next().zero();for(let i=0;i<t.length;i++){let r=normal_tri(t[i],t[(i+1)%t.length],e);s.add(r)}return s.normalize(),s}let barycentric_v2_rets=cachering.fromConstructor(Vector2$b,2048),calc_proj_refs=new cachering((()=>[0,0]),64);function dihedral_v3_sqr(t,e,i,s){let r=e[0]-t[0],a=e[1]-t[1],n=e[2]-t[2],o=i[0]-t[0],l=i[1]-t[1],h=i[2]-t[2],c=s[0]-t[0],d=s[1]-t[1],u=s[2]-t[2];return((r*h-n*o)*(o*u-h*c)+(a*h-n*l)*(l*u-h*d)+(r*l-a*o)*(o*d-l*c))**2/(((r*h-n*o)**2+(a*h-n*l)**2+(r*l-a*o)**2)*((o*u-h*c)**2+(l*u-h*d)**2+(o*d-l*c)**2))}let tet_area_tmps=cachering.fromConstructor(Vector3$2,64);function tet_volume(t,e,i,s){return t=tet_area_tmps.next().load(t),e=tet_area_tmps.next().load(e),i=tet_area_tmps.next().load(i),s=tet_area_tmps.next().load(s),t.sub(s),e.sub(s),i.sub(s),e.cross(i),t.dot(e)/6}function calc_projection_axes(t){let e=Math.abs(t[0]),i=Math.abs(t[1]),s=Math.abs(t[2]),r=calc_proj_refs.next();return e>i&&e>s?(r[0]=1,r[1]=2):i>s&&i>e?(r[0]=0,r[1]=2):(r[0]=0,r[1]=1),r}let _avtmps=cachering.fromConstructor(Vector3$2,128);function inrect_3d(t,e,i){let s=t[0]>=e[0]&&t[0]<=i[0];return s=s&&t[1]>=e[1]&&t[1]<=i[1],s=s&&t[2]>=e[2]&&t[2]<=i[2],s}function aabb_isect_line_3d(t,e,i,s){let r=inrect_3d(t,i,s);if(r=r||inrect_3d(e,i,s),r)return!0;let a=closest_point_on_line(_avtmps.next().load(i).interp(s,.5),t,e,!0);return!!a&&(a=a[0],inrect_3d(a,i,s))}function aabb_isect_cylinder_3d(t,e,i,s,r){let a=inrect_3d(t,s,r);if(a=a||inrect_3d(e,s,r),a)return!0;let n=_avtmps.next().load(s).interp(r,.5),o=closest_point_on_line(n,t,e,!0);if(!o)return!1;o=o[0];let l=_avtmps.next().load(r).sub(s);return l.mulScalar(.5),l.addScalar(i),o.sub(n).abs(),o[0]<=l[0]&&o[1]<=l[1]&&o[2]<=l[2]}function barycentric_v2(t,e,i,s,r=0,a=1,n){let o=i[r]*s[a]-i[a]*s[r]+(i[a]-s[a])*e[r]-(i[r]-s[r])*e[a];Math.abs(o)<1e-6&&(o=1e-5);let l=(i[r]*s[a]-i[a]*s[r]+(i[a]-s[a])*t[r]-(i[r]-s[r])*t[a])/o,h=(-(e[r]*s[a]-e[a]*s[r]+(e[a]-s[a])*t[r])+(e[r]-s[r])*t[a])/o;return n||(n=barycentric_v2_rets.next()),n[0]=l,n[1]=h,n}function _linedis2(t,e,i){let s=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2],n=i[0]-t[0],o=i[1]-t[1],l=i[2]-t[2];return(((r-o)*r+(a-l)*a+(s-n)*s)*(r-o)-r)**2+(((r-o)*r+(a-l)*a+(s-n)*s)*(a-l)-a)**2+(((r-o)*r+(a-l)*a+(s-n)*s)*(s-n)-s)**2}let closest_p_tri_rets=new cachering((()=>({co:new Vector3$2,uv:new Vector2$b,dist:0})),512),cpt_v1=new Vector3$2,cpt_v2=new Vector3$2,cpt_v3=new Vector3$2,cpt_v4=new Vector3$2,cpt_v5=new Vector3$2,cpt_v6=new Vector3$2,cpt_p=new Vector3$2,cpt_n=new Vector3$2,cpt_mat=new Matrix4$2,cpt_mat2=new Matrix4$2,cpt_b=new Vector3$2;function closest_point_on_quad(t,e,i,s,r,a,n){let o=closest_point_on_tri(t,e,i,s,a,n),l=closest_point_on_tri(t,e,s,r,a,n);return o.dist<=l.dist?o:l}function closest_point_on_tri(t,e,i,s,r,a){let n,o,l=t;a&&(a[0]=a[1]=0,a.length>2&&(a[2]=0)),e=cpt_v1.load(e),i=cpt_v2.load(i),s=cpt_v3.load(s),t=cpt_p.load(t),void 0===r&&(r=cpt_n.load(normal_tri(e,i,s))),e.sub(t),i.sub(t),s.sub(t),t.zero();let h,c=Math.abs(r[0]),d=Math.abs(r[1]),u=Math.abs(r[2]);if(0===c&&0===d&&0===u){console.log("eek1",r,e,i,s);let t=closest_p_tri_rets.next();return t.dist=1e17,t.co.zero(),t.uv.zero(),t}c>=d&&c>=u?(n=1,o=2,h=0):d>=c&&d>=u?(n=0,o=2,h=1):(n=0,o=1,h=2);let p=cpt_mat,m=cpt_mat2;p.makeIdentity();let f=p.$matrix;f.m11=e[n],f.m12=i[n],f.m13=s[n],f.m14=0,f.m21=e[o],f.m22=i[o],f.m23=s[o],f.m24=0,f.m31=1,f.m32=1,f.m33=1,f.m34=0,p.transpose();let g=cpt_b.zero();if(g[0]=t[n],g[1]=t[o],g[2]=1,g[3]=0,m.load(p).transpose(),p.preMultiply(m),null===p.invert()){console.log("eek2",p.determinant(),n,o,r);let t=closest_p_tri_rets.next();return t.dist=1e17,t.co.zero(),t.uv.zero(),t}p.multiply(m),g.multVecMatrix(p);let _=g[0],v=g[1],b=g[2];for(let t=0;t<1;t++){_=Math.min(Math.max(_,0),1),v=Math.min(Math.max(v,0),1),b=Math.min(Math.max(b,0),1);let t=_+v+b;0!==t&&(t=1/t,_*=t,v*=t,b*=t)}a&&(a[0]=_,a[1]=v,a.length>2&&(a[2]=b));let y=e[0]*_+i[0]*v+s[0]*b,S=e[1]*_+i[1]*v+s[1]*b,x=e[2]*_+i[2]*v+s[2]*b,T=closest_p_tri_rets.next();return T.co.loadXYZ(y,S,x),T.uv[0]=_,T.uv[1]=v,T.dist=T.co.vectorLength(),T.co.add(l),T}function dist_to_tri_v3_old(t,e,i,s,r){r||(r=dtvtmps.next().load(normal_tri(e,i,s)));let a=dtvtmps.next().load(t);a.sub(e);let n=-a.dot(r),[o,l]=calc_projection_axes(r),h=dtvtmps.next(),c=dtvtmps.next(),d=dtvtmps.next();h[0]=e[o],h[1]=e[l],h[2]=0,c[0]=i[o],c[1]=i[l],c[2]=0,d[0]=s[o],d[1]=s[l],d[2]=0;let u=dtvtmps.next();u[0]=t[o],u[1]=t[l],u[2]=0;let p=1e17;let m=dtvtmps.next(),f=dtvtmps.next();function g(t,e,i){m.load(t).sub(e),f.load(i).sub(e).normalize();let s=m.dot(f);return s=Math.min(Math.max(s,0),e.vectorDistance(i)),f.mulScalar(s).add(e),f.vectorDistance(t)}return point_in_tri(u,h,c,d)?Math.abs(n):(p=Math.min(p,g(t,e,i)),p=Math.min(p,g(t,i,s)),p=Math.min(p,g(t,s,e)),p)}function dist_to_tri_v3(t,e,i,s,r){return dist_to_tri_v3_old(t,e,i,s,r)}let _dt3s_n=new Vector3$2;function dist_to_tri_v3_sqr(t,e,i,s,r){let a,n,o;void 0===r&&(r=_dt3s_n).load(normal_tri(e,i,s));let l=r[0]<0?-r[0]:r[0],h=r[1]<0?-r[1]:r[1],c=r[2]<0?-r[2]:r[2];const d=1e-7;l>h&&l>c?(a=1,n=2,o=0):h>l&&h>c?(a=0,n=2,o=1):(a=0,n=1,o=2);let u=(t[0]-e[0])*r[0]+(t[1]-e[1])*r[1]+(t[2]-e[2])*r[2];u=u<0?-u:u;let p=e[a],m=e[n],f=e[o],g=i[a]-p,_=i[n]-m,v=i[o]-f,b=s[a]-p,y=s[n]-m,S=s[o]-f,x=g*g,T=_*_,w=b*b,k=y*y,P=t[a]-p,C=t[n]-m,E=t[o]-f;Math.sqrt(g**2+_**2),Math.sqrt((b-g)**2+(y-_)**2),Math.sqrt(b**2+y**2);let A=P*_-C*g<0,M=(P-g)*(y-_)-(C-_)*(b-g)<0,$=P*-y+C*b<0;r[o]<0&&(A=!A,M=!M,$=!$);let I,D,B,O,R=1&A|M<<1|$<<2;if(0===R||7===R)return u*u;let U,N,F,L=0;switch(U=g,N=_,F=v,l=r[a],h=r[n],c=r[o],R){case 1:O=x+T,O>d?(I=g*C-_*P,I=I*I/O,U=-_,N=g,F=v):(I=P*P+C*C,U=P,N=C,F=E),L=I;break;case 3:return U=P-g,N=C-_,F=E-v,L=U*U+N*N,U*U+N*N+F*F;case 2:O=(g-b)**2+(_-y)**2,O>d?(D=(g-b)*C-(_-y)*P,D/=O,U=_-y,N=b-g,F=S-v):(D=(P-g)*(P-g)+(C-_)*(C-_),U=P-g,N=C-_,F=E-v),L=D;break;case 6:return U=P-b,N=C-y,F=E-S,U*U+N*N+F*F;case 4:O=w+k,O>d?(B=b*C-y*P,B=B*B/O,U=y,N=-b,F=S):(B=(P-b)*(P-b)+(C-y)*(C-y),U=P-b,N=C-y,F=E-S),L=B;break;case 5:return U=P,N=C,F=E,U*U+N*N+F*F}{let t=U*l+N*h+F*c;t=-t,U+=l*t,N+=h*t,F+=c*t}let V=((U**2+N**2)*c**2+(U*l+N*h)**2)/((U**2+N**2)*c**2);return Math.random()>.999&&console.log(V.toFixed(4)),L*V+u*u}let tri_area_temps=cachering.fromConstructor(Vector3$2,64);function tri_area(t,e,i){let s=t.vectorDistance(e),r=e.vectorDistance(i),a=i.vectorDistance(t),n=(s+r+a)/2;return n=n*(n-s)*(n-r)*(n-a),n=Math.max(n,0),Math.sqrt(n)}function aabb_overlap_area(t,e,i,s){let r=0,a=0;for(let n=0;n<2;n++){let o=t[n],l=i[n],h=t[n]+e[n],c=i[n]+s[n];if(h>=l&&c>=o){let t=Math.abs(l-h);t=Math.min(t,Math.abs(o-c)),n?a=t:r=t}}return r*a}function aabb_isect_2d(t,e,i,s){let r=0;for(let a=0;a<2;a++){let n=t[a],o=t[a]+e[a],l=i[a],h=i[a]+s[a];o>=l&&n<=h&&(r+=1)}return 2===r}function aabb_isect_3d(t,e,i,s){let r=0;for(let a=0;a<3;a++){let n=t[a],o=t[a]+e[a],l=i[a],h=i[a]+s[a];o>=l&&n<=h&&(r+=1)}return 3===r}let aabb_intersect_vs=cachering.fromConstructor(Vector2$b,32),aabb_intersect_rets=new cachering((()=>({pos:new Vector2$b,size:new Vector2$b})),512);function aabb_intersect_2d(t,e,i,s){let r=aabb_intersect_vs.next().load(t),a=aabb_intersect_vs.next().load(t).add(e),n=aabb_intersect_vs.next().load(i),o=aabb_intersect_vs.next().load(i).add(s),l=aabb_intersect_vs.next().zero(),h=aabb_intersect_vs.next().zero(),c=0;for(let t=0;t<2;t++)a[t]>=n[t]&&r[t]<=o[t]&&(c++,l[t]=Math.max(n[t],r[t]),h[t]=Math.min(a[t],o[t]));if(2!==c)return;let d=aabb_intersect_rets.next();return d.pos.load(l),d.size.load(h).sub(l),d}window.test_aabb_intersect_2d=function(){let t=document.getElementById("test_canvas");t||(t=document.createElement("canvas"),t.setAttribute("id","test_canvas"),t.g=t.getContext("2d"),document.body.appendChild(t)),t.width=~~(window.innerWidth*devicePixelRatio),t.height=~~(window.innerHeight*devicePixelRatio),t.style.width=t.width/devicePixelRatio+"px",t.style.height=t.height/devicePixelRatio+"px",t.style.position="absolute",t.style["z-index"]="1000";let e=t.g;e.clearRect(0,0,t.width,t.height);let i=800,s=new Vector2$b([Math.random()*i,Math.random()*i]).floor(),r=new Vector2$b([Math.random()*i,Math.random()*i]).floor(),a=new Vector2$b([Math.random()*i,Math.random()*i]).floor(),n=new Vector2$b([Math.random()*i,Math.random()*i]).floor(),o=new Vector2$b,l=new Vector2$b,h=new Vector2$b,c=new Vector2$b;o.load(s).min(r),l.load(s).max(r),h.load(a).min(n),c.load(a).max(n),l.sub(o),c.sub(o),console.log(o,l),console.log(h,c),e.beginPath(),e.rect(0,0,t.width,t.height),e.fillStyle="white",e.fill(),e.beginPath(),e.rect(o[0],o[1],l[0],l[1]),e.fillStyle="rgba(255, 100, 75, 1.0)",e.fill(),e.beginPath(),e.rect(h[0],h[1],c[0],c[1]),e.fillStyle="rgba(75, 100, 255, 1.0)",e.fill();let d=aabb_intersect_2d(o,l,h,c);return d&&(e.beginPath(),e.rect(d.pos[0],d.pos[1],d.size[0],d.size[1]),e.fillStyle="rgba(0, 0, 0, 1.0)",e.fill()),{end:test_aabb_intersect_2d.end,timer:test_aabb_intersect_2d.timer}},test_aabb_intersect_2d.stop=function(){test_aabb_intersect_2d._timer&&(console.log("stopping timer"),window.clearInterval(test_aabb_intersect_2d._timer),test_aabb_intersect_2d._timer=void 0)},test_aabb_intersect_2d.end=function(){test_aabb_intersect_2d.stop();let t=document.getElementById("test_canvas");t&&t.remove()},test_aabb_intersect_2d.timer=function(t=500){if(test_aabb_intersect_2d._timer)return window.clearInterval(test_aabb_intersect_2d._timer),test_aabb_intersect_2d._timer=void 0,void console.log("stopping timer");console.log("starting timer"),test_aabb_intersect_2d._timer=window.setInterval((()=>{test_aabb_intersect_2d()}),t)};let aabb_intersect_vs3=cachering.fromConstructor(Vector3$2,64);function aabb_intersect_3d(t,e,i,s){let r=0;for(let a=0;a<2;a++)e[a]>=i[a]&&t[a]<=s[a]&&r++;return 3===r}function aabb_union(t,e){for(let i=0;i<2;i++)for(let s=0;s<t[i].length;s++)t[i][s]=i?Math.max(t[i][s],e[i][s]):Math.min(t[i][s],e[i][s]);return t}function aabb_union_2d(t,e,i,s){let r=aabb_intersect_vs.next(),a=aabb_intersect_vs.next(),n=aabb_intersect_vs.next(),o=aabb_intersect_vs.next();r.load(t).add(e),a.load(i).add(s),n.load(r).min(a),o.load(r).max(a),o.sub(n);let l=aabb_intersect_rets.next();return l.pos.load(n),l.pos.load(o),l}function init_prototype(t,e){for(let i in e)t.prototype[i]=e[i];return t.prototype}function inherit(t,e,i){t.prototype=Object.create(e.prototype);for(let e in i)t.prototype[e]=i[e];return t.prototype}let set$1=set$2,$_mh,$_swapt;const feps=222e-18,COLINEAR=1,LINECROSS=2,COLINEAR_ISECT=3;let _cross_vec1=new Vector3$2,_cross_vec2=new Vector3$2;const SQRT2=Math.sqrt(2),FEPS_DATA={F16:111e-18,F32:5.96e-8,F64:488e-6},FEPS=FEPS_DATA.F32,FLOAT_MIN=-1e21,FLOAT_MAX=1e22,Matrix4UI=Matrix4$2;let _static_grp_points4=new Array(4),_static_grp_points8=new Array(8);function get_rect_points(t,e){let i;if(2===t.length)i=_static_grp_points4,i[0]=t,i[1]=[t[0]+e[0],t[1]],i[2]=[t[0]+e[0],t[1]+e[1]],i[3]=[t[0],t[1]+e[1]];else{if(3!==t.length)throw"get_rect_points has no implementation for "+t.length+"-dimensional data";i=_static_grp_points8,i[0]=t,i[1]=[t[0]+e[0],t[1],t[2]],i[2]=[t[0]+e[0],t[1]+e[1],t[2]],i[3]=[t[0],t[1]+e[0],t[2]],i[4]=[t[0],t[1],t[2]+e[2]],i[5]=[t[0]+e[0],t[1],t[2]+e[2]],i[6]=[t[0]+e[0],t[1]+e[1],t[2]+e[2]],i[7]=[t[0],t[1]+e[0],t[2]+e[2]]}return i}function get_rect_lines(t,e){let i=get_rect_points(t,e);if(2===t.length)return[[i[0],i[1]],[i[1],i[2]],[i[2],i[3]],[i[3],i[0]]];if(3===t.length){let t=[[i[0],i[1]],[i[1],i[2]],[i[2],i[3]],[i[3],i[0]]],e=[[i[4],i[5]],[i[5],i[6]],[i[6],i[7]],[i[7],i[4]]];return t.concat(e),t.push([i[0],i[4]]),t.push([i[1],i[5]]),t.push([i[2],i[6]]),t.push([i[3],i[7]]),t}throw"get_rect_points has no implementation for "+t.length+"-dimensional data"}let $vs_simple_tri_aabb_isect=[0,0,0];function simple_tri_aabb_isect(t,e,i,s,r){$vs_simple_tri_aabb_isect[0]=t,$vs_simple_tri_aabb_isect[1]=e,$vs_simple_tri_aabb_isect[2]=i;for(let t=0;t<3;t++){let e=!0;for(let i=0;i<3;i++)($vs_simple_tri_aabb_isect[i][t]<s[t]||$vs_simple_tri_aabb_isect[i][t]>=r[t])&&(e=!1);if(e)return!0}return!1}class MinMax{constructor(t){if(void 0===t&&(t=1),this.totaxis=t,1!==t){let e;switch(t){case 2:e=Vector2$b;break;case 3:e=Vector3$2;break;case 4:e=Vector4$2;break;default:e=Array}this._min=new e(t),this._max=new e(t),this.min=new e(t),this.max=new e(t)}else this.min=this.max=0,this._min=FLOAT_MAX,this._max=FLOAT_MIN;this.reset(),this._static_mr_co=new Array(this.totaxis),this._static_mr_cs=new Array(this.totaxis*this.totaxis)}static fromSTRUCT(t){let e=new MinMax;return t(e),e}load(t){1===this.totaxis?(this.min=t.min,this.max=t.max,this._min=t.min,this._max=t.max):(this.min=new Vector3$2(t.min),this.max=new Vector3$2(t.max),this._min=new Vector3$2(t._min),this._max=new Vector3$2(t._max))}reset(){let t=this.totaxis;if(1===t)this.min=this.max=0,this._min=FLOAT_MAX,this._max=FLOAT_MIN;else for(let e=0;e<t;e++)this._min[e]=FLOAT_MAX,this._max[e]=FLOAT_MIN,this.min[e]=0,this.max[e]=0}minmax_rect(t,e){let i=this.totaxis,s=this._static_mr_cs;if(2===i)s[0]=t,s[1]=[t[0]+e[0],t[1]],s[2]=[t[0]+e[0],t[1]+e[1]],s[3]=[t[0],t[1]+e[1]];else{if(!(i=3))throw"Minmax.minmax_rect has no implementation for "+i+"-dimensional data";s[0]=t,s[1]=[t[0]+e[0],t[1],t[2]],s[2]=[t[0]+e[0],t[1]+e[1],t[2]],s[3]=[t[0],t[1]+e[0],t[2]],s[4]=[t[0],t[1],t[2]+e[2]],s[5]=[t[0]+e[0],t[1],t[2]+e[2]],s[6]=[t[0]+e[0],t[1]+e[1],t[2]+e[2]],s[7]=[t[0],t[1]+e[0],t[2]+e[2]]}for(let t=0;t<s.length;t++)this.minmax(s[t])}minmax(t){let e=this.totaxis;if(1===e)this._min=this.min=Math.min(this._min,t),this._max=this.max=Math.max(this._max,t);else if(2===e)this._min[0]=this.min[0]=Math.min(this._min[0],t[0]),this._min[1]=this.min[1]=Math.min(this._min[1],t[1]),this._max[0]=this.max[0]=Math.max(this._max[0],t[0]),this._max[1]=this.max[1]=Math.max(this._max[1],t[1]);else if(3===e)this._min[0]=this.min[0]=Math.min(this._min[0],t[0]),this._min[1]=this.min[1]=Math.min(this._min[1],t[1]),this._min[2]=this.min[2]=Math.min(this._min[2],t[2]),this._max[0]=this.max[0]=Math.max(this._max[0],t[0]),this._max[1]=this.max[1]=Math.max(this._max[1],t[1]),this._max[2]=this.max[2]=Math.max(this._max[2],t[2]);else for(let i=0;i<e;i++)this._min[i]=this.min[i]=Math.min(this._min[i],t[i]),this._max[i]=this.max[i]=Math.max(this._max[i],t[i])}}function winding_axis(t,e,i,s){let r=(s+1)%3,a=(s+2)%3,n=t[r],o=t[a],l=e[r],h=e[a],c=i[r];return(n-l)*(i[a]-h)-(o-h)*(c-l)>=0}function winding(t,e,i,s=!1,r=0){let a=e[0]-t[0],n=e[1]-t[1],o=i[0]-t[0];return a*(i[1]-t[1])-n*o>r}function inrect_2d(t,e,i){return void 0===t||void 0===e||void 0===i?(console.trace(),console.log("Bad paramters to inrect_2d()"),console.log("p: ",t,", pos: ",e,", size: ",i),!1):t[0]>=e[0]&&t[0]<=e[0]+i[0]&&t[1]>=e[1]&&t[1]<=e[1]+i[1]}MinMax.STRUCT="\n  math.MinMax {\n    min     : vec3;\n    max     : vec3;\n    _min    : vec3;\n    _max    : vec3;\n    totaxis : int;\n  }\n";let $ps_aabb_isect_line_2d=[new Vector2$b,new Vector2$b,new Vector2$b,new Vector2$b];function aabb_isect_line_2d(t,e,i,s){if(point_in_aabb_2d(t,i,s)||point_in_aabb(e,i,s))return!0;let r=$ps_aabb_isect_line_2d;r[0][0]=i[0],r[0][1]=i[1],r[1][0]=i[0],r[1][1]=s[1],r[2][0]=s[0],r[2][1]=s[1],r[3][0]=s[0],r[3][1]=i[1];for(let i=0;i<4;i++)if(line_line_cross(t,e,r[i],r[(i+1)%4]))return!0;return!1}function expand_rect2d(t,e,i){t[0]-=Math.floor(i[0]),t[1]-=Math.floor(i[1]),e[0]+=Math.floor(2*i[0]),e[1]+=Math.floor(2*i[1])}function expand_line(t,e){let i=new Vector3$2;i.add(t[0]),i.add(t[1]),i.mulScalar(.5),t[0].sub(i),t[1].sub(i);let s=t[0].vectorLength(),r=t[1].vectorLength();return t[0].normalize(),t[1].normalize(),t[0].mulScalar(e+s),t[1].mulScalar(e+r),t[0].add(i),t[1].add(i),t}function colinear(t,e,i,s=22e-17,r=1e-5**2){let a=_cross_vec1,n=_cross_vec2,o=t.length;for(let s=0;s<o;s++)a[s]=e[s]-t[s],n[s]=i[s]-t[s];for(let t=o;t<3;t++)a[t]=n[t]=0;return a.dot(a)<=r||n.dot(n)<=r||(a.normalize(),n.normalize(),a.cross(n),a.dot(a)<=s)}function colinear2d(t,e,i,s=1e-5,r=!1){let a=t[0]-e[0],n=t[1]-e[1],o=i[0]-e[0],l=i[1]-e[1],h=Math.abs(a*l-n*o);if(r){let t=(a**2+n**2)**.5+(o**2+l**2)**.5;if(t<=1e-5)return!0;h/=t}return h<=s}let _llc_l1=[new Vector3$2,new Vector3$2],_llc_l2=[new Vector3$2,new Vector3$2],_llc_l3=[new Vector3$2,new Vector3$2],_llc_l4=[new Vector3$2,new Vector3$2],lli_v1=new Vector3$2,lli_v2=new Vector3$2,lli_v3=new Vector3$2,lli_v4=new Vector3$2,_zero_cn=new Vector3$2,_tmps_cn=cachering.fromConstructor(Vector3$2,64),_rets_cn=cachering.fromConstructor(Vector3$2,64);function corner_normal(t,e,i){let s=_rets_cn.next().zero(),r=_tmps_cn.next().zero();if(r.load(t).add(e).normalize(),Math.abs(t.normalizedDot(e))>.9999)return t.dot(e)>1e-4?s.load(t).add(e).normalize():s.load(t).normalize(),s.mulScalar(i),s;t=_tmps_cn.next().load(t).mulScalar(i),e=_tmps_cn.next().load(e).mulScalar(i);let a=_tmps_cn.next().load(t),n=_tmps_cn.next().load(e);t.addFac(t,.01),e.addFac(e,.01);a[0]+=1*t[1],a[1]+=1*-t[0],n[0]+=1*-e[1],n[1]+=1*e[0];let o=line_line_isect(t,a,e,n,!1);return void 0===o||o===COLINEAR_ISECT||o.dot(o)<1e-6?s.load(t).add(e).normalize().mulScalar(i):(s.load(o),r.dot(r)>0&&r.dot(s)<0&&s.load(r).mulScalar(i)),s}function line_line_isect(t,e,i,s,r=!0){if(r&&!line_line_cross(t,e,i,s))return;let a=t[0],n=e[0],o=t[1],l=e[1],h=i[0],c=s[0],d=i[1],u=s[1],p=(a-n)*(d-u)-(h-c)*(o-l);if(Math.abs(p)<1e-8)return COLINEAR_ISECT;{let i=-((o-u)*h-(d-u)*a-(o-d)*c)/p;return lli_v1.load(t).interp(e,i)}}function line_line_cross(t,e,i,s){let r=winding(t,e,i),a=winding(i,t,s),n=winding(t,e,s),o=winding(i,e,s);return r===a&&n===o&&r!==n}let _asi_v1=new Vector3$2,_asi_v2=new Vector3$2,_asi_v3=new Vector3$2,_asi_v4=new Vector3$2,_asi_v5=new Vector3$2,_asi_v6=new Vector3$2;function point_in_aabb_2d(t,e,i){return t[0]>=e[0]&&t[0]<=i[0]&&t[1]>=e[1]&&t[1]<=i[1]}let _asi2d_v1=new Vector2$b,_asi2d_v2=new Vector2$b,_asi2d_v3=new Vector2$b,_asi2d_v4=new Vector2$b,_asi2d_v5=new Vector2$b,_asi2d_v6=new Vector2$b;function aabb_sphere_isect_2d(t,e,i,s){let r=_asi2d_v1,a=_asi2d_v2,n=_asi2d_v3,o=_asi2d_v4;t=_asi2d_v6.load(t),r.load(t),a.load(t),i=_asi_v5.load(i),s=_asi_v6.load(s),o.load(s).sub(i).normalize().mulScalar(e+1e-4),r.sub(o),a.add(o),n.load(t);let l=point_in_aabb_2d(r,i,s)||point_in_aabb_2d(a,i,s)||point_in_aabb_2d(n,i,s);return l||(r.load(i),a[0]=i[0],a[1]=s[1],l=l||dist_to_line_2d(t,r,a)<e,r.load(s),a[0]=s[0],a[1]=s[1],l=l||dist_to_line_2d(t,r,a)<e,r.load(s),a[0]=s[0],a[1]=i[1],l=l||dist_to_line_2d(t,r,a)<e,r.load(s),a[0]=i[0],a[1]=i[1],l=l||dist_to_line_2d(t,r,a)<e,l)}function point_in_aabb(t,e,i){return t[0]>=e[0]&&t[0]<=i[0]&&t[1]>=e[1]&&t[1]<=i[1]&&t[2]>=e[2]&&t[2]<=i[2]}let asi_rect=new Array(8);for(let t=0;t<8;t++)asi_rect[t]=new Vector3$2;let aabb_sphere_isect_vs=cachering.fromConstructor(Vector3$2,64);function aabb_sphere_isect(t,e,i,s){{let e=aabb_sphere_isect_vs.next().load(t),r=aabb_sphere_isect_vs.next().load(i),a=aabb_sphere_isect_vs.next().load(s);2===t.length&&(e[2]=0),2===r.length&&(r[2]=0),2===s.length&&(a[2]=0),t=e,i=r,s=a}let r=aabb_sphere_isect_vs.next().load(i).interp(s,.5);if(t.sub(r),i.sub(r),s.sub(r),e*=e,point_in_aabb(t,i,s))return!0;let a=asi_rect;a[0].loadXYZ(i[0],i[1],i[2]),a[1].loadXYZ(i[0],s[1],i[2]),a[2].loadXYZ(s[0],s[1],i[2]),a[3].loadXYZ(s[0],i[1],i[2]),a[4].loadXYZ(i[0],i[1],s[2]),a[5].loadXYZ(i[0],s[1],s[2]),a[6].loadXYZ(s[0],s[1],s[2]),a[7].loadXYZ(s[0],i[1],s[2]);for(let i=0;i<8;i++)if(t.vectorDistanceSqr(a[i])<e)return!0;let n=aabb_sphere_isect_vs.next().load(t);for(let r=0;r<3;r++){n.load(t);let a=(r+1)%3,o=(r+2)%3;if(n[r]=n[r]<0?i[r]:s[r],n[a]=Math.min(Math.max(n[a],i[a]),s[a]),n[o]=Math.min(Math.max(n[o],i[o]),s[o]),n.vectorDistanceSqr(t)<=e)return!0}return!1}function aabb_sphere_dist(t,e,i){{let s=aabb_sphere_isect_vs.next().load(t),r=aabb_sphere_isect_vs.next().load(e),a=aabb_sphere_isect_vs.next().load(i);2===t.length&&(s[2]=0),2===r.length&&(r[2]=0),2===i.length&&(a[2]=0),t=s,e=r,i=a}let s=aabb_sphere_isect_vs.next().load(e).interp(i,.5);if(t.sub(s),e.sub(s),i.sub(s),point_in_aabb(t,e,i))return 0;let r,a=asi_rect;a[0].loadXYZ(e[0],e[1],e[2]),a[1].loadXYZ(e[0],i[1],e[2]),a[2].loadXYZ(i[0],i[1],e[2]),a[3].loadXYZ(i[0],e[1],e[2]),a[4].loadXYZ(e[0],e[1],i[2]),a[5].loadXYZ(e[0],i[1],i[2]),a[6].loadXYZ(i[0],i[1],i[2]),a[7].loadXYZ(i[0],e[1],i[2]);for(let e=0;e<8;e++){let i=t.vectorDistanceSqr(a[e]);(void 0===r||i<r)&&(r=i)}let n=aabb_sphere_isect_vs.next().load(t);for(let s=0;s<3;s++){n.load(t);let a=(s+1)%3,o=(s+2)%3;n[s]=n[s]<0?e[s]:i[s],n[a]=Math.min(Math.max(n[a],e[a]),i[a]),n[o]=Math.min(Math.max(n[o],e[o]),i[o]);let l=n.vectorDistanceSqr(t);(void 0===r||l<r)&&(r=l)}return void 0===r?1e17:r}function point_in_tri(t,e,i,s){let r=winding(t,e,i),a=winding(t,i,s),n=winding(t,s,e);return r===a&&a===n}function convex_quad(t,e,i,s){return line_line_cross([t,i],[e,s])}let $e1_normal_tri=new Vector3$2,$e3_normal_tri=new Vector3$2,$e2_normal_tri=new Vector3$2;function isNum(t){let e="number"==typeof t;return e=e&&!isNaN(t)&&isFinite(t),e}const _normal_tri_rets=cachering.fromConstructor(Vector3$2,64);function normal_tri(t,e,i){let s,r,a,n=e[0]-t[0],o=e[1]-t[1],l=e[2]-t[2],h=i[0]-t[0],c=i[1]-t[1],d=i[2]-t[2];if(!isNum(n+o+l+d+c+d))throw new Error("NaN in normal_tri");n=e[0]-t[0],o=e[1]-t[1],l=e[2]-t[2],h=i[0]-t[0],c=i[1]-t[1],d=i[2]-t[2],s=o*d-l*c,r=l*h-n*d,a=n*c-o*h;let u=Math.sqrt(s*s+r*r+a*a);u>1e-5&&(u=1/u),s*=u,r*=u,a*=u;let p=_normal_tri_rets.next();if(!isNum(s+r+a))throw new Error("NaN!");return p[0]=s,p[1]=r,p[2]=a,p}let $n2_normal_quad=new Vector3$2,_q1=new Vector3$2,_q2=new Vector3$2,_q3=new Vector3$2;function normal_quad(t,e,i,s){return _q1.load(normal_tri(t,e,i)),_q2.load(normal_tri(e,i,s)),_q1.add(_q2).normalize(),_q1}function normal_quad_old(t,e,i,s){let r=normal_tri(t,e,i);$n2_normal_quad[0]=r[0],$n2_normal_quad[1]=r[1],$n2_normal_quad[2]=r[2],r=normal_tri(t,i,s),$n2_normal_quad[0]=$n2_normal_quad[0]+r[0],$n2_normal_quad[1]=$n2_normal_quad[1]+r[1],$n2_normal_quad[2]=$n2_normal_quad[2]+r[2];let a=Math.sqrt($n2_normal_quad[0]*$n2_normal_quad[0]+$n2_normal_quad[1]*$n2_normal_quad[1]+$n2_normal_quad[2]*$n2_normal_quad[2]);return a>1e-5&&(a=1/a),$n2_normal_quad[0]*=a,$n2_normal_quad[1]*=a,$n2_normal_quad[2]*=a,$n2_normal_quad}let _li_vi=new Vector3$2;function line_isect(t,e,i,s,r){void 0===r&&(r=!1);let a=(e[0]-t[0])*(s[1]-i[1])-(e[1]-t[1])*(s[0]-i[0]);if(0===a)return[new Vector3$2,COLINEAR,0];let n=_li_vi;if(n[0]=0,n[1]=0,n[2]=0,n[0]=((i[0]-s[0])*(t[0]*e[1]-t[1]*e[0])-(t[0]-e[0])*(i[0]*s[1]-i[1]*s[0]))/a,n[1]=((i[1]-s[1])*(t[0]*e[1]-t[1]*e[0])-(t[1]-e[1])*(i[0]*s[1]-i[1]*s[0]))/a,r||3===t.length){let i=new Vector2$b(e).sub(t),s=new Vector2$b(n).sub(t),r=s.vectorLength()/i.vectorLength();return i.normalize(),s.normalize(),i.dot(s)<0&&(r=-r),3===t.length&&(n[2]=t[2]+(e[2]-t[2])*r),[n,LINECROSS,r]}return[n,LINECROSS]}let dt2l_v1=new Vector2$b,dt2l_v2=new Vector2$b,dt2l_v3=new Vector2$b,dt2l_v4=new Vector2$b,dt2l_v5=new Vector2$b;function dist_to_line_2d(t,e,i,s=!0,r,a){e=dt2l_v4.load(e),i=dt2l_v5.load(i);let n=dt2l_v1,o=dt2l_v3;n.load(i).sub(e).normalize(),o.load(t).sub(e);let l=o.dot(n);return s&&(l=Math.min(Math.max(l,0),e.vectorDistance(i))),n.mulScalar(l).add(e),r&&(r[0]=n[0],r[1]=n[1]),void 0!==a&&(a=l),n.vectorDistance(t)}let dt3l_v1=new Vector3$2,dt3l_v2=new Vector3$2,dt3l_v3=new Vector3$2,dt3l_v4=new Vector3$2,dt3l_v5=new Vector3$2;function dist_to_line_sqr(t,e,i,s=!0){let r=t[0]-e[0],a=t[1]-e[1],n=t.length<3?0:t[2]-e[2];n=void 0===n?0:n;let o=i[0]-e[0],l=i[1]-e[1],h=i.length<3?0:i[2]-e[2],c=o*o+l*l+h*h;if(0===c)return Math.sqrt(r*r+a*a+n*n);let d=1/c;o*=d,l*=d,h*=d;let u=r*o+a*l+n*h;return s&&(u=Math.min(Math.max(u,0),c)),o*=u,l*=u,h*=u,(o-r)*(o-r)+(l-a)*(l-a)+(h-n)*(h-n)}function dist_to_line(t,e,i,s=!0){return Math.sqrt(dist_to_line_sqr(t,e,i,s))}let _cplw_vs4=cachering.fromConstructor(Vector4$2,64),_cplw_vs3=cachering.fromConstructor(Vector3$2,64),_cplw_vs2=cachering.fromConstructor(Vector2$b,64);function wclip(t,e,i,s,r){let a=(i-s)*r-(t-e);return 0===a?0:(r*i-t)/a}function clip(t,e,i){return t-e==0?0:(t-i)/(t-e)}function clip_line_w(t,e,i,s){let r=_cplw_vs4.next().load(t),a=_cplw_vs4.next().load(e);if(r[2]<1&&a[2]<1)return!1;function n(t,e,i){if(t[i]/t[3]<-1){let s=wclip(t[i],e[i],t[3],e[3],-1);t.interp(e,s)}else if(t[i]/t[3]>1){let s=wclip(t[i],e[i],t[3],e[3],1);t.interp(e,s)}}function o(t,e,i){n(t,e,i),n(e,t,i)}!function(t,e){if(t[2]<1){let i=clip(t[2],e[2],1);t.interp(e,i)}else if(e[2]<1){let i=clip(e[2],t[2],1);e.interp(t,i)}}(r,a),o(r,a,0),o(r,a,1);for(let i=0;i<4;i++)t[i]=r[i],e[i]=a[i];return!(r[0]/r[3]==a[0]/a[3]||r[1]/a[3]==a[1]/a[3])}let _closest_point_on_line_cache=cachering.fromConstructor(Vector3$2,64),_closest_point_rets=new cachering((function(){return[0,0]}),64),_closest_tmps=[new Vector3$2,new Vector3$2,new Vector3$2];function closest_point_on_line(t,e,i,s=!0){let r,a=_closest_tmps[0],n=_closest_tmps[1];a.load(i).sub(e),s&&(r=a.vectorLength()),a.normalize(),n.load(t).sub(e);let o=n.dot(a);s&&(o=o<0?0:o,o=o>r?r:o);let l=_closest_point_on_line_cache.next();l.load(a).mulScalar(o).add(e);let h=_closest_point_rets.next();return h[0]=l,h[1]=o,h}let _circ_from_line_tan_vs=cachering.fromConstructor(Vector3$2,32),_circ_from_line_tan_ret=new cachering((function(){return[new Vector3$2,0]}),64);function circ_from_line_tan(t,e,i){let s=_circ_from_line_tan_vs.next(),r=_circ_from_line_tan_vs.next(),a=_circ_from_line_tan_vs.next();s.load(t).sub(e),r.load(i).normalize(),a.load(s).normalize().cross(r).cross(r).normalize();let n=s[0],o=s[1],l=s[2],h=-(n*n+o*o+l*l),c=2*(n*a[0]+o*a[1]+l*a[2]);Math.abs(c)>1e-6?h/=c:h=1e6;let d=_circ_from_line_tan_ret.next();return d[0].load(a).mulScalar(h).add(t),d[1]=h,d}let _circ_from_line_tan2d_vs=cachering.fromConstructor(Vector3$2,32),_circ_from_line_tan2d_ret=new cachering((function(){return[new Vector2$b,0]}),64);function circ_from_line_tan_2d(t,e,i){t=_circ_from_line_tan2d_vs.next().load(t),e=_circ_from_line_tan2d_vs.next().load(e),i=_circ_from_line_tan2d_vs.next().load(i),t[2]=e[2]=i[2]=0;let s=_circ_from_line_tan2d_vs.next(),r=_circ_from_line_tan2d_vs.next(),a=_circ_from_line_tan2d_vs.next();s.load(t).sub(e),r.load(i).normalize(),a.load(s).normalize().cross(r).cross(r).normalize();{let s,r,a,n=t[0],o=t[1],l=e[0],h=e[1],c=i[0],d=i[1],u=4*((n-l)*d-(o-h)*c)**2,p=2*(n-l)*d-2*(o-h)*c;if(Math.abs(u)<1e-4||Math.abs(p)<1e-4){let i=_circ_from_line_tan2d_ret.next();i[0].load(t).interp(e,.5);let s=t[1]-e[1],r=e[0]-t[0];return a=1e6,i[0][0]+=s*a,i[0][1]+=r*a,i[1]=a,i}s=(((n+l)*(n-l)-(o-h)**2)*d-2*(o-h)*c*n)/p,r=(-((o+h)*(o-h)-l**2-(n-2*l)*n)*c+2*(n-l)*d*o)/p,a=((o-h)**2+l**2+(n-2*l)*n)**2*(c**2+d**2)/u;let m=.5*t[0]+.5*e[0],f=.5*t[1]+.5*e[1];s=2*m-s,r=2*f-r;let g=_circ_from_line_tan2d_ret.next();return g[0].loadXY(s,r),g[1]=Math.sqrt(a),g}}let _gtc_e1=new Vector3$2,_gtc_e2=new Vector3$2,_gtc_e3=new Vector3$2,_gtc_p1=new Vector3$2,_gtc_p2=new Vector3$2,_gtc_v1=new Vector3$2,_gtc_v2=new Vector3$2,_gtc_p12=new Vector3$2,_gtc_p22=new Vector3$2,_get_tri_circ_ret=new cachering((function(){return[0,0]}));function get_tri_circ(t,e,i){let s,r,a=_gtc_v1,n=_gtc_v2,o=_gtc_e1,l=_gtc_e2,h=_gtc_e3,c=_gtc_p1,d=_gtc_p2;for(let s=0;s<3;s++)o[s]=e[s]-t[s],l[s]=i[s]-e[s],h[s]=t[s]-i[s];for(let s=0;s<3;s++)c[s]=.5*(t[s]+e[s]),d[s]=.5*(i[s]+e[s]);o.normalize(),a[0]=-o[1],a[1]=o[0],a[2]=o[2],n[0]=-l[1],n[1]=l[0],n[2]=l[2],a.normalize(),n.normalize();for(let t=0;t<3;t++)_gtc_p12[t]=c[t]+a[t],_gtc_p22[t]=d[t]+n[t];let u=line_isect(c,_gtc_p12,d,_gtc_p22);s=u[0],r=u[1],o.load(t),l.load(e),h.load(i);let p=o.sub(s).vectorLength();p<feps&&(p=l.sub(s).vectorLength()),p<feps&&(p=h.sub(s).vectorLength());let m=_get_tri_circ_ret.next();return m[0]=s,m[1]=p,m}function gen_circle(t,e,i,s){let r=Math.PI,a=-r/2,n=2*r/s,o=new Array;for(let r=0;r<s;r++){let s=e[0]+i*Math.sin(a),r=e[1]+i*Math.cos(a),l=t.make_vert(new Vector3$2([s,r,e[2]]));o.push(l),a+=n}for(let e=0;e<o.length;e++){let i=o[e],s=o[(e+1)%o.length];t.make_edge(i,s)}return o}let cos=Math.cos,sin=Math.sin;function rot2d(t,e,i){let s=t[0],r=t[1];1===i?(t[0]=s*cos(e)+r*sin(e),t[2]=r*cos(e)-s*sin(e)):(t[0]=s*cos(e)-r*sin(e),t[1]=r*cos(e)+s*sin(e))}function makeCircleMesh(t,e,i){let s=new Mesh,r=gen_circle(s,new Vector3$2,e,i),a=gen_circle(s,new Vector3$2,e/1.75,i);return s.make_face_complex([r,a]),s}function minmax_verts(t){let e,i=new Vector3$2([1e12,1e12,1e12]),s=new Vector3$2([-1e12,-1e12,-1e12]),r=__get_iter(t);for(;;){let t=r.next();if(t.done)break;e=t.value;for(let t=0;t<3;t++)i[t]=Math.min(i[t],e.co[t]),s[t]=Math.max(s[t],e.co[t])}return[i,s]}function unproject(t,e,i){let s=new Vector3$2(t);return s.multVecMatrix(e),s.multVecMatrix(i),s}function project(t,e,i){let s=new Vector3$2(t);return s.multVecMatrix(e),s.multVecMatrix(i),s}let _sh_minv=new Vector3$2,_sh_maxv=new Vector3$2,_sh_start=[],_sh_end=[],static_cent_gbw=new Vector3$2;function get_boundary_winding(t){let e=static_cent_gbw.zero();if(0===t.length)return!1;for(let i=0;i<t.length;i++)e.add(t[i]);e.divideScalar(t.length);let i=0,s=0;for(let r=0;r<t.length;r++){let a=t[r],n=t[(r+1)%t.length];colinear(a,n,e)||(i+=winding(a,n,e),s+=1)}return s>0&&(i/=s),1===Math.round(i)}class PlaneOps{constructor(t){this.axis=[0,0,0],this.reset_axis(t)}reset_axis(t){let e,i,s,r=Math.abs(t[0]),a=Math.abs(t[1]),n=Math.abs(t[2]);n>r&&n>a?(e=0,i=1,s=2):r>a&&r>n?(e=2,i=1,s=0):(e=0,i=2,s=1),this.axis=[e,i,s]}convex_quad(t,e,i,s){let r=this.axis;return convex_quad(t=new Vector3$2([t[r[0]],t[r[1]],t[r[2]]]),e=new Vector3$2([e[r[0]],e[r[1]],e[r[2]]]),i=new Vector3$2([i[r[0]],i[r[1]],i[r[2]]]),s=new Vector3$2([s[r[0]],s[r[1]],s[r[2]]]))}line_isect(t,e,i,s){let r=this.axis,a=t,n=e,o=line_isect(t=new Vector3$2([t[r[0]],t[r[1]],t[r[2]]]),e=new Vector3$2([e[r[0]],e[r[1]],e[r[2]]]),i=new Vector3$2([i[r[0]],i[r[1]],i[r[2]]]),s=new Vector3$2([s[r[0]],s[r[1]],s[r[2]]]),!0);o[0];return o[1]===LINECROSS&&o[0].load(n).sub(a).mulScalar(o[2]).add(a),o}line_line_cross(t,e){let i=this.axis,s=t[0],r=t[1],a=e[0],n=e[1];return s=new Vector3$2([s[i[0]],s[i[1]],0]),r=new Vector3$2([r[i[0]],r[i[1]],0]),a=new Vector3$2([a[i[0]],a[i[1]],0]),n=new Vector3$2([n[i[0]],n[i[1]],0]),line_line_cross([s,r],[a,n])}winding(t,e,i){let s=this.axis;return void 0===t&&console.trace(),winding(t=new Vector3$2([t[s[0]],t[s[1]],0]),e=new Vector3$2([e[s[0]],e[s[1]],0]),i=new Vector3$2([i[s[0]],i[s[1]],0]))}colinear(t,e,i){let s=this.axis;return colinear(t=new Vector3$2([t[s[0]],t[s[1]],0]),e=new Vector3$2([e[s[0]],e[s[1]],0]),i=new Vector3$2([i[s[0]],i[s[1]],0]))}get_boundary_winding(t){this.axis;let e=new Vector3$2;if(0===t.length)return!1;for(let i=0;i<t.length;i++)e.add(t[i]);e.divideScalar(t.length);let i=0,s=0;for(let r=0;r<t.length;r++){let a=t[r],n=t[(r+1)%t.length];this.colinear(a,n,e)||(i+=this.winding(a,n,e),s+=1)}return s>0&&(i/=s),1===Math.round(i)}}let _isrp_ret=new Vector3$2,isect_ray_plane_rets=cachering.fromConstructor(Vector3$2,256);function isect_ray_plane(t,e,i,s){let r=t,a=e,n=i,o=s,l=a[1]*o[1]+a[2]*o[2]+a[0]*o[0];if(Math.abs(l)<1e-6)return;let h=((r[1]-n[1])*a[1]+(r[2]-n[2])*a[2]+(r[0]-n[0])*a[0])/l;return _isrp_ret.load(n).addFac(o,h),isect_ray_plane_rets.next().load(_isrp_ret)}function _old_isect_ray_plane(t,e,i,s){let r=t,a=e,n=i,o=s,l=(r.vectorLength(),-(n.dot(a)-r.dot(a))/o.dot(a));return _isrp_ret.load(o),_isrp_ret.mulScalar(l),_isrp_ret.add(n),_isrp_ret}class Mat4Stack{constructor(){this.stack=[],this.matrix=new Matrix4$2,this.matrix.makeIdentity(),this.update_func=void 0}set_internal_matrix(t,e){this.update_func=e,this.matrix=t}reset(t){this.matrix.load(t),this.stack=[],void 0!==this.update_func&&this.update_func()}load(t){this.matrix.load(t),void 0!==this.update_func&&this.update_func()}multiply(t){this.matrix.multiply(t),void 0!==this.update_func&&this.update_func()}identity(){this.matrix.loadIdentity(),void 0!==this.update_func&&this.update_func()}push(t){this.stack.push(new Matrix4$2(this.matrix)),void 0!==t&&(this.matrix.load(t),void 0!==this.update_func&&this.update_func())}pop(){let t=this.stack.pop(this.stack.length-1);return this.matrix.load(t),void 0!==this.update_func&&this.update_func(),t}}const tril_rets=cachering.fromConstructor(Vector3$2,128);function lreport(){}function trilinear_v3(t,e){let[i,s,r]=t;const a=e[0][0],n=e[0][1],o=e[0][2],l=e[1][0]-a,h=e[1][1]-n,c=e[1][2]-o,d=e[2][0]-a,u=e[2][1]-n,p=e[2][2]-o,m=e[3][0]-a,f=e[3][1]-n,g=e[3][2]-o,_=e[4][0]-a,v=e[4][1]-n,b=e[4][2]-o,y=e[5][0]-a,S=e[5][1]-n,x=e[5][2]-o,T=e[6][0]-a,w=e[6][1]-n,k=e[6][2]-o,P=e[7][0]-a,C=e[7][1]-n,E=e[7][2]-o,A=(((_-y)*s-_+(T-P)*s+P)*i-((_-y)*s-_)-(((d-m)*s+m-l*s)*i+l*s))*r+((d-m)*s+m-l*s)*i+l*s,M=(((v-S)*s-v+(w-C)*s+C)*i-((v-S)*s-v)-(((u-f)*s+f-h*s)*i+h*s))*r+((u-f)*s+f-h*s)*i+h*s,$=(((b-x)*s-b+(k-E)*s+E)*i-((b-x)*s-b)-(((p-g)*s+g-c*s)*i+c*s))*r+((p-g)*s+g-c*s)*i+c*s;let I=tril_rets.next();return I[0]=A+a,I[1]=M+n,I[2]=$+o,I}let tril_co_rets=cachering.fromConstructor(Vector3$2,128),tril_co_tmps=cachering.fromConstructor(Vector3$2,16),tril_mat_1=new Matrix4$2,tril_mat_2=new Matrix4$2,wtable=[[[.5,.5,0],[.5,.5,0],[.5,.5,0]],[[.5,.5,0],[0,.5,.5],[.5,.5,0]],[[0,.5,.5],[0,.5,.5],[.5,.5,0]],[[0,.5,.5],[.5,.5,0],[.5,.5,0]]];for(let t=0;t<4;t++){let e=wtable[t];e=[e[0],e[1],[0,.5,.5]],wtable.push(e)}const pih_tmps=cachering.fromConstructor(Vector3$2,16),boxfaces_table=[[0,1,2,3],[7,6,5,4],[0,4,5,1],[1,5,6,2],[2,6,7,3],[3,7,4,0]];let boxfaces_tmp=new Array(6);for(let t=0;t<6;t++)boxfaces_tmp[t]=new Vector3$2;let boxfacenormals_tmp=new Array(6);for(let t=0;t<6;t++)boxfacenormals_tmp[t]=new Vector3$2;function point_in_hex(t,e,i,s){if(!i){i=boxfaces_tmp;for(let t=0;t<6;t++){let[s,r,a,n]=boxfaces_table[t];s=e[s],r=e[r],a=e[a],n=e[n],i[t].load(s).add(r).add(a).add(n).mulScalar(.25)}}if(!s){s=boxfacenormals_tmp;for(let t=0;t<6;t++){let[i,r,a,n]=boxfaces_table[t];i=e[i],r=e[r],a=e[a],n=e[n];let o=normal_quad(i,r,a,n);s[t].load(o).negate()}}let r=pih_tmps.next(),a=pih_tmps.next(),n=pih_tmps.next().zero();for(let t=0;t<6;t++)n.add(i[t]);n.mulScalar(1/6);let o=!0;for(let e=0;e<6;e++){r.load(t).sub(i[e]),a.load(n).sub(i[e]);s[e];if(r.normalize(),a.normalize(),r.dot(a)<0)return o=!1,!1}return o}const boxverts_tmp=new Array(8);for(let t=0;t<8;t++)boxverts_tmp[t]=new Vector3$2;function trilinear_co(t,e){let i=tril_co_rets.next();i.zero();let s=tril_co_tmps.next(),r=tril_co_tmps.next(),a=tril_co_tmps.next();s.loadXYZ(0,.5,1),r.loadXYZ(0,.5,1),a.loadXYZ(0,.5,1);tril_co_tmps.next();for(let n=0;n<4;n++){let n;i.loadXYZ(s[1],r[1],a[1]);let o=trilinear_v3(i,e).vectorDistanceSqr(t);for(let l=0;l<8;l++){let[h,c,d]=wtable[l],u=h[0]*s[0]+h[1]*s[1]+h[2]*s[2],p=c[0]*r[0]+c[1]*r[1]+c[2]*r[2],m=d[0]*a[0]+d[1]*a[1]+d[2]*a[2],f=Math.abs(u-s[1]),g=Math.abs(p-r[1]),_=Math.abs(m-a[1]);i.loadXYZ(u,p,m);let v=trilinear_v3(i,e).vectorDistanceSqr(t);{let i=boxverts_tmp;i[0].loadXYZ(u-f,p-g,m-_),i[1].loadXYZ(u-f,p+g,m-_),i[2].loadXYZ(u+f,p+g,m-_),i[3].loadXYZ(u+f,p-g,m-_),i[4].loadXYZ(u-f,p-g,m+_),i[5].loadXYZ(u-f,p+g,m+_),i[6].loadXYZ(u+f,p+g,m+_),i[7].loadXYZ(u+f,p-g,m+_);for(let t=0;t<8;t++)i[t].load(trilinear_v3(i[t],e));if(point_in_hex(t,i)){n=l,o=v;break}}}if(void 0===n){lreport("mindis:",(o**.5).toFixed(3));break}let[l,h,c]=wtable[n],d=l[0]*s[0]+l[1]*s[1]+l[2]*s[2],u=h[0]*r[0]+h[1]*r[1]+h[2]*r[2],p=c[0]*a[0]+c[1]*a[1]+c[2]*a[2],m=Math.abs(d-s[1]),f=Math.abs(u-r[1]),g=Math.abs(p-a[1]);s[0]=d-m,r[0]=u-f,a[0]=p-g,s[1]=d,r[1]=u,a[1]=p,s[2]=d+m,r[2]=u+f,a[2]=p+g,lreport("mindis:",(o**.5).toFixed(3),d,u,p)}return i.loadXYZ(s[1],r[1],a[1]),trilinear_co2(t,e,i)}function trilinear_co2(t,e,i){let s=tril_co_tmps.next(),r=1e-5,a=tril_mat_1,n=(a.$matrix,tril_co_tmps.next());for(let a=0;a<55;a++){let a=0;for(let o=0;o<3;o++){let l=0;i[o]<0?l=-i[o]:i[o]>1&&(l=i[o]-1),n[o]=trilinear_v3(i,e).vectorDistance(t)+10*l;let h=i[o];i[o]+=r,l=i[o]<0?-i[o]:i[o]>1?i[o]-1:0;let c=trilinear_v3(i,e).vectorDistance(t)+10*l;i[o]=h,s[o]=(c-n[o])/r,a+=s[o]**2}if(0===a)break;let o=trilinear_v3(i,e).vectorDistance(t);if(i.addFac(s,-o/a*.85),lreport("error:",o.toFixed(3),i),n.dot(n)**.5<1e-4)break}return lreport("\n"),i}let angle_tri_v3_rets=cachering.fromConstructor(Vector3$2,32),angle_tri_v3_vs=cachering.fromConstructor(Vector3$2,32);function tri_angles(t,e,i){let s=angle_tri_v3_vs.next().load(t).sub(e),r=angle_tri_v3_vs.next().load(i).sub(e),a=angle_tri_v3_vs.next().load(e).sub(i);s.normalize(),r.normalize(),a.normalize();let n=Math.acos(.99999*s.dot(r));r.negate();let o=Math.acos(.99999*r.dot(a)),l=Math.PI-(n+o),h=angle_tri_v3_rets.next();return h[0]=n,h[1]=o,h[2]=l,h}let angle_v2_temps=cachering.fromConstructor(Vector2$b,32),angle_v3_temps=cachering.fromConstructor(Vector3$2,32);function angle_between_vecs(t,e,i){let s,r;2===t.length?(s=angle_v2_temps.next(),r=angle_v2_temps.next()):(s=angle_v3_temps.next(),r=angle_v3_temps.next()),s.load(t).sub(e).normalize(),r.load(i).sub(e).normalize();let a=s.dot(r);return a<-1?Math.PI:a>1?0:Math.acos(a)}var math=Object.freeze({__proto__:null,quad_bilinear:quad_bilinear,ClosestModes:ClosestModes,AbstractCurve:AbstractCurve,ClosestCurveRets:ClosestCurveRets,closestPoint:closestPoint,normal_poly:normal_poly,dihedral_v3_sqr:dihedral_v3_sqr,tet_volume:tet_volume,calc_projection_axes:calc_projection_axes,aabb_isect_line_3d:aabb_isect_line_3d,aabb_isect_cylinder_3d:aabb_isect_cylinder_3d,barycentric_v2:barycentric_v2,closest_point_on_quad:closest_point_on_quad,closest_point_on_tri:closest_point_on_tri,dist_to_tri_v3_old:dist_to_tri_v3_old,dist_to_tri_v3:dist_to_tri_v3,dist_to_tri_v3_sqr:dist_to_tri_v3_sqr,tri_area:tri_area,aabb_overlap_area:aabb_overlap_area,aabb_isect_2d:aabb_isect_2d,aabb_isect_3d:aabb_isect_3d,aabb_intersect_2d:aabb_intersect_2d,aabb_intersect_3d:aabb_intersect_3d,aabb_union:aabb_union,aabb_union_2d:aabb_union_2d,feps:feps,COLINEAR:COLINEAR,LINECROSS:LINECROSS,COLINEAR_ISECT:COLINEAR_ISECT,SQRT2:SQRT2,FEPS_DATA:FEPS_DATA,FEPS:FEPS,FLOAT_MIN:FLOAT_MIN,FLOAT_MAX:FLOAT_MAX,Matrix4UI:Matrix4UI,get_rect_points:get_rect_points,get_rect_lines:get_rect_lines,simple_tri_aabb_isect:simple_tri_aabb_isect,MinMax:MinMax,winding_axis:winding_axis,winding:winding,inrect_2d:inrect_2d,aabb_isect_line_2d:aabb_isect_line_2d,expand_rect2d:expand_rect2d,expand_line:expand_line,colinear:colinear,colinear2d:colinear2d,corner_normal:corner_normal,line_line_isect:line_line_isect,line_line_cross:line_line_cross,point_in_aabb_2d:point_in_aabb_2d,aabb_sphere_isect_2d:aabb_sphere_isect_2d,point_in_aabb:point_in_aabb,aabb_sphere_isect:aabb_sphere_isect,aabb_sphere_dist:aabb_sphere_dist,point_in_tri:point_in_tri,convex_quad:convex_quad,isNum:isNum,normal_tri:normal_tri,normal_quad:normal_quad,normal_quad_old:normal_quad_old,line_isect:line_isect,dist_to_line_2d:dist_to_line_2d,dist_to_line_sqr:dist_to_line_sqr,dist_to_line:dist_to_line,clip_line_w:clip_line_w,closest_point_on_line:closest_point_on_line,circ_from_line_tan:circ_from_line_tan,circ_from_line_tan_2d:circ_from_line_tan_2d,get_tri_circ:get_tri_circ,gen_circle:gen_circle,rot2d:rot2d,makeCircleMesh:makeCircleMesh,minmax_verts:minmax_verts,unproject:unproject,project:project,get_boundary_winding:get_boundary_winding,PlaneOps:PlaneOps,isect_ray_plane:isect_ray_plane,_old_isect_ray_plane:_old_isect_ray_plane,Mat4Stack:Mat4Stack,trilinear_v3:trilinear_v3,point_in_hex:point_in_hex,trilinear_co:trilinear_co,trilinear_co2:trilinear_co2,tri_angles:tri_angles,angle_between_vecs:angle_between_vecs});let _clipdata={name:"nothing",mime:"nothing",data:void 0},_clipboards={};window.setInterval((()=>{if(!document.hasFocus())return;let t=navigator.clipboard;t&&t.read&&t.read().then((t=>{for(let e of t)for(let t=0;t<e.types.length;t++){let i=e.types[t];i in _clipboards||(_clipboards[i]={name:i,mime:i,data:void 0}),e.getType(i).then((t=>new Response(t).text())).then((t=>{_clipboards[i].data=t}))}})).catch((function(){}))}),200);let exports={getClipboardData(t="text/plain"){"string"==typeof t&&(t=[t]);for(let e of t){let t=_clipboards[e];if(t&&t.data)return t}},setClipboardData(t,e,i){_clipboards[e]={name:t,mime:e,data:i};let s=navigator.clipboard;if(s)try{s.write([new ClipboardItem({[e]:new Blob([i],{type:e})})]).catch((s=>{e.startsWith("text")&&"text/plain"!==e?this.setClipboardData(t,"text/plain",i):console.error(s)}))}catch(t){console.log(t.stack),console.log("failed to write to system clipboard")}},colorSchemeType:"light",docManualPath:"../simple_docsys/doc_build/",docEditorPath:"../simple_docsys.js",useNumSliderTextboxes:!0,numSliderArrowLimit:15,simpleNumSliders:!1,menusCanPopupAbove:!1,menu_close_time:500,doubleClickTime:500,doubleClickHoldTime:750,DEBUG:{paranoidEvents:!1,screenborders:!1,areaContextPushes:!1,allBordersMovable:!1,doOnce:!1,modalEvents:!1,areaConstraintSolver:!1,datapaths:!1,lastToolPanel:!1,domEvents:!1,domEventAddRemove:!1,debugUIUpdatePerf:!1,screenAreaPosSizeAccesses:!1,buttonEvents:!1},autoLoadSplineTemplates:!0,addHelpPickers:!0,useAreaTabSwitcher:!1,autoSizeUpdate:!0,showPathsInToolTips:!0,enableThemeAutoUpdate:!0,useNativeToolTips:!0,noElectronMenus:!1,loadConstants:function(t){for(let e in t)"loadConstants"!==e&&(this[e]=t[e]);setConfig(this)}};window.DEBUG=exports.DEBUG;let cfg=document.getElementById("pathux-config");cfg&&exports.loadConstants(JSON.parse(cfg.innerText));let compatMap={BoxMargin:"padding",BoxBG:"background",BoxRadius:"border-radius",background:"background-color",defaultWidth:"width",defaultHeight:"height",DefaultWidth:"width",DefaultHeight:"height",BoxBorder:"border-color",BoxLineWidth:"border-width",BoxSubBG:"background-color",BoxSub2BG:"background-color",DefaultPanelBG:"background-color",InnerPanelBG:"background-color",Background:"background-color",numslider_width:"width",numslider_height:"height"},ColorSchemeTypes={LIGHT:"light",DARK:"dark"};function parsepx$4(t){return parseFloat(t.trim().replace("px",""))}function color2css$1(t,e){let i=~~(255*t[0]),s=~~(255*t[1]),r=~~(255*t[2]),a=t.length<4?1:t[3];return a=void 0!==e?e:a,3===t.length&&void 0===e?`rgb(${i},${s},${r})`:`rgba(${i},${s},${r}, ${a})`}window.color2css=color2css$1;let css2color_rets=cachering.fromConstructor(Vector4$2,64),basic_colors={white:[1,1,1],grey:[.5,.5,.5],gray:[.5,.5,.5],black:[0,0,0],red:[1,0,0],yellow:[1,1,0],green:[0,1,0],teal:[0,1,1],cyan:[0,1,1],blue:[0,0,1],orange:[1,.5,.25],brown:[.5,.4,.3],purple:[1,0,1],pink:[1,.5,.5]};function color2web(t){function e(t){let e=(t=~~(255*t)).toString(16);for(e.length>2&&(e=e.slice(0,2));e.length<2;)e="0"+e;return e}if(3===t.length||1===t[3]){return"#"+e(t[0])+e(t[1])+e(t[2])}return"#"+e(t[0])+e(t[1])+e(t[2])+e(t[3])}function css2color$1(t){if(!t)return new Vector4$2([0,0,0,1]);t=(""+t).trim();let e=css2color_rets.next();if("#"===t[0]){t=t.slice(1,t.length);let i,s=[];for(let e=0;e<t.length>>1;e++){let i="0x"+t.slice(2*e,2*e+2);s.push(parseInt(i))}for(e.zero(),i=0;i<Math.min(s.length,e.length);i++)e[i]=s[i]/255;return i<4&&(e[3]=1),e}if(t in basic_colors)return e.load(basic_colors[t]),e[3]=1,e;const i=t.startsWith("rgba(");t=t.replace("rgba","").replace("rgb","").replace(/[\(\)]/g,"").trim().split(",");for(let i=0;i<t.length;i++)e[i]=parseFloat(t[i]),i<3&&(e[i]/=255);return 3===e.length&&e.push(1),i||(e[3]=1),e}function web2color(t){return"string"==typeof t&&"#"!==t.trim()[0]&&(t="#"+t.trim()),css2color$1(t)}window.color2web=color2web,window.css2color=css2color$1,window.web2color=web2color;let validate_pat=/\#?[0-9a-fA-F]{6}([0-9a-fA-F]{2})?$/;function validateWebColor(t){return("string"==typeof t||t instanceof String)&&0===t.trim().search(validate_pat)}let num="(([0-9]+.[0-9]+)|[0-9a-f]+)",validate_rgba=new RegExp(`rgba\\(${num},${num},${num},${num}\\)$`),validate_rgb=new RegExp(`rgb\\(${num},${num},${num}\\)$`);function validateCSSColor$1(t){if(t.toLowerCase()in basic_colors)return!0;let e=t.toLowerCase().replace(/[ \t]/g,"");return e=e.trim(),!(!validate_rgba.test(e)&&!validate_rgb.exec(e))||validateWebColor(t)}window.validateCSSColor=validateCSSColor$1;let theme={};function invertTheme(){function t(e){if(Array.isArray(e)){for(let t=0;t<3;t++)e[t]=1-e[t];return e}return color2css$1(t(e=css2color$1(e)))}exports.colorSchemeType=exports.colorSchemeType===ColorSchemeTypes.LIGHT?ColorSchemeTypes.DARK:ColorSchemeTypes.LIGHT;let e=document.body.style["background-color"];e=exports.colorSchemeType===ColorSchemeTypes.LIGHT?"rgb(200,200,200)":"rgb(55, 55, 55)",document.body.style["background-color"]=e;for(let e in theme){e=theme[e];for(let i in e){let s=e[i];if(s instanceof CSSFont)s.color=t(s.color);else if("string"==typeof s){s=s.trim().toLowerCase();let r=s.search("rgb")>=0;r=r||s in basic_colors,r=r||validateWebColor(s),r&&(e[i]=t(s))}}}}function setColorSchemeType(t){!!t!==exports.colorSchemeType&&(invertTheme(),exports.colorSchemeType=t)}window.invertTheme=invertTheme,window.validateWebColor=validateWebColor;let _digest$1=new HashDigest;class CSSFont{constructor(t={}){this._size=t.size?t.size:12,this.font=t.font,this.style=void 0!==t.style?t.style:"normal",this.weight=void 0!==t.weight?t.weight:"normal",this.variant=void 0!==t.variant?t.variant:"normal",this.color=t.color}calcHashUpdate(t=_digest$1.reset()){return t.add(this._size||0),t.add(this.font),t.add(this.style),t.add(this.weight),t.add(this.variant),t.add(this.color),t.get()}set size(t){this._size=t}get size(){if(isMobile()){let t=theme.base.mobileTextSizeMultiplier/visualViewport.scale;if(t)return this._size*t}return this._size}copyTo(t){t._size=this._size,t.font=this.font,t.style=this.style,t.color=this.color,t.variant=this.variant,t.weight=this.weight}copy(){let t=new CSSFont;return this.copyTo(t),t}genCSS(t=this.size){return`${this.style} ${this.variant} ${this.weight} ${t}px ${this.font}`}hash(){return this.genKey()}genKey(){let t=this.color;return"object"!=typeof this.color&&"function"!=typeof this.color||(t=JSON.stringify(t)),this.genCSS()+":"+this.size+":"+t}}function exportTheme(t=theme,e=!0){let i=t=>{let e=[];for(let i in t)e.push(i);return e.sort(),e},s=e?"var theme = {\n":"{\n";function r(t,e=""){if("string"==typeof t)return t=t.search("\n")>=0?"`"+t+"`":"'"+t+"'";if("object"==typeof t){if(t instanceof CSSFont)return`new CSSFont({\n${e}  font    : ${r(t.font)},\n${e}  weight  : ${r(t.weight)},\n${e}  variant : ${r(t.variant)},\n${e}  style   : ${r(t.style)},\n${e}  size    : ${r(t._size)},\n${e}  color   : ${r(t.color)}\n${e}})`;{let s="{\n";for(let a of i(t)){let i=t[a];(a.search(" ")>=0||a.search("-")>=0)&&(a="'"+a+"'"),s+=e+"  "+a+" : "+r(i,e+"  ")+",\n"}return s+=e+"}",s}}return""+t}for(let e of i(t)){let a=e;e.search(/[- \t.]/)>=0&&(a="'"+e+"'"),s+="  "+a+": ";let n=t[e];if("object"!=typeof n||n instanceof CSSFont)s+=r(n,"  ")+",\n";else{s+=" {\n";let t="",e=0;for(let t of i(n))(t.search("-")>=0||t.search(" ")>=0)&&(t="'"+t+"'"),e=Math.max(e,t.length);for(let s of i(n)){let i=n[s];(s.search("-")>=0||s.search(" ")>=0)&&(s="'"+s+"'");let a="";for(let t=0;t<e-s.length;t++)a+=" ";t+="    "+s+a+": "+r(i,"    ")+",\n"}s+=t,s+="  },\n\n"}}return s+="};\n",s}function copyTheme(t){if(t instanceof CSSFont)return t.copy();let e={};for(let i in t){let s=t[i];"function"!=typeof s&&(e[i]="object"==typeof s?copyTheme(s):s)}return e}CSSFont.STRUCT='\nCSSFont {\n  size     : float | obj._size;\n  font     : string | obj.font || "";\n  style    : string | obj.font || "";\n  color    : string | ""+obj.color;\n  variant  : string | obj.variant || "";\n  weight   : string | ""+obj.weight;\n}\n',nstructjs.register(CSSFont),window._exportTheme=exportTheme;class EventDispatcher{constructor(){this._cbs={}}_fireEvent(t,e){let i=!1;if(e={stopPropagation(){i=!0},data:e},t in this._cbs)for(let s of this._cbs[t])if(s(e),i)break}on(t,e){return t in this._cbs||(this._cbs[t]=[]),this._cbs[t].push(e),this}off(t,e){if(!(t in this._cbs))return console.warn("event handler not in list",t,e),this;let i=this._cbs[t];return i.indexOf(e)<0?(console.warn("event handler not in list",t,e),this):(i.remove(e),this)}}function copyMouseEvent(t){let e={};function i(t,e){return function(){return this._orig.apply(t,arguments)}}let s=new Set(["__proto__"]);e._orig=t;for(let r in t){let a=t[r];s.has(r)||("function"==typeof a&&(a=i(a)),e[r]=a)}e.ctrlKey=t.ctrlKey,e.shiftKey=t.shiftKey,e.altKey=t.altKey;for(let i=0;i<2;i++){let s=i?"targetTouches":"touches";if(t[s]){e[s]=[];for(let i of t[s]){let t={};e[s].push(t);for(let e in i)t[e]=i[e]}}}return e}const DomEventTypes={on_mousemove:"mousemove",on_mousedown:"mousedown",on_mouseup:"mouseup",on_touchstart:"touchstart",on_touchcancel:"touchcanel",on_touchmove:"touchmove",on_touchend:"touchend",on_mousewheel:"mousewheel",on_keydown:"keydown",on_keyup:"keyup",on_pointerdown:"pointerdown",on_pointermove:"pointermove",on_pointercancel:"pointercancel",on_pointerup:"pointerup"};function getDom(t,e){return e.startsWith("key")?window:t}let modalStack=[];function isModalHead(t){return 0===modalStack.length||modalStack[modalStack.length-1]===t}class EventHandler{constructor(){this._modalstate=void 0}pushPointerModal(t,e){this._modalstate?console.warn("pushPointerModal called twiced!"):this._modalstate=pushPointerModal(this,t,e)}pushModal(t,e){this._modalstate?console.warn("pushModal called twiced!"):this._modalstate=pushModalLight(this)}popModal(){if(void 0!==this._modalstate){popModalLight(this._modalstate),this._modalstate=void 0}}}function pushModal(t,e){console.warn("Deprecated call to pathux.events.pushModal; use api in simple_events.js instead");let i=new EventHandler;for(let t in e)i[t]=e[t];return e.popModal=()=>i.popModal(t),i.pushModal(t,!1),i}const CurveConstructors=[],CURVE_VERSION=1.1,CurveFlags={SELECT:1,TRANSFORM:2},TangentModes={SMOOTH:1,BREAK:2};function getCurve(t,e=!0){for(let e of CurveConstructors){if(e.name===t)return e;if(e.define().name===t)return e}if(e)throw new Error("Unknown curve type "+t);return console.warn("Unknown curve type",t),getCurve("ease")}let _udigest$4=new HashDigest;class CurveTypeData{constructor(){this.type=this.constructor.define().typeName,this.parent=void 0}get hasGUI(){throw new Error("get hasGUI(): implement me!")}static register(t){if(t.define===CurveTypeData.define)throw new Error("missing define() static method");let e=t.define();if(!e.name)throw new Error(t.name+".define() result is missing 'name' field");if(!e.typeName)throw new Error(t.name+".define() is missing .typeName, which should equal class name; needed for minificaiton");CurveConstructors.push(t)}static define(){return{uiname:"Some Curve",name:"somecurve",typeName:"CurveTypeData"}}calcHashKey(t=_udigest$4.reset()){let e=t;return e.add(this.type),e.get()}toJSON(){return{type:this.type}}equals(t){return this.type===t.type}loadJSON(t){return this.type=t.type,this}redraw(){this.parent&&this.parent.redraw()}makeGUI(t){}killGUI(t){t.clear()}evaluate(t){throw new Error("implement me!")}integrate(t,e=64){let i=0,s=t/e;for(let t=0,r=0;t<e;t++,r+=s)i+=this.evaluate(r)*s;return i}derivative(t){let e=1e-4;return t>.9997?(this.evaluate(t)-this.evaluate(t-e))/e:t<3*e?(this.evaluate(t+e)-this.evaluate(t))/e:(this.evaluate(t+e)-this.evaluate(t-e))/(2*e)}derivative2(t){let e=1e-4;return t>.9997?(this.derivative(t)-this.derivative(t-e))/e:t<3*e?(this.derivative(t+e)-this.derivative(t))/e:(this.derivative(t+e)-this.derivative(t-e))/(2*e)}inverse(t){let e,i,s=1/9,r=0;for(let a=0;a<9;a++,r+=s){let a,n=r,o=r+s;for(let e=0;e<11;e++){let e=this.evaluate(n),i=this.evaluate(o);a=.5*(n+o),Math.abs(e-t)<Math.abs(i-t)?o=a:n=a}let l=this.evaluate(a);(void 0===e||Math.abs(t-l)<e)&&(e=Math.abs(t-l),i=a)}return void 0===i?0:i}onActive(t,e){}onInactive(t,e){}reset(){}destroy(){}update(){this.parent&&this.parent._on_change()}draw(t,e,i){}loadSTRUCT(t){t(this)}}CurveTypeData.STRUCT="\nCurveTypeData {\n  type : string;\n}\n",nstructjs.register(CurveTypeData);const unitRange=[0,1];function evalHermiteTable(t,e,i=unitRange){let s=(e=(e-i[0])/(i[1]-i[0]))*(t.length/4),r=Math.floor(s);s-=r,r*=4;let a=t[r]+(t[r+1]-t[r])*s;return a+(t[r+2]+(t[r+3]-t[r+2])*s-a)*s}function genHermiteTable(t,e,i=[0,1]){let s,r,a=new Array(e),[n,o]=i,l=1e-4,h=(o-n-4.001*l)/(e-1),c=n+4*l;for(let i=0;i<e;i++,c+=h){let n=t(c-l),o=t(c),h=(t(c+l)-n)/(2*l);if(h/=e,i>0){let t=i-1;a[4*t]=r,a[4*t+1]=r+s/3,a[4*t+2]=o-h/3,a[4*t+3]=o}s=h,r=o}return a}const DataFlags={READ_ONLY:1,USE_CUSTOM_GETSET:2,USE_FULL_UNDO:4,USE_CUSTOM_PROP_GETTER:8,USE_EVAL_MASS_SET_PATHS:16},DataTypes={STRUCT:0,DYNAMIC_STRUCT:1,PROP:2,ARRAY:3};let propCacheRings={};function getTempProp(t){return t in propCacheRings||(propCacheRings[t]=cachering.fromConstructor(ToolProperty$1.getClass(t),32)),propCacheRings[t].next()}class DataPathError extends Error{}function getVecClass(t){switch(t){case PropTypes$8.VEC2:return Vector2$b;case PropTypes$8.VEC3:return Vector3$2;case PropTypes$8.VEC4:return Vector4$2;case PropTypes$8.QUAT:return Quat;default:throw new Error("bad prop type "+t)}}function isVecProperty(t){if(!t||"object"!=typeof t||null===t)return!1;let e=!1;return e=e||t instanceof Vec2PropertyIF,e=e||t instanceof Vec3PropertyIF,e=e||t instanceof Vec4PropertyIF,e=e||t instanceof Vec2Property,e=e||t instanceof Vec3Property,e=e||t instanceof Vec4Property,e=e||t.type===PropTypes$8.VEC2,e=e||t.type===PropTypes$8.VEC3,e=e||t.type===PropTypes$8.VEC4,e=e||t.type===PropTypes$8.QUAT,e}class DataPath{constructor(t,e,i,s=DataTypes.PROP){this.type=s,this.data=i,this.apiname=e,this.path=t,this.flag=0,this.struct=void 0,s===DataTypes.PROP&&this.data&&0===(""+this.data.uiname).trim().length&&(this.data.uiname=ToolProperty$1.makeUIName(e))}evalMassSetFilter(){return this.flag|=DataFlags.USE_EVAL_MASS_SET_PATHS,this}copy(){let t=new DataPath;return t.flag=this.flag,t.type=this.type,t.data=this.data,t.apiname=this.apiname,t.path=this.path,t.struct=this.struct,t}noUndo(){return this.data.flag|=PropFlags$3.NO_UNDO,this}setProp(t){this.data=t}readOnly(){return this.flag|=DataFlags.READ_ONLY,this.type===DataTypes.PROP&&(this.data.flag|=PropFlags$3.READ_ONLY),this}read_only(){return console.warn("DataPath.read_only is deprecated; use readOnly"),this.readOnly()}customPropCallback(t){return this.flag|=DataFlags.USE_CUSTOM_PROP_GETTER,this.data.flag|=PropFlags$3.USE_CUSTOM_PROP_GETTER,this.propGetter=t,this}customGetSet(t,e){return this.flag|=DataFlags.USE_CUSTOM_GETSET,this.type!==DataTypes.DYNAMIC_STRUCT&&this.type!==DataTypes.STRUCT?(this.data.flag|=PropFlags$3.USE_CUSTOM_GETSET,this.data._getValue=this.data.getValue,this.data._setValue=this.data.setValue,t&&(this.data.getValue=t),e&&(this.data.setValue=e)):(this.getSet={get:t,set:e},this.getSet.dataref=void 0,this.getSet.datapath=void 0,this.getSet.ctx=void 0),this}customSet(t){return this.customGetSet(void 0,t),this}customGet(t){return this.customGetSet(t,void 0),this}on(t,e){if(this.type!=DataTypes.PROP)throw new Error("invalid call to DataPath.on");return this.data.on(t,e),this}off(t,e){this.type===DataTypes.PROP&&this.data.off(t,e)}simpleSlider(){return this.data.flag|=PropFlags$3.SIMPLE_SLIDER,this.data.flag&=~PropFlags$3.FORCE_ROLLER_SLIDER,this}rollerSlider(){return this.data.flag&=~PropFlags$3.SIMPLE_SLIDER,this.data.flag|=PropFlags$3.FORCE_ROLLER_SLIDER,this}checkStrip(t=!0){return t?this.data.flag|=PropFlags$3.FORCE_ENUM_CHECKBOXES:this.data.flag&=~PropFlags$3.FORCE_ENUM_CHECKBOXES,this}noUnits(){return this.baseUnit("none"),this.displayUnit("none"),this}baseUnit(t){return this.data.setBaseUnit(t),this}displayUnit(t){return this.data.setDisplayUnit(t),this}unit(t){return this.baseUnit(t).displayUnit(t)}editAsBaseUnit(){return this.data.flag|=PropFlags$3.EDIT_AS_BASE_UNIT,this}range(t,e){return this.data.setRange(t,e),this}uiRange(t,e){return this.data.setUIRange(t,e),this}decimalPlaces(t){return this.data.setDecimalPlaces(t),this}sliderDisplayExp(t){return this.data.setSliderDisplayExp(t),this}uiNameGetter(t){return this.ui_name_get=t,this}expRate(t){return this.data.setExpRate(t),this}slideSpeed(t){return this.data.setSlideSpeed(t),this}uniformSlider(t=!0){return this.data.uniformSlider(t),this}radix(t){return this.data.setRadix(t),this}relativeStep(t){return this.data.setRelativeStep(t),this}step(t){return this.data.setStep(t),this}fullSaveUndo(){return this.flag|=DataFlags.USE_FULL_UNDO,this.data.flag|=PropFlags$3.USE_BASE_UNDO,this}icon(t){return this.data.setIcon(t),this}icon2(t){return this.data.setIcon2(t),this}icons(t){return this.data.addIcons(t),this}icons2(t){return this.data.addIcons2(t),this}descriptions(t){return this.data.addDescriptions(t),this}uiNames(t){return this.data.addUINames(t),this}description(t){return this.data.description=t,this}}const StructFlags={NO_UNDO:1};class ListIface{getStruct(t,e,i){}get(t,e,i){}getKey(t,e,i){}getActive(t,e){}setActive(t,e,i){}set(t,e,i,s){e[i]=s}getIter(){}filter(t,e,i){}}class ToolOpIface{constructor(){}static tooldef(){return{uiname:"!untitled tool",icon:-1,toolpath:"logical_module.tool",description:void 0,is_modal:!1,inputs:{},outputs:{}}}}let DataAPIClass,notifier;function setImplementationClass(t){DataAPIClass=t}function registerTool(t){if(void 0===DataAPIClass)throw new Error("data api not initialized properly; call setImplementationClass");return DataAPIClass.registerTool(t)}function setNotifier(t){notifier=t}const ContextFlags={IS_VIEW:1};class InheritFlag$1{constructor(t){this.data=t}}let __idgen=1;void 0===Symbol.ContextID&&(Symbol.ContextID=Symbol("ContextID")),void 0===Symbol.CachedDef&&(Symbol.CachedDef=Symbol("CachedDef"));const _ret_tmp=[void 0],OverlayClasses=[];function makeDerivedOverlay(t){return class e extends t{constructor(t){super(t),this.ctx=void 0,this._state=t}get state(){return this._state}set state(t){this._state=t}onRemove(t=!1){}copy(){return new this.constructor(this._state)}validate(){throw new Error("Implement me!")}static contextDefine(){throw new Error("implement me!")}static resolveDef(){if(this.hasOwnProperty(Symbol.CachedDef))return this[Symbol.CachedDef];let t=Symbol.CachedDef={},i=this.contextDefine();void 0===i&&(i={});for(let e in i)t[e]=i[e];"flag"in i||(t.flag=Context.inherit(0));let s=[],r=getClassParent(this);for(;r&&r!==e;)s.push(r),r=getClassParent(r);if(t.flag instanceof InheritFlag$1){let e=t.flag.data;for(let t of s){let i=t.contextDefine();if(i.flag){if(!(i.flag instanceof InheritFlag$1)){e|=i.flag;break}e|=i.flag.data}}t.flag=e}return t}}}const ContextOverlay=makeDerivedOverlay(Object),excludedKeys=new Set(["onRemove","reset","toString","_fix","valueOf","copy","next","save","load","clear","hasOwnProperty","toLocaleString","constructor","propertyIsEnumerable","isPrototypeOf","state","saveProperty","loadProperty","getOwningOverlay","_props"]);class LockedContext{constructor(t,e){this.props={},this.state=t.state,this.api=t.api,this.toolstack=t.toolstack,this.noWarnings=e,this.load(t)}toLocked(){return this}error(){return this.ctx.error(...arguments)}warning(){return this.ctx.warning(...arguments)}message(){return this.ctx.message(...arguments)}progbar(){return this.ctx.progbar(...arguments)}load(t){let e=t._props;function i(e){return function(i,s){return t.loadProperty(i,e,s)}}for(let s of e){let e,r,a;if("state"===s||"toolstack"===s||"api"===s)continue;if("string"==typeof s&&(s.endsWith("_save")||s.endsWith("_load")))continue;try{e=t[s]}catch(t){config.DEBUG.contextSystem&&console.warn("failed to look up property in context: ",s);continue}let n=t.getOwningOverlay(s);if(void 0!==n){try{"string"==typeof s&&n[s+"_save"]&&n[s+"_load"]?(r=n[s+"_save"](),a=n[s+"_load"]):(r=t.saveProperty(s),a=i(s))}catch(t){console.warn("Failed to save context property",s);continue}this.props[s]={data:r,get:a}}}let s=t=>{Object.defineProperty(this,t,{get:function(){let e=this.props[t];return e.get(this.ctx,e.data)}})};for(let t in this.props)s(t);this.ctx=t}setContext(t){this.ctx=t,this.state=t.state,this.api=t.api,this.toolstack=t.toolstack}}let next_key={},idgen$1=1;class Context{constructor(t){this.state=t,this._props=new Set,this._stack=[],this._inside_map={}}static isContextSubclass(t){for(;t;){if(t===Context)return!0;t=t.__proto__}return!1}_fix(){this._inside_map={}}fix(){this._fix()}error(t,e=1500){let i=this.state;if(console.warn(t),i&&i.screen)return notifier.error(i.screen,t,e)}warning(t,e=1500){let i=this.state;if(console.warn(t),i&&i.screen)return notifier.warning(i.screen,t,e)}message(t,e=1500){let i=this.state;if(console.warn(t),i&&i.screen)return notifier.message(i.screen,t,e)}progbar(t,e=0,i=1500,s=t){let r=this.state;if(r&&r.screen)return notifier.progbarNote(r.screen,t,e,"green",i,s)}validateOverlays(){let t=this._stack,e=[];for(let i=0;i<t.length;i++)t[i].validate()&&e.push(t[i]);this._stack=e}hasOverlay(t){return void 0!==this.getOverlay(t)}getOverlay(t){for(let e of this._stack)if(e.constructor===t)return e}clear(t=!1){for(let e of this._stack)e.onRemove(t);this._stack=[]}reset(t=!1){this.clear(t)}override(t){void 0===t.copy&&(t.copy=function(){return Object.assign({},this)});let e=this.copy();return e.pushOverlay(t),e}copy(){let t=new this.constructor(this.state);for(let e of this._stack)t.pushOverlay(e.copy());return t}static super(){return next_key}saveProperty(t){return this[t]}loadProperty(t,e,i){return i}getOwningOverlay(t,e){let i=this._inside_map,s=this._stack;config.DEBUG.contextSystem&&console.log(t,i);for(let r=s.length-1;r>=0;r--){let a=s[r],n=next_key;if(void 0===a[Symbol.ContextID])throw new Error("context corruption");let o=a[Symbol.ContextID];if(config.DEBUG.contextSystem&&console.log(o,a),!i[o]){if(a.__allKeys.has(t)){config.DEBUG.contextSystem&&console.log("getting value"),i[o]=1;try{n=a[t]}catch(t){throw i[o]=0,t}i[o]=0}if(n!==next_key)return void 0!==e&&(e[0]=n),a}}void 0!==e&&(e[0]=void 0)}ensureProperty(t){this.hasOwnProperty(t)||(this._props.add(t),Object.defineProperty(this,t,{get:function(){let e=_ret_tmp;return _ret_tmp[0]=void 0,this.getOwningOverlay(t,e),e[0]},set:function(){throw new Error("Cannot set ctx properties")}}))}toLocked(){return new LockedContext(this)}pushOverlay(t){t.hasOwnProperty(Symbol.ContextID)||(t[Symbol.ContextID]=idgen$1++);let e=new Set;for(let i of getAllKeys(t))excludedKeys.has(i)||"string"==typeof i&&"_"===i[0]||e.add(i);t.ctx=this,void 0===t.__allKeys&&(t.__allKeys=e);for(let t of e){let e="symbol"==typeof t||excludedKeys.has(t);e=e||"string"==typeof t&&"_"===t[0],e=e||"string"==typeof t&&t.endsWith("_save"),e=e||"string"==typeof t&&t.endsWith("_load"),e||this.ensureProperty(t)}this._stack.indexOf(t)>=0&&(console.warn("Overlay already added once"),this._stack[this._stack.length-1]===t)?console.warn("  Definitely an error, overlay is already at top of stack"):this._stack.push(t)}popOverlay(t){t===this._stack[this._stack.length-1]?(t.onRemove(),this._stack.pop()):console.warn("Context.popOverlay called in error",t)}removeOverlay(t){this._stack.indexOf(t)<0?console.warn("Context.removeOverlay called in error",t):(t.onRemove(),this._stack.remove(t))}static inherit(t){return new InheritFlag$1(t)}static register(t){t[Symbol.ContextID]?console.warn("Tried to register same class twice:",t):(t[Symbol.ContextID]=__idgen++,OverlayClasses.push(t))}}function test(){return function(){class t extends ContextOverlay{static contextDefine(){return{flag:1}}}class e extends t{static contextDefine(){return{flag:2}}}class i extends e{static contextDefine(){return{flag:Context.inherit(4)}}}class s extends i{static contextDefine(){return{flag:Context.inherit(8)}}}return 30===class extends s{static contextDefine(){return{flag:Context.inherit(16)}}}.resolveDef().flag}()}if(!test())throw new Error("Context test failed");let ToolClasses=[];function setContextClass(t){console.warn("setContextClass is deprecated")}window._ToolClasses=ToolClasses;const ToolFlags$1={PRIVATE:1},UndoFlags$1={NO_UNDO:2,IS_UNDO_ROOT:4,UNDO_BARRIER:8,HAS_UNDO_DATA:16};class InheritFlag{constructor(t={}){this.slots=t}}let modalstack=[],defaultUndoHandlers={undoPre(t){throw new Error("implement me")},undo(t){throw new Error("implement me")}};function setDefaultUndoHandlers(t,e){if(!t||!e)throw new Error("invalid parameters to setDefaultUndoHandlers");defaultUndoHandlers.undoPre=t,defaultUndoHandlers.undo=e}class ToolPropertyCache{constructor(){this.map=new Map,this.pathmap=new Map,this.accessors={},this.userSetMap=new Set,this.api=void 0,this.dstruct=void 0}static getPropKey(t,e,i){return i.apiname&&i.apiname.length>0?i.apiname:e}_buildAccessors(t,e,i,s,r){let a=t._getFinalToolDef();if(this.api=r,this.dstruct=s,!a.toolpath)return void console.warn("Bad tool property",t,"it's tooldef was missing a toolpath field");let n=a.toolpath.trim().split(".").filter((t=>t.trim().length>0)),o=this.accessors,l=s,h="";for(let t=0;t<n.length;t++){let e=n[t],i=e;0===t&&(i="accessors."+e),t>0&&(h+="."),h+=e,e in o||(o[e]={});let s=r.mapStruct(o[e],!0,e);e in l.pathmap||l.struct(i,e,e,s),l=s,this.pathmap.set(h,o[e]),o=o[e]}let c=void 0!==i.apiname&&i.apiname.length>0?i.apiname:e,d=i.copy(),u=new DataPath(c,c,d),p=i.uiname;p&&0!==p.trim().length||(p=i.apiname),p&&0!==p.trim().length||(p=e),p=ToolProperty.makeUIName(p),d.uiname=p,d.description=d.description||d.uiname,l.add(u),o[c]=d.getValue()}_getAccessor(t){let e=t.tooldef().toolpath.trim();return this.pathmap.get(e)}useDefault(t,e,i){return e=(e=this.userSetMap.has(t.tooldef().trim()+"."+this.constructor.getPropKey(e))).trim()}has(t,e,i){if(i.flag&PropFlags$3.NO_DEFAULT)return!1;let s=this._getAccessor(t);return e=this.constructor.getPropKey(t,e,i),s&&e in s}get(t,e,i){if(t===ToolMacro)return;let s=this._getAccessor(t);return e=this.constructor.getPropKey(t,e,i),s?s[e]:void 0}set(t,e,i){if(t===ToolMacro)return;let s=t.tooldef().toolpath.trim(),r=this._getAccessor(t);if(r||(console.warn("Warning, toolop "+t.name+" was not in the default map; unregistered?"),this._buildAccessors(t,e,i,this.dstruct,this.api),r=this.pathmap.get(s)),!r)return void console.error("Malformed toolpath in toolop definition: "+s);r[e=this.constructor.getPropKey(t,e,i)]=i.copy().getValue();let a=s+"."+e;return this.userSetMap.add(a),this}}const SavedToolDefaults=new ToolPropertyCache;class ToolOp extends EventHandler{constructor(){super(),this._pointerId=void 0,this._overdraw=void 0,this.__memsize=void 0;var t=this.constructor.tooldef();for(var e in void 0!==t.undoflag&&(this.undoflag=t.undoflag),void 0!==t.flag&&(this.flag=t.flag),this._accept=this._reject=void 0,this._promise=void 0,t)this[e]=t[e];let i=(t,e)=>{if(void 0===t)return{};if(!(t instanceof InheritFlag))return t;t={};let i,s=this.constructor;for(;void 0!==s&&s!==Object&&s!==ToolOp&&s!==i;){if(s.tooldef){let i=s.tooldef();if(void 0!==i[e]){let s=i[e],r=!(s instanceof InheritFlag);s instanceof InheritFlag&&(s=s.slots);for(let e in s)e in t||(t[e]=s[e]);if(r)break}}i=s,s=s.prototype.__proto__.constructor}return t},s=i(t.inputs,"inputs"),r=i(t.outputs,"outputs");if(this.inputs={},this.outputs={},s)for(let t in s){let e=s[t].copy();if(e.apiname=e.apiname&&e.apiname.length>0?e.apiname:t,this.hasDefault(e,t)){try{e.setValue(this.getDefault(e,t))}catch(t){console.log(t.stack),console.log(t.message)}e.wasSet=!1,this.inputs[t]=e}else this.inputs[t]=e}if(r)for(let t in r){let e=r[t].copy();e.apiname=e.apiname&&e.apiname.length>0?e.apiname:t,this.outputs[t]=e}this.drawlines=[]}static tooldef(){if(this===ToolOp)throw new Error("Tools must implemented static tooldef() methods!");return{}}getInputs(){let t={};for(let e in this.inputs)t[e]=this.inputs[e].getValue();return t}static Equals(t,e){if(!t||!e)return!1;if(t.constructor!==e.constructor)return!1;let i=!1;for(let s in t.inputs)if(i=i||!(s in e.inputs),i=i||t.inputs[s].constructor!==e.inputs[s],i=i||!t.inputs[s].equals(e.inputs[s]),i)break;return!i}static inherit(t={}){return new InheritFlag(t)}static invoke(t,e){let i=new this;for(let t in e){if(!(t in i.inputs)){console.warn("Unknown tool argument "+t);continue}let s=i.inputs[t],r=e[t];if("string"==typeof r&&s.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){if(!(r in s.values)){console.warn("Possible invalid enum/flag:",r);continue}r=s.values[r]}i.inputs[t].setValue(r)}return i}static register(t){ToolClasses.indexOf(t)>=0?console.warn("Tried to register same ToolOp class twice:",t.name,t):ToolClasses.push(t)}static _regWithNstructjs(t,e=t.name){if(nstructjs.isRegistered(t))return;let i=t.prototype.__proto__.constructor;t.hasOwnProperty("STRUCT")||(i!==ToolOp&&i!==ToolMacro&&i!==Object&&this._regWithNstructjs(i),t.STRUCT=nstructjs.inherit(t,i)+"}\n"),nstructjs.register(t)}static isRegistered(t){return ToolClasses.indexOf(t)>=0}static unregister(t){ToolClasses.indexOf(t)>=0&&ToolClasses.remove(t)}static _getFinalToolDef(){let t=this.tooldef(),e=(t,e)=>{if(void 0===t)return{};if(!(t instanceof InheritFlag))return t;t={};let i=this;for(;void 0!==i&&i!==Object&&i!==ToolOp;){if(i.tooldef){let s=i.tooldef();if(void 0!==s[e]){let i=s[e],r=!(i instanceof InheritFlag);i instanceof InheritFlag&&(i=i.slots);for(let e in i)e in t||(t[e]=i[e]);if(r)break}}i=i.prototype.__proto__.constructor}return t},i=e(t.inputs,"inputs"),s=e(t.outputs,"outputs");return t.inputs=i,t.outputs=s,t}static onTick(){for(let t of modalstack)t.on_tick()}static searchBoxOk(t){let e=this.tooldef().flag,i=!(e&&e&ToolFlags$1.PRIVATE);return i=i&&this.canRun(t),i}static canRun(t,e){return!0}onUndoDestroy(){}calcMemSize(t){if(void 0!==this.__memsize)return this.__memsize;let e=0;for(let t=0;t<2;t++){let i=t?this.outputs:this.inputs;for(let t in i){let s=i[t],r=s.calcMemSize();!isNaN(r)&&isFinite(r)?e+=r:console.warn("Got NaN when calculating mem size for property",s)}}let i=this.calcUndoMem(t);return isNaN(i)||!isFinite(i)?console.warn("Got NaN in calcMemSize",this):e+=i,this.__memsize=e,e}loadDefaults(t=!0){for(let e in this.inputs){let i=this.inputs[e];!t&&i.wasSet||this.hasDefault(i,e)&&(i.setValue(this.getDefault(i,e)),i.wasSet=!1)}return this}hasDefault(t,e=t.apiname){return SavedToolDefaults.has(this.constructor,e,t)}getDefault(t,e=t.apiname){let i=this.constructor;return SavedToolDefaults.has(i,e,t)?SavedToolDefaults.get(i,e,t):t.getValue()}saveDefaultInputs(){for(let t in this.inputs){let e=this.inputs[t];e.flag&PropFlags$3.SAVE_LAST_VALUE&&SavedToolDefaults.set(this.constructor,t,e)}return this}genToolString(){let t=this.constructor.tooldef().toolpath+"(";for(let e in this.inputs){let i=this.inputs[e];t+=e+"=",i.type===PropTypes$8.STRING&&(t+="'"),i.type===PropTypes$8.FLOAT?t+=i.getValue().toFixed(3):t+=i.getValue(),i.type===PropTypes$8.STRING&&(t+="'"),t+=" "}return t+=")",t}on_tick(){}on_keydown(t){switch(t.keyCode){case keymap$4.Enter:case keymap$4.Space:this.modalEnd(!1);break;case keymap$4.Escape:this.modalEnd(!0)}}calcUndoMem(t){return console.warn("ToolOp.prototype.calcUndoMem: implement me!"),0}undoPre(t){throw new Error("implement me!")}undo(t){throw new Error("implement me!")}redo(t){this._was_redo=!0,this.undoPre(t),this.execPre(t),this.exec(t),this.execPost(t)}exec_pre(t){this.execPre(t)}execPre(t){}exec(t){}execPost(t){}resetTempGeom(){this.modal_ctx;for(var t of this.drawlines)t.remove();this.drawlines.length=0}error(t){console.warn(t)}getOverdraw(){return void 0===this._overdraw&&(this._overdraw=document.createElement("overdraw-x"),this._overdraw.start(this.modal_ctx.screen)),this._overdraw}makeTempLine(t,e,i){let s=this.getOverdraw().line(t,e,i);return this.drawlines.push(s),s}pushModal(t){throw new Error("cannot call this; use modalStart")}popModal(){throw new Error("cannot call this; use modalEnd")}modalStart(t){return this.modalRunning?(console.warn("Warning, tool is already in modal mode consuming events"),this._promise):(this.modal_ctx=t,this.modalRunning=!0,this._promise=new Promise(((e,i)=>{this._accept=e,this._reject=i,modalstack.push(this),void 0!==this._pointerId?super.pushPointerModal(t.screen,this._pointerId):super.pushModal(t.screen)})),this._promise)}toolCancel(){}modalEnd(t){this._modalstate&&modalstack.pop(),void 0!==this._overdraw&&(this._overdraw.end(),this._overdraw=void 0),t&&void 0!==this._on_cancel&&(this._accept&&this._accept(this.modal_ctx,!0),this._on_cancel(this),this._on_cancel=void 0),this.resetTempGeom();var e=this.modal_ctx;this.modal_ctx=void 0,this.modalRunning=!1,this.is_modal=!1,super.popModal(),this._promise=void 0,this._accept&&(this._accept(e,!1),this._accept=this._reject=void 0),this.saveDefaultInputs()}loadSTRUCT(t){t(this);let e=this.outputs,i=this.inputs;this.inputs={},this.outputs={};for(let t of i)this.inputs[t.key]=t.val;for(let t of e)this.outputs[t.key]=t.val}_save_inputs(){let t=[];for(let e in this.inputs)t.push(new PropKey(e,this.inputs[e]));return t}_save_outputs(){let t=[];for(let e in this.outputs)t.push(new PropKey(e,this.outputs[e]));return t}}ToolOp.STRUCT="\ntoolsys.ToolOp {\n  inputs  : array(toolsys.PropKey) | this._save_inputs();\n  outputs : array(toolsys.PropKey) | this._save_outputs();\n}\n",nstructjs.register(ToolOp);class PropKey{constructor(t,e){this.key=t,this.val=e}}PropKey.STRUCT="\ntoolsys.PropKey {\n  key : string;\n  val : abstract(ToolProperty);\n}\n",nstructjs.register(PropKey);class MacroLink{constructor(t,e,i="outputs",s,r,a="inputs"){this.source=t,this.dest=s,this.sourceProps=i,this.destProps=a,this.sourcePropKey=e,this.destPropKey=r}}MacroLink.STRUCT="\ntoolsys.MacroLink {\n  source         : int;\n  dest           : int;\n  sourcePropKey  : string;\n  destPropKey    : string;\n  sourceProps    : string;\n  destProps      : string; \n}\n",nstructjs.register(MacroLink);const MacroClasses={};window._MacroClasses=MacroClasses;let macroidgen=0;class ToolMacro extends ToolOp{constructor(){super(),this.tools=[],this.curtool=0,this.has_modal=!1,this.connects=[],this.connectLinks=[],this._macro_class=void 0}static tooldef(){return{uiname:"Tool Macro"}}static canRun(t,e){return!0}_getTypeClass(){if(this._macro_class&&this._macro_class.ready)return this._macro_class;if(this._macro_class||(this._macro_class=class extends ToolOp{static tooldef(){return this.__tooldef}},this._macro_class.__tooldef={toolpath:this.constructor.tooldef().toolpath||""},this._macro_class.ready=!1),!this.tools||0===this.tools.length)return this._macro_class;let t="";for(let e of this.tools)t=e.constructor.name+":";this.constructor!==ToolMacro&&(t+=":"+this.constructor.tooldef().toolpath);for(let e in this.inputs)t+=e+":";if(t in MacroClasses)return this._macro_class=MacroClasses[t],this._macro_class;let e,i="Macro(",s=0;for(let t of this.tools){let r=t.constructor.tooldef();s>0?i+=", ":e=r.is_modal,r.uiname?i+=r.uiname:r.toolpath?i+=r.toolpath:i+=t.constructor.name,s++}let r={};for(let t in this.inputs)r[t]=this.inputs[t].copy().clearEventCallbacks(),r[t].wasSet=!1;let a={uiname:i,toolpath:t,inputs:r,outputs:{},is_modal:e},n=this._macro_class;return n.__tooldef=a,n._macroTypeId=macroidgen++,n.ready=!0,MacroClasses[t]=n,n}saveDefaultInputs(){for(let t in this.inputs){let e=this.inputs[t];e.flag&PropFlags$3.SAVE_LAST_VALUE&&SavedToolDefaults.set(this._getTypeClass(),t,e)}return this}hasDefault(t,e=t.apiname){return SavedToolDefaults.has(this._getTypeClass(),e,t)}getDefault(t,e=t.apiname){let i=this._getTypeClass();return SavedToolDefaults.has(i,e,t)?SavedToolDefaults.get(i,e,t):t.getValue()}connect(t,e,i,s,r="outputs",a="inputs"){if("function"==typeof i)return this.connectCB(...arguments);let n=this.tools.indexOf(t),o=this.tools.indexOf(i);if(n<0||o<0)throw new Error("tool not in macro");if("inputs"===r){this.tools[n].inputs[e]===this.inputs[e]&&delete this.inputs[e]}if("inputs"===a){let t=this.tools[o].inputs[s];this.inputs[s]===t&&delete this.inputs[s]}return this.connectLinks.push(new MacroLink(n,e,r,o,s,a)),this}connectCB(t,e,i,s){return this.connects.push({srctool:t,dsttool:e,callback:i,thisvar:s}),this}add(t){t.is_modal&&(this.is_modal=!0);for(let e in t.inputs){let i=t.inputs[e];i.flag&PropFlags$3.PRIVATE||(this.inputs[e]=i)}return this.tools.push(t),this}_do_connections(t){let e=this.tools.indexOf(t);for(let i of this.connectLinks)if(i.source===e){this.tools[i.dest][i.destProps][i.destPropKey].setValue(t[i.sourceProps][i.sourcePropKey].getValue())}for(var i of this.connects)i.srctool===t&&i.callback.call(i.thisvar,i.srctool,i.dsttool)}modalStart(t){let e;for(this.loadDefaults(!1),this._promise=new Promise(function(t,e){this._accept=t,this._reject=e}.bind(this)),this.curtool=0,e=0;e<this.tools.length&&!this.tools[e].is_modal;e++)this.tools[e].undoPre(t),this.tools[e].execPre(t),this.tools[e].exec(t),this.tools[e].execPost(t),this._do_connections(this.tools[e]);var i=function e(){for(this._do_connections(this.tools[this.curtool]),this.curtool++;this.curtool<this.tools.length&&!this.tools[this.curtool].is_modal;)this.tools[this.curtool].undoPre(t),this.tools[this.curtool].execPre(t),this.tools[this.curtool].exec(t),this.tools[this.curtool].execPost(t),this._do_connections(this.tools[this.curtool]),this.curtool++;this.curtool<this.tools.length?(this.tools[this.curtool].undoPre(t),this.tools[this.curtool].modalStart(t).then(e)):this._accept(this,!1)}.bind(this);return e<this.tools.length&&(this.curtool=e,this.tools[this.curtool].undoPre(t),this.tools[this.curtool].modalStart(t).then(i)),this._promise}loadDefaults(t=!0){return super.loadDefaults(t)}exec(t){this.loadDefaults(!1);for(var e=0;e<this.tools.length;e++)this.tools[e].undoPre(t),this.tools[e].execPre(t),this.tools[e].exec(t),this.tools[e].execPost(t),this._do_connections(this.tools[e])}calcUndoMem(t){let e=0;for(let i of this.tools)e+=i.calcUndoMem(t);return e}calcMemSize(t){let e=0;for(let i of this.tools)e+=i.calcMemSize(t);return e}undoPre(){}undo(t){for(var e=this.tools.length-1;e>=0;e--)this.tools[e].undo(t)}}ToolMacro.STRUCT=nstructjs.inherit(ToolMacro,ToolOp,"toolsys.ToolMacro")+"\n  tools        : array(abstract(toolsys.ToolOp));\n  connectLinks : array(toolsys.MacroLink);\n}\n",nstructjs.register(ToolMacro);class ToolStack extends Array{constructor(t){super(),this.memLimit=536870912,this.enforceMemLimit=!1,this.cur=-1,this.ctx=t,this.modalRunning=0,this._undo_branch=void 0}get head(){return this[this.cur]}limitMemory(t=this.memLimit,e=this.ctx){if(void 0===t)throw new Error("maxmem cannot be undefined");let i=this.calcMemSize(),s=0;for(;s<this.cur-2&&i>t;)i-=this[s].calcMemSize(e),s++;if(0===s)return i;for(let t=0;t<s;t++)this[t].onUndoDestroy();this.cur-=s;for(let t=0;t<this.length-s;t++)this[t]=this[t+s];return this.length-=s,this.calcMemSize(e)}calcMemSize(t=this.ctx){let e=0;for(let t of this)try{e+=t.calcMemSize()}catch(t){print_stack$1(t),console.error("Failed to execute a calcMemSize method")}return e}setRestrictedToolContext(t){this.toolctx=t}reset(t){void 0!==t&&(this.ctx=t),this.modalRunning=0,this.cur=-1,this.length=0}execOrRedo(t,e,i=!1){let s=this.head,r=i?ToolOp.Equals(s,e):s&&s.constructor===e.constructor;return e.__memsize=void 0,r?(this.undo(),i?this.rerun():this.execTool(t,e),!1):(this.execTool(t,e),!0)}execTool(t,e){if(this.enforceMemLimit&&this.limitMemory(this.memLimit,t),!e.constructor.canRun(t,e))return void console.log("toolop.constructor.canRun returned false");let i=t.toLocked(),s=e.constructor.tooldef().undoflag;void 0!==e.undoflag&&(s=e.undoflag),s=void 0===s?0:s,e.execCtx=i,s&UndoFlags$1.NO_UNDO||(this.cur++,this._undo_branch=this.slice(this.cur+1,this.length),this.length=this.cur+1,this[this.cur]=e,e.undoPre(i)),e.is_modal?(t=e.modal_ctx=t,this.modal_running=!0,e._on_cancel=function(e){e.undoflag&UndoFlags$1.NO_UNDO||(this[this.cur].undo(t),this.pop_i(this.cur),this.cur--)}.bind(this),e.modalStart(t)):(e.execPre(i),e.exec(i),e.execPost(i),e.saveDefaultInputs())}toolCancel(t,e){if(!e._was_redo)if(e===this[this.cur]){if(this.undo(),this.length=this.cur+1,void 0!==this._undo_branch)for(let t of this._undo_branch)this.push(t)}else console.warn("toolCancel called in error",this,e)}undo(){if(this.enforceMemLimit&&this.limitMemory(this.memLimit),this.cur>=0&&!(this[this.cur].undoflag&UndoFlags$1.IS_UNDO_ROOT)){let t=this[this.cur];t.undo(t.execCtx),this.cur--}}rerun(t){this.enforceMemLimit&&this.limitMemory(this.memLimit),t===this[this.cur]?(t._was_redo=!1,t.execCtx||(t.execCtx=this.ctx),t.undo(t.execCtx),t._was_redo=!0,t.undoPre(t.execCtx),t.execPre(t.execCtx),t.exec(t.execCtx),t.execPost(t.execCtx)):console.warn("Tool wasn't at head of stack",t)}redo(){if(this.enforceMemLimit&&this.limitMemory(this.memLimit),this.cur>=-1&&this.cur+1<this.length){this.cur++;let t=this[this.cur];t.execCtx||(t.execCtx=this.ctx),t._was_redo=!0,t.redo(t.execCtx),t.saveDefaultInputs()}}save(){let t=[];return nstructjs.writeObject(t,this),t}rewind(){for(;this.cur>=0;){let t=this.cur;if(this.undo(),t===this.cur)break}return this}replay(t,e){this.cur;this.rewind();let i=this.cur,s=time_ms();return new Promise(((r,a)=>{let n=()=>{if(i=this.cur,t&&!1===t(ctx))r();else if(this.cur<this.length&&(this.cur++,this.rerun()),i===this.cur)console.warn("time:",(time_ms()-s)/1e3),r(this);else if(e){let t=e();t&&t instanceof Promise?t.then((()=>{n()})):window.setTimeout((()=>{n()}))}};n()}))}loadSTRUCT(t){t(this);for(let t of this._stack)this.push(t);delete this._stack}_save(){for(let t of this){let e=t.constructor;nstructjs.isRegistered(e)||e._regWithNstructjs(e)}return this}}function buildToolOpAPI(t,e){let i=t.mapStruct(e,!0),s=e._getFinalToolDef();function r(t){let e=s.inputs[t];if(e.flag&(PropFlags$3.PRIVATE|PropFlags$3.READ_ONLY))return;e.uiname=e.uiname||ToolProperty.makeUIName(t);let r=new DataPath(t,t,e);i.add(r),r.customGetSet((function(){return this.dataref.inputs[t].getValue()}),(function(e){this.dataref.inputs[t].setValue(e)}))}window.DEBUG&&window.DEBUG.datapaths&&console.log("Building api for ",s.toolpath);for(let t in s.inputs)r(t);return i}function buildToolSysAPI(t,e=!0,i,s,r=!0){let a=t.mapStruct(ToolPropertyCache,!0);for(let e of ToolClasses){let i=e._getFinalToolDef();buildToolOpAPI(t,e);for(let s in i.inputs){let r=i.inputs[s];r.flag&(PropFlags$3.PRIVATE|PropFlags$3.READ_ONLY)||SavedToolDefaults._buildAccessors(e,s,r,a,t)}}if(i&&(i.struct("toolDefaults","toolDefaults","Tool Defaults",t.mapStruct(ToolPropertyCache)),i.dynamicStruct("last_tool","last_tool","Last Tool")),s&&r){let t=new s({});function n(e){return Reflect.ownKeys(t).indexOf(e)>=0||Reflect.ownKeys(s.prototype).indexOf(e)>=0}n("last_tool")||(Object.defineProperty(s.prototype,"last_tool",{get(){return this.toolstack.head}}),Context.isContextSubclass(s)&&(s.prototype.last_tool_save=()=>({}),s.prototype.last_tool_load=()=>{})),n("toolDefaults")||(Object.defineProperty(s.prototype,"toolDefaults",{get:()=>SavedToolDefaults}),Context.isContextSubclass(s)&&(s.prototype.toolDefaults_save=()=>({}),s.prototype.toolDefaults_load=()=>{}))}if(e)for(let t of ToolClasses)try{nstructjs.isRegistered(t)||ToolOp._regWithNstructjs(t)}catch(t){console.log(t.stack),console.error("Failed to register a tool with nstructjs")}}ToolStack.STRUCT="\ntoolsys.ToolStack {\n  cur    : int;\n  _stack : array(abstract(toolsys.ToolOp)) | this._save();\n}\n",nstructjs.register(ToolStack),window._testToolStackIO=function(){let t=[],e=_appstate.toolstack.constructor;nstructjs.writeObject(t,_appstate.toolstack),t=new DataView(new Uint8Array(t).buffer);let i=nstructjs.readObject(t,e);return _appstate.toolstack.rewind(),i.cur=-1,i.ctx=_appstate.toolstack.ctx,_appstate.toolstack=i,i};let Vector2$a=Vector2$b;const SplineTemplates={CONSTANT:0,LINEAR:1,SHARP:2,SQRT:3,SMOOTH:4,SMOOTHER:5,SHARPER:6,SPHERE:7,REVERSE_LINEAR:8,GUASSIAN:9},templates={[SplineTemplates.CONSTANT]:[[1,1],[1,1]],[SplineTemplates.LINEAR]:[[0,0],[1,1]],[SplineTemplates.SHARP]:[[0,0],[.9999,1e-4],[1,1]],[SplineTemplates.SQRT]:[[0,0],[.05,.25],[.15,.45],[.33,.65],[1,1]],[SplineTemplates.SMOOTH]:["DEG",3,[0,0],[1/3,0],[2/3,1],[1,1]],[SplineTemplates.SMOOTHER]:["DEG",6,[0,0],[1/2.25,0],[2/3,1],[1,1]],[SplineTemplates.SHARPER]:[[0,0],[.3,.03],[.7,.065],[.9,.16],[1,1]],[SplineTemplates.SPHERE]:[[0,0],[.01953,.23438],[.08203,.43359],[.18359,.625],[.35938,.81641],[.625,.97656],[1,1]],[SplineTemplates.REVERSE_LINEAR]:[[0,1],[1,0]],[SplineTemplates.GUASSIAN]:["DEG",5,[0,0],[.17969,.007],[.48958,.01172],[.77995,.99609],[1,1]]},SplineTemplateIcons={};let RecalcFlags$1={BASIS:1,FULL:2,ALL:3,FULL_BASIS:4};function mySafeJSONStringify$1(t){return JSON.stringify(t.toJSON(),(function(t){let e=this[t];return"number"==typeof e&&(e=e!==Math.floor(e)?parseFloat(e.toFixed(5)):e),e}))}function mySafeJSONParse$1(t){return JSON.parse(t,((t,e)=>{}))}window.mySafeJSONStringify=mySafeJSONStringify$1;let bin_cache={};window._bin_cache=bin_cache;let eval2_rets=cachering.fromConstructor(Vector2$a,32);function bez3$1(t,e,i,s){let r=t+(e-t)*s;return r+(e+(i-e)*s-r)*s}function bez4$1(t,e,i,s,r){let a=bez3$1(t,e,i,r);return a+(bez3$1(e,i,s,r)-a)*r}function binomial(t,e){if(e>t)throw new Error("Bad call to binomial(n, i), i was > than n");if(0===e||e===t)return 1;let i=t+","+e;if(i in bin_cache)return bin_cache[i];let s=binomial(t-1,e-1)+bin(t-1,e);return bin_cache[i]=s,s}window.bin=binomial;class Curve1dBSplineOpBase extends ToolOp{static tooldef(){return{inputs:{dataPath:new StringProperty},outputs:{}}}_undo=void 0;undoPre(t){let e=this.getCurve1d(t);this._undo=e?e.copy():void 0}undo(t){let e=this.getCurve1d(t);e&&(e.load(this._undo),e._fireEvent("update",e))}getCurve1d(t){let e,{dataPath:i}=this.getInputs();try{e=t.api.getValue(t,i)}catch(t){return console.error(t.stack),console.error(t.message),void console.error("Failed to lookup curve1d property at path ",i)}return e}execPost(t){let e=this.getCurve1d(t);e&&e._fireEvent("update",e)}}class Curve1dBSplineResetOp extends Curve1dBSplineOpBase{static tooldef(){return{toolpath:"curve1d.reset_bspline",inputs:ToolOp.inherit({}),outputs:{}}}exec(t){let e=this.getCurve1d(t);e&&e.generators.active.reset()}}ToolOp.register(Curve1dBSplineResetOp);class Curve1dBSplineLoadTemplOp extends Curve1dBSplineOpBase{static tooldef(){return{toolpath:"curve1d.bspline_load_template",inputs:ToolOp.inherit({template:new EnumProperty$9(SplineTemplates.SMOOTH,SplineTemplates)}),outputs:{}}}exec(t){let e=this.getCurve1d(t),{template:i}=this.getInputs();e&&e.generators.active.loadTemplate(i)}}ToolOp.register(Curve1dBSplineLoadTemplOp);class Curve1dBSplineDeleteOp extends Curve1dBSplineOpBase{static tooldef(){return{toolpath:"curve1d.bspline_delete_point",inputs:ToolOp.inherit({}),outputs:{}}}exec(t){let e=this.getCurve1d(t);e&&e.generators.active.deletePoint()}}ToolOp.register(Curve1dBSplineDeleteOp);class Curve1dBSplineSelectOp extends Curve1dBSplineOpBase{static tooldef(){return{toolpath:"curve1d.bspline_select_point",inputs:ToolOp.inherit({point:new IntProperty(-1),state:new BoolProperty(!0),unique:new BoolProperty(!0)}),outputs:{}}}exec(t){let e=this.getCurve1d(t);if(e){let t=e.generators.active,{point:i,state:s,unique:r}=this.getInputs();for(let e of t.points)e.eid===i?s?e.flag|=CurveFlags.SELECT:e.flag&=~CurveFlags.SELECT:r&&(e.flag&=~CurveFlags.SELECT);e._fireEvent("select",t)}}}ToolOp.register(Curve1dBSplineSelectOp);class Curve1dBSplineAddOp extends Curve1dBSplineOpBase{static tooldef(){return{toolpath:"curve1d.bspline_add_point",inputs:ToolOp.inherit({x:new FloatProperty,y:new FloatProperty}),outputs:{}}}exec(t){let e=this.getCurve1d(t);if(e){let{x:t,y:i}=this.getInputs();e.generators.active.addFromMouse(t,i)}}}ToolOp.register(Curve1dBSplineAddOp);class BSplineTransformOp extends ToolOp{constructor(){super(),this.first=!0,this.start_mpos=new Vector2$a}static tooldef(){return{toolpath:"curve1d.transform_bspline",inputs:{dataPath:new StringProperty,off:new Vec2Property,dpi:new FloatProperty(1)},is_modal:!0,outputs:{}}}_undo=void 0;storePoints(t){let e=this.getCurve1d(t);if(e){let t=e.generators.active;return Array.from(t.points).map((t=>t.copy()))}return[]}loadPoints(t,e){let i=this.getCurve1d(t);if(i){let t=i.generators.active;for(let i of t.points)for(let t of e)t.eid===i.eid&&(i.co.load(t.co),i.rco.load(t.rco),i.sco.load(t.sco));t.parent._fireEvent("transform",t),t.recalc=RecalcFlags$1.ALL,t.updateKnots(),t.update(),t.redraw()}}undoPre(t){this._undo=this.storePoints(t)}undo(t){this.loadPoints(t,this._undo)}getCurve1d(t){let e,{dataPath:i}=this.getInputs();try{e=t.api.getValue(t,i)}catch(t){return console.error(t.stack),console.error(t.message),void console.error("Failed to lookup curve1d property at path ",i)}return e}finish(t=!1){let e=this.modal_ctx;this.modalEnd(t);let i=this.getCurve1d(e);i&&(i.generators.active.fastmode=!1),t&&this.undo(e)}on_pointerup(t){this.finish()}modalStart(t){super.modalStart(t);let e=this.getCurve1d(t);if(!e)return void console.log("Failed to get curve1d!");let i=e.generators.active;for(let t of i.points)t.startco.load(t.co)}on_pointermove(t){let e=(new Vector2$a).loadXY(t.x,t.y);if(this.first)return this.start_mpos.load(e),void(this.first=!1);let i=this.getCurve1d(this.modal_ctx);i&&(i.generators.active.fastmode=!0);const{dpi:s}=this.getInputs();let r=new Vector2$a(e).sub(this.start_mpos).mulScalar(s);r[1]=-r[1],this.inputs.off.setValue(r);const a=i.generators.active;for(let t of a.points)t.co.load(t.startco);this.exec(this.modal_ctx)}on_pointerdown(t){this.finish()}exec(t){let e=this.getCurve1d(t);if(!e)return;let i=e.generators.active,{off:s}=this.getInputs();const r=e.xRange,a=e.yRange;for(let t of i.points)t.flag&CurveFlags.SELECT&&(t.co.add(s),t.co[0]=Math.min(Math.max(t.co[0],r[0]),r[1]),t.co[1]=Math.min(Math.max(t.co[1],a[0]),a[1]));i.parent._fireEvent("transform",i),i.recalc=RecalcFlags$1.ALL,i.updateKnots(),i.update(),i.redraw()}}ToolOp.register(BSplineTransformOp);class Curve1DPoint{constructor(t){this.co=new Vector2$a(t),this.rco=new Vector2$a(t),this.sco=new Vector2$a(t),this.startco=new Vector2$a,this.eid=-1,this.flag=0,this.tangent=TangentModes.SMOOTH,Object.seal(this)}get 0(){throw new Error("Curve1DPoint get 0")}get 1(){throw new Error("Curve1DPoint get 1")}set 0(t){this.co[0]=t}set 1(t){this.co[1]=t}load(t){return this.eid=t.eid,this.flag=t.flag,this.tangent=t.tangent,this.co.load(t.co),this.rco.load(t.rco),this.sco.load(t.sco),this.startco.load(t.startco),this}set deg(t){console.warn("old file data detected")}static fromJSON(t){let e=new Curve1DPoint(t);return"0"in t?(e.co[0]=t[0],e.co[1]=t[1]):e.co.load(t.co),e.startco.load(t.startco),e.eid=t.eid,e.flag=t.flag,e.tangent=t.tangent,e.rco.load(t.rco),e}copy(){let t=new Curve1DPoint(this.co);return t.tangent=this.tangent,t.flag=this.flag,t.eid=this.eid,t.startco.load(this.startco),t.rco.load(this.rco),t.sco.load(this.sco),t}toJSON(){return{co:this.co,eid:this.eid,flag:this.flag,tangent:this.tangent,rco:this.rco,startco:this.startco}}loadSTRUCT(t){t(this),this.sco.load(this.co),this.rco.load(this.co),splineCache.update(this)}}Curve1DPoint.STRUCT="\nCurve1DPoint {\n  co      : vec2;\n  rco     : vec2;\n  sco     : vec2;\n  startco : vec2;\n  eid     : int;\n  flag    : int;\n  tangent : int;\n}\n",nstructjs.register(Curve1DPoint);let _udigest$3=new HashDigest;class BSplineCache{constructor(){this.curves=[],this.map=new Map,this.maxCurves=32,this.gen=0}limit(){if(!(this.curves.length<=this.maxCurves))for(this.curves.sort(((t,e)=>e.cache_w-t.cache_w));this.curves.length>this.maxCurves;){let t=this.curves.pop();this.map.delete(t.calcHashKey())}}has(t){let e=this.map.get(t.calcHashKey());return e&&e.equals(t)}get(t){let e=t.calcHashKey();t._last_cache_key=e;let i=this.map.get(e);return i&&i.equals(t)?(i.cache_w=this.gen++,i):(i=t.copy(),i._last_cache_key=e,i.updateKnots(),i.regen_basis(),i.regen_hermite(),this.map.set(i),this.curves.push(i),i.cache_w=this.gen++,this.limit(),i)}_remove(t){let e=this.map.get(t);this.map.delete(t),this.curves.remove(e)}update(t){let e=t._last_cache_key;this.map.has(e)&&(this._remove(t),this.get(t))}}let splineCache=new BSplineCache;window._splineCache=splineCache;let _idgen$1=1;class BSplineCurve extends CurveTypeData{constructor(){super(),this._bid=_idgen$1++,this._degOffset=0,this.cache_w=0,this._last_cache_key=0,this.fastmode=!1,this.points=[],this.length=0,this.interpolating=!1,this._ps=[],this.hermite=[],this.fastmode=!1,this.deg=6,this.recalc=RecalcFlags$1.ALL,this.basis_tables=[],this.eidgen=new IDGen,this.add(0,0),this.add(1,1),this.mpos=new Vector2$a,this.on_mousedown=this.on_mousedown.bind(this),this.on_mousemove=this.on_mousemove.bind(this),this.on_mouseup=this.on_mouseup.bind(this),this.on_keydown=this.on_keydown.bind(this),this.on_touchstart=this.on_touchstart.bind(this),this.on_touchmove=this.on_touchmove.bind(this),this.on_touchend=this.on_touchend.bind(this),this.on_touchcancel=this.on_touchcancel.bind(this)}get hasGUI(){return void 0!==this.uidata}static define(){return{uiname:"B-Spline",name:"bspline",typeName:"BSplineCurve"}}calcHashKey(t=_udigest$3.reset()){let e=t;super.calcHashKey(e),e.add(this.deg),e.add(this.interpolating),e.add(this.points.length);for(let t of this.points){let i=~~(1024*t.co[0]),s=~~(1024*t.co[1]);e.add(i),e.add(s),e.add(t.tangent)}return e.get()}copyTo(t){t.deg=this.deg,t.interpolating=this.interpolating,t.fastmode=this.fastmode;for(let e of this.points){let i=e.copy();t.points.push(i)}return t}copy(){let t=new BSplineCurve;return this.copyTo(t),t}equals(t){if(t.type!==this.type)return!1;let e=this.points.length!==t.points.length;if(e=e||this.deg!==t.deg,e=e||this.interpolating!==t.interpolating,e)return!1;for(let e=0;e<this.points.length;e++){let i=this.points[e],s=t.points[e];if(i.co.vectorDistance(s.co)>1e-5)return!1;if(i.tangent!==s.tangent)return!1}return!0}remove(t){let e=this.points.remove(t);return this.length=this.points.length,e}add(t,e,i=!1){let s=new Curve1DPoint;return this.recalc=RecalcFlags$1.ALL,s.eid=this.eidgen.next(),s.co.loadXY(t,e),s.sco.load(s.co),s.rco.load(s.co),this.points.push(s),i||this.update(),this.length=this.points.length,s}update(){super.update()}_sortPoints(){if(!this.interpolating)for(let t=0;t<this.points.length;t++)this.points[t].rco.load(this.points[t].co);return this.points.sort((function(t,e){return t.co[0]-e.co[0]})),this}updateKnots(t=!0,e=this.points){if(t&&(this.recalc=RecalcFlags$1.ALL),this._sortPoints(),this._ps=[],e.length<2)return;e[0].co[0],e[e.length-1].co[0];let i=this.deg;this._degOffset=-this.deg;for(let t=0;t<e.length-1;t++)this._ps.push(e[t]);if(i){let t=e.length-1;for(let s=0;s<i;s++){let i=e[t].copy();this._ps.push(i)}}if(!this.interpolating)for(let t=0;t<this._ps.length;t++)this._ps[t].rco.load(this._ps[t].co);for(let t=0;t<e.length;t++){let i=e[t],s=i.co[0],r=i.co[1];i.sco[0]=s,i.sco[1]=r}}toJSON(){this._sortPoints();let t=super.toJSON();return t=Object.assign(t,{points:this.points.map((t=>t.toJSON())),deg:this.deg,interpolating:this.interpolating,eidgen:this.eidgen.toJSON()}),t}loadJSON(t){super.loadJSON(t),this.interpolating=t.interpolating,this.deg=t.deg,this.length=0,this.points=[],this._ps=[],t.range&&(this.range=[new Vector2$a(t.range[0]),new Vector2$a(t.range[1])]),this.hightlight=void 0,this.eidgen=IDGen.fromJSON(t.eidgen),this.recalc=RecalcFlags$1.ALL,this.mpos=[0,0];for(let e=0;e<t.points.length;e++)this.points.push(Curve1DPoint.fromJSON(t.points[e]));return this.updateKnots(),this.redraw(),this}basis(t,e){if(this.recalc&RecalcFlags$1.FULL_BASIS)return this._basis(t,e);this.recalc&RecalcFlags$1.BASIS&&(this.regen_basis(),this.recalc&=~RecalcFlags$1.BASIS),e=Math.min(Math.max(e,0),this._ps.length-1),t=.999999999*Math.min(Math.max(t,0),1);let i=this.basis_tables[e],s=t*(i.length/4)*.99999,r=~~s;return s-=r,r*=4,bez4$1(i[r],i[r+1],i[r+2],i[r+3],s)}reset(t=!1){return this.length=0,this.points=[],this._ps=[],t||(this.add(0,0,!0),this.add(1,1,!0)),this.recalc=1,this.updateKnots(),this.update(),this.redraw(),this}regen_hermite(t){if(splineCache.has(this))return console.log("loading spline approx from cached bspline data"),void(this.hermite=splineCache.get(this).hermite);void 0===t&&(t=this.fastmode?120:340),this.interpolating&&(t*=2),this.hermite=new Array(t);let e,i,s=this.hermite,r=1e-5,a=.99995999/(t-1),n=4*r;for(let o=0;o<t;o++,n+=a){this._evaluate(n-2*r);let a=this._evaluate(n-r),l=this._evaluate(n),h=this._evaluate(n+r),c=(this._evaluate(n+2*r),(h-a)/(2*r));if(c/=t,o>0){let t=o-1;s[4*t]=i,s[4*t+1]=i+e/3,s[4*t+2]=l-c/3,s[4*t+3]=l}e=c,i=l}}solve_interpolating(){for(let t of this._ps)t.rco.load(t.co);this.points.concat(this.points);this._evaluate2(.5);let t=t=>this._evaluate(t.co[0])-t.co[1],e=e=>t(e),i=0,s=new Vector2$a;for(let t=0;t<25;t++){i=0;for(let t of this._ps){let r=e(t);const a=1e-6;if(i+=Math.abs(r),t===this._ps[this._ps.length-1])continue;s.zero();for(let i=0;i<2;i++){let n=t.rco[i];t.rco[i]+=a;let o=e(t);t.rco[i]=n,s[i]=(o-r)/a}let n=s.dot(s);if(n<1e-8)continue;r/=n;let o=.5;t.rco[0]+=-r*s[0]*o,t.rco[1]+=-r*s[1]*o}if(i<(this.fastmode?.001:5e-5))break}}regen_basis(){if(splineCache.has(this))return console.log("loading from cached bspline data"),void(this.basis_tables=splineCache.get(this).basis_tables);let t=this.fastmode?64:128;this.interpolating&&(t*=2),this.basis_tables=new Array(this._ps.length);for(let e=0;e<this._ps.length;e++){let i=this.basis_tables[e]=new Array(4*(t-1)),s=1e-5,r=(1-8*s)/(t-1),a=4*s,n=0,o=0;for(let s=0;s<t;s++,a+=r){let r,l=this._basis(a,e);if(r=this._dbasis(a,e),isNaN(r)&&(console.log("NaN!"),r=this._dbasis(a,e)),r/=t,s>0){let t=s-1;i[4*t]=o,i[4*t+1]=o+n/3,i[4*t+2]=l-r/3,i[4*t+3]=l}n=r,o=l}}}_dbasis(t,e){let i=this._ps.length,s=this._ps;function r(t){return 0===t?0:1/t}function a(t,e,n){let o=Math.min(Math.max(e+1,0),i-1),l=Math.min(Math.max(e+n,0),i-1),h=Math.min(Math.max(e+n+1,0),i-1),c=Math.min(Math.max(e,0),i-1);if(0===n)return t>=s[c].rco[0]&&t<s[o].rco[0]?1:0;{let i=(t-s[c].rco[0])*r(s[l].rco[0]-s[c].rco[0]+1e-4),d=(s[h].rco[0]-t)*r(s[h].rco[0]-s[o].rco[0]+1e-4);return i*a(t,e,n-1)+d*a(t,e+1,n-1)}}let n=this.deg;return function t(e,r,n){let o=Math.min(Math.max(r+1,0),i-1),l=Math.min(Math.max(r+n,0),i-1),h=Math.min(Math.max(r+n+1,0),i-1),c=Math.min(Math.max(r,0),i-1);if(o=s[o].rco[0],l=s[l].rco[0],h=s[h].rco[0],c=s[c].rco[0],0===n)return 0;{let i=(c-l)*(o-h);return 0===i?0:(((c-e)*t(e,r,n-1)-a(e,r,n-1))*(o-h)-((h-e)*t(e,r+1,n-1)-a(e,r+1,n-1))*(c-l))/i}}(t,e+this._degOffset,n)}_basis(t,e){let i=this._ps.length,s=this._ps;function r(t){return 0===t?0:1/t}this._ps[e].rco;let a=this.deg,n=function t(e,a,n){Math.min(Math.max(a-1,0),i-1);let o=Math.min(Math.max(a+1,0),i-1),l=Math.min(Math.max(a+n,0),i-1),h=Math.min(Math.max(a+n+1,0),i-1),c=Math.min(Math.max(a,0),i-1);if(0===n)return e>=s[c].rco[0]&&e<s[o].rco[0]?1:0;{let i=(e-s[c].rco[0])*r(s[l].rco[0]-s[c].rco[0]+1e-4),d=(s[h].rco[0]-e)*r(s[h].rco[0]-s[o].rco[0]+1e-4);return i*t(e,a,n-1)+d*t(e,a+1,n-1)}}(t,e+this._degOffset,a);return n}evaluate(t){if(0===this.points.length)return 0;let e=this.points[0].rco,i=this.points[this.points.length-1].rco;if(t<e[0])return e[1];if(t>i[0])return i[1];if(2===this.points.length)return t=(t-e[0])/(i[0]-e[0]),e[1]+(i[1]-e[1])*t;this.recalc&&(this.regen_basis(),this.interpolating&&this.solve_interpolating(),this.regen_hermite(),this.recalc=0),t*=.999999;let s=this.hermite,r=t*(s.length/4),a=Math.floor(r);return r-=a,a*=4,s[a]+(s[a+3]-s[a])*r}_evaluate(t){let e=t;if(0===this.points.length)return 0;let i,s,r,a=this.points[0].rco[0],n=this.points[this.points.length-1].rco[0],o=this.fastmode?16:32,l=a,h=(n-a)/(o-1);for(let t=0;t<o;t++,l+=h){let t=this._evaluate2(l),a=Math.abs(t[0]-e);(void 0===r||a<r)&&(r=a,i=t[1],s=l)}let c=s-h,d=s+h;l=s;for(let t=0;t<16;t++){let t=this._evaluate2(l);t[0]>e?d=l:c=l,l=.5*(c+d),i=t[1]}return void 0===i&&(i=0),i}_evaluate2(t){let e=eval2_rets.next();t*=.9999999;let i=0,s=0,r=0;for(let e=0;e<this._ps.length;e++){let a=this._ps[e].rco,n=this.basis(t,e);i+=n*a[0],s+=n*a[1],r+=n}return 0!==r&&(i/=r,s/=r),e[0]=i,e[1]=s,e}_wrapTouchEvent(t){return{x:t.touches.length?t.touches[0].pageX:this.mpos[0],y:t.touches.length?t.touches[0].pageY:this.mpos[1],button:0,shiftKey:t.shiftKey,altKey:t.altKey,ctrlKey:t.ctrlKey,isTouch:!0,commandKey:t.commandKey,stopPropagation:()=>t.stopPropagation(),preventDefault:()=>t.preventDefault()}}on_touchstart(t){this.mpos[0]=t.touches[0].pageX,this.mpos[1]=t.touches[0].pageY;let e=this._wrapTouchEvent(t);this.on_mousemove(e),this.on_mousedown(e)}loadTemplate(t){if(void 0!==t&&templates[t]){t=templates[t],this.reset(!0),this.deg=3;for(let e=0;e<t.length;e++){let i=t[e];"DEG"!==i?this.add(i[0],i[1],!0):(this.deg=t[e+1],e++)}this.recalc=1,this.updateKnots(),this.update(),this.redraw(),this.parent&&this.parent._fireEvent("update",this.parent)}else console.warn("Unknown bspline template",t)}on_touchmove(t){this.mpos[0]=t.touches[0].pageX,this.mpos[1]=t.touches[0].pageY;let e=this._wrapTouchEvent(t);this.on_mousemove(e)}on_touchend(t){this.on_mouseup(this._wrapTouchEvent(t))}on_touchcancel(t){this.on_touchend(t)}deletePoint(){for(let t=0;t<this.points.length;t++){let e=this.points[t];e.flag&CurveFlags.SELECT&&(this.points.remove(e),t--)}this.updateKnots(),this.update(),this.regen_basis(),this.recalc=RecalcFlags$1.ALL,this.redraw()}makeGUI(t,e,i,s,r){let a;console.warn(this._bid,"makeGUI",this.uidata,this.uidata?this.uidata.start_mpos:void 0),this.uidata&&(a=this.uidata.start_mpos),this.uidata={start_mpos:new Vector2$a(a),transpoints:[],dom:t,canvas:e,g:e.g,transforming:!1,draw_trans:i,datapath:s},console.warn("Building gui"),e.addEventListener("touchstart",this.on_touchstart),e.addEventListener("touchmove",this.on_touchmove),e.addEventListener("touchend",this.on_touchend),e.addEventListener("touchcancel",this.on_touchcancel),e.addEventListener("mousedown",this.on_mousedown),e.addEventListener("mousemove",this.on_mousemove),e.addEventListener("mouseup",this.on_mouseup),e.addEventListener("keydown",this.on_keydown);let n=t.row().strip(),o=(t,e)=>{let i=e[0]+e.slice(1,e.length).toLowerCase();i=i.replace(/_/g," ");let a=t.iconbutton(-1,i,(()=>{s?(l.ctx.api.execTool(l.ctx,"curve1d.bspline_load_template",{dataPath:s,template:SplineTemplates[e]}),r()):this.loadTemplate(SplineTemplates[e])}));a.iconsheet=0,a.customIcon=SplineTemplateIcons[e]};for(let t in SplineTemplates)o(n,t);let l=t.row(),h=()=>{this.updateKnots(),this.update(),this.regen_basis(),this.recalc=RecalcFlags$1.ALL,this.redraw()},c=l.constructor.getIconEnum(),d=void 0!==c.LARGE_X?c.LARGE_X:c.TINY_X;void 0===c.LARGE_X&&(console.log(c),console.error("Curve widget expects Icons.LARGE_X icon for delete button.")),l.iconbutton(d,"Delete Point",(()=>{s?l.ctx.api.execTool(l.ctx,"curve1d.bspline_delete_point",{dataPath:s}):this.deletePoint(),r(),h()})),l.button("Reset",(()=>{s?(l.ctx.api.execTool(l.ctx,"curve1d.reset_bspline",{dataPath:s}),r()):this.reset()}));let u=l.simpleslider(void 0,{name:"Degree",min:1,max:7,isInt:!0,callback:t=>{this.deg=Math.floor(t.value),h()}});u.setValue(this.deg);let p=this.deg;u.update.after((()=>{p!==this.deg&&(console.log("degree update",this.deg),p=this.deg,u.setValue(this.deg))})),u.baseUnit="none",u.displayUnit="none",l=t.row();let m=l.check(void 0,"Interpolating");return m.checked=this.interpolating,m.onchange=()=>{this.interpolating=m.value,h()},this}killGUI(t,e){if(void 0!==this.uidata){this.uidata;this.uidata=void 0,e.removeEventListener("touchstart",this.on_touchstart),e.removeEventListener("touchmove",this.on_touchmove),e.removeEventListener("touchend",this.on_touchend),e.removeEventListener("touchcancel",this.on_touchcancel),e.removeEventListener("mousedown",this.on_mousedown),e.removeEventListener("mousemove",this.on_mousemove),e.removeEventListener("mouseup",this.on_mouseup),e.removeEventListener("keydown",this.on_keydown)}return this}start_transform(t=!0){let e=1/this.uidata.draw_trans[0];for(let t of this.points)t.startco.load(t.co);let i=new BSplineTransformOp;i.inputs.dataPath.setValue(this.uidata.datapath),i.inputs.dpi.setValue(e),this.uidata.dom.ctx.api.execTool(this.uidata.dom.ctx,i)}on_mousedown(t){this.uidata.start_mpos.load(this.transform_mpos(t.x,t.y)),this.fastmode=!0;let e=this.transform_mpos(t.x,t.y),i=e[0],s=e[1];if(this.do_highlight(i,s),void 0!==this.points.highlight){if(t.shiftKey)this.points.highlight.flag^=CurveFlags.SELECT;else{for(let t=0;t<this.points.length;t++)this.points[t].flag&=~CurveFlags.SELECT;this.points.highlight.flag|=CurveFlags.SELECT}if(this.uidata.datapath){let e=!t.shiftKey||!(this.points.highlight.flag&CurveFlags.SELECT);this.uidata.dom.ctx.api.execTool(this.uidata.dom.ctx,"curve1d.bspline_select_point",{dataPath:this.uidata.datapath,state:e,unique:!t.shiftKey,point:this.points.highlight.eid})}this.start_transform(),this.updateKnots(),this.update(),this.redraw()}else{let t=this.uidata;if(this.uidata.datapath){let t=this.uidata.start_mpos;this.uidata.dom.ctx.api.execTool(this.uidata.dom.ctx,"curve1d.bspline_add_point",{dataPath:this.uidata.datapath,x:t[0],y:t[1]})}else this.addFromMouse(this.uidata.start_mpos[0],this.uidata.start_mpos[1]),this.parent._fire("update",this.parent);this.updateKnots(),this.update(),this.redraw(),this.uidata=t,this.start_transform()}}load(t){if(this!==t){this.recalc=RecalcFlags$1.ALL,this.length=t.points.length,this.points.length=0,this.eidgen=t.eidgen.copy(),this.deg=t.deg,this.interpolating=t.interpolating;for(let e of t.points){let i=new Curve1DPoint;i.load(e),e===t.points.highlight&&(this.points.highlight=i),this.points.push(i)}return this.updateKnots(),this.update(),this.redraw(),this}}addFromMouse(t,e){let i=this.add(t,e);i.startco.load(i.co),this.points.highlight=i;for(let t of this.points)t.flag&=~CurveFlags.SELECT;i.flag|=CurveFlags.SELECT,this.updateKnots(),this.update(),this.redraw(),this.points.highlight.flag|=CurveFlags.SELECT}do_highlight(t,e){let i,s=1e17,r=19/this.uidata.draw_trans[0],a=r*r;for(let r=0;r<this.points.length;r++){let n=this.points[r],o=t-n.sco[0],l=e-n.sco[1],h=o*o+l*l;h<s&&h<a&&(s=h,i=n)}this.points.highlight!==i&&(this.points.highlight=i,this.redraw())}do_transform(t,e){let i=new Vector2$a([t,e]).sub(this.uidata.start_mpos),s=this.parent.xRange,r=this.parent.yRange;for(let t=0;t<this.uidata.transpoints.length;t++){let e=this.uidata.transpoints[t];e.co.load(e.startco).add(i),e.co[0]=Math.min(Math.max(e.co[0],s[0]),s[1]),e.co[1]=Math.min(Math.max(e.co[1],r[0]),r[1])}this.updateKnots(),this.update(),this.redraw()}transform_mpos(t,e){let i=this.uidata.canvas.getClientRects()[0],s=devicePixelRatio;t-=parseInt(i.left),e-=parseInt(i.top),t*=s,e*=s;let r=this.uidata.draw_trans;return[t=t/r[0]-r[1][0],e=-e/r[0]-r[1][1]]}on_mousemove(t){t.isTouch&&this.uidata.transforming&&t.preventDefault();let e=this.transform_mpos(t.x,t.y),i=e[0],s=e[1];this.uidata.transforming?(this.do_transform(i,s),this.evaluate(.5)):this.do_highlight(i,s)}end_transform(){this.uidata.transforming=!1,this.fastmode=!1,this.updateKnots(),this.update(),splineCache.update(this)}on_mouseup(t){this.end_transform()}on_keydown(t){switch(t.keyCode){case 88:case 46:void 0!==this.points.highlight&&(this.points.remove(this.points.highlight),this.recalc=RecalcFlags$1.ALL,this.points.highlight=void 0,this.updateKnots(),this.update(),void 0!==this._save_hook&&this._save_hook())}}draw(t,e,i){if(e.save(),void 0===this.uidata)return;this.uidata.canvas=t,this.uidata.g=e,this.uidata.draw_trans=i;i[0],i[1];e.lineWidth*=1.5;let s=e.strokeStyle;e.strokeStyle=s,e.lineWidth/=3;let r=.03;for(let t of this.points)e.beginPath(),t===this.points.highlight?e.fillStyle="green":t.flag&CurveFlags.SELECT?e.fillStyle="red":e.fillStyle="orange",e.rect(t.sco[0]-r/2,t.sco[1]-r/2,r,r),e.fill();e.restore()}loadSTRUCT(t){if(t(this),super.loadSTRUCT(t),this.highlightPoint>=0){for(let t of this.points)t.eid===this.highlightPoint&&(this.points.highlight=t);delete this.highlightPoint}this.updateKnots(),this.recalc=RecalcFlags$1.ALL}}function makeSplineTemplateIcons(t=64){let e=devicePixelRatio;t=~~(t*e);for(let i in SplineTemplates){let s=new BSplineCurve;s.loadTemplate(SplineTemplates[i]),s.fastmode=!0;let r=document.createElement("canvas");r.width=r.height=t;let a=r.getContext("2d"),n=64;s.update();let o=.5;a.translate(-.5,-.5),a.scale(t*o,t*o),a.translate(.5,.5);let l=0,h=t=>1-2*Math.abs(Math.fract(t)-.5);for(let t=0;t<n;t++){let e=t/(n-1),i=1-s.evaluate(h(e));e=e*(1-2*l)+l,i=i*(1-2*l)+l,0===t?a.moveTo(e,i):a.lineTo(e,i)}const c=7;a.lineCap="round",a.strokeStyle="black",a.lineWidth=3*c*e/(t*o),a.stroke(),a.strokeStyle="white",a.lineWidth=c*e/(t*o),a.stroke();let d=r.toDataURL(),u=document.createElement("img");u.src=d,SplineTemplateIcons[i]=u,SplineTemplateIcons[SplineTemplates[i]]=u}}BSplineCurve.STRUCT=nstructjs.inherit(BSplineCurve,CurveTypeData)+"\n  points         : array(Curve1DPoint);\n  highlightPoint : int | this.points.highlight ? this.points.highlight.eid : -1;\n  deg            : int;\n  eidgen         : IDGen;\n  interpolating  : bool;\n}\n",nstructjs.register(BSplineCurve),CurveTypeData.register(BSplineCurve);let splineTemplatesLoaded=!1;function initSplineTemplates(){if(!splineTemplatesLoaded){splineTemplatesLoaded=!0;for(let t in SplineTemplates){console.log("Loading spline template",t);let e=new BSplineCurve;e.loadTemplate(SplineTemplates[t]),splineCache.get(e)}makeSplineTemplateIcons(),window._SplineTemplateIcons=SplineTemplateIcons}}function mySafeJSONStringify(t){return JSON.stringify(t.toJSON(),(function(t){let e=this[t];return"number"==typeof e&&(e=e!==Math.floor(e)?parseFloat(e.toFixed(5)):e),e}))}function mySafeJSONParse(t){return JSON.parse(t,((t,e)=>{}))}window.setTimeout((()=>{config.autoLoadSplineTemplates&&initSplineTemplates()}),0),window.mySafeJSONStringify=mySafeJSONStringify;let _udigest$2=new HashDigest;class Curve1D{constructor(){this._eventCBs=[],this.uiZoom=1,this.xRange=(new Vector2$b).loadXY(0,1),this.yRange=(new Vector2$b).loadXY(0,1),this.clipToRange=!1,this.generators=[],this.VERSION=CURVE_VERSION;for(let t of CurveConstructors)t=new t,t.parent=this,this.generators.push(t);this.setGenerator("bspline")}get generatorType(){return this.generators.active?this.generators.active.type:void 0}get fastmode(){return this._fastmode}set fastmode(t){this._fastmode=t;for(let e of this.generators)e.fastmode=t}on(t,e,i,s){void 0===s&&(s=()=>!1),this._eventCBs.push({type:t,cb:e,owner:i,dead:s,once:!1})}off(t,e){this._eventCBs=this._eventCBs.filter((t=>t.cb!==t))}once(t,e,i,s){this.on(t,e,i,s),this._eventCBs[this._eventCBs.length-1].once=!0}subscribed(t,e){for(let i of this._eventCBs)if((!t||i.type===t)&&i.owner===e)return!0;return!1}_pruneEventCallbacks(){this._eventCBs=this._eventCBs.filter((t=>!t.dead()))}_fireEvent(t,e){this._pruneEventCallbacks();for(let i=0;i<this._eventCBs.length;i++){let s=this._eventCBs[i];if(s.type===t){try{s.cb(e)}catch(t){console.error(t.stack),console.error(t.message)}s.once&&(this._eventCBs.remove(s),i--)}}}calcHashKey(t=_udigest$2.reset()){let e=t;for(let t of this.generators)t.calcHashKey(e);return e.get()}equals(t){let e=this.generators.active,i=t.generators.active;return!(!e||!i||e.constructor!==i.constructor)&&e.equals(i)}load(t){if(void 0===t||t===this)return this;let e=nstructjs.writeJSON(t,Curve1D),i=nstructjs.readJSON(e,Curve1D),s=i.generators.active.constructor,r=this.generators;this.generators=i.generators;for(let t of i.generators){for(let e of r)if(e.constructor===t.constructor&&void 0!==e.load){i.generators[i.generators.indexOf(t)]=e,e.constructor===s&&(this.generators.active=e),e.parent=this,e.load(t),t=e;break}t.constructor===s&&(this.generators.active=t),t.parent=this}for(let t in e){if("generators"===t)continue;if(t.startsWith("_"))continue;let e=i[t];"number"==typeof e||"boolean"==typeof e||"string"==typeof e?this[t]=e:(e instanceof Vector2$b||e instanceof Vector3$2||e instanceof Vector4$2||e instanceof Matrix4$2)&&this[t].load(e)}return this._on_change(),this.redraw(),this}copy(){let t=nstructjs.writeJSON(this,Curve1D);return nstructjs.readJSON(t,Curve1D)}_on_change(){}redraw(){this._fireEvent("draw",this)}setGenerator(t){for(let e of this.generators)if(e.constructor.define().name===t||e.type===t||e.constructor.define().typeName===t||e.constructor===t)return this.generators.active&&this.generators.active.onInactive(),this.generators.active=e,void e.onActive();throw new Error("unknown curve type "+t)}toJSON(){let t={generators:[],uiZoom:this.uiZoom,VERSION:this.VERSION,active_generator:this.generatorType,xRange:this.xRange,yRange:this.yRange,clipToRange:this.clipToRange};for(let e of this.generators)t.generators.push(e.toJSON());return t.generators.sort(((t,e)=>t.type.localeCompare(e.type))),t}getGenerator(t,e=!0){for(let e of this.generators)if(e.type===t)return e;for(let e of CurveConstructors)if(e.define().typeName===t){let i=new e;return i.type=t,i.parent=this,this.generators.push(i),i}if(e)throw new Error("Unknown generator "+t+".")}switchGenerator(t){let e=this.getGenerator(t);if(e!==this.generators.active){let t=this.generators.active;this.generators.active=e,t.onInactive(this),e.onActive(this)}return e}destroy(){return this}loadJSON(t){this.VERSION=t.VERSION,this.uiZoom=parseFloat(t.uiZoom)||this.uiZoom,t.xRange&&(this.xRange=new Vector2$b(t.xRange)),t.yRange&&(this.yRange=new Vector2$b(t.yRange)),this.clipToRange=Boolean(t.clipToRange);for(let e of t.generators){let i=this.getGenerator(e.type,!1);i&&i instanceof CurveTypeData?(i.parent=void 0,i.reset(),i.loadJSON(e),i.parent=this,e.type===t.active_generator&&(this.generators.active=i)):(console.warn("Bad curve generator class:",i),i&&this.generators.remove(i))}return this.VERSION<1.1&&this.#t(),this}evaluate(t){let e;this.clipToRange&&(t=Math.min(Math.max(t,this.xRange[0]),this.xRange[1]));try{e=this.generators.active.evaluate(t)}catch(t){e=0,console.warn(t.stack),console.warn(t.message)}return this.clipToRange&&(e=Math.min(Math.max(e,this.yRange[0]),this.yRange[1])),e}integrate(t,e){return this.generators.active.integrate(t,e)}derivative(t){return this.generators.active.derivative(t)}derivative2(t){return this.generators.active.derivative2(t)}inverse(t){return this.generators.active.inverse(t)}reset(){this.generators.active.reset()}update(){return this.generators.active.update()}draw(t,e,i){let s=t.width;t.height;e.save();let r=i[0];i[1];e.beginPath(),e.moveTo(-1,0),e.lineTo(1,0),e.strokeStyle="red",e.stroke(),e.beginPath(),e.moveTo(0,-1),e.lineTo(0,1),e.strokeStyle="green",e.stroke();let a=this.xRange[0],n=(this.xRange[1]-this.xRange[0])/63;s=6/r;this.generators.active;e.beginPath();for(let t=0;t<64;t++,a+=n){let i=this.evaluate(a);(0===t?e.moveTo:e.lineTo).call(e,a,i,s,s)}if(e.strokeStyle="grey",e.stroke(),void 0!==this.overlay_curvefunc){e.beginPath(),a=this.xRange[0];for(let t=0;t<64;t++,a+=n){let i=this.overlay_curvefunc(a);(0===t?e.moveTo:e.lineTo).call(e,a,i,s,s)}e.strokeStyle="green",e.stroke()}return this.generators.active.draw(t,e,i),e.restore(),this}loadSTRUCT(t){if(this.generators=[],t(this),this.VERSION<=.75){this.generators=[];for(let t of CurveConstructors)this.generators.push(new t);this.generators.active=this.getGenerator("BSplineCurve")}for(let t of this.generators.concat([]))t instanceof CurveTypeData?t.type===this._active&&(this.generators.active=t):(console.warn("Bad generator data found:",t),this.generators.remove(t));for(let t of this.generators)t.parent=this;this.VERSION<1.1&&this.#t(),delete this._active,this.VERSION=CURVE_VERSION}#t(){let t=this.getGenerator("BSplineCurve").range;t&&(this.xRange.load(t[0]),this.yRange.load(t[1]))}}Curve1D.STRUCT="\nCurve1D {\n  generators  : array(abstract(CurveTypeData));\n  _active     : string | obj.generators.active.type;\n  VERSION     : float;\n  uiZoom      : float;\n  xRange      : vec2;\n  yRange      : vec2;\n  clipToRange : bool;\n}\n",nstructjs.register(Curve1D);class Task{constructor(t){this.task=t,this.start=time_ms(),this.done=!1}}class AnimManager{constructor(){this.tasks=[],this.timer=void 0,this.timeOut=1e4}stop(){void 0!==this.timer&&(window.clearInterval(this.timer),this.timer=void 0)}add(t){this.tasks.push(new Task(t))}remove(t){for(let e of this.tasks)if(e.task===t)return e.dead=!0,void this.tasks.remove(e)}start(){this.timer=window.setInterval((()=>{for(let t of this.tasks){try{t.task()}catch(e){t.done=!0,print_stack$1(e)}time_ms()-t.start>this.timeOut&&(t.dead=!0)}for(let t=0;t<this.tasks.length;t++)if(this.tasks[t].done){let e=this.tasks[t];this.tasks.remove(e),t--;try{e.task.onend&&e.task.onend()}catch(t){print_stack$1(t)}}}),25)}}const manager=new AnimManager;manager.start();class AbstractCommand{constructor(){this.cbs=[],this.end_cbs=[]}start(t,e){}exec(t,e){}}class WaitCommand extends AbstractCommand{constructor(t){super(),this.ms=t}start(t,e){this.time=t.time}exec(t,e){t.time-this.time>this.ms&&e()}}class GoToCommand extends AbstractCommand{constructor(t,e,i,s,r="ease"){super(),this.object=t,this.key=e,this.value=i,this.ms=s,this.curve="string"==typeof r?new(getCurve(r)):r}start(t,e){this.time=t.time;let i=this.object[this.key];Array.isArray(i)?this.startValue=list$2(i):this.startValue=i}exec(t,e){let i=t.time-this.time,s=this.ms;if(i>s&&(e(),i=s),i/=s,i=this.curve.evaluate(i),Array.isArray(this.startValue)){let t=this.object[this.key];for(let e=0;e<this.startValue.length;e++)void 0!==t[e]&&void 0!==this.value[e]&&(t[e]=this.startValue[e]+(this.value[e]-this.startValue[e])*i)}else this.object[this.key]=this.startValue+(this.value-this.startValue)*i}}class SetCommand extends AbstractCommand{constructor(t,e,i){super(),this.object=t,this.key=e,this.value=i}start(t,e){this.object[key]=val,e()}}class Command{constructor(t,e){this.args=e,this.cbs=[]}}class Animator{constructor(t,e="update"){this.on_tick=this.on_tick.bind(this),this.on_tick.onend=()=>{this.onend&&this.onend()},this.commands=[],this.owner=t,this._done=!1,this.method=e,this.onend=null,this.first=!0,this.time=0,this.last=time_ms(),this.bind(t)}bind(t){this._done=!1,this.owner=t,manager.add(this.on_tick)}wait(t){return this.commands.push(new WaitCommand(t)),this}goto(t,e,i,s="ease"){let r=new GoToCommand(this.owner,t,e,i,s);return this.commands.push(r),this}set(t,e,i){let s=new SetCommand(this.owner,t,e);return this.commands.push(s),this}while(t){return this.commands[this.commands.length-1].cbs.push(t),this}then(t){return this.commands[this.commands.length-1].end_cbs.push(t),this}end(){this._done||(this._done=!0,manager.remove(this.on_tick),this.onend&&this.onend())}on_tick(){if(this._done)throw new Error("animation wasn't properly cleaned up");let t=time_ms()-this.last;if(this.time+=t,this.last=time_ms(),0===this.commands.length)return void this.end();let e=this.commands[0],i=!1;function s(){i=!0}this.first&&(this.first=!1,e.start(this,s));try{e.exec(this,s)}catch(t){i=!0,print_stack$1(t)}for(let t of this.commands[0].cbs)try{t()}catch(t){print_stack$1(t)}if(i){for(let t of this.commands[0].end_cbs)try{t()}catch(t){print_stack$1(t)}for(;this.commands.length>0&&(this.commands.shift(),i=!1,this.commands.length>0&&this.commands[0].start(this,s),i););}}}class token{constructor(t,e,i,s,r,a,n){this.type=t,this.value=e,this.lexpos=i,this.lexlen=s,this.lineno=r,this.lexer=a,this.parser=n}setValue(t){return this.value=t,this}toString(){return void 0!==this.value?"token(type="+this.type+", value='"+this.value+"')":"token(type="+this.type+")"}}class tokdef{constructor(t,e,i){this.name=t,this.re=e,this.func=i}}class PUTLParseError$1 extends Error{}class lexer$1{constructor(t,e){this.tokdef=t,this.tokens=new Array,this.lexpos=0,this.lexdata="",this.lineno=0,this.errfunc=e,this.tokints={},this.print_tokens=!1,this.print_debug=!1;for(let e=0;e<t.length;e++)this.tokints[t[e].name]=e;this.statestack=[["__main__",0]],this.states={__main__:[t,e]},this.statedata=0}copy(){let t=new lexer$1(this.tokdef,this.errfunc);for(let e in this.states){let i=this.states[e];i=[i[0],i[1]],t.states[e]=i}return t.statedata=this.statedata,t}add_state(t,e,i){void 0===i&&(i=function(t){return!0}),this.states[t]=[e,i]}tok_int(t){}push_state(t,e){this.statestack.push([t,e]),t=this.states[t],this.statedata=e,this.tokdef=t[0],this.errfunc=t[1]}pop_state(){let t=this.statestack[this.statestack.length-1],e=this.states[t[0]];this.tokdef=e[0],this.errfunc=e[1],this.statedata=t[1]}input(t){for(;this.statestack.length>1;)this.pop_state();this.lexdata=t,this.lexpos=0,this.lineno=0,this.tokens=new Array,this.peeked_tokens=[]}error(){if(void 0!==this.errfunc&&!this.errfunc(this))return;console.log("Syntax error near line "+this.lineno);let t=Math.min(this.lexpos+8,this.lexdata.length);throw console.log("  "+this.lexdata.slice(this.lexpos,t)),new PUTLParseError$1("Parse error")}peek(){let t=this.next(!0);if(void 0!==t)return this.peeked_tokens.push(t),t}peek_i(t){for(;this.peeked_tokens.length<=t;){if(void 0===this.peek())return}return this.peeked_tokens[t]}at_end(){return this.lexpos>=this.lexdata.length&&0===this.peeked_tokens.length}next(t){if(!0!==t&&this.peeked_tokens.length>0){let t=this.peeked_tokens[0];return this.print_debug&&console.log("PEEK_SHIFTING",""+t),this.peeked_tokens.shift(),this.print_tokens&&console.log(t.toString()),t}if(this.lexpos>=this.lexdata.length)return;let e=this.tokdef,i=e.length,s=this.lexdata.slice(this.lexpos,this.lexdata.length),r=[];for(let t=0;t<i;t++){let i=e[t];if(void 0===i.re)continue;let a=i.re.exec(s);null!=a&&0===a.index&&r.push([i,a])}let a,n=0;for(let t=0;t<r.length;t++){let e=r[t];e[1][0].length>n&&(a=e,n=e[1][0].length)}if(void 0===a)return void this.error();let o=a[0],l=n,h=new token(o.name,a[1][0],this.lexpos,l,this.lineno,this,void 0);return this.lexpos+=n,o.func&&(h=o.func(h),void 0===h)?this.next(t):(this.print_tokens&&console.log(h.toString()),!t&&this.print_debug&&console.log("CONSUME",h.toString(),"\n"+getTraceBack()),h)}}function getTraceBack(t,e){try{throw new Error}catch(i){let s=i.stack.split("\n");s=s.slice(1,s.length),void 0===e&&(e=0);for(let t=0;t<s.length;t++){let i=s[t],r=i.length-1;for(;r>0&&"/"!==i[r];)r--;let a=r;for(;a>=0&&"("!==i[a];)a--;let n=i.slice(0,a).trim(),o=i.slice(r+1,i.length-1);i=`  ${n} (${o})`,i.search(/parseutil\.js/)>=0&&(e=Math.max(e,t)),s[t]=i}return void 0!==t&&(s.length=Math.min(s.length,t)),void 0!==e&&(s=s.slice(e,s.length)),s=s.join("\n"),s}}class parser{constructor(t,e){this.lexer=t,this.errfunc=e,this.start=void 0,this.userdata=void 0}copy(){let t=new parser(this.lexer.copy(),this.errfunc);return t.start=this.start,t}parse(t,e){void 0===e&&(e=!0),void 0!==t&&this.lexer.input(t);let i=this.start(this);return e&&!this.lexer.at_end()&&void 0!==this.lexer.next()&&this.error(void 0,"parser did not consume entire input"),i}input(t){this.lexer.input(t)}error(t,e){let i;void 0===e&&(e=""),i=void 0===t?"Parse error at end of input: "+e:"Parse error at line "+(t.lineno+1)+": "+e;let s="1| ",r=this.lexer.lexdata,a=1;for(let t=0;t<r.length;t++){let e=r[t];"\n"===e?(a++,s+="\n"+a+"| "):s+=e}if(console.log("------------------"),console.log(s),console.log("=================="),console.log(i),!this.errfunc||this.errfunc(t))throw new PUTLParseError$1(i)}peek(){let t=this.lexer.peek();return void 0!==t&&(t.parser=this),t}peek_i(t){let e=this.lexer.peek_i(t);return void 0!==e&&(e.parser=this),e}peeknext(){return this.peek_i(0)}next(){let t=this.lexer.next();return void 0!==t&&(t.parser=this),t}optional(t){let e=this.peek_i(0);return!(!e||e.type!==t)&&(this.next(),!0)}at_end(){return this.lexer.at_end()}expect(t,e){let i=this.next();return void 0===e&&(e=t),void 0!==i&&i.type==t||this.error(i,"Expected "+e+", not "+i.type),i.value}}function test_parser(){let t=new set(["int","float","double","vec2","vec3","vec4","mat4","string"]),e=new set(["int","float","double","vec2","vec3","vec4","mat4","string","static_string","array"]);function i(t,e,i){return new tokdef(t,e,i)}let s=[i("ID",/[a-zA-Z]+[a-zA-Z0-9_]*/,(function(t){return e.has(t.value)&&(t.type=t.value.toUpperCase()),t})),i("OPEN",/\{/),i("CLOSE",/}/),i("COLON",/:/),i("JSCRIPT",/\|/,(function(t){let e="",i=t.lexer;for(;i.lexpos<i.lexdata.length;){let t=i.lexdata[i.lexpos];if("\n"===t)break;e+=t,i.lexpos++}return e.endsWith(";")&&(e=e.slice(0,e.length-1),i.lexpos--),t.value=e,t})),i("LPARAM",/\(/),i("RPARAM",/\)/),i("COMMA",/,/),i("NUM",/[0-9]/),i("SEMI",/;/),i("NEWLINE",/\n/,(function(t){t.lexer.lineno+=1})),i("SPACE",/ |\t/,(function(t){}))];for(let t in e)s.push(i(t.toUpperCase()));let r,n=new lexer$1(s,(function(t){return!0}));for(console.log("Testing lexical scanner..."),n.input(a);r=n.next();)console.log(r.toString());let o=new o(n);function l(e){let i=e.peek();return"ID"===i.type?(e.next(),{type:"struct",data:'"'+i.value+'"'}):t.has(i.type.toLowerCase())?(e.next(),{type:i.type.toLowerCase()}):"ARRAY"===i.type?function(t){t.expect("ARRAY"),t.expect("LPARAM");let e=l(t),i="";return t.optional("COMMA")&&(i=e,e=l(t)),t.expect("RPARAM"),{type:"array",data:{type:e,iname:i}}}(e):void e.error(i,"invalid type "+i.type)}function h(t){let e={};console.log("-----",t.peek().type),e.name=t.expect("ID","struct field name"),t.expect("COLON"),e.type=l(t),e.set=void 0,e.get=void 0;let i=t.peek();return"JSCRIPT"===i.type&&(e.get=i.value,t.next()),i=t.peek(),"JSCRIPT"===i.type&&(e.set=i.value,t.next()),t.expect("SEMI"),e}o.input(a);let c=function(t){let e={};for(e.name=t.expect("ID","struct name"),e.fields=[],t.expect("OPEN");;)if(t.at_end())t.error(void 0);else{if(t.optional("CLOSE"))break;e.fields.push(h(t))}return e}(o);console.log(JSON.stringify(c))}var parseutil=Object.freeze({__proto__:null,token:token,tokdef:tokdef,PUTLParseError:PUTLParseError$1,lexer:lexer$1,getTraceBack:getTraceBack,parser:parser});let ToolPaths={};var initToolPaths_run=!1;function buildParser(){let t=(t,e,i)=>new tokdef(t,e,i),e=[t("ID",/[a-zA-Z_$]+[a-zA-Z0-9_$]*/,(t=>("true"!=t.value&&"false"!=t.value||(t.type="BOOL",t.value="true"==t.value),t))),t("LPAREN",/\(/),t("RPAREN",/\)/),t("LSBRACKET",/\[/),t("RSBRACKET",/\]/),t("DOT",/\./),t("COMMA",/\,/),t("EQUALS",/\=/),t("STRLIT",/"[^"]*"/,(t=>(t.value=t.value.slice(1,t.value.length-1),t))),t("STRLIT",/'[^']*'/,(t=>(t.value=t.value.slice(1,t.value.length-1),t))),t("NUMBER",/-?[0-9]+/,(t=>(t.value=parseInt(t.value),t))),t("NUMBER",/-?[0-9]+\.[0-9]*/,(t=>(t.value=parseFloat(t.value),t))),t("WS",/[ \n\r\t]/,(t=>{}))],i={STRLIT:1,NUMBER:1,BOOL:1};let s=new lexer$1(e,(t=>(console.warn("Parse error"),!0))),r=new parser(s);return r.start=function(t){let e={};for(;!t.at_end();){let s=t.expect("ID");t.expect("EQUALS");let r=t.next();if(!(r.type in i))throw new PUTLParseError$1("parse error: unexpected "+r.type);e[s]=r.value}return e},r}let Parser=buildParser();function parseToolPath(t,e=!0){initToolPaths_run||(initToolPaths_run=!0,initToolPaths());let i,s=t,r=t.search(/\(/),a=t.search(/\)/),n="";if(r>=0&&a>=0&&(n=t.slice(r+1,a).trim(),t=t.slice(0,r).trim()),!(t in ToolPaths)&&e)throw new DataPathError("unknown tool "+t);try{i=Parser.parse(n)}catch(t){throw console.log(t),new DataPathError(`"${s}"\n  ${t.message}`)}return{toolclass:ToolPaths[t],args:i}}function testToolParser(){return parseToolPath("view3d.sometool(selectmode=1 str='str' bool=true)",!1)}function initToolPaths(){for(let t of ToolClasses){if(!t.hasOwnProperty("tooldef"))continue;let e=t.tooldef().toolpath;ToolPaths[e]=t}}window.parseToolPath=parseToolPath;class ModelInterface{constructor(){this.prefix=""}getToolDef(t){throw new Error("implement me")}getToolPathHotkey(t,e){}get list(){throw new Error("implement me")}createTool(t,e={},i){throw new Error("implement me")}parseToolPath(t){throw new Error("implement me")}execOrRedo(t,e,i=!1){return t.toolstack.execOrRedo(t,e,i)}execTool(t,e,i={},s,r){return new Promise(((a,n)=>{let o=e;try{"string"!=typeof o&&o instanceof ToolOp||(o=this.createTool(t,e,i,s))}catch(t){return print_stack$1(t),void n(t)}a(o);try{t.toolstack.execTool(t,o,r)}catch(t){throw print_stack$1(t),t}}))}pushReportContext(t){}popReportContext(){}static toolRegistered(t){throw new Error("implement me")}static registerTool(t){throw new Error("implement me")}massSetProp(t,e,i){throw new Error("implement me")}resolveMassSetPaths(t,e){throw new Error("implement me")}resolvePath(t,e,i,s){}setValue(t,e,i,s){let r=this.resolvePath(t,e,void 0,s),a=r.prop;if(void 0!==a&&a.flag&PropFlags$3.READ_ONLY)throw new DataPathError("Tried to set read only property");if(void 0!==a&&a.flag&PropFlags$3.USE_CUSTOM_GETSET){if(a.dataref=r.obj,a.ctx=t,a.datapath=e,void 0!==r.subkey){let t=a.getValue();"object"==typeof t&&(t=t.copy()),a.type===PropTypes$8.FLAG?(i?t|=a.values[r.subkey]:t&=~a.values[r.subkey],i=t):a.type===PropTypes$8.ENUM?i=a.values[r.subkey]:(t[r.subkey]=i,i=t)}return void a.setValue(i)}if(void 0!==a){if(a.type===PropTypes$8.CURVE&&!i)throw new DataPathError("can't set curve data to nothing");let t=a.type&(PropTypes$8.INT|PropTypes$8.FLOAT);t=t||r.subkey&&a.type&(PropTypes$8.VEC2|PropTypes$8.VEC3|PropTypes$8.VEC4),t=t&&a.range,t=t&&!(0===a.range[0]&&0===a.range[1]),t=t&&"number"==typeof i,t&&(i=Math.min(Math.max(i,a.range[0]),a.range[1]))}let n=r.obj[r.key];if(void 0!==r.subkey&&void 0!==r.prop&&r.prop.type===PropTypes$8.ENUM){let t=r.prop.values[r.subkey];i&&(r.obj[r.key]=t)}else if(void 0!==r.prop&&r.prop.type===PropTypes$8.FLAG)if(void 0!==r.subkey){let t=r.prop.values[r.subkey];i?r.obj[r.key]|=t:r.obj[r.key]&=~t}else{if("number"!=typeof i&&"boolean"!=typeof i)throw new DataPathError("Expected a number for a bitmask property");i="boolean"==typeof i?1&i:i,r.obj[r.key]=i}else if(void 0!==r.subkey&&isVecProperty(r.prop))""!==r.key?r.obj[r.key][r.subkey]=i:r.obj[r.subkey]=i;else if(""===r.key&&isVecProperty(r.prop))for(let t=0;t<r.obj.length;t++)r.obj[t]=i[t];else void 0!==a&&a instanceof ListIface||(r.obj[r.key]=i);void 0!==a&&a instanceof ListIface?a.set(this,r.obj,r.key,i):void 0!==a&&(a.dataref=r.obj,a.datapath=e,a.ctx=t,a._fire("change",r.obj[r.key],n))}getDescription(t,e){let i=this.resolvePath(t,e);if(void 0===i)throw new DataPathError("invalid path "+e);if(!(i.prop&&i.prop instanceof ToolProperty$1))return"";let s=i.prop.type,r=i.prop;if(void 0!==i.subkey){let t=i.subkey;if(s&(PropTypes$8.VEC2|PropTypes$8.VEC3|PropTypes$8.VEC4)){if(r.descriptions&&t in r.descriptions)return r.descriptions[t]}else if(s&(PropTypes$8.ENUM|PropTypes$8.FLAG)){if(!(t in r.values)&&t in r.keys&&(t=r.keys[t]),r.descriptions&&t in r.descriptions)return r.descriptions[t]}else if(s===PropTypes$8.PROPLIST){let t=tdef.value;if("object"==typeof t&&t instanceof ToolProperty$1)return t.description}}return i.prop.description?i.prop.description:i.prop.uiname}validPath(t,e,i){try{return this.getValue(t,e,i),!0}catch(t){if(!(t instanceof DataPathError))throw t}return!1}getPropName(t,e){let i=e.length-1;for(;i>=0&&"."!==e[i];)i--;if((e=e.slice(i+1,e.length).trim()).endsWith("]")){for(i=e.length-1;i>=0&&"["!==e[i];)i--;return e=e.slice(0,i).trim(),this.getPropName(t,e)}return e}getValue(t,e,i){if("string"==typeof t)throw new Error("You forgot to pass context to getValue");let s=this.resolvePath(t,e,void 0,i);if(void 0===s)throw new DataPathError("invalid path "+e);let r=void 0!==s.prop&&s.prop.flag&PropFlags$3.USE_CUSTOM_GETSET;if(r=r&&!(void 0!==s.prop&&s.prop.type&(PropTypes$8.VEC2|PropTypes$8.VEC3|PropTypes$8.VEC4|PropTypes$8.QUAT)),r){s.prop.dataref=s.obj,s.prop.datapath=e,s.prop.ctx=t;let i=s.prop.getValue();return"string"==typeof i&&s.prop.type&(PropTypes$8.FLAG|PropTypes$8.ENUM)&&(i=s.prop.values[i]),s.subkey&&s.prop.type===PropTypes$8.ENUM?i=i===s.prop.values[s.subkey]:s.subkey&&s.prop.type===PropTypes$8.FLAG&&(i&=s.prop.values[s.subkey]),i}return s.value}}class DataPathSetOp extends ToolOp{constructor(){super(),this.propType=-1,this._undo=void 0}setValue(t,e,i){let s=this.inputs.prop,r=this.inputs.dataPath.getValue();if(s.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){let e=t.api.resolvePath(t,r);if(void 0!==e.subkey){let t=e.subkey;"string"==typeof t&&(t=e.prop.values[t]),this.inputs.flagBit.setValue(t),this.inputs.useFlagBit.setValue(!0)}}s.dataref=i,s.ctx=t,s.datapath=r;try{s.setValue(e),this.hadError=!1}catch(t){console.error("Error setting datapath",r),this.hadError=!0}}static create(t,e,i,s,r){let a=t.api.resolvePath(t,e);if(void 0===a||void 0===a.prop)return void console.warn("DataPathSetOp failed",a,a.prop);let n=a.prop,o=new DataPathSetOp;o.propType=n.type,o.inputs.destType.setValue(n.type),n&&n.flag&PropFlags$3.USE_BASE_UNDO&&o.inputs.fullSaveUndo.setValue(!0);let l=PropTypes$8.FLAG|PropTypes$8.ENUM;if(l|=PropTypes$8.VEC2|PropTypes$8.VEC3|PropTypes$8.VEC4|PropTypes$8.QUAT,void 0!==a.subkey&&n.type&l){if(n.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){let t=e.length-1;for(;t>=0&&"["!==e[t]&&"="!==e[t];)t--;if(t>=0){if(!i&&n.type===PropTypes$8.ENUM)return;e=e.slice(0,t).trim()}o.inputs.prop=new IntProperty}else o.inputs.prop=new FloatProperty;let s=a.subkey;if("number"!=typeof s&&(s=a.prop.values[s]),n.type===PropTypes$8.FLAG&&(o.inputs.flagBit.setValue(s),o.inputs.useFlagBit.setValue(!0)),n.type===PropTypes$8.ENUM)i=s;else if(n.type===PropTypes$8.FLAG){let r=t.api.getValue(t,e);"number"!=typeof r&&(r="boolean"==typeof r?1&i:0),i?r|=s:r&=~s,i=r}}else o.inputs.prop=n.copy();return o.inputs.dataPath.setValue(e),r?o.inputs.massSetPath.setValue(r):o.inputs.massSetPath.setValue(""),o.id=s,o.setValue(t,i,a.obj),o}hash(t,e,i,s){return(t=null===(t=void 0===t?"":t)?"":t)+":"+e+":"+i+":"+s}hashThis(){return this.hash(this.inputs.massSetPath.getValue(),this.inputs.dataPath.getValue(),this.propType,this.id)}undoPre(t){if(this.inputs.fullSaveUndo.getValue())return super.undoPre(t);this.__ctx&&(t=this.__ctx),this._undo={};let e=new Set;if(this.inputs.massSetPath.getValue().trim()){let i=this.inputs.massSetPath.getValue().trim();e=new Set(t.api.resolveMassSetPaths(t,i))}e.add(this.inputs.dataPath.getValue());for(let i of e){let e=t.api.getValue(t,i);"object"==typeof e&&(e=e.copy()),this._undo[i]=e}}undo(t){if(this.__ctx&&(t=this.__ctx),this.inputs.fullSaveUndo.getValue())return super.undo(t);for(let e in this._undo){let i=t.api.resolvePath(t,e);if(void 0!==i.prop&&i.prop.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){let s=i.obj[i.key];if(i.subkey){let t=i.subkey;"number"!=typeof t&&(t=i.prop.values[t]),i.prop.type===PropTypes$8.FLAG?this._undo[e]?i.obj[i.key]|=t:i.obj[i.key]&=~t:i.obj[i.key]=t}else i.obj[i.key]=this._undo[e];i.prop.dataref=i.obj,i.prop.datapath=e,i.prop.ctx=t,i.prop._fire("change",i.obj[i.key],s)}else try{t.api.setValue(t,e,this._undo[e])}catch(t){print_stack$1(t),console.warn("Failed to set property in undo for DataPathSetOp")}}}exec(t){this.__ctx&&(t=this.__ctx);let e=this.inputs.dataPath.getValue(),i=this.inputs.massSetPath.getValue().trim();try{t.api.setValue(t,e,this.inputs.prop.getValue()),this.hadError=!1}catch(t){console.log(t.stack),console.log(t.message),console.log("error setting "+e),this.hadError=!0}if(i){let s=this.inputs.prop.getValue();if(this.inputs.useFlagBit.getValue()&&this.inputs.destType.getValue()===PropTypes$8.FLAG){s=!!(s&this.inputs.flagBit.getValue())}try{t.api.massSetProp(t,i,s)}catch(t){console.log(t.stack),console.log(t.message),console.log("error setting "+e),this.hadError=!0}}}modalStart(t){this.__ctx=t.toLocked(),super.modalStart(this.__ctx),this.exec(this.__ctx),this.modalEnd(!1)}static tooldef(){return{uiname:"Property Set",toolpath:"app.prop_set",icon:-1,flag:ToolFlags$1.PRIVATE,is_modal:!0,inputs:{dataPath:new StringProperty,massSetPath:new StringProperty,fullSaveUndo:new BoolProperty(!1),flagBit:new IntProperty,useFlagBit:new BoolProperty,destType:new EnumProperty$9(PropTypes$8.INT,PropTypes$8)}}}}ToolOp.register(DataPathSetOp);let _udigest$1=new HashDigest;function feq(t,e){return Math.abs(t-e)<1e-5}class EquationCurve extends CurveTypeData{constructor(t){super(),this.equation="x",this._last_equation="",this._last_xrange=new Vector2$b,this._func=void 0}get hasGUI(){return void 0!==this.uidata}static define(){return{uiname:"Equation",name:"equation",typeName:"EquationCurve"}}calcHashKey(t=_udigest$1.reset()){let e=t;return super.calcHashKey(e),e.add(this.equation),e.add(this.parent.xRange[0]),e.add(this.parent.xRange[1]),e.get()}equals(t){return super.equals(t)&&this.equation===t.equation}toJSON(){let t=super.toJSON();return Object.assign(t,{equation:this.equation})}loadJSON(t){return super.loadJSON(t),void 0!==t.equation&&(this.equation=t.equation),this}makeGUI(t,e,i){this.uidata={canvas:e,g:e.g,draw_trans:i};let s=t.row();(this.uidata.textbox=s.textbox(void 0,""+this.equation)).onchange=t=>{console.log(t),this.equation=t,this.update(),this.redraw()},t.label("Equation")}killGUI(t,e,i,s,r){void 0!==this.uidata&&this.uidata.textbox.remove(),this.uidata=void 0}updateTextBox(){this.uidata&&this.uidata.textbox&&(this.uidata.textbox.text=this.equation)}evaluate(t){let e=this.hermite||this._last_equation!==this.equation;return e=e||this._last_xrange.vectorDistance(this.parent.xRange)>0,e=e||!this._func,e&&(this._last_xrange.load(this.parent.xRange),this._last_equation=this.equation,this.updateTextBox(),this.#e(),this._evaluate(0),this._haserror)?(console.warn("ERROR!"),0):this._func(t)}#e(){this._func=void 0;var sin=Math.sin,cos=Math.cos,pi=Math.PI,PI=Math.PI,e=Math.E,E=Math.E,tan=Math.tan,abs=Math.abs,floor=Math.floor,ceil=Math.ceil,acos=Math.acos,asin=Math.asin,atan=Math.atan,cosh=Math.cos,sinh=Math.sinh,log=Math.log,pow=Math.pow,exp=Math.exp,sqrt=Math.sqrt,cbrt=Math.cbrt,min=Math.min,max=Math.max,func;let code=`\n    func = function(x) {\n      return ${this.equation};\n    }\n    `;try{eval(code),this._haserror=!1}catch(t){this._haserror=!0,console.warn("Compile error!",t.message)}this._func=func}_evaluate(t){try{let e=this._func(t);if(this._haserror=!1,isNaN(e))return 0}catch(t){return this._haserror=!0,console.warn("ERROR!"),0}}derivative(t){let e=1e-4;return t>.9997?(this.evaluate(t)-this.evaluate(t-e))/e:t<3*e?(this.evaluate(t+e)-this.evaluate(t))/e:(this.evaluate(t+e)-this.evaluate(t-e))/(2*e)}derivative2(t){let e=1e-4;return t>.9997?(this.derivative(t)-this.derivative(t-e))/e:t<3*e?(this.derivative(t+e)-this.derivative(t))/e:(this.derivative(t+e)-this.derivative(t-e))/(2*e)}inverse(t){let e,i,s=1/9,r=0;for(let a=0;a<9;a++,r+=s){let a,n=r,o=r+s;for(let e=0;e<11;e++){let e=this.evaluate(n),i=this.evaluate(o);a=.5*(n+o),Math.abs(e-t)<Math.abs(i-t)?o=a:n=a}let l=this.evaluate(a);(void 0===e||Math.abs(t-l)<e)&&(e=Math.abs(t-l),i=a)}return void 0===i?0:i}onActive(t,e){}onInactive(t,e){}reset(){this.equation="x"}destroy(){}draw(t,e,i){if(e.save(),this._haserror)return e.fillStyle=e.strokeStyle="rgba(255, 50, 0, 0.25)",e.beginPath(),e.rect(0,0,1,1),e.fill(),e.beginPath(),e.moveTo(0,0),e.lineTo(1,1),e.moveTo(0,1),e.lineTo(1,0),e.lineWidth*=3,e.stroke(),void e.restore();e.restore()}}EquationCurve.STRUCT=nstructjs.inherit(EquationCurve,CurveTypeData)+"\n  equation : string;\n}\n",nstructjs.register(EquationCurve),CurveTypeData.register(EquationCurve);class GuassianCurve extends CurveTypeData{constructor(t){super(),this.height=1,this.offset=1,this.deviation=.3}get hasGUI(){return void 0!==this.uidata}static define(){return{uiname:"Guassian",name:"guassian",typeName:"GuassianCurve"}}calcHashKey(t=_udigest$1.reset()){super.calcHashKey(t);let e=t;return e.add(this.height),e.add(this.offset),e.add(this.deviation),e.get()}equals(t){let e=super.equals(t);return e=e&&feq(this.height,t.height),e=e&&feq(this.offset,t.offset),e=e&&feq(this.deviation,t.deviation),e}toJSON(){let t=super.toJSON();return Object.assign(t,{height:this.height,offset:this.offset,deviation:this.deviation})}loadJSON(t){return super.loadJSON(t),this.height=void 0!==t.height?t.height:1,this.offset=t.offset,this.deviation=t.deviation,this}makeGUI(t,e,i){this.uidata={canvas:e,g:e.g,draw_trans:i},this.uidata.hslider=t.slider(void 0,"Height",this.height,-10,10,1e-4),this.uidata.hslider.onchange=()=>{this.height=this.uidata.hslider.value,this.redraw(),this.update()},this.uidata.oslider=t.slider(void 0,"Offset",this.offset,-10,10,1e-4),this.uidata.oslider.onchange=()=>{this.offset=this.uidata.oslider.value,this.redraw(),this.update()},this.uidata.dslider=t.slider(void 0,"STD Deviation",this.deviation,-10,10,1e-4),this.uidata.dslider.onchange=()=>{this.deviation=this.uidata.dslider.value,this.redraw(),this.update()}}killGUI(t,e,i,s,r){void 0!==this.uidata&&(this.uidata.hslider.remove(),this.uidata.oslider.remove(),this.uidata.dslider.remove()),this.uidata=void 0}evaluate(t){return this.height*Math.exp(-(t-this.offset)*(t-this.offset)/(2*this.deviation*this.deviation))}derivative(t){let e=1e-4;return t>.9997?(this.evaluate(t)-this.evaluate(t-e))/e:t<3*e?(this.evaluate(t+e)-this.evaluate(t))/e:(this.evaluate(t+e)-this.evaluate(t-e))/(2*e)}derivative2(t){let e=1e-4;return t>.9997?(this.derivative(t)-this.derivative(t-e))/e:t<3*e?(this.derivative(t+e)-this.derivative(t))/e:(this.derivative(t+e)-this.derivative(t-e))/(2*e)}inverse(t){let e,i,s=1/9,r=0;for(let a=0;a<9;a++,r+=s){let a,n=r,o=r+s;for(let e=0;e<11;e++){let e=this.evaluate(n),i=this.evaluate(o);a=.5*(n+o),Math.abs(e-t)<Math.abs(i-t)?o=a:n=a}let l=this.evaluate(a);(void 0===e||Math.abs(t-l)<e)&&(e=Math.abs(t-l),i=a)}return void 0===i?0:i}}function Ease(){throw"Ease cannot be instantiated."}function bez3(t,e,i,s){var r=t+(e-t)*s;return r+(e+(i-e)*s-r)*s}function bez4(t,e,i,s,r){var a=bez3(t,e,i,r);return a+(bez3(e,i,s,r)-a)*r}GuassianCurve.STRUCT=nstructjs.inherit(GuassianCurve,CurveTypeData)+"\n  height    : float;\n  offset    : float;\n  deviation : float;\n}\n",nstructjs.register(GuassianCurve),CurveTypeData.register(GuassianCurve),Ease.linear=function(t){return t},Ease.none=Ease.linear,Ease.get=function(t){return t<-1?t=-1:t>1&&(t=1),function(e){return 0==t?e:t<0?e*(e*-t+1+t):e*((2-e)*t+(1-t))}},Ease.getPowIn=function(t){return function(e){return Math.pow(e,t)}},Ease.getPowOut=function(t){return function(e){return 1-Math.pow(1-e,t)}},Ease.getPowInOut=function(t){return function(e){return(e*=2)<1?.5*Math.pow(e,t):1-.5*Math.abs(Math.pow(2-e,t))}},Ease.quadIn=Ease.getPowIn(2),Ease.quadOut=Ease.getPowOut(2),Ease.quadInOut=Ease.getPowInOut(2),Ease.cubicIn=Ease.getPowIn(3),Ease.cubicOut=Ease.getPowOut(3),Ease.cubicInOut=Ease.getPowInOut(3),Ease.quartIn=Ease.getPowIn(4),Ease.quartOut=Ease.getPowOut(4),Ease.quartInOut=Ease.getPowInOut(4),Ease.quintIn=Ease.getPowIn(5),Ease.quintOut=Ease.getPowOut(5),Ease.quintInOut=Ease.getPowInOut(5),Ease.sineIn=function(t){return 1-Math.cos(t*Math.PI/2)},Ease.sineOut=function(t){return Math.sin(t*Math.PI/2)},Ease.sineInOut=function(t){return-.5*(Math.cos(Math.PI*t)-1)},Ease.getBackIn=function(t){return function(e){return e*e*((t+1)*e-t)}},Ease.backIn=Ease.getBackIn(1.7),Ease.getBackOut=function(t){return function(e){return--e*e*((t+1)*e+t)+1}},Ease.backOut=Ease.getBackOut(1.7),Ease.getBackInOut=function(t){return t*=1.525,function(e){return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Ease.backInOut=Ease.getBackInOut(1.7),Ease.circIn=function(t){return-(Math.sqrt(1-t*t)-1)},Ease.circOut=function(t){return Math.sqrt(1- --t*t)},Ease.circInOut=function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},Ease.bounceIn=function(t){return 1-Ease.bounceOut(1-t)},Ease.bounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},Ease.bounceInOut=function(t){return t<.5?.5*Ease.bounceIn(2*t):.5*Ease.bounceOut(2*t-1)+.5},Ease.getElasticIn=function(t,e){var i=2*Math.PI;return function(s){if(0==s||1==s)return s;var r=e/i*Math.asin(1/t);return-t*Math.pow(2,10*(s-=1))*Math.sin((s-r)*i/e)}},Ease.elasticIn=Ease.getElasticIn(1,.3),Ease.getElasticOut=function(t,e){var i=2*Math.PI;return function(s){if(0==s||1==s)return s;var r=e/i*Math.asin(1/t);return t*Math.pow(2,-10*s)*Math.sin((s-r)*i/e)+1}},Ease.elasticOut=Ease.getElasticOut(1,.3),Ease.getElasticInOut=function(t,e){var i=2*Math.PI;return function(s){var r=e/i*Math.asin(1/t);return(s*=2)<1?t*Math.pow(2,10*(s-=1))*Math.sin((s-r)*i/e)*-.5:t*Math.pow(2,-10*(s-=1))*Math.sin((s-r)*i/e)*.5+1}},Ease.elasticInOut=Ease.getElasticInOut(1,.3*1.5);class ParamKey{constructor(t,e){this.key=t,this.val=e}}ParamKey.STRUCT="\nParamKey {\n  key : string;\n  val : float;\n}\n",nstructjs.register(ParamKey);let BOOL_FLAG=1e17,_udigest=new HashDigest;class SimpleCurveBase extends CurveTypeData{constructor(){super(),this.type=this.constructor.name;let t=this.constructor.define().params;this.params={};for(let e in t)this.params[e]=t[e][1]}get hasGUI(){return!0}calcHashKey(t=_udigest.reset()){let e=t;super.calcHashKey(e);for(let e in this.params)t.add(e),t.add(this.params[e]);return e.get()}equals(t){if(this.type!==t.type)return!1;for(let e in this.params)if(Math.abs(this.params[e]-t.params[e])>1e-6)return!1;return!0}redraw(){this.parent&&this.parent.redraw()}makeGUI(t){let e=this.constructor.define().params;for(let i in e){let s=e[i];if(s[2]===BOOL_FLAG){let e=t.check(void 0,s[0]);e.checked=!!this.params[i],e.key=i;let r=this;e.onchange=function(){r.params[this.key]=this.checked?1:0,r.update(),r.redraw()}}else{let e=t.slider(void 0,{name:s[0],defaultval:this.params[i],min:s[2],max:s[3]});e.baseUnit=e.displayUnit="none",e.key=i;let r=this;e.onchange=function(){r.params[this.key]=this.value,r.update(),r.redraw()}}}}killGUI(t){t.clear()}evaluate(t){throw new Error("implement me!")}reset(){}update(){super.update()}draw(t,e,i){let s=0;e.beginPath();for(let t=0;t<128;t++,s+=.007874015748031496){let i=this.evaluate(s);t?e.lineTo(i[0],i[1]):e.moveTo(i[0],i[1])}e.stroke()}_saveParams(){let t=[];for(let e in this.params)t.push(new ParamKey(e,this.params[e]));return t}toJSON(){return Object.assign(super.toJSON(),{params:this.params})}loadJSON(t){for(let e in t.params)this.params[e]=t.params[e];return this}loadSTRUCT(t){t(this),super.loadSTRUCT(t);let e=this.params;this.params={};let i=this.constructor.define().params;if(i){for(let t of e)t.key in i&&(this.params[t.key]=t.val);for(let t in i)t in this.params||(this.params[t]=i[t][1])}else console.warn("Missing define function for curve",this.constructor.name)}}SimpleCurveBase.STRUCT=nstructjs.inherit(SimpleCurveBase,CurveTypeData)+"\n  params : array(ParamKey) | obj._saveParams();\n}\n",nstructjs.register(SimpleCurveBase);class BounceCurve extends SimpleCurveBase{static define(){return{params:{decay:["Decay",1,.1,5],scale:["Scale",1,.01,10],freq:["Freq",1,.01,50],phase:["Phase",0,2*-Math.PI,2*Math.PI],offset:["Offset",0,-2,2]},name:"bounce",uiname:"Bounce",typeName:"BounceCurve"}}_evaluate(t){let e=this.params,i=e.decay+1,s=e.scale,r=e.freq,a=e.phase;e.offset;t*=r;let n=Math.abs(Math.cos(a+t*Math.PI*2))*s;return n*=Math.exp(i*t)/Math.exp(i),n}evaluate(t){let e=this._evaluate(0),i=this._evaluate(1);return(this._evaluate(t)-e)/(i-e)+this.params.offset}}CurveTypeData.register(BounceCurve),BounceCurve.STRUCT=nstructjs.inherit(BounceCurve,SimpleCurveBase)+"\n}",nstructjs.register(BounceCurve);class ElasticCurve extends SimpleCurveBase{constructor(){super(),this._func=void 0,this._last_hash=void 0}static define(){return{params:{mode:["Out Mode",!1,BOOL_FLAG,BOOL_FLAG],amplitude:["Amplitude",1,.01,10],period:["Period",1,.01,5]},name:"elastic",uiname:"Elastic",typeName:"ElasticCurve"}}evaluate(t){let e=~~(127*this.params.mode+256*this.params.amplitude+512*this.params.period);return e===this._last_hash&&this._func||(this._last_hash=e,this.params.mode?this._func=Ease.getElasticOut(this.params.amplitude,this.params.period):this._func=Ease.getElasticIn(this.params.amplitude,this.params.period)),this._func(t)}}CurveTypeData.register(ElasticCurve),ElasticCurve.STRUCT=nstructjs.inherit(ElasticCurve,SimpleCurveBase)+"\n}",nstructjs.register(ElasticCurve);class EaseCurve extends SimpleCurveBase{constructor(){super()}static define(){return{params:{mode_in:["in",!0,BOOL_FLAG,BOOL_FLAG],mode_out:["out",!0,BOOL_FLAG,BOOL_FLAG],amplitude:["Amplitude",1,.01,4]},name:"ease",uiname:"Ease",typeName:"EaseCurve"}}evaluate(t){let e=this.params.amplitude;return bez4(0,this.params.mode_in?1-e:1/3,this.params.mode_out?e:2/3,1,t)}}CurveTypeData.register(EaseCurve),EaseCurve.STRUCT=nstructjs.inherit(EaseCurve,SimpleCurveBase)+"\n}",nstructjs.register(EaseCurve);class RandCurve extends SimpleCurveBase{constructor(){super(),this.random=new MersenneRandom,this.seed=0}get seed(){return this._seed}set seed(t){this.random.seed(t),this._seed=t}static define(){return{params:{amplitude:["Amplitude",1,.01,4],decay:["Decay",1,0,5],in_mode:["In",!0,BOOL_FLAG,BOOL_FLAG]},name:"random",uiname:"Random",typeName:"RandCurve"}}evaluate(t){let e,i=this.random.random(),s=this.params.decay+1,r=(this.params.amplitude,this.params.in_mode);return r&&(t=1-t),e=Math.exp(t*s)/Math.exp(s),t+=(i-t)*e,r&&(t=1-t),t}}CurveTypeData.register(RandCurve),RandCurve.STRUCT=nstructjs.inherit(RandCurve,SimpleCurveBase)+"\n}",nstructjs.register(RandCurve);class Curve1DProperty extends ToolProperty$1{constructor(t,e,i,s,r,a){super(PropTypes$8.CURVE,void 0,e,i,s,r,a),this.data=new Curve1D,void 0!==t&&this.setValue(t),this.wasSet=!1}calcMemSize(){return 1024}equals(t){}getValue(){return this.data}evaluate(t){return this.data.evaluate(t)}setValue(t){void 0!==t&&(this.data.load(t),super.setValue(t))}copyTo(t){super.copyTo(t),t.setValue(this.data)}}Curve1DProperty.STRUCT=inherit$1(Curve1DProperty,ToolProperty$1)+"\n  data : Curve1D;\n}\n",register$1(Curve1DProperty),ToolProperty$1.internalRegister(Curve1DProperty);let PUTLParseError=PUTLParseError$1,tk=(t,e,i)=>new tokdef(t,e,i),tokens=[tk("ID",/[a-zA-Z_$]+[a-zA-Z_$0-9]*/),tk("NUM",/-?[0-9]+/,(t=>(t.value=parseInt(t.value),t))),tk("NUMBER",/-?[0-9]+\.[0-9]*/,(t=>(t.value=parseFloat(t.value),t))),tk("STRLIT",/'.*?'/,(t=>(t.value=t.value.slice(1,t.value.length-1),t))),tk("STRLIT",/".*?"/,(t=>(t.value=t.value.slice(1,t.value.length-1),t))),tk("DOT",/\./),tk("EQUALS",/(\=)|(\=\=)/),tk("LSBRACKET",/\[/),tk("RSBRACKET",/\]/),tk("AND",/\&/),tk("WS",/[ \t\n\r]+/,(t=>{}))],lexer=new lexer$1(tokens,(t=>{throw console.warn("Parse error",t),new DataPathError})),pathParser=new parser(lexer),parserStack=new Array(32);for(let t=0;t<parserStack.length;t++)parserStack[t]=pathParser.copy();parserStack.cur=0;let tool_classes=ToolClasses,tool_idgen$1=1;function toolkey(t){return Symbol.ToolID in t||(t[Symbol.ToolID]=tool_idgen$1++),t[Symbol.ToolID]}Symbol.ToolID=Symbol("toolid");let lt=time_ms(),lastmsg,lcount=0,reportstack=["api"];function pushReportName(t){reportstack.length>1024&&(console.trace("eerk, reportstack overflowed"),reportstack.length=0,reportstack.push("api")),reportstack.push(t)}function report$1(t){let e=0===reportstack.length?"api":reportstack[reportstack.length-1];console$1.context(e).warn(t)}function popReportName(){reportstack.pop()}class DataList extends ListIface{constructor(t){if(super(),void 0===t)throw new DataPathError("missing callbacks argument to DataList");if(this.cb={},"object"!=typeof t||Array.isArray(t))for(let e of t)this.cb[e.name]=e;else for(let e in t)this.cb[e]=t[e]}copy(){let t=new DataList([this.cb.get]);for(let e in this.cb)t.cb[e]=this.cb[e];return t}get(t,e,i){return this.cb.get(t,e,i)}getLength(t,e){return this._check("getLength"),this.cb.getLength(t,e)}_check(t){if(!(t in this.cb))throw new DataPathError(t+" not supported by this list")}set(t,e,i,s){void 0===this.cb.set?e[i]=s:this.cb.set(t,e,i,s)}getIter(t,e){return this._check("getIter"),this.cb.getIter(t,e)}filter(t,e,i){return this._check("filter"),this.cb.filter(t,e,i)}getActive(t,e){return this._check("getActive"),this.cb.getActive(t,e)}setActive(t,e,i){this._check("setActive"),this.cb.setActive(t,e,i)}getKey(t,e,i){return this._check("getKey"),this.cb.getKey(t,e,i)}getStruct(t,e,i){if(void 0!==this.cb.getStruct)return this.cb.getStruct(t,e,i);let s=this.get(t,e,i);return void 0!==s?t.getStruct(s.constructor):void 0}}class DataStruct{constructor(t=[],e="unnamed"){this.members=[],this.name=e,this.pathmap={},this.flag=0,this.dpath=void 0,this.inheritFlag=0;for(let e of t)this.add(e)}clear(){return this.pathmap={},this.members=[],this}copy(){let t=new DataStruct;t.name=this.name,t.flag=this.flag,t.inheritFlag=this.inheritFlag;for(let e of this.members){let i=e.copy();i.type===DataTypes.PROP&&(i.data=i.data.copy()),t.add(i)}return t}dynamicStruct(t,e,i,s){let r=s||new DataStruct,a=new DataPath(t,e,r,DataTypes.DYNAMIC_STRUCT);return r.inheritFlag|=this.inheritFlag,r.dpath=a,this.add(a),r}struct(t,e,i,s){let r=s||new DataStruct,a=new DataPath(t,e,r,DataTypes.STRUCT);return r.inheritFlag|=this.inheritFlag,r.dpath=a,this.add(a),r}customGet(t){return this.dpath.customGet(t),this}customGetSet(t,e){return this.dpath.customGetSet(t,e),this}color3(t,e,i,s){let r=this.vec3(t,e,i,s);return r.data.subtype=PropSubTypes$3.COLOR,r.range(0,1),r.simpleSlider(),r.noUnits(),r}color4(t,e,i,s=i){let r=this.vec4(t,e,i,s);return r.data.subtype=PropSubTypes$3.COLOR,r.range(0,1),r.simpleSlider(),r.noUnits(),r}arrayList(t,e,i,s,r){let a=this.list(t,e,[function(t,e){return e[Symbol.iterator]()},function(t,e){return e.length},function(t,e,i){return e[i]},function(t,e,i,s){if("string"==typeof i&&(i=parseInt(i)),i<0||i>=e.length)throw new DataPathError("Invalid index "+i);e[i]=s},function(t,e,i){return e.indexOf(i)},function(t,e,s){return i}]);return a}color3List(t,e,i,s){return this.vectorList(3,t,e,i,s,PropSubTypes$3.COLOR)}color4List(t,e,i,s){return this.vectorList(4,t,e,i,s,PropSubTypes$3.COLOR)}vectorList(t,e,i,s,r,a){let n;switch(t){case 2:n=Vec2Property;break;case 3:n=Vec3Property;case 4:n=Vec4Property}if(void 0===n)throw new DataPathError("Invalid size for vectorList; expected 2 3 or 4");new n(void 0,i,s,r);let o=new DataStruct(void 0,"Vector");o.vec3("","co","Coords","Coordinates");let l=this.list(e,i,[function(t,e){return e[Symbol.iterator]()},function(t,e){return e.length},function(t,e,i){return e[i]},function(t,e,i,s){if("string"==typeof i&&(i=parseInt(i)),i<0||i>=e.length)throw new DataPathError("Invalid index "+i);e[i]=s},function(t,e,i){return e.indexOf(i)},function(t,e,i){return o}]);return l}bool(t,e,i,s){let r=new BoolProperty(void 0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}vec2(t,e,i,s){let r=new Vec2Property(void 0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}vec3(t,e,i,s){let r=new Vec3Property(void 0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}vec4(t,e,i,s){let r=new Vec4Property(void 0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}float(t,e,i,s){let r=new FloatProperty(0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}textblock(t,e,i,s){let r=new StringProperty(void 0,e,i,s);r.multiLine=!0;let a=new DataPath(t,e,r);return this.add(a),a}report(t,e,i,s){let r=new ReportProperty(void 0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}string(t,e,i,s){let r=new StringProperty(void 0,e,i,s),a=new DataPath(t,e,r);return this.add(a),a}int(t,e,i,s,r){r||(r=new IntProperty(0,e,i,s));let a=new DataPath(t,e,r);return this.add(a),a}curve1d(t,e,i,s){let r=new Curve1DProperty(void 0);r.apiname=e,r.uiname=i,r.description=s;let a=new DataPath(t,e,r);return this.add(a),a}enum(t,e,i,s,r){let a;a=i instanceof EnumProperty$9?i:new EnumProperty$9(void 0,i,e,s,r);let n=new DataPath(t,e,a);return this.add(n),n}list(t,e,i){let s=new DataList(i),r=new DataPath(t,e,s);return r.type=DataTypes.ARRAY,this.add(r),r}flags(t,e,i,s,r){let a;a=void 0!==i&&i instanceof ToolProperty$1?i:new FlagProperty(void 0,i,e,s,r);let n=new DataPath(t,e,a);return this.add(n),n}remove(t){if("string"==typeof t&&(t=this.pathmap[t]),!(t.apiname in this.pathmap))throw new Error("Member not in struct "+t.apiname);delete this.pathmap[t.apiname],this.members.remove(t)}fromToolProp(t,e,i=(e.apiname.length>0?e.apiname:t)){let s=new DataPath(t,i,e);return this.add(s),s}add(t){return t.apiname in this.pathmap&&(window.DEBUG.datapaths&&console.warn("Overriding existing member '"+t.apiname+"' in datapath struct",this.name),this.remove(this.pathmap[t.apiname])),t.flag|=this.inheritFlag,this.members.push(t),t.parent=this,this.pathmap[t.apiname]=t,this}}let _map_struct_idgen=1,_map_structs={};window._debug__map_structs=_map_structs;let _dummypath=new DataPath,DummyIntProperty=new IntProperty;const CLS_API_KEY=Symbol("dp_map_id"),CLS_API_KEY_CUSTOM=Symbol("dp_map_custom");class DataAPI extends ModelInterface{constructor(){super(),this.rootContextStruct=void 0,this.structs=[]}get list(){}static toolRegistered(t){return ToolOp.isRegistered(t)}static registerTool(t){return console.warn("Outdated function simple_controller.DataAPI.registerTool called"),ToolOp.register(t)}getStructs(){return this.structs}setRoot(t){this.rootContextStruct=t}hasStruct(t){return t.hasOwnProperty(CLS_API_KEY)}getStruct(t){return this.mapStruct(t,!1)}mergeStructs(t,e){for(let i of e.members)t.add(i.copy())}inheritStruct(t,e,i=!1){let s=this.mapStruct(e,i);if(void 0===s)throw new Error("parent has no struct definition");return s=s.copy(),s.name=t.name,this._addClass(t,s),s}_addClass(t,e){let i=_map_struct_idgen++;t[CLS_API_KEY]=i,this.structs.push(e),_map_structs[i]=e}mapStructCustom(t,e){this.mapStruct(t,!0),t[CLS_API_KEY_CUSTOM]=e}mapStruct(t,e=!0,i=t.name){let s;if(s=t.hasOwnProperty(CLS_API_KEY)?t[CLS_API_KEY]:void 0,void 0===s&&e){let e=new DataStruct(void 0,i);return this._addClass(t,e),e}if(void 0===s)throw new Error("class does not have a struct definition: "+i);return _map_structs[s]}pushReportContext(t){pushReportName(t)}popReportContext(){popReportName()}massSetProp(t,e,i){for(let s of this.resolveMassSetPaths(t,e))this.setValue(t,s,i)}resolveMassSetPaths(ctx,massSetPath){massSetPath.startsWith("/")&&(massSetPath=massSetPath.slice(1,massSetPath.length));let start=massSetPath.search("{"),end=massSetPath.search("}");if(start<0||end<0)throw new DataPathError("Invalid mass set datapath: "+massSetPath);let prefix=massSetPath.slice(0,start-1),filter=massSetPath.slice(start+1,end),suffix=massSetPath.slice(end+2,massSetPath.length),rdef=this.resolvePath(ctx,prefix);if(!(rdef.prop instanceof DataList))throw new DataPathError("massSetPath expected a path resolving to a DataList: "+massSetPath);let paths=[],list=rdef.prop,api=ctx.api;function applyFilter(obj){const forceEval=rdef.dpath.flag&DataFlags.USE_EVAL_MASS_SET_PATHS;if(void 0!==obj){if(forceEval||"object"!=typeof obj&&"function"!=typeof obj){let $=obj;return eval(filter)}{let t=api.mapStruct(obj.constructor,!1),e=filter;e.startsWith("$")&&(e=e.slice(1,filter.length).trim()),e.startsWith(".")&&(e=e.slice(1,filter.length).trim());try{return api.getValue(obj,e,t)}catch(t){return t instanceof DataPathError||(print_stack$1(t),console.error("Error in datapath callback")),!1}}}}for(let t of list.getIter(this,rdef.value)){if(!applyFilter(t))continue;let e=""+list.getKey(this,rdef.value,t),i=`${prefix}[${e}]${suffix}`;try{this.getValue(ctx,i)}catch(t){t instanceof DataPathError||(print_stack$1(t),console.error(i+": Error in datapath API"));continue}paths.push(i)}return paths}resolvePath(t,e,i=!1,s){let r,a=parserStack[parserStack.cur++];"/"===e[0]&&(e=e.slice(1,e.length).trim());try{r=this.resolvePath_intern(t,e,i,a,s)}catch(t){t instanceof DataPathError||(print_stack$1(t),report$1("error while evaluating path "+e)),window.DEBUG&&window.DEBUG.datapaths&&print_stack$1(t),r=void 0}if(parserStack.cur--,void 0!==r&&r.prop&&r.dpath&&r.dpath.flag&DataFlags.USE_CUSTOM_PROP_GETTER&&(r.prop=this.getPropOverride(t,e,r.dpath,r.obj)),void 0!==r&&r.prop&&r.dpath&&r.dpath.ui_name_get){let i={datactx:t,datapath:e,dataref:r.obj},s=r.dpath.ui_name_get.call(i);r.prop.uiname=""+s}return r}getPropOverride(t,e,i,s,r=i.data){r.ctx=t,r.datapath=e,r.dataref=s;let a=getTempProp(r.type);return r.copyTo(a),i.propGetter.call(r,a),r.ctx=r.datapath=r.dataref=void 0,a}resolvePath_intern(t,e,i=!1,s=pathParser,r){e=e.replace("==","="),s.input(e),r=r||this.rootContextStruct;let a,n,o,l,h,c=t,d=t;function u(){let t=s.peeknext();if("NUM"===t.type||"STRLIT"===t.type)return s.next(),t.value;throw new PUTLParseError("Expected list key")}let p=0;for(;!s.at_end();){let m,f=s.expect("ID"),g=r.pathmap[f];if(h=g,void 0===g){if(!("length"===f&&void 0!==l&&l instanceof DataList)){if("active"===f&&void 0!==l&&l instanceof DataList){let t=l.getActive(this,c);if(void 0===t&&!i)throw new DataPathError("no active elem ent for list");let a=void 0!==c&&void 0!==t?l.getKey(this,c,t):void 0;if(void 0===(r=l.getStruct(this,c,a)))throw new DataPathError("couldn't get data type for "+e+"'s element '"+f+"'");_dummypath.parent=g,g=_dummypath,d=c,c=t,g.type=DataTypes.STRUCT,g.data=r,g.path=f,s.optional("DOT");continue}throw new DataPathError(e+": unknown property "+f)}l.getLength(this,c),f="length",l=DummyIntProperty,l.name="length",l.flag=PropFlags$3.READ_ONLY,g=_dummypath,g.type=DataTypes.PROP,g.data=l,g.struct=g.parent=r,g.flag=DataFlags.READ_ONLY,g.path="length"}if(g.type===DataTypes.STRUCT)r=g.data;else if(g.type===DataTypes.DYNAMIC_STRUCT){let i=!1;if(void 0!==c){let s;if(g.flag&DataFlags.USE_CUSTOM_GETSET){let i=g.getSet;i.ctx=t,i.dataref=c,i.datapath=e,s=i.get(),i.ctx=i.datapath=i.dataref=void 0}else s=c[g.path];m=s,void 0===(r=void 0!==s?CLS_API_KEY_CUSTOM in s.constructor?s.constructor[CLS_API_KEY_CUSTOM](s):this.mapStruct(s.constructor,!1):g.data)&&(r=g.data),i=void 0!==r}if(!i)throw new DataPathError("dynamic struct error for path: "+e)}else l=g.data;if(l&&g.flag&DataFlags.USE_CUSTOM_PROP_GETTER&&(l=this.getPropOverride(t,e,g,c)),g.path.search(/\./)>=0){let t=g.path.split(/\./);for(let s of t){if(n=d,d=c,o=s,void 0===c&&!i)throw new DataPathError("no data for "+e);void 0!==c&&(c=c[s.trim()])}}else if(n=d,d=c,o=g.path,g.flag&DataFlags.USE_CUSTOM_GETSET){let i=g.getSet;if(i||g.type!==DataTypes.PROP)i.ctx=t,i.dataref=c,i.datapath=e,c=i.get(),i.ctx=i.datapath=i.dataref=void 0;else{let i=g.data;i.ctx=t,i.dataref=c,i.datapath=e;try{c=i.getValue()}catch(t){print_stack$1(t),c=void 0}"string"==typeof c&&i.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)&&(c=i.values[c]),i.ctx=i.dataref=i.datapath=void 0}}else{if(void 0===c&&!i)throw new DataPathError("no data for "+e);g.type===DataTypes.DYNAMIC_STRUCT?c=m:void 0!==c&&""!==g.path&&(c=c[g.path])}let _=s.peeknext();if(void 0===_)break;if("DOT"===_.type)s.next();else if("EQUALS"===_.type&&void 0!==l&&l.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){s.expect("EQUALS");let t=s.peeknext(),e=t&&"ID"===t.type?"ID":"NUM",i=s.expect(e),r=i;if("string"==typeof i&&(i=l.values[i]),void 0===i)throw new DataPathError("unknown value "+r);i in l.keys&&(a=l.keys[i]),f=g.path,c=!(d[f]!=i)}else if("AND"===_.type&&void 0!==l&&l.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){s.expect("AND");let t=s.peeknext(),e=t&&"ID"===t.type?"ID":"NUM",i=s.expect(e),r=i;if("string"==typeof i&&(i=l.values[i]),void 0===i)throw new DataPathError("unknown value "+r);i in l.keys&&(a=l.keys[i]),f=g.path,c=!!(d[f]&i)}else if("LSBRACKET"===_.type&&void 0!==l&&l.type&(PropTypes$8.ENUM|PropTypes$8.FLAG)){s.expect("LSBRACKET");let r,n=s.peeknext(),o=n&&"ID"===n.type?"ID":"NUM",h=s.expect(o),u=h;if("string"==typeof h&&(h=l.values[h]),void 0===h)throw console.warn(e,l.values,u,l),new DataPathError("unknown value "+u);if(h in l.keys&&(a=l.keys[h]),f=g.path,l.flag&PropFlags$3.USE_CUSTOM_GETSET){l.dataref=d,l.datapath=e,l.ctx=t;try{r=l.getValue()}catch(t){print_stack$1(t),r=NaN}}else r=d?d[f]:0;if(void 0===d&&!i)throw new DataPathError("no data for path "+e);void 0!==d&&(c=l.type===PropTypes$8.ENUM?!(r!==h):!!(r&h)),s.expect("RSBRACKET")}else if("LSBRACKET"===_.type&&void 0!==l&&isVecProperty(l)){s.expect("LSBRACKET");let t=s.expect("NUM");s.expect("RSBRACKET"),a=t,void 0===l||l.type&(PropTypes$8.VEC2|PropTypes$8.VEC3|PropTypes$8.VEC4|PropTypes$8.QUAT)||(d=c),c=c[t]}else if("LSBRACKET"===_.type){if(s.expect("LSBRACKET"),d&&o&&"string"==typeof o&&o.length>0&&(d=d[o]),o=u(),s.expect("RSBRACKET"),!(l instanceof DataList))throw new DataPathError("bad property, not a list");if(c=l.get(this,d,o),!(r=l.getStruct(this,d,o)))throw new DataPathError(e+": list has no entry "+o);void 0!==s.peeknext()&&"DOT"===s.peeknext().type&&s.next()}if(p++>1e3){console.warn("infinite loop in resolvePath parser");break}}return{dpath:h,parent:n,obj:d,value:c,key:o,dstruct:r,prop:l,subkey:a}}_parsePathOverrides(t){let e=["",void 0,void 0];let i=0;for(let s=0;s<t.length;s++){let r=t[s],a=s<t.length-1?t[s+1]:"";"|"!==r?":"!==r||":"!==a?e[i]+=r:(i=2,e[2]="",s++):(i=1,e[1]="")}return{path:e[0].trim(),uiname:e[1]?e[1].trim():void 0,hotkey:e[2]?e[2].trim():void 0}}getToolDef(t){let{path:e,uiname:i,hotkey:s}=this._parsePathOverrides(t),r=this.parseToolPath(e);if(void 0===r)throw new DataPathError('unknown path "'+e+'"');let a=r.tooldef();return i&&(a.uiname=i),s&&(a.hotkey=s),a}getToolPathHotkey(t,e){let{path:i,uiname:s,hotkey:r}=this._parsePathOverrides(e);if(r)return r;try{return this.#i(t,i)}catch(t){return print_stack$1(t),void console$1.context("api").log("failed to fetch tool path: "+i)}}#i(t,e){let i=t.screen,s=this;function r(t){if(void 0===t)return;let i;function r(e){if(!i)for(let s of t)"string"==typeof s.action&&e(s.action)&&(i=s.buildString())}return r((t=>t.trim()===e.trim())),r((t=>s._parsePathOverrides(t).path===e.trim())),i}if(0===i.sareas.length)return r(i.keymap);let a=i.sareas[0].area.constructor.getActiveArea();if(a)for(let t of a.getKeyMaps()){let e=r(t);if(void 0!==e)return e}for(let t of i.sareas)if(t.area)for(let e of t.area.getKeyMaps()){let t=r(e);if(t)return t}return!!this.keymap&&r(this.keymap)}parseToolPath(t){try{return parseToolPath(t).toolclass}catch(e){if(e instanceof DataPathError)return void console.warn("warning, bad tool path "+t);throw e}}parseToolArgs(t){return parseToolPath(t).args}createTool(t,e,i={}){let s,r;if("string"==typeof e||e instanceof String){let t=parseToolPath(e);s=t.toolclass,r=t.args}else s=e,r={};s||console.error("Unknown tool "+e),r={...r};const a=s._getFinalToolDef();if(void 0!==i)for(let t in i)t in a.inputs?t in r||(r[t]=i[t]):console.warn(s.tooldef().uiname+': Unknown tool property "'+t+'"');let n=s.invoke(t,r);if(void 0!==i)for(let t in i)t in n.inputs?n.inputs[t].setValue(i[t]):console.warn(s.tooldef().uiname+': Unknown tool property "'+t+'"');return n}}function initSimpleController(){initToolPaths()}let dpt=DataPathSetOp;function getDataPathToolOp(){return dpt}function setDataPathToolOp(t){ToolOp.unregister(DataPathSetOp),ToolOp.isRegistered(t)||ToolOp.register(t),dpt=t}setImplementationClass(DataAPI);let rgb_to_hsv_rets=new cachering((()=>[0,0,0]),64);function rgb_to_hsv(t,e,i){let s=0,r=0,a=0;if(null==t||null==e||null==i||isNaN(t)||isNaN(e)||isNaN(i))throw new Error(`Please enter numeric RGB values! r: ${t} g: ${e} b: ${i}`);let n=Math.min(t,Math.min(e,i)),o=Math.max(t,Math.max(e,i));if(n===o){a=n;let t=rgb_to_hsv_rets.next();return t[0]=0,t[1]=0,t[2]=a,t}s=60*((t===n?3:i===n?1:5)-(t===n?e-i:i===n?t-e:i-t)/(o-n))/360,r=(o-n)/o,a=o;let l=rgb_to_hsv_rets.next();return l[0]=s,l[1]=r,l[2]=a,l}let hsv_to_rgb_rets=new cachering((()=>[0,0,0]),64);function hsv_to_rgb(t,e,i){let s,r=0,a=0,n=0,o=hsv_to_rgb_rets.next();function l(t,e,i){return o[0]=t,o[1]=e,o[2]=i,o}return o[0]=o[1]=o[2]=0,t*=360,r=i*e,n=r*(1-Math.abs(t/60%2-1)),a=i-r,s=t>=0&&t<60?l(r+a,n+a,a):t>=60&&t<120?l(n+a,r+a,a):t>=120&&t<180?l(a,r+a,n+a):t>=180&&t<240?l(a,n+a,r+a):t>=240&&t<300?l(n+a,a,r+a):t>=300?l(r+a,a,n+a):l(a,a,a),s}let rgb_to_cmyk_rets=cachering.fromConstructor(Vector4$2,512),cmyk_to_rgb_rets=cachering.fromConstructor(Vector3$2,512);function cmyk_to_rgb(t,e,i,s){let r=cmyk_to_rgb_rets.next();return 1===s?(r.zero(),r):(t=t-t*s+s,e=e-e*s+s,i=i-i*s+s,r[0]=1-t,r[1]=1-e,r[2]=1-i,r)}function rgb_to_cmyk(t,e,i){let s=rgb_to_cmyk_rets.next(),r=1-t,a=1-e,n=1-i,o=1;r<o&&(o=r),a<o&&(o=a),n<o&&(o=n),1===o?(r=0,a=0,n=0):(r=(r-o)/(1-o),a=(a-o)/(1-o),n=(n-o)/(1-o));let l=o;return s[0]=r,s[1]=a,s[2]=n,s[3]=l,s}const DefaultTheme={base:{AreaHeaderBG:"rgba(200, 200, 200, 0.95)",BasePackFlag:0,BoxDepressed:"rgba(130,130,130, 1)",BoxHighlight:"rgba(151,208,239, 1)","flex-grow":"unset",mobileSizeMultiplier:1,DefaultText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:14,color:"rgba(35, 35, 35, 1.0)"}),LabelText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:14,color:"rgba(35, 35, 35, 1.0)"}),TitleText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:12,color:"rgba(35, 35, 35, 1.0)"}),"background-color":"rgba(207,207,207, 0.5)","border-color":"rgba(34,34,34, 1)","border-radius":12.010619764585666,"focus-border-width":2,oneAxisPadding:2,padding:1},button:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgba(35,35,35, 1)"}),"background-color":"rgba(238,238,238, 0.8672412740773168)","border-color":"rgba(255,255,255, 1)","border-radius":4,"border-style":"solid","border-width":2,disabled:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgb(109,109,109)"}),"background-color":"rgb(19,19,19)","border-color":"#f58f8f","border-style":"solid","border-width":1},height:25,highlight:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgba(255,255,255, 1)"}),"background-color":"rgba(138,222,255, 1)","border-color":"rgba(255,255,255, 1)","border-radius":4,"border-style":"solid","border-width":2},"highlight-pressed":{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgba(35,35,35, 1)"}),"background-color":"rgba(113,113,113, 1)","border-color":"#DADCE0","border-style":"solid","border-width":1},margin:4,"margin-left":4,"margin-right":4,padding:1,pressed:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgba(35,35,35, 1)"}),"background-color":"rgba(113,113,113, 1)","border-color":"#DADCE0","border-style":"solid","border-width":1},width:25},checkbox:{CheckSide:"left",height:32,width:32,"background-color":"rgb(168,168,168)"},colorfield:{circleSize:11,colorBoxHeight:24,fieldSize:400,height:256,hueHeight:32,width:256},colorpickerbutton:{height:32,width:95},curvewidget:{CanvasBG:"rgb(44,44,44)",CanvasHeight:256,CanvasWidth:256},dropbox:{dropTextBG:"rgba(233,233,233, 1)",height:25,width:32},iconbutton:{highlight:{"background-color":"rgba(133,182,255,0.8)","border-color":"black","border-radius":5,"border-width":1,height:32,"margin-bottom":1,"margin-left":2,"margin-right":2,"margin-top":1,padding:2,width:32},depressed:{"background-color":"rgba(42,61,77,0.8)","border-color":"black","border-radius":5,"border-width":1,height:32,"margin-bottom":1,"margin-left":2,"margin-right":2,"margin-top":1,padding:2,width:32},"background-color":"rgba(15,15,15, 0)","border-color":"black","border-radius":5,"border-width":1,height:32,"margin-bottom":1,"margin-left":2,"margin-right":2,"margin-top":1,padding:2,width:32},iconcheck:{highlight:{"background-color":"rgba(133,182,255,0.8)","border-color":"black","border-radius":5,"border-width":1,height:32,"margin-bottom":1,"margin-left":2,"margin-right":2,"margin-top":1,padding:2,width:32},depressed:{"background-color":"rgba(42,61,77,0.8)","border-color":"black","border-radius":5,"border-width":1,height:32,"margin-bottom":1,"margin-left":2,"margin-right":2,"margin-top":1,padding:2,width:32},"background-color":"rgba(15,15,15, 0)","border-color":"rgba(237,209,209, 1)","border-radius":5,"border-width":0,drawCheck:!0,height:32,"margin-bottom":1,"margin-left":2,"margin-right":2,"margin-top":1,padding:2,width:32},label:{LabelText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:14,color:"rgba(35, 35, 35, 1.0)"})},listbox:{ListActive:"rgba(200, 205, 215, 1.0)",ListHighlight:"rgba(155, 220, 255, 0.5)",height:200,width:110},menu:{MenuBG:"rgba(250, 250, 250, 1.0)","item-radius":0,MenuBorder:"1px solid grey",MenuHighlight:"rgba(155, 220, 255, 1.0)",MenuSeparator:{width:"100%",height:2,padding:0,margin:0,border:"none","background-color":"grey"},"box-shadow":"5px 5px 25px rgba(0,0,0,0.75)",MenuSpacing:5,MenuText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:12,color:"rgba(25, 25, 25, 1.0)"}),"padding-top":0,"padding-left":0,"padding-right":0,"padding-bottom":0,"border-color":"grey","border-radius":5,"border-style":"solid","border-width":1},notification:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgb(55,55,55)"}),"background-color":"rgba(72,72,72,0)","border-radius":5,"border-color":"grey","border-width":1,"border-style":"solid",ProgressBarBG:"rgb(74,148,183)",ProgressBar:"rgb(250,132,58)"},numslider:{"arrow-color":"50%","background-color":"rgba(219,219,219, 1)","border-color":"rgba(255,255,255, 1)","border-radius":1,height:22,highlight:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgb(0,0,0)"}),"background-color":"rgba(151,208,239, 1)","border-color":"rgba(255,255,255, 1)","border-style":"solid","border-width":1},pressed:{DefaultText:new CSSFont({font:"poppins",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgba(0,0,0, 1)"}),"arrow-color":"rgb(28,28,28)","background-color":"rgba(178,178,178, 1)","border-color":"rgba(255,255,255, 1)","border-style":"solid","border-width":1},width:115},numslider_simple:{SlideHeight:10,TextBoxWidth:45,"background-color":"rgba(219,219,219, 1)",height:18,labelOnTop:!0,addLabel:!0,width:135},numslider_textbox:{TextBoxHeight:25,TextBoxWidth:50,"background-color":"rgba(219,219,219, 1)",height:25,labelOnTop:!0,addLabel:!1,width:120},panel:{HeaderBorderRadius:5.329650280441558,HeaderRadius:4,TitleBackground:"rgba(177,219,255, 1)",TitleBorder:"rgba(104,104,104, 1)",TitleText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:14,color:"rgba(0,0,0, 1)"}),"background-color":"rgba(184,184,184, 0.7594818376068376)","border-color":"rgba(0,0,0, 0.5598061397157866)","border-radius":4,"border-style":"groove","border-width":1.141,"margin-bottom":0,"margin-bottom-closed":0,"margin-left":5.6584810220495445,"margin-right":0,"margin-top":0,"margin-top-closed":0,"padding-bottom":0,"padding-left":0,"padding-right":0,"padding-top":0},richtext:{DefaultText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:16,color:"rgba(35, 35, 35, 1.0)"}),"background-color":"rgb(245, 245, 245)"},screenborder:{"border-inner":"grey","border-outer":"rgba(228,228,228, 1)","border-width":2,"mouse-threshold":8},scrollbars:{border:void 0,color:void 0,color2:void 0,contrast:void 0,width:void 0},sidebar:{"background-color":"rgba(55, 55, 55, 0.5)"},strip:{"background-color":"rgba(75,75,75, 0.33213141025641024)","border-color":"rgba(0,0,0, 0.31325409987877156)","border-radius":8.76503417507447,"border-style":"solid","border-width":1,margin:2,oneAxisPadding:2,padding:1,"flex-grow":"unset"},tabs:{"focus-on-tab-click":"false","movable-tabs":"true",TabPadding_mobile:20,TabPadding:0,TabActive:"rgba(212,212,212, 1)",TabBarRadius:6,TabHighlight:"rgba(50, 50, 50, 0.2)",TabInactive:"rgba(183,183,183, 1)",TabStrokeStyle1:"rgba(0,0,0, 1)",TabStrokeStyle2:"rgba(0,0,0, 1)",TabText:new CSSFont({font:"sans-serif",weight:"normal",variant:"bold",style:"normal",size:15,color:"rgba(0,0,0, 1)"}),"background-color":"rgba(222,222,222, 1)"},textbox:{DefaultText:new CSSFont({font:"sans-serif",weight:"normal",variant:"normal",style:"normal",size:14,color:"rgba(3,3,3, 1)"}),"border-color":"rgba(0,0,0,0)","border-width":1,"border-radius":4,"border-style":"solid","background-color":"rgba(245,245,245, 1)"},tooltip:{ToolTipText:new CSSFont({font:"sans-serif",weight:"bold",variant:"normal",style:"normal",size:12,color:"rgba(35, 35, 35, 1.0)"}),"background-color":"rgba(255,255,255, 1)","border-color":"rgba(139,139,139, 1)","border-radius":3,"border-style":"solid","border-width":1,padding:5},treeview:{itemIndent:10,rowHeight:18},vecPopupButton:{height:18,padding:3,width:100}};function setIconMap(t){for(let e in t)Icons$2[e]=t[e]}let a$1=0,Icons$2={FOLDER:a$1++,FILE:a$1++,TINY_X:a$1++,SMALL_PLUS:a$1++,SMALL_MINUS:a$1++,UNDO:a$1++,REDO:a$1++,HELP:a$1++,UNCHECKED:a$1++,CHECKED:a$1++,LARGE_CHECK:a$1++,CURSOR_ARROW:a$1++,NOTE_EXCL:a$1++,SCROLL_DOWN:a$1++,SCROLL_UP:a$1++,BACKSPACE:a$1++,LEFT_ARROW:a$1++,RIGHT_ARROW:a$1++,UI_EXPAND:a$1++,UI_COLLAPSE:a$1++,BOLD:a$1++,ITALIC:a$1++,UNDERLINE:a$1++,STRIKETHRU:a$1++,TREE_EXPAND:a$1++,TREE_COLLAPSE:a$1++,ZOOM_OUT:a$1++,ZOOM_IN:a$1++,LARGE_X:a$1++};Icons$2.ENUM_CHECKED=Icons$2.CHECKED,Icons$2.ENUM_UNCHECKED=Icons$2.UNCHECKED;let exclude=new Set(["toString","constructor","prototype","__proto__","toLocaleString","hasOwnProperty","shadow"]),UIBase$g;function _setUIBase(t){UIBase$g=t}let AspectKeys=Symbol("aspect-keys");function initAspectClass(t,e=new Set){let i=t.constructor;if(!i[AspectKeys]){i[AspectKeys]=[];let r=[],a=t.__proto__;for(;a;)r=r.concat(Reflect.ownKeys(a)),a=a.__proto__;function s(t,e){let i=Object.getOwnPropertyDescriptor(t,e);if(i&&(i.get||i.set))return!1;let s=t.constructor;do{if(s.prototype){let t=Object.getOwnPropertyDescriptor(s.prototype,e);if(t&&(t.set||t.get))return!1}s=s.__proto__}while(s&&s!==s.__proto__);return!0}r=new Set(r);for(let a of r){let r;if(("string"!=typeof a||!a.startsWith("_"))&&("constructor"!==a&&!e.has(a)&&!exclude.has(a)&&s(t,a))){try{r=t[a]}catch(t){continue}"function"==typeof r&&i[AspectKeys].push(a)}}}t.__aspect_methods=new Set;for(let e of i[AspectKeys])AfterAspect.bind(t,e)}function clearAspectCallbacks(t){for(let e of t.__aspect_methods)t[e].clear()}class AfterAspect{constructor(t,e){this.owner=t,this.key=e,this.chain=[[t[e],!1]],this.chain2=[[t[e],!1]],this.root=[[t[e],!1]];let i=this,s=this._method=function(){let t=i.chain,e=i.chain2;e.length=t.length;for(let i=0;i<t.length;i++)e[i]=t[i];for(let i=0;i<e.length;i++){let[r,a,n]=e[i];if(a){let s=!a.isConnected;if(a instanceof UIBase$g&&(s=s||a.isDead()),s){console.warn("pruning dead AfterAspect callback",a),t.remove(e[i]);continue}}n&&t.indexOf(e[i])>=0&&t.remove(e[i]),r&&r.apply&&(s.value=r.apply(this,arguments))}let r=s.value;return s.value=void 0,r};this._method_bound=!1,s.after=this.after.bind(this),s.once=this.once.bind(this),s.remove=this.remove.bind(this),t[e].after=this.after.bind(this),t[e].once=this.once.bind(this),t[e].remove=this.remove.bind(this)}static bind(t,e){return t.__aspect_methods.add(e),new AfterAspect(t,e)}remove(t){for(let e of this.chain)if(e[0]===t)return this.chain.remove(e),!0;return!1}once(t,e){return this.after(t,e,!0)}_checkbind(){this._method_bound||(this.owner[this.key]=this._method)}clear(){return this._checkbind(),this.chain=[[this.root[0][0],this.root[0][1]]],this.chain2=[[this.root[0][0],this.root[0][1]]],this}before(t,e,i){return this._checkbind(),void 0===t?(console.warn("invalid call to .after(); cb was undefined"),this.owner):(this.chain=[[t,e,i]].concat(this.chain),this.owner)}after(t,e,i){return this._checkbind(),void 0===t?(console.warn("invalid call to .after(); cb was undefined"),this.owner):(this.chain.push([t,e,i]),this.owner)}}const SocketFlags={UPDATE:1},NodeFlags={UPDATE:1,SORT_TAG1:2,SORT_TAG2:4},RecalcFlags={RUN:1,RESORT:2},SocketTypes={INPUT:"inputs",OUTPUT:"outputs"};let graphIdGen=1;class EventSocket{static socketDef={typeName:"",uiName:"",flag:0};name="";id=graphIdGen++;flag=0;edges=[];node=void 0;type=void 0;constructor(t){this.node=t}get value(){throw new Error("implement me!")}set value(t){this.flagUpdate()}get isUpdated(){return this.flag&SocketFlags.UPDATE}copyFrom(t){return this.name=t.name,this.flag=t.flag,this}copy(){return(new this.constructor).copyFrom(this)}flagUpdate(){if(this.flag|=SocketFlags.UPDATE,this.node){if(this.type===SocketTypes.INPUT)this.node.flagUpdate();else for(let t of this.edges)t.flag|=SocketFlags.UPDATE,t.node.flagUpdate();return this}}flagResort(){return this.node&&this.node.flagResort(),this}connect(t){return this.edges.push(t),t.edges.push(this),this}hasNode(t){for(let e of this.edges)if(e.node===t||e.node.owner===t)return!0;return!1}has(t){return this.edges.indexOf(t)>=0}disconnect(t){if(this.flagResort(),void 0===t){for(let t of this.edges)t.flagUpdate(),t.edges.remove(this);return this.edges.length=0,this}return t.flagUpdate(),this.edges.remove(t),this}}const NodeClasses=[];class NodeCapable{graphNode=void 0;static graphNodeDef={typeName:"",uiName:"",flag:0,inputs:{},outputs:{}};graphExec(){}}class EventNode{owner=void 0;inputs={};outputs={};allsockets=[];graph=void 0;sortIndex=-1;id=graphIdGen++;flag=0;static register(t,e){if(t.graphNodeDef=e,!e.typeName)throw new Error("Missing graphNodeDef.typeName");return NodeClasses.push(t),e}addSocket(t,e,i){return this[t][e]=i,i.name=e,i.node=this,i.type=t,this}static isNodeCapable(t){return void 0!==t.graphNodeDef}constructor(t){this.owner=t;let e=t.constructor,i=t=>{let i={},s=e;for(;s;){if(s.graphNodeDef){let e=s.graphNodeDef[t]||{};for(let s in e)s in i||(i[s]=e[s].copy(),i[s].name=s,i[s].node=this,i[s].type=t,this.allsockets.push(i[s]))}s=s.__proto__}return i};this.inputs=i("inputs"),this.outputs=i("outputs")}static init(t){return t.graphNode=new EventNode(t),t.graphNode}flagUpdate(){return this.flag|=NodeFlags.UPDATE,this.graph&&this.graph.flagUpdate(this),this}flagResort(){return this.graph&&this.graph.flagResort(this),this}}class EventGraph{nodes=[];flag=0;nodeIdMap=new Map;sockIdMap=new Map;sortlist=[];queueReq=void 0;#s=0;constructor(){}add(t){(t=this.eventNode(t)).graph=this,this.nodeIdMap.set(t.id,t),this.nodes.push(t),this.flagResort(t),this.flagUpdate(t)}has(t){return t=this.eventNode(t),this.nodeIdMap.has(t.id)}eventNode(t){if(t instanceof EventNode||(t=t.graphNode),void 0===t)throw console.warn("Not an event node:",arguments[0]),new Error("Not an event node");return t}remove(t){if(void 0===(t=this.eventNode(t)))throw new Error("EventGraph.prototype.remove(): node was undefined");if(!this.nodeIdMap.get(t.id))throw new Error("Node is not in event graph");this.nodeIdMap.delete(t.id);for(let e of Array.from(t.eventNode.allsockets)){this.sockIdMap.delete(e.id);try{e.disconnect()}catch(t){print_stack$1(t),console.error("Failed to disconnect a socket")}}t.graph=void 0,this.nodes.remove(t),this.flagResort()}flagResort(t){return t&&(t=this.eventNode(t)),this.flag|=RecalcFlags.RESORT|RecalcFlags.RUN,this}flagUpdate(t){return t=this.eventNode(t),this.flag|=RecalcFlags.RUN,this.#s||this.queueExec(),this}sort(){console.warn("Sorting Graph"),this.flag&=~RecalcFlags.RESORT;for(let t of this.nodes)t.flag&=~(NodeFlags.SORT_TAG1|NodeFlags.SORT_TAG2);let t=this.sortlist;this.sortlist.length=0;let e=i=>{if(i.flag&NodeFlags.SORT_TAG2)console.error("Cycle in event dag!",i);else{i.flag|=NodeFlags.SORT_TAG2;for(let[t,s]of Object.entries(i.inputs))for(let t of s.edges){let i=t.node;i.flag&NodeFlags.SORT_TAG1||e(i)}i.flag&=~NodeFlags.SORT_TAG2,i.flag|=NodeFlags.SORT_TAG1,i.sortIndex=t.length,t.push(i);for(let[t,s]of Object.entries(i.outputs))for(let t of s.edges){let i=t.node;i.flag&NodeFlags.SORT_TAG1||e(i)}}};for(let t of this.nodes)t.flag&NodeFlags.SORT_TAG1||e(t)}queueExec(){console.warn("queueExec",this.queueReq),this.flag|=RecalcFlags.RUN,void 0===this.queueReq&&(this.queueReq=!0,this.queueReq=window.setTimeout((()=>{this.queueReq=void 0,this.exec()}),0))}exec(){this.flag&=~RecalcFlags.RUN,this.flag&RecalcFlags.RESORT&&this.sort(),console.warn("Executing Graph"),this.#s++;let t=this.sortlist;for(let e of t)if(e.flag&NodeFlags.UPDATE){try{e.owner.graphExec()}catch(t){print_stack$1(t),console.error("Error during event graph execution")}e.flag&=~NodeFlags.UPDATE;for(let t in e.inputs){e.inputs[t].flag&=~SocketFlags.UPDATE}for(let t in e.outputs){let i=e.outputs[t];if(i.flag&SocketFlags.UPDATE){for(let t of i.edges)t.flag|=SocketFlags.UPDATE,t.node.flag|=SocketFlags.UPDATE;i.flag&=~SocketFlags.UPDATE}}}this.#s--}}const theEventGraph=new EventGraph,strBoolMap={true:"false",false:"true",on:"off",off:"on",yes:"no",no:"yes"};class DependSocket extends EventSocket{static socketDef={typeName:"depend",uiName:"depend",flag:0};#r=void 0;get value(){return this.#r}set value(t){this.#r=t}copyFrom(t){return super.copyFrom(t),this.#r=t.#r,this}}const PropSocketModes={REPLACE:0,MIN:1,MAX:2};class PropertySocket extends EventSocket{static socketDef={typeName:"property_socket",uiName:"Property Socket",flag:0};mixMode=PropSocketModes.REPLACE;#a={obj:null,key:""};#n=[];#o=!1;oldValue=void 0;mode(t){return this.mixMode=t,this}copyFrom(t){return super.copyFrom(t),this.#o=t.#o,this.#n=Array.from(t.#n),this.#a=t.#a,this}invert(t=!0){return this.#o=t,this}callback(t){return this.#n.push(t),this}get value(){let t=this.#a;return t.obj?t.obj[t.key]:void 0}set value(t){let e=this.value;if(this.#n.length>0)for(let i of this.#n)t=i(t,e);if(!this.#o||"number"!=typeof t&&"boolean"!=typeof t&&void 0!==t){if(this.#o&&"string"==typeof t){let e=t.toLowerCase().trim();e in strBoolMap&&(t=strBoolMap[e])}}else t=!t;let i=this.#a;i.obj?i.obj[i.key]=t:console.warn("Attempt to set unbound property socket",this)}bind(t,e){return this.#a.obj=t,this.#a.key=e,this}}var eventdag=Object.freeze({__proto__:null,SocketFlags:SocketFlags,NodeFlags:NodeFlags,RecalcFlags:RecalcFlags,SocketTypes:SocketTypes,EventSocket:EventSocket,NodeCapable:NodeCapable,EventNode:EventNode,EventGraph:EventGraph,theEventGraph:theEventGraph,DependSocket:DependSocket,PropSocketModes:PropSocketModes,PropertySocket:PropertySocket});let _ui_base,TextBox$1;function _setTextboxClass(t){TextBox$1=t}let ElementClasses=[];window.__cconst=exports;let Vector4$1=Vector4$2;const EnumProperty$8=EnumProperty$9;let Area$2,_setAreaClass=t=>{Area$2=t};const ErrorColors={WARNING:"yellow",ERROR:"red",OK:"green"};window.__theme=theme;let registered_has_happened=!1,tagPrefix="";const EventCBSymbol=Symbol("wrapped event callback");function calcElemCBKey(t,e,i){return t._id+":"+e+":"+JSON.stringify(i||{})}function setTagPrefix(t){if(registered_has_happened)throw new Error("have to call ui_base.setTagPrefix before loading any other path.ux modules");tagPrefix=""+t}function getTagPrefix(t){return tagPrefix}let prefix=document.getElementById("pathux-tag-prefix");prefix&&(console.log("Found pathux-tag-prefix element"),prefix=prefix.innerText.trim(),setTagPrefix(prefix));let class_idgen=1;function setTheme(t){for(let e in t){let i=t[e];if("object"!=typeof i){theme[e]=i;continue}theme[e];e in theme||(theme[e]={});for(let t in i){if(t in compatMap){let e=compatMap[t];void 0===i[e]&&(i[e]=i[t]),delete i[t],t=e}theme[e][t]=i[t]}}}setTheme(DefaultTheme);let _last_report=time_ms();function report(){time_ms()-_last_report>350&&(console.warn(...arguments),_last_report=time_ms())}function getDefault(t,e){if(console.warn("Deprecated call to ui_base.js:getDefault"),t in theme.base)return theme.base[t];throw new Error("Unknown default "+t)}function IsMobile(){return console.warn("ui_base.IsMobile is deprecated; use util.isMobile instead"),isMobile()}let keys=["margin","padding","margin-block-start","margin-block-end"];keys=keys.concat(["padding-block-start","padding-block-end"]),keys=keys.concat(["margin-left","margin-top","margin-bottom","margin-right"]),keys=keys.concat(["padding-left","padding-top","padding-bottom","padding-right"]);const marginPaddingCSSKeys=keys;class _IconManager{constructor(t,e,i,s){this.tilex=i,this.tilesize=e,this.drawsize=s,this.customIcons=new Map,this.image=t,this.promise=void 0,this._accept=void 0,this._reject=void 0}get ready(){return this.image&&this.image.width}onReady(){if(this.ready)return new Promise(((t,e)=>{t(this)}));if(this.promise)return this.promise;let t=this.image.onload;return this.image.onload=e=>{if(t&&t.call(this.image,e),!this._accept)return;let i=this._accept;this._accept=this._reject=this.promise=void 0,this.image.width&&i(this)},this.promise=new TimeoutPromise(((t,e)=>{this._accept=t,this._reject=e}),15e3,!0),this.promise.catch((t=>{print_stack$1(t),this.promise=this._accept=this._reject=void 0})),this.promise}canvasDraw(t,e,i,s,r=0,a=0){let n=this.customIcons.get(s);if(n)return void i.drawImage(n.canvas,r,a);let o=s%this.tilex,l=~~(s/this.tilex),h=t.getDPI(),c=this.tilesize,d=this.drawsize;if(this.image)try{i.drawImage(this.image,o*c,l*c,c,c,r,a,d*h,d*h)}catch(t){console.log(this.image),console.error(t.stack),console.error(t.message),console.error("failed to draw an icon")}}setCSS(t,e,i){i||(i=this.drawsize),"object"==typeof i&&(i=Math.max(i[0],i[1])),e.style.background=this.getCSS(t,i),this.customIcons.has(t)?e.style["background-size"]=i+"px":e.style["background-size"]=i*this.tilex+"px",e.style["background-clip"]="content-box",e.style.width||(e.style.width=this.drawsize+"px"),e.style.height||(e.style.height=this.drawsize+"px")}getCSS(t,e=this.drawsize){if(-1===t)return"";"object"==typeof e&&(e=Math.max(e[0],e[1]));let i=e/this.tilesize,s=this.customIcons.get(t);if(void 0!==s){return`url("${s.blobUrl}")`}let r=-t%this.tilex*this.tilesize*i,a=-~~(t/this.tilex)*this.tilesize*i;return`url("${this.image.src}") ${r}px ${a}px`}}class CustomIcon{constructor(t,e,i,s){this.key=e,this.baseImage=s,this.images=[],this.id=i,this.manager=t}regenIcons(){let t=this.manager,e=t=>{let e=t.drawsize,i=document.createElement("canvas"),s=i.getContext("2d");i.width=i.height=e,s.drawImage(this.baseImage,0,0,e,e),i.toBlob((e=>{let s=URL.createObjectURL(e);t.customIcons.set(this.id,{blobUrl:s,canvas:i})}))};for(let i of t.iconsheets)e(i)}}class IconManager{constructor(t,e,i){this.iconsheets=[],this.tilex=i,this.customIcons=new Map,this.customIconIDMap=new Map;for(let s=0;s<t.length;s++){let r,a;"object"==typeof e[s]?(r=e[s][0],a=e[s][1]):r=a=e[s],isMobile()&&(a=~~(a*theme.base.mobileSizeMultiplier)),this.iconsheets.push(new _IconManager(t[s],r,i,a))}}isReady(t=0){return this.iconsheets[t].ready}addCustomIcon(t,e){let i=this.customIcons.get(t);if(!i){let s=0;for(let t in Icons$2)s=Math.max(s,Icons$2[t]+1);for(let t of this.customIcons.values())s=Math.max(s,t.id+1);s=Math.max(s,1e3);let r=s;i=new CustomIcon(this,t,r,e),this.customIcons.set(t,i),this.customIconIDMap.set(r,i)}return i.baseImage=e,i.regenIcons(),i.id}load(t){return this.iconsheets=t.iconsheets,this.tilex=t.tilex,this}reset(t){this.iconsheets.length=0,this.tilex=t}add(t,e,i=e){return this.iconsheets.push(new _IconManager(t,e,this.tilex,i)),this}canvasDraw(t,e,i,s,r=0,a=0,n=0){let o=this.iconsheets[n],l=(n=this.findSheet(n)).drawsize;n.drawsize=o.drawsize,n.canvasDraw(t,e,i,s,r,a),n.drawsize=l}findClosestSheet(t){let e,i=this.iconsheets.concat([]);i.sort(((t,e)=>t.drawsize-e.drawsize));for(let s=0;s<i.length;s++)if(i[s].drawsize<=t){e=i[s];break}return e||(e=i[i.length-1]),this.iconsheets.indexOf(e)}findSheet(t){void 0===t&&(console.warn("sheet was undefined"),t=0);let e,i=this.iconsheets[t],s=UIBase$f.getDPI()*i.drawsize;for(let t of this.iconsheets)if(e=t,t.drawsize>=s)break;return void 0===e?i:e}getTileSize(t=0){return this.iconsheets[t].drawsize}getRealSize(t=0){return this.iconsheets[t].tilesize}getCSS(t,e=0){let i=this.iconsheets[e],s=(e=this.findSheet(e)).drawsize;e.drawsize=i.drawsize;let r=e.getCSS(t);return e.drawsize=s,r}setCSS(t,e,i=0,s){let r=this.iconsheets[i],a=(i=this.findSheet(i)).drawsize;i.drawsize=r.drawsize;let n=i.setCSS(t,e,s);return i.drawsize=a,n}}let iconmanager$1=new IconManager([document.getElementById("iconsheet16"),document.getElementById("iconsheet32"),document.getElementById("iconsheet48")],[16,32,64],16);window._iconmanager=iconmanager$1;let IconSheets$7={SMALL:0,LARGE:1,XLARGE:2};function iconSheetFromPackFlag(t){return t&PackFlags$a.CUSTOM_ICON_SHEET?t>>PackFlags$a.CUSTOM_ICON_SHEET_START:t&PackFlags$a.SMALL_ICON&&!PackFlags$a.LARGE_ICON?0:1}function getIconManager(){return iconmanager$1}function setIconManager(t,e){if(iconmanager$1.load(t),void 0!==e)for(let t in e)IconSheets$7[t]=e[t]}function makeIconDiv(t,e=0){iconmanager$1.getRealSize(e);let i=iconmanager$1.getTileSize(e),s=document.createElement("div");return s.style.width=s.style["min-width"]=i+"px",s.style.height=s.style["min-height"]=i+"px",s.style.margin="0px",s.style.padding="0px",iconmanager$1.setCSS(t,s,e),s}let Vector2$9=Vector2$b,Matrix4$1=Matrix4$2,dpistack=[];const UIFlags={},internalElementNames={},externalElementNames={},PackFlags$a={INHERIT_WIDTH:1,INHERIT_HEIGHT:2,VERTICAL:4,USE_ICONS:8,SMALL_ICON:16,LARGE_ICON:32,FORCE_PROP_LABELS:64,PUT_FLAG_CHECKS_IN_COLUMNS:128,WRAP_CHECKBOXES:256,STRIP_HORIZ:512,STRIP_VERT:1024,STRIP:1536,SIMPLE_NUMSLIDERS:2048,FORCE_ROLLER_SLIDER:4096,HIDE_CHECK_MARKS:8192,NO_NUMSLIDER_TEXTBOX:16384,CUSTOM_ICON_SHEET:32768,CUSTOM_ICON_SHEET_START:20,NO_UPDATE:65536,LABEL_ON_RIGHT:1<<17};let first=t=>{if(void 0!==t)if(Symbol.iterator in t)for(let e of t)return e;else for(let e in t)return e},_mobile_theme_patterns=[/.*width.*/,/.*height.*/,/.*size.*/,/.*margin.*/,/.*pad/,/.*radius.*/],_idgen=0;function styleScrollBars$1(t="grey",e,i=.5,s=15,r="1px groove black",a="*"){if(!e){let s=css2color(t),r=s.length>3?s[3]:1;s=rgb_to_hsv(s[0],s[1],s[2]);let a=s.slice(0,s.length);a[2]=1-a[2],a[2]+=(s[2]-a[2])*(1-i),a=hsv_to_rgb(a[0],a[1],a[2]),a.length=4,a[3]=r,a=color2css(a),e=a}return`\n\n${a} {\n  scrollbar-width : ${s<=16?"thin":"auto"};\n  scrollbar-color : ${e} ${t};\n}\n\n${a}::-webkit-scrollbar {\n  width : ${s}px;\n  background-color : ${t};\n}\n\n${a}::-webkit-scrollbar-track {\n  background-color : ${t};\n  border : ${r};\n}\n\n${a}::-webkit-scrollbar-thumb {\n  background-color : ${e};\n  border : ${r};\n}\n    `}window._testSetScrollbars=function(t="grey",e=.5,i=15,s="solid"){let r=styleScrollBars$1(t,void 0,e,i,s,"*");return CTX.screen.mergeGlobalCSS(r),r},window.styleScrollBars=styleScrollBars$1;let _digest=new HashDigest;function calcThemeKey(t=_digest.reset()){for(let e in theme){let i=theme[e];if("object"==typeof i)for(let e in i){let s=i[e];"number"==typeof s||"boolean"==typeof s||"string"==typeof s?t.add(s):"object"==typeof s&&s instanceof CSSFont&&s.calcHashUpdate(t)}}return t.get()}var _themeUpdateKey=calcThemeKey();function flagThemeUpdate(){_themeUpdateKey=calcThemeKey()}window._flagThemeUpdate=flagThemeUpdate;let setTimeoutQueue=new Set,haveTimeout=!1,_mc;function timeout_cb(){if(0!==setTimeoutQueue.size){for(let t of new Set(setTimeoutQueue)){let{cb:e,timeout:i,time:s}=t;if(!(time_ms()-s<i)){setTimeoutQueue.delete(t);try{e()}catch(t){console.error(t.stack)}}}window.setTimeout(timeout_cb,0)}else haveTimeout=!1}function internalSetTimeout(t,e){e>100?window.setTimeout(t,e):(setTimeoutQueue.add({cb:t,timeout:e,time:time_ms()}),haveTimeout||(haveTimeout=!0,window.setTimeout(timeout_cb,0)))}window.setTimeoutQueue=setTimeoutQueue;class UIBase$f extends HTMLElement{#l=!1;static graphNodeDef=EventNode.register(this,{typeName:this.name,uiName:this.name,inputs:{depend:new DependSocket},outputs:{depend:new DependSocket}});graphExec(){let t=this.graphNode;t.inputs.depend.isUpdated&&t.outputs.depend.flagUpdate();for(let e in t.inputs){let i=t.inputs[e];if(!(i instanceof PropertySocket))continue;let s=i.value,r=!0;for(let t of i.edges)if(r)s=t.value,r=!1;else switch(i.mixMode){case PropSocketModes.REPLACE:s=t.value;break;case PropSocketModes.MIN:s=Math.min(s,t.value);break;case PropSocketModes.MAX:s=Math.max(s,t.value)}i.value=s}function e(t){if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(void 0!==t[e]&&"number"!=typeof t[e]&&"boolean"!=typeof t[e])return!1;return!0}for(let i in t.outputs){let s=t.outputs[i];if(!(s instanceof PropertySocket))continue;let r,a=s.value;if("boolean"==typeof a||"string"==typeof a||"number"==typeof a)r=a!==s.oldValue,s.oldValue=a;else if("object"==typeof a)if(e(a))if(s.oldValue){if(s.oldValue.length!==a.length)r=!0;else for(let t=0;t<s.oldValue.length;t++)r=s.oldValue[t]!==a[t];s.oldValue.length!==a.length&&(s.oldValue.length=a.length);for(let t=0;t<a.length;t++)s.oldValue[t]=a.value[t]}else s.oldValue=Array.from(a);else if(void 0===s.oldValue)s.oldValue=JSON.stringify(a);else{let t=JSON.stringify(a);r=t!==s.oldValue,s.oldValue=t}r&&(console.log("Propagating prop update"),s.flagUpdate())}}ensureGraph(){console.log("Ensure Graph",this,this.graphNode,this.graphNode.id),theEventGraph.has(this)||theEventGraph.add(this)}flagPropSocketUpdate(t){let e=this.getPropertySocket(t,SocketTypes.OUTPUT);return e&&(console.warn(`Flag socket "${t}" for update`),e.flagUpdate()),this}getPropertySocket(t,e){let i=this.graphNode,s=e===SocketTypes.INPUT?i.inputs:i.outputs;if(s[t])return s[t]}ensurePropertySocket(t,e){this.ensureGraph();let i=this.graphNode,s=e===SocketTypes.INPUT?i.inputs:i.outputs;if(s[t])return s[t];let r=new PropertySocket;return r.bind(this,t),i.addSocket(e,t,r),"value"===t&&r.callback((t=>this.getValue?this.getValue():this.value)),r}dependsOn(t,e,i,s,r){let a=this.ensurePropertySocket(t,SocketTypes.INPUT),n=e.ensurePropertySocket(i,SocketTypes.OUTPUT);return s&&n.callback(s),a.connect(n),a}constructor(){super(),EventNode.init(this),this._modalstack=[],this._tool_tip_abort_delay=void 0,this._tooltip_ref=void 0,this._textBoxEvents=!1,this._themeOverride=void 0,this._checkTheme=!0,this._last_theme_update_key=_themeUpdateKey,this._client_disabled_set=void 0,this._useNativeToolTips=exports.useNativeToolTips,this._useNativeToolTips_set=!1,this._has_own_tooltips=void 0,this._tooltip_timer=time_ms(),this.pathUndoGen=0,this._lastPathUndoGen=0,this._useDataPathUndo=void 0,this._active_animations=[],this._screenStyleTag=document.createElement("style"),this._screenStyleUpdateHash=0,initAspectClass(this,new Set(["appendChild","animate","shadow","removeNode","prepend","add","init"])),this.shadow=this.attachShadow({mode:"open"}),exports.DEBUG.paranoidEvents&&(this.__cbs=[]),this.shadow.appendChild(this._screenStyleTag),this.shadow._appendChild=this.shadow.appendChild;this.shadow.appendChild;this.shadow.appendChild=t=>(t&&"object"==typeof t&&t instanceof UIBase$f&&(t.parentWidget=this),this.shadow._appendChild(t,...arguments)),this._wasAddedToNodeAtSomeTime=!1,this.visibleToPick=!0,this._override_class=void 0,this.parentWidget=void 0;let t=this.constructor.define().tagname;this._id=t.replace(/\-/g,"_")+_idgen++,this.default_overrides={},this.my_default_overrides={},this.class_default_overrides={},this._last_description=void 0,this._description_final=void 0,this._modaldata=void 0,this.packflag=this.getDefault("BasePackFlag"),this._internalDisabled=!1,this.__disabledState=!1,this._disdata=void 0,this._ctx=void 0,this._description=void 0;let e=document.createElement("style");e.textContent="\n    .DefaultText {\n      font: "+_getFont(this)+";\n    }\n    ",this.shadow.appendChild(e),this._init_done=!1;let i=(t,e,i)=>{if(haveModal())return;i=void 0===i?0:i;let s=copyEvent(t);if(0===t.touches.length);else{let e=t.touches[0];s.pageX=e.pageX,s.pageY=e.pageY,s.screenX=e.screenX,s.screenY=e.screenY,s.clientX=e.clientX,s.clientY=e.clientY,s.x=e.x,s.y=e.y}s.button=i,s=new MouseEvent(e,s),s.was_touch=!0,s.stopPropagation=t.stopPropagation.bind(t),s.preventDefault=t.preventDefault.bind(t),s.touches=t.touches,this.dispatchEvent(s)};this.addEventListener("touchstart",(t=>{i(t,"mousedown",0)}),{passive:!1}),this.addEventListener("touchmove",(t=>{i(t,"mousemove")}),{passive:!1}),this.addEventListener("touchcancel",(t=>{i(t,"mouseup",2)}),{passive:!1}),this.addEventListener("touchend",(t=>{i(t,"mouseup",0)}),{passive:!1}),this.constructor.define().havePickClipboard&&this._clipboardHotkeyInit()}get useNativeToolTips(){return this._useNativeToolTips}set useNativeToolTips(t){this._useNativeToolTips=t,this._useNativeToolTips_set=!0}get parentWidget(){return this._parentWidget}set parentWidget(t){t&&(this._wasAddedToNodeAtSomeTime=!0),this._parentWidget=t}get useDataPathUndo(){let t=this;for(;t;){if(void 0!==t._useDataPathUndo)return t._useDataPathUndo;t=t.parentWidget}return!0}set useDataPathUndo(t){this._useDataPathUndo=t}get description(){return this._description}set description(t){if(null!==t){if(this._description=t,null!=t){if(exports.showPathsInToolTips&&this.hasAttribute("datapath")){let t=""+this._description;if(t+="\n    path: "+this.getAttribute("datapath"),this.hasAttribute("mass_set_path")){t+="\n    massSetPath: "+this.getAttribute("mass_set_path")}this._description_final=t}else this._description_final=this._description;exports.useNativeToolTips&&(this.title=""+this._description_final)}}else this._description=void 0}get background(){return this.__background}set background(t){this.__background=t,this.overrideDefault("background-color",t,!0),this.style["background-color"]=t}get disabled(){return!(!this.parentWidget||!this.parentWidget.disabled)||(!!this._client_disabled_set||!!this._internalDisabled)}set disabled(t){this._client_disabled_set=t,this.__updateDisable(this.disabled)}get internalDisabled(){return this._internalDisabled}set internalDisabled(t){this._internalDisabled=!!t,this.__updateDisable(this.disabled)}get ctx(){return this._ctx}set ctx(t){this._ctx=t,this._forEachChildWidget((e=>{e.ctx=t}))}get _reportCtxName(){return""+this._id}get modalRunning(){return void 0!==this._modaldata}static getIconEnum(){return Icons$2}static setDefault(t){return t}static getDPI(){return window.devicePixelRatio}static prefix(t){return tagPrefix+t}static internalRegister(t){t[ClassIdSymbol]=class_idgen++,registered_has_happened=!0,internalElementNames[t.define().tagname]=this.prefix(t.define().tagname),customElements.define(this.prefix(t.define().tagname),t)}static getInternalName(t){return internalElementNames[t]}static createElement(t,e=!1){return!e&&t in externalElementNames?document.createElement(t):t in internalElementNames?document.createElement(internalElementNames[t]):document.createElement(t)}static register(t){registered_has_happened=!0,t[ClassIdSymbol]=class_idgen++,ElementClasses.push(t),externalElementNames[t.define().tagname]=t.define().tagname,customElements.define(t.define().tagname,t)}static define(){throw new Error("Missing define() for ux element")}setUndo(t){return this.useDataPathUndo=t,this}set hidden(t){t=!!t,super.hidden=t;for(let e of this.shadow.childNodes)e.hidden=t;this._forEachChildWidget((e=>{e.hide(t)}))}get hidden(){return super.hidden}hide(t=!0){return this.hidden=t,this}getElementById(t){let e,i=s=>{if(!e){if(s.getAttribute("id")!==t&&s.id!==t||(e=s),s instanceof UIBase$f&&"panelframe-x"===s.constructor.define().tagname)i(s.contents);else if(s instanceof UIBase$f&&"tabcontainer-x"===s.constructor.define().tagname)for(let t in s.tabs){let e=s.tabs[t];e&&i(e)}for(let t of s.childNodes)if(t instanceof HTMLElement&&(i(t),e))break;if(s.shadow)for(let t of s.shadow.childNodes)if(t instanceof HTMLElement&&(i(t),e))break}};return i(this),e}unhide(){this.hide(!1)}findArea(){let t=this;for(;t;){if(t instanceof Area$2)return t;t=t.parentWidget}return t}addEventListener(t,e,i){exports.DEBUG.domEventAddRemove&&console.log("addEventListener",t,this._id,i);let s=s=>{if(exports.DEBUG.paranoidEvents&&this.isDead())return void this.removeEventListener(t,e,i);exports.DEBUG.domEvents&&pathDebugEvent(s);let r=this.findArea();if(!r)return exports.DEBUG.areaContextPushes&&console.warn("Element is not part of an area?",element),e(s);r.push_ctx_active();try{let t=e(s);return r.pop_ctx_active(),t}catch(t){throw r.pop_ctx_active(),t}};e[EventCBSymbol]||(e[EventCBSymbol]=new Map);let r=calcElemCBKey(this,t,i);return e[EventCBSymbol].set(r,s),exports.DEBUG.paranoidEvents&&this.__cbs.push([t,s,i]),super.addEventListener(t,s,i)}removeEventListener(t,e,i){if(exports.DEBUG.paranoidEvents)for(let s of this.__cbs)if(s[0]==t&&s[1]===e._cb2&&""+s[2]==""+i){this.__cbs.remove(s);break}exports.DEBUG.domEventAddRemove&&console.log("removeEventListener",t,this._id,i);let s=calcElemCBKey(this,t,i);if(e[EventCBSymbol]&&e[EventCBSymbol].has(s)){let r=e[EventCBSymbol].get(s),a=super.removeEventListener(t,r,i);return e[EventCBSymbol].delete(s),a}return super.removeEventListener(t,e,i)}connectedCallback(){}noMarginsOrPadding(){let t=["margin","padding","margin-block-start","margin-block-end"];t=t.concat(["padding-block-start","padding-block-end"]),t=t.concat(["margin-left","margin-top","margin-bottom","margin-right"]),t=t.concat(["padding-left","padding-top","padding-bottom","padding-right"]);for(let e of t)this.style[e]="0px";return this}regenTabOrder(){let t=this.getScreen();return void 0!==t&&(t.needsTabRecalc=!0),this}noMargins(){return this.style.margin=this.style["margin-left"]=this.style["margin-right"]="0px",this.style["margin-top"]=this.style["margin-bottom"]="0px",this}noPadding(){return this.style.padding=this.style["padding-left"]=this.style["padding-right"]="0px",this.style["padding-top"]=this.style["padding-bottom"]="0px",this}getTotalRect(){let t=!1,e=new Vector2$9([1e17,1e17]),i=new Vector2$9([-1e17,-1e17]),s=s=>{let r=s.getClientRects();for(let s of r)e[0]=Math.min(e[0],s.x),e[1]=Math.min(e[1],s.y),i[0]=Math.max(i[0],s.x+s.width),i[1]=Math.max(i[1],s.y+s.height),t=!0};return s(this),this._forEachChildWidget((t=>{s(t)})),t?{width:i[0]-e[0],height:i[1]-e[1],x:e[0],y:e[1],left:e[0],top:e[1],right:i[0],bottom:i[1]}:void 0}parseNumber(t,e={}){t=(""+t).trim().toLowerCase();let i=e.baseUnit||this.baseUnit,s=e.isInt||this.isInt,r=1;t.startsWith("-")&&(t=t.slice(1,t.length).trim(),r=-1);return t.startsWith("0b")?(t=t.slice(2,t.length).trim(),t=parseInt(t,2)):t.startsWith("0x")?(t=t.slice(2,t.length).trim(),t=parseInt(t,16)):0===t.search(/-?[0-9a-f]+h$/)?(t=t.slice(0,t.length-1).trim(),t=parseInt(t,16)):t=parseValue(t,i),s&&(t=~~t),t*r}formatNumber(t,e={}){let i=e.baseUnit||this.baseUnit,s=e.displayUnit||this.displayUnit,r=e.isInt||this.isInt,a=e.radix||this.radix||10,n=e.decimalPlaces||this.decimalPlaces;if(r&&10!==a){let e=Math.floor(t).toString(a);if(2===a)return"0b"+e;if(16===a)return e+"h"}return buildString(t,i,n,s)}setBoxCSS(t){let e,i=["left","right","top","bottom"];t&&(e=this.getAttribute(t)||{});let s=i=>e?this.getSubDefault(t,i):this.getDefault(i);for(let t=0;t<2;t++){let e=t?"padding":"margin";this.style[e]="unset";let r=s(e);if(void 0!==r)for(let t=0;t<4;t++)this.style[e+"-"+i[t]]=r+"px";for(let t=0;t<4;t++){let r=`${e}-${i[t]}`,a=s(r);void 0!==a&&(this.style[r]=a+"px")}}this.style["border-radius"]=s("border-radius")+"px",this.style.border=`${s("border-width")}px ${s("border-style")} ${s("border-color")}`}genBoxCSS(t){let e,i="",s=["left","right","top","bottom"];t&&(e=this.getAttribute(t)||{});let r=i=>e?this.getSubDefault(t,i):this.getDefault(i);for(let t=0;t<2;t++){let e=t?"padding":"margin",a=r(e);void 0!==a&&(i+=`${e}: ${a} px;\n`);for(let t=0;t<4;t++){let n=`${e}-${s[t]}`;void 0!==r(n)&&(i+=`${n}: ${a}px;\n`)}}return i+=`border-radius: ${r("border-radius")}px;\n`,i+=`border: ${r("border-width")}px ${r("border-style")} ${r("border-color")};\n`,i}setCSS(t=!0){if(t){let t=this.getDefault("background-color");t&&(this.style["background-color"]=t)}let e=this.getZoom();if(1===e)return;let i=""+this.style.transform;i=i.replace(/[ \t\n\r]+/g," "),i=i.replace(/, /g,",");let s=i.replace(/scale\([^)]+\)/,"").trim();this.style.transform=s+` scale(${e},${e})`}flushSetCSS(){this._init(),this.setCSS(),this._forEachChildWidget((t=>{t.packflag&PackFlags$a.NO_UPDATE||t.flushSetCSS()}))}replaceChild(t,e){for(let i=0;i<this.childNodes.length;i++)if(this.childNodes[i]===e)return super.replaceChild(t,e),!0;for(let i=0;i<this.shadow.childNodes.length;i++)if(this.shadow.childNodes[i]===e)return this.shadow.replaceChild(t,e),!0;return console.error("Unknown child node",e),!1}swapWith(t){let e=this.parentNode,i=t.parentNode;if((this.parentWidget&&e===this.parentWidget.shadow||null===e)&&(e=this.parentWidget),(t.parentWidget&&i===t.parentWidget.shadow||null===i)&&(i=t.parentWidget),!e||!i)return console.error("Invalid call to UIBase.prototype.swapWith",this,t,e,i),!1;let s=(t,e)=>{let i=Array.prototype.indexOf.call(e.childNodes,t);return i<0&&e.shadow&&(e=e.shadow,i=Array.prototype.indexOf.call(e.childNodes,t)),[i,e]},[r,a]=s(this,e),[n,o]=s(t,i);console.log("i1, i2, n1, n2",r,n,a,o);let l=document.createElement("div"),h=document.createElement("div");a.insertBefore(l,this),o.insertBefore(h,t),a.replaceChild(t,l),o.replaceChild(this,h);let c=this.parentWidget;return this.parentWidget=t.parentWidget,t.parentWidget=c,l.remove(),h.remove(),!0}traverse(t){let e=this,i=t,s=t instanceof Set;s=s||t instanceof set$2,s=s||Array.isArray(t),s||(i=[t]);let r=new Set;return function*(){let t=[e];for(;t.length>0;){let e=t.pop();if(r.add(e),e&&e.childNodes){for(let t of i)e instanceof t&&(yield e);for(let i of e.childNodes)r.has(i)||t.push(i);if(e.shadow)for(let i of e.shadow.childNodes)r.has(i)||t.push(i)}}}()}appendChild(t){return t instanceof UIBase$f&&(t.ctx=this.ctx,t.parentWidget=this,t.useDataPathUndo=this.useDataPathUndo),super.appendChild(t)}_clipboardHotkeyInit(){this._clipboard_over=!1,this._last_clipboard_keyevt=void 0,this._clipboard_keystart=()=>{this._clipboard_events||(this._clipboard_events=!0,window.addEventListener("keydown",this._clipboard_keydown,{capture:!0,passive:!1}))},this._clipboard_keyend=()=>{this._clipboard_events&&(this._clipboard_events=!1,window.removeEventListener("keydown",this._clipboard_keydown,{capture:!0,passive:!1}))},this._clipboard_keydown=(t,e)=>{if(!this.isConnected||!exports.getClipboardData)return void this._clipboard_keyend();if(t===this._last_clipboard_keyevt||!this._clipboard_over)return;let i=t.keyCode===keymap$4.C&&(t.ctrlKey||t.commandKey)&&!t.shiftKey&&!t.altKey,s=t.keyCode===keymap$4.V&&(t.ctrlKey||t.commandKey)&&!t.shiftKey&&!t.altKey;if(i||s){if(e)console.warn("COLOR",this._id);else{let t=this.ctx.screen,e=t.pickElement(t.mpos[0],t.mpos[1]),r=s&&this.constructor.define().pasteForAllChildren;for(r=r||i&&this.constructor.define().copyForAllChildren;r&&!(e instanceof TextBox$1)&&e!==this&&e.parentWidget;)console.log("  "+e._id),e=e.parentWidget;if(console.warn("COLOR",this._id,e._id),e!==this)return void this._clipboard_keyend()}this._last_clipboard_keyevt=t,i&&(this.clipboardCopy(),t.preventDefault(),t.stopPropagation()),s&&(this.clipboardPaste(),t.preventDefault(),t.stopPropagation())}};let t=t=>{this._clipboard_over=!1,this._clipboard_keyend()};this.doOnce((()=>{this.tabIndex=0})),this.addEventListener("keydown",(t=>this._clipboard_keydown(t,!0))),this.addEventListener("pointerover",(t=>{this._clipboard_over=!0,this._clipboard_keystart()}),{capture:!0,passive:!0}),this.addEventListener("pointerout",t,{capture:!0,passive:!0}),this.addEventListener("focus",t,{capture:!0,passive:!0})}clipboardCopy(){throw new Error("implement me!")}clipboardPaste(){throw new Error("implement me!")}init(){this._init_done=!0,!this.hasAttribute("id")&&this._id&&this.setAttribute("id",this._id)}_ondestroy(){if(this.tabIndex>=0&&this.regenTabOrder(),exports.DEBUG.paranoidEvents){for(let t of this.__cbs)this.removeEventListener(t[0],t[1],t[2]);this.__cbs=[]}void 0!==this.ondestroy&&this.ondestroy()}remove(t=!0){this.tabIndex>=0&&this.regenTabOrder(),super.remove(),t&&this._ondestroy(),this.on_remove&&this.on_remove(),this.parentWidget=void 0}on_remove(){}removeChild(t,e=!0){super.removeChild(t),e&&t._ondestroy()}flushUpdate(t=!1){this._init(),this.update(),this._forEachChildWidget((e=>{!t&&e.packflag&PackFlags$a.NO_UPDATE||(e.ctx||(e.ctx=this.ctx),e.flushUpdate(t))}))}_forEachChildWidget(t,e){let i=s=>{if(s instanceof UIBase$f)void 0!==e?t.call(e,s):t(s);else{for(let t of s.childNodes)i(t);if(void 0!==s.shadow)for(let t of s.shadow.childNodes)i(t)}};for(let t of this.childNodes)i(t);if(this.shadow)for(let t of this.shadow.childNodes)i(t)}checkInit(){return this._init()}_init(){return!this._init_done&&(this._init_done=!0,this.init(),!0)}getWinWidth(){return window.innerWidth}getWinHeight(){return window.innerHeight}calcZ(){let t=this,e=this;for(;e;){if(e.style&&e.style["z-index"]){return parseFloat(e.style["z-index"])}e=e.parentNode,e||(e=t=t.parentWidget)}return 0}pickElement(t,e,i={},s=0,r=UIBase$f,a){let n,o,l,h;"object"==typeof i?(r=i.nodeclass||UIBase$f,a=i.excluded_classes,n=i.clip,o=i.mouseEvent):i={nodeclass:r||UIBase$f,excluded_classes:a,clip:n},o&&(l="mousemove"===o.type||"touchmove"===o.type||"pointermove"===o.type,h=o.buttons||o.touches&&o.touches.length>0),t-=window.scrollX,e-=window.scrollY;let c=document.elementFromPoint(t,e);if(!c)return;let d=[c],u=c,p=0;for(;c&&c.shadow;){if(p++>1e3){console.error("Infinite loop error");break}if(c=c.shadow.elementFromPoint(t,e),c===u)break;c&&d.push(c),u=c}d.reverse();for(let t=0;t<d.length;t++){let e=d[t],i=e instanceof r;if(a)for(let t of a)i=i&&!(e instanceof t);if(n){let t=e.getBoundingClientRect(),s=aabb_intersect_2d(n.pos,n.size,[t.x,t.y],[t.width,t.height]);i=i&&s}if(i)return window.elem=e,e}}__updateDisable(t){if(!!t==!!this.__disabledState)return;if(this.__disabledState=!!t,t&&!this._disdata){let e=this.getDefault("disabled")||this.getDefault("internalDisabled")||{"background-color":this.getDefault("DisabledBG")};this._disdata={style:{},defaults:{}};for(let t in e){this._disdata.style[t]=this.style[t],this._disdata.defaults[t]=this.default_overrides[t];let i=e[t];if("object"==typeof i&&i instanceof CSSFont)this.style[t]=e[t].genCSS();else{if("object"==typeof i)continue;this.style[t]=e[t]}this.default_overrides[t]=e[t]}this.__disabledState=!!t,this.on_disabled()}else if(!t&&this._disdata){for(let t in this._disdata.style)this.style[t]=this._disdata.style[t];for(let t in this._disdata.defaults){let e=this._disdata.defaults[t];void 0===e?delete this.default_overrides[t]:this.default_overrides[t]=e}this._disdata=void 0,this.__disabledState=!!t,this.on_enabled()}this.__disabledState=!!t;this._forEachChildWidget((t=>{if(t instanceof UIBase$f){let e=!!t.__disabledState;t.__updateDisable(t.disabled),e=e!==!!t.__disabledState,e&&(t.update(),t.setCSS())}}))}on_disabled(){}on_enabled(){}pushModal(t=this,e=!0,i,s=this){void 0!==this._modaldata&&(console.warn("UIBase.prototype.pushModal called when already in modal mode"),this.popModal());let r=contextWrangler.copy();function a(e){return function(){return r.copyTo(contextWrangler),e.apply(t,arguments)}}contextWrangler.copy(this.ctx);let n={};for(let e in t){let i=t[e];"function"==typeof i&&(n[e]=a(i))}return this._modaldata=void 0!==i&&s?pushPointerModal(n,e):pushModalLight(n,e),this._modaldata}popModal(){void 0!==this._modaldata?(popModalLight(this._modaldata),this._modaldata=void 0):console.warn("Invalid call to UIBase.prototype.popModal")}_flash_focus(){this.focus()}flash(t,e=this,i=355,s=!0){"object"!=typeof t&&(t=css2color(t)),t=new Vector4$1(t);let r=color2css(t);if(void 0!==this._flashtimer&&this._flashcolor!==r)return void window.setTimeout((()=>{this.flash(t,e,i,s)}),100);if(void 0!==this._flashtimer)return;let a,n=e.getBoundingClientRect();if(void 0===n)return;let o=0,l=~~(i/20),h=n.x,c=n.y,d=e=>{if(void 0===a)return;let i=1-o/l;u.style["background-color"]=color2css(t,i*i*.5),o>l&&(window.clearInterval(a),this._flashtimer=void 0,this._flashcolor=void 0,a=void 0,u.remove(),s&&this._flash_focus()),o++};window.setTimeout(d,5),this._flashtimer=a=window.setInterval(d,20);let u=document.createElement("div");u.style["pointer-events"]="none",u.tabIndex=void 0,u.style["z-index"]="900",u.style.display="float",u.style.position=UIBase$f.PositionKey,u.style.margin="0px",u.style.left=h+"px",u.style.top=c+"px",u.style["background-color"]=color2css(t,.5),u.style.width=n.width+"px",u.style.height=n.height+"px",u.setAttribute("class","UIBaseFlash");let p=this.getScreen();void 0!==p&&p._enterPopupSafe(),document.body.appendChild(u),s&&this._flash_focus(),this._flashcolor=r,void 0!==p&&p._exitPopupSafe()}destroy(){}on_resize(t){}toJSON(){let t={};return this.hasAttribute("datapath")&&(t.datapath=this.getAttribute("datapath")),t}loadJSON(t){this._init_done||this._init()}getPathValue(t,e){try{return t.api.getValue(t,e)}catch(t){return}}undoBreakPoint(){this.pathUndoGen++}setPathValueUndo(t,e,i){this.pathSocketUpdate(t,e);let s=this.getAttribute("mass_set_path"),r=t.api.resolvePath(t,e),a=r.prop;if(t.api.getValue(t,e)===i)return;let n=this.ctx.toolstack,o=n.head,l=void 0===o||!(o instanceof getDataPathToolOp());if(l=l||o.hashThis()!==o.hash(s,e,a.type,this._id),l=l||this.pathUndoGen!==this._lastPathUndoGen,l){this._lastPathUndoGen=this.pathUndoGen;let r=getDataPathToolOp().create(t,e,i,this._id,s);if(!r)return;t.toolstack.execTool(this.ctx,r),o=n.head}else n.undo(),o.setValue(t,i,r.obj),n.redo();if(!o||!0===o.hadError)throw new Error("toolpath error")}loadNumConstraints(t,e=this,i){let s=!1;if(!t){let i;e.hasAttribute("datapath")&&(i=e.getAttribute("datapath")),void 0===i&&this.hasAttribute("datapath")&&(i=this.getAttribute("datapath")),"string"==typeof i&&(t=this.getPathMeta(this.ctx,i))}let r=(i,r=key,a=key)=>{let n=this[a];e.hasAttribute(r)?this[a]=parseFloat(e.getAttribute(r)):t&&(this[a]=t[i]),this[a]!==n&&(s=!0)};for(let t of NumberConstraints){let e=t,i=t;"range"!==t&&r(t,i,e)}let a=this.range[0],n=this.range[1],o=t?t.range:void 0;o&&!e.hasAttribute("min")?this.range[0]=o[0]:e.hasAttribute("min")&&(this.range[0]=parseFloat(e.getAttribute("min"))),o&&!e.hasAttribute("max")?this.range[1]=o[1]:e.hasAttribute("max")&&(this.range[1]=parseFloat(e.getAttribute("max"))),this.range[0]===a&&this.range[1]===n||(s=!0);let l=this.isInt;if(e.getAttribute("integer")){let t=e.getAttribute("integer");t=(""+t).toLowerCase(),this.isInt="null"===t||"true"===t||"yes"===t||"1"===t}else t&&t instanceof IntProperty&&(this.isInt=!0);!this.isInt!=!l&&(s=!0);let h=this.editAsBaseUnit;void 0===this.editAsBaseUnit&&(t&&t.flag&PropFlags$3.EDIT_AS_BASE_UNIT?this.editAsBaseUnit=!0:this.editAsBaseUnit=!1),!this.editAsBaseUnit!=!h&&(s=!0),s&&(this.setCSS(),i&&i.call(this))}pushReportContext(t){this.ctx.api.pushReportContext&&this.ctx.api.pushReportContext(t)}popReportContext(){this.ctx.api.popReportContext&&this.ctx.api.popReportContext()}pathSocketUpdate(t,e){return this.flagPropSocketUpdate("value"),this}setPathValue(t,e,i){if(this.pathSocketUpdate(t,e),this.useDataPathUndo){this.pushReportContext(this._reportCtxName);try{this.setPathValueUndo(t,e,i)}catch(t){if(this.popReportContext(),t instanceof DataPathError)return;throw t}this.popReportContext()}else{this.pushReportContext(this._reportCtxName);try{this.hasAttribute("mass_set_path")?(t.api.massSetProp(t,this.getAttribute("mass_set_path"),i),t.api.setValue(t,e,i)):t.api.setValue(t,e,i)}catch(t){if(this.popReportContext(),!(t instanceof DataPathError))throw t;return}this.popReportContext()}}getPathMeta(t,e){this.pushReportContext(this._reportCtxName);let i=t.api.resolvePath(t,e);return this.popReportContext(),void 0!==i?i.prop:void 0}getPathDescription(t,e){let i;this.pushReportContext(this._reportCtxName);try{i=t.api.getDescription(t,e)}catch(t){if(this.popReportContext(),t instanceof DataPathError)return;throw t}return this.popReportContext(),i}getScreen(){if(void 0!==this.ctx)return this.ctx.screen}isDead(){return!this.isConnected}doOnce(t,e){void 0===t._doOnce&&(t._doOnce_reqs=new Set,t._doOnce=function(i,s){t._doOnce_reqs.has(i._id)||(t._doOnce_reqs.add(i._id),internalSetTimeout((function e(){if(i.isDead()){if(t._doOnce_reqs.delete(i._id),t===i._init||!exports.DEBUG.doOnce)return;console.warn("Ignoring doOnce call for dead element",i._id,t,s)}else{if(!i.ctx)return exports.DEBUG.doOnce&&console.warn("doOnce call is waiting for context...",i._id,t),void internalSetTimeout(e,0);t._doOnce_reqs.delete(i._id),t.call(i)}}),e))});let i=(new Error).stack;t._doOnce(this,i)}float(t=0,e=0,i,s=UIBase$f.PositionKey){return this.style.position=s,this.style.left=t+"px",this.style.top=e+"px",void 0!==i&&(this.style["z-index"]=i),this}_ensureChildrenCtx(){let t=this.ctx;void 0!==t&&this._forEachChildWidget((e=>{e.parentWidget=this,void 0===e.ctx&&(e.ctx=t),e._ensureChildrenCtx(t)}))}checkThemeUpdate(){return!!exports.enableThemeAutoUpdate&&(_themeUpdateKey!==this._last_theme_update_key&&(this._last_theme_update_key=_themeUpdateKey,!0))}abortToolTips(t=500){return this._has_own_tooltips&&this._has_own_tooltips.stop_timer(),this._tooltip_ref&&(this._tooltip_ref.remove(),this._tooltip_ref=void 0),this._tool_tip_abort_delay=time_ms()+t,this}updateToolTipHandlers(){if(this._useNativeToolTips_set||!exports.useNativeToolTips==!this._useNativeToolTips||(this._useNativeToolTips=exports.useNativeToolTips),!!this.useNativeToolTips!=!this._has_own_tooltips)if(this.useNativeToolTips){console.warn(this.id,"removing tooltip handlers");this._has_own_tooltips;for(let t in this.state.handlers){let e=this.state.handlers[t];this.removeEventListener(t,e)}this._has_own_tooltips=void 0,this._tooltip_timer=void 0}else{let t=this._has_own_tooltips={start_timer:t=>{this._tooltip_timer=time_ms()},stop_timer:t=>{this._tooltip_timer=void 0},reset_timer:t=>{void 0!==this._tooltip_timer&&(this._tooltip_timer=time_ms())},start_events:["mouseover"],reset_events:["mousemove","mousedown","mouseup","touchstart","touchend","keydown","focus"],stop_events:["mouseleave","blur","mouseout"],handlers:{}},e=(e,i)=>{let s=i=>{void 0!==this._tool_tip_abort_delay&&time_ms()<this._tool_tip_abort_delay?this._tooltip_timer=void 0:t[e](i)};if(!(i in t.handlers))return t.handlers[i]=s,s;console.error(e,"is in handlers already")},i=0,s=[t.start_events,t.stop_events,t.reset_events];for(let t of["start_timer","stop_timer","reset_timer"]){for(let r of s[i])this.addEventListener(r,e(t,r),{passive:!0});i++}}}updateToolTips(){if(void 0===this._description_final||null===this._description_final||0===this._description_final.trim().length)return;if(!this.ctx||!this.ctx.screen)return;if(this.updateToolTipHandlers(),this.useNativeToolTips||void 0===this._tooltip_timer)return;if(void 0!==this._tool_tip_abort_delay&&time_ms()<this._tool_tip_abort_delay)return;this._tool_tip_abort_delay=void 0;let t=this.ctx.screen;let e=time_ms()-this._tooltip_timer>500,i=t.mpos[0],s=t.mpos[1],r=this.getClientRects();r=r?r[0]:r,r?(e=e&&i>=r.x&&i<r.x+r.width,e=e&&s>=r.y&&s<r.y+r.height):e=!1,e=e&&!haveModal(),e=e&&t.pickElement(i,s)===this,e=e&&this._description_final,e?this._tooltip_ref=_ToolTip.show(this._description_final,this.ctx.screen,i,s):(this._tooltip_ref&&this._tooltip_ref.remove(),this._tooltip_ref=void 0),time_ms()-this._tooltip_timer>500&&(this._tooltip_timer=void 0)}updateEventGraph(){if(this.isConnected){if(this.#l){this.#l=!1;for(let[t,e]of Object.entries(this.graphNode.inputs))e.flagUpdate()}}else this.#l=!0}update(){if(this.updateToolTips(),this.updateEventGraph(),this.ctx&&void 0===this._description&&this.getAttribute("datapath")){let t=this.getPathDescription(this.ctx,this.getAttribute("datapath"));this.description=t}this._init_done||this._init(),this._init_done&&!this.constructor.define().subclassChecksTheme&&this.checkThemeUpdate()&&(console.log("theme update!"),this.setCSS())}onadd(){this._init_done||this.doOnce(this._init),this.tabIndex>=0&&this.regenTabOrder()}getZoom(){return void 0!==this.parentWidget?this.parentWidget.getZoom():1}getDPI(){return void 0!==this.parentWidget?this.parentWidget.getDPI():UIBase$f.getDPI()}saveData(){return{}}loadData(t){return this}overrideDefault(t,e,i=!1){return this.my_default_overrides[t]=e,i||(this.default_overrides[t]=e),this}overrideClass(t){this._override_class=t}overrideClassDefault(t,e,i){t in this.class_default_overrides||(this.class_default_overrides[t]={}),this.class_default_overrides[t][e]=i}_doMobileDefault(t,e,i){if(!isMobile())return e;const s=t+"_mobile";if(i&&s in i)return i[s];t=t.toLowerCase();let r=!1;for(let e of _mobile_theme_patterns)if(t.search(e)>=0){r=!0;break}return r&&theme.base.mobileSizeMultiplier&&(e*=theme.base.mobileSizeMultiplier),e}hasDefault(t){let e=this;for(;e;){if(t in e.default_overrides)return!0;e=e.parentWidget}return this.hasClassDefault(t)}hasSubDefault(t,e){return this._hasSubDefault(...arguments,theme)||this._themeOverride&&this._hasSubDefault(...arguments,this._themeOverride)}_hasSubDefault(t,e){this.getStyleClass();let i=this.getDefault(t);return!(!i||"object"!=typeof i)&&e in i}hasClassSubDefault(t,e,i=!0){return this._hasClassSubDefault(t,e,i,void 0,theme)||this._themeOverride&&this._hasClassSubDefault(t,e,i,void 0,this._themeOverride)}_hasClassSubDefault(t,e,i=!0,s=this.getStyleClass(),r){let a=r;if(a=a[s],i){if(this._hasClassSubDefault(t,e,!1,r))return!0;let i=!1,s=this.constructor.define();return s.parentStyle&&(i|=this._hasClassSubDefault(t,e,!1,s.parentStyle,r)),i|=this._hasClassSubDefault(t,e,!1,"base",r),i}if(!a)return!1;let n=a[t];return!(!n||"object"!=typeof n)&&e in n}getSubDefault(t,e,i=e,s,r=!0){if(e&&this.my_default_overrides,!t)return this.getDefault(e,void 0,s,r);let a=this.getDefault(t,void 0,void 0,r);return a&&"object"==typeof a&&e in a?a[e]:void 0!==s?s:i?this.getDefault(i,void 0,void 0,r):void 0}getDefault(t,e=!0,i,s=!0){let r=this.getDefault_intern(t,e,i,s);if("string"==typeof r&&r.trim().toLowerCase().endsWith("px")){let t=r.trim().toLowerCase();t=t.slice(0,t.length-2).trim();let e=parseFloat(t);if(!isNaN(e)&&isFinite(e))return e}return r}getDefault_intern(t,e=!0,i,s=!0){if(void 0!==this.my_default_overrides[t]){let i=this.my_default_overrides[t];return e?this._doMobileDefault(t,i,this.my_default_overrides):i}let r=this;for(;r;){if(void 0!==r.default_overrides[t]){let i=r.default_overrides[t];e&&this._doMobileDefault(t,i,r.default_overrides)}r=r.parentWidget}return this.getClassDefault(t,e,i,s)}getStyleClass(){if(void 0!==this._override_class)return this._override_class;let t,e=this.constructor;for(;e&&e!==t&&e!==UIBase$f&&e!==Object;){let t=e.define();if(t.style)return t.style;if(!e.prototype||!e.prototype.__proto__)break;e=e.prototype.__proto__.constructor}return"base"}hasClassDefault(t){let e=this.getStyleClass(),i=this;for(;i;){let s=i.class_default_overrides[e];if(s&&t in s)return!0;i=i.parentWidget}let s=this._themeOverride;return!!(s&&e in s&&t in s[e])||(e in theme&&t in theme[e]||t in theme.base)}getClassDefault(t,e=!0,i,s=!0){let r,a,n=this.getStyleClass();if("none"===n)return;let o=this;for(;o;){let e=o.class_default_overrides[n];if(e&&t in e){r=e,a=e[t];break}o=o.parentWidget}void 0!==a||!(n in theme)||t in theme[n]||t in theme.base||window.DEBUG.theme&&report("Missing theme key ",t,"for",n);for(let e=0;e<2;e++){let o=e?theme:this._themeOverride;if(o)if(void 0===a&&n in o&&t in o[n])r=o[n],a=o[n][t];else if(void 0!==i)r=void 0,a=i;else if(void 0===a&&s){let e=this.constructor.define();e.parentStyle&&t in o[e.parentStyle]?(a=o[e.parentStyle][t],r=o[e.parentStyle]):(a=o.base[t],r=o.base)}}return e?this._doMobileDefault(t,a,r):a}overrideTheme(t){return this._themeOverride=t,this._forEachChildWidget((e=>{e.overrideTheme(t)})),this.ctx&&(this.flushSetCSS(),this.flushUpdate()),this}getStyle(){return console.warn("deprecated call to UIBase.getStyle"),this.getStyleClass()}animate(t={},e){if(Array.isArray(t))return super.animate(t,e);let i=new DOMMatrix(this.style.transform),s=()=>{let t=i,e="matrix("+t.a+","+t.b+","+t.c+","+t.d+","+t.e+","+t.f+")";this.style.transform=e},r={background_get(){return css2color(this.background)},background_set(t){"string"!=typeof t&&(t=color2css(t)),this.background=t},dx_get:()=>i.m41,dx_set(t){i.m41=t,s()},dy_get:()=>i.m42,dy_set(t){i.m42=t,s()}},a=["width","height","left","top","right","bottom","border-radius","border-width","margin","padding","margin-left","margin-right","margin-top","margin-bottom","padding-left","padding-right","padding-bottom","padding-top"];r=Object.assign(r,t);let n=(t,e)=>{r[e+"_get"]=()=>{let e=this.style[t];return e.endsWith("px")?parsepx$4(e):0},r[e+"_set"]=e=>{this.style[t]=e+"px"}};for(let t of a)t in r||(n(t,`style.${t}`),n(t,`style["${t}"]`),n(t,`style['${t}']`));let o=new Proxy(this,{get:(t,e,i)=>(console.log(e,r[e+"_get"],r),e+"_get"in r?r[e+"_get"].call(t):t[e]),set:(t,e,i,s)=>(console.log(e),e+"_set"in r?r[e+"_set"].call(t,i):t[e]=i,!0)}),l=new Animator(o);return l.onend=()=>{this._active_animations.remove(l)},this._active_animations.push(l),l}abortAnimations(){for(let t of list$2(this._active_animations))t.end();this._active_animations=[]}}function drawRoundBox2(t,e={}){drawRoundBox(t,e.canvas,e.g,e.width,e.height,e.r,e.op,e.color,e.margin,e.no_clear)}function drawRoundBox(t,e,i,s,r,a,n="fill",o,l,h=!1){s=void 0===s?e.width:s,r=void 0===r?e.height:r,i.save();let c=t.getDPI();a=void 0===a?t.getDefault("border-radius"):a,void 0===l&&(l=1);let d=a*=c,u=a;a>.5*(r-2*l)&&(d=.5*(r-2*l)),a>.5*(s-2*l)&&(u=.5*(s-2*l));let p=o;void 0===p&&void 0!==e._background?p=e._background:void 0===p&&(p=t.getDefault("background-color")),"fill"!==n||h||i.clearRect(0,0,s,r),i.fillStyle=p,i.strokeStyle=void 0===o?t.getDefault("border-color"):o;let m=s,f=r;Math.PI,Math.PI;i.beginPath(),i.moveTo(l,l+d),i.lineTo(l,f-d-l),i.quadraticCurveTo(l,f-l,l+u,f-l),i.lineTo(m-l-u,f-l),i.quadraticCurveTo(m-l,f-l,m-l,f-l-d),i.lineTo(m-l,l+d),i.quadraticCurveTo(m-l,l,m-l-u,l),i.lineTo(l+u,l),i.quadraticCurveTo(l,l,l,l+d),i.closePath(),"clip"===n?i.clip():"fill"===n?i.fill():i.stroke(),i.restore()}function _getFont_new(t,e,i="DefaultText",s=!0){return(i=t.getDefault(i)).genCSS(e)}function getFont(t,e,i="DefaultText",s=!0){return _getFont_new(t,e,"DefaultText",!0)}function _getFont(t,e,i="DefaultText",s=!0){t.getDPI();if(void 0!==t.getDefault(i))return _getFont_new(t,e,i,s);throw new Error("unknown font "+i)}function _ensureFont(t,e,i,s){if(e.font)i.font=e.font;else{let e=t.getDefault("DefaultText");i.font=e.genCSS(s)}}function get_measure_canvas(){return void 0!==_mc||(_mc=document.createElement("canvas"),_mc.width=256,_mc.height=256,_mc.g=_mc.getContext("2d")),_mc}function measureTextBlock(t,e,i,s,r,a){let n=e.split("\n"),o={width:0,height:0};void 0===r&&(void 0!==a&&"object"==typeof a&&(r=a.size),void 0===r&&(r=t.getDefault("DefaultText").size));for(let e of n){let n=measureText(t,e,i,s,r,a);o.width=Math.max(o.width,n.width);let l=void 0!==n.height?n.height:1.25*r;o.height+=l}return o}function measureText(t,e,i,s,r,a){if("object"==typeof i&&null!==i&&!(i instanceof HTMLCanvasElement)&&"CANVAS"!==i.tagName){let t=i;i=t.canvas,s=t.g,r=t.size,a=t.font}void 0===s&&(s=(i=get_measure_canvas()).g),void 0!==a?("object"==typeof a&&a instanceof CSSFont&&(a=a.genCSS(r)),s.font=a):_ensureFont(t,i,s,r);let n=s.measureText(e);return void 0!==r&&(s.font=void 0),n}function drawText(t,e,i,s,r={}){let a=r.canvas,n=r.g,o=r.color,l=r.font,h=r.size;void 0===h&&(h=void 0!==l&&l instanceof CSSFont?l.size:t.getDefault("DefaultText").size),h*=UIBase$f.getDPI(),void 0===o&&(o=l&&l.color?l.color:t.getDefault("DefaultText").color),void 0===l?_ensureFont(t,a,n,h):"object"==typeof l&&l instanceof CSSFont?n.font=l=l.genCSS(h):l&&(n.font=l),"object"==typeof o&&(o=color2css(o)),n.fillStyle=o,n.fillText(s,e+.5,i+.5),void 0!==h&&(n.font=void 0)}let PIDX=0,PSHADOW=1,PTOT=2;function saveUIData(t,e){if(void 0===e)throw new Error("ui_base.saveUIData(): key cannot be undefined");let i=[],s=(t,e,r,a)=>{let n=(e=e.slice(0,e.length)).length;for(let t=0;t<PTOT;t++)e.push(void 0);if(e[n]=r,e[n+1]=a?1:0,t instanceof UIBase$f){let s=e.slice(0,e.length),r=t.saveData(),a=!r;a=a||"object"==typeof r&&0===Object.keys(r).length,a||(s.push(r),s[n+2]&&i.push(s))}for(let i=0;i<t.childNodes.length;i++){let r=t.childNodes[i];s(r,e,i,!1)}let o=t.shadow;if(o)for(let t=0;t<o.childNodes.length;t++){let i=o.childNodes[t];s(i,e,t,!0)}};return s(t,[],0,!1),JSON.stringify({key:e,paths:i,_ui_version:1})}function loadUIData(t,e){if(null==e)return;let i=JSON.parse(e);e.key;for(let e of i.paths){let i=t,s=e[e.length-1];e=e.slice(2,e.length-1);for(let t=0;t<e.length;t+=PTOT){let s,r=e[t];if(e[t+1]?(s=i.shadow,s&&(s=s.childNodes)):s=i.childNodes,void 0===s||void 0===s[r]){i=void 0;break}i=s[r]}void 0!==i&&i instanceof UIBase$f&&(i._init(),i.loadData(s))}}window._saveUIData=saveUIData,UIBase$f.PositionKey="fixed",window._loadUIData=loadUIData,_setUIBase(UIBase$f);let keymap$3=keymap$4,EnumProperty$7=EnumProperty$9,PropTypes$7=PropTypes$8,UIBase$e=UIBase$f,PackFlags$9=PackFlags$a,IconSheets$6=IconSheets$7,parsepx$3=parsepx$4;exports.DEBUG.buttonEvents=!0;class ButtonEventBase extends UIBase$e{constructor(){super(),this._auto_depress=!0,this._highlight=!1,this._pressed=!1}bindEvents(){let t;t=t=>{if(exports.DEBUG.buttonEvents&&console.log("button depress",t.button,t.was_touch),this._auto_depress){if(this._pressed=!1,this.disabled)return;this._redraw()}t&&(t.preventDefault(),t.stopPropagation(),isMobile()||"pointerup"===t.type&&t.button)||(this._redraw(),exports.DEBUG.buttonEvents&&console.log("button click callback:",this.onclick,this._onpress,this.onpress),this.onclick&&t&&"mouse"!==t.pointerType&&this.onclick(this),this.undoBreakPoint())},this.addEventListener("click",(()=>{this._pressed=!1,this._highlight=!1,this._redraw()})),this.addEventListener("pointerdown",(e=>{if(e.stopPropagation(),!this.modalRunning){let i=this;this.pushModal({on_pointerdown(t){this.end(t)},on_pointerup(t){this.end(t)},on_pointercancel(t){console.warn("Pointer cancel in button"),i.popModal()},on_keydown(t){switch(t.keyCode){case keymap$3.Enter:case keymap$3.Escape:case keymap$3.Space:this.end()}},end(e){i.modalRunning&&(i.popModal(),t(e))}},void 0,e.pointerId)}exports.DEBUG.buttonEvents&&console.log("button press",this._pressed,this.disabled,e.button),this.disabled||(this._pressed=!0,this._onpress&&this._onpress(this),this._redraw(),e.preventDefault())}),{captured:!0,passive:!1}),this.addEventListener("pointerup",t,{captured:!0,passive:!1}),this.addEventListener("pointerover",(t=>{this.disabled||(this._highlight=!0,this._redraw())})),this.addEventListener("pointerout",(t=>{this.disabled||(this._highlight=!1,this._redraw())})),this.addEventListener("keydown",(t=>{if(!this.disabled)switch(exports.DEBUG.buttonEvents&&console.log(t.keyCode),t.keyCode){case 27:this.blur(),t.preventDefault(),t.stopPropagation();break;case 32:case 13:this.click(),t.preventDefault(),t.stopPropagation()}})),this.addEventListener("focusin",(()=>{this.disabled||(this._focus=1,this._redraw(),this.focus())})),this.addEventListener("blur",(()=>{this.disabled||(this._focus=0,this._redraw())}))}_redraw(){}}class Button extends ButtonEventBase{constructor(){super(),this.label=document.createElement("span"),this.label.innerText="button",this.shadow.appendChild(this.label),this.label.style["pointer-events"]="none",this._pressed=!1,this._highlight=!1,this._pressedTime=0,this._pressedTimeout=100,this._auto_depress=!0,this._last_name=void 0,this._last_disabled=void 0}get name(){return""+this.getAttribute("name")}set name(t){this.setAttribute("name",t)}get _pressed(){return this.__pressed}set _pressed(t){let e=!t!=!this._pressed;t?this._pressedTime=time_ms():e&&time_ms()-this._pressedTime<this._pressedTimeout&&window.setTimeout((()=>{this.setCSS()}),this._pressedTimeout-(time_ms()-this._pressedTime)+1),this.__pressed=t}static define(){return{tagname:"button-x",style:"button"}}init(){super.init(),this.tabIndex=0,this.bindEvents(),this.setCSS()}on_enabled(){this.setCSS()}on_disabled(){this.setCSS()}setCSS(){let t;super.setCSS(),this.hasDefault("pressedTimeout")&&(this._pressedTimeout=this.getDefault("pressedTimeout"));let e=this._pressed;!e&&time_ms()-this._pressedTime<this._pressedTimeout&&(e=!0),this.disabled?t="disabled":e&&this._highlight?t="highlight-pressed":e?t="pressed":this._highlight&&(t="highlight");let i=this.getDefault("height");this.setBoxCSS(t),this.label.style.padding=this.label.style.margin="0px",this.style["background-color"]=this.getSubDefault(t,"background-color");let s=this.getSubDefault(t,"DefaultText");this.label.style.font=s.genCSS(),this.label.style.color=s.color,this.style.display="flex",this.style["align-items"]="center",this.style.width="max-content",this.style.height=i+"px",this.style["user-select"]="none",this.label.style["user-select"]="none"}click(){if(this._onpress){let t=this.getClientRects(),e={x:t.x+.5*t.width,y:t.y+.5*t.height,stopPropagation:()=>{},preventDefault:()=>{}};this._onpress(e)}super.click()}_redraw(){this.setCSS()}updateDisabled(){this._last_disabled!==this.disabled&&(this._last_disabled=this.disabled,this._redraw(),exports.DEBUG.buttonEvents&&console.log("disabled update!",this.disabled,this.style["background-color"]))}update(){this._last_name!==this.name&&(this.label.innerHTML=this.name,this._last_name=this.name)}}UIBase$e.register(Button);class OldButton extends ButtonEventBase{constructor(){super();let t=this.getDPI();this._last_but_update_key="",this._name="",this._namePad=void 0,this._leftPad=5,this._rightPad=5,this._last_w=0,this._last_h=0,this._last_dpi=t,this._lastw=void 0,this._lasth=void 0,this.dom=document.createElement("canvas"),this.g=this.dom.getContext("2d"),this.dom.setAttribute("class","canvas1"),this.dom.tabIndex=0,this._last_bg=void 0,this._last_disabled=!1,this._auto_depress=!0,this.shadow.appendChild(this.dom)}get r(){return this.getDefault("border-radius")}set r(t){this.overrideDefault("border-radius",t)}static define(){return{tagname:"old-button-x",style:"button"}}click(){if(this._onpress){let t=this.getClientRects(),e={x:t.x+.5*t.width,y:t.y+.5*t.height,stopPropagation:()=>{},preventDefault:()=>{}};this._onpress(e)}super.click()}init(){let t=this.getDPI(),e=~~(this.getDefault("width")*t),i=~~(this.getDefault("height")*t);this.dom.width=e,this.dom.height=i,this.dom.style.width=e/t+"px",this.dom.style.height=i/t+"px",this.dom.style.padding=this.dom.style.margin="0px",this._name=void 0,this.updateName(),this.bindEvents(),this._redraw()}setAttribute(t,e){super.setAttribute(t,e),"name"===t&&(this.updateName(),this.updateWidth())}old_bindEvents(){this.addEventListener("mousedown",(t=>{t.stopPropagation(),exports.DEBUG.buttonEvents&&console.log("button press",this._pressed,this.disabled,t.button),this.disabled||(this._pressed=!0,isMobile()&&this.onclick&&0===t.button&&this.onclick(),this._onpress&&this._onpress(this),this._redraw(),t.preventDefault())}),{captured:!0,passive:!1}),this.addEventListener("mouseup",(t=>{if(exports.DEBUG.buttonEvents&&console.log("button depress",t.button,t.was_touch),this._auto_depress){if(this._pressed=!1,this.disabled)return;this._redraw()}t.preventDefault(),t.stopPropagation(),isMobile()||"pointerup"===t.type&&t.button||(this._redraw(),exports.DEBUG.buttonEvents&&console.log("button click callback:",this.onclick,this._onpress,this.onpress),this.onclick&&"mouse"!==t.pointerType&&this.onclick(this),this.undoBreakPoint())}),{captured:!0,passive:!1}),this.addEventListener("mouseover",(t=>{this.disabled||(this._highlight=!0,this._repos_canvas(),this._redraw())})),this.addEventListener("mouseout",(t=>{this.disabled||(this._highlight=!1,this._repos_canvas(),this._redraw())}))}updateDisabled(){this._last_disabled!==this.disabled&&(this._last_disabled=this.disabled,this.dom._background=this.getDefault("background-color"),this._repos_canvas(),this._redraw(),exports.DEBUG.buttonEvents&&console.log("disabled update!",this.disabled,this.style["background-color"]))}updateDefaultSize(){const t=UIBase$e.getDPI();let e=~~this.getDefault("height")+this.getDefault("padding"),i=1.33*this.getDefault("DefaultText").size;if(void 0===e||void 0===i||isNaN(e)||isNaN(i))return;e=~~(Math.max(e,i)*t);let s=e/t+"px";s!==this.style.height&&(this.style.height=s,this.dom.style.height=s,this.dom.height=e,this._repos_canvas(),this._redraw())}_calcUpdateKey(){return _themeUpdateKey}update(){super.update(),this.style["user-select"]="none",this.dom.style["user-select"]="none",this.updateDefaultSize(),this.updateWidth(),this.updateDPI(),this.updateName(),this.updateDisabled(),this.background!==this._last_bg&&(this._last_bg=this.background,this._repos_canvas(),this._redraw());let t=this._calcUpdateKey();t!==this._last_but_update_key&&(this._last_but_update_key=t,this.setCSS(),this._repos_canvas(),this._redraw())}setCSS(){if(super.setCSS(),this.updateBorders(),void 0===this._name)return;this.getDPI();let t=this.getDefault("padding"),e=this.getDefault("DefaultText").size,i=measureText(this,this._genLabel(),{size:e,font:this.getDefault("DefaultText")}).width+2*t+this._leftPad+this._rightPad;void 0!==this._namePad&&(i+=this._namePad);let s=this.getDefault("width");s=Math.max(s,i),s=~~s,this.dom.style.width=s+"px",this.updateBorders()}updateBorders(t=this.dom){let e=this.getDefault("border-width");e?(t.style["border-color"]=this.getDefault("border-color"),t.style["border-width"]=e+"px",t.style["border-style"]="solid",t.style["border-radius"]=this.getDefault("border-radius")+"px"):(t.style["border-color"]="none",t.style["border-width"]="0px",t.style["border-radius"]=this.getDefault("border-radius")+"px")}updateName(){if(!this.hasAttribute("name"))return;let t=this.getAttribute("name");t!==this._name&&(this._name=t,this.setCSS(),this._repos_canvas(),this._redraw())}updateWidth(t=0){}_repos_canvas(){let t=this.getDPI(),e=parsepx$3(this.dom.style.width),i=parsepx$3(this.dom.style.height),s=~~(e*t),r=~~(i*t);e=s/t,i=r/t,this.dom.width=s,this.dom.style.width=e+"px",this.dom.height=r,this.dom.style.height=i+"px"}updateDPI(){let t=this.getDPI();this._last_dpi!==t&&(this._last_dpi=t,this.g.font=void 0,this.setCSS(),this._repos_canvas(),this._redraw()),this.style["background-color"]&&(this.dom._background=this.style["background-color"],this.style["background-color"]="")}_genLabel(){return""+this._name}_getSubKey(){return this._pressed?"depressed":this._highlight?"highlight":void 0}_redraw(t=!0){let e=this.getDPI(),i=this._getSubKey();if(this._pressed&&this._highlight?this.dom._background=this.getSubDefault(i,"highlight-pressed","BoxHighlight"):this._pressed?this.dom._background=this.getSubDefault(i,"pressed","BoxDepressed"):this._highlight?this.dom._background=this.getSubDefault(i,"highlight","BoxHighlight"):this.dom._background=this.getSubDefault(i,"background-color","background-color"),drawRoundBox(this,this.dom,this.g),this.updateBorders(),this._focus){let t=this.dom.width,i=this.dom.height,s=1/e;this.g.translate(s,s);let r=this.g.lineWidth;this.g.lineWidth=this.getDefault("focus-border-width",void 0,1)*e,drawRoundBox(this,this.dom,this.g,t-2*s,i-2*s,this.r,"stroke",this.getDefault("BoxHighlight")),this.g.lineWidth=r,this.g.translate(-s,-s)}t&&this._draw_text()}_draw_text(){let t=this.getDPI(),e=this._getSubKey(),i=this.getSubDefault(e,"DefaultText"),s=this.getDefault("padding")*t,r=i.size*t,a=this._genLabel(),n=(this.dom.width,this.dom.height),o=(measureText(this,a,void 0,void 0,r,i).width,.5*s+this._leftPad*t),l=r+(n-r)/3;this.g;drawText(this,~~o,~~l,a,{canvas:this.dom,g:this.g,size:r/t,font:i})}}function myToFixed$1(t,e){for(t=t.toFixed(e);t.endsWith("0");)t=t.slice(0,t.length-1);return t.endsWith(".")&&(t=t.slice(0,t.length-1)),t}UIBase$e.internalRegister(OldButton);let keymap$2=keymap$4,EnumProperty$6=EnumProperty$9,PropTypes$6=PropTypes$8,UIBase$d=UIBase$f,PackFlags$8=PackFlags$a,IconSheets$5=IconSheets$7,parsepx$2=parsepx$4;class TextBoxBase extends UIBase$d{static define(){return{modalKeyEvents:!0}}}class TextBox extends TextBoxBase{constructor(){super(),this._editing=!1,this._width=this.getDefault("width")+"px",this._textBoxEvents=!0;let t=Math.ceil(3*this.getDPI());this._had_error=!1,this.decimalPlaces=void 0,this.baseUnit=void 0,this.displayUnit=void 0,this.dom=document.createElement("input"),this.dom.tabIndex=0,this.dom.setAttribute("tabindex",0),this.dom.setAttribute("tab-index",0),this.dom.style.margin=t+"px",this.dom.setAttribute("type","textbox"),this.dom.onchange=t=>{this._change(this.dom.value)},this.radix=16,this.dom.oninput=t=>{this._change(this.dom.value)},this.shadow.appendChild(this.dom),this.dom.addEventListener("focus",(t=>{console.log("Textbox focus",this.isModal),this._focus=1,this.isModal&&(this._startModal(),this.setCSS())})),this.dom.addEventListener("blur",(t=>{console.log("Textbox blur"),this._focus=0,this._modal&&(this._endModal(!0),this.setCSS())}))}get startSelected(){let t=(""+this.getAttribute("start-selected")).toLowerCase();return"yes"===t||"true"===t||"on"===t||"1"===t}set startSelected(t){this.setAttribute("start-selected",t?"true":"false")}get realtime(){let t=this.getAttribute("realtime");return!t||(t=t.toLowerCase().trim(),"yes"===t||"true"===t||"on"===t)}set realtime(t){this.setAttribute("realtime",t?"true":"false")}get isModal(){let t=this.getAttribute("modal");return!!t&&(t=t.toLowerCase().trim(),"yes"===t||"true"===t||"on"===t)}set isModal(t){this.setAttribute("modal",t?"true":"false")}_startModal(){this.startSelected&&this.select(),console.warn("textbox modal"),this._modal&&this._endModal(!0),this._editing=!0;let t=t=>{this._endModal(t)},e=e=>{switch(e.stopPropagation(),e.keyCode){case keymap$2.Enter:t(!0);break;case keymap$2.Escape:t(!1)}};this._modal=!0,this.pushModal({on_mousemove:t=>{t.stopPropagation()},on_keydown:e,on_keypress:e,on_keyup:e,on_mousedown:t=>{t.stopPropagation(),console.log("mouse down",t,t.x,t.y)}},!1)}_flash_focus(){}get editing(){return this._editing}_endModal(t){console.log("textbox end modal"),this._editing=!1,this._modal=!1,this.popModal(),this.blur(),this.onend?this.onend(t):this._updatePathVal(this.dom.value),this.blur()}get tabIndex(){return this.dom.tabIndex}set tabIndex(t){this.dom.tabIndex=t}init(){super.init(),this.hasAttribute("modal")||(this.isModal=!0),this.style.display="flex",this.style.width=this._width,this.setCSS()}set width(t){"number"==typeof t&&(t+="px"),this._width=t,this.style.width=t}setCSS(){super.setCSS(),this.overrideDefault("background-color",this.getDefault("background-color")),this.background=this.getDefault("background-color"),this.dom.style.margin=this.dom.style.padding="0px",this.getDefault("background-color")&&(this.dom.style["background-color"]=this.getDefault("background-color")),this.style["border-radius"]=this.getDefault("border-radius")+"px",this.dom.style["border-radius"]=this.getDefault("border-radius")+"px";let t=this.getDefault("border-width"),e=this.getDefault("border-color"),i=`${t}px ${this.getDefault("border-style")} ${e}`;this.style.border=i,this.style["border-color"]=e,this._focus?this.dom.style.border=`2px dashed ${this.getDefault("focus-border-color")}`:(this.dom.style.border=i,this.dom.style["border-color"]=e),this.style.font?this.dom.style.font=this.style.font:(this.dom.style.font=this.getDefault("DefaultText").genCSS(),this.dom.style.color=this.getDefault("DefaultText").color),this.dom.style.width="100%",this.dom.style.height="100%"}updateDataPath(){if(!this.ctx||!this.hasAttribute("datapath"))return;if(this._focus||void 0!==this._flashtimer||this._had_error&&this._focus)return;let t=this.getPathValue(this.ctx,this.getAttribute("datapath"));if(null==t)return void(this.internalDisabled=!0);this.internalDisabled=!1;let e=this.getPathMeta(this.ctx,this.getAttribute("datapath")),i=this.text;if(!e)return void console.error("datapath error "+this.getAttribute("datapath"),t);let s=e.type&(PropTypes$6.FLOAT|PropTypes$6.INT);if("number"==typeof t&&e.type&(PropTypes$6.VEC2|PropTypes$6.VEC3|PropTypes$6.VEC4|PropTypes$6.QUAT)&&(s=!0),s){let s=e.type===PropTypes$6.INT;this.radix=e.radix;let r=void 0!==this.decimalPlaces?this.decimalPlaces:e.decimalPlaces;this.hasAttribute("decimalPlaces")&&(r=parseInt(this.getAttribute("decimalPlaces")));let a=this.baseUnit??e.baseUnit;this.hasAttribute("baseUnit")&&(a=this.getAttribute("baseUnit"));let n=this.displayUnit??e.displayUnit;this.hasAttribute("displayUnit")&&(n=this.getAttribute("displayUnit")),s&&2===this.radix?(i=t.toString(this.radix),i="0b"+i):s&&16===this.radix?i+="h":i=buildString(t,a,r,n)}else void 0!==e&&e.type===PropTypes$6.STRING&&(i=t);this.text!==i&&(this.text=i)}update(){super.update(),this.dom.style.width!==this.style.width&&(this.dom.style.width=this.style.width),this.dom.style.height!==this.style.height&&(this.dom.style.height=this.style.height),this.hasAttribute("datapath")&&this.updateDataPath(),this.setCSS()}select(){this.dom.select()}focus(){return this.dom.focus()}blur(){return this.dom.blur()}static define(){return{tagname:"textbox-x",style:"textbox",modalKeyEvents:!0}}get text(){return this.dom.value}set text(t){this.dom.value=t}_prop_update(t,e){let i=t.type&(PropTypes$6.FLOAT|PropTypes$6.INT);if("number"==typeof this.getPathValue(this.ctx,this.getAttribute("datapath"))&&t.type&(PropTypes$6.VEC2|PropTypes$6.VEC3|PropTypes$6.VEC4|PropTypes$6.QUAT)&&(i=!0),i){t.type,PropTypes$6.INT;this.radix=t.radix;let i=void 0!==this.decimalPlaces?this.decimalPlaces:t.decimalPlaces;this.hasAttribute("decimalPlaces")&&(i=parseInt(this.getAttribute("decimalPlaces")));let s=this.baseUnit??t.baseUnit;this.hasAttribute("baseUnit")&&(s=this.getAttribute("baseUnit"));let r=this.displayUnit??t.displayUnit;if(this.hasAttribute("displayUnit")&&(r=this.getAttribute("displayUnit")),isNumber(e.trim())){let t=parseValue(e,s,r);this._had_error&&this.flash(ErrorColors.OK,this.dom,void 0,!1),this._had_error=!1,this.setPathValue(this.ctx,this.getAttribute("datapath"),t)}else this.flash(ErrorColors.ERROR,this.dom,void 0,!1),this.focus(),this.dom.focus(),this._had_error=!0}else if(t.type===PropTypes$6.STRING)try{this.setPathValue(this.ctx,this.getAttribute("datapath"),this.text),this._had_error&&(this.flash(ErrorColors.OK,this.dom,void 0,!1),this.dom.focus()),this._had_error=!1}catch(t){console.log(t.stack),console.log(t.message),console.warn("textbox error!"),this.flash(ErrorColors.ERROR,this.dom,void 0,!1),this.dom.focus()}}_updatePathVal(t){if(this.hasAttribute("datapath")&&void 0!==this.ctx){let e=this.getPathMeta(this.ctx,this.getAttribute("datapath"));console.log(e),e&&this._prop_update(e,t)}}_change(t){this.realtime&&this._updatePathVal(t),this.onchange&&this.onchange(t)}}function checkForTextBox(t,e,i){let s=t.pickElement(e,i);for(;s;){if(s.draggable)return!0;if(s instanceof UIBase$d)for(let t=0;t<2;t++){let e=t?s.childNodes:s.shadow.childNodes;for(let t of e)if(t.draggable)return!0}let t=s instanceof TextBoxBase;if(t=t||s.constructor.define&&s.constructor.define().modalKeyEvents,t)return!0;s=s.parentWidget?s.parentWidget:s.parentNode}return!1}function myToFixed(t,e){for(t=t.toFixed(e);t.endsWith("0");)t=t.slice(0,t.length-1);return t.endsWith(".")&&(t=t.slice(0,t.length-1)),t}UIBase$d.internalRegister(TextBox),_setTextboxClass(TextBox);let keymap$1=keymap$4,EnumProperty$5=EnumProperty$9,PropTypes$5=PropTypes$8,UIBase$c=UIBase$f,PackFlags$7=PackFlags$a,IconSheets$4=IconSheets$7,parsepx$1=parsepx$4;class IconLabel extends UIBase$c{constructor(){super(),this._icon=-1,this.iconsheet=1}get icon(){return this._icon}set icon(t){this._icon=t,this.setCSS()}static define(){return{tagname:"icon-label-x"}}init(){super.init(),this.style.display="flex",this.style.margin=this.style.padding="0px",this.setCSS()}setCSS(){let t=iconmanager$1.getTileSize(this.iconsheet);iconmanager$1.setCSS(this.icon,this),this.style.width=t+"px",this.style.height=t+"px"}}UIBase$c.internalRegister(IconLabel);class ValueButtonBase extends OldButton{constructor(){super()}get value(){return this._value}set value(t){this._value=t,this.ctx&&this.hasAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),this._value)}updateDataPath(){if(!this.hasAttribute("datapath"))return;if(void 0===this.ctx)return;let t=this.getPathValue(this.ctx,this.getAttribute("datapath"));if(void 0===t){let t=!this.disabled;return this.internalDisabled=!0,void(t&&this._redraw())}{let t=this.disabled;this.internalDisabled=!1,t&&this._redraw()}t!==this._value&&(this._value=t,this.updateWidth(),this._repos_canvas(),this._redraw(),this.setCSS())}update(){this.updateDataPath(),super.update()}}class Check extends UIBase$c{constructor(){super(),this._checked=!1,this._highlight=!1,this._focus=!1;let t=this.shadow,e=document.createElement("span");e.setAttribute("class","checkx"),e.style.display="flex",e.style["flex-direction"]="row",e.style.margin=e.style.padding="0px";iconmanager$1.getTileSize(0);let i=this.canvas=document.createElement("canvas");this.g=i.getContext("2d"),i.setAttribute("id",i._id),i.setAttribute("name",i._id);let s=t=>{this._highlight=!1,this.blur(),this._redraw()},r=t=>{this._highlight=!0,this._redraw()},a=t=>{this._highlight=!1,this._redraw()};e.addEventListener("pointerover",r,{passive:!0}),e.addEventListener("mousein",r,{passive:!0}),e.addEventListener("mouseleave",a,{passive:!0}),e.addEventListener("pointerout",a,{passive:!0}),this.addEventListener("blur",(t=>{this._highlight=this._focus=!1,this._redraw()})),this.addEventListener("focusin",(t=>{this._focus=!0,this._redraw()})),this.addEventListener("focus",(t=>{this._focus=!0,this._redraw()})),e.addEventListener("pointerdown",(t=>{this._highlight=!1,this.checked=!this.checked}),{passive:!0}),e.addEventListener("pointerup",s,{passive:!0}),e.addEventListener("pointercancel",s,{passive:!0}),this.addEventListener("keydown",(t=>{switch(t.keyCode){case keymap$1.Escape:this._highlight=void 0,this._redraw(),t.preventDefault(),t.stopPropagation(),this.blur();break;case keymap$1.Enter:case keymap$1.Space:this.checked=!this.checked,t.preventDefault(),t.stopPropagation()}})),this.checkbox=i,e.appendChild(i);let n=this._label=document.createElement("label");n.setAttribute("class","checkx"),e.setAttribute("class","checkx"),n.style["align-self"]="center","right"===this.getDefault("CheckSide")?e.prepend(n):e.appendChild(n),t.appendChild(e)}get internalDisabled(){return super.internalDisabled}set internalDisabled(t){!!this.internalDisabled!=!!t&&(super.internalDisabled=t,this._redraw())}get value(){return this.checked}set value(t){this.checked=t}get checked(){return this._checked}set checked(t){t=!!t,this._checked!==t&&(this._checked=t,this.setCSS(),this._redraw(),this.onclick&&this.onclick(t),this.onchange&&this.onchange(t),this.hasAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),this._checked))}get label(){return this._label.textContent}set label(t){this._label.textContent=t}static define(){return{tagname:"check-x",style:"checkbox",parentStyle:"button"}}init(){this.tabIndex=1,this.setAttribute("class","checkx");let t=document.createElement("style");this.getDefault("focus-border-color");t.textContent="\n      .checkx:focus {\n        outline : none;\n      }\n    ",this.prepend(t)}setCSS(){this._label.style.font=this.getDefault("DefaultText").genCSS(),this._label.style.color=this.getDefault("DefaultText").color,this._label.style.font="normal 14px poppins",super.setCSS(),this.style["background-color"]="rgba(0,0,0,0)"}updateDataPath(){if(!this.getAttribute("datapath"))return;let t=this.getPathValue(this.ctx,this.getAttribute("datapath")),e=!1;void 0!==t?(e=this.internalDisabled,this.internalDisabled=!1,t=!!t,e=e||!!this._checked!=!!t,e&&(this._checked=t,this._repos_canvas(),this.setCSS(),this._redraw())):this.internalDisabled=!0}_repos_canvas(){}_redraw(){if(void 0===this.canvas)return void(this._updatekey="");let t,e=this.canvas,i=this.g,s=UIBase$c.getDPI(),r=iconmanager$1.getTileSize(0),a=r+2*this.getDefault("padding");if(e.style.margin="2px",e.style.width=a+"px",e.style.height=a+"px",a=~~(a*s+.5),r=~~(r*s+.5),e.width=a,e.height=a,i.clearRect(0,0,e.width,e.height),i.beginPath(),i.rect(0,0,e.width,e.height),i.fill(),!this._checked&&this._highlight&&(t=this.getDefault("BoxHighlight")),drawRoundBox(this,e,i,void 0,void 0,void 0,void 0,t),this._checked){let t=.5*(a-r),s=.5*(a-r);iconmanager$1.canvasDraw(this,e,i,Icons$2.LARGE_CHECK,t,s)}this._focus&&(t=this.getDefault("focus-border-color"),i.lineWidth*=s,drawRoundBox(this,e,i,void 0,void 0,void 0,"stroke",t))}updateDPI(){let t=UIBase$c.getDPI();t!==this._last_dpi&&(this._last_dpi=t,this._redraw())}update(){super.update(),this.updateDPI();let t=getIconManager().isReady(0);this.hasAttribute("datapath")&&this.updateDataPath();let e=this.getDefault("DefaultText").hash();e+=this._checked+":"+this._label.textContent,e+=":"+t,e!==this._updatekey&&(this._repos_canvas(),this.setCSS(),this._updatekey=e,this._redraw())}}UIBase$c.internalRegister(Check);class IconButton extends UIBase$c{constructor(){super(),this._customIcon=void 0,this._pressed=!1,this._highlight=!1,this._draw_pressed=!0,this._icon=-1,this._icon_pressed=void 0,this.iconsheet=0,this.drawButtonBG=!0,this._extraIcon=void 0,this.extraDom=void 0,this.dom=document.createElement("div"),this.shadow.appendChild(this.dom),this._last_iconsheet=void 0,this.addEventListener("keydown",(t=>{switch(t.keyCode){case keymap$1.Enter:case keymap$1.Space:this.click()}}))}click(){if(this._onpress){let t=this.getClientRects(),e={x:t.x+.5*t.width,y:t.y+.5*t.height,stopPropagation:()=>{},preventDefault:()=>{}};this._onpress(e)}super.click()}get customIcon(){return this._customIcon}set customIcon(t){this._customIcon=t,this.setCSS()}get icon(){return this._icon}set icon(t){this._icon=t,this.setCSS()}static define(){return{tagname:"iconbutton-x",style:"iconbutton"}}_on_press(){this._pressed=!0,this.setCSS()}_on_depress(){this._pressed=!1,this.setCSS()}updateDefaultSize(){}setCSS(){let t;super.setCSS();this.getDefault("depressed"),this.getDefault("highlight");this.noMarginsOrPadding(),t=this._pressed&&this._draw_pressed?t=>this.getSubDefault("depressed",t):this._highlight?t=>this.getSubDefault("highlight",t):t=>this.getDefault(t);let e=(e,i)=>{let s=t(e);i&&(s=(""+s).trim(),s.toLowerCase().endsWith("px")||(s+="px")),this.style[e]=s},i=["margin","padding","margin-left","margin-right","margin-top","margin-botton","padding-left","padding-bottom","padding-top","padding-right","border-radius"];for(let t of i)e(t,!0);e("background-color",!1),e("color",!1);let s=`${t("border-width",!0)} ${t("border-style",!1)} ${t("border-color",!1)}`;this.style.border=s;let r=this.getDefault("width"),a=iconmanager$1.getTileSize(this.iconsheet);if(r=a,this.style.width=r+"px",this.style.height=r+"px",this.dom.style.width=r+"px",this.dom.style.height=r+"px",this.dom.style.margin=this.dom.style.padding="0px",this.style.display="flex",this.style["align-items"]="center",this._customIcon)this.dom.style["background-image"]=`url("${this._customIcon.src}")`,this.dom.style["background-size"]="contain",this.dom.style["background-repeat"]="no-repeat";else{let t=this.icon;this._pressed&&void 0!==this._icon_pressed&&(t=this._icon_pressed),iconmanager$1.setCSS(t,this.dom,this.iconsheet)}if(void 0!==this._extraIcon){let t;this.extraDom?t=this.extraDom:(this.extraDom=t=document.createElement("div"),this.shadow.appendChild(t)),t.style.position="absolute",t.style.margin=t.style.padding="0px",t.style["pointer-events"]="none",t.style.width=a+"px",t.style.height=a+"px",iconmanager$1.setCSS(this._extraIcon,t,this.iconsheet)}else this.extraDom&&this.extraDom.remove()}init(){super.init();let t=t=>{this._highlight=!0,this.setCSS()},e=t=>{this._highlight=!1,this.setCSS()};this.tabIndex=0,this.addEventListener("mouseover",t),this.addEventListener("mouseexit",e),this.addEventListener("mouseleave",e),this.addEventListener("focus",t),this.addEventListener("blur",e),this.addEventListener("mousedown",(t=>{if(t.stopPropagation(),t.preventDefault(),this.modalRunning&&this.popModal(),eventWasTouch(t)||0===t.button){{//!eventWasTouch(e)) {
let e=this;this.pushModal({on_mouseup(t){e.onclick&&eventWasTouch(t)&&e.onclick(),this.end()},on_touchcancel(t){this.on_mouseup(t),this.end()},on_touchend(t){this.on_mouseup(t),this.end()},on_keydown(t){this.end()},end(){e.modalRunning&&(e.popModal(),e._on_depress(t),e.setCSS())}})}this._on_press(t)}}),{capture:!0}),this.addEventListener("mouseup",(t=>{t.stopPropagation(),t.preventDefault(),this._on_depress(),this.setCSS()}),{capture:!0}),this.setCSS(),this.dom.style["pointer-events"]="none"}update(){super.update(),this.iconsheet!==this._last_iconsheet&&(this.setCSS(),this._last_iconsheet=this.iconsheet)}_getsize(){let t=this.getDefault("padding");return iconmanager$1.getTileSize(this.iconsheet)+2*t}}UIBase$c.internalRegister(IconButton);class IconCheck extends IconButton{constructor(){super(),this._checked=void 0,this._drawCheck=void 0}get drawCheck(){let t=this._drawCheck;return t=void 0===t?this.getDefault("drawCheck"):t,t=void 0===t||t,t}set drawCheck(t){(t=!!t)&&this.packflag&PackFlags$7.HIDE_CHECK_MARKS&&(this.packflag&=~PackFlags$7.HIDE_CHECK_MARKS);let e=!!this.drawCheck;this._drawCheck=t,t!==e&&(this.updateDrawCheck(),this.setCSS())}click(){super.click(),this.checked^=!0}get icon(){return this._icon}set icon(t){this._icon=t,this.setCSS()}get checked(){return this._checked}set checked(t){!!t!=!!this._checked&&(this._checked=t,this._updatePressed(!!t),this.setCSS(),this.onchange&&this.onchange(t))}get noEmboss(){let t=this.getAttribute("no-emboss");return!!t&&(t=t.toLowerCase().trim(),"true"===t||"yes"===t||"on"===t)}set noEmboss(t){this.setAttribute("no-emboss",t?"true":"false")}static define(){return{tagname:"iconcheck-x",style:"iconcheck",parentStyle:"iconbutton"}}_updatePressed(t){this._icon_pressed&&(this._draw_pressed=!1),this._pressed=t,this.setCSS()}_on_depress(){}_on_press(){this.checked^=!0,this.hasAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),!!this.checked),this.setCSS()}updateDefaultSize(){}_calcUpdateKey(){return super._calcUpdateKey()+":"+this._icon}updateDataPath(){if(!this.hasAttribute("datapath")||!this.ctx)return;if(this._icon<0){let t;try{t=this.ctx.api.resolvePath(this.ctx,this.getAttribute("datapath"))}catch(t){if(t instanceof DataPathError)return;throw t}if(void 0!==t&&t.prop){let e,i,s;t.prop.flag&PropFlags$3.NO_UNDO?this.setUndo(!1):this.setUndo(!0),!t.subkey||t.prop.type!==PropTypes$5.FLAG&&t.prop.type!==PropTypes$5.ENUM?(i=t.prop.icon2,e=t.prop.icon,s=t.prop.description):(e=t.prop.iconmap[t.subkey],i=t.prop.iconmap2[t.subkey],s=t.prop.descriptions[t.subkey],!s&&t.subkey.length>0&&(s=t.subkey,s=s[0].toUpperCase()+s.slice(1,s.length).toLowerCase())),void 0!==i&&-1!==i&&(this._icon_pressed=e,e=i),void 0!==e&&e!==this.icon&&(this.icon=e),s&&(this.description=s)}}let t=this.getPathValue(this.ctx,this.getAttribute("datapath"));void 0!==t?(this.internalDisabled=!1,t=!!t,t!==!!this._checked&&(this._checked=t,this._updatePressed(!!t),this.setCSS())):this.internalDisabled=!0}updateDrawCheck(){this.drawCheck?this._extraIcon=this._checked?Icons$2.ENUM_CHECKED:Icons$2.ENUM_UNCHECKED:this._extraIcon=void 0}update(){this.packflag&PackFlags$7.HIDE_CHECK_MARKS&&(this.drawCheck=!1),this.updateDrawCheck(),this.hasAttribute("datapath")&&this.updateDataPath(),super.update()}_getsize(){let t=this.getDefault("padding");return iconmanager$1.getTileSize(this.iconsheet)+2*t}setCSS(){this.updateDrawCheck(),super.setCSS()}}UIBase$c.internalRegister(IconCheck);class Check1 extends Button{constructor(){super(),this._namePad=40,this._value=void 0}static define(){return{tagname:"check1-x",parentStyle:"button"}}_redraw(){this.getDPI();drawRoundBox(this,this.dom,this.g,40);let t=this.getDefault("DefaultText").size,e=this._genLabel(),i=measureText(this,e,this.dom,this.g).width;this.dom.width;drawText(this,40,this.dom.height/2+t/2,e,{canvas:this.dom,g:this.g})}}function saveFile$1(t,e="unnamed",i=[],s="application/x-octet-stream"){let r=new Blob([t],{type:s}),a=URL.createObjectURL(r),n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download",e),n.click()}function loadFile$1(t="unnamed",e=[]){let i=document.createElement("input");return i.type="file",e=e.join(","),i.setAttribute("accept",e),new Promise(((t,e)=>{i.onchange=function(i){if(void 0===this.files||1!==this.files.length)return void e("file load error");let s=this.files[0],r=new FileReader;r.onload=function(e){t(e.target.result)},r.readAsArrayBuffer(s)},i.click()}))}UIBase$c.internalRegister(Check1),window._testLoadFile=function(t=["*.*"]){loadFile$1(void 0,t).then((t=>{console.log("got file data:",t)}))},window._testSaveFile=function(){saveFile$1(_appstate.createFile(),"unnamed.w3d",[".w3d"])};var html5_fileapi=Object.freeze({__proto__:null,saveFile:saveFile$1,loadFile:loadFile$1});class Constraint{constructor(t,e,i,s,r=1){this.glst=[],this.klst=i,this.wlst=[],this.k=r,this.params=s,this.name=t;for(let t of i){this.glst.push(new Float64Array(t.length));const e=new Float64Array(t.length);for(let t=0;t<e.length;t++)e[t]=1;this.wlst.push(e)}this.df=5e-4,this.threshold=1e-4,void 0!==e&&(this.func=e),this.funcDv||(this.funcDv=null)}postSolve(){}evaluate(t=!1){let e=this.func(this.params);if(this.funcDv)return this.funcDv(this.params,this.glst),e;if(Math.abs(e)<this.threshold)return 0;let i=this.df;if(t)return e;for(let t=0;t<this.klst.length;t++){let s=this.glst[t],r=this.klst[t];for(let t=0;t<r.length;t++){let a=r[t];r[t]+=i;let n=this.func(this.params);r[t]=a,s[t]=(n-e)/i}}return e}}class Solver{constructor(){this.constraints=[],this.gk=.99,this.simple=!1,this.randCons=!1,this.threshold=.01}remove(t){this.constraints.remove(t)}add(t){this.constraints.push(t)}solveStep(t=this.gk){let e=0,i=this.constraints;for(let s=0;s<i.length;s++){let r=s;this.randCons&&(r=~~(Math.random()*this.constraints.length*.99999));let a=i[r],n=a.evaluate();if(0===n)continue;e+=Math.abs(n);let o=0;for(let t=0;t<a.klst.length;t++){let e=a.klst[t],i=a.glst[t];for(let t=0;t<e.length;t++)o+=i[t]*i[t]}if(0!==o){n/=o;for(let e=0;e<a.klst.length;e++){let i=a.klst[e],s=a.glst[e],r=a.wlst[e];for(let e=0;e<i.length;e++)i[e]+=-n*s[e]*a.k*t*r[e];a.postSolve()}}}return e}solveStepSimple(t=this.gk){let e=0,i=this.constraints;for(let s=0;s<i.length;s++){let r=s;this.randCons&&(r=~~(Math.random()*this.constraints.length*.99999));let a=i[r],n=a.evaluate();if(0===n)continue;e+=Math.abs(n);let o=0;for(let t=0;t<a.klst.length;t++){let e=a.klst[t],i=a.glst[t];for(let t=0;t<e.length;t++)o+=i[t]*i[t]}if(0!==o){o=1e-4/Math.sqrt(o);for(let e=0;e<a.klst.length;e++){let i=a.klst[e],s=a.glst[e],r=a.wlst[j];for(let e=0;e<i.length;e++)i[e]+=-o*s[e]*a.k*t*r[e]}a.postSolve()}}return e}solve(t,e=this.gk,i=!1){let s=0;for(let r=0;r<t&&(s=this.simple?this.solveStepSimple(e):this.solveStep(e),i&&console.warn("average error:",(s/this.constraints.length).toFixed(4)),!(s<this.threshold/this.constraints.length));r++);return s}}var solver=Object.freeze({__proto__:null,Constraint:Constraint,Solver:Solver});let idgen=0;class PackNodeVertex extends Vector2$b{constructor(t,e){super(e),this.node=t,this._id=idgen++,this.edges=[],this._absPos=new Vector2$b}get absPos(){return this._absPos.load(this).add(this.node.pos),this._absPos}[Symbol.keystr](){return this._id}}class PackNode{constructor(){this.pos=new Vector2$b,this.vel=new Vector2$b,this.oldpos=new Vector2$b,this._id=idgen++,this.size=new Vector2$b,this.verts=[]}[Symbol.keystr](){return this._id}}function copyGraph(t){let e=[],i={};for(let s of t){let t=new PackNode;t._id=s._id,t.pos.load(s.pos),t.vel.load(s.vel),t.size.load(s.size),t.verts=[],i[t._id]=t;for(let e of s.verts){let s=new PackNodeVertex(t,e);s._id=e._id,i[s._id]=s,t.verts.push(s)}e.push(t)}for(let e of t)for(let t of e.verts){let e=i[t._id];for(let s of t.edges)e.edges.push(i[s._id])}return e}function getCenter(t){let e=new Vector2$b;for(let i of t)e.add(i.pos);return 0===t.length||e.mulScalar(1/t.length),e}function loadGraph(t,e){for(let i=0;i<t.length;i++)t[i].pos.load(e[i].pos),t[i].oldpos.load(e[i].oldpos),t[i].vel.load(e[i].vel)}function graphGetIslands(t){let e=[],i=new set$2,s=(t,e)=>{e.push(t),i.add(t);for(let r of t.verts)for(let a of r.edges){let r=a.node;r===t||i.has(r)||s(r,e)}};for(let r of t){if(i.has(r))continue;let t=[];e.push(t),s(r,t)}return e}function graphPack(t,e=15,i=10,s){let r=e,a=1;if("object"==typeof r){let t=r;r=t.margin??15,i=t.steps??10,s=t.updateCb,a=t.speed??1}let n=t;t=copyGraph(t);let o=1,l=0,h=(new Vector2$b).addScalar(1e17),c=(new Vector2$b).addScalar(-1e17),d=new Vector2$b;for(let e of t)h.min(e.pos),d.load(e.pos).add(e.size),c.max(d);let u=new Vector2$b(c).sub(h);for(let e of t)e.pos[0]+=5*(Math.random()-.5)/u[0]*a,e.pos[1]+=5*(Math.random()-.5)/u[1]*a;let p={};for(let e of t){e.vel.zero(),p[e._id]=e;for(let t of e.verts)p[t._id]=t}let m=new set$2,f=new set$2,g=[],_=!1;function v(t){let[e,i,s]=t;return _?0:Math.abs(e.absPos.vectorDistance(i.absPos)-s)}let b=new Vector2$b,y=new Vector2$b,S=new Vector2$b,x=new Vector2$b;function T(t,e,i=r){b.load(t.pos),y.load(e.pos),S.load(t.size),x.load(e.size),b.subScalar(i),y.subScalar(i),S.addScalar(2*i),x.addScalar(2*i)}let w,k,P,C=!1;function E(t){let[e,i]=t;if(C)return 0;T(e,i);e.size[0],e.size[1],i.size[0],i.size[1];return aabb_overlap_area(b,S,y,x)}let A=graphGetIslands(t),M=[];for(let t of A){let e=t[0],i=new PackNodeVertex(e);M.push(i)}let $=(e=1)=>{let i=new Solver;if(g.length=0,m=new set$2,M.length>1)for(let t=1;t<M.length;t++){let e=M[0],s=M[t],r=1,a=new Constraint("edge_c",v,[e.node.pos,s.node.pos],[e,s,r]);a.k=.25,i.add(a)}for(let e of t){for(let t of e.verts){f.add(t);for(let s of t.edges){if(s._id<t._id)continue;let r=0*e.size.vectorLength(),a=new Constraint("edge_c",v,[t.node.pos,s.node.pos],[t,s,r]);a.k=1,i.add(a)}}for(let i of t){if(e===i)continue;let t=Math.min(e._id,i._id)+":"+Math.max(e._id,i._id);if(!m.has(t)&&(T(e,i),aabb_overlap_area(b,S,y,x)>.01)){let s=o*(e.size.vectorLength()+i.size.vectorLength())*a;e.pos[0]+=(Math.random()-.5)*s,e.pos[1]+=(Math.random()-.5)*s,i.pos[0]+=(Math.random()-.5)*s,i.pos[1]+=(Math.random()-.5)*s,g.push([e,i]),m.add(t)}}for(let[t,e]of g){let s=new Constraint("area_c",E,[t.pos,e.pos],[t,e]);i.add(s),s.k=1}}return i},I=1,D=(e=.5)=>{let i=$();if(I%40==0){let e=getCenter(t),i=1e3;P&&loadGraph(t,P);for(let e of t)e.pos[0]+=(Math.random()-.5)*i*a,e.pos[1]+=(Math.random()-.5)*i*a,e.vel.zero();let s=getCenter(t);e.sub(s);for(let i of t)i.pos.add(e)}let s=1e17;for(let e of t)e.oldpos.load(e.pos),e.pos.addFac(e.vel,.5);_=!1,C=!0,i.solve(1,e),_=!0,C=!1;for(let t=0;t<10;t++)i=$(),s=i.solve(10,e*a);for(let e of t)e.vel.load(e.pos).sub(e.oldpos);_=!1,C=!0,s=0;for(let t of i.constraints)s+=t.evaluate(!0);_=!1,C=!1,w=s;let r=Math.random()*k*Math.exp(.1*-I);return(void 0===k||s<k+r)&&(P=copyGraph(t),k=s),I++,s};for(let t=0;t<i;t++)D(),l++,o=Math.exp(.1*-l);h.zero().addScalar(1e17),c.zero().addScalar(-1e17);for(let e of P||t)h.min(e.pos),y.load(e.pos).add(e.size),c.max(y);for(let e of P||t)e.pos.sub(h);if(loadGraph(n,P||t),s){void 0!==t._timer&&window.clearInterval(t._timer),t._timer=window.setInterval((()=>{let e=time_ms();for(;time_ms()-e<50;){D()}cconst.DEBUG.boxPacker&&console.log("err",(k/t.length).toFixed(2),(w/t.length).toFixed(2),"isects",g.length),P&&loadGraph(n,P),!1!==s()||clearInterval(t._timer)}),100);let e=t._timer;return{stop:()=>{P&&loadGraph(t,P),window.clearInterval(e),t._timer=void 0}}}}var controller=Object.freeze({__proto__:null,eventgraph:eventdag,solver:solver,util:util,vectormath:vectormath,math:math,toolprop_abstract:toolprop_abstract,html5_fileapi:html5_fileapi,parseutil:parseutil,config:config$1,nstructjs:nstructjs,lzstring:lzstring,binomial:binomial,setNotifier:setNotifier,ContextFlags:ContextFlags,OverlayClasses:OverlayClasses,makeDerivedOverlay:makeDerivedOverlay,ContextOverlay:ContextOverlay,excludedKeys:excludedKeys,LockedContext:LockedContext,Context:Context,test:test,DataPathError:DataPathError,DataFlags:DataFlags,DataTypes:DataTypes,getTempProp:getTempProp,getVecClass:getVecClass,isVecProperty:isVecProperty,DataPath:DataPath,StructFlags:StructFlags,ListIface:ListIface,ToolOpIface:ToolOpIface,setImplementationClass:setImplementationClass,registerTool:registerTool,pathParser:pathParser,pushReportName:pushReportName,popReportName:popReportName,DataList:DataList,DataStruct:DataStruct,DataAPI:DataAPI,initSimpleController:initSimpleController,getDataPathToolOp:getDataPathToolOp,setDataPathToolOp:setDataPathToolOp,ModelInterface:ModelInterface,DataPathSetOp:DataPathSetOp,ToolClasses:ToolClasses,setContextClass:setContextClass,ToolFlags:ToolFlags$1,UndoFlags:UndoFlags$1,setDefaultUndoHandlers:setDefaultUndoHandlers,ToolPropertyCache:ToolPropertyCache,SavedToolDefaults:SavedToolDefaults,ToolOp:ToolOp,MacroLink:MacroLink,MacroClasses:MacroClasses,ToolMacro:ToolMacro,ToolStack:ToolStack,buildToolOpAPI:buildToolOpAPI,buildToolSysAPI:buildToolSysAPI,PropTypes:PropTypes$8,PropFlags:PropFlags$3,isNumber:isNumber,NumberConstraintsBase:NumberConstraintsBase,IntegerConstraints:IntegerConstraints,FloatConstrinats:FloatConstrinats,NumberConstraints:NumberConstraints,PropSubTypes:PropSubTypes$3,setPropTypes:setPropTypes,customPropertyTypes:customPropertyTypes,PropClasses:PropClasses,get defaultRadix(){return defaultRadix},get defaultDecimalPlaces(){return defaultDecimalPlaces},ToolProperty:ToolProperty$1,FloatArrayProperty:FloatArrayProperty,StringProperty:StringProperty,NumProperty:NumProperty,_NumberPropertyBase:_NumberPropertyBase,IntProperty:IntProperty,ReportProperty:ReportProperty,BoolProperty:BoolProperty,FloatProperty:FloatProperty,EnumKeyPair:EnumKeyPair,EnumProperty:EnumProperty$9,FlagProperty:FlagProperty,VecPropertyBase:VecPropertyBase,Vec2Property:Vec2Property,Vec3Property:Vec3Property,Vec4Property:Vec4Property,QuatProperty:QuatProperty,Mat4Property:Mat4Property,ListProperty:ListProperty,StringSetProperty:StringSetProperty,ToolPaths:ToolPaths,buildParser:buildParser,Parser:Parser,parseToolPath:parseToolPath,testToolParser:testToolParser,initToolPaths:initToolPaths,SplineTemplates:SplineTemplates,SplineTemplateIcons:SplineTemplateIcons,Curve1dBSplineOpBase:Curve1dBSplineOpBase,Curve1dBSplineResetOp:Curve1dBSplineResetOp,Curve1dBSplineLoadTemplOp:Curve1dBSplineLoadTemplOp,Curve1dBSplineDeleteOp:Curve1dBSplineDeleteOp,Curve1dBSplineSelectOp:Curve1dBSplineSelectOp,Curve1dBSplineAddOp:Curve1dBSplineAddOp,BSplineTransformOp:BSplineTransformOp,Curve1DPoint:Curve1DPoint,initSplineTemplates:initSplineTemplates,ParamKey:ParamKey,SimpleCurveBase:SimpleCurveBase,BounceCurve:BounceCurve,ElasticCurve:ElasticCurve,EaseCurve:EaseCurve,RandCurve:RandCurve,getCurve:getCurve,CurveConstructors:CurveConstructors,CURVE_VERSION:CURVE_VERSION,CurveTypeData:CurveTypeData,Curve1D:Curve1D,CurveFlags:CurveFlags,TangentModes:TangentModes,evalHermiteTable:evalHermiteTable,genHermiteTable:genHermiteTable,Curve1DProperty:Curve1DProperty,EulerOrders:EulerOrders,BaseVector:BaseVector,F64BaseVector:F64BaseVector,F32BaseVector:F32BaseVector,I32BaseVector:I32BaseVector,I16BaseVector:I16BaseVector,I8BaseVector:I8BaseVector,UI32BaseVector:UI32BaseVector,UI16BaseVector:UI16BaseVector,UI8BaseVector:UI8BaseVector,makeVector4:makeVector4,Vector4:Vector4$2,makeVector3:makeVector3,Vector3:Vector3$2,makeVector2:makeVector2,Vector2:Vector2$b,Quat:Quat,Matrix4:Matrix4$2,quad_bilinear:quad_bilinear,ClosestModes:ClosestModes,AbstractCurve:AbstractCurve,ClosestCurveRets:ClosestCurveRets,closestPoint:closestPoint,normal_poly:normal_poly,dihedral_v3_sqr:dihedral_v3_sqr,tet_volume:tet_volume,calc_projection_axes:calc_projection_axes,aabb_isect_line_3d:aabb_isect_line_3d,aabb_isect_cylinder_3d:aabb_isect_cylinder_3d,barycentric_v2:barycentric_v2,closest_point_on_quad:closest_point_on_quad,closest_point_on_tri:closest_point_on_tri,dist_to_tri_v3_old:dist_to_tri_v3_old,dist_to_tri_v3:dist_to_tri_v3,dist_to_tri_v3_sqr:dist_to_tri_v3_sqr,tri_area:tri_area,aabb_overlap_area:aabb_overlap_area,aabb_isect_2d:aabb_isect_2d,aabb_isect_3d:aabb_isect_3d,aabb_intersect_2d:aabb_intersect_2d,aabb_intersect_3d:aabb_intersect_3d,aabb_union:aabb_union,aabb_union_2d:aabb_union_2d,feps:feps,COLINEAR:COLINEAR,LINECROSS:LINECROSS,COLINEAR_ISECT:COLINEAR_ISECT,SQRT2:SQRT2,FEPS_DATA:FEPS_DATA,FEPS:FEPS,FLOAT_MIN:FLOAT_MIN,FLOAT_MAX:FLOAT_MAX,Matrix4UI:Matrix4UI,get_rect_points:get_rect_points,get_rect_lines:get_rect_lines,simple_tri_aabb_isect:simple_tri_aabb_isect,MinMax:MinMax,winding_axis:winding_axis,winding:winding,inrect_2d:inrect_2d,aabb_isect_line_2d:aabb_isect_line_2d,expand_rect2d:expand_rect2d,expand_line:expand_line,colinear:colinear,colinear2d:colinear2d,corner_normal:corner_normal,line_line_isect:line_line_isect,line_line_cross:line_line_cross,point_in_aabb_2d:point_in_aabb_2d,aabb_sphere_isect_2d:aabb_sphere_isect_2d,point_in_aabb:point_in_aabb,aabb_sphere_isect:aabb_sphere_isect,aabb_sphere_dist:aabb_sphere_dist,point_in_tri:point_in_tri,convex_quad:convex_quad,isNum:isNum,normal_tri:normal_tri,normal_quad:normal_quad,normal_quad_old:normal_quad_old,line_isect:line_isect,dist_to_line_2d:dist_to_line_2d,dist_to_line_sqr:dist_to_line_sqr,dist_to_line:dist_to_line,clip_line_w:clip_line_w,closest_point_on_line:closest_point_on_line,circ_from_line_tan:circ_from_line_tan,circ_from_line_tan_2d:circ_from_line_tan_2d,get_tri_circ:get_tri_circ,gen_circle:gen_circle,rot2d:rot2d,makeCircleMesh:makeCircleMesh,minmax_verts:minmax_verts,unproject:unproject,project:project,get_boundary_winding:get_boundary_winding,PlaneOps:PlaneOps,isect_ray_plane:isect_ray_plane,_old_isect_ray_plane:_old_isect_ray_plane,Mat4Stack:Mat4Stack,trilinear_v3:trilinear_v3,point_in_hex:point_in_hex,trilinear_co:trilinear_co,trilinear_co2:trilinear_co2,tri_angles:tri_angles,angle_between_vecs:angle_between_vecs,rgb_to_hsv:rgb_to_hsv,hsv_to_rgb:hsv_to_rgb,cmyk_to_rgb:cmyk_to_rgb,rgb_to_cmyk:rgb_to_cmyk,PackNodeVertex:PackNodeVertex,PackNode:PackNode,graphGetIslands:graphGetIslands,graphPack:graphPack,Constraint:Constraint,Solver:Solver,modalstack:modalstack$1,singleMouseEvent:singleMouseEvent,isLeftClick:isLeftClick,DoubleClickHandler:DoubleClickHandler,isMouseDown:isMouseDown,pathDebugEvent:pathDebugEvent,eventWasTouch:eventWasTouch,copyEvent:copyEvent,_setScreenClass:_setScreenClass,_setModalAreaClass:_setModalAreaClass,pushPointerModal:pushPointerModal,pushModalLight:pushModalLight,popModalLight:popModalLight,haveModal:haveModal,keymap_latin_1:keymap_latin_1,keymap:keymap$4,reverse_keymap:reverse_keymap,HotKey:HotKey,KeyMap:KeyMap});let EnumProperty$4=EnumProperty$9,PropTypes$4=PropTypes$8,UIBase$b=UIBase$f,PackFlags$6=PackFlags$a,IconSheets$3=IconSheets$7;function getpx$2(t){return parseFloat(t.trim().replace("px",""))}function debugmenu(){window.DEBUG&&window.DEBUG.menu&&console.warn("%cmenu:","color:blue",...arguments)}class Menu extends UIBase$b{constructor(){super(),this.parentMenu=void 0,this._was_clicked=!1,this.items=[],this.autoSearchMode=!0,this._ignoreFocusEvents=!1,this.closeOnMouseUp=!0,this._submenu=void 0,this.ignoreFirstClick=!1,this.itemindex=0,this.closed=!1,this.started=!1,this.activeItem=void 0,this.overrideDefault("DefaultText",this.getDefault("MenuText")),this.container=document.createElement("span"),this.container.style.display="flex",this.container.style.color=this.getDefault("MenuText").color,this.container.setAttribute("class","menucon"),this.dom=document.createElement("ul"),this.dom.setAttribute("class","menu");let t=this.menustyle=document.createElement("style");this.buildStyle(),this.dom.setAttribute("tabindex",-1),this.shadow.appendChild(t),this.shadow.appendChild(this.container)}static define(){return{tagname:"menu-x",style:"menu"}}float(t,e,i){this.getDPI();let s=this.dom.getClientRects(),r=this.getWinWidth()-10,a=this.getWinHeight()-10;s.length>0&&(s=s[0],e+s.height>a&&(e=a-s.height-1),t+s.width>r&&(t=r-s.width-1)),super.float(t,e,50)}click(){if(!this._was_clicked)if(this.ignoreFirstClick)this.ignoreFirstClick=Math.max(this.ignoreFirstClick-1,0);else if(this.activeItem&&!this.activeItem._isMenu){if(this._was_clicked=!0,this.onselect)try{this.onselect(this.activeItem._id)}catch(t){print_stack$1(t),console.log("Error in menu callback")}this.close()}}_ondestroy(){this.started&&(menuWrangler.popMenu(this),this.onclose&&this.onclose())}init(){super.init(),this.setCSS()}close(){this.closed||(this.closed=!0,this.started&&menuWrangler.popMenu(this),this.started=!1,this._popup&&(this._popup.end(),this._popup=void 0),this.remove(),this.dom.remove(),this.onclose&&this.onclose(this))}_select(t,e=!0){if(void 0===this.activeItem){for(let t of this.items)if(!t.hidden){this.setActive(t,e);break}}else{let i=this.items.indexOf(this.activeItem),s=this.activeItem;do{if(i=(i+t+this.items.length)%this.items.length,s=this.items[i],!s.hidden)break}while(s!==this.activeItem);this.setActive(s,e)}this.hasSearchBox&&this.activeItem.scrollIntoView()}selectPrev(t=!0){return this._select(-1,t)}selectNext(t=!0){return this._select(1,t)}start_fancy(t,e=!0){return this.startFancy(t,e)}setActive(t,e=!0){this.activeItem!==t&&(this.activeItem&&(this.activeItem.style["background-color"]=this.getDefault("MenuBG"),e&&this.activeItem.blur()),t&&(t.style["background-color"]=this.getDefault("MenuHighlight"),e&&t.focus()),this.activeItem=t)}startFancy(t,e=!0){this.hasSearchBox=!0,this.started=!0,menuWrangler.pushMenu(this);let i=document.createElement("div");this.dom.setAttribute("class","menu"),i.setAttribute("class","menu");let s=this.textbox=UIBase$b.createElement("textbox-x");this.textbox.parentWidget=this,i.appendChild(s),i.appendChild(this.dom),i.style.height="300px",this.dom.style.height="300px",this.dom.style.overflow="scroll",t?this.container.prepend(i):this.container.appendChild(i),i.parentWidget=this.container,s.focus(),s.onchange=()=>{let t=s.text.trim().toLowerCase();for(let t of this.items)t.hidden=!0,t.remove();for(let e of this.items){let i=""==t;i=i||e.innerHTML.toLowerCase().search(t)>=0,i?(e.hidden=!1,this.dom.appendChild(e)):e===this.activeItem&&this.selectNext(!1)}},s.addEventListener("keydown",(t=>{switch(t.keyCode){case 27:this.close();break;case 13:this.click(this.activeItem),this.close()}}))}start(t=!1,e=!0){this.closed=!1,this.started=!0,this.focus(),menuWrangler.pushMenu(this);let i=t=>{let e=this.getDefault(t);"number"==typeof e&&(e+="px"),void 0!==e&&(this.dom.style[t]=e)};if(i("padding"),i("padding-top"),i("padding-left"),i("padding-right"),i("padding-bottom"),this.items.length>15&&this.autoSearchMode)return this.start_fancy(t,e);t?this.container.prepend(this.dom):this.container.appendChild(this.dom),e&&(this.setCSS(),this.flushUpdate(),window.setTimeout((()=>{this.flushUpdate(),void 0===this.activeItem&&(this.activeItem=this.dom.childNodes[0]),void 0!==this.activeItem&&this.activeItem.focus()}),0))}addItemExtra(t,e,i,s=-1,r=!0,a){let n,o=document.createElement("span");o.style.display="inline-flex",o.hotkey=i,o.icon=s,n=makeIconDiv(s,IconSheets$3.SMALL),n.style.display="inline-flex",n.style["margin-right"]="1px",n.style.align="left";let l=document.createElement("span");l.style.font=getFont(this,void 0,"MenuText");this.getDPI(),this.getDefault("MenuText").size;let h=document.createElement("canvas").getContext("2d");h.font=l.style.font;l.getClientRects();let c,d=Math.ceil(h.measureText(t).width);if(i&&(o.hotkey=i,h.font=getFont(this,void 0,"HotkeyText"),c=Math.ceil(h.measureText(i).width/UIBase$b.getDPI()),d+=c+8),l.innerText=t,l.style["word-wrap"]="none",l.style["white-space"]="pre",l.style.overflow="hidden",l.style["text-overflow"]="clip",l.style.width=~~d+"px",l.style.padding="0px",l.style.margin="0px",o.style.width="100%",o.appendChild(n),o.appendChild(l),i){let t=document.createElement("span");t.innerText=i,t.style.display="inline-flex",t.style.margin="0px",t.style["margin-left"]="auto",t.style["margin-right"]="0px",t.style.padding="0px",t.style.font=getFont(this,void 0,"HotkeyText"),t.style.color=this.getDefault("HotkeyTextColor"),t.style.width="max-content",t.style["text-align"]="right",t.style["justify-content"]="right",t["flex-wrap"]="nowrap",t["text-wrap"]="nowrap",o.appendChild(t)}let u=this.addItem(o,e,r);return u.hotkey=i,u.icon=s,u.label=t||u.innerText,a&&(u.title=a),u}addItem(t,e,i=!0,s){e=void 0===e?t:e;let r=t;if("string"==typeof t||t instanceof String){let e=document.createElement("dom");e.style["text-align"]="left",e.textContent=t,t=e}else r=t.textContent;let a=document.createElement("li");if(a.setAttribute("tabindex",this.itemindex++),a.setAttribute("class","menuitem"),void 0!==s&&(a.title=s),t instanceof Menu){let i=document.createElement("span");i.innerHTML=""+t.title,i._id=i.id=e,i.setAttribute("class","menu"),a.style.width="100%",a.appendChild(i),a._isMenu=!0,a._menu=t,t.parentMenu=this,t.hidden=!1,t.container=this.container}else a._isMenu=!1,a.appendChild(t);if(a._id=e,this.items.push(a),a.label=r||a.innerText.trim(),i){a.addEventListener("blur",(t=>{this._ignoreFocusEvents||this.activeItem&&!this.activeItem._isMenu&&this.setActive(void 0,!1)}));let t=t=>{if(this._ignoreFocusEvents)return;this.activeItem;this._submenu&&(this._submenu.close(),this._submenu=void 0),a._isMenu&&(a._menu.onselect=t=>{this.onselect(t),a._menu.close(),this.close()},a._menu.start(!1,!1),this._submenu=a._menu),this.setActive(a,!1)},e=e=>{t(e),e.stopPropagation(),e.preventDefault(),void 0!==this.activeItem&&this.activeItem._isMenu||this.click()};a.addEventListener("contextmenu",(t=>t.preventDefault())),this.addEventListener("contextmenu",(t=>t.preventDefault())),a.addEventListener("pointerup",e,{capture:!0}),a.addEventListener("click",e,{capture:!0}),a.addEventListener("pointerdown",e,{capture:!0}),a.addEventListener("focus",(e=>{t(e),t(e)})),a.addEventListener("pointermove",(e=>{t(e),a.focus()})),a.addEventListener("mouseover",(e=>{t(e),a.focus()})),a.addEventListener("mouseenter",(e=>{t(e),a.focus()})),a.addEventListener("pointerover",(e=>{t(e),a.focus()})),this.dom.appendChild(a)}return a}_getBorderStyle(){return`${this.getDefault("border-width")}px ${this.getDefault("border-style")} ${this.getDefault("border-color")}`}buildStyle(){let t=isMobile()?2:0;t+=this.getDefault("MenuSpacing");let e="";this.hasDefault("box-shadow")&&(e="box-shadow: "+this.getDefault("box-shadow")+";");let i=this.getDefault("MenuSeparator");if("object"==typeof i){let t="";for(let e in i){let s=i[e];"number"==typeof s&&(s=s.toFixed(4)+"px"),t+=`    ${e}: ${s};\n`}i=t}let s=0;s=this.hasDefault("item-radius")?this.getDefault("item-radius"):this.getDefault("border-radius"),this.menustyle.textContent=`\n        .menucon {\n          position:fixed;\n          float:left;\n          \n          border-radius : ${this.getDefault("border-radius")}px;\n\n          display: block;\n          -moz-user-focus: normal;\n          ${e}\n        }\n        \n        ul.menu {\n          display        : flex;\n          flex-direction : column;\n          flex-wrap      : nowrap;\n          width          : max-content;\n          \n          margin : 0px;\n          padding : 0px;\n          border : ${this._getBorderStyle()};\n          border-radius : ${this.getDefault("border-radius")}px;\n          -moz-user-focus: normal;\n          background-color: ${this.getDefault("MenuBG")};\n          color : ${this.getDefault("MenuText").color};\n        }\n        \n        .menuitem {\n          display : flex;\n          flex-wrap : nowrap;\n          flex-direction : row;          \n          \n          list-style-type:none;\n          -moz-user-focus: normal;\n          \n          margin : 0;\n          padding : 0px;\n          padding-right: 16px;\n          padding-left: 16px;\n          padding-top : ${t}px;\n          padding-bottom : ${t}px;\n          \n          border-radius : ${s}px;\n          \n          color : ${this.getDefault("MenuText").color};\n          font : ${this.getDefault("MenuText").genCSS()};\n          background-color: ${this.getDefault("MenuBG")};\n        }\n        \n        .menuseparator {\n          ${i}\n        }\n        \n        .menuitem:focus {\n          display : flex;\n          text-align: left;\n          \n          border : none;\n          outline : none;\n          border-radius : ${s}px;\n          \n          background-color: ${this.getDefault("MenuHighlight")};\n          color : ${this.getDefault("MenuText").color};\n          -moz-user-focus: normal;\n        }\n      `}setCSS(){super.setCSS(),this.buildStyle(),this.container.style.color=this.getDefault("MenuText").color,this.style.color=this.getDefault("MenuText").color}seperator(){let t=document.createElement("div");return t.setAttribute("class","menuseparator"),this.dom.appendChild(t),this}menu(t){let e=UIBase$b.createElement("menu-x");return e.setAttribute("name",t),this.addItem(e),e}calcSize(){}}Menu.SEP=Symbol("menu seperator"),UIBase$b.internalRegister(Menu);class DropBox extends OldButton{constructor(){super(),this.lockTimer=0,this._template=void 0,this._searchMenuMode=!1,this.altKey=void 0,this._value=0,this._last_datapath=void 0,this.r=5,this._menu=void 0,this._auto_depress=!1,this._onpress=this._onpress.bind(this)}get searchMenuMode(){return this._searchMenuMode}set searchMenuMode(t){this._searchMenuMode=t}get template(){return this._template}set template(t){this._template=t}get value(){return this._value}set value(t){this.setValue(t)}get menu(){return this._menu}set menu(t){this._menu=t,void 0!==t&&(this._name=t.title,this.updateName())}static define(){return{tagname:"dropbox-x",style:"dropbox"}}init(){super.init(),this.setAttribute("menu-button","true"),this.updateWidth()}setCSS(){let t;this.style["user-select"]="none",this.dom.style["user-select"]="none",t=this.getAttribute("simple")?["margin-left","margin-right","padding-left","padding-right"]:["margin","margin-left","margin-right","margin-top","margin-bottom","padding","padding-left","padding-right","padding-top","padding-bottom"];let e=t=>{this.hasDefault(t)&&(this.style[t]=this.getDefault(t,void 0,0)+"px")};for(let i of t)e(i)}_genLabel(){let t=super._genLabel(),e="";0===t.length&&(t="(error)"),this.altKey=t[0].toUpperCase().charCodeAt(0);for(let i=0;i<t.length;i++)if("&"===t[i]&&i<t.length-1&&"&"!==t[i+1])this.altKey=t[i+1].toUpperCase().charCodeAt(0);else{if("&"===t[i]&&i<t.length-1&&"&"===t[i+1])continue;e+=t[i]}return e}updateWidth(){let t=this.getDPI(),e=(this.getDefault("DefaultText").size,this.g.measureText(this._genLabel()).width/t);return e=~~e,e+=15,this.getAttribute("simple")||(e+=35),e!==this._last_w&&(this._last_w=e,this.dom.style.width=e+"px",this.style.width=e+"px",this.width=e,this.overrideDefault("width",e),this._repos_canvas(),this._redraw()),0}updateBorders(){super.updateBorders(this)}updateDataPath(){if(!this.ctx||!this.hasAttribute("datapath"))return;let t,e,i=!1;try{this.pushReportContext(this._reportCtxName),t=this.ctx.api.resolvePath(this.ctx,this.getAttribute("datapath")).prop,e=this.ctx.api.getValue(this.ctx,this.getAttribute("datapath")),t=t&&t.prop?t.prop:t,this.popReportContext()}catch(t){print_stack$1(t),i=!0}if(i)return this.disabled=!0,this.setCSS(),void this._redraw();if(this.disabled=!1,this.setCSS(),this._redraw(),!t)return;void 0===this.prop&&(this.prop=t),t=this.prop;let s=this.getAttribute("name");s=t.type&(PropTypes$4.ENUM|PropTypes$4.FLAG)?t.ui_value_names[t.keys[e]]:""+e,s!==this.getAttribute("name")&&(this.setAttribute("name",s),this.updateName())}update(){let t=this.getAttribute("datapath");t&&t!==this._last_datapath&&(this._last_datapath=t,this.prop=void 0,this.updateDataPath()),super.update();let e=this.getDefault("dropTextBG");e!==this._last_dbox_key&&(this._last_dbox_key=e,this.setCSS(),this._redraw()),this.hasAttribute("datapath")&&this.updateDataPath()}_build_menu_template(){void 0!==this._menu&&void 0!==this._menu.parentNode&&this._menu.remove();let t=this._template;return"function"==typeof t&&(t=t()),this._menu=createMenu(this.ctx,"",t),this._menu}_build_menu(){if(this._template)return void this._build_menu_template();let t=this.prop;if(void 0===this.prop)return;void 0!==this._menu&&void 0!==this._menu.parentNode&&this._menu.remove();let e=this._menu=UIBase$b.createElement("menu-x");e.setAttribute("name",""),e._dropbox=this;let i={},s=t.values,r=t.iconmap,a=t.ui_value_names,n=t.descriptions||{};for(let t in s){let o=t;i[s[t]]=t,void 0!==a&&t in a&&(o=a[t]);let l=n[t];r&&r[t]?e.addItemExtra(o,s[t],void 0,r[t],void 0,l):e.addItem(o,s[t],void 0,l)}e.onselect=t=>{this._pressed=!1,this._pressed=!1,this._redraw(),this._menu=void 0;let e=!0;if(this.hasAttribute("datapath")){let t=this.ctx.api.resolvePath(this.ctx,this.getAttribute("datapath"));t.dpath.data;e=!(t&&t.dpath&&t.dpath.data instanceof ToolProperty)}this._value=this._convertVal(t),e&&this.prop.setValue(t),this.setAttribute("name",this.prop.ui_value_names[i[t]]),this.onselect&&this.onselect(t),this.hasAttribute("datapath")&&this.ctx&&this.setPathValue(this.ctx,this.getAttribute("datapath"),t)}}_onpress(t){if(this.abortToolTips(1e3),void 0!==this._menu){this.lockTimer=time_ms(),this._pressed=!1,this._redraw();let t=this._menu;return this._menu=void 0,void t.close()}if(time_ms()-this.lockTimer<200)return;if(this._build_menu(),void 0===this._menu)return;this._menu.autoSearchMode=!1,this._menu._dropbox=this,this.dom._background=this.getDefault("BoxDepressed"),this._background=this.getDefault("BoxDepressed"),this._redraw(),this._pressed=!0,this.setCSS();let e=this._menu.onclose;this._menu.onclose=()=>{this.lockTimer=time_ms(),this._pressed=!1,this._redraw();let t=this._menu;t&&(this._menu=void 0,t._dropbox=void 0),e&&e.call(t)};let i=this._menu,s=this.getScreen(),r=(this.getDPI(),t.x),a=t.y,n=this.dom.getBoundingClientRect(),o=n.height;if(r=n.x-window.scrollX,a=n.y+o-window.scrollY,window.haveElectron,exports.menusCanPopupAbove&&a>.5*s.size[1]&&!this.searchMenuMode){let t=s.popup(this,500,400,!1,0);t.style["z-index"]="-10000",t.style.position=UIBase$b.PositionKey,document.body.appendChild(t),t.style.visibility="hidden",t.add(i),i.start();let e=time_ms(),n=window.setInterval((()=>{if(time_ms()-e>1500)return void window.clearInterval(n);let l=i.dom.getBoundingClientRect();if(!l||l.height<55)return;window.clearInterval(n),a-=l.height+o,i.dom.remove(),t.remove();let h=this._popup=i._popup=s.popup(this,r,a,!1,0);h.noMarginsOrPadding(),h.add(i),i.start(),h.style.left=r+"px",h.style.top=a+"px"}),1);return}let l=this._popup=i._popup=s.popup(this,r,a,!1,0);l.noMarginsOrPadding(),l.add(i),this.searchMenuMode?i.startFancy():i.start()}_redraw(){if(this.getAttribute("simple")){return this.g.clearRect(0,0,this.dom.width,this.dom.height),this._highlight&&drawRoundBox2(this,{canvas:this.dom,g:this.g,color:this.getDefault("BoxHighlight")}),this._focus&&(drawRoundBox2(this,{canvas:this.dom,g:this.g,color:this.getDefault("BoxHighlight"),op:"stroke",no_clear:!0}),drawRoundBox(this,this.dom,this.g,void 0,void 0,2,"stroke")),void this._draw_text()}super._redraw(!1);let t=this.g,e=this.dom.width,i=this.dom.height,s=this.getDPI(),r=10*s,a=s,n=this.getDefault("dropTextBG");void 0!==n&&(t.fillStyle=n,t.beginPath(),t.rect(a,a,this.dom.width-a-i,this.dom.height-2*a),t.fill()),t.fillStyle="rgba(50, 50, 50, 0.2)",t.strokeStyle="rgba(50, 50, 50, 0.8)",t.beginPath();let o=.3;t.moveTo(e-.5*i-r,r),t.lineTo(e-r,r),t.moveTo(e-.5*i-r,r+o*i/3),t.lineTo(e-r,r+o*i/3),t.moveTo(e-.5*i-r,r+o*i*2/3),t.lineTo(e-r,r+o*i*2/3),t.lineWidth=1,t.stroke(),this._draw_text()}_convertVal(t){return"string"==typeof t&&this.prop?t in this.prop.values?this.prop.values[t]:t in this.prop.keys?this.prop.keys[t]:void 0:t}setValue(t,e=!1){if(void 0!==t&&t!==this._value)if(void 0!==(t=this._convertVal(t))){if(this._value=t,void 0===this.prop||e)this.setAttribute("name",""+t),this._name=""+t;else{this.prop.setValue(t);let e=t;e in this.prop.keys&&(e=this.prop.keys[e]),e=this.prop.ui_value_names[e],this.setAttribute("name",""+e),this._name=""+e}this.onchange&&!e&&this.onchange(t),this.setCSS(),this.updateDataPath(),this._redraw()}else console.warn("Bad val",arguments[0])}}UIBase$b.internalRegister(DropBox);class MenuWrangler{constructor(){this.screen=void 0,this.menustack=[],this.lastPickElemTime=time_ms(),this._closetimer=0,this.closeOnMouseUp=void 0,this.closereq=void 0,this.timer=void 0}get closetimer(){return this._closetimer}set closetimer(t){debugmenu("set closertime",t),this._closetimer=t}get menu(){return this.menustack.length>0?this.menustack[this.menustack.length-1]:void 0}pushMenu(t){debugmenu("pushMenu"),this.spawnreq=void 0,0===this.menustack.length&&t.closeOnMouseUp&&(this.closeOnMouseUp=!0),this.menustack.push(t)}popMenu(t){return debugmenu("popMenu"),this.menustack.pop()}endMenus(){debugmenu("endMenus");for(let t of this.menustack)t.close();this.menustack=[]}searchKeyDown(t){let e=this.menu;switch(t.stopPropagation(),e._ignoreFocusEvents=!0,e.textbox.focus(),e._ignoreFocusEvents=!1,t.keyCode){case keymap$4.Enter:e.click(e.activeItem);break;case keymap$4.Escape:e.close();break;case keymap$4.Up:e.selectPrev(!1);break;case keymap$4.Down:e.selectNext(!1)}}on_keydown(t){if(window.menu=this.menu,void 0===this.menu)return;if(this.menu.hasSearchBox)return this.searchKeyDown(t);let e=this.menu;switch(t.keyCode){case keymap$4.Left:case keymap$4.Right:if(e._dropbox){let i=e._dropbox;i=t.keyCode===keymap$4.Left?i.previousElementSibling:i.nextElementSibling,void 0!==i&&i instanceof DropBox&&(this.endMenus(),i._onpress(t))}break;case keymap$4.Up:e.selectPrev();break;case keymap$4.Down:e.selectNext();break;case 13:case 32:e.click(e.activeItem);break;case 27:e.close()}}on_pointerdown(t){if(void 0===this.menu||void 0===this.screen)return void(this.closetimer=time_ms());let e=this.screen,i=t.pageX,s=t.pageY,r=e.pickElement(i,s);void 0!==r&&(r instanceof DropBox||isMobile())&&(this.endMenus(),t.preventDefault(),t.stopPropagation())}on_pointerup(t){if(void 0===this.menu||void 0===this.screen)return void(this.closetimer=time_ms());let e=this.screen,i=t.pageX,s=t.pageY,r=e.pickElement(i,s,void 0,void 0,DropBox);void 0!==r?this.closeOnMouseUp=!1:(r=e.pickElement(i,s,void 0,void 0,Menu),r&&this.closeOnMouseUp&&r.click())}findMenu(t,e){let i=this.screen.pickElement(t,e);if(void 0===i)return;if(i instanceof Menu)return i;let s=i;for(;s;){if(s instanceof Menu)return s;s=s.parentWidget}}on_pointermove(t){if(this.menu&&this.menu.hasSearchBox)return this.closetimer=time_ms(),void(this.closereq=void 0);if(void 0===this.menu||void 0===this.screen)return this.closetimer=time_ms(),void(this.closereq=void 0);let e,i=this.screen,s=t.pageX,r=t.pageY,a=this.menu;if(a){let t=a.getBoundingClientRect(),i=15;t&&s>=t.x-i&&r>=t.y-i&&s<=t.x+t.width+2*i&&r<=t.y+t.height+2*i&&(e=a)}if(!e&&time_ms()-this.lastPickElemTime>250&&(e=i.pickElement(s,r),this.lastPickElemTime=time_ms()),void 0===e)return;if(e instanceof Menu)return this.closetimer=time_ms(),void(this.closereq=void 0);let n=e.hasAttribute("menu-button")&&e.hasAttribute("simple");if(n=n&&e.menu!==this.menu,n){let t=this.menu;for(;t!==e.menu;)t=t.parentMenu,n=n&&(void 0===t||t!==e.menu)}if(n)return this.endMenus(),this.closetimer=time_ms(),this.closereq=void 0,void e._onpress(t);let o=!1,l=e;for(;l;){if(l instanceof Menu){o=!0;break}if(l.hasAttribute("menu-button")&&l.menu===this.menu){o=!0;break}l=l.parentWidget}o?(this.closetimer=time_ms(),this.closereq=void 0):this.closereq=this.menu}update(){let t=exports.menu_close_time;t=void 0===t?50:t;let e=this.closereq&&this.closereq===this.menu;e=e&&time_ms()-this.closetimer>t,e&&(this.closereq=void 0,this.endMenus())}startTimer(){this.timer&&this.stopTimer(),this.timer=setInterval((()=>{debugmenu("start menu wrangler interval"),this.update()}),150)}stopTimer(){this.timer&&(debugmenu("stop menu wrangler interval"),clearInterval(this.timer),this.timer=void 0)}}let menuWrangler=window._menuWrangler=new MenuWrangler,wrangerStarted=!1;function startMenuEventWrangling(t){if(menuWrangler.screen=t,!wrangerStarted){wrangerStarted=!0;for(let t in DomEventTypes){if(void 0===menuWrangler[t])continue;let e=t.search("key")>=0?window:document.body;e=window,e.addEventListener(DomEventTypes[t],menuWrangler[t].bind(menuWrangler),{passive:!1,capture:!0})}menuWrangler.screen=t,menuWrangler.startTimer()}}function setWranglerScreen(t){startMenuEventWrangling(t)}function getWranglerScreen(){return menuWrangler.screen}function createMenu(t,e,i){let s=UIBase$b.createElement("menu-x");s.ctx=t,s.setAttribute("name",e);let r=s.constructor.SEP,a=0,n={},o=e=>{if(void 0!==e&&e instanceof Menu)s.addItem(e);else if("string"==typeof e){let i,r;try{i=t.api.getToolDef(e)}catch(t){return void s.addItem("(tool path error)",a++)}if(i.hotkey)r=i.hotkey;else try{r=t.api.getToolPathHotkey(t,e)}catch(t){print_stack$1(t),console.warn("error getting hotkey for tool "+e),r=void 0}s.addItemExtra(i.uiname,a,r,i.icon),n[a]=(h=e,function(){t.api.execTool(t,h)}),a++}else if(e===r)s.seperator();else if("function"==typeof e||e instanceof Function)o(e());else if(e instanceof Array){let t=e.length>2?e[2]:void 0,r=e.length>3?e[3]:void 0,o=e.length>4?e[4]:void 0,h=e.length>5?e[5]:a++;void 0!==t&&t instanceof HotKey&&(t=t.buildString()),s.addItemExtra(e[0],h,t,r,void 0,o),n[h]=(i=e[1],l=h,function(){i(l)})}else if("object"==typeof e){let{name:t,callback:i,hotkey:r,icon:o,tooltip:l}=e,h=void 0!==e.id?e.id:a++;void 0!==r&&r instanceof HotKey&&(r=r.buildString()),s.addItemExtra(t,h,r,o,void 0,l),n[h]=function(t,e){return function(){t(e)}}(i,h)}var i,l,h};for(let t of i)o(t);return s.onselect=t=>{n[t]()},s}function startMenu(t,e,i,s=!1,r=55){menuWrangler.endMenus();let a=t.ctx.screen,n=t._popup=a.popup(void 0,e,i,!1,r);n.noMarginsOrPadding(),n.add(t),s?t.startFancy():t.start(),t.flushUpdate(),t.flushSetCSS(),t._popup.flushUpdate(),t._popup.flushSetCSS()}window._startMenuEventWrangling=startMenuEventWrangling;var _ui$2=void 0;let PropFlags$2=PropFlags$3,PropSubTypes$2=PropSubTypes$3,EnumProperty$3=EnumProperty$9,Vector2$8=Vector2$b,UIBase$a=UIBase$f,PackFlags$5=PackFlags$a,PropTypes$3=PropTypes$8;class Label extends UIBase$f{constructor(){super(),this._label="",this._lastText="",this.dom=document.createElement("div"),this.dom.setAttribute("class","_labelx");let t=document.createElement("style");t.textContent="\n      div._labelx::selection {\n        color: none;\n        background: none;\n         -webkit-user-select:none;\n         user-select:none;\n      }\n    ",this.shadow.appendChild(t),this.shadow.appendChild(this.dom),this.font="LabelText"}get font(){return this._font}set font(t){"string"==typeof t?(this._font=this.getDefault(t),this._font||console.warn("Invalid font",t)):"object"==typeof t&&t instanceof CSSFont?this._font=t:console.warn("Invalid font",t),this._updateFont()}get text(){return this._label}set text(t){this._label=t,this.hasAttribute("datapath")||(this.dom.innerText=t)}static define(){return{tagname:"label-x",style:"label"}}init(){this.dom.style.width="max-content"}setCSS(){super.setCSS(!1),this.setBoxCSS()}on_disabled(){super.on_disabled(),this._enabled_font=this.font,this.font="DefaultText",this._updateFont()}on_enabled(){super.on_enabled(),this.font=this._enabled_font,this._updateFont()}_updateFont(){let t=this._font;t&&(this.dom.style.font=t.genCSS(),this.dom.style.color=t.color)}updateDataPath(){if(void 0===this.ctx)return;let t=this.getAttribute("datapath"),e=this.getPathMeta(this.ctx,t),i=this.getPathValue(this.ctx,t);void 0!==i&&(e.type&(PropTypes$3.INT|PropTypes$3.FLOAT)&&(i=buildString(i,e.baseUnit,e.decimalPlaces,e.displayUnit)),i=this._label+" "+i,i!==this._lastText&&(this._lastText=i,this.dom.innerText=i))}update(){let t="";void 0!==this._font&&this._font instanceof CSSFont&&(t+=this._font.genKey()),t!==this._last_font&&(this._last_font=t,this._updateFont()),this.dom.style["pointer-events"]=this.style["pointer-events"],this.hasAttribute("datapath")&&this.updateDataPath()}}UIBase$f.internalRegister(Label);class Container extends UIBase$f{constructor(){super(),this.dataPrefix="",this.massSetPrefix="",this.inherit_packflag=0;let t=this.styletag=document.createElement("style");t.textContent="\n    ",this.shadow.appendChild(t),this.reversed=!1,this._prefixstack=[],this._mass_prefixstack=[]}noUndo(){return this.setUndo(!1),this}set background(t){this.__background=t,this.styletag.textContent=`div.containerx {\n        background-color : ${t};\n      }\n    `,this.style["background-color"]=t}get children(){let t=[];return this._forEachChildWidget((e=>{t.push(e)})),t}static define(){return{tagname:"container-x"}}changePathPrefix(t){let e=this.dataPrefix.trim();this.dataPrefix=t,e.length>0&&(e+=".");let i=(t,s)=>{if(t instanceof Container&&t!==this&&t.dataPrefix.startsWith(e)&&(t.dataPrefix=t.dataPath.slice(e.length,t.dataPrefix.length),t.dataPrefix=s._joinPrefix(t.dataPrefix),s=t),t.hasAttribute("datapath")){let i=t.getAttribute("datapath");i.startsWith(e)&&(i=i.slice(e.length,i.length),i=s._joinPrefix(i),t.setAttribute("datapath",i),t.description=t.description)}t._forEachChildWidget((t=>{i(t,s)}))};i(this,this)}reverse(){return this.reversed^=!0,this}pushMassSetPrefix(t){return this._mass_prefixstack.push(this.massSetPrefix),this.massSetPrefix=t,this}pushDataPrefix(t){return this._prefixstack.push(this.dataPrefix),this.dataPrefix=t,this}popDataPrefix(){return this.dataPrefix=this._prefixstack.pop(),this}popMassSetPrefix(){return this.massSetPrefix=this._mass_prefixstack.pop(),this}saveData(){return this.scrollTop||this.scrollLeft?{scrollTop:this.scrollTop,scrollLeft:this.scrollLeft}:{}}loadData(t){if(!t)return;let e=t.scrollLeft||0,i=t.scrollTop||0;this.doOnce((()=>{this.scrollTo(e,i)}),12)}init(){this.style.display="flex",this.style["flex-direction"]=this.reversed?"column-reverse":"column",this.style["flex-wrap"]="nowrap",this.style["flex-grow"]=""+this.getDefault("flex-grow",void 0,"1"),this.setCSS(),super.init(),this.setAttribute("class","containerx")}useIcons(t=!0){let e=!!t,i=PackFlags$5.USE_ICONS|PackFlags$5.SMALL_ICON|PackFlags$5.LARGE_ICON;i|=PackFlags$5.CUSTOM_ICON_SHEET,i|=255<<PackFlags$5.CUSTOM_ICON_SHEET_START;let s=this.packflag&i;if(!e)return this.packflag&=~PackFlags$5.USE_ICONS,this.inherit_packflag&=~PackFlags$5.USE_ICONS,s;let r=t;return r=!0===r?PackFlags$5.SMALL_ICON:1===r?PackFlags$5.LARGE_ICON:PackFlags$5.CUSTOM_ICON_SHEET|r<<PackFlags$5.CUSTOM_ICON_SHEET_START,this.packflag&=~(PackFlags$5.SMALL_ICON|PackFlags$5.LARGE_ICON|PackFlags$5.CUSTOM_ICON_SHEET),this.packflag&=~(255<<PackFlags$5.CUSTOM_ICON_SHEET_START),this.packflag|=PackFlags$5.USE_ICONS|r,this.inherit_packflag|=PackFlags$5.USE_ICONS|r,s}wrap(t="wrap"){return this.style["flex-wrap"]=t,this}noMarginsOrPadding(){super.noMarginsOrPadding();let t=["margin","padding","margin-block-start","margin-block-end"];t=t.concat(["padding-block-start","padding-block-end"]);for(let e of t)this.style[e]="0px";return this}setCSS(){let t="",e=e=>{if(!this.hasDefault(e))return;let i=this.getDefault(e);void 0!==i&&(t+=`  ${e} = ${i};\n`,this.style[e]=i)};e("border-radius"),e("border-width"),e("border-top"),e("border-bottom"),e("border-left"),e("border-right"),this.styletag.textContent=`div.containerx {\n        background-color : ${this.getDefault("background-color")};\n        ${t}\n      }\n      `}overrideDefault(t,e){return super.overrideDefault(t,e),this.setCSS(),this}strip(t="strip",e=this.getDefault("oneAxisPadding"),i=1,s){let r=t;if("object"==typeof t){let a=t;r=a.themeClass??"strip",e=a.margin1??e,i=a.margin2??1,s=a.horiz}void 0===s&&(s=(s=this instanceof RowFrame)||"row"===this.style["flex-direction"]);let a=s?PackFlags$5.STRIP_HORIZ:PackFlags$5.STRIP_VERT,n=s?this.row():this.col();if("number"!=typeof e)throw new Error("margin1 was not a number");if("number"!=typeof i)throw new Error("margin2 was not a number");if(n.packflag|=a,n.dataPrefix=this.dataPrefix,n.massSetPrefix=this.massSetPrefix,r in theme){let t;n.overrideClass(r),n.background=n.getDefault("background-color"),n.setCSS(),n.overrideClass(r),n.update.after((function(){let s=n.getDefault("border-radius"),r=n.getDefault("border-width"),a=n.getDefault("border-style")||"solid",o=n.getDefault("padding"),l=n.getDefault("border-color")||"rgba(0,0,0,0)",h=n.getDefault("margin")||0;r=void 0===r?0:r,s=void 0===s?0:s,o=void 0===o?5:o;let c=n.getDefault("background-color"),d=s+":"+r+":"+c+":"+o+":";d+=a+":"+o+":"+l+":"+h,d!==t&&(t=d,n.oneAxisPadding(e+o,i+o),n.setCSS(),n.background=c,n.style.margin=h+"px",n.style.border=`${r}px ${a} ${l}`,n.style["border-radius"]=s+"px")}))}else console.warn(this.constructor.name+".strip(): unknown theme class "+r);return n}oneAxisMargin(t=this.getDefault("oneAxisMargin"),e=0){return this.style["margin-top"]=this.style["margin-bottom"]=t+"px",this.style["margin-left"]=this.style["margin-right"]=e+"px",this}oneAxisPadding(t=this.getDefault("oneAxisPadding"),e=0){return this.style["padding-top"]=this.style["padding-bottom"]=t+"px",this.style["padding-left"]=this.style["padding-right"]=e+"px",this}setMargin(t){return this.style.margin=t+"px",this}setPadding(t){return this.style.padding=t+"px",this}setSize(t,e){return void 0!==t&&(this.style.width=this.div.style.width="number"==typeof t?~~t+"px":t),void 0!==e&&(this.style.height=this.div.style.height="number"==typeof e?~~e+"px":e),this}save(){}load(){}saveVisibility(){return localStorage[this.storagePrefix+"_settings"]=JSON.stringify(this),this}loadVisibility(){let t=this.storagePrefix+"_settings",e=!0;if(t in localStorage){console.log("loading UI visibility state. . .");try{this.loadJSON(JSON.parse(localStorage[t]))}catch(t){print_stack$1(t),e=!1}}return e}toJSON(){let t={opened:!this.closed};return Object.assign(super.toJSON(),t)}_ondestroy(){this._forEachChildWidget((t=>{t._ondestroy()})),super._ondestroy()}loadJSON(t){return this}redrawCurves(){throw new Error("Implement me (properly!)")}listen(){window.setInterval((()=>{this.update()}),150)}update(){super.update()}appendChild(t){return t instanceof UIBase$f?(t.ctx=this.ctx,t.parentWidget=this,this.shadow.appendChild(t),void(t.onadd&&t.onadd())):super.appendChild(t)}clear(t=!0){for(let e of this.children)e instanceof UIBase$f&&e.remove(t)}removeChild(t,e=!0){let i=super.removeChild(t);return t.on_remove&&t.on_remove(),e&&t.on_destroy&&t.on_destroy(),t.parentWidget=void 0,i}prepend(t){t instanceof UIBase$a?this._prepend(t):super.prepend(t)}_prepend(t){return this._add(t,!0)}add(t){return this._add(t)}insert(t,e){e.parentWidget=this,e.ctx=this,t>=this.shadow.childNodes.length?this.add(e):this.shadow.insertBefore(e,list$2(this.children)[t]),e.onadd&&e.onadd()}_add(t,e=!1){if(t instanceof NodeList)throw new Error("eek!");return t.ctx=this.ctx,t.parentWidget=this,t._useDataPathUndo=this._useDataPathUndo,!t._themeOverride&&this._themeOverride&&t.overrideTheme(this._themeOverride),e?this.shadow.prepend(t):this.shadow.appendChild(t),t.onadd&&t.onadd(),t}dynamicMenu(t,e,i=0){return this.menu(t,e,i)}menu(t,e,i=0){let s=UIBase$a.createElement("dropbox-x");return s._name=t,s.setAttribute("simple",!0),s.setAttribute("name",t),e instanceof HTMLElement&&"Menu"===e.constructor.name?s._build_menu=function(){return void 0!==this._menu&&void 0!==this._menu.parentNode&&this._menu.remove(),this._menu=createMenu(this.ctx,t,e),this._menu}:e&&(s.template=e),this._container_inherit(s,i),this._add(s),s}toolPanel(t,e={}){let i,s;s="string"==typeof t?this.ctx.api.parseToolPath(t):t,i=s._getFinalToolDef();let r=e.packflag||0,a=e.label||i.uiname,n=e.createCb||e.create_cb,o=e.container||this.panel(a),l=e.defaultsPath||"toolDefaults";l.length>0&&!l.endsWith(".")&&(l+=".");let h=l+i.toolpath;o.useIcons(!1);let c=i.inputs||{};for(let t in c){let e=c[t];if(e.flag&PropFlags$2.PRIVATE)continue;let i=h+"."+(e.apiname||t);o.prop(i)}return o.tool(t,r,n,a),o}tool(t,e={},i,s){let r,a,n;if("object"==typeof e){let t=e;a=t.packflag,i=t.createCb,s=t.label}else a=e||0;if("string"==typeof t){if(t.search(/\|/)>=0&&(t=t.split("|"),void 0===s&&t.length>1&&(s=t[1].trim()),t=t[0].trim()),void 0===this.ctx)return void console.warn("this.ctx was undefined in tool()");if(r=this.ctx.api.parseToolPath(t),void 0===r)return void console.warn('Unknown tool for toolpath "'+t+'"')}else r=t;a|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,void 0===i&&(i=e=>this.ctx.api.createTool(this.ctx,t));let o,l=()=>{console.log("tool run");let t=i(r);this.ctx.api.execTool(this.ctx,t)},h="string"==typeof t?this.ctx.api.getToolDef(t):r.tooldef(),c=void 0===h.description?h.uiname:h.description;if(void 0!==h.hotkey)c+="\n\t"+h.hotkey,n=h.hotkey;else{let e=t;"string"!=typeof e&&(e=h.toolpath);let i=this.ctx.api.getToolPathHotkey(this.ctx,e);i&&(c+="\n\tHotkey: "+i)}return void 0!==h.icon&&a&PackFlags$5.USE_ICONS?(s=void 0===s?c:s,o=this.iconbutton(h.icon,s,l),o.iconsheet=iconSheetFromPackFlag(a),o.packflag|=a,o.description=c):(s=void 0===s?h.uiname:s,o=this.button(s,l),o.description=c,o.packflag|=a),o}textbox(t,e,i,s=0){let r;t&&(r=this._joinPrefix(t)),s|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let a=UIBase$a.createElement("textbox-x");return void 0!==r&&a.setAttribute("datapath",r),a.ctx=this.ctx,a.parentWidget=this,a._init(),this._add(a),a.setCSS(),a.update(),a.packflag|=s,a.onchange=i,a.text=e,a}pathlabel(t,e,i=0){let s;i|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,t&&(s=this._joinPrefix(t));let r=UIBase$a.createElement("label-x");if(void 0===e&&t){let t=this.ctx.api.resolvePath(this.ctx,s);e=t?t.prop.uiname??t.dpath.apiname:"(error)"}return r.text=e,r.packflag=i,r.setAttribute("datapath",s),this._add(r),r.setCSS(),r}label(t){let e=UIBase$a.createElement("label-x");return e.text=t,this._add(e),e}helppicker(){let t=this.iconbutton(Icons$2.HELP,"Help Picker",(()=>{this.getScreen().hintPickerTool()}));return isMobile(),t.ctx&&(t._init(),t.setCSS()),t}iconbutton(t,e,i,s,r=0){r|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let a=UIBase$a.createElement("iconbutton-x");return a.packflag|=r,a.setAttribute("icon",t),a.description=e,a.icon=t,a.iconsheet=iconSheetFromPackFlag(r),a.onclick=i,this._add(a),a}button(t,e,i,s,r=0){r|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let a=UIBase$a.createElement("button-x");return a.packflag|=r,a.setAttribute("name",t),a.setAttribute("buttonid",s),a.onclick=e,this._add(a),a}_joinPrefix(t,e=this.dataPrefix.trim()){if(void 0!==t)return"/"===(t=t.trim())[0]?t:(e.length>0&&t.length>0&&!e.endsWith(".")&&!t.startsWith(".")&&(t="."+t),e+t)}colorbutton(t,e,i){e|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,i=this._getMassPath(this.ctx,t,i);let s=UIBase$a.createElement("color-picker-button-x");return void 0!==t&&(t=this._joinPrefix(t),s.setAttribute("datapath",t)),void 0!==i&&s.setAttribute("mass_set_path",i),s.packflag|=e,this._add(s),s}noteframe(t=0){let e=UIBase$a.createElement("noteframe-x");return e.packflag|=this.inherit_packflag&~PackFlags$5.NO_UPDATE|t,this._add(e),e}curve1d(t,e=0,i){e|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,i=this._getMassPath(this.ctx,t,i);let s=UIBase$a.createElement("curve-widget-x");return s.ctx=this.ctx,s.packflag|=e,t&&(t=this._joinPrefix(t),s.setAttribute("datapath",t)),i&&s.setAttribute("mass_set_path",i),this.add(s),s}vecpopup(t,e=0,i){let s=UIBase$a.createElement("vector-popup-button-x");i=this._getMassPath(this.ctx,t,i),e|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let r="vector";if(t){t=this._joinPrefix(t),s.setAttribute("datapath",t),i&&s.setAttribute("mass_set_path",i);let e=this.ctx.api.resolvePath(this.ctx,t);e&&e.prop&&(r=e.prop.uiname||e.prop.name)}return s.setAttribute("name",r),s.packflag|=e,this.add(s),s}_getMassPath(t,e,i){if(void 0===i&&this.massSetPrefix.length>0&&(i=t.api.getPropName(t,e)),void 0!==i)return this._joinPrefix(i,this.massSetPrefix)}prop(t,e=0,i){if(!this.ctx){console.warn(this.id+".ctx was undefined");let t=this.parentWidget;for(;t;){if(t.ctx){console.warn("Fetched this.ctx from parent"),this.ctx=t.ctx;break}t=t.parentWidget}if(!this.ctx)throw new Error("ui.Container.prototype.prop(): this.ctx was undefined")}e|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let s=this.ctx.api.resolvePath(this.ctx,this._joinPrefix(t),!0);if(void 0===s||void 0===s.prop)return void console.warn("Unknown property at path",this._joinPrefix(t),this.ctx.api.resolvePath(this.ctx,this._joinPrefix(t),!0));let r=s.prop,a=this.useDataPathUndo&&!(r.flag&PropFlags$2.NO_UNDO);function n(e){return"number"==typeof e&&isNaN(e)?(console.warn("Subkey error in data api",t),""+e):e=(e=(e=""+e)[0].toUpperCase()+e.slice(1,e.length).toLowerCase()).replace(/_/g," ")}if(r.type===PropTypes$3.REPORT)return this.pathlabel(t,r.uiname);if(r.type===PropTypes$3.STRING){let n;if(r.flag&PropFlags$2.READ_ONLY)n=this.pathlabel(t,r.uiname);else if(r.multiLine)n=this.textarea(t,s.value,e,i),n.useDataPathUndo=a;else{let e=this.strip();void 0!==r.uiname?r.uiname:ToolProperty.makeUIName(r.apiname);e.label(r.uiname),n=e.textbox(t),n.useDataPathUndo=a,i&&n.setAttribute("mass_set_path",i)}return n.packflag|=e,n}if(r.type===PropTypes$3.CURVE){let s=this.curve1d(t,e,i);return s.useDataPathUndo=a,s}if(r.type===PropTypes$3.INT||r.type===PropTypes$3.FLOAT){let s;return s=e&PackFlags$5.SIMPLE_NUMSLIDERS?this.simpleslider(t,{packflag:e}):this.slider(t,{packflag:e}),s.useDataPathUndo=a,s.packflag|=e,i&&s.setAttribute("mass_set_path",i),s}if(r.type===PropTypes$3.BOOL){let s=this.check(t,r.uiname,e,i);return s.useDataPathUndo=a,s}if(r.type===PropTypes$3.ENUM){if(void 0!==s.subkey){let r=s.subkey,o=s.prop.ui_value_names[s.subkey];void 0===o&&(o=n(s.subkey));let l=this.check(t,o,e,i),h=s.prop.descriptions[r];return l.useDataPathUndo=a,l.description=void 0===h?s.prop.ui_value_names[r]:h,l.icon=s.prop.iconmap[s.subkey],l}if(e&PackFlags$5.USE_ICONS||r.flag&(PropFlags$2.USE_ICONS|PropFlags$2.FORCE_ENUM_CHECKBOXES)){if(r.flag&PropFlags$2.USE_ICONS?e|=PackFlags$5.USE_ICONS:r.flag&PropFlags$2.FORCE_ENUM_CHECKBOXES&&(e&=~PackFlags$5.USE_ICONS),e&PackFlags$5.FORCE_PROP_LABELS){let i=this.strip();return i.label(r.uiname),i.checkenum(t,void 0,e).setUndo(a)}return this.checkenum(t,void 0,e).setUndo(a)}return this.listenum(t,{packflag:e,mass_set_path:i}).setUndo(a)}if(r.type&(PropTypes$3.VEC2|PropTypes$3.VEC3|PropTypes$3.VEC4)){if(void 0!==s.subkey){let i;return i=e&PackFlags$5.SIMPLE_NUMSLIDERS?this.simpleslider(t,{packflag:e}):this.slider(t,{packflag:e}),i.packflag|=e,i.setUndo(a)}if(r.subtype===PropSubTypes$2.COLOR)return this.colorbutton(t,e,i).setUndo(a);{let s=UIBase$a.createElement("vector-panel-x");return i=this._getMassPath(this.ctx,t,i),s.packflag|=e|this.inherit_packflag&~PackFlags$5.NO_UPDATE,s.inherit_packflag|=e|this.inherit_packflag&~PackFlags$5.NO_UPDATE,t&&s.setAttribute("datapath",this._joinPrefix(t)),i&&s.setAttribute("mass_set_path",i),this.add(s),s.setUndo(a)}}if(r.type===PropTypes$3.FLAG){if(void 0!==s.subkey){let r=s.prop.descriptions[s.subkey],o=s.prop.ui_value_names[s.subkey];"number"==typeof s.subkey&&(o=s.prop.keys[s.subkey],o=o&&o in s.prop.ui_value_names?s.prop.ui_value_names[o]:n(o||"(error)")),void 0===o&&(o="(error)");let l=this.check(t,o,e,i);return l.icon=s.prop.iconmap[s.subkey],r&&(l.description=r),l.setUndo(a)}{let s=this;if(e&PackFlags$5.FORCE_PROP_LABELS&&(s=this.strip(),s.label(r.uiname)),e&PackFlags$5.PUT_FLAG_CHECKS_IN_COLUMNS){let o=0,l=s.row(),h=l.col(),c=l.col();for(let s in r.values){let l=r.ui_value_names[s],d=r.descriptions[s];void 0===l&&(l=n(s));let u=(1&o?h:c).check(`${t}[${s}]`,l,e,i);d&&(u.description=d),u.setUndo(a),o++}return l}if(e&PackFlags$5.WRAP_CHECKBOXES){let s,a,o,l="row"===this.style["flex-direction"];l=l||"row-reverse"===this.style["flex-direction"],l?(s=this.getDefault("checkRowWrapLimit",void 0,24),a=this.col().strip(),a.packflag|=e,a.inherit_packflag|=e,o=a.row()):(s=this.getDefault("checkColWrapLimit",void 0,5),a=this.row().strip(),a.packflag|=e,a.inherit_packflag|=e,o=a.col());let h=0,c=0;for(let d in r.values){let u=r.ui_value_names[d],p=r.descriptions[d];void 0===u&&(u=n(d));let m=o.check(`${t}[${d}]`,u,e,i);p&&(m.description=p),h+=u.length,c+=1,l&&h>s?(h=0,o=a.row()):!l&&c>s&&(c=0,o=a.col())}return a}s===this&&(s=this.strip());let o=()=>{s.clear();for(let o in r.values){let l=r.ui_value_names[o],h=r.descriptions[o];void 0===l&&(l=n(o));let c=s.check(`${t}[${o}]`,l,e,i);c.useDataPathUndo=a,h&&(c.description=h),c.setUndo(a)}};o();let l=r.calcHash();return s.update.after((()=>{let t=r.calcHash();l!==t&&(l=t,console.error("Property definition update"),o())})),s}}}iconcheck(t,e,i,s){let r=UIBase$a.createElement("iconcheck-x");return r.icon=e,r.description=i,t&&r.setAttribute("datapath",t),s&&r.setAttribute("mass_set_path",s),this.add(r),r}check(t,e,i=0,s){i|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let r,a=void 0!==t?this._joinPrefix(t):void 0;return i&PackFlags$5.USE_ICONS?(r=UIBase$a.createElement("iconcheck-x"),r.iconsheet=iconSheetFromPackFlag(i)):r=UIBase$a.createElement("check-x"),s=this._getMassPath(this.ctx,t,s),r.packflag|=i,r.label=e,r.noMarginsOrPadding(),t&&r.setAttribute("datapath",a),s&&r.setAttribute("mass_set_path",s),this._add(r),r}checkenum(t,e,i,s,r,a,n,o){if("object"==typeof e&&null!==e){let t=e;e=t.name,i=t.packflag,t.enummap,t.defaultval,a=t.callback,t.iconmap,o=t.mass_set_path}o=this._getMassPath(this.ctx,t,o),i=void 0===i?0:i,i|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let l,h,c=this._joinPrefix(t);if(void 0!==c&&(l=this.ctx.api.resolvePath(this.ctx,c,!0),void 0!==l&&(l=l.prop)),void 0!==c){if(void 0===l)return void console.warn("Bad path in checkenum",c);if(h=this.strip(),h.oneAxisPadding(),i&PackFlags$5.USE_ICONS)for(let e in l.values){let s=h.check(t+"["+e+"]","",i);s.packflag|=PackFlags$5.HIDE_CHECK_MARKS,s.icon=l.iconmap[e],s.drawCheck=!1,s.style.padding="0px",s.style.margin="0px",s.dom.style.padding="0px",s.dom.style.margin="0px",s.description=l.descriptions[e]}else{void 0===e&&(e=l.uiname),h.label(e).font="TitleText";let i={},s=!1;function r(t){return()=>{if(!s){s=!0;for(let e in i)e!==t&&(i[e].checked=!1);s=!1,a&&a(t)}}}for(let e in l.values){let s=h.check(`${t}[${e}]`,l.ui_value_names[e]);i[e]=s,o&&s.setAttribute("mass_set_path",o),s.description=l.descriptions[l.keys[e]],s.description||(s.description=""+l.ui_value_names[e]),s.onchange=r(e)}}}return h}checkenum_panel(t,e,i=0,s,r,a){i=void 0===i?0:i,i|=this.inherit_packflag&~PackFlags$5.NO_UPDATE;let n,o=this._joinPrefix(t);if(void 0!==o&&void 0===a&&void 0!==(a=this.ctx.api.resolvePath(this.ctx,o,!0))&&(a=a.prop),!e&&a&&(e=a.uiname),void 0!==o){if(void 0===a)return void console.warn("Bad path in checkenum",o);if(n=this.panel(e,e,i),n.oneAxisPadding(),n.setCSS.after(n.background=this.getDefault("BoxSub2BG")),i&PackFlags$5.USE_ICONS)for(let e in a.values){let s=n.check(t+" == "+a.values[e],"",i);s.icon=a.iconmap[e],s.drawCheck=!1,s.style.padding="0px",s.style.margin="0px",s.dom.style.padding="0px",s.dom.style.margin="0px",s.description=a.descriptions[e]}else{void 0===e&&(e=a.uiname),n.label(e).font="TitleText";let i={},o=!1;function l(t){return()=>{if(!o){o=!0;for(let e in i)e!==t&&(i[e].checked=!1);o=!1,s&&s(t)}}}for(let e in a.values){let s=n.check(t+" = "+a.values[e],a.ui_value_names[e]);i[e]=s,r&&s.setAttribute("mass_set_path",r),s.description=a.descriptions[a.keys[e]],s.description||(s.description=""+a.ui_value_names[e]),s.onchange=l(e)}}}return n}listenum(t,e,i,s,r,a,n=0){let o,l;if(n|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,e&&"object"==typeof e){let t=e;e=t.name,i=t.enumDef,s=t.defaultval,r=t.callback,a=t.iconmap,n=t.packflag||0,o=t.mass_set_path}o=this._getMassPath(this.ctx,t,o);let h=e;void 0!==t&&(l=this._joinPrefix(t));let c=UIBase$a.createElement("dropbox-x");if(void 0!==i)i instanceof EnumProperty$9?(c.prop=i,h||=i.uiname||ToolProperty$1.makeUIName(i.apiname)):c.prop=new EnumProperty$9(s,i,l,e),void 0!==a&&c.prop.addIcons(a);else{let t=this.ctx.api.resolvePath(this.ctx,l,!0);void 0!==t&&(c.prop=t.prop,e||=t.prop.uiname,h||=e)}if(o=this._getMassPath(this.ctx,t,o),void 0!==l&&c.setAttribute("datapath",l),void 0!==o&&c.setAttribute("mass_set_path",o),c.setAttribute("name",e),s&&c.setValue(s),c.onchange=r,c.onselect=r,c.packflag|=n,h&&n&PackFlags$5.FORCE_PROP_LABELS){const t=this.row();let e;n&PackFlags$5.LABEL_ON_RIGHT?(t._add(c),e=t.label(h),e.style["margin-left"]&&"unset"!==e.style["margin-left"]||(e.style["margin-left"]="5px")):(e=t.label(h),t._add(c))}else this._add(c);return c}getroot(){let t=this;for(;void 0!==t.parent;)t=t.parent;return t}simpleslider(t,e,i,s,r,a,n,o,l,h=0){if(2===arguments.length||"object"==typeof e){let i=Object.assign({},e);return i.packflag=(i.packflag||0)|PackFlags$5.SIMPLE_NUMSLIDERS,this.slider(t,i)}return this.slider(t,e,i,s,r,a,n,o,l,h|PackFlags$5.SIMPLE_NUMSLIDERS)}slider(t,e,i,s,r,a,n,o,l,h=0){if(2===arguments.length||"object"==typeof e){let t=e;e=t.name,i=t.defaultval,s=t.min,r=t.max,a=t.step,n=t.is_int||t.isInt,o=t.do_redraw,l=t.callback,h=t.packflag||0}let c;if(h|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,t){t=this._joinPrefix(t);let e=this.ctx.api.resolvePath(this.ctx,t,!0);e&&e.prop&&e.prop.flag&PropFlags$2.SIMPLE_SLIDER&&(h|=PackFlags$5.SIMPLE_NUMSLIDERS),e&&e.prop&&e.prop.flag&PropFlags$2.FORCE_ROLLER_SLIDER&&(h|=PackFlags$5.FORCE_ROLLER_SLIDER)}let d=h&PackFlags$5.SIMPLE_NUMSLIDERS||exports.simpleNumSliders;return d=d&&!(h&PackFlags$5.FORCE_ROLLER_SLIDER),c=exports.useNumSliderTextboxes&&!(h&PackFlags$5.NO_NUMSLIDER_TEXTBOX)?d?UIBase$a.createElement("numslider-simple-x"):UIBase$a.createElement("numslider-textbox-x"):d?UIBase$a.createElement("numslider-simple-x"):UIBase$a.createElement("numslider-x"),c.packflag|=h,t&&c.setAttribute("datapath",t),e&&c.setAttribute("name",e),void 0!==s&&c.setAttribute("min",s),void 0!==r&&c.setAttribute("max",r),void 0!==i&&c.setValue(i),n&&c.setAttribute("integer",n),l&&(c.onchange=l),this._add(c),this.ctx&&(c.setCSS(),c.update()),c}_container_inherit(t,e=0){e|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,t.packflag|=e,t.inherit_packflag|=e,t.dataPrefix=this.dataPrefix,t.massSetPrefix=this.massSetPrefix}treeview(){let t=UIBase$a.createElement("tree-view-x");return t.ctx=this.ctx,this.add(t),this._container_inherit(t),t}panel(t,e,i=0,s){e=void 0===e?t:e;let r=UIBase$a.createElement("panelframe-x");return this._container_inherit(r,i),s&&r.setHeaderToolTip(s),r.setAttribute("label",t),r.setAttribute("id",e),this._add(r),this.ctx&&(r.ctx=this.ctx,r._init(),r.contents.ctx=r.ctx),r.contents.dataPrefix=this.dataPrefix,r.contents.massSetPrefix=this.massSetPrefix,r}row(t=0){let e=UIBase$a.createElement("rowframe-x");return this._container_inherit(e,t),this._add(e),e.ctx=this.ctx,e}listbox(t=0){let e=UIBase$a.createElement("listbox-x");return this._container_inherit(e,t),this._add(e),e}table(t=0){let e=UIBase$a.createElement("tableframe-x");return this._container_inherit(e,t),this._add(e),e}twocol(t=1,e=0){let i=UIBase$a.createElement("two-column-x");return i.parentDepth=t,this._container_inherit(i,e),this._add(i),i}col(t=0){let e=UIBase$a.createElement("colframe-x");return this._container_inherit(e,t),this._add(e),e}colorPicker(t,e=0,i,s){let r,a;if("object"==typeof e){let t=e;r=void 0!==t.packflag?t.packflag:0,i=t.massSetPath,s=t.themeOverride}t&&(a=this._joinPrefix(t));let n=UIBase$a.createElement("colorpicker-x");return s&&n.overrideClass(s),r|=PackFlags$5.SIMPLE_NUMSLIDERS,this._container_inherit(n,r),n.ctx=this.ctx,n.parentWidget=this,n._init(),n.packflag|=r,n.inherit_packflag|=r,n.constructor.setDefault(n),void 0!==a&&n.setAttribute("datapath",a),console.warn("mass_set_path",i),i&&n.setAttribute("mass_set_path",i),window.colorpicker=n,this._add(n),n}textarea(t,e="",i=0,s){i|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,s=this._getMassPath(this.ctx,t,s);let r=UIBase$a.createElement("rich-text-editor-x");return r.ctx=this.ctx,r.packflag|=i,void 0!==e&&(r.value=e),t&&r.setAttribute("datapath",t),s&&r.setAttribute("mass_set_path",s),this.add(r),r}viewer(t,e="",i=0,s){i|=this.inherit_packflag&~PackFlags$5.NO_UPDATE,s=this._getMassPath(this.ctx,t,s);let r=UIBase$a.createElement("html-viewer-x");return r.ctx=this.ctx,r.packflag|=i,void 0!==e&&(r.value=e),t&&r.setAttribute("datapath",t),s&&r.setAttribute("mass_set_path",s),this.add(r),r}tabs(t="top",e=0){let i=UIBase$a.createElement("tabcontainer-x");return i.constructor.setDefault(i),i.setAttribute("bar_pos",t),this._container_inherit(i,e),this._add(i),i}asDialogFooter(){return this.style["margin-top"]="15px",this.style["justify-content"]="flex-end",this}}UIBase$f.internalRegister(Container,"div");class RowFrame extends Container{constructor(){super()}static define(){return{tagname:"rowframe-x"}}connectedCallback(){super.connectedCallback(),this.style.display="flex",this.style["flex-direction"]=this.reversed?"row-reverse":"row"}init(){super.init(),this.style.display="flex",this.style["flex-direction"]=this.reversed?"row-reverse":"row",this.style["align-items"]&&""!=this.style["align-items"]||(this.style["align-items"]="center"),"simple"===this.getDefault("slider-style")&&(this.packflag|=PackFlags$5.SIMPLE_NUMSLIDERS,this.inherit_packflag|=PackFlags$5.SIMPLE_NUMSLIDERS)}oneAxisMargin(t=this.getDefault("oneAxisMargin"),e=0){return this.style["margin-left"]=this.style["margin-right"]=t+"px",this.style["margin-top"]=this.style["margin-bottom"]=e+"px",this}oneAxisPadding(t=this.getDefault("oneAxisPadding"),e=0){return this.style["padding-left"]=this.style["padding-right"]=t+"px",this.style["padding-top"]=this.style["padding-bottom"]=e+"px",this}update(){super.update()}}UIBase$a.internalRegister(RowFrame);class ColumnFrame extends Container{constructor(){super()}static define(){return{tagname:"colframe-x"}}init(){super.init(),this.style.display="flex",this.style["flex-direction"]="column",this.style["justify-content"]="right"}update(){super.update()}oneAxisMargin(t=this.getDefault("oneAxisMargin"),e=0){return this.style["margin-top"]=this.style["margin-bottom"]=t+"px",this.style["margin-left"]=this.style["margin-right"]=e+"px",this}oneAxisPadding(t=this.getDefault("oneAxisPadding"),e=0){return this.style["padding-top"]=this.style["padding-bottom"]=t+"px",this.style["padding-left"]=this.style["padding-right"]=e+"px",this}}UIBase$a.internalRegister(ColumnFrame);class TwoColumnFrame extends Container{constructor(){super(),this._colWidth=256,this.parentDepth=1}get colWidth(){return this.hasAttribute("colWidth")?parsepx(this.getAttribute("colWidth")):this._colWidth}set colWidth(t){this.hasAttribute("colWidth")?this.setAttribute("colWidth",""+t):this._colWidth=t}static define(){return{tagname:"two-column-x"}}init(){super.init(),this.style.display="flex",this.style["flex-direction"]="column"}update(){super.update();let t=this;for(let e=0;e<this.parentDepth;e++)t=t.parentWidget?t.parentWidget:t;if(!t)return;let e=t.getBoundingClientRect();if(!e)return;let i=e.width>2*this.colWidth?"row":"column";this.style["flex-direction"]!==i&&(this.style["flex-direction"]=i)}}UIBase$a.internalRegister(TwoColumnFrame);let UIBase$9=UIBase$f;class Note extends UIBase$f{constructor(){super();let t=document.createElement("style");this._noteid=void 0,this.height=20,this.showExclMark=!0,t.textContent="\n    .notex {\n      display : flex;\n      flex-direction : row;\n      flex-wrap : nowrap;\n      height : {this.height}px;\n      padding : 0px;\n      margin : 0px;\n    }\n    ",this.dom=document.createElement("div"),this.dom.setAttribute("class","notex"),this.color="red",this.shadow.appendChild(t),this.shadow.append(this.dom),this.setLabel("")}static define(){return{tagname:"note-x",style:"notification"}}setLabel(t){this.color;if(this.showExclMark&&void 0===this.mark){this.mark=document.createElement("div"),this.mark.style.display="flex",this.mark.style["flex-direction"]="row",this.mark.style["flex-wrap"]="nowrap";let t=0,e=iconmanager$1.getTileSize(t);this.mark.style.width=e+"px",this.mark.style.height=e+"px",this.dom.appendChild(this.mark),this.ntext=document.createElement("div"),this.ntext.style.display="inline-flex",this.ntext.style["flex-wrap"]="nowrap",this.dom.appendChild(this.ntext),iconmanager$1.setCSS(Icons$2.NOTE_EXCL,this.mark,t)}else!this.showExclMark&&this.mark&&(this.mark.remove(),this.mark=void 0);this.ntext.innerText=" "+t}init(){super.init(),this.setAttribute("class","notex"),this.style.display="flex",this.style["flex-wrap"]="nowrap",this.style["flex-direction"]="row",this.style["border-radius"]="7px",this.style.padding="2px",this.style.color=this.getDefault("DefaultText").color;let t=css2color$1(this.color);t=color2css$1([t[0],t[1],t[2],.25]),this.style["background-color"]=t,this.setCSS()}setCSS(){super.setCSS(!1)}}UIBase$9.internalRegister(Note);class ProgBarNote extends Note{constructor(){super(),this._percent=0,this.barWidth=100;let t=this.bar=document.createElement("div");t.style.display="flex",t.style["flex-direction"]="row",t.style.width=this.barWidth+"px",t.style.height=this.height+"px",t.style["background-color"]=this.getDefault("ProgressBarBG"),t.style["border-radius"]="12px",t.style["align-items"]="center",t.style.padding=t.style.margin="0px";let e=this.bar2=document.createElement("div");e.style.display="flex",e.style["flex-direction"]="row",e.style.height=this.height+"px",e.style["background-color"]=this.getDefault("ProgressBar"),e.style["border-radius"]="12px",e.style["align-items"]="center",e.style.padding=e.style.margin="0px",this.bar.appendChild(e),this.dom.appendChild(this.bar)}get percent(){return this._percent}set percent(t){this._percent=t,this.setCSS()}static define(){return{tagname:"note-progress-x",style:"notification"}}setCSS(){super.setCSS();let t=~~(this.percent*this.barWidth+.5);this.bar2.style.width=t+"px"}init(){super.init()}}UIBase$9.internalRegister(ProgBarNote);class NoteFrame extends RowFrame{constructor(){super(),this._h=20}static define(){return{tagname:"noteframe-x",style:"noteframe"}}init(){super.init(),this.noMarginsOrPadding(),noteframes.push(this),this.background=this.getDefault("background-color"),this.style["flex-grow"]="unset"}setCSS(){super.setCSS(),this.style.width="min-contents",this.style.height=this._h+"px"}_ondestroy(){noteframes.indexOf(this)>=0&&noteframes.remove(this),super._ondestroy()}progbarNote(t,e,i="rgba(255,0,0,0.2)",s=700,r=t){let a;for(let t of this.children)if(t._noteid===r){a=t;break}(100*Math.min(e,1)).toFixed(1);return void 0===a&&(a=this.addNote(t,i,-1,"note-progress-x"),a._noteid=r),a.percent=e,e>=1&&window.setTimeout((()=>{a.remove()}),s),a}addNote(t,e="rgba(255,0,0,0.2)",i=1200,s="note-x",r=!0){let a=UIBase$9.createElement(s);return a.color=e,a.setLabel(t),a.style["text-align"]="center",a.style.font=getFont(a,"DefaultText"),a.style.color=this.getDefault("DefaultText").color,a.showExclMark=r,this.add(a),this.noMarginsOrPadding(),a.noMarginsOrPadding(),a.style.height=this._h+"px",a.height=this._h,-1!==i&&window.setTimeout((()=>{a.remove()}),i),a}}function getNoteFrames(t){let e=[],i=t=>{if(t instanceof NoteFrame&&e.push(t),void 0!==t.childNodes)for(let e of t.childNodes)i(e);if(t instanceof UIBase$f&&void 0!==t.shadow&&t.shadow.childNodes)for(let e of t.shadow.childNodes)i(e)};return i(t),e}UIBase$9.internalRegister(NoteFrame);let noteframes=[];function sendNote(t,e,i,s=3e3,r=!0){noteframes=getNoteFrames(t);for(let t of noteframes)try{t.addNote(e,i,s,void 0,r)}catch(t){print_stack(t),console.log(t.stack,t.message),console.log("bad notification frame")}}function error(t,e,i){return sendNote(t,e,color2css$1([1,0,0,1]),i)}function warning(t,e,i){return sendNote(t,e,color2css$1([.78,.78,.2,1]),i)}function message(t,e,i){return sendNote(t,e,color2css$1([.2,.9,.1,1]),i,!1)}function progbarNote(t,e,i,s,r){noteframes=getNoteFrames(t);for(let t of noteframes)try{t.progbarNote(e,i,s,r)}catch(t){print_stack(t),console.log(t.stack,t.message),console.log("bad notification frame")}}window._sendNote=sendNote;var ui_noteframe=Object.freeze({__proto__:null,Note:Note,ProgBarNote:ProgBarNote,NoteFrame:NoteFrame,getNoteFrames:getNoteFrames,get noteframes(){return noteframes},sendNote:sendNote,error:error,warning:warning,message:message,progbarNote:progbarNote});let UIBase$8=UIBase$f,Icons$1=Icons$2;class RichEditor extends TextBoxBase{constructor(){super(),this._internalDisabled=!1,this._value="",this.textOnlyMode=!1,this.styletag=document.createElement("style"),this.styletag.textContent="\n      div.rich-text-editor-x {\n        width        :   100%;\n        height       :   100%;\n        min-height   :   150px;\n        overflow     :   scroll;\n        padding      :   5px;\n        white-space  :   pre-wrap;\n      }\n      \n      rich-text-editor-x {\n        display        : flex;\n        flex-direction : column;\n      }\n    ",this.shadow.appendChild(this.styletag);let t=this.controls=UIBase$8.createElement("rowframe-x"),e=(e,i,s)=>((e=t.iconbutton(e,i,s)).iconsheet=1,e.overrideDefault("padding",3),e);e(Icons$1.BOLD,"Bold",(()=>{document.execCommand("bold")})),e(Icons$1.ITALIC,"Italic",(()=>{document.execCommand("italic")})),e(Icons$1.UNDERLINE,"Underline",(()=>{document.execCommand("underline")})),e(Icons$1.STRIKETHRU,"Strikethrough",(()=>{document.execCommand("strikeThrough")})),t.background=this.getDefault("background-color"),this.shadow.appendChild(t),this.textarea=document.createElement("div"),this.textarea.contentEditable=!0,this.textarea.setAttribute("class","rich-text-editor-x"),this.textarea.style.font=this.getDefault("DefaultText").genCSS(),this.textarea.style["background-color"]=this.getDefault("background-color"),this.textarea.setAttribute("white-space","pre-wrap"),this.textarea.addEventListener("keydown",(t=>{t.keyCode===keymap$4.S&&t.shiftKey&&(t.ctrlKey||t.commandKey)&&(this.toggleStrikeThru(),t.preventDefault(),t.stopPropagation())})),this.textarea.addEventListener("focus",(t=>{this._focus=1,this.setCSS()})),this.textarea.addEventListener("blur",(t=>{this._focus=0,this.setCSS()})),document.execCommand("styleWithCSS",!0),window.ta=this,this.textarea.addEventListener("selectionchange",(t=>{console.log("sel1")})),document.addEventListener("selectionchange",((t,e)=>{console.log("sel2",document.getSelection().startNode,e)})),this.textarea.addEventListener("input",(t=>{if(this.internalDisabled)return;let e;if(console.log("text input",t),e=this.textOnlyMode?this.textarea.innerText:this.textarea.innerHTML,this.textOnlyMode&&e===this._value)return void console.log("detected formatting change");let i=document.getSelection();i.getRangeAt(0),i.anchorNode,i.anchorOffset;if(this._value=e,this.hasAttribute("datapath")){let t=this.getAttribute("datapath");this.setPathValue(this.ctx,t,this.value)}this.onchange&&this.onchange(this._value),this.oninput&&this.oninput(this._value),this.dispatchEvent(new InputEvent(this)),this.dispatchEvent(new CustomEvent("change"))})),this.shadow.appendChild(this.textarea)}formatStart(){}formatLine(t,e){return t}toggleStrikeThru(){console.log("strike thru!"),document.execCommand("strikeThrough")}formatEnd(){}init(){super.init(),window.rc=this,document.execCommand("defaultParagraphSeparator",!1,"div"),this.setCSS()}get internalDisabled(){return this._internalDisabled}set internalDisabled(t){this._internalDisabled;this._internalDisabled=!!t,super.internalDisabled=t,this.textarea.internalDisabled=t,this.textarea.contentEditable=!t,this.setCSS()}set value(t){if(this._value=t,this.textOnlyMode){let e="";for(let i of t.split("\n"))e+=i+"<br>";t=e}this.textarea.innerHTML=t}get value(){return this._value}setCSS(){super.setCSS(),this.controls.background=this.getDefault("background-color"),this._focus?this.textarea.style.border=`2px dashed ${this.getDefault("focus-border-color")}`:this.textarea.style.border="none",this.style.font?this.textarea.style.font=this.style.font:this.textarea.style.font=this.getDefault("DefaultText").genCSS(),this.style.color?this.textarea.style.color=this.style.color:this.textarea.style.color=this.getDefault("DefaultText").color,this.disabled?this.textarea.style["background-color"]=this.getDefault("DisabledBG"):this.textarea.style["background-color"]=this.getDefault("background-color")}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getAttribute("datapath");if(void 0===this.getPathMeta(this.ctx,t))return console.warn("invalid datapath "+t),void(this.internalDisabled=!0);this.internalDisabled=!1;let e=this.getPathValue(this.ctx,t);e!==this._value&&(console.log("text change"),this.value=e)}update(){super.update(),this.updateDataPath()}static define(){return{tagname:"rich-text-editor-x",style:"richtext",modalKeyEvents:!0}}}UIBase$8.internalRegister(RichEditor);class RichViewer extends UIBase$8{constructor(){super(),this.contents=document.createElement("div"),this.contents.style.padding="10px",this.contents.style.margin="10px",this.contents.style.overflow="scroll",this.shadow.appendChild(this.contents),this._value=""}hideScrollBars(){this.contents.style.overflow="hidden"}showScrollBars(){this.contents.style.overflow="scroll"}textTransform(t){return t}set value(t){this._value=t,this.contents.innerHTML=this.textTransform(t)}get value(){return this._value}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getAttribute("datapath");if(void 0===this.getPathMeta(this.ctx,t))return console.warn("invalid datapath "+t),void(this.internalDisabled=!0);this.internalDisabled=!1;let e=this.getPathValue(this.ctx,t);e!==this.value&&(this.value=e)}update(){super.update(),this.updateDataPath()}static define(){return{tagname:"html-viewer-x",style:"html_viewer"}}}UIBase$8.internalRegister(RichViewer);let keymap=keymap$4;class VectorPopupButton extends Button{constructor(){super(),this.value=new Vector4$2}static define(){return{tagname:"vector-popup-button-x",style:"vecPopupButton"}}_onpress(t){if(t.button&&0!==t.button)return;let e=UIBase$f.createElement("vector-panel-x"),i=this.ctx.screen.popup(this,this);i.add(e),i.button("ok",(()=>{i.end()})),this.hasAttribute("datapath")&&e.setAttribute("datapath",this.getAttribute("datapath")),this.hasAttribute("mass_set_path")&&e.setAttribute("mass_set_path",this.getAttribute("mass_set_path")),i.flushUpdate()}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getPathValue(this.ctx,this.getAttribute("datapath"));if(t){if(this.internalDisabled&&(this.internalDisabled=!1),this.value.length!==t.length)switch(t.length){case 2:this.value=new Vector2$b;break;case 3:this.value=new Vector3$2;break;case 4:this.value=new Vector4$2}this.value.vectorDistance(t)>1e-4&&(this.value.load(t),console.log("updated vector popup button value"))}else this.internalDisabled=!0}update(){super.update(),this.updateDataPath()}}UIBase$f.internalRegister(VectorPopupButton);class VectorPanel extends ColumnFrame{constructor(){super(),this.range=[-1e17,1e17],this.name="",this.axes="XYZW",this.value=new Vector3$2,this.sliders=[],this.hasUniformSlider=!1,this.packflag|=PackFlags$a.FORCE_ROLLER_SLIDER;let t=t=>{Object.defineProperty(this,t,{get:function(){return this._getNumParam(t)},set:function(e){this._setNumParam(t,e)}})};this.__range=[-1e17,1e17],this._range=new Array(2),Object.defineProperty(this._range,0,{get:()=>this.__range[0],set:t=>this.__range[0]=t}),Object.defineProperty(this._range,1,{get:()=>this.__range[1],set:t=>this.__range[1]=t}),t("isInt"),t("radix"),t("decimalPlaces"),t("baseUnit"),t("displayUnit"),t("step"),t("slideSpeed"),t("expRate"),t("stepIsRelative"),window.vp=this}init(){super.init(),this.rebuild(),this.setCSS(),this.background=this.getDefault("InnerPanelBG")}_getNumParam(t){return this["_"+t]}_setNumParam(t,e){if("range"===t)return this.__range[0]=e[0],void(this.__range[1]=e[1]);this["_"+t]=e;for(let i of this.sliders)i[t]=e}rebuild(){let t,e;this.clear(),this.name&&this.label(this.name),this.hasUniformSlider?(e=this.row(),t=e.col()):t=this,this.sliders=[];for(let e=0;e<this.value.length;e++){let i=t.slider(void 0,{name:this.axes[e],defaultval:this.value[e],min:this.range[0],max:this.range[1],step:this.step||.001,is_int:this.isInt,packflag:this.packflag});i.addLabel=!1,i.labelOnTop=!1,i.axis=e;let s=this;i.baseUnit=this.baseUnit,i.slideSpeed=this.slideSpeed,i.decimalPlaces=this.decimalPlaces,i.displayUnit=this.displayUnit,i.isInt=this.isInt,i.range=this.__range,i.radix=this.radix,i.step=this.step,i.expRate=this.expRate,i.stepIsRelative=this.stepIsRelative,this.stepIsRelative&&(i.step=ToolProperty$1.calcRelativeStep(this.step,this.value[e])),i.onchange=function(t){s.value[this.axis]=this.value,s.hasAttribute("datapath")&&s.setPathValue(s.ctx,s.getAttribute("datapath"),s.value),s.uslider&&s.uslider.setValue(s.uniformValue,!1),s.onchange&&s.onchange(s.value)},this.sliders.push(i)}if(this.hasUniformSlider){let t=this.uslider=UIBase$f.createElement("numslider-x");e._prepend(t),t.range=this.range,t.baseUnit=this.baseUnit,t.slideSpeed=this.slideSpeed,t.decimalPlaces=this.decimalPlaces,t.displayUnit=this.displayUnit,t.expRate=this.expRate,t.step=this.step,t.expRate=this.expRate,t.isInt=this.isInt,t.radix=this.radix,t.decimalPlaces=this.decimalPlaces,t.stepIsRelative=this.stepIsRelative,t.vertical=!0,t.setValue(this.uniformValue,!1),this.sliders.push(t),t.onchange=()=>{this.uniformValue=t.value}}else this.uslider=void 0;this.setCSS()}get uniformValue(){let t=0;for(let e=0;e<this.value.length;e++)t+=isNaN(this.value[e])?0:this.value[e];return t/this.value.length}set uniformValue(t){let e=this.uniformValue,i=!1;if(0===e||0===t)i=0!==this.value.dot(this.value),this.value.zero();else{let s=t/e;for(let t=0;t<this.value.length;t++)this.value[t]*=s;i=!0}if(i){this.hasAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),this.value),this.onchange&&this.onchange(this.value);for(let t=0;t<this.value.length;t++)this.sliders[t].setValue(this.value[t],!1),this.sliders[t]._redraw();this.uslider&&(this.uslider.setValue(t,!1),this.uslider._redraw())}}setValue(t){if(t){if(t.length!==this.value.length){switch(t.length){case 2:this.value=new Vector2$b(t);break;case 3:this.value=new Vector3$2(t);break;case 4:this.value=new Vector4$2(t);break;default:throw new Error("invalid vector size "+t.length)}this.rebuild()}else this.value.load(t);return this.onchange&&this.onchange(this.value),this}}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getAttribute("datapath"),e=this.getPathValue(this.ctx,t);if(void 0===e)return void(this.internalDisabled=!0);let i=this.getPathMeta(this.ctx,t),s=void 0!==i.uiname?i.uiname:i.name;if(this.hasAttribute("name")&&(s=this.getAttribute("name")),s&&s!==this.name)return this.name=s,void this.rebuild();let r=(t,e=!1)=>{i&&void 0!==i[t]&&void 0===this[t]&&(this[t]=i[t],this[t]!==i[t]&&e&&this.doOnce(this.rebuild))};if(r("decimalPlaces"),r("baseUnit"),r("slideSpeed"),r("displayUnit"),r("decimalPlaces"),r("isInt"),r("radix"),r("step"),r("expRate"),r("stepIsRelative"),i&&void 0!==i.hasUniformSlider&&i.hasUniformSlider!==this.hasUniformSlider&&(this.hasUniformSlider=i.hasUniformSlider,this.doOnce(this.rebuild)),i&&i.range){let t=this.range[0]!==i.range[0];t=t||this.range[1]!==i.range[1],this.range[0]=i.range[0],this.range[1]=i.range[1],t&&this.doOnce(this.rebuild)}this.internalDisabled=!1;let a=e.length;if(i&&i.flag&PropFlags$3.USE_CUSTOM_GETSET){let e=this.ctx.api.resolvePath(this.ctx,t);i.ctx=this.ctx,i.dataref=e.obj,i.datapath=t,a=i.getValue().length,i.dataref=void 0}if(this.value.length!==a){switch(a){case 2:e=new Vector2$b(e);break;case 3:e=new Vector3$2(e);break;case 4:e=new Vector4$2(e);break;default:e=i.getValue().copy().load(e)}this.value=e,this.rebuild();for(let t=0;t<this.value.length;t++)this.sliders[t].setValue(e[t],!1),this.sliders[t]._redraw()}else if(this.value.vectorDistance(e)>0){this.value.load(e),this.uslider&&this.uslider.setValue(this.uniformValue,!1);for(let t=0;t<this.value.length;t++)this.sliders[t].setValue(e[t],!1),this.sliders[t]._redraw()}}update(){if(super.update(),this.updateDataPath(),this.stepIsRelative)for(let t of this.sliders)t.step=ToolProperty$1.calcRelativeStep(this.step,t.value);this.uslider&&(this.uslider.step=this.step,this.stepIsRelative&&(this.uslider.step=ToolProperty$1.calcRelativeStep(this.step,this.uniformValue)))}static define(){return{tagname:"vector-panel-x"}}}UIBase$f.internalRegister(VectorPanel);class ToolTip extends UIBase$f{constructor(){super(),this.visibleToPick=!1,this.div=document.createElement("div"),this.shadow.appendChild(this.div),this._start_time=void 0,this.timeout=void 0}static show(t,e,i,s){let r=UIBase$f.createElement(this.define().tagname);r._start_time=time_ms(),r.timeout=r.getDefault("timeout"),r.text=t;let a=r._estimateSize();a=[a[0]+5,a[1]+5],console.log(a),i=Math.min(Math.max(i,0),e.size[0]-a[0]),s=Math.min(Math.max(s,0),e.size[1]-a[1]);let n=UIBase$f.getDPI();return i+=10/n,s+=15/n,r._popup=e.popup(r,i,s),r._popup.background="rgba(0,0,0,0)",r._popup.style.border="none",r.div.style.padding="15px",r._popup.add(r),r}end(){this._popup.end()}init(){super.init(),this.setCSS()}set text(t){this.div.innerHTML=t.replace(/[\n]/g,"<br>\n")}get text(){return this.div.innerHTML}_estimateSize(){let t=measureTextBlock(this,this.div.textContent,void 0,void 0,void 0,this.getDefault("ToolTipText"));return[t.width+50,t.height+30]}update(){super.update(),time_ms()-this._start_time>this.timeout&&this.end()}setCSS(){super.setCSS();let t=this.getDefault("background-color"),e=this.getDefault("border-color");this.background=t;let i=this.getDefault("border-radius",void 0,5),s=this.getDefault("border-style",void 0,"solid"),r=this.getDefault("border-width",void 0,1),a=this.getDefault("padding",void 0,15);this.noMarginsOrPadding(),this.div.style.padding=a+"px",this.div.style["background-color"]="rgba(0,0,0,0)",this.div.style.border=`${r}px ${s} ${e}`,this.div.style["border-radius"]=i+"px",this.style["border-radius"]=i+"px";let n=this.getDefault("ToolTipText");this.div.style.color=n.color,this.div.style.font=n.genCSS()}static define(){return{tagname:"tool-tip-x",style:"tooltip"}}}UIBase$f.internalRegister(ToolTip),window._ToolTip=ToolTip;let toolstack_getter=function(){throw new Error("must pass a toolstack getter to registerToolStackGetter")};function registerToolStackGetter$1(t){toolstack_getter=t}let Vector2$7=Vector2$b,Vector3$1=Vector3$2,UndoFlags=UndoFlags$1,ToolFlags=ToolFlags$1;class ToolBase extends ToolOp{constructor(t){super(),this.screen=t,this._finished=!1}start(t,e){this.modalStart(void 0,t,e)}cancel(){this.finish()}finish(){this._finished=!0,this.popModal(this.screen)}popModal(){this.overdraw.end(),popModalLight(this.modaldata),this.modaldata=void 0}modalStart(t,e,i){this.ctx=t,void 0!==this.modaldata&&(console.log("Error, modaldata was not undefined"),popModalLight(this.modaldata)),this.overdraw=UIBase$f.createElement("overdraw-x"),this.overdraw.start(this.screen);let s={},r=Object.getOwnPropertyNames(this);for(let t in this.__proto__)r.push(t);for(let t of Object.getOwnPropertyNames(this.__proto__))r.push(t);for(let t in this)r.push(t);for(let t of r)t.startsWith("on")&&(s[t]=this[t].bind(this));void 0!==i?(s.on_pointerdown=s.on_pointerdown??s.on_mousedown,s.on_pointermove=s.on_pointermove??s.on_mousemove,s.on_pointerup=s.on_pointerup??s.on_mouseup,s.on_pointercancel=s.on_pointercancel??s.on_pointerup??s.on_mouseup,this.modaldata=pushPointerModal(s,e,i)):this.modaldata=pushModalLight(s)}on_pointermove(t){}on_pointerup(t){this.finish()}on_keydown(t){switch(console.log("s",t.keyCode),t.keyCode){case keymap$4.Escape:this.cancel();break;case keymap$4.Space:case keymap$4.Enter:this.finish()}}}class AreaResizeTool extends ToolBase{constructor(t,e,i){if(void 0===t&&(t=_appstate.screen),super(t),this.start_mpos=new Vector2$7(i),this.sarea=e.sareas[0],!this.sarea||e.dead)throw console.log(e.dead,e),new Error("border corruption");this.screen=t,this.side=this.sarea._side(e)}get border(){return this.sarea._borders[this.side]}static tooldef(){return{uiname:"Resize Area",toolpath:"screen.area.resize",icon:Icons$2.RESIZE,description:"change size of area",is_modal:!0,undoflag:UndoFlags.NO_UNDO,flag:0,inputs:{},outputs:{}}}getBorders(){let t=this.border.horiz,e=[],i=new Set,s=r=>{if(!i.has(r._id)){i.add(r._id);for(let a of r.borders)a.horiz!=t||i.has(a._id)||(i.add(a._id),e.push(a),s(a.otherVertex(r)))}};return s(this.border.v1),s(this.border.v2),e}on_pointerup(t){this.finish()}finish(){super.finish(),this.screen.snapScreenVerts(),this.screen.regenBorders(),this.screen.snapScreenVerts(),this.screen.loadFromVerts()}on_keydown(t){switch(t.keyCode){case keymap$4.Escape:case keymap$4.Enter:case keymap$4.Space:this.finish()}}on_pointermove(t){let e=new Vector2$7([t.x,t.y]);e.sub(this.start_mpos);let i=this.border.horiz?1:0;this.overdraw.clear();new Set;let s=this.getBorders(),r=exports.DEBUG.screenborders?"rgba(1.0, 0.5, 0.0, 0.1)":"rgba(1.0, 0.5, 0.0, 1.0)",a=!1;for(let t of s)a=a||!this.screen.isBorderMovable(t),t.oldv1=new Vector2$7(t.v1),t.oldv2=new Vector2$7(t.v2);if(a)return void console.log("border is not movable");let n=()=>{let t=0;for(let e of this.screen.sareas)(e.size[0]<15||e.size[1]<15)&&t++;return t},o=n(),l=!0,h=e[i],c=this.border;this.screen.moveBorder(c,h,!1);for(let t of s)t.outer&&(l=!1),this.overdraw.line(t.v1,t.v2,r);if(this.start_mpos[0]=t.x,this.start_mpos[1]=t.y,this.screen.loadFromVerts(),this.screen.setCSS(),n()!=o){console.log("bad");for(let t of s)t.v1.load(t.oldv1),t.v2.load(t.oldv2)}this.screen.snapScreenVerts(l),this.screen.loadFromVerts(),this.screen.solveAreaConstraints(l),this.screen.setCSS(),this.screen.updateDebugBoxes(),this.screen._fireResizeCB()}}class SplitTool extends ToolBase{constructor(t){void 0===t&&(t=_appstate.screen),super(t),this.done=!1,this.screen=t,this.ctx=t.ctx,this.sarea=void 0,this.t=void 0,this.started=!1}static tooldef(){return{uiname:"Split Area",toolpath:"screen.area.split",icon:Icons$2.SMALL_PLUS,description:"split an area in two",is_modal:!0,undoflag:UndoFlags.NO_UNDO,flag:0,inputs:{},outputs:{}}}modalStart(t){this.started?console.trace("double call to modalStart()"):(this.overdraw=UIBase$f.createElement("overdraw-x"),this.overdraw.start(this.screen),super.modalStart(t))}cancel(){return this.finish(!0)}finish(t=!1){if(this.done)return;if(this.done=!0,this.overdraw.end(),this.popModal(this.screen),t||!this.sarea)return;let e=this.sarea,i=this.screen,s=this.t;i.splitArea(e,s,this.horiz),i._internalRegenAll()}on_pointermove(t){let e=t.x,i=t.y,s=this.screen.findScreenArea(e,i);if(this.overdraw.clear(),void 0!==s){e=(e-s.pos[0])/s.size[0],i=(i-s.pos[1])/s.size[1];let r=1-Math.abs(e-.5),a=1-Math.abs(i-.5);this.sarea=s,(this.horiz=r<a)?(this.t=i,this.overdraw.line([s.pos[0],t.y],[s.pos[0]+s.size[0],t.y])):(this.t=e,this.overdraw.line([t.x,s.pos[1]],[t.x,s.pos[1]+s.size[1]]))}}on_pointerdown(t){this.finish(),t.button&&(this.stopPropagation(),this.preventDefault())}on_keydown(t){switch(t.keyCode){case keymap$4.Escape:this.cancel();break;case keymap$4.Space:case keymap$4.Enter:this.finish()}}}class RemoveAreaTool extends ToolBase{constructor(t,e){void 0===t&&(t=_appstate.screen),super(t),this.border=e,this.done=!1,this.screen=t,this.ctx=t.ctx,this.sarea=void 0,this.t=void 0,this.started=!1}static tooldef(){return{uiname:"Remove Area",toolpath:"screen.area.pick_remove",icon:Icons$2.SMALL_PLUS,description:"Collapse a window",is_modal:!0,undoflag:UndoFlags.NO_UNDO,flag:0,inputs:{},outputs:{}}}modalStart(t){this.started?console.trace("double call to modalStart()"):(this.overdraw=UIBase$f.createElement("overdraw-x"),this.overdraw.start(this.screen),super.modalStart(t))}cancel(){return this.finish(!0)}finish(t=!1){if(this.done)return;if(this.done=!0,this.overdraw.end(),this.popModal(this.screen),t||!this.sarea)return;let e=this.sarea,i=this.screen;this.t;e&&(i.collapseArea(e,this.border),i._internalRegenAll())}on_pointermove(t){let e=t.x,i=t.y,s=this.screen.findScreenArea(e,i);this.overdraw.clear(),void 0!==s&&(this.sarea=s,this.overdraw.rect(s.pos,s.size,"rgba(0,0,0,0.1)"))}on_pointerdown(t){this.finish(),t.button&&(this.stopPropagation(),this.preventDefault())}on_keydown(t){switch(console.log("s",t.keyCode),t.keyCode){case keymap$4.Escape:this.cancel();break;case keymap$4.Space:case keymap$4.Enter:this.finish()}}}class AreaDragTool extends ToolBase{constructor(t,e,i){void 0===t&&(t=_appstate.screen),super(t),this.dropArea=!1,this.excludeAreas=new Set,this.cursorbox=void 0,this.boxes=[],this.boxes.active=void 0,this.sarea=e,this.start_mpos=new Vector2$7(i),this.screen=t}static tooldef(){return{uiname:"Drag Area",toolpath:"screen.area.drag",icon:Icons$2.TRANSLATE,description:"move or duplicate area",is_modal:!0,undoflag:UndoFlags.NO_UNDO,flag:0,inputs:{},outputs:{}}}finish(){super.finish(),this.screen.regenBorders(),this.screen.solveAreaConstraints(),this.screen.snapScreenVerts(),this.screen._recalcAABB()}getBoxRect(t){let e,i,s=t.sarea;-1==t.horiz?(e=s.pos,i=s.size):t.horiz?"b"==t.side?(e=[s.pos[0],s.pos[1]+s.size[1]*t.t],i=[s.size[0],s.size[1]*(1-t.t)]):(e=[s.pos[0],s.pos[1]],i=[s.size[0],s.size[1]*t.t]):"r"==t.side?(e=[s.pos[0]+s.size[0]*t.t,s.pos[1]],i=[s.size[0]*(1-t.t),s.size[1]]):(e=[s.pos[0],s.pos[1]],i=[s.size[0]*t.t,s.size[1]]);let r=this.overdraw.rect(e,i,"rgba(100, 100, 100, 0.2)");return r.style["pointer-events"]="none",r}doSplit(t){if(this.sarea)return this.doSplitDrop(t);this.sarea;let e=t.sarea,i=this.screen,s=t.t;i.splitArea(e,s,t.horiz),i._internalRegenAll()}doSplitDrop(t){if(-1===t.horiz&&t.sarea===this.sarea)return;let e=!1,i=this.sarea,s=this.screen;e=i.size[0]===s.size[0]||i.size[1]===s.size[1],e=e||this.sarea.floating,e=e&&t.sarea!==i,e=e&&(-1===t.horiz||!s.areasBorder(i,t.sarea));let r=-1===t.horiz&&t.sarea!==i&&s.areasBorder(t.sarea,i);if(e=e||r,console.log("can_rip:",e,r),e&&(s.removeArea(i),s.snapScreenVerts()),-1===t.horiz){let i=this.sarea,a=t.sarea;if(e&&i!==a){let t;if(r&&(t=s.minmaxArea(i),s.minmaxArea(a,t)),console.log("replacing. . .",r),i.floating){let t=a.editors;a.editors=[],a.editormap={},a.area&&!(a.area.constructor.define().areaname in i.editormap)&&(a.area.push_ctx_active(),a.area.on_area_inactive(),a.area.remove(),a.area.pop_ctx_active());for(let e of t){let t=e.constructor.define(),s=!1;for(let t of i.editors)if(e.constructor===t.constructor){s=!0;break}s||(a.editors.push(e),a.editormap[t.areaname]=e)}for(let t of i.editors){let e=t.constructor.define();a.editormap[e.areaname]=t,a.editors.push(t),t.owning_sarea&&(t.owning_sarea=a),t.parentWidget&&(t.parentWidget=a)}if(exports.useAreaTabSwitcher)for(let t of a.editors)t.switcher&&t.switcher.flagUpdate();return a.area=i.area,a.shadow.appendChild(i.area),i.area=void 0,i.editors=[],i.editormap={},a.on_resize(a.size,a.size),a.flushSetCSS(),a.flushUpdate(),s.removeArea(i),void s.snapScreenVerts()}s.replaceArea(a,i),r&&(console.log("\nEXPANDING:",i.size[0],i.size[1]),i.pos[0]=t.min[0],i.pos[1]=t.min[1],i.size[0]=t.max[0]-t.min[0],i.size[1]=t.max[1]-t.min[1],i.loadFromPosSize(),s._internalRegenAll())}else s.replaceArea(a,i.copy()),s._internalRegenAll()}else{let i=this.sarea,r=t.sarea,a=t.t,n=s.splitArea(r,a,t.horiz);"l"!==t.side&&"t"!==t.side||(n=r),e?s.replaceArea(n,i):s.replaceArea(n,i.copy()),s._internalRegenAll()}}makeBoxes(t){let e=isMobile()?100:40,i=t.pos[0]+.5*t.size[0],s=t.pos[1]+.5*t.size[1],r=this.color="rgba(200, 200, 200, 0.55)",a=this.hcolor="rgba(230, 230, 230, 0.75)",n=0,o=this.boxes,l=(e,i,s,l,h,c)=>{let d=this.overdraw.rect([e-.5*s[0],i-.5*s[1]],s,r);d.style["border-radius"]="14px",o.push(d),d.sarea=t;let u=document.createElement("style"),p="mybox_"+n++;d.horiz=l,d.t=h,d.side=c,d.setAttribute("class",p),d.setAttribute("is_box",!0),d.addEventListener("pointermove",this.on_pointermove.bind(this));let m=d.onclick=t=>{t.type.toLowerCase();("pointerdown"!==t.type&&"pointerup"!==t.type||0===t.button)&&(console.log("split click"),this._finished||(this.finish(),this.doSplit(d),t.preventDefault(),t.stopPropagation()))};return d.addEventListener("click",m),d.addEventListener("pointerdown",m),d.addEventListener("pointerup",m),d.addEventListener("pointerenter",(t=>{void 0!==this.curbox&&this.curbox.rect&&(this.curbox.rect.remove(),this.curbox.rect=void 0),void 0!==d.rect&&(d.rect.remove(),d.rect=void 0),d.rect=this.getBoxRect(d),this.curbox=d,d.setColor(a)})),d.addEventListener("pointerleave",(t=>{d.rect&&(d.rect.remove(),d.rect=void 0),this.curbox===d&&(this.curbox=void 0),d.setColor(r)})),u.textContent=`\n        .${p}:hover {\n          background-color : orange;\n          fill:orange;stroke-width:2\n        }\n      `,d.appendChild(u),d.setAttribute("class",p),d};this.sarea&&l(i,s,[e,e],-1,-1,-1),l(i-.75*e-5,s,[.5*e,e],!1,.5,"l"),l(i-1.2*e-5,s,[.25*e,e],!1,.3,"l"),l(i+.75*e+5,s,[.5*e,e],!1,.5,"r"),l(i+1.2*e+5,s,[.25*e,e],!1,.7,"r"),l(i,s-.75*e-5,[e,.5*e],!0,.5,"t"),l(i,s-1.2*e-5,[e,.25*e],!0,.3,"t"),l(i,s+.75*e+5,[e,.5*e],!0,.5,"b"),l(i,s+1.2*e+5,[e,.25*e],!0,.7,"b")}getActiveBox(t,e){for(let i of this.boxes)if(i.hasAttribute&&i.hasAttribute("is_box")){let s=i.getClientRects()[0];if(t>=s.x&&e>=s.y&&t<s.x+s.width&&e<s.y+s.height)return i}}on_drag(t){this.on_pointermove(t)}on_dragend(t){this.on_pointerup(t)}on_pointermove(t){let e=55,i=this.getActiveBox(t.x,t.y);void 0!==i&&i.setColor(this.hcolor),void 0!==this.boxes.active&&this.boxes.active!==i&&(this.boxes.active.setColor(this.color),this.boxes.active.dispatchEvent(new PointerEvent("pointerleave",t))),void 0!==i&&i.dispatchEvent(new PointerEvent("pointerenter",t)),this.boxes.active=i,void 0!==this.sarea&&(void 0===this.cursorbox?(e=25,this.cursorbox=this.overdraw.rect([t.x-.5*e,t.y-.5*e],[e,e],"rgb(200, 200, 200, 0.7)"),this.cursorbox.style["pointer-events"]="none"):(this.cursorbox.style.x=t.x-.5*e+"px",this.cursorbox.style.y=t.y-.5*e+"px"))}on_pointerup(t){if(console.log("e.button",t.button,t,t.x,t.y,this.getActiveBox(t.x,t.y)),t.button)t.stopPropagation(),t.preventDefault();else{let e=this.getActiveBox(t.x,t.y);void 0!==e&&e.onclick(t)}this.finish()}modalStart(t){super.modalStart(...arguments);let e=this.screen;if(this.overdraw.clear(),this.sarea&&!this.excludeAreas.has(this.sarea)){let t=this.sarea;this.overdraw.rect(t.pos,t.size,"rgba(100, 100, 100, 0.5)").style["pointer-events"]="none"}for(let t of e.sareas)this.excludeAreas.has(t)||this.makeBoxes(t)}on_keydown(t){switch(t.keyCode){case keymap$4.Escape:case keymap$4.Enter:case keymap$4.Space:this.finish()}}}class AreaMoveAttachTool extends AreaDragTool{constructor(t,e,i){super(t,e,i),this.excludeAreas=new Set([e]),this.dropArea=!0,this.first=!0,this.sarea=e,this.mpos=new Vector2$7(i),this.start_mpos2=new Vector2$7(i),this.start_pos=new Vector2$7(e.pos)}on_pointermove(t){let e=t.x-this.start_mpos2[0],i=t.y-this.start_mpos2[1],s=this.sarea;if(this.first)return this.start_mpos2=new Vector2$7([t.x,t.y]),void(this.first=!1);s.pos[0]=this.start_pos[0]+e,s.pos[1]=this.start_pos[1]+i,s.loadFromPosSize(),this.mpos.loadXY(t.x,t.y),super.on_pointermove(t)}on_pointerup(t){super.on_pointerup(t)}on_pointerdown(t){super.on_pointerdown(t)}on_keydown(t){super.on_keydown(t)}}class ToolTipViewer extends ToolBase{constructor(t){super(t),this.tooltip=void 0,this.element=void 0}static tooldef(){return{uiname:"Help Tool",toolpath:"screen.help_picker",icon:Icons$2.HELP,description:"view tooltips",is_modal:!0,undoflag:UndoFlags.NO_UNDO,flag:0,inputs:{},outputs:{}}}on_pointermove(t){this.pick(t)}on_pointerdown(t){this.pick(t)}on_pointerup(t){this.finish()}finish(){super.finish()}on_keydown(t){switch(t.keyCode){case keymap$4.Escape:case keymap$4.Enter:case Keymap.Space:this.tooltip&&this.tooltip.end(),this.finish()}}pick(t){let e=t.x,i=t.y,s=this.screen.pickElement(e,i);if(console.log(s?s.tagName:s),void 0!==s&&s!==this.element&&s.title){this.tooltip&&this.tooltip.end(),this.element=s;let t=s.title;this.tooltip=ToolTip.show(t,this.screen,e,i)}t.preventDefault(),t.stopPropagation()}}const AreaFlags={HIDDEN:1,FLOATING:2,INDEPENDENT:4,NO_SWITCHER:8,NO_HEADER_CONTEXT_MENU:16,NO_COLLAPSE:32};let SnapLimit=1;const BORDER_ZINDEX_BASE=25;function snap(t,e=SnapLimit){if(Array.isArray(t))for(let i=0;i<t.length;i++)t[i]=Math.floor(t[i]/e)*e;else t=Math.floor(t/e)*e;return t}function snapi(t,e=SnapLimit){if(Array.isArray(t))for(let i=0;i<t.length;i++)t[i]=Math.ceil(t[i]/e)*e;else t=Math.ceil(t/e)*e;return t}class ScreenVert extends Vector2$b{constructor(t,e,i){super(t),this.added_id=i,this.sareas=[],this.borders=[],this._id=e}static hash(t,e,i){return snap(t[0],i)+":"+snap(t[1],i)+": + added_id"}valueOf(){return ScreenVert.hash(this,this.added_id)}[Symbol.keystr](){return ScreenVert.hash(this,this.added_id)}loadSTRUCT(t){t(this)}}ScreenVert.STRUCT="\npathux.ScreenVert {\n  0 : float;\n  1 : float;\n}\n",nstructjs.register(ScreenVert);class ScreenHalfEdge{constructor(t,e){this.sarea=e,this.border=t,this.side=e._side(t)}get v1(){return this.border.v1}get v2(){return this.border.v2}[Symbol.keystr](){return this.sarea._id+":"+this.border._id}}class ScreenBorder extends UIBase$f{constructor(){super(),this.visibleToPick=!1,this.screen=void 0,this.v1=void 0,this.v2=void 0,this._id=void 0,this._hash=void 0,this.outer=void 0,this.halfedges=[],this.sareas=[],this._innerstyle=document.createElement("style"),this._style=void 0,this.shadow.appendChild(this._innerstyle),this.inner=document.createElement("div"),this.shadow.appendChild(this.inner);let t=ScreenBorder.bindBorderMenu(this);this.addEventListener("pointerdown",(e=>{let i=this.movable;2!==e.button?i?(new AreaResizeTool(this.screen,this,[e.x,e.y]).start(),e.preventDefault(),e.stopPropagation()):console.log("border is not movable"):t(e)}),{capture:!0})}static bindBorderMenu(t,e=!1){let i=i=>{if(e&&t.pickElement(i.x,i.y)!==t)return;let s=[["Split Area",()=>{t.ctx.screen.splitTool()}],Menu.SEP,["Collapse Area",()=>{console.log("Collapse Area!"),t.ctx.screen.removeAreaTool(t instanceof ScreenBorder?t:void 0)}]];s=createMenu(t.ctx,"",s),s.ignoreFirstClick=2,t.ctx.screen.popupMenu(s,i.x-15,i.y-15),i.preventDefault(),i.stopPropagation()};return t.addEventListener("contextmenu",(t=>t.preventDefault())),t.addEventListener("dblclick",i,{capture:!0}),i}getOtherSarea(t){console.log(this.halfedges,this.halfedges.length);for(let e of this.halfedges){console.log(e);let i=e.sarea!==t;if(i=i&&e.sarea._verts.indexOf(this.v1)>=0,i=i&&e.sarea._verts.indexOf(this.v2)>=0,i)return e.sarea}}get locked(){for(let t of this.sareas){let e=1<<t._borders.indexOf(this);if(t.borderLock&e||t.flag&AreaFlags.NO_COLLAPSE)return!0}return!1}get dead(){return!this.parentNode}get side(){throw new Error("side accedd")}set side(t){throw new Error("side accedd")}get valence(){let t=0,e=this.horiz,i={};for(let s=0;s<2;s++){let r=s?this.v2:this.v1;for(let s of r.borders){if(s.horiz!=this.horiz)continue;if(s._id in i)continue;i[s._id]=1;let r,a=Math.min(this.v1[0],this.v2[0]),n=Math.min(this.v1[1],this.v2[1]),o=Math.max(this.v1[0],this.v2[0]),l=Math.max(this.v1[1],this.v2[1]),h=(Math.min(s.v1[0],s.v2[0]),Math.min(s.v1[1],s.v2[1]),Math.min(s.v1[0],s.v2[0])),c=Math.min(s.v1[1],s.v2[1]),d=.001;r=e?n<=c+d&&l>=n-d:a<=h+d&&o>=a-d,r&&(t+=s.sareas.length)}}return t}get horiz(){let t=this.v2[0]-this.v1[0],e=this.v2[1]-this.v1[1];return Math.abs(t)>Math.abs(e)}static hash(t,e){return Math.min(t._id,e._id)+":"+Math.max(t._id,e._id)}static define(){return{tagname:"screenborder-x",style:"screenborder"}}otherVertex(t){return t===this.v1?this.v2:this.v1}setCSS(){this.style["pointer-events"]=this.movable?"auto":"none",void 0===this._style&&(this._style=document.createElement("style"),this.appendChild(this._style));let t,e,i,s,r=UIBase$f.getDPI(),a=this.getDefault("mouse-threshold")/r,n=this.getDefault("border-width"),o=this.v1,l=this.v2,h=new Vector2$b(l).sub(o),c=Math.min(o[0],l[0]),d=Math.min(o[1],l[1]);this.style.display="flex",this.style.display=this.horiz?"row":"column",this.style["justify-content"]="center",this.style["align-items"]="center",this.horiz?(this.style["padding-top"]=this.style["padding-bottom"]=a+"px",d-=.5*n+a,t=Math.abs(h[0]),e=n,i="n-resize",s="border-top-style : solid;\n    border-bottom-style : solid;\n"):(this.style["padding-left"]=this.style["padding-right"]=a+"px",c-=.5*n+a,t=2*n,e=Math.abs(h[1]),i="e-resize",s="border-left-style : solid;\n    border-right-style : solid;\n",s="border-top-style : none;\n    border-bottom-style : none;\n");let u=this.getDefault("border-outer"),p=exports.DEBUG.screenborders;if(p){n=4;let t=1,e=(this.sareas.length,0),i=0,s=0;this.movable&&(s=255),this.halfedges.length>1&&(i=255),this.outer&&(e=255),u=`rgba(${e}, ${i}, ${s}, ${t})`}let m=`\n        .screenborder_inner_${this._id} {\n          ${s}\n          ${this.horiz?"height":"width"} : ${n}px;\n          ${this.horiz?"width":"height"} : 100%;\n          margin : 0px;\n          padding : 0px;\n          \n          background-color : ${this.getDefault("border-inner")};\n          border-color : ${u};\n          border-width : ${.5*n}px;\n          border-style : ${p&&this.outer?"dashed":"solid"};\n          pointer-events : none;\n        }`,f=`\n        .screenborder_${this._id} {\n        }\n    `,g=this.movable;if(!this.outer)for(let t of this.sareas)g=g||t.floating;g&&(f+=`\n        .screenborder_${this._id}:hover {\n          cursor : ${i};\n        }\n      `),this._style.textContent=f,this._innerstyle.textContent=m,this.setAttribute("class","screenborder_"+this._id),this.inner.setAttribute("class","screenborder_inner_"+this._id),this.style.position=UIBase$f.PositionKey,this.style.left=c+"px",this.style.top=d+"px",this.style.width=t+"px",this.style.height=e+"px",this.style["z-index"]=""+BORDER_ZINDEX_BASE}valueOf(){return ScreenBorder.hash(this.v1,this.v2)}[Symbol.keystr](){return ScreenBorder.hash(this.v1,this.v2)}}let _ScreenArea;UIBase$f.internalRegister(ScreenBorder);let UIBase$7=UIBase$f,Vector2$6=Vector2$b,Screen$1;window._contextWrangler=contextWrangler;const BorderMask={LEFT:1,BOTTOM:2,RIGHT:4,TOP:8,ALL:15},BorderSides={LEFT:0,BOTTOM:1,RIGHT:2,TOP:3};class Area$1 extends UIBase$f{constructor(){super();let t=this.constructor.define();this.borderLock=t.borderLock||0,this.flag=t.flag||0,this.inactive=!0,this.areaDragToolEnabled=!0,this.owning_sarea=void 0,this._area_id=contextWrangler.idgen++,this.pos=void 0,this.size=void 0,this.minSize=[5,5],this.maxSize=[void 0,void 0];let e=this.shadow.appendChild;this.shadow.appendChild=t=>{e.call(this.shadow,t),t instanceof UIBase$7&&(t.parentWidget=this)};let i=this.shadow.prepend;this.shadow.prepend=t=>{i.call(this.shadow,t),t instanceof UIBase$7&&(t.parentWidget=this)}}get floating(){return~~(this.flag&AreaFlags.FLOATING)}set floating(t){t?this.flag|=AreaFlags.FLOATING:this.flag&=~AreaFlags.FLOATING}static getActiveArea(t){return contextWrangler.getLastArea(t)}static unregister(t){let e=t.define();if(!e.areaname)throw new Error("Missing areaname key in define()");e.areaname in areaclasses&&delete areaclasses[e.areaname]}static register(t){let e=t.define();if(!e.areaname)throw new Error("Missing areaname key in define()");areaclasses[e.areaname]=t,UIBase$f.internalRegister(t)}static makeAreasEnum(){let t={},e={};for(let i in areaclasses){let s=areaclasses[i].define();if(s.flag&AreaFlags.HIDDEN)continue;let r=s.uiname;void 0===r&&(r=i.replace("_"," ").toLowerCase(),r=r[0].toUpperCase()+r.slice(1,r.length)),t[r]=i,e[r]=void 0!==s.icon?s.icon:-1}let i=new EnumProperty$9(void 0,t);return i.addIcons(e),i}static define(){return{tagname:"pathux-editor-x",areaname:void 0,flag:0,uiname:void 0,icon:void 0}}static newSTRUCT(){return UIBase$7.createElement(this.define().tagname)}init(){super.init(),this.style.overflow="hidden",this.noMarginsOrPadding();let t=t=>{this.push_ctx_active(),this.pop_ctx_active()};super.addEventListener("mouseover",t,{passive:!0}),super.addEventListener("mousemove",t,{passive:!0}),super.addEventListener("mousein",t,{passive:!0}),super.addEventListener("mouseenter",t,{passive:!0}),super.addEventListener("touchstart",t,{passive:!0}),super.addEventListener("focusin",t,{passive:!0}),super.addEventListener("focus",t,{passive:!0})}_get_v_suffix(){return this.flag&AreaFlags.INDEPENDENT?this._id:""}getKeyMaps(){return void 0!==this.keymap?[this.keymap]:[]}on_fileload(t){contextWrangler.reset()}buildDataPath(){let t=this.owning_sarea;if(void 0===t||void 0===t.screen)return console.warn("Area.buildDataPath(): Failed to build data path"),"";let e=t.screen.sareas.indexOf(t),i=t.editors.indexOf(this);if(e<0||i<0)throw new Error("malformed area data");return`screen.sareas[${e}].editors[${i}]`}saveData(){return{_area_id:this._area_id,areaName:this.areaName}}loadData(t){let e=t._area_id;null!=e&&(this._area_id=e)}draw(){}copy(){return console.warn("You might want to implement this, Area.prototype.copy based method called"),UIBase$7.createElement(this.constructor.define().tagname)}on_resize(t,e){super.on_resize(t,e)}on_area_focus(){}on_area_blur(){}on_area_active(){}on_area_inactive(){}push_ctx_active(t=!1){contextWrangler.updateLastRef(this.constructor,this),contextWrangler.push(this.constructor,this,!t)}pop_ctx_active(t=!1){contextWrangler.pop(this.constructor,this,!t)}getScreen(){throw new Error("replace me in Area.prototype")}toJSON(){return Object.assign(super.toJSON(),{areaname:this.constructor.define().areaname,_area_id:this._area_id})}loadJSON(t){return super.loadJSON(t),this._area_id=t._area_id,this}getBarHeight(){return this.header.getClientRects()[0].height}makeAreaSwitcher(t){if(exports.useAreaTabSwitcher){let e=UIBase$7.createElement("area-docker-x");return t.add(e),e}let e=Area$1.makeAreasEnum(),i=t.listenum(void 0,{name:this.constructor.define().uiname,enumDef:e,callback:t=>{let e=areaclasses[t];this.owning_sarea.switch_editor(e)}});return i.update.after((()=>{let t=this.constructor.define().uiname,s=e.values[t];i.value!==s&&s in e.keys&&(s=e.keys[s]),i.value!==s&&i.setValue(e.values[t],!0)})),i}makeHeader(t,e=!0,i=!0){let s,r,a;if(this.flag&AreaFlags.NO_SWITCHER||!exports.useAreaTabSwitcher)r=a=this.header=t.row();else{let e=this.header=t.col();s=a=e.row(),r=e.row()}if(!(this.flag&AreaFlags.NO_HEADER_CONTEXT_MENU)){let t=ScreenBorder.bindBorderMenu(this.header,!0);this.addEventListener("mousedown",(e=>{2===e.button&&this.header.pickElement(e.x,e.y)===this.header&&t(e)}))}this.header.remove(),t._prepend(this.header),r.setCSS.after((()=>r.background=this.getDefault("AreaHeaderBG")));this.getDPI();if(t.noMarginsOrPadding(),r.noMarginsOrPadding(),r.style.width="100%",r.style.margin="0px",r.style.padding="0px",this.flag&AreaFlags.NO_SWITCHER||(this.switcher?s.add(this.switcher):this.switcher=this.makeAreaSwitcher(exports.useAreaTabSwitcher?s:r)),(isMobile()||exports.addHelpPickers)&&(this.helppicker&&this.helppicker.remove(),this.helppicker=a.helppicker(),this.helppicker.iconsheet=0),e){let t=UIBase$7.createElement("noteframe-x");t.ctx=this.ctx,r._add(t)}if(exports.useAreaTabSwitcher)return r;let n=this.header,o=!1,l=new Vector2$6,h=(t,e,i)=>{if(haveModal())return;return e=void 0===e?t.x:e,i=void 0===i?t.y:i,this.getScreen().pickElement(e,i)===r};n.addEventListener("pointerout",(t=>{o=!1})),n.addEventListener("pointerleave",(t=>{o=!1})),n.addEventListener("pointerdown",(t=>{h(t)&&(l[0]=t.pageX,l[1]=t.pageY,o=!0)}));let c=time_ms(),d=(t,e,s)=>{if(haveModal()||!i)return;let r=0!==t.buttons||t.touches&&t.touches.length>0;if(r=r&&o,time_ms()-c<250)return;if(c=time_ms,!r||!h(t,e,s))return;if("mousemove"===t.type&&t.was_touch)return;let a=e-l[0],n=s-l[1];if(a*a+n*n>49){let e=this.owning_sarea;if(void 0===e)return void console.warn("Error: missing sarea ref");let i=e.screen;if(void 0===i)return void console.log("Error: missing screen ref");if(!this.areaDragToolEnabled)return;o=!1,console.log("area drag tool!",t.type,t),i.areaDragTool(this.owning_sarea)}};return n.addEventListener("pointermove",(t=>d(t,t.pageX,t.pageY)),!1),n.addEventListener("pointerup",(t=>{console.log("pointerup",t),o=!1}),!1),n.addEventListener("pointercancel",(t=>{console.log("pointercancel",t),o=!1}),!1),r}setCSS(){void 0!==this.size&&(this.style.position=UIBase$7.PositionKey,this.style.width=this.size[0]+"px",this.style.height=this.size[1]+"px")}update(){void 0!==this.owning_sarea&&this===this.owning_sarea.area&&super.update()}loadSTRUCT(t){t(this)}_isDead(){if(this.dead)return!0;let t=this.getScreen();return void 0===t||(void 0===t.parentNode||void 0)}afterSTRUCT(){let t=()=>{if(!this._isDead())if(this.ctx)try{loadUIData(this,this.saved_uidata),this.saved_uidata=void 0}catch(t){console.log("failed to load ui data"),print_stack$1(t)}else this.doOnce(t)};this.doOnce(t)}_getSavedUIData(){return saveUIData(this,"area")}}Area$1.STRUCT="\npathux.Area { \n  flag : int;\n  saved_uidata : string | obj._getSavedUIData();\n}\n",nstructjs.register(Area$1,"pathux.Area"),UIBase$f.internalRegister(Area$1);class ScreenArea extends UIBase$f{constructor(){if(super(),this._flag=void 0,this.flag=0,this._borders=[],this._verts=[],this.dead=!1,this._sarea_id=contextWrangler.idgen++,this._pos=new Vector2$6,this._size=new Vector2$6([512,512]),exports.DEBUG.screenAreaPosSizeAccesses){let t=(t,e)=>{Object.defineProperty(this[t],e,{get:function(){return this["_"+e]},set:function(i){console.warn(`ScreenArea.${t}[${e}] set:`,i),this["_"+e]=i}})};t("size",0),t("size",1),t("pos",0),t("pos",1)}this.area=void 0,this.editors=[],this.editormap={},this.addEventListener("mouseover",(t=>{if(haveModal())return;let e=this.getScreen();e.sareas.active!==this&&e.sareas.active&&e.sareas.active.area&&e.sareas.active.area.on_area_blur(),this.area&&e.sareas.active!==this&&this.area.on_area_focus(),e.sareas.active=this}))}get floating(){return this.flag&AreaFlags.FLOATING}set floating(t){t?this.flag|=AreaFlags.FLOATING:this.flag&=~AreaFlags.FLOATING}get flag(){let t=this._flag&(AreaFlags.FLOATING|AreaFlags.INDEPENDENT);return this.area&&(t|=this.area.flag),t}set flag(t){this._flag&=~(AreaFlags.FLOATING|AreaFlags.INDEPENDENT),this._flag|=t&(AreaFlags.FLOATING|AreaFlags.INDEPENDENT),this.area&&(this.area.flag|=t&~(AreaFlags.FLOATING|AreaFlags.INDEPENDENT))}get borderLock(){return void 0!==this.area?this.area.borderLock:0}get minSize(){return void 0!==this.area?this.area.minSize:this.size}get maxSize(){return void 0!==this.area?this.area.maxSize:this.size}get pos(){return this._pos}set pos(t){exports.DEBUG.screenAreaPosSizeAccesses&&console.log("ScreenArea set pos",t),this._pos.load(t)}get size(){return this._size}set size(t){exports.DEBUG.screenAreaPosSizeAccesses&&console.log("ScreenArea set size",t),this._size.load(t)}static newSTRUCT(){return UIBase$7.createElement("screenarea-x")}static define(){return{tagname:"screenarea-x"}}_get_v_suffix(){return this.area?this.area._get_v_suffix():""}bringToFront(){let t=this.getScreen();HTMLElement.prototype.remove.call(this),t.sareas.remove(this),t.appendChild(this);let e=BORDER_ZINDEX_BASE+1;t.style["z-index"]&&(e=parseInt(t.style["z-index"])+1);for(let e of t.sareas){let t=e.style["z-index"];e.style["z-index"]&&(t=Math.max(t,parseInt(e.style["z-index"])+1))}this.style["z-index"]=e}_side(t){let e=this._borders.indexOf(t);if(e<0)throw new Error("border not in screen area");return e}init(){super.init(),this.noMarginsOrPadding()}draw(){this.area&&this.area.draw&&(this.area.push_ctx_active(),this.area.draw(),this.area.pop_ctx_active())}_isDead(){if(this.dead)return!0;let t=this.getScreen();return void 0===t||(void 0===t.parentNode||void 0)}toJSON(){let t={editors:this.editors,_sarea_id:this._sarea_id,area:this.area.constructor.define().areaname,pos:this.pos,size:this.size};return Object.assign(super.toJSON(),t)}on_keydown(t){this.area.on_keydown&&(this.area.push_ctx_active(),this.area.on_keydown(t),this.area.pop_ctx_active())}loadJSON(t){if(void 0!==t){super.loadJSON(t),this.pos.load(t.pos),this.size.load(t.size);for(let e of t.editors){let i=e.areaname,s=areaclasses[i].define().tagname,r=UIBase$7.createElement(s);r.owning_sarea=this,this.editormap[i]=r,this.editors.push(this.editormap[i]),r.pos=new Vector2$6(t.pos),r.size=new Vector2$6(t.size),r.ctx=this.ctx,r.inactive=!0,r.loadJSON(e),r.owning_sarea=void 0,i===t.area&&(this.area=r)}void 0!==this.area&&(this.area.ctx=this.ctx,this.area.style.width="100%",this.area.style.height="100%",this.area.owning_sarea=this,this.area.parentWidget=this,this.area.pos=this.pos,this.area.size=this.size,this.area.inactive=!1,this.shadow.appendChild(this.area),this.area.on_area_active(),this.area.onadd()),this.setCSS()}else console.warn("undefined in loadJSON")}_ondestroy(){super._ondestroy(),this.dead=!0;for(let t of this.editors)t!==this.area&&t._ondestroy()}getScreen(){if(void 0!==this.screen)return this.screen;let t=this.parentNode,e=0;for(;t&&!(t instanceof Screen$1)&&t!==t.parentNode;)if(t=this.parentNode,e++>1e3)return void console.warn("infinite loop detected in ScreenArea.prototype.getScreen()");return t&&t instanceof Screen$1?t:void 0}copy(t){let e=UIBase$7.createElement("screenarea-x");e.screen=t,e.ctx=this.ctx,e.pos[0]=this.pos[0],e.pos[1]=this.pos[1],e.size[0]=this.size[0],e.size[1]=this.size[1];for(let t of this.editors){let i=t.copy();i.ctx=this.ctx,i.parentWidget=e,e.editors.push(i),e.editormap[i.constructor.define().areaname]=i,t===this.area&&(e.area=i)}return e.ctx=this.ctx,void 0!==e.area&&(e.area.ctx=this.ctx,e.area.pos=e.pos,e.area.size=e.size,e.area.owning_sarea=e,e.area.parentWidget=e,e.shadow.appendChild(e.area),e.area._init_done?(e.area.push_ctx_active(),e.area.on_area_active(),e.area.pop_ctx_active()):e.doOnce((()=>{this.dead||(e._init(),e.area._init(),e.area.push_ctx_active(),e.area.on_area_active(),e.area.pop_ctx_active())}))),e}snapToScreenSize(){let t=this.getScreen(),e=new Vector2$6,i=0;for(let s of this._verts)e.load(s),s[0]=Math.min(Math.max(s[0],0),t.size[0]),s[1]=Math.min(Math.max(s[1],0),t.size[1]),e.vectorDistance(s)>.1&&(i=1);i&&this.loadFromVerts()}loadFromPosSize(){if(this.floating&&this._verts.length>0){let t=this.pos,e=this.size;this._verts[0].loadXY(t[0],t[1]),this._verts[1].loadXY(t[0],t[1]+e[1]),this._verts[2].loadXY(t[0]+e[0],t[1]+e[1]),this._verts[3].loadXY(t[0]+e[0],t[1]);for(let t of this._borders)t.setCSS();return void this.setCSS()}let t=this.getScreen();if(t){for(let e of this._borders)t.freeBorder(e);return this.makeBorders(t),this.setCSS(),this}}loadFromVerts(){if(0==this._verts.length)return;let t=new Vector2$6([1e17,1e17]),e=new Vector2$6([-1e17,-1e17]);for(let i of this._verts)t.min(i),e.max(i);return this.pos[0]=t[0],this.pos[1]=t[1],this.size[0]=e[0]-t[0],this.size[1]=e[1]-t[1],this.setCSS(),this}on_resize(t,e){super.on_resize(t,e),void 0!==this.area&&this.area.on_resize(t,e)}makeBorders(t){this._borders.length=0,this._verts.length=0;let e=this.pos,i=this.size,s=[new Vector2$6([e[0],e[1]]),new Vector2$6([e[0],e[1]+i[1]]),new Vector2$6([e[0]+i[0],e[1]+i[1]]),new Vector2$6([e[0]+i[0],e[1]])],r=this.floating;for(let e=0;e<s.length;e++)s[e]=snap(s[e]),s[e]=t.getScreenVert(s[e],e,r),this._verts.push(s[e]);for(let e=0;e<s.length;e++){let i=s[e],r=s[(e+1)%s.length],a=t.getScreenBorder(this,i,r,e);for(let t=0;t<2;t++){let e=t?a.v2:a.v1;e.sareas.indexOf(this)<0&&e.sareas.push(this)}a.sareas.indexOf(this)<0&&a.sareas.push(this),this._borders.push(a),a.movable=t.isBorderMovable(a)}return this}setCSS(){this.style.position=UIBase$7.PositionKey,this.style.left=this.pos[0]+"px",this.style.top=this.pos[1]+"px",this.style.width=this.size[0]+"px",this.style.height=this.size[1]+"px",this.style.overflow="hidden",this.style.contain="layout",void 0!==this.area&&this.area.setCSS()}appendChild(t){if(t instanceof Area$1){let e=t.constructor.define(),i=this.editormap[e.areaname];i&&i!==t&&(console.warn("Warning, replacing an exising editor instance",t,i),this.area===i&&(this.area=t),i.remove(),this.editors.remove(i,!0),this.editormap[e.areaname]=t),t.ctx=this.ctx,t.pos=this.pos,t.size=this.size,this.editors.indexOf(t)<0&&this.editors.push(t),t.owning_sarea=void 0,void 0===this.area&&(this.area=t)}super.appendChild(t),t instanceof UIBase$f&&(t.parentWidget=this,t.onadd())}switch_editor(t){return this.switchEditor(t)}switchEditor(t){let e=t.define(),i=e.areaname;i in this.editormap||(this.editormap[i]=UIBase$7.createElement(e.tagname),this.editormap[i].ctx=this.ctx,this.editormap[i].parentWidget=this,this.editormap[i].owning_sarea=this,this.editormap[i].inactive=!1,this.editors.push(this.editormap[i])),this.area?(this.area.pos=new Vector2$6(this.area.pos),this.area.size=new Vector2$6(this.area.size),this.area.owning_sarea=void 0,this.area.inactive=!0,this.area.push_ctx_active(),this.area._init(),this.area.on_area_inactive(),this.area.pop_ctx_active(),this.area.remove()):this.area=void 0,this.area=this.editormap[i],this.area.inactive=!1,this.area.parentWidget=this,this.area.pos=this.pos,this.area.size=this.size,this.area.owning_sarea=this,this.area.ctx=this.ctx,this.area.packflag|=this.packflag,this.shadow.appendChild(this.area),this.area.style.width="100%",this.area.style.height="100%",this.area.push_ctx_active(),this.area._init(),this.area.on_resize(this.size,this.size),this.area.pop_ctx_active(),this.area.push_ctx_active(),this.area.on_area_active(),this.area.pop_ctx_active(),this.regenTabOrder()}_checkWrangler(){this.ctx&&contextWrangler._checkWrangler(this.ctx)}update(){if(this._checkWrangler(),super.update(),void 0!==this.area){this.area.owning_sarea=this,this.area.parentWidget=this,this.area.size=this.size,this.area.pos=this.pos;let t=this.getScreen(),e=[this.size[0],this.size[1]],i=t?t.checkAreaConstraint(this,!0):0;i&&(exports.DEBUG.areaConstraintSolver&&console.log("screen constraint solve",i,this.area.minSize,this.area.maxSize,this.area.tagName,this.size),t.solveAreaConstraints(),t.regenBorders(),this.on_resize(e)),this.area.push_ctx_active(!0)}this._forEachChildWidget((t=>{t.update()})),void 0!==this.area&&this.area.pop_ctx_active(!0)}removeChild(t){if(!(t instanceof Area$1))return super.removeChild(t);{if(t.owining_sarea=void 0,t.pos=void 0,t.size=void 0,this.area===t&&this.editors.length>1){let e=(this.editors.indexOf(t)+1)%this.editors.length;this.switchEditor(this.editors[e].constructor)}else if(this.area===t)return this.editors=[],this.editormap={},this.area=void 0,void t.remove();let e=t.constructor.define().areaname;this.editors.remove(t),delete this.editormap[e],t.parentWidget=void 0}}afterSTRUCT(){for(let t of this.editors)t.pos=this.pos,t.size=this.size,t.owning_sarea=this,t.push_ctx_active(),t._ctx=this.ctx,t.afterSTRUCT(),t.pop_ctx_active()}loadSTRUCT(t){t(this),this.pos=new Vector2$6(this.pos),this.size=new Vector2$6(this.size);let e=[];for(let t of this.editors){if(!t.constructor||!t.constructor.define||t.constructor===Area$1)continue;let i=t.constructor.define().areaname;t.inactive=!0,t.owning_sarea=void 0,this.editormap[i]=t,i===this.area&&(this.area=t),t.parentWidget=this,e.push(t)}if(this.editors=e,"object"!=typeof this.area){let t=this.editors[0];if(console.warn("Failed to find active area!",this.area),"object"!=typeof t)for(let e in areaclasses){t=areaclasses[e].define().tagname,t=UIBase$7.createElement(t);let i=t.constructor.define().areaname;this.editors.push(t),this.editormap[i]=t;break}t&&(this.area=t)}if(void 0!==this.area){this.area.style.width="100%",this.area.style.height="100%",this.area.owning_sarea=this,this.area.parentWidget=this,this.area.pos=this.pos,this.area.size=this.size,this.area.inactive=!1,this.shadow.appendChild(this.area);let t=()=>{if(!this._isDead()){if(!this.ctx&&this.parentNode)return console.log("waiting to start. . ."),void this.doOnce(t);this.area.ctx=this.ctx,this.area._init(),this.area.on_area_active(),this.area.onadd()}};this.doOnce(t)}}}function setScreenClass(t){Screen$1=t}ScreenArea.STRUCT='\npathux.ScreenArea { \n  pos      : vec2;\n  size     : vec2;\n  type     : string;\n  hidden   : bool;\n  editors  : array(abstract(pathux.Area));\n  area     : string | this.area ? this.area.constructor.define().areaname : "";\n}\n',nstructjs.register(ScreenArea,"pathux.ScreenArea"),UIBase$f.internalRegister(ScreenArea),_setAreaClass(Area$1);var ScreenArea$1=Object.freeze({__proto__:null,AreaFlags:AreaFlags,contextWrangler:contextWrangler,BorderMask:BorderMask,BorderSides:BorderSides,Area:Area$1,ScreenArea:ScreenArea,setScreenClass:setScreenClass,getAreaIntName:getAreaIntName,AreaTypes:AreaTypes,setAreaTypes:setAreaTypes,areaclasses:areaclasses,AreaWrangler:AreaWrangler});class ThemeEditor extends Container{constructor(){super(),this.categoryMap={}}static define(){return{tagname:"theme-editor-x",style:"theme-editor"}}init(){super.init(),this.build()}doFolder(t,e,i=this,s,r){let a=t.key;r||(r=[a]),s||((s=i.panel(a,void 0,void 0,t.help)).style["margin-left"]="15px");let n=s.row(),o=n.textbox(void 0,""),l=n=>{console.log("ID",n,e,t),console.log(o,o.text,o.value);let l=(o.text||"").trim();if(!l)return void console.error("Cannot have empty theme property name");"FLOAT"===n?e[l]=0:"SUBFOLDER"===n?e[l]={test:0}:"COLOR"===n?e[l]="grey":"FONT"===n?e[l]=new CSSFont:"STRING"===n&&(e[l]="");let h=saveUIData(s,"theme-panel");s.clear(),this.doFolder(t,e,i,s,r),loadUIData(s,h),s.flushUpdate(),s.flushSetCSS(),this.onchange&&this.onchange(a,l,e)},h=(n.menu("+",[{name:"Float",callback:()=>l("FLOAT")},{name:"Color",callback:()=>l("COLOR")},{name:"Subfolder",callback:()=>l("SUBFOLDER")},{name:"Font",callback:()=>l("FONT")},{name:"String",callback:()=>l("STRING")}]),s.row()),c=h.col(),d=h.col(),u=(t,e,i)=>{flagThemeUpdate(),this.onchange&&this.onchange(t,e,i),this.ctx.screen.completeSetCSS(),this.ctx.screen.completeUpdate()},p=t=>{let e=theme;for(let i=0;i<t.length;i++)e=e[t[i]];return e},m=!1,f=0,g=(e,i,r)=>{let n=f%2==0?c:d;if(!(e.toLowerCase().search("flag")>=0))if("string"==typeof i){let t=i.toLowerCase().trim();if(validateCSSColor$1(t)){let i=n.colorbutton();m=!0,f++;let s=css2color$1(t);s.length<3&&(s=[s[0],s[1],s[2],1]);try{i.setRGBA(s)}catch(i){console.warn("Failed to set color "+e,t)}i.onchange=()=>{console.log("setting '"+e+"' to "+color2css$1(i.rgba),a),p(r)[e]=color2css$1(i.rgba),u(a,e)},i.label=e}else{n.label(e);let t=n.textbox();t.onchange=()=>{p(r)[e]=t.text,u(a,e)},t.text=i}}else if("number"==typeof i){let t=n.slider(void 0,e,i,0,256,.01,!1);t.baseUnit=t.displayUnit="none",m=!0,f++,t.onchange=()=>{p(r)[e]=t.value,u(a,e)}}else if("boolean"==typeof i){let t=n.check(void 0,e);t.value=p(r)[e],t.onchange=()=>{p(r)[e]=!!t.value,u(a,e)}}else if("object"==typeof i&&i instanceof CSSFont){let t=n.panel(e);m=!0,f++;let s=s=>{t.label(s);let r=t.textbox(void 0,i[s]);r.width=r.getDefault("width"),r.onchange=function(){i[s]=this.text,u(s,e)}};s("font"),s("variant"),s("weight"),s("style");let r=t.colorbutton();r.label="color",r.setRGBA(css2color$1(i.color)),r.onchange=()=>{i.color=color2css$1(r.rgba),u(a,e)};let o=t.slider(void 0,"size",i.size);o.onchange=()=>{i.size=o.value,u(a,e)},o.setAttribute("min",1),o.setAttribute("max",100),o.baseUnit=o.displayUnit="none",t.closed=!0}else if("object"==typeof i){let a=Object.assign({},t);a.key=e;let n=r.concat(e);this.doFolder(a,i,s,void 0,n)}};for(let t in e){g(t,e[t],r)}m?s.closed=!0:s.remove()}build(){let t=saveUIData(this,"theme");this.clear();let e={};for(let t of Object.keys(theme)){let i;if(t in this.categoryMap){let e=this.categoryMap[t];"string"==typeof e&&(e={category:e,help:"",key:t}),i=e}else i={category:t,help:"",key:t};i.key||(i.key=t),i.category in e||(e[i.category]=[]),e[i.category].push(i)}function i(t,e){return(t=t.trim().toLowerCase())<(e=e.trim().toLowerCase())?-1:t===e?0:1}let s=Object.keys(e);s.sort(i);for(let t of s){let s=e[t];s.sort(((t,e)=>i(t.key,e.key)));let r=this;s.length>1&&(r=this.panel(t));for(let t of s){let e=t.key,i=theme[e];"object"==typeof i&&this.doFolder(t,i,r)}s.length>1&&(r.closed=!0)}loadUIData(this,t);for(let t=0;t<2;t++)this.flushSetCSS(),this.flushUpdate();this.ctx&&this.ctx.screen&&window.setTimeout((()=>{this.ctx.screen.completeSetCSS()}),100)}}UIBase$f.internalRegister(ThemeEditor);const sliderDomAttributes=new Set(["min","max","integer","displayUnit","baseUnit","labelOnTop","radix","step","expRate","stepIsRelative","decimalPlaces","slideSpeed","sliderDisplayExp"]);function updateSliderFromDom(t,e=t){e.loadNumConstraints(void 0,t)}const SliderDefaults={stepIsRelative:!1,expRate:1+1/3,radix:10,decimalPlaces:4,baseUnit:"none",displayUnit:"none",slideSpeed:1,step:.1,sliderDisplayExp:1};function NumberSliderBase(t=UIBase$f,e=new Set,i=SliderDefaults){return e=new Set(e),class extends t{constructor(){super();for(let t of NumberConstraints)e.has(t)||(this[t]=t in i?i[t]:void 0)}loadNumConstraints(t,e){return super.loadNumConstraints(t,e,this._redraw)}}}class NumSlider extends(NumberSliderBase(ValueButtonBase)){constructor(){super(),this._highlight=void 0,this._last_label=void 0,this.mdown=!1,this.ma=void 0,this.mpos=new Vector2$b,this.start_mpos=new Vector2$b,this._last_overarrow=!1,this._name="",this._value=0,this.expRate=SliderDefaults.expRate,this.vertical=!1,this._last_disabled=!1,this.range=[-1e17,1e17],this.isInt=!1,this.editAsBaseUnit=void 0}get value(){return this._value}set value(t){this.setValue(t)}get name(){return this.getAttribute("name")||this._name}set name(t){null==t?this.removeAttribute("name"):this.setAttribute("name",t)}static define(){return{tagname:"numslider-x",style:"numslider",parentStyle:"button",havePickClipboard:!0}}updateWidth(t=!1){let e=UIBase$f.getDPI(),i=~~(this.getDefault("width")*e);(t||i!==this._last_width)&&(this._last_width=i,this.setCSS())}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t,e=this.getPathMeta(this.ctx,this.getAttribute("datapath"));if(!e)return;t=this.hasAttribute("name")?this.getAttribute("name"):""+e.uiname;let i=!1;t!==this._name&&(this._name=t,this.setCSS(),i=!0),this.getPathValue(this.ctx,this.getAttribute("datapath"))!==this._value&&(i=!0),i&&this.loadNumConstraints(e),super.updateDataPath()}update(){!!this._last_disabled!=!!this.disabled&&(this._last_disabled=!!this.disabled,this._redraw(),this.setCSS()),this.updateWidth(),super.update(),updateSliderFromDom(this)}clipboardCopy(){console.log("Copy",""+this.value),exports.setClipboardData("value","text/plain",""+this.value)}clipboardPaste(){let t=exports.getClipboardData("text/plain");console.log("Paste",t),"object"==typeof t&&(t=t.data);let e=this.editAsBaseUnit?void 0:this.displayUnit,i=parseValue(t,this.baseUnit,e);"number"!=typeof i||isNaN(i)||this.setValue(i)}swapWithTextbox(){let t=UIBase$f.createElement("textbox-x");if(this.modalRunning&&this.popModal(),this.mdown=!1,this._pressed=!1,t.ctx=this.ctx,t._init(),t.decimalPlaces=this.decimalPlaces,t.isInt=this.isInt,t.editAsBaseUnit=this.editAsBaseUnit,this.isInt&&10!=this.radix){let e=this.value.toString(this.radix);2===this.radix?e="0b"+e:16===this.radix&&(e+="h"),t.text=e}else t.text=buildString(this.value,this.baseUnit,this.decimalPlaces,this.displayUnit);this.parentNode.insertBefore(t,this),this.hidden=!0;t.onend=e=>{if(t.remove(),this.hidden=!1,e){let e=t.text.trim();if(this.isInt&&10!==this.radix)e=parseInt(e);else{let t=this.editAsBaseUnit?void 0:this.displayUnit;e=parseValue(e,this.baseUnit,t)}isNaN(e)?(console.log("Text input error",e,t.text.trim(),this.isInt),this.flash(ErrorColors.ERROR)):(this.setValue(e),this.onchange&&this.onchange(this))}},t.focus(),t.select()}bindEvents(){let t=this.range&&this.range[0]>this.range[1]?-1:1;this.addEventListener("keydown",(e=>{switch(e.keyCode){case keymap$4.Left:case keymap$4.Down:this.setValue(this.value-5*t*this.step);break;case keymap$4.Up:case keymap$4.Right:this.setValue(this.value+5*t*this.step)}}));let e=t=>{if(t.preventDefault(),this.disabled)return this.mdown=!1,this._pressed=!1,void t.stopPropagation();t.button||(this.mdown=!0,this._pressed=!0,this._redraw(),this.overArrow(t.x,t.y)?this._on_click(t):(this.dragStart(t),t.stopPropagation()))};this._on_click=t=>{if(this.setMpos(t),this.disabled)return t.preventDefault(),void t.stopPropagation();let e;(e=this.overArrow(t.x,t.y))&&(t.shiftKey&&(e*=.1),this.setValue(this.value+e))},this.addEventListener("pointermove",(t=>{this.setMpos(t),this.mdown&&!this._modaldata&&this.mpos.vectorDistance(this.start_mpos)>13&&this.dragStart(t)})),this.addEventListener("dblclick",(t=>{if(this.setMpos(t),this.mdown=!1,this._pressed=!1,this.disabled||this.overArrow(t.x,t.y))return t.preventDefault(),void t.stopPropagation();t.preventDefault(),t.stopPropagation(),this.swapWithTextbox()})),this.addEventListener("pointerdown",(t=>{this.setMpos(t),this.disabled||e(t)}),{capture:!0}),this.addEventListener("pointerup",(t=>{this.mdown=!1,this._pressed=!1,this._redraw()})),this.addEventListener("pointerover",(t=>{this.setMpos(t),this.disabled||this._highlight||(this._highlight=!0,this._repos_canvas(),this._redraw())})),this.addEventListener("blur",(t=>{this._highlight=!1,this.mdown=!1})),this.addEventListener("pointerout",(t=>{this.setMpos(t),this.disabled||(this._highlight=!1,this.dom._background=this.getDefault("background-color"),this._repos_canvas(),this._redraw())}))}overArrow(t,e){let i,s,r=this.getBoundingClientRect();this.vertical?(i=r.height,s=r.y,t=e):(i=r.width,s=r.x),t-=s;let a=this._getArrowSize()+exports.numSliderArrowLimit,n=this.step||.01;return this.isInt&&(n=Math.max(n,1)),isNaN(n)&&(console.error("NaN step size","step:",this.step,"numslider:",this._id),this.flash("red"),n=this.isInt?1:.1),t<a?-n:t>i-a?n:0}doRange(){console.warn("Deprecated: NumSlider.prototype.doRange, use loadNumConstraints instead!"),this.loadNumConstraints()}setValue(t,e=!0,i=!0,s=!0){t=Math.min(Math.max(t,this.range[0]),this.range[1]),this._value=t,this.hasAttribute("integer")&&(this.isInt=!0),this.isInt&&(this._value=Math.floor(this._value)),s&&this.loadNumConstraints(),i&&this.ctx&&this.hasAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),this._value),e&&this.onchange&&this.onchange(this.value),this._redraw()}setMpos(t){this.mpos[0]=t.x,this.mpos[1]=t.y,this.mdown||(this.start_mpos[0]=t.x,this.start_mpos[1]=t.y);let e=this.overArrow(t.x,t.y);e!==this._last_overarrow&&(this._last_overarrow=e,this._redraw())}dragStart(t){if(this.mdown=!1,this._pressed=!0,this.disabled)return;if(this.modalRunning)return void console.log("modal already running for numslider",this);this.last_time=time_ms();let e,i=this.dom._background;this.ma=new MovingAvg(eventWasTouch(t)?8:2);let s=this.value,r=s,a=this.vertical?t.y:t.x,n=(this.vertical?t.x:t.y,0);this.dom._background=this.getDefault("BoxDepressed");let o=()=>{this.onchange&&this.onchange(this)},l={on_keydown:t=>{switch(t.keyCode){case 27:e(!0);case 13:e(!1)}t.preventDefault(),t.stopPropagation()},on_pointermove:t=>{if(this.disabled)return;t.preventDefault(),t.stopPropagation();let e=this.ma.add(this.vertical?t.y:t.x),i=e-a;if(a=e,time_ms()-this.last_time<35)return;this.last_time=time_ms(),t.shiftKey&&(i*=.1),i*=this.vertical?-1:1,n+=Math.abs(i),r+=i*this.step*.1*this.slideSpeed;let l=r-s,h=Math.sign(l),c=this.expRate;this.hasAttribute("linear")||(l=Math.pow(Math.abs(l),c)*h),this.value=s+l,this.updateWidth(),this._redraw(),o()},on_pointerup:t=>{this.setMpos(t),this.undoBreakPoint(),e(!1),t.preventDefault(),t.stopPropagation()},on_pointerout:t=>{i=this.getDefault("background-color"),t.preventDefault(),t.stopPropagation()},on_pointerover:t=>{i=this.getDefault("BoxHighlight"),t.preventDefault(),t.stopPropagation()},on_pointerdown:t=>{this.popModal()}};this.pushModal(l),e=t=>{this._pressed=!1,t&&(this.value=s,this.updateWidth(),o()),this.dom._background=i,this._redraw(),this.popModal()}}get _pressed(){return this.__pressed}set _pressed(t){t?this.__pressed=t:window.setTimeout((()=>{let t=this.__pressed;this.__pressed=!1,t&&this._redraw()}),100)}setCSS(t,e){let i,s,r=this.getDPI(),a=this.getDefault("DefaultText").size*UIBase$f.getDPI(),n=measureText(this,this._genLabel(),{size:a,font:this.getDefault("DefaultText")}).width/r;n=Math.max(n+1*this._getArrowSize(),this.getDefault("width")),n+=a,n=~~n,this.vertical?(i=this.getDefault("height"),s=n):(s=this.getDefault("height"),i=n),i=~~(i*r),s=~~(s*r),this.style.width=this.dom.style.width=i/r+"px",this.style.height=this.dom.style.height=s/r+"px",this.dom.width=i,this.dom.height=s,e||(this._repos_canvas(),this._redraw())}_repos_canvas(){}updateDefaultSize(){}updateName(t){if(!this.hasAttribute("name"))return;let e=this.getAttribute("name");(t||e!==this._name)&&(this._name=e,this.setCSS());let i=this._genLabel();i!==this._last_label&&(this._last_label=i,this.setCSS())}_genLabel(){let t,e=this.value;return void 0===e?t="error":(e=void 0===e?0:e,this.isInt&&(e=Math.floor(e)),e=buildString(e,this.baseUnit,this.decimalPlaces,this.displayUnit),t=e,this._name?t=this._name+": "+t:this.hasAttribute("name")&&(t=this.getAttribute("name")+": "+t)),t}_redraw(t){t||this.setCSS(void 0,!0);let e,i=this.g,s=this.dom,r=(this.getDPI(),this.disabled),a=!this._modaldata&&this.overArrow(this.mpos[0],this.mpos[1]),n=this._pressed&&!a;this._highlight&&n?e="highlight-pressed":this._highlight?e="highlight":n&&(e="pressed");let o=(t,i,s=e)=>"highlight-pressed"!==s||this.hasClassSubDefault(s,t,!1)?s?this.getSubDefault(s,t,void 0,i):this.getDefault(t,void 0,i):this.getSubDefault("pressed",t,void 0,i),l=o("border-radius");this.isInt&&(l*=.25);let h=o("background-color");drawRoundBox(this,this.dom,this.g,void 0,void 0,l,"fill",r?o("DisabledBG"):h),drawRoundBox(this,this.dom,this.g,void 0,void 0,l,"stroke",o(r?"DisabledBG":"border-color"));let c=o("DefaultText").size,d=this._genLabel(),u=c+this._getArrowSize(),p=this.dom.height/2;this.dom.font=void 0,i.save();let m=.5*Math.PI;this.vertical?(i.rotate(m),drawText(this,u,.5*-c,d,{canvas:this.dom,g:this.g,size:c,font:o("DefaultText")}),i.restore()):drawText(this,u,p+c/2,d,{canvas:this.dom,g:this.g,size:c,font:o("DefaultText")});let f,g,_=t=>{if((t=t.trim()).endsWith("%")){t=t.slice(0,t.length-1).trim();let e=parseFloat(t)/100,i=css2color$1(this.getDefault("background-color")),s=(i[0]+i[1]+i[2])*e;s=~~(255*s),t=`rgba(${s},${s},${s},0.95)`}return t};if(f=this.getDefault("arrow-color"),f=_(f),this._pressed&&this._highlight)g=this.getSubDefault("highlight-pressed","arrow-color",null,void 0,!1),g||(g=this.getSubDefault("pressed","arrow-color")),g||(g="33%");else if(this._pressed)g=this.getSubDefault("pressed","arrow-color","arrow-color","33%");else if(this._highlight)if(this.hasClassSubDefault("highlight","arrow-color",!1))g=this.getSubDefault("highlight","arrow-color");else{g=this.hasClassSubDefault("highlight","background-color",!1)?this.getSubDefault("highlight","background-color"):this.getDefault("BoxHighlight"),g=css2color$1(g);let t=this.getSubDefault("pressed","arrow-color",void 0,"33%");t=css2color$1(t),g.interp(t,.25),g=color2css$1(g)}else g=o("arrow-color","33%");this._pressed,g=_(g);let v=s.width,b=s.height,y=this._getArrowSize();this.vertical?(i.beginPath(),i.moveTo(.5*v,7),i.lineTo(.5*v+.5*y,7+y),i.lineTo(.5*v-.5*y,7+y),i.fillStyle=a<0?g:f,i.fill(),i.beginPath(),i.moveTo(.5*v,b-7),i.lineTo(.5*v+.5*y,b-y-7),i.lineTo(.5*v-.5*y,b-y-7),i.fillStyle=a>0?g:f,i.fill()):(i.beginPath(),i.moveTo(7,.5*b),i.lineTo(7+y,.5*b+.5*y),i.lineTo(7+y,.5*b-.5*y),i.fillStyle=a<0?g:f,i.fill(),i.beginPath(),i.moveTo(v-7,.5*b),i.lineTo(v-y-7,.5*b+.5*y),i.lineTo(v-y-7,.5*b-.5*y),i.fillStyle=a>0?g:f,i.fill()),i.fill()}_getArrowSize(){return 10*UIBase$f.getDPI()}}UIBase$f.internalRegister(NumSlider);class NumSliderSimpleBase extends(NumberSliderBase(UIBase$f)){constructor(){super(),this.baseUnit=void 0,this.displayUnit=void 0,this.editAsBaseUnit=void 0,this.sliderDisplayExp=void 0,this.canvas=document.createElement("canvas"),this.g=this.canvas.getContext("2d"),this.canvas.style["pointer-events"]="none",this.highlight=!1,this.isInt=!1,this.shadow.appendChild(this.canvas),this.range=[0,1],this.uiRange=void 0,this.step=.1,this._value=.5,this.ma=void 0,this._focus=!1,this.modal=void 0,this._last_slider_key=""}get value(){return this._value}set value(t){this.setValue(t)}static define(){return{tagname:"numslider-simple-base-x",style:"numslider_simple",parentStyle:"button"}}setValue(t,e=!0,i=!0){if(t=Math.min(Math.max(t,this.range[0]),this.range[1]),this.isInt&&(t=Math.floor(t)),this._value!==t&&(this._value=t,this._redraw(),this.onchange&&e&&this.onchange(t),i&&this.getAttribute("datapath"))){let t=this.getAttribute("datapath");this.setPathValue(this.ctx,t,this._value)}}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getAttribute("datapath");if(!t||"null"===t||"undefined"===t)return;let e=this.getPathValue(this.ctx,t);if(this.isInt&&(e=Math.floor(e)),e!==this._value){let i=this.getPathMeta(this.ctx,t);if(!i)return;this.loadNumConstraints(i),this.setValue(e,!0,!1)}}_setFromMouse(t){let e=this.getClientRects()[0];if(void 0===e)return;let i=t.x-e.left,s=UIBase$f.getDPI(),r=(this._getButtonPos(),this._invertButtonX(i*s));this.value=r}_startModal(t){if(this.disabled)return;void 0!==t&&this._setFromMouse(t);let e;window;if(this.modal)return void console.warn("Double call to _startModal!");this.ma=new MovingAvg(eventWasTouch(t)?4:2);let i=()=>{void 0!==e&&(this.popModal(),e=void 0)};function s(t){return e=>(e.stopPropagation(),e.preventDefault(),t(e))}e={pointermove:t=>{let e=t.x,i=t.y;e=this.ma.add(e);new MouseEvent(t,{x:e,y:i});this._setFromMouse(t)},pointerover:t=>{},pointerout:t=>{},pointerleave:t=>{},pointerenter:t=>{},blur:t=>{},focus:t=>{},pointerup:t=>{this.undoBreakPoint(),i()},keydown:t=>{switch(t.keyCode){case keymap$4.Enter:case keymap$4.Space:case keymap$4.Escape:i()}}};for(let t in e)e[t]=s(e[t]);this.pushModal(e)}init(){super.init(),this.hasAttribute("tab-index")||this.setAttribute("tab-index",0),this.updateSize(),this.addEventListener("keydown",(t=>{let e=this.range[1]>this.range[0]?1:-1;switch(t.keyCode){case keymap$4.Left:case keymap$4.Right:let i=this.step;t.shiftKey&&(i*=.1),this.isInt&&(i=Math.max(i,1)),this.value+=t.keyCode===keymap$4.Left?-e*i:e*i}})),this.addEventListener("focusin",(()=>{this.disabled||(this._focus=1,this._redraw(),this.focus())})),this.addEventListener("pointerdown",(t=>{this.disabled||(t.preventDefault(),this._startModal(t))})),this.addEventListener("pointerin",(t=>{this.setHighlight(t),this._redraw()})),this.addEventListener("pointerout",(t=>{this.highlight=!1,this._redraw()})),this.addEventListener("pointerover",(t=>{this.setHighlight(t),this._redraw()})),this.addEventListener("pointermove",(t=>{this.setHighlight(t),this._redraw()})),this.addEventListener("pointerleave",(t=>{this.highlight=!1,this._redraw()})),this.addEventListener("blur",(t=>{this._focus=0,this.highlight=!1,this._redraw()})),this.setCSS()}setHighlight(t){this.highlight=this.isOverButton(t)?2:1}_redraw(){let t=this.g,e=this.canvas,i=e.width,s=e.height,r=UIBase$f.getDPI(),a=this.getDefault("background-color"),n=~~(this.getDefault("SlideHeight")*r+.5);t.clearRect(0,0,e.width,e.height),t.fillStyle=a;let o=.5*(s-n),l=this.getDefault("border-radius");t.translate(0,o),drawRoundBox(this,this.canvas,t,i,n,l,"fill",a,void 0,!0);let h=this.getDefault("border-color");if(drawRoundBox(this,this.canvas,t,i,n,l,"stroke",h,void 0,!0),t.translate(0,-o),this.sliderDisplayExp&&1!==this.sliderDisplayExp){t.strokeStyle=this.getDefault("SliderDivColor")||this.getDefault("border-color")||"grey";let e=8,r=0,a=1/(e-1);t.beginPath();for(let n=0;n<e;n++,r+=a){let e=Math.pow(r,this.sliderDisplayExp)*i;t.moveTo(e,o),t.lineTo(e,s-o)}t.stroke()}a=1===this.highlight?this.getDefault("BoxHighlight"):this.getDefault("border-color");let c=this._getButtonPos();t.beginPath(),a=2===this.highlight?this.getDefault("BoxHighlight"):this.getDefault("border-color"),t.arc(c[0],c[1],Math.abs(c[2]),-Math.PI,Math.PI),t.fill(),t.strokeStyle=a,t.stroke(),t.beginPath(),t.setLineDash([4,4]),this._focus&&(t.strokeStyle=this.getDefault("BoxHighlight"),t.arc(c[0],c[1],c[2]-4,-Math.PI,Math.PI),t.stroke()),t.setLineDash([])}isOverButton(t){let e=t.x,i=t.y,s=this.getClientRects()[0];if(!s)return!1;e-=s.left,i-=s.top;let r=this._getButtonPos(),a=UIBase$f.getDPI();return new Vector2$b([r[0]/a-e,r[1]/a-i]).vectorLength()<r[2]/a}_invertButtonX(t){let e=this.canvas.width,i=UIBase$f.getDPI(),s=(this.getDefault("SlideHeight"),this.canvas.height-4),r=e-s,a=this.uiRange||this.range;return t=(t-.5*s)/r,this.sliderDisplayExp&&(t=Math.max(t,0),t=Math.pow(t,1/this.sliderDisplayExp)),t=t*(a[1]-a[0])+a[0]}_getButtonPos(){let t=this.canvas.width,e=UIBase$f.getDPI(),i=(this.getDefault("SlideHeight"),this._value),s=this.uiRange||this.range;i=(i-s[0])/(s[1]-s[0]),this.sliderDisplayExp&&(i=Math.pow(i,this.sliderDisplayExp));let r=this.canvas.height-4;return i=i*(t-r)+.5*r,[i,.5*r,.5*r]}setCSS(){const t=UIBase$f.getDPI();this.style["min-width"]=this.getDefault("width")+"px",this.style.width=this.getDefault("width")+"px",this.canvas.style.width=this.canvas.width/t+"px",this.canvas.style.height=this.canvas.height/t+"px`",this.canvas.height=this.getDefault("height")*UIBase$f.getDPI(),this._redraw()}updateSize(){if(void 0===this.canvas)return;let t=this.getClientRects()[0];if(void 0===t)return;let e=UIBase$f.getDPI(),i=this.canvas,s=~~(t.width*e),r=~~(t.height*e);s===i.width&&r===i.height||(this.canvas.width=s,this.canvas.height=r,this.setCSS(),this._redraw())}_ondestroy(){this.modalRunning&&this.popModal()}update(){super.update();let t=this.getDefault("width")+":"+this.getDefault("height")+":"+this.getDefault("SlideHeight");t!==this._last_slider_key&&(this._last_slider_key=t,this.flushUpdate(),this.setCSS(),this._redraw()),this.getAttribute("tab-index")!==this.tabIndex&&(this.tabIndex=this.getAttribute("tab-index")),this.updateSize(),this.updateDataPath(),updateSliderFromDom(this)}}UIBase$f.internalRegister(NumSliderSimpleBase);class SliderWithTextbox extends ColumnFrame{constructor(){super(),this._value=0,this._name=void 0,this._lock_textbox=!1,this._labelOnTop=void 0,this._last_label_on_top=void 0,this.container=this,this.textbox=UIBase$f.createElement("textbox-x"),this.textbox.width=55,this._numslider=void 0,this.textbox.overrideDefault("width",this.getDefault("TextBoxWidth")),this.textbox.setAttribute("class","numslider_simple_textbox"),this.textbox.startSelected=!0,this._last_value=void 0}get addLabel(){if(this.hasAttribute("add-label")){let t=(""+this.getAttribute("add-label")).toLowerCase();return"true"===t||"yes"===t}return this.getDefault("addLabel")}set addLabel(t){this.setAttribute("add-label",t?"true":"false"),this.addLabel&&!this.l&&this.doOnce(this.rebuild)}get labelOnTop(){let t=this._labelOnTop;if(void 0===t&&this.hasAttribute("labelOnTop")){let e=this.getAttribute("labelOnTop");"string"==typeof e?(e=e.toLowerCase(),t="true"===e||"yes"===e):t=!!e}return void 0===t&&(t=this.getDefault("labelOnTop")),!!t}set labelOnTop(t){this._labelOnTop=t}get numslider(){return this._numslider}set numslider(t){this._numslider=t,this.textbox.range=this._numslider.range}get editAsBaseUnit(){return this.numslider.editAsBaseUnit}set editAsBaseUnit(t){this.numslider.editAsBaseUnit=t}get range(){return this.numslider.range}set range(t){this.numslider.range=t}get step(){return this.numslider.step}set step(t){this.numslider.step=t}get expRate(){return this.numslider.expRate}set expRate(t){this.numslider.expRate=t}get decimalPlaces(){return this.numslider.decimalPlaces}set decimalPlaces(t){this.numslider.decimalPlaces=t}get isInt(){return this.numslider.isInt}set isInt(t){this.numslider.isInt=t}get slideSpeed(){return this.numslider.slideSpeed}set slideSpeed(t){this.numslider.slideSpeed=t}get sliderDisplayExp(){return this.numslider.sliderDisplayExp}set sliderDisplayExp(t){this.numslider.sliderDisplayExp=t}get radix(){return this.numslider.radix}set radix(t){this.numslider.radix=t}get stepIsRelative(){return this.numslider.stepIsRelative}set stepIsRelative(t){this.numslider.stepIsRelative=t}get displayUnit(){return this.numslider.displayUnit}set displayUnit(t){let e=t!==this.displayUnit;this.numslider.displayUnit=this.textbox.displayUnit=t,e&&this.updateTextBox()}get baseUnit(){return this.textbox.baseUnit}set baseUnit(t){let e=t!==this.baseUnit;this.numslider.baseUnit=this.textbox.baseUnit=t,e&&this.updateTextBox()}get realTimeTextBox(){let t=this.getAttribute("realtime");return!!t&&(t=t.toLowerCase().trim(),"true"===t||"on"===t||"yes"===t)}set realTimeTextBox(t){this.setAttribute("realtime",t?"true":"false")}get value(){return this._value}set value(t){this.setValue(t)}init(){super.init(),this.rebuild(),window.setTimeout((()=>this.updateTextBox()),500)}rebuild(){this._last_label_on_top=this.labelOnTop,this.container.clear(),this.labelOnTop?this.container=this:this.container=this.row(),this.hasAttribute("name")?this._name=this.getAttribute("name"):this._name="slider",this.addLabel&&(this.l=this.container.label(this._name),this.l.overrideClass("numslider_textbox"),this.l.font="TitleText",this.l.style.display="float",this.l.style.position="relative");let t=this.container.row();t.add(this.numslider);this.hasAttribute("datapath")&&this.getAttribute("datapath");let e=this.textbox;this.textbox.overrideDefault("width",this.getDefault("TextBoxWidth"));let i=()=>{let t=e.text;if(isNumber(t)){e.flash("green");let i=this.editAsBaseUnit?void 0:this.displayUnit,s=parseValue(t,this.baseUnit,i);if(isNaN(s))return void this.flash("red");this.isInt&&(s=Math.floor(s)),this._lock_textbox=1,this.setValue(s),this._lock_textbox=0}else e.flash("red")};this.realTimeTextBox&&(e.onchange=i),e.onend=i,e.ctx=this.ctx,e.packflag|=this.inherit_packflag,e.overrideDefault("width",this.getDefault("TextBoxWidth")),e.style.height=this.getDefault("height")-2+"px",e._init(),t.add(e),e.setCSS(),this.linkTextBox();let s=0;this.numslider.onchange=t=>{if(this._value=this.numslider.value,this.updateTextBox(),!s){if(void 0!==this.onchange){s++;try{this.onchange&&this.onchange(this)}catch(t){print_stack$1(t)}}s--}}}updateTextBox(){this._init_done&&(this._lock_textbox>0||this.textbox.editing||(this.textbox.text=this.formatNumber(this._value),this.textbox.update(),updateSliderFromDom(this,this.numslider)))}linkTextBox(){this.updateTextBox();let t=this.numslider.onchange;this.numslider.onchange=e=>{this._value=e.value,this.updateTextBox(),t(e)}}setValue(t,e=!0){this._value=t,this.numslider.setValue(t,e),this.updateTextBox()}updateName(){let t=this.getAttribute("name");if(!t&&this.hasAttribute("datapath")){let e=this.getPathMeta(this.ctx,this.getAttribute("datapath"));e&&(t=e.uiname)}t||(t="[error]"),t!==this._name&&(this._name=t,this.l&&(this.l.text=t))}updateLabelOnTop(){this.labelOnTop!==this._last_label_on_top&&(this._last_label_on_top=this.labelOnTop,this.rebuild())}updateDataPath(){if(!this.ctx||!this.getAttribute("datapath"))return;if(!this.getPathMeta(this.ctx,this.getAttribute("datapath")))return;let t=this.getPathValue(this.ctx,this.getAttribute("datapath"));t!==this._last_value&&(this._last_value=this._value=t,this.updateTextBox())}update(){this.updateLabelOnTop(),super.update(),this.updateDataPath();updateSliderFromDom(this,this.numslider),updateSliderFromDom(this,this.textbox),this.updateName(),this.numslider.description=this.description,this.textbox.description=this.title,this.hasAttribute("datapath")&&(this.numslider.setAttribute("datapath",this.getAttribute("datapath")),this.textbox.setAttribute("datapath",this.getAttribute("datapath"))),this.hasAttribute("mass_set_path")&&(this.numslider.setAttribute("mass_set_path",this.getAttribute("mass_set_path")),this.textbox.setAttribute("mass_set_path",this.getAttribute("mass_set_path")))}setCSS(){super.setCSS(),this.textbox.setCSS()}}class NumSliderSimple extends SliderWithTextbox{constructor(){super(),this.numslider=UIBase$f.createElement("numslider-simple-base-x")}static define(){return{tagname:"numslider-simple-x",style:"numslider_simple"}}_redraw(){this.numslider._redraw()}}UIBase$f.internalRegister(NumSliderSimple);class NumSliderWithTextBox extends SliderWithTextbox{constructor(){super(),this.numslider=UIBase$f.createElement("numslider-x")}static define(){return{tagname:"numslider-textbox-x",style:"numslider_textbox"}}update(){if(super.update(),this.hasAttribute("name")){let t=this.getAttribute("name");t!==this.numslider.name&&(this.numslider.setAttribute("name",t),this.numslider._redraw())}}_redraw(){this.numslider._redraw()}}UIBase$f.internalRegister(NumSliderWithTextBox);let pagecache=new Map;var domTransferAttrs=new Set(["id","title","tab-index"]),domEventAttrs=new Set(["click","mousedown","mouseup","mousemove","keydown","keypress"]);function parseXML(t){return t=`<root>${t}</root>`,(new DOMParser).parseFromString(t.trim(),"application/xml")}let num_re=/[0-9]+$/;function getIconFlag(t){if(!t.hasAttribute("useIcons"))return 0;let e=t.getAttribute("useIcons");if("string"==typeof e&&(e=e.toLowerCase().trim()),"false"===e||"no"===e)return 0;if("true"===e||"yes"===e)return PackFlags$a.USE_ICONS;if("small"===e)return PackFlags$a.SMALL_ICON|PackFlags$a.USE_ICONS;if("large"===e)return PackFlags$a.LARGE_ICON|PackFlags$a.USE_ICONS;{let t="number"==typeof e,i=e;if("string"==typeof i&&0===i.search(num_re)&&(i=parseInt(i),t=!0),!t)return PackFlags$a.USE_ICONS;let s=PackFlags$a.USE_ICONS|PackFlags$a.CUSTOM_ICON_SHEET;return s|=i-1<<PackFlags$a.CUSTOM_ICON_SHEET_START,s}}function getPackFlag(t){let e=getIconFlag(t);return t.hasAttribute("drawChecks")&&(getbool(t,"drawChecks")?e&=~PackFlags$a.HIDE_CHECK_MARKS:e|=PackFlags$a.HIDE_CHECK_MARKS),getbool(t,"simpleSlider")&&(e|=PackFlags$a.SIMPLE_NUMSLIDERS),getbool(t,"rollarSlider")&&(e|=PackFlags$a.FORCE_ROLLER_SLIDER),e}function myParseFloat(t){return(t=(t=""+t).trim().toLowerCase()).endsWith("px")&&(t=t.slice(0,t.length-2)),parseFloat(t)}function getbool(t,e){let i=t.getAttribute(e);return!!i&&(i=i.toLowerCase(),"1"===i||"true"===i||"yes"===i)}function getfloat(t,e,i){return t.hasAttribute(e)?myParseFloat(t.getAttribute(e)):i}const customHandlers={};class Handler{constructor(t,e){this.container=e,this.stack=[],this.ctx=t,this.codefuncs={},this.templateVars={};let i=list$2(sliderDomAttributes);this.inheritDomAttrs={},this.inheritDomAttrKeys=new Set(i)}push(){this.stack.push(this.container),this.stack.push(new Set(this.inheritDomAttrKeys)),this.stack.push(Object.assign({},this.inheritDomAttrs))}pop(){this.inheritDomAttrs=this.stack.pop(),this.inheritDomAttrKeys=this.stack.pop(),this.container=this.stack.pop()}handle(t){if(t.constructor===XMLDocument||"root"===t.nodeName){for(let e of t.childNodes)this.handle(e);return void(window.tree=t)}if(t.constructor===Text||t.constructor===Comment)return;let e=""+t.tagName;if(e in customHandlers)customHandlers[e](this,t);else if(this[e])this[e](t);else{let i=UIBase$f.createElement(e.toLowerCase());window.__elem=t;for(let e of t.getAttributeNames())i.setAttribute(e,t.getAttribute(e));if(i instanceof UIBase$f){if(!i.hasAttribute("datapath")&&i.hasAttribute("path")&&i.setAttribute("datapath",i.getAttribute("path")),i.hasAttribute("datapath")){let t=i.getAttribute("datapath");t=this.container._joinPrefix(t),i.setAttribute("datapath",t)}if(i.hasAttribute("massSetPath")||this.container.massSetPrefix){let t="";i.hasAttribute("massSetPath")&&(t=i.getAttribute("massSetPath"));let e=i.getAttribute("datapath");e=this.container._getMassPath(this.container.ctx,e,t),i.setAttribute("massSetPath",e),i.setAttribute("mass_set_path",e)}if(this.container.add(i),this._style(t,i),i instanceof Container)return this.push(),this.container=i,this._container(t,i,!0),this.visit(t),void this.pop()}else{console.warn("Unknown element "+t.tagName+" ("+t.constructor.name+")");let e=document.createElement(t.tagName.toLowerCase());for(let i of t.getAttributeNames())e.setAttribute(i,t.getAttribute(i));this._basic(t,e),this.container.shadow.appendChild(e),e instanceof UIBase$f?e.ctx=this.container.ctx:e.pathux_ctx=this.container.ctx}this.visit(t)}}_style(t,e){let i={};if(t.hasAttribute("class")){e.setAttribute("class",t.getAttribute("class"));let s=e.getAttribute("class").trim(),r=[s,(e.tagName.toLowerCase()+"."+s).trim(),"#"+t.getAttribute("id").trim()];for(let t of document.styleSheets)for(let e of t.rules)for(let t of r)if(e.selectorText.trim()===t)for(let t of e.styleMap.keys()){let s=e.style[t];i[t]=s}}if(t.hasAttribute("style")){let e=t.getAttribute("style");e=e.split(";");for(let t of e){t=t.trim();let e=t.search(/\:/);if(e>=0){let s=t.slice(0,e).trim(),r=t.slice(e+1,t.length).trim();i[s]=r}}}let s=Object.keys(i);function r(){for(let t of s)e.style[t]=i[t]}0!==s.length&&(e instanceof UIBase$f&&e.setCSS.after((()=>{r()})),r())}visit(t){for(let e of t.childNodes)this.handle(e)}_getattr(t,e){let i=t.getAttribute(e);return i?(i.startsWith("##")&&(i=i.slice(2,i.length).trim(),i in this.templateVars?i=this.templateVars[i]:(console.error(`unknown template variable '${i}'`),i="")),i):i}_basic(t,e){this._style(t,e);for(let i of t.getAttributeNames())i.startsWith("custom")&&e.setAttribute(i,this._getattr(t,i));let i=[];for(let e of t.getAttributeNames()){let s=""+t.getAttribute(e);s.startsWith("ng[")&&(s=s.slice(3,s.endsWith("]")?s.length-1:s.length),i.push([e,"ng",s]))}for(let e of domEventAttrs){let s="on"+e;t.hasAttribute(s)&&i.push([e,"dom",t.getAttribute(s)])}for(let[t,s,r]of i)if(r in this.codefuncs)if("dom"===s)if("click"===t){let t=e.onclick,i=this.codefuncs[r];e.onclick=function(){return t&&t.apply(this,arguments),i.apply(this,arguments)}}else e.addEventListener(t,this.codefuncs[r]);else"ng"===s&&e.addEventListener(t,this.codefuncs[r]);else console.error("Unknown code fragment "+r);for(let i of domTransferAttrs)t.hasAttribute(i)&&e.setAttribute(i,t.getAttribute(i));for(let e in this.inheritDomAttrs)t.hasAttribute(e)||t.setAttribute(e,this.inheritDomAttrs[e]);for(let i of sliderDomAttributes)t.hasAttribute(i)&&e.setAttribute(i,t.getAttribute(i));if(e instanceof UIBase$f){if(t.hasAttribute("theme-class")&&(e.overrideClass(t.getAttribute("theme-class")),e._init_done&&(e.setCSS(),e.flushUpdate())),t.hasAttribute("useIcons")&&"function"==typeof e.useIcons){let i=t.getAttribute("useIcons").trim().toLowerCase();i="small"===i||"true"===i||"yes"===i||("large"===i?1:"false"!==i&&"no"!==i&&parseInt(i)-1),e.useIcons(i)}if(t.hasAttribute("sliderTextBox")){getbool(t,"sliderTextBox")?(e.packflag&=~PackFlags$a.NO_NUMSLIDER_TEXTBOX,e.inherit_packflag&=~PackFlags$a.NO_NUMSLIDER_TEXTBOX):(e.packflag|=PackFlags$a.NO_NUMSLIDER_TEXTBOX,e.inherit_packflag|=PackFlags$a.NO_NUMSLIDER_TEXTBOX)}if(t.hasAttribute("sliderMode")){let i=t.getAttribute("sliderMode");"slider"===i?(e.packflag&=~PackFlags$a.FORCE_ROLLER_SLIDER,e.inherit_packflag&=~PackFlags$a.FORCE_ROLLER_SLIDER,e.packflag|=PackFlags$a.SIMPLE_NUMSLIDERS,e.inherit_packflag|=PackFlags$a.SIMPLE_NUMSLIDERS):"roller"===i&&(e.packflag&=~PackFlags$a.SIMPLE_NUMSLIDERS,e.packflag|=PackFlags$a.FORCE_ROLLER_SLIDER,e.inherit_packflag&=~PackFlags$a.SIMPLE_NUMSLIDERS,e.inherit_packflag|=PackFlags$a.FORCE_ROLLER_SLIDER)}if(t.hasAttribute("showLabel")){getbool(t,"showLabel")?(e.packflag|=PackFlags$a.FORCE_PROP_LABELS,e.inherit_packflag|=PackFlags$a.FORCE_PROP_LABELS):(e.packflag&=~PackFlags$a.FORCE_PROP_LABELS,e.inherit_packflag&=~PackFlags$a.FORCE_PROP_LABELS)}s("width"),s("height"),s("margin"),s("padding");for(let t=0;t<2;t++){let e=t?"margin":"padding";s(e+"-bottom"),s(e+"-top"),s(e+"-left"),s(e+"-right")}}function s(i){if(t.hasAttribute(i)){let s=t.getAttribute(i).toLowerCase().trim();if(s.endsWith("px")&&(s=s.slice(0,s.length-2).trim()),s.endsWith("%"))console.warn(`Relative styling of '${i}' may be unstable for this element`,t),t.setCSS.after((function(){this.style[i]=s}));else{if(s=parseFloat(s),isNaN(s)||"number"!=typeof s)return void console.error(`Invalid style ${i}:${t.getAttribute(i)}`);e.overrideDefault(i,s),e.setCSS(),e.style[i]=s+"px"}}}}_handlePathPrefix(t,e){if(t.hasAttribute("path")){let i=e.dataPrefix,s=t.getAttribute("path").trim();i.length>0&&(i+="."),i+=s,e.dataPrefix=i}if(t.hasAttribute("massSetPath")){let i=e.massSetPrefix,s=t.getAttribute("massSetPath").trim();i.length>0&&(i+="."),i+=s,e.massSetPrefix=i}}_container(t,e,i=!1){for(let e of this.inheritDomAttrKeys)t.hasAttribute(e)&&(this.inheritDomAttrs[e]=t.getAttribute(e));let s=getPackFlag(t);e.packflag|=s,e.inherit_packflag|=s,this._basic(t,e),i||this._handlePathPrefix(t,e)}noteframe(t){let e=this.container.noteframe();e&&this._basic(t,e)}cell(t){this.push(),this.container=this.container.cell(),this._container(t,this.container),this.visit(t),this.pop()}table(t){this.push(),this.container=this.container.table(),this._container(t,this.container),this.visit(t),this.pop()}panel(t){let e=""+t.getAttribute("label"),i=getbool(t,"closed");this.push(),this.container=this.container.panel(e),this.container.closed=i,this._container(t,this.container),this.visit(t),this.pop()}pathlabel(t){this._prop(t,"pathlabel")}code(elem){window._codelem=elem;let buf="";for(let t of elem.childNodes)"#text"===t.nodeName&&(buf+=t.textContent+"\n");var func,$scope=this.templateScope;buf=`\nfunc = function() {\n  ${buf};\n}\n    `,eval(buf);let id=""+elem.getAttribute("id");this.codefuncs[id]=func}textbox(t){t.hasAttribute("path")&&this._prop(t,"textbox")}label(t){let e=this.container.label(t.innerHTML);this._basic(t,e)}colorfield(t){this._prop(t,"colorfield")}prop(t){this._prop(t,"prop")}_prop(t,e){let i,s=getPackFlag(t),r=t.getAttribute("path");if("pathlabel"===e?i=this.container.pathlabel(r,t.innerHTML,s):"textbox"===e?(i=this.container.textbox(r,void 0,void 0,s),i.update(),t.hasAttribute("modal")&&i.setAttribute("modal",t.getAttribute("modal")),t.hasAttribute("realtime")&&i.setAttribute("realtime",t.getAttribute("realtime"))):i="colorfield"===e?this.container.colorPicker(r,{packflag:s,themeOverride:t.hasAttribute("theme-class")?t.getAttribute("theme-class"):void 0}):this.container[e](r,s),i){if(this._basic(t,i),t.hasAttribute("massSetPath")||this.container.massSetPrefix){let e=t.getAttribute("massSetPath");e||(e=t.getAttribute("path")),e=this.container._getMassPath(this.container.ctx,r,e),i.setAttribute("mass_set_path",e)}}else i=document.createElement("span"),i.innerHTML="error",this.container.shadow.appendChild(i)}strip(t){let e;this.push(),t.hasAttribute("mode")&&(e=t.getAttribute("mode").toLowerCase().trim(),e="horizontal"===e);let i=getfloat(t,"margin1",void 0),s=getfloat(t,"margin2",void 0);this.container=this.container.strip(void 0,i,s,e),this._container(t,this.container),this.visit(t),this.pop()}column(t){this.push(),this.container=this.container.col(),this._container(t,this.container),this.visit(t),this.pop()}row(t){this.push(),this.container=this.container.row(),this._container(t,this.container),this.visit(t),this.pop()}toolPanel(t){this.tool(t,"toolPanel")}tool(t,e="tool"){let i,s=t.getAttribute("path"),r=getPackFlag(t),a=!1;getbool(t,"useIcons")?r|=PackFlags$a.USE_ICONS:t.hasAttribute("useIcons")&&(r&=~PackFlags$a.USE_ICONS,a=!0);let n=(""+t.textContent).trim();n.length>0&&(s+="|"+n),a&&(i=this.container.useIcons(!1));let o=this.container[e](s,r);o||(o=document.createElement("strip"),o.innerHTML="error",this.container.shadow.appendChild(o)),this._basic(t,o),a&&(this.container.inherit_packflag|=i,this.container.packflag|=i)}dropbox(t){return this.menu(t,!0)}menu(t,e=!1){let i=getPackFlag(t),s=t.getAttribute("name"),r=[];for(let e of t.childNodes)if("tool"===e.tagName){let t=e.getAttribute("path"),i=e.innerHTML.trim();i.length>0&&(t+="|"+i),r.push(t)}else if("sep"===e.tagName)r.push(Menu.SEP);else if("item"===e.tagName){let t,i,s,a;e.hasAttribute("id")&&(t=e.getAttribute("id")),e.hasAttribute("icon")&&(i=e.getAttribute("icon").toUpperCase().trim(),i=Icons$2[i]),e.hasAttribute("hotkey")&&(s=e.getAttribute("hotkey")),e.hasAttribute("description")&&(a=e.getAttribute("description")),r.push({name:e.innerHTML.trim(),id:t,icon:i,hotkey:s,description:a})}let a=this.container.menu(s,r,i);return e&&a.removeAttribute("simple"),t.hasAttribute("id")&&a.setAttribute("id",t.getAttribute("id")),this._basic(t,a),a}button(t){let e=t.innerHTML.trim(),i=this.container.button(e);t.hasAttribute("id")&&i.setAttribute("id",t.getAttribute("id")),this._basic(t,i)}iconbutton(t){let e=t.innerHTML.trim(),i=t.getAttribute("icon");i&&(i=UIBase$f.getIconEnum()[i]);let s=this.container.iconbutton(i,e);t.hasAttribute("id")&&s.setAttribute("id",t.getAttribute("id")),this._basic(t,s)}tab(t){this.push();let e=""+t.getAttribute("label");this.container;this.container=this.container.tab(e),t.hasAttribute("overflow")&&this.container.setAttribute("overflow",t.getAttribute("overflow")),t.hasAttribute("overflow-y")&&this.container.setAttribute("overflow-y",t.getAttribute("overflow-y")),this._container(t,this.container),this.visit(t),this.pop()}tabs(t){let e=t.getAttribute("pos")||"left";this.push();let i=this.container.tabs(e);this.container=i,t.hasAttribute("movable-tabs")&&i.setAttribute("movable-tabs",t.getAttribute("movable-tabs")),this._container(t,i),this.visit(t),this.pop()}}function initPage(t,e,i,s={},r={}){let a=parseXML(e),n=UIBase$f.createElement("container-x");n.ctx=t,t&&n._init(),i&&i.add(n);let o=new Handler(t,n);return o.templateVars=Object.assign({},s),o.templateScope=r,o.handle(a),n}function loadPage(t,e,i,s=!1,r,a,n){let o,l;if(void 0===i||i instanceof HTMLElement)l=i;else{let t=i;l=t.parentContainer,s=t.loadSourceOnly,r=t.modifySourceCB,a=t.templateVars,n=t.templateScope}return pagecache.has(e)?(o=pagecache.get(e),r&&(o=r(o)),new Promise(((e,i)=>{e(s?o:initPage(t,o,l,a,n))}))):new Promise(((i,o)=>{fetch(e).then((t=>t.text())).then((o=>{pagecache.set(e,o),r&&(o=r(o)),i(s?o:initPage(t,o,l,a,n))}))}))}function makeGenEnum(){let t={},e={},i={};for(let s of CurveConstructors){let r=s.define(),a=r.uiname;a=void 0===a?r.name:a,t[r.name]=s.name,e[r.name]=a,i[r.name]=void 0!==r.icon?r.icon:-1}return new EnumProperty$9(void 0,t).addUINames(e).addIcons(i)}class Curve1DWidget extends ColumnFrame{#h=!1;constructor(){super(),this.useDataPathUndo=!1,this._on_draw=this._on_draw.bind(this),this.drawTransform=[1,[0,0]],this._value=new Curve1D,this.checkCurve1dEvents(),this.#h=0,this._value._on_change=t=>{if(!this.#h){this.#h++;try{if(this.hasAttribute("datapath")){let t=this.getAttribute("datapath");if(void 0!==this._value){let e=this.getPathValue(this.ctx,t);e?(e.load(this._value),this.setPathValue(this.ctx,t,e)):(e=this._value.copy(),this.setPathValue(this.ctx,t,e))}}this.onchange&&this.onchange(this._value)}catch(t){window.DEBUG&&window.DEBUG.datapath&&(console.error(t.stack),console.error(t.message))}this.#h--,this.#h<0&&(console.warn("this.#in_onchange was negative"),this.#h=0)}},this._gen_type=void 0,this._lastGen=void 0,this._last_dpi=void 0,this.canvas=document.createElement("canvas"),this.g=this.canvas.getContext("2d"),this.canvas.g=this.g,window.cw=this,this.shadow.appendChild(this.canvas)}checkCurve1dEvents(){if(this._value.subscribed("draw",this)||this._value.on("draw",this._on_draw,this,(()=>!this.isConnected)),this.ctx&&this.hasAttribute("datapath")){let t;try{t=this.ctx.api.getValue(this.ctx,this.getAttribute("datapath"))}catch(t){window.DEBUG&&window.DEBUG.datapath&&(console.error(t.stack),console.error(t.message))}if(!t)return void(this.disabled=!0);this.disabled&&(this.disabled=!1),t.subscribed(void 0,this)||(t.on("select",(t=>{let e=this._value.getGenerator("BSplineCurve");for(let i=0;i<t.points.length&&!(i>=e.length);i++)e.points[i].flag=t.points[i].flag;e.redraw()})),t.on("transform",(t=>{let e=this._value.getGenerator("BSplineCurve");for(let i=0;i<t.points.length&&!(i>=e.length);i++)e.points[i].co.load(t.points[i].co);e.update(),e.updateKnots(),e.redraw()})),t.on("update",(()=>{console.log("datapath curve1d update!"),this._value.load(t),this.rebuild()}),this,(()=>!this.isConnected)))}}get value(){return this._value}_on_draw(t){t.data;this._redraw()}set value(t){this._value.load(t),this.update(),this._redraw()}_on_change(){this.onchange&&this.onchange(this)}init(){super.init(),this.useDataPathUndo=!1;let t=this.row(),e=makeGenEnum();e.setValue(this.value.generatorType),this.dropbox=t.listenum(void 0,"Type",e,this.value.generatorType,(t=>{console.warn("SELECT",t,e.keys[t]),this.value.setGenerator(t),this.value._on_change("curve type change")})),this.dropbox._init(),t.iconbutton(Icons$2.ZOOM_OUT,"Zoom Out",(()=>{let t=this._value;t&&(t.uiZoom*=.9,this.getAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),t),this._redraw())})).iconsheet=0,t.iconbutton(Icons$2.ZOOM_IN,"Zoom In",(()=>{let t=this._value;t&&(t.uiZoom*=1.1,this.getAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),t),this._redraw())})).iconsheet=0,this.container=this.col();let i=this.panel("Range"),s=i.check(void 0,"Clip To Range");s.onchange=t=>{this._value.clipToRange=t,this._on_change(),this._redraw()},s.checked=this._value.clipToRange;let r=i.slider(void 0,"X Min",this._value.xRange[0],-10,10,.1,!1,void 0,(t=>{this._value.xRange[0]=t.value,this._on_change(),this._redraw()})),a=i.slider(void 0,"X Max",this._value.xRange[1],-10,10,.1,!1,void 0,(t=>{this._value.xRange[1]=t.value,this._on_change(),this._redraw()})),n=i.slider(void 0,"Y Min",this._value.yRange[0],-10,10,.1,!1,void 0,(t=>{this._value.yRange[0]=t.value,this._on_change(),this._redraw()})),o=i.slider(void 0,"Y Max",this._value.yRange[1],-10,10,.1,!1,void 0,(t=>{this._value.yRange[1]=t.value,this._on_change(),this._redraw()})),l="";this.container.update.after((()=>{const t=this._value.xRange,e=this._value.yRange;let i=t[0]+":"+t[1]+":"+e[0]+":"+e[1]+":"+this._value.clipToRange;s.checked=this._value.clipToRange,i!==l&&(l=i,r.setValue(t[0]),a.setValue(t[1]),n.setValue(e[0]),o.setValue(e[1]))})),r.displayUnit=r.baseUnit="none",n.displayUnit=n.baseUnit="none",a.displayUnit=a.baseUnit="none",o.displayUnit=o.baseUnit="none",i.closed=!1}setCSS(){super.setCSS(),this.style.width="min-contents",this.style.height="min-contents",this.updateSize()}updateSize(){let t=UIBase$f.getDPI(),e=~~(this.getDefault("CanvasWidth")*t),i=~~(this.getDefault("CanvasHeight")*t),s=e!==this.canvas.width||i!==this.canvas.height;s=s||t!==this._last_dpi,s&&(this._last_dpi=t,this.canvas.width=e,this.canvas.height=i,this.canvas.style.width=e/t+"px",this.canvas.style.height=i/t+"px",this._redraw())}_redraw(){this.canvas.width=this.canvas.width,this.canvas.height=this.canvas.height;let t=this.canvas,e=this.g;e.beginPath(),e.rect(0,0,t.width,t.height),e.fillStyle=this.getDefault("CanvasBG"),e.fill(),e.save();let i=this._value.uiZoom,s=Math.max(t.width,t.height);e.lineWidth/=s,this.drawTransform[0]=s*i,this.drawTransform[1][0]=0,this.drawTransform[1][1]=-1,this.drawTransform[1][0]-=.5-.5/i,this.drawTransform[1][1]+=.5-.5/i,e.scale(this.drawTransform[0],-this.drawTransform[0]),e.translate(this.drawTransform[1][0],this.drawTransform[1][1]),e.lineWidth/=i,this._value.draw(this.canvas,this.g,this.drawTransform),e.restore()}rebuild(){if(void 0===this.ctx||void 0===this.container)return;this.checkCurve1dEvents();let t=saveUIData(this.container,"curve1d");this._gen_type=this.value.generatorType;let e=this.container;void 0!==this._lastGen&&this._lastGen.killGUI(e,this.canvas);let i=this.dropbox.onchange;this.dropbox.onchange=void 0,this.dropbox.setValue(this.value.generatorType),this.dropbox.onchange=i,e.clear();let s=()=>{if(!this.hasAttribute("datapath"))return;let t=this.getPathValue(this.ctx,this.getAttribute("datapath"));this._value.load(t),this.rebuild()},r=this.hasAttribute("datapath")?this.getAttribute("datapath"):void 0,a=this.value.generators.active;this.#h++;try{a.makeGUI(e,this.canvas,this.drawTransform,r,s),loadUIData(this.container,t);for(let t=0;t<4;t++)e.flushUpdate()}catch(t){console.warn(t.stack),console.warn(t.message)}this.#h--,this._lastGen=a,this._redraw()}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getAttribute("datapath"),e=this.getPathValue(this.ctx,t);void 0===this._lastu&&(this._lastu=0),e&&!e.equals(this._value)&&time_ms()-this._lastu>200&&(this._lastu=time_ms(),this._value.load(e),this.update(),this._redraw())}updateGenUI(){this._lastGen!==this.value.generators.active&&(this.rebuild(),this._redraw())}update(){super.update(),this.checkCurve1dEvents(),this.updateDataPath(),this.updateSize(),this.updateGenUI()}static define(){return{tagname:"curve-widget-x",style:"curvewidget"}}}UIBase$f.internalRegister(Curve1DWidget);var _ui$1=void 0;let PropFlags$1=PropFlags$3,PropSubTypes$1=PropSubTypes$3,EnumProperty$2=EnumProperty$9,Vector2$5=Vector2$b,UIBase$6=UIBase$f,PackFlags$4=PackFlags$a,PropTypes$2=PropTypes$8,forward_keys=new Set(["row","col","strip","noteframe","helppicker","vecpopup","tabs","table","menu","listbox","panel","pathlabel","label","listenum","check","iconcheck","button","iconbutton","colorPicker","twocol","treeview","slider","simpleslider","curve1d","noteframe","vecpopup","prop","tool","toolPanel","textbox","dynamicMenu","add","prepend","useIcons","noMarginsOrPadding","wrap"]);class PanelFrame extends ColumnFrame{constructor(){super(),this.titleframe=super.row(),this.contents=super.col(),this.contents._remove=this.contents.remove,this.contents.remove=()=>{this.remove()},this._panel=this,this.contents._panel=this,this.iconcheck=UIBase$6.createElement("iconcheck-x"),this.iconcheck.noEmboss=!0,Object.defineProperty(this.contents,"closed",{get:()=>this.closed,set:t=>{this.closed=t}}),Object.defineProperty(this.contents,"title",{get:()=>this.titleframe.getAttribute("title"),set:t=>this.setHeaderToolTip(t)}),this.packflag=this.inherit_packflag=0,this._closed=!1,this.makeHeader()}get inherit_packflag(){if(this.contents)return this.contents.inherit_packflag}set inherit_packflag(t){this.contents&&(this.contents.inherit_packflag=t)}get packflag(){if(this.contents)return this.contents.packflag}set packflag(t){this.contents&&(this.contents.packflag=t)}appendChild(t){return this.contents.shadow.appendChild(t)}get headerLabel(){return this.__label.text}set headerLabel(t){this.__label.text=t,this.__label._updateFont(),this.hasAttribute("label")&&this.setAttribute("label",t),this.ctx&&this.setCSS()}get dataPrefix(){return this.contents?this.contents.dataPrefix:""}set dataPrefix(t){this.contents&&(this.contents.dataPrefix=t)}get closed(){return this._closed}set closed(t){let e=!!t!=!!this.closed;this._closed=t,e&&this._updateClosed(!0)}static define(){return{tagname:"panelframe-x",style:"panel",subclassChecksTheme:!0}}setHeaderToolTip(t){this.titleframe.setAttribute("title",t),this.titleframe._forEachChildWidget((e=>{e.setAttribute("title",t)}))}saveData(){let t={closed:this._closed};return Object.assign(super.saveData(),t)}loadData(t){this.closed="closed"in t?t.closed:t._closed}clear(){return this.contents.clear(),this}makeHeader(){let t=this.titleframe,e=this.iconcheck;if(!e)return;e.overrideDefault("padding",0),e.noMarginsOrPadding(),e.overrideDefault("highlight",{"background-color":e.getSubDefault("highlight","background-color")}),e.overrideDefault("background-color","rgba(0,0,0,0)"),e.overrideDefault("BoxDepressed","rgba(0,0,0,0)"),e.overrideDefault("border-color","rgba(0,0,0,0)"),e.ctx=this.ctx,e._icon_pressed=Icons$2.UI_EXPAND,e._icon=Icons$2.UI_COLLAPSE,e.drawCheck=!1,e.iconsheet=IconSheets$7.SMALL,e.checked=this._closed,this.iconcheck.onchange=t=>{this.closed=this.iconcheck.checked},t._add(e);let i=t=>{e.checked=!e.checked,t.preventDefault()},s=this.__label=t.label(this.getAttribute("label"));this.__label.font="TitleText",s._updateFont(),s.noMarginsOrPadding(),s.addEventListener("mousedown",i),s.addEventListener("touchdown",i);let r=this.getDefault("border-style");t.background=this.getDefault("TitleBackground"),t.style["border-radius"]=this.getDefault("border-radius")+"px",t.style.border=`${this.getDefault("border-width")}px ${r} ${this.getDefault("border-color")}`,t.style["padding-right"]="20px",t.style["padding-left"]="5px",t.style["padding-top"]=this.getDefault("padding-top")+"px",t.style["padding-bottom"]=this.getDefault("padding-bottom")+"px"}init(){super.init(),this.background=this.getDefault("background-color"),this.style.width="100%",this.contents.ctx=this.ctx,this._closed||(super.add(this.contents),this.contents.flushUpdate()),this.contents.dataPrefix=this.dataPrefix,this.setCSS()}setCSS(){if(super.setCSS(),!this.titleframe||!this.__label)return;let t=(t,e)=>{let i=this.getDefault(t);return void 0!==i?i:e},e=this.getDefault("border-style"),i=this.getDefault("HeaderRadius");void 0===i&&(i=this.getDefault("border-radius"));let s=t("padding",0),r=t("padding-left",0),a=t("padding-right",0);r+=s,a+=s,this.titleframe.background=this.getDefault("TitleBackground"),this.titleframe.style["border-radius"]=i+"px",this.titleframe.style.border=`${this.getDefault("border-width")}px ${e} ${this.getDefault("TitleBorder")}`,this.style.border=`${this.getDefault("border-width")}px ${e} ${this.getDefault("border-color")}`,this.style["border-radius"]=this.getDefault("border-radius")+"px",this.titleframe.style["padding-top"]=this.getDefault("padding-top")+"px",this.titleframe.style["padding-bottom"]=this.getDefault("padding-bottom")+"px",this.titleframe.style["padding-left"]=r+"px",this.titleframe.style["padding-right"]=a+"px",this.titleframe.style["margin-bottom"]="0px",this.titleframe.style["margin-top"]="0px",this.__label.style.border="unset",this.__label.style["border-radius"]="unset";let n,o,l=this.getDefault("background-color");this.background=l,this.contents.background=l,this.contents.parentWidget=this,this.contents.style["background-color"]=l,this.style["background-color"]=l,this._closed?(n=t("margin-top-closed",0),o=t("margin-bottom-closed",5)):(n=t("margin-top",0),o=t("margin-bottom",0));let h=t("margin-left",0),c=t("margin-right",0);this.style["margin-left"]=h+"px",this.style["margin-right"]=c+"px",this.style["margin-top"]=n+"px",this.style["margin-bottom"]=o+"px",this.__label._updateFont()}on_disabled(){super.on_disabled(),this.__label._updateFont(),this.setCSS()}on_enabled(){super.on_enabled(),this.__label.setCSS(),this.__label.style.color=this.style.color,this.setCSS()}update(){let t=this.getAttribute("label")!==this.__label.text;this.checkThemeUpdate()&&(t=!0,this._setVisible(this.closed,!0),this.setCSS(),this.flushSetCSS()),t&&(this.headerLabel=this.getAttribute("label"),this.__label._updateFont(),this.setCSS()),super.update()}_onchange(t){this.onchange&&this.onchange(t),this.contents.onchange&&this.contents.onchange(t)}setAttribute(t,e){let i=super.setAttribute(t,e);return this.ctx&&(this.update(),this.flushUpdate()),i}get noUpdateClosedContents(){if(!this.hasAttribute("update-closed-contents"))return!1;let t=this.getAttribute("update-closed-contents");return"true"===t||"on"===t}set noUpdateClosedContents(t){this.setAttribute("update-closed-contents",t?"true":"false")}_setVisible(t,e){e=e||!!t!=!!this._closed,this._state=t,t?(this.contents.style.display="none",this.noUpdateClosedContents||(this.contents.packflag|=PackFlags$4.NO_UPDATE)):(this.contents.style.display="flex",this.contents.packflag&=~PackFlags$4.NO_UPDATE,this.contents.flushUpdate()),this.contents.hidden=t,this.parentWidget?this.parentWidget.flushUpdate():this.flushUpdate(),e&&this._onchange(t)}_updateClosed(t){this._setVisible(this._closed,t),this.iconcheck&&(this.iconcheck.checked=this._closed)}}let makeForward=t=>function(){return this.contents[t](...arguments)};for(let t of forward_keys)PanelFrame.prototype[t]=makeForward(t);UIBase$6.internalRegister(PanelFrame);let Vector2$4=Vector2$b,Vector3=Vector3$2,Vector4=Vector4$2,Matrix4=Matrix4$2,UIBase$5=UIBase$f,PackFlags$3=PackFlags$a,IconSheets$2=IconSheets$7,UPW=1.25,VPW=.75,sample_rets=new cachering((()=>[0,0]),64);function inv_sample(t,e){let i=sample_rets.next();return i[0]=Math.pow(t,UPW),i[1]=Math.pow(e,VPW),i}function sample(t,e){let i=sample_rets.next();return i[0]=Math.pow(t,1/UPW),i[1]=Math.pow(e,1/VPW),i}function colorClipboardCopy(){let t=this.getRGBA(),e=255*t[0],i=255*t[1],s=255*t[2],r=t[3],a=`rgba(${e.toFixed(4)}, ${i.toFixed(4)}, ${s.toFixed(4)}, ${r.toFixed(4)})`;exports.setClipboardData("color","text/plain",a)}function colorClipboardPaste(){let t,e=exports.getClipboardData("text/plain");if(e&&validateCSSColor(""+e.data)){try{t=css2color(e.data)}catch(t){console.log(t.stack),console.log(t.message)}t&&(t.length<4&&t.push(1),this.setRGBA(t))}}let fieldrand=new MersenneRandom(0),huefields={};function getHueField(t,e,i){let s=t+":"+e+":"+i.toFixed(4);if(s in huefields)return huefields[s];let r=new ImageData(t,e),a=r.data;for(let i=0;i<t*e;i++){let e=4*i,s=hsv_to_rgb(i%t/t,1,1);a[e]=255*s[0],a[e+1]=255*s[1],a[e+2]=255*s[2],a[e+3]=255}let n=document.createElement("canvas");return n.width=r.width,n.height=r.height,n.getContext("2d").putImageData(r,0,0),r=n,huefields[s]=r,r}let fields={};function getFieldImage(t,e,i,s){fieldrand.seed(0);let r=e>>1,a=i>>1,n=t>>1,o=s[0],l=(hsv_to_rgb(o,1,1),t+":"+r+":"+a+":"+o.toFixed(5));if(l in fields)return fields[l];let h=n,c=.75,d={width:e,height:i,image:new ImageData(n,n),x2sat:t=>Math.min(Math.max(t/e,0),1),y2val:t=>0===(t=1-Math.min(Math.max(t/i,0),1))?0:t**c,sat2x:t=>t*e,val2y:t=>0===t?i:(1-(t=t**(1/c)))*i};d.params={box:{x:0,y:0,width:e,height:i}};let u=d.image.data;for(let t=0;t<u.length;t+=4){let e=t/4,i=1-~~(e/h)/h,r=e%h/h,a=hsv_to_rgb(s[0],r,i**c);u[t]=255*a[0],u[t+1]=255*a[1],u[t+2]=255*a[2],u[t+3]=255}let p=document.createElement("canvas");return p.width=h,p.height=h,p.getContext("2d").putImageData(d.image,0,0),d.canvas=p,d.scale=e/h,fields[l]=d,d}let _update_temp=new Vector4;class SimpleBox{constructor(t=[0,0],e=[1,1]){this.pos=new Vector2$4(t),this.size=new Vector2$4(e),this.r=0}}class HueField extends UIBase$5{constructor(){super(),this.canvas=document.createElement("canvas"),this.g=this.canvas.getContext("2d"),this.shadow.appendChild(this.canvas);let t=(t,e)=>{let i=this.getDPI(),s=this._getPad(),r=(t-=s)/(this.canvas.width/i-2*s);r=Math.min(Math.max(r,0),1),this.hsva[0]=r,this.onchange&&this.onchange(this.hsva),this._redraw()};this.addEventListener("keydown",(t=>{switch(t.keyCode){case keymap$4.Left:case keymap$4.Right:let e=t.keyCode===keymap$4.Left?-1:1;this.hsva[0]=Math.min(Math.max(this.hsva[0]+.05*e,0),1),this._redraw(),this.onchange&&this.onchange()}})),this.addEventListener("mousedown",(e=>{if(this.modalRunning)return;e.preventDefault();let i=this.canvas.getClientRects()[0],s=e.clientX-i.x;e.clientY,i.y;t(s),this.pushModal({on_mousemove:e=>{let i=this.canvas.getClientRects()[0],s=e.clientX-i.x;e.clientY,i.y;t(s)},on_mousedown:t=>{this.popModal()},on_mouseup:t=>{this.popModal()},on_keydown:t=>{t.keyCode!==keymap$4.Enter&&t.keyCode!==keymap$4.Escape&&t.keyCode!==keymap$4.Space||this.popModal()}})}))}static define(){return{tagname:"huefield-x",style:"colorfield",havePickClipboard:!0}}getRGBA(){let t=hsv_to_rgb(this.hsva[0],this.hsva[1],this.hsva[2]);return(new Vector4).loadXYZW(t[0],t[1],t[2],this.hsva[3])}setRGBA(t){let e=rgb_to_hsv(t[0],t[1],t[2]);this.hsva.loadXYZW(e[0],e[1],e[2],t[3]),this._redraw(),this.onchange&&this.onchange(this.hsva)}clipboardCopy(){colorClipboardCopy.apply(this,arguments)}clipboardPaste(){colorClipboardPaste.apply(this,arguments)}_getPad(){return Math.max(this.getDefault("circleSize"),15)}_redraw(){let t=this.g,e=this.canvas,i=this.getDPI(),s=this.getDefault("width"),r=this.getDefault("hueHeight");e.width=~~(s*i),e.height=~~(r*i),e.style.width=s+"px",e.style.height=r+"px";let a=~~(this._getPad()*i),n=this.getDefault("circleSize")*i,o=e.width,l=e.height;o-=2*a,t.drawImage(getHueField(o,l,i),0,0,o,l,a,0,o,l);let h=this.hsva[0]*o+a,c=.5*e.height;t.beginPath(),t.arc(h,c,n,-Math.PI,Math.PI),t.closePath(),t.strokeStyle="white",t.lineWidth=3*i,t.stroke(),t.strokeStyle="grey",t.lineWidth=1*i,t.stroke(),this.disabled&&(t.beginPath(),t.fillStyle="rgba(25,25,25,0.75)",t.rect(0,0,this.canvas.width,this.canvas.height),t.fill())}on_disabled(){this._redraw()}on_enabled(){this._redraw()}}UIBase$5.internalRegister(HueField);class SatValField extends UIBase$5{constructor(){super(),this.hsva=[0,0,0,1],this.canvas=document.createElement("canvas"),this.g=this.canvas.getContext("2d"),this.shadow.appendChild(this.canvas),this.onchange=void 0;let t=(t,e)=>{let i=this._getField(),s=~~(this.getDefault("circleSize")*this.getDPI()),r=i.x2sat(t-s),a=i.y2val(e-s);this.hsva[1]=r,this.hsva[2]=a,this.onchange&&this.onchange(this.hsva),this._redraw()};this.addEventListener("keydown",(t=>{switch(t.keyCode){case keymap$4.Left:case keymap$4.Right:{let e=t.keyCode===keymap$4.Left?-1:1;this.hsva[1]=Math.min(Math.max(this.hsva[1]+.05*e,0),1),this._redraw(),this.onchange&&this.onchange(this.hsva);break}case keymap$4.Up:case keymap$4.Down:{let e=t.keyCode===keymap$4.Down?-1:1;this.hsva[2]=Math.min(Math.max(this.hsva[2]+.05*e,0),1),this._redraw(),this.onchange&&this.onchange(this.hsva);break}}})),this.canvas.addEventListener("mousedown",(e=>{if(this.modalRunning)return;e.preventDefault();let i=this.canvas.getClientRects()[0],s=e.clientX-i.x,r=e.clientY-i.y;t(s,r),this.pushModal({on_pointermove(t){this.on_mousemove(t)},on_mousemove:e=>{let i=this.canvas.getClientRects()[0];if(void 0===i)return;let s=e.clientX-i.x,r=e.clientY-i.y;t(s,r)},on_mousedown:t=>{this.popModal()},on_mouseup:t=>{this.popModal()},on_keydown:t=>{t.keyCode!==keymap$4.Enter&&t.keyCode!==keymap$4.Escape&&t.keyCode!==keymap$4.Space||this.popModal()}})})),this.canvas.addEventListener("touchstart",(e=>{if(this.modalRunning)return;e.preventDefault();let i=this.canvas.getClientRects()[0],s=e.touches[0].clientX-i.x,r=e.touches[0].clientY-i.y;t(s,r),this.pushModal({on_mousemove:e=>{let i,s,r=this.canvas.getClientRects()[0];e.touches&&e.touches.length?(i=e.touches[0].clientX-r.x,s=e.touches[0].clientY-r.y):(i=e.x,s=e.y),t(i,s)},on_touchmove:e=>{let i=this.canvas.getClientRects()[0],s=e.touches[0].clientX-i.x,r=e.touches[0].clientY-i.y;t(s,r)},on_mousedown:t=>{this.popModal()},on_touchcancel:t=>{this.popModal()},on_touchend:t=>{this.popModal()},on_mouseup:t=>{this.popModal()},on_keydown:t=>{t.keyCode!==keymap$4.Enter&&t.keyCode!==keymap$4.Escape&&t.keyCode!==keymap$4.Space||this.popModal()}})}))}static define(){return{tagname:"satvalfield-x",style:"colorfield",havePickClipboard:!0}}getRGBA(){let t=hsv_to_rgb(this.hsva[0],this.hsva[1],this.hsva[2]);return(new Vector4).loadXYZW(t[0],t[1],t[2],this.hsva[3])}setRGBA(t){let e=rgb_to_hsv(t[0],t[1],t[2]);this.hsva.loadXYZW(e[0],e[1],e[2],t[3]),this.update(!0),this._redraw(),this.onchange&&this.onchange(this.hsva)}clipboardCopy(){colorClipboardCopy.apply(this,arguments)}clipboardPaste(){colorClipboardPaste.apply(this,arguments)}_getField(){this.getDPI(),this.canvas;let t=this.getDefault("circleSize"),e=this.getDefault("width"),i=this.getDefault("height");return getFieldImage(this.getDefault("fieldSize"),e-2*t,i-2*t,this.hsva)}update(t=!1){super.update(),t&&this._redraw()}_redraw(){let t=this.g,e=this.canvas,i=this.getDPI(),s=this.getDefault("width"),r=this.getDefault("height");e.width=~~(s*i),e.height=~~(r*i),e.style.width=s+"px",e.style.height=r+"px";let a=~~(this.getDefault("circleSize")*i),n=this._getField(),o=n.canvas;t.globalAlpha=1,t.beginPath(),t.rect(0,0,e.width,e.height),t.fillStyle="rgb(200, 200, 200)",t.fill(),t.beginPath();let l=17,h=e.width/l,c=e.height/l;for(let e=0;e<289;e++){let i=e%l*h,s=~~(e/l)*c;e%2!=0&&t.rect(i,s,h,c)}t.fillStyle="rgb(110, 110, 110)",t.fill(),t.globalAlpha=this.hsva[3],t.drawImage(o,0,0,o.width,o.height,a,a,e.width-2*a,e.height-2*a);let d=this.hsva,u=n.sat2x(d[1])*i+a,p=n.val2y(d[2])*i+a,m=a;t.beginPath(),t.arc(u,p,m,-Math.PI,Math.PI),t.closePath(),t.strokeStyle="white",t.lineWidth=3*i,t.stroke(),t.strokeStyle="grey",t.lineWidth=1*i,t.stroke(),this.disabled&&(t.beginPath(),t.fillStyle="rgba(25,25,25,0.75)",t.rect(0,0,this.canvas.width,this.canvas.height),t.fill())}on_disabled(){this._redraw()}on_enabled(){this._redraw()}}UIBase$5.internalRegister(SatValField);class ColorField extends ColumnFrame{constructor(){super(),this.hsva=new Vector4([.05,.6,.15,1]),this.rgba=new Vector4([0,0,0,0]),this._recalcRGBA(),this._lastThemeStyle=this.constructor.define().style,this._last_dpi=void 0;let t=this.satvalfield=UIBase$5.createElement("satvalfield-x");t.hsva=this.hsva;let e=this.huefield=UIBase$5.createElement("huefield-x");e.hsva=this.hsva,e.onchange=t=>{this.satvalfield._redraw(),this._recalcRGBA(),this.onchange&&this.onchange(this.rgba)},t.onchange=t=>{this._recalcRGBA(),this.onchange&&this.onchange(this.rgba)},this._add(t),this._add(e)}static define(){return{tagname:"colorfield-x",style:"colorfield"}}setCMYK(t,e,i,s){let r=cmyk_to_rgb(t,e,i,s),a=rgb_to_hsv(r[0],r[1],r[2]);this.setHSVA(a[0],a[1],a[2],this.hsva[3])}getCMYK(){let t=hsv_to_rgb(this.hsva[0],this.hsva[1],this.hsva[2]);return rgb_to_cmyk(t[0],t[1],t[2])}setHSVA(t,e,i,s=1,r=!0){this.hsva[0]=t,this.hsva[1]=e,this.hsva[2]=i,this.hsva[3]=s,this._recalcRGBA(),this.update(!0),this.onchange&&r&&this.onchange(this.hsva,this.rgba)}_recalcRGBA(){let t=hsv_to_rgb(this.hsva[0],this.hsva[1],this.hsva[2]);return this.rgba[0]=t[0],this.rgba[1]=t[1],this.rgba[2]=t[2],this.rgba[3]=this.hsva[3],this}updateDPI(t=!1,e=!1){let i=this.getDPI(),s=t;if(s=s||i!=this._last_dpi,s)return this._last_dpi=i,e||this._redraw(),!0}getRGBA(){let t=hsv_to_rgb(this.hsva[0],this.hsva[1],this.hsva[2]);return(new Vector4).loadXYZW(t[0],t[1],t[2],this.hsva[3])}setRGBA(t,e,i,s=1,r=!0){"object"==typeof t&&(e=t[1],i=t[2],s=t[3],t=t[0]);let a=rgb_to_hsv(t,e,i);this.hsva[0]=a[0],this.hsva[1]=a[1],this.hsva[2]=a[2],this.hsva[3]=s,this._recalcRGBA(),this.update(!0),this.onchange&&r&&this.onchange(this.hsva,this.rgba)}updateThemeOverride(){let t=this.getStyleClass();if(t===this._lastThemeStyle)return!1;this._lastThemeStyle=t,this.huefield.overrideClass(t),this.satvalfield.overrideClass(t);for(let t=0;t<3;t++)this.flushSetCSS(),this.flushUpdate();return!0}update(t=!1){super.update(),this.updateThemeOverride();let e=this.updateDPI(t,!0);e=e||t,e&&(this.satvalfield.update(!0),this._redraw())}setCSS(){super.setCSS(),this.style["flex-grow"]=this.getDefault("flex-grow")}_redraw(){this.satvalfield._redraw(),this.huefield._redraw()}}UIBase$5.internalRegister(ColorField);class ColorPicker extends ColumnFrame{constructor(){super(),this._lastThemeStyle=this.constructor.define().style}get hsva(){return this.field.hsva}get rgba(){return this.field.rgba}set description(t){}static setDefault(t){let e,i=t;if(t.getClassDefault("usePanels")){let s=i=t.panel("Color");e=s.tabs(),s.closed=!0,s.style["flex-grow"]="unset",s.titleframe.style["flex-grow"]="unset"}else e=t.tabs();t.cssText=t.textbox(),t.cssText.onchange=e=>{if(!validateWebColor(e))return void t.cssText.flash("red");t.cssText.flash("green");let i=web2color(e=e.trim());t._no_update_textbox=!0,t.field.setRGBA(i[0],i[1],i[2],i[3]),t._setSliders(),t._no_update_textbox=!1};let s=e.tab("HSV");if(t.h=s.slider(void 0,"Hue",0,0,1,.001,!1,!0,(e=>{let i=t.hsva;t.setHSVA(e.value,i[1],i[2],i[3])})),t.s=s.slider(void 0,"Saturation",0,0,1,.001,!1,!0,(e=>{let i=t.hsva;t.setHSVA(i[0],e.value,i[2],i[3])})),t.v=s.slider(void 0,"Value",0,0,1,.001,!1,!0,(e=>{let i=t.hsva;t.setHSVA(i[0],i[1],e.value,i[3])})),t.a=s.slider(void 0,"Alpha",0,0,1,.001,!1,!0,(e=>{let i=t.hsva;t.setHSVA(i[0],i[1],i[2],e.value)})),t.h.baseUnit=t.h.displayUnit="none",t.s.baseUnit=t.s.displayUnit="none",t.v.baseUnit=t.v.displayUnit="none",t.a.baseUnit=t.a.displayUnit="none",s=e.tab("RGB"),t.r=s.slider(void 0,"R",0,0,1,.001,!1,!0,(e=>{let i=t.rgba;t.setRGBA(e.value,i[1],i[2],i[3])})),t.g=s.slider(void 0,"G",0,0,1,.001,!1,!0,(e=>{let i=t.rgba;t.setRGBA(i[0],e.value,i[2],i[3])})),t.b=s.slider(void 0,"B",0,0,1,.001,!1,!0,(e=>{let i=t.rgba;t.setRGBA(i[0],i[1],e.value,i[3])})),t.a2=s.slider(void 0,"Alpha",0,0,1,.001,!1,!0,(e=>{let i=t.rgba;t.setRGBA(i[0],i[1],i[2],e.value)})),t.r.baseUnit=t.r.displayUnit="none",t.g.baseUnit=t.g.displayUnit="none",t.b.baseUnit=t.b.displayUnit="none",t.a2.baseUnit=t.a2.displayUnit="none",!t.getDefault("noCMYK")){s=e.tab("CMYK");let i=t.getCMYK(),r=(e,r)=>{let a=s.slider(void 0,{name:e,min:0,max:1,is_int:!1,defaultval:i[r],callback:e=>{let i=t.getCMYK();i[r]=e.value,t.setCMYK(i[0],i[1],i[2],i[3])},step:.001});return a.baseUnit=a.displayUnit="none",a};t.cmyk=[r("C",0),r("M",1),r("Y",2),r("K",3)]}t._setSliders()}static define(){return{tagname:"colorpicker-x",style:"colorfield",havePickClipboard:!0,copyForAllChildren:!0,pasteForAllChildren:!0}}clipboardCopy(){colorClipboardCopy.apply(this,arguments)}clipboardPaste(){colorClipboardPaste.apply(this,arguments)}init(){super.init(),this.field=UIBase$5.createElement("colorfield-x"),this.field.setAttribute("class","colorpicker"),this.field.packflag|=this.inherit_packflag,this.field.packflag|=this.packflag,this.field.onchange=()=>{this._setDataPath(),this._setSliders(),this.onchange&&this.onchange(this.field.rgba)};let t=document.createElement("style");t.textContent=`\n      .colorpicker {\n        background-color : ${this.getDefault("background-color")};\n      }\n    `,this._style=t;let e=this.colorbox=document.createElement("div");e.style.width="100%",e.style.height=this.getDefault("colorBoxHeight")+"px",e.style["background-color"]="black",this.shadow.appendChild(t),this.field.ctx=this.ctx,this.add(this.colorbox),this.add(this.field),this.style.width=this.getDefault("width")+"px"}updateColorBox(){let t=this.field.rgba[0],e=this.field.rgba[1],i=this.field.rgba[2];t=~~(255*t),e=~~(255*e),i=~~(255*i);let s=`rgb(${t},${e},${i})`;this.colorbox.style["background-color"]=s}_setSliders(){if(void 0===this.h)return void console.warn("colorpicker ERROR");let t=this.field.hsva;this.h.setValue(t[0],!1),this.s.setValue(t[1],!1),this.v.setValue(t[2],!1),this.a.setValue(t[3],!1);let e=this.field.rgba;if(this.r.setValue(e[0],!1),this.g.setValue(e[1],!1),this.b.setValue(e[2],!1),this.a2.setValue(e[3],!1),this.cmyk){let t=this.field.getCMYK();for(let e=0;e<4;e++)this.cmyk[e].setValue(t[e],!1)}this.updateColorBox(),this._no_update_textbox||(this.cssText.text=color2web(this.field.rgba))}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getPathMeta(this.ctx,this.getAttribute("datapath")),e=this.getPathValue(this.ctx,this.getAttribute("datapath"));void 0!==e?(this.internalDisabled=!1,_update_temp.load(e),t.type===PropTypes$8.VEC3&&(_update_temp[3]=1),_update_temp.vectorDistance(this.field.rgba)>.01&&(this.field.setRGBA(_update_temp[0],_update_temp[1],_update_temp[2],_update_temp[3],!1),this._setSliders(),this.field.update(!0))):this.internalDisabled=!0}updateThemeOverride(){let t=this.getStyleClass();return t!==this._lastThemeStyle&&(this._lastThemeStyle=t,this.field.overrideClass(t),this.flushSetCSS(),this.flushUpdate(),!0)}update(){this.updateThemeOverride(),this.hasAttribute("datapath")&&this.updateDataPath(),super.update()}_setDataPath(){if(this.hasAttribute("datapath")){let t=this.getPathMeta(this.ctx,this.getAttribute("datapath"));void 0===t&&console.warn("Bad data path for color field:",this.getAttribute("datapath"));let e=this.field.rgba;void 0!==t&&t.type===PropTypes$8.VEC3&&(e=new Vector3,e.load(this.field.rgba)),this.setPathValue(this.ctx,this.getAttribute("datapath"),e)}}getCMYK(){return this.field.getCMYK()}setCMYK(t,e,i,s){this.field.setCMYK(t,e,i,s),this._setSliders(),this._setDataPath()}setHSVA(t,e,i,s){this.field.setHSVA(t,e,i,s),this._setSliders(),this._setDataPath()}getRGBA(){return this.field.getRGBA()}setRGBA(t,e,i,s){this.field.setRGBA(t,e,i,s),this._setSliders(),this._setDataPath()}}UIBase$5.internalRegister(ColorPicker);class ColorPickerButton extends UIBase$5{constructor(){super(),this._highlight=!1,this._depress=!1,this._label="error",this.customLabel=void 0,this.rgba=new Vector4([1,1,1,1]),this.labelDom=document.createElement("span"),this.labelDom.textContent=this._label,this.dom=document.createElement("canvas"),this.g=this.dom.getContext("2d"),this.shadow.appendChild(this.labelDom),this.shadow.appendChild(this.dom)}get label(){return this._label}set label(t){this._label=t,this.labelDom.textContent=t}get font(){return this._font}set font(t){this._font=t,this.setCSS()}get noLabel(){let t=""+this.getAttribute("no-label");return t=t.toLowerCase(),"true"===t||"yes"===t||"on"===t}set noLabel(t){this.labelDom&&(this.labelDom.hidden=!0),this.setAttribute("no-label",t?"true":"false")}static define(){return{tagname:"color-picker-button-x",style:"colorpickerbutton",havePickClipboard:!0}}init(){super.init(),this._font="DefaultText";let t=t=>{this._highlight=!1,this._redraw()};this.addEventListener("pointerover",(t=>{this._highlight=!0,this._redraw()}),{capture:!0,passive:!0}),this.addEventListener("pointerout",t,{capture:!0,passive:!0}),this.addEventListener("focus",t,{capture:!0,passive:!0}),this.addEventListener("mousedown",(t=>{t.preventDefault(),this.click(t)})),this.setCSS()}clipboardCopy(){colorClipboardCopy.apply(this,arguments)}clipboardPaste(){colorClipboardPaste.apply(this,arguments)}getRGBA(){return this.rgba}click(t){this.abortToolTips(4e3),console.warn("CLICK COLORPICKER"),this.blur(),this.onclick&&this.onclick(t);let e=this.ctx.screen.popup(this,this),i=contextWrangler.makeSafeContext(this.ctx);e.ctx=i,e.useDataPathUndo=this.useDataPathUndo;let s=this.hasAttribute("datapath")?this.getAttribute("datapath"):void 0,r=e.colorPicker(s,void 0,this.getAttribute("mass_set_path"));r.ctx=i,r._init(),r.setRGBA(this.rgba[0],this.rgba[1],this.rgba[2],this.rgba[3]),r.style.padding="20px";r.onchange=()=>{this.rgba.load(r.rgba),this.redraw(),this.onchange&&this.onchange(this)},e.style["background-color"]=r.getDefault("background-color"),e.style["border-width"]=r.getDefault("border-width")}setRGBA(t){let e=this.rgba[3],i=new Vector4(this.rgba);if(this.rgba.load(t),t.length<4&&(this.rgba[3]=e),!(this.rgba.vectorDistance(i)<.001))return this.hasAttribute("datapath")&&this.setPathValue(this.ctx,this.getAttribute("datapath"),this.rgba),this.onchange&&this.onchange(),this._redraw(),this}on_disabled(){this.setCSS(),this._redraw()}_redraw(){let t=this.dom,e=this.g;if(e.clearRect(0,0,t.width,t.height),this.disabled){let i="rgb(55, 55, 55)";e.save(),drawRoundBox(this,t,e,t.width,t.height,void 0,"fill",i),drawRoundBox(this,t,e,t.width,t.height,void 0,"clip");let s=5,r=t.width/s,a=0;e.beginPath(),e.lineWidth=2,e.strokeStyle="black";for(let i=0;i<s;i++,a+=r)e.moveTo(a,0),e.lineTo(a+r,t.height),e.moveTo(a+r,0),e.lineTo(a,t.height);return e.stroke(),void e.restore()}e.save();drawRoundBox(this,t,e,t.width,t.height,void 0,"clip"),drawRoundBox(this,t,e,t.width,t.height,void 0,"fill","rgb(100, 100, 100)");let i=10,s=Math.ceil(t.width/i),r=Math.ceil(t.height/i);drawRoundBox(this,t,e,t.width,t.height,void 0,"clip",void 0,void 0,!0),e.clip(),e.beginPath();for(let t=0;t<s;t++)for(let s=0;s<r;s++)t+s&1||e.rect(t*i,s*i,i,i);e.fillStyle="rgb(175, 175, 175)",e.fill();let a=color2css(this.rgba);if(drawRoundBox(this,t,e,t.width,t.height,void 0,"fill",a,void 0,!0),this._highlight){let i=this.getDefault("BoxHighlight");drawRoundBox(this,t,e,t.width,t.height,void 0,"fill",i)}e.restore()}setCSS(){super.setCSS();let t=this.getDefault("width"),e=this.getDefault("height"),i=this.getDPI();this.style.width="min-contentspx",this.style.height=e+"px",this.style["flex-direction"]="row",this.style.display="flex",this.labelDom.style.color=this.getDefault(this._font).color,this.labelDom.style.font=getFont(this,void 0,this._font,!1);let s=this.dom;s.style.width=t+"px",s.style.height=e+"px",s.width=~~(t*i),s.height=~~(e*i),this.style["background-color"]="rgba(0,0,0,0)",this._redraw()}updateDataPath(){if(!this.hasAttribute("datapath"))return;let t=this.getAttribute("datapath"),e=this.getPathMeta(this.ctx,t);if((void 0===e||void 0===e.data)&&exports.DEBUG.verboseDataPath)return void console.log("bad path",t);if(void 0===e){let t=!this.disabled;return this.internalDisabled=!0,void(t&&this._redraw())}let i=this.disabled;this.internalDisabled=!1,void 0===this.customLabel&&e.uiname!==this._label&&(this.label=e.uiname);let s=this.getPathValue(this.ctx,t);if(void 0===s)i=i||!0!==this.disabled,this.internalDisabled=!0,i&&this._redraw();else{let t;this.internalDisabled=!1,t=3===s.length?Vector3.prototype.vectorDistance.call(s,this.rgba):this.rgba.vectorDistance(s),t>1e-4&&(e.type===PropTypes$8.VEC3?(this.rgba.load(s),this.rgba[3]=1):this.rgba.load(s),i=!0),i&&this._redraw()}}update(){super.update(),this.noLabel&&this.labelDom.isConnected&&this.labelDom.remove(),void 0!==this.customLabel&&this.customLabel!==this._label&&(this.label=this.customLabel);for(let t=0;t<this.rgba.length;t++)void 0===this.rgba[t]&&(console.warn("corrupted color or alpha detected",this.rgba),this.rgba[t]=1);let t=this.rgba[0].toFixed(4)+" "+this.rgba[1].toFixed(4)+" "+this.rgba[2].toFixed(4)+" "+this.rgba[3].toFixed(4);t+=this.disabled,t!==this._last_key&&(this._last_key=t,this.redraw()),this.hasAttribute("datapath")&&this.updateDataPath()}redraw(){this._redraw()}}UIBase$5.internalRegister(ColorPickerButton);let UIBase$4=UIBase$f,PackFlags$2=PackFlags$a,IconSheets$1=IconSheets$7,iconmanager=iconmanager$1,tab_idgen=1,debug=!1,Vector2$3=Vector2$b;function getpx$1(t){return parseFloat(t.trim().replace("px",""))}let FAKE_TAB_ID=Symbol("fake_tab_id");class TabDragEvent extends PointerEvent{}class TabItem extends UIBase$4{constructor(){super(),this.name=name,this.icon=void 0,this.tooltip="",this.movable=!0,this.tbar=void 0,this.ontabclick=null,this.ontabdragstart=null,this.ontabdragmove=null,this.ontabdragend=null;let t=t=>{let e="on"+t;this.addEventListener(t,(t=>{if(this[e])return this[e](t)}))};t("tabclick"),t("tabdragstart"),t("tabdragmove"),t("tabdragend"),this.dom=void 0,this.extra=void 0,this.extraSize=void 0,this.size=new Vector2$3,this.pos=new Vector2$3,this.abssize=new Vector2$3,this.abspos=new Vector2$3,this.addEventListener("pointerdown",(t=>{this.parentWidget.on_pointerdown(t)})),this.addEventListener("pointermove",(t=>{this.parentWidget.on_pointermove(t)})),this.addEventListener("pointerup",(t=>{this.parentWidget.on_pointerup(t)})),this.addEventListener("keydown",(t=>{switch(t.keyCode){case keymap$4.Enter:case keymap$4.Space:this.parentWidget.setActive(this,t)}}))}init(){this.tabIndex=1}static define(){return{tagname:"tab-item-x"}}sendEvent(t,e){let i;i="tabdragstart"===t||"tabdragend"===t?TabDragEvent:e&&e instanceof Event?e.constructor:PointerEvent;let s={};if(e)for(let t in e)"defaultPrevented"!==t&&"cancelBubble"!==t&&(s[t]=e[t]);return s.target=this,s=new i(t,s),this.dispatchEvent(s),s}getClientRects(){let t=this.tbar.getClientRects()[0],e=this.abssize,i=this.abspos;return e.load(this.size),i.load(this.pos),t&&(i[0]+=t.x,i[1]+=t.y),[{x:i[0],y:i[1],width:e[0],height:e[1],left:i[0],top:i[1],right:i[0]+e[0],bottom:i[1]+e[1]}]}setCSS(){let t=UIBase$4.getDPI(),e=this.pos[0]/t,i=this.pos[1]/t,s=this.size[0]/t,r=this.size[1]/t;this==this.parentWidget.tabs.active?this.style["focus-border-width"]="0px":this.style["focus-border-width"]="2px",this.style["background-color"]="transparent",this.style.margin=this.style.padding="0px",this.style.position="absolute",this.style["pointer-events"]="auto",this.style.left=e+"px",this.style.top=i+"px",this.style.width=s+"px",this.style.height=r+"px"}}UIBase$4.internalRegister(TabItem);class ModalTabMove extends EventHandler{constructor(t,e,i){super(),this.dom=i,this.tab=t,this.tbar=e,this.first=!0,this.droptarget=void 0,this.start_mpos=new Vector2$3,this.mpos=void 0,this.dragtab=void 0,this.dragstate=!1,this.finished=!1}finish(){debug&&debug&&console.log("finish"),this.finished||(this.finished=!0,this.tbar.tool===this&&(this.tbar.tool=void 0),this.popModal(this.dom),this.tbar.update(!0))}popModal(){void 0!==this.dragcanvas&&this.dragcanvas.remove();let t=super.popModal(...arguments);return this.tab.sendEvent("tabdragend"),t}on_pointerenter(t){}on_pointerleave(t){}on_pointerstart(t){}on_pointerend(t){}on_pointerdown(t){this.finish()}on_pointercancel(t){this.finish()}on_pointerup(t){this.finish()}on_pointermove(t){return this._on_move(t,t.x,t.y)}_dragstate(t,e,i){this.dragcanvas.style.left=e+"px",this.dragcanvas.style.top=i+"px";let s=this.tbar.ctx.screen.pickElement(e,i);new DragEvent("dragenter",this.dragevent);if(s!==this.droptarget){let t=new DragEvent("dragexit",this.dragevent);this.droptarget&&this.droptarget.dispatchEvent(t),t=new DragEvent("dragover",this.dragevent),this.droptarget=s,s&&s.dispatchEvent(t)}}_on_move(t,e,i){let s,r,a=this.tbar.getClientRects()[0],n=UIBase$4.getDPI();if(void 0===a)return void this.finish();if(this.dragstate)return void this._dragstate(t,e,i);e-=a.x,i-=a.y,e*=n,i*=n,this.first&&(this.first=!1,this.start_mpos[0]=e,this.start_mpos[1]=i),void 0===this.mpos?(this.mpos=[0,0],s=r=0):(s=e-this.mpos[0],r=i-this.mpos[1]),debug&&console.log(e,i,s,r);let o,l=this.tab,h=this.tbar,c=h.horiz?0:1;h.horiz?(l.pos[0]+=s,o=Math.abs(i-this.start_mpos[1])):(l.pos[1]+=r,o=Math.abs(e-this.start_mpos[0]));let d=h.horiz?this.tbar.canvas.width:this.tbar.canvas.height,u=l.pos[c]+l.size[c]<-50||l.pos[c]>=d+50;if(u=u||o>75,u=u&&(this.tbar.draggable||this.tbar.getAttribute("draggable")),u){this.dragstate=!0,this.dragevent=new DragEvent("dragstart",{dataTransfer:new DataTransfer}),this.dragtab=l;let e=this.tbar.g;this.dragimg=e.getImageData(~~l.pos[0],~~l.pos[1],~~l.size[0],~~l.size[1]),this.dragcanvas=document.createElement("canvas");let i=this.drag_g=this.dragcanvas.getContext("2d");return this.dragcanvas.visibleToPick=!1,this.dragcanvas.width=~~l.size[0],this.dragcanvas.height=~~l.size[1],this.dragcanvas.style.width=l.size[0]/n+"px",this.dragcanvas.style.height=l.size[1]/n+"px",this.dragcanvas.style.position=UIBase$4.PositionKey,this.dragcanvas.style.left=t.x+"px",this.dragcanvas.style.top=t.y+"px",this.dragcanvas.style["z-index"]="500",document.body.appendChild(this.dragcanvas),i.putImageData(this.dragimg,0,0),void this.tbar.dispatchEvent(this.dragevent)}let p=h.tabs.indexOf(l),m=p<h.tabs.length-1?h.tabs[p+1]:void 0,f=p>0?h.tabs[p-1]:void 0;void 0!==m&&m.movable&&l.pos[c]>m.pos[c]?h.swapTabs(l,m):void 0!==f&&f.movable&&l.pos[c]<f.pos[c]+.5*f.size[c]&&h.swapTabs(l,f),h.update(!0),this.mpos[0]=e,this.mpos[1]=i,l.sendEvent("tabdragmove",t).defaultPrevented&&this.finish()}on_keydown(t){switch(debug&&console.log(t.keyCode),t.keyCode){case keymap$4.Escape:case keymap$4.Space:case keymap$4.Enter:case keymap$4.Tab:this.finish()}}}class TabBar extends UIBase$4{constructor(){super();let t=document.createElement("style"),e=document.createElement("canvas");this.iconsheet=0,this.movableTabs=!0,this.tabFontScale=1,this.tabs=[],this.tabs.active=void 0,this.tabs.highlight=void 0,this._last_style_key=void 0,e.style.width="145px",e.style.height="45px",this.r=this.getDefault("TabBarRadius",void 0,8),this.canvas=e,this.g=e.getContext("2d"),this.canvas.style["touch-action"]="none",t.textContent="\n    ",this.shadow.appendChild(t),this.shadow.appendChild(e),this._last_dpi=void 0,this._last_pos=void 0,this.horiz=!0,this.onchange=null,this.onselect=null,this.canvas.addEventListener("pointermove",(t=>{this.on_pointermove(t)}),!1),this.canvas.addEventListener("pointerdown",(t=>{this.on_pointerdown(t)}))}_doelement(t,e,i){for(let t of this.tabs){let s;s=this.horiz?e>=t.pos[0]&&e<=t.pos[0]+t.size[0]:i>=t.pos[1]&&i<=t.pos[1]+t.size[1],s&&this.tabs.highlight!==t&&(this.tabs.highlight=t,this.update(!0))}}_domouse(t){let e=this.canvas.getClientRects()[0],i=t.x-e.x,s=t.y-e.y,r=this.getDPI();i*=r,s*=r,this._doelement(t,i,s);("mousedown"===t.type||"pointerdown"==t.type)&&this.onselect&&this._fireOnSelect().defaultPrevented&&t.preventDefault()}_doclick(t){if(this._domouse(t),t.defaultPrevented)return;if(debug&&console.log("mdown"),0!==t.button)return;let e=this.tabs.highlight,i={};for(let e in t)"defaultPrevented"!==e&&"cancelBubble"!==e&&(i[e]=t[e]);i.target=e,i.pointerId=t.pointerId,i=new PointerEvent("tabactive",i),e.sendEvent("tabclick",t).defaultPrevented&&i.preventDefault(),void 0!==e&&void 0===this.tool&&(this.setActive(e,i),this.movableTabs&&!i.defaultPrevented&&this._startMove(e,t),t.preventDefault(),t.stopPropagation())}on_pointerdown(t){this._doclick(t)}on_pointermove(t){this.canvas.getClientRects()[0];this._domouse(t),t.preventDefault(),t.stopPropagation()}on_pointerup(t){}static setDefault(t){return t.setAttribute("bar_pos","top"),t.updatePos(!0),t}static define(){return{tagname:"tabbar-x",style:"tabs"}}_ensureNoModal(){this.tool&&(this.tool.finish(),this.tool=void 0)}get tool(){return this._tool}set tool(t){this._tool=t}_startMove(t=this.tabs.active,e,i=(e?e.pointerId:void 0),s=t){if(this.movableTabs){if(t.sendEvent("tabdragstart",e).defaultPrevented)return;this.tool&&this.tool.finish();let r=this.getScreen(),a=this.tool=new ModalTabMove(t,this,r);e&&s&&void 0!==i?a.pushPointerModal(s,i):a.pushModal(r,!1)}}_fireOnSelect(){let t=this._makeOnSelectEvt();return this.onselect&&this.onselect(t),t}_makeOnSelectEvt(){return{tab:this.tabs.highlight,defaultPrevented:!1,preventDefault(){this.defaultPrevented=!0}}}getTab(t){for(let e of this.tabs)if(e.id===t||e.name===t)return e}clear(){for(let t of this.tabs)t.dom&&t.dom.remove(),t.remove();this.tabs=[],this.setCSS(),this._redraw()}saveData(){let t=[];for(let e of this.tabs)t.push(e.name);return{taborder:t,active:void 0!==this.tabs.active?this.tabs.active.name:"null"}}loadData(t){if(!t.taborder)return;let e,i=this.tabs,s=[];s.active=void 0,s.highlight=void 0;for(let i of t.taborder){let r=this.getTab(i);void 0!==r&&(r.name===t.active&&(e=r),s.push(r))}for(let t of i)s.indexOf(t)<0&&s.push(t);this.tabs=s;try{void 0!==e?this.setActive(e):this.tabs.length>0&&this.setActive(this.tabs[0])}catch(t){print_stack$1(t)}return this.update(!0),this}swapTabs(t,e){let i=this.tabs,s=i.indexOf(t),r=i.indexOf(e);i[s]=e,i[r]=t,this.update(!0)}addIconTab(t,e,i,s=!0){let r=this.addTab("",e,i,s);return r.icon=t,r}addTab(t,e,i="",s){let r=UIBase$4.createElement("tab-item-x",!0);return this.shadow.appendChild(r),r.parentWidget=this,r.name=t,r.id=e,r.tooltip=i,r.movable=s,r.tbar=this,this.tabs.push(r),this.update(!0),1===this.tabs.length&&this.setActive(this.tabs[0]),r}updatePos(t=!1){let e=this.getAttribute("bar_pos");(e!==this._last_pos||t)&&(this._last_pos=e,this.horiz="top"===e||"bottom"===e,debug&&console.log("tab bar position update",this.horiz),this.horiz?(this.style.width="100%",delete this.style.height):(this.style.height="100%",delete this.style.width),this._redraw())}updateDPI(t=!1){let e=this.getDPI();e!==this._last_dpi&&(debug&&console.log("DPI update!"),this._last_dpi=e,this.updateCanvas(!0))}updateCanvas(t=!1){let e=this.canvas,i=this.getDPI(),s=~~(getpx$1(this.canvas.style.width)*i),r=~~(getpx$1(this.canvas.style.height)*i),a=t;a=a||e.width!==s||e.height!==r,a&&(e.width=s,e.height=r,this._redraw())}_getFont(t){let e=this.getDefault("TabText");return 1!==this.tabFontScale&&(e=e.copy(),e.size*=this.tabFontScale),e}_layout(){this.ctx&&this.ctx.screen||this.isDead()||this.doOnce(this._layout);let t=this.g;debug&&console.log("tab layout");let e=this.getDPI(),i=this._getFont(),s=i.size*e;t.font=i.genCSS(s);let r=this.horiz?0:1,a=4*e+Math.ceil(.25*s),n=this.getDefault("TabPadding",void 0,0),o=a,l=s+Math.ceil(.5*s)+n,h=iconmanager.getTileSize(this.iconsheet),c=!1;for(let t of this.tabs)if(void 0!==t.icon){c=!0,l=Math.max(l,h+4);break}this.parentWidget&&this.parentWidget.getClientRects()[0];let d=this.canvas.getClientRects()[0],u=0,p=0;d&&(u=d.x,p=d.y);let m=t=>{t.watcher&&clearInterval(t.watcher.timer);let e=()=>{let e=this.tabs.indexOf(t)<0;e=e||this.isDead(),e&&(t.dom&&t.dom.remove(),t.dom=void 0,t.watcher.timer&&clearInterval(t.watcher.timer))};return t.watcher=e,t.watcher.timer=window.setInterval(e,750),t.watcher.timer},f=!1;for(let t of this.tabs)t.extra&&(f=!0);f&&this.ctx&&this.ctx.screen&&!this._size_cb&&(this._size_cb=()=>{if(this.isDead())return this.ctx.screen.removeEventListener("resize",this._size_cb),void(this._size_cb=void 0);this.ctx&&(this._layout(),this._redraw())},this.ctx.screen.addEventListener("resize",this._size_cb));for(let i of this.tabs){if(i.extra&&!i.dom){i.dom=document.createElement("div"),i.dom.style.margin=i.dom.style.padding="0px",document.body.appendChild(i.dom),i.dom.style.position=UIBase$4.PositionKey,i.dom.style.display="flex",i.dom.style["flex-direction"]=this.horiz?"row":"column",i.dom.style["pointer-events"]="none",this.horiz,i.dom.style.width=i.size[0]/e+"px",i.dom.style.height=i.size[1]/e+"px",i.dom.style.left=u+i.pos[0]/e+"px",i.dom.style.top=p+i.pos[1]/e+"px";let t=this._getFont();i.dom.style.font=t.genCSS(),i.dom.style.color=t.color,i.dom.appendChild(i.extra),m(i)}let s=t.measureText(i.name).width;i.extra&&(s+=i.extraSize||i.extra.getClientRects()[0].width),void 0!==i.icon&&(s+=h),void 0!==this.tool&&i===this.tabs.active||(i.pos[r]=o,i.pos[1^r]=0),i.size[r]=s+2*a,i.size[1^r]=l,o+=s+2*a}o=~~(o+a)/e,l=~~l/e,this.horiz?(this.canvas.style.width=o+"px",this.canvas.style.height=l+"px"):(this.canvas.style.height=o+"px",this.canvas.style.width=l+"px");for(let t of this.tabs)t.setCSS()}setActive(t,e){if(t.noSwitch)return;let i=t!==this.tabs.active;this.tabs.active=t,i&&(!isMobile()&&this.getDefault("focus-on-tab-click")&&t.focus({preventScroll:!0,focusVisible:!1}),this.onchange&&this.onchange(t,e),this.update(!0))}_redraw(){let t=this.g,e=this.getDefault("TabActive")||"rgba(0,0,0,0)";debug&&console.log("tab draw"),t.clearRect(0,0,this.canvas.width,this.canvas.height);let i=this.getDPI(),s=this._getFont(),r=s.size,a=iconmanager.getTileSize(this.iconsheet);r*=i,t.font=s.genCSS(r),t.lineWidth=2,t.strokeStyle=this.getDefault("TabStrokeStyle1");let n,o=this.r*i;this._layout();const l=(e,i,s)=>{let r=this.getDefault("TabPadding",void 0,0);this.horiz?s+=.5*r:s-=.5*r,t.fillText(n.name,i,s)};let h=-1;for(n of this.tabs){if(h++,n===this.tabs.active)continue;let e=n.pos[0],i=n.pos[1],o=n.size[0],c=n.size[1],d=measureText(this,n.name,this.canvas,t,r,s).width,u=e+.5*(n.size[1^this.horiz]-d),p=i+r;if(n===this.tabs.highlight){let s=2;t.beginPath(),t.rect(e+s,i+s,o-2*s,c-2*s),t.fillStyle=this.getDefault("TabHighlight"),t.fill()}if(t.fillStyle=this.getDefault("TabText").color,!this.horiz){let e=0,i=p;t.save(),t.translate(e,i),t.rotate(Math.PI/2),t.translate(e-r,-i-.5*r)}void 0!==n.icon&&(iconmanager.canvasDraw(this,this.canvas,t,n.icon,e,i,this.iconsheet),u+=a+4),l(n.name,u,p),this.horiz||t.restore();let m=this.tabs[Math.max(h-1+this.tabs.length,0)],f=this.tabs[Math.min(h+1,this.tabs.length-1)];n!==this.tabs[this.tabs.length-1]&&m!==this.tabs.active&&f!==this.tabs.active&&(t.beginPath(),this.horiz?(t.moveTo(e+o,c-5),t.lineTo(e+o,5)):(t.moveTo(o-5,i+c),t.lineTo(5,i+c)),t.strokeStyle=this.getDefault("TabStrokeStyle1"),t.stroke())}if(n=this.tabs.active,n){let i=n.pos[0],a=n.pos[1],h=n.size[0],c=n.size[1],d=measureText(this,n.name,this.canvas,t,r,s).width;this.horiz?c+=2:h+=2;let u=i+.5*(n.size[1^this.horiz]-d),p=a+r;if(n===this.tabs.active){t.beginPath();let s=2;t.strokeStyle=this.getDefault("TabStrokeStyle2"),t.fillStyle=e;let d=1.5*o;this.horiz?(t.moveTo(i-o,c),t.quadraticCurveTo(i,c,i,c-o),t.lineTo(i,d),t.quadraticCurveTo(i,s,i+d,s),t.lineTo(i+h-d,s),t.quadraticCurveTo(i+h,0,i+h,d),t.lineTo(i+h,c-d),t.quadraticCurveTo(i+h,c,i+h+o,c),t.stroke(),t.closePath()):(t.moveTo(h,a-o),t.quadraticCurveTo(h,a,h-o,a),t.lineTo(d,a),t.quadraticCurveTo(s,a,s,a+d),t.lineTo(s,a+c-d),t.quadraticCurveTo(0,a+c,d,a+c),t.lineTo(h-d,a+c),t.quadraticCurveTo(h,a+c,h,a+c+o),t.stroke(),t.closePath());this.horiz?this.canvas.width:this.canvas.height;let m=t.lineWidth;if(t.lineWidth*=.5,t.fill(),t.lineWidth=m,!this.horiz){let e=0,i=p;t.save(),t.translate(e,i),t.rotate(Math.PI/2),t.translate(-e-r,-i-.5*r)}t.fillStyle=this.getDefault("TabText").color,l(n.name,u,p),this.horiz||t.restore()}}}removeTab(t){this.tabs.remove(t),t===this.tabs.active&&(this.tabs.active=this.tabs[0]),this._layout(),this._redraw(),this.setCSS()}setCSS(){super.setCSS(!1),this.style.contain="layout",this.r=this.getDefault("TabBarRadius",void 0,8);let t=void 0!==this.r?this.r:3;this.style["touch-action"]="none",this.canvas.style["background-color"]=this.getDefault("TabInactive"),this.canvas.style["border-radius"]=t+"px"}updateStyle(){let t=""+this.getDefault("background-color");t+=this.getDefault("TabActive"),t+=this.getDefault("TabInactive"),t+=this.getDefault("TabBarRadius"),t+=this.getDefault("TabStrokeStyle1"),t+=this.getDefault("TabStrokeStyle2"),t+=this.getDefault("TabHighlight"),t+=JSON.stringify(this.getDefault("TabText")),t+=this.tabFontScale,t!==this._last_style_key&&(this._last_style_key=t,this._layout(),this.setCSS(),this._redraw())}update(t=!1){let e=this.getClientRects()[0];if(e){let t=Math.floor(4*e.x)+":"+Math.floor(4*e.y);t!==this._last_p_key&&(this._last_p_key=t,this._layout())}super.update(),this.updateStyle(),this.updatePos(t),this.updateDPI(t),this.updateCanvas(t)}}UIBase$4.internalRegister(TabBar);class TabContainer extends UIBase$4{constructor(){super(),this._last_style_key="",this.dataPrefix="",this.inherit_packflag=0,this.packflag=0,this.tabFontScale=1,this.tbar=UIBase$4.createElement("tabbar-x"),this.tbar.parentWidget=this,this.tbar.setAttribute("class","_tbar_"+this._id),this.tbar.constructor.setDefault(this.tbar),this.tbar.tabFontScale=this.tabFontScale,this._remakeStyle(),this.tabs={},this._last_horiz=void 0,this._last_bar_pos=void 0,this._tab=void 0;let t=document.createElement("div");t.setAttribute("class",`_tab_${this._id}`),t.appendChild(this.tbar),this.shadow.appendChild(t),this.tbar.parentWidget=this,this.tbar.onselect=t=>{this.onselect&&this.onselect(t)},this.tbar.onchange=(t,e)=>{this._tab&&HTMLElement.prototype.remove.call(this._tab),this._tab=this.tabs[t.id],this._tab.parentWidget=this;for(let t=0;t<2;t++)this._tab.flushUpdate();let i=document.createElement("div");this.tbar.setCSS.once((()=>i.style["background-color"]=this.getDefault("background-color")),i),i.setAttribute("class",`_tab_${this._id}`),i.appendChild(this._tab),this.shadow.appendChild(i),this.onchange&&this.onchange(t,e)}}get movableTabs(){let t;return this.hasAttribute("movable-tabs")?t=""+this.getAttribute("movable-tabs"):(t=this.getDefault("movable-tabs"),null==t&&(t="true"),"boolean"!=typeof t&&"number"!=typeof t||(t=t?"true":"false")),t=t.toLowerCase(),"true"===t}set movableTabs(t){t=!!t,this.setAttribute("movable-tabs",t?"true":"false"),this.tbar.movableTabs=this.movableTabs}get hideScrollBars(){let t=(""+this.getAttribute("hide-scrollbars")).toLowerCase();return"true"===t||"yes"===t}set hideScrollBars(t){t=!!t,this.setAttribute("hide-scrollbars",""+t)}static setDefault(t){return t.setAttribute("bar_pos","top"),t}static define(){return{tagname:"tabcontainer-x",style:"tabs"}}_startMove(t=this.tbar.tabs.active,e){return this.tbar._startMove(t,e)}_ensureNoModal(){return this.tbar._ensureNoModal()}saveData(){let t=super.saveData()||{};t.tabs={};for(let e in this.tabs){let i=this.tabs[e];if(e!==this.tbar.tabs.active.id)try{t.tabs[i.id]=JSON.parse(saveUIData(i,"tab"))}catch(t){console.error("Failed to save tab UI layout",i.id)}}return t}loadData(t){if(t.tabs)for(let e in t.tabs){if(!(e in this.tabs))continue;let i=JSON.stringify(t.tabs[e]);loadUIData(this.tabs[e],i)}}enableDrag(){this.tbar.draggable=this.draggable=!0,this.tbar.addEventListener("dragstart",(t=>{this.dispatchEvent(new DragEvent("dragstart",t))})),this.tbar.addEventListener("dragover",(t=>{this.dispatchEvent(new DragEvent("dragover",t))})),this.tbar.addEventListener("dragexit",(t=>{this.dispatchEvent(new DragEvent("dragexit",t))}))}clear(){this.tbar.clear(),void 0!==this._tab&&(HTMLElement.prototype.remove.call(this._tab),this._tab=void 0),this.tabs={}}init(){super.init(),this.background=this.getDefault("background-color")}setCSS(){super.setCSS(),this.background=this.getDefault("background-color"),this._remakeStyle()}_remakeStyle(){let t=this.tbar.horiz,e=t?"column":"row",i=this.__background,s=document.createElement("style");s.textContent=`\n      ._tab_${this._id} {\n        display : flex;\n        flex-direction : ${e};\n        margin : 0px;\n        padding : 0px;\n        align-self : flex-start;\n        ${t?"":"vertical-align : top;"}\n      }\n      \n      ._tbar_${this._id} {\n        list-style-type : none;\n        align-self : flex-start;\n        background-color : ${i};\n        flex-direction : ${e};\n        ${t?"":"vertical-align : top;"}\n      }\n    `,this._style&&this._style.remove(),this._style=s,this.shadow.prepend(s)}icontab(t,e,i){let s=this.tab("",e,i);return s._tab.icon=t,s}removeTab(t){let e=t._tab;this.tbar.removeTab(e),t.remove()}tab(t,e,i,s=!0){void 0===e&&(e=tab_idgen++);let r=UIBase$4.createElement("colframe-x");function a(t){t="on"+t,Object.defineProperty(r,t,{get(){return this._tab[t]},set(e){this._tab[t]=e}})}return this.tabs[e]=r,r.dataPrefix=this.dataPrefix,r.ctx=this.ctx,r._tab=this.tbar.addTab(t,e,i,s),r.inherit_packflag|=this.inherit_packflag,r.packflag|=this.packflag,r.parentWidget=this,r.ctx&&r._init(),r.setCSS(),void 0===this._tab&&this.setActive(r),r.noSwitch=function(){return this._tab.noSwitch=!0,this},a("tabclick"),a("tabdragmove"),a("tabdragstart"),a("tabdragend"),r}setActive(t){"string"==typeof t&&(t=this.getTab(t)),t&&t._tab!==this.tbar.tabs.active&&this.tbar.setActive(t._tab)}getTabCount(){return this.tbar.tabs.length}moveTab(t,e){t=t._tab;let i=this.tbar.tabs[e];t!==i&&this.tbar.swapTabs(t,i),this.tbar.setCSS(),this.tbar._layout(),this.tbar._redraw()}getTab(t){if(t in this.tabs)return this.tabs[t];for(let e in this.tabs){let i=this.tabs[e];if(i.name===t)return i}throw new Error("Unknown tab "+t)}updateBarPos(){let t=this.getAttribute("bar_pos");t!==this._last_bar_pos&&(this.horiz="top"===t||"bottom"===t,this._last_bar_pos=t,this.tbar.setAttribute("bar_pos",t),this.tbar.update(!0),this.update())}updateHoriz(){let t=this.tbar.horiz;this._last_horiz!==t&&(this._last_horiz=t,this._remakeStyle())}updateStyle(){let t=""+this.getDefault("background-color");t!==this._last_style_key&&(this._last_style_key=t,this.setCSS())}getActive(){return this.tbar.tabs.active}update(){super.update(),this.tbar.movableTabs=this.movableTabs,void 0!==this._tab&&this._tab.update(),this.style.display="flex",this.style["flex-direction"]=this.horiz?"column":"row",this.tbar.tabFontScale=this.tabFontScale,this.updateStyle(),this.updateHoriz(),this.updateBarPos(),this.tbar.update();let t=this.tbar.tabs.active;if(t&&!this.hideScrollBars){let e=this.tabs[t.id];e.hasAttribute("overflow-y")&&this.style["overflow-y"]!==e.getAttribute("overflow-y")?this.style["overflow-y"]=e.getAttribute("overflow-y"):e.hasAttribute("overflow-y")||(this.style["overflow-y"]=this.getDefault("overflow-y")||"unset"),e.hasAttribute("overflow")&&this.style.overflow!==e.getAttribute("overflow")?this.style.overflow=e.getAttribute("overflow"):e.hasAttribute("overflow")||(this.style.overflow=this.getDefault("overflow")||"unset")}else this.hideScrollBars&&(this.style.overflow=this.style["overflow-y"]="unset")}}UIBase$4.internalRegister(TabContainer);var _ui=void 0;let PropFlags=PropFlags$3,PropSubTypes=PropSubTypes$3,EnumProperty$1=EnumProperty$9,Vector2$2=Vector2$b,UIBase$3=UIBase$f,PackFlags$1=PackFlags$a,PropTypes$1=PropTypes$8;const list$1=list$2;class TableRow extends Container{constructor(){super(),this.dom.remove(),this.dom=document.createElement("tr"),this.dom.setAttribute("class","containerx")}static define(){return{tagname:"tablerow-x"}}_add(t){t.ctx=this.ctx,t.parentWidget=this;let e=document.createElement("td");e.appendChild(t),this.dom.appendChild(e),t.onadd()}}UIBase$3.internalRegister(TableRow);class TableFrame extends Container{constructor(){super(),this.dom=document.createElement("table"),this.shadow.appendChild(this.dom),this.dom.setAttribute("class","containerx")}update(){super.update()}_add(t){t.ctx=this.ctx,t.parentWidget=this,this.dom.appendChild(t),t.onadd()}add(t){this._add(t)}row(){let t=document.createElement("tr"),e="table-tr";t.setAttribute("class",e),this.dom.appendChild(t);let i=this;function s(){let s=document.createElement("td");t.appendChild(s),s.style.margin=t.style.margin,s.style.padding=t.style.padding;let r=UIBase$3.createElement("rowframe-x");return r.ctx=i.ctx,r.parentWidget=i,r.setAttribute("class",e),s.setAttribute("class",e),s.appendChild(r),r}let r={_tr:t,style:t.style,focus:function(e){t.focus(e)},blur:function(e){t.blur(e)},remove:()=>{t.remove()},addEventListener:function(e,i,s){t.addEventListener(e,i,s)},removeEventListener:function(e,i,s){t.removeEventListener(e,i,s)},setAttribute:function(i,s){"class"==i&&(e=s),t.setAttribute(i,s)},scrollTo:function(){return this._tr.scrollTo(...arguments)},scrollIntoView:function(){return this._tr.scrollIntoView(...arguments)},clear:function(){for(let e of list$1(t.childNodes))t.removeChild(e)}};function a(e){r[e]=function(){let i=s();return i.background=t.style["background-color"],i[e].apply(i,arguments)}}let n="";return Object.defineProperty(r,"tabIndex",{set:function(e){t.tabIndex=e},get:function(e){return t.tabIndex}}),Object.defineProperty(r,"background",{set:function(e){n=e,t.style["background-color"]=e;for(let i of t.childNodes)i.childNodes.length>0&&(i.childNodes[0].background=e,i.style["background-color"]=e)},get:function(){return n}}),r.cell=()=>{let e=s();return e.background=t.style["background-color"],e},a("label"),a("tool"),a("prop"),a("pathlabel"),a("button"),a("iconbutton"),a("textbox"),a("col"),a("row"),a("table"),a("listenum"),a("check"),r}clear(){super.clear();for(let t of list$1(this.dom.childNodes))t.remove()}static define(){return{tagname:"tableframe-x"}}}UIBase$3.internalRegister(TableFrame);let EnumProperty=EnumProperty$9,PropTypes=PropTypes$8,UIBase$2=UIBase$f,PackFlags=PackFlags$a,IconSheets=IconSheets$7;function getpx(t){return parseFloat(t.trim().replace("px",""))}class ListItem extends RowFrame{constructor(){super();let t=()=>{this.highlight=!0,this.setBackground()},e=()=>{this.highlight=!1,this.setBackground()};this.addEventListener("mouseover",t),this.addEventListener("mousein",t),this.addEventListener("mouseleave",e),this.addEventListener("mouseout",e),this.addEventListener("blur",e);let i=document.createElement("style");i.textContent="\n      .listitem {\n        -moz-user-focus: normal;\n        moz-user-focus: normal;\n        user-focus: normal;\n      }\n    ",this.shadowRoot.prepend(i)}static define(){return{tagname:"listitem-x",style:"listbox"}}init(){super.init(),this.setAttribute("class","listitem"),this.style.width="100%",this.style.height=this.getDefault("ItemHeight")+"px",this.style["flex-grow"]="unset",this.setCSS()}setBackground(){this.highlight&&this.is_active?this.background=this.getDefault("ListActiveHighlight"):this.highlight?this.background=this.getDefault("ListHighlight"):this.is_active?this.background=this.getDefault("ListActive"):this.background=this.getDefault("background-color")}setCSS(){super.setCSS(),this.setBackground()}}UIBase$2.internalRegister(ListItem);class ListBox extends Container{constructor(){super(),this.items=[],this.idmap={},this.items.active=void 0,this.highlight=!1,this.is_active=!1;let t=document.createElement("style");t.textContent="\n      .listbox {\n        -moz-user-focus: normal;\n        moz-user-focus: normal;\n        user-focus: normal;\n      }\n    ",this.shadow.prepend(t),this.onkeydown=t=>{switch(t.keyCode){case keymap$4.Up:case keymap$4.Down:if(0==this.items.length)return;if(void 0===this.items.active)return void this.setActive(this.items[0]);let e=this.items.indexOf(this.items.active),i=t.keyCode==keymap$4.Up?-1:1;e=Math.max(Math.min(e+i,this.items.length-1),0),this.setActive(this.items[e])}}}static define(){return{tagname:"listbox-x",style:"listbox"}}setCSS(){super.setCSS()}init(){super.init(),this.setCSS(),this.style.width=this.getDefault("width")+"px",this.style.height=this.getDefault("height")+"px",this.style.overflow="scroll"}addItem(t,e){let i=UIBase$2.createElement("listitem-x");i._id=void 0===e?this.items.length:e,this.idmap[i._id]=i,this.tabIndex=1,this.setAttribute("tabindex",1),this.add(i),this.items.push(i),i.label(t);let s=this;return i.onclick=function(){s.setActive(this),this.setBackground()},i}removeItem(t){"number"==typeof t&&(t=this.idmap[t]),t.remove(),delete this.idmap[t._id],this.items.remove(t)}setActive(t){"number"==typeof t&&(t=this.idmap[t]),t!==this.items.active&&(void 0!==this.items.active&&(this.items.active.highlight=!1,this.items.active.is_active=!1,this.items.active.setBackground()),this.items.active=t,t&&(t.is_active=!0,t.setBackground(),t.scrollIntoViewIfNeeded()),this.onchange&&this.onchange(t?t._id:void 0,t))}clear(){}}UIBase$2.internalRegister(ListBox);class ProgressCircle extends UIBase$f{constructor(){super(),this.canvas=document.createElement("canvas"),this.g=this.canvas.getContext("2d"),this.shadow.appendChild(this.canvas),this.size=150,this.animreq=void 0,this._value=0,this.startTime=time_ms()}init(){super.init(),this.flagRedraw(),this.update(),this.tabIndex=0,this.setAttribute("tab-index",0),this.setAttribute("tabindex",0);let t=t=>{if(t.keyCode===keymap$4.Escape)this.oncancel&&this.oncancel(this)};this.addEventListener("keydown",t),this.canvas.addEventListener("keydown",t)}flagRedraw(){void 0===this.animreq&&(this.animreq=requestAnimationFrame((()=>{this.animreq=void 0,this.draw()})))}draw(){let t=this.canvas,e=this.g,i=(time_ms()-this.startTime)/1e3;e.save(),e.clearRect(0,0,t.width,t.height),e.lineWidth/=.5*t.width,e.scale(t.width,t.height),e.translate(.5,.5),e.fillStyle="rgb(141,154,196)",e.strokeStyle="rgb(68,69,83)",e.beginPath(),e.moveTo(0,0),e.arc(0,0,.45,Math.PI,-Math.PI),e.moveTo(0,0),e.arc(0,0,.2,Math.PI,-Math.PI),e.clip("evenodd"),e.beginPath(),e.arc(0,0,.45,-Math.PI,Math.PI),e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,.2,Math.PI,-Math.PI),e.stroke(),e.beginPath();let s=this._value*Math.PI*2,r=2*Math.PI/12,a=e.lineWidth;e.lineWidth*=3;for(let t=0;t<12;t++){let s=t*r;s+=i;let a=.2,n=.45,o=s+.5*r;e.beginPath(),e.moveTo(Math.cos(s)*a,Math.sin(s)*a),e.lineTo(Math.cos(o)*n,Math.sin(o)*n),e.strokeStyle="rgba(255,255,255,0.5)",e.stroke()}e.lineWidth=a,e.beginPath(),e.moveTo(0,0),e.arc(0,0,.4,Math.PI,-Math.PI),e.clip("evenodd"),e.beginPath(),e.fillStyle="rgb(214,110,54)",e.moveTo(0,0),e.arc(0,0,.45,0,s),e.lineTo(0,0),e.fill(),e.strokeStyle="rgb(141,154,196)",e.stroke(),e.restore()}set value(t){this._value=t,this.flagRedraw()}get value(){return this._value}startTimer(){void 0===this.timer&&(this.focus(),window.setInterval((()=>{this.isConnected?this.flagRedraw():this.endTimer()}),50))}endTimer(){void 0!==this.timer&&window.clearInterval(this.timer),this.timer=void 0}update(){!this.isConnected&&this.timer&&this.endTimer(),~~(this.size*UIBase$f.getDPI())!==this.canvas.width&&this.setCSS()}setCSS(){let t=this.canvas,e=~~(this.size*UIBase$f.getDPI());t.width!==e&&(t.width=t.height=e,e/=UIBase$f.getDPI(),t.style.width=e+"px",t.style.height=e+"px",t.style.display="flex",this.style.width=e+"px",this.style.height=e+"px",this.draw()),this.style.display="flex",this.style["align-items"]="center",this.style["justify-content"]="center",this.style.width="100%",this.style.height="100%"}static define(){return{tagname:"progress-circle-x"}}}UIBase$f.register(ProgressCircle);const LastKey=Symbol("LastToolPanelId");let tool_idgen=0;function getLastToolStruct(t){let e=t.state._last_tool;if(e){let t="Passing the last tool to last-tool-panel via appstate._last_tool is deprecated;";t+="\nctx.toolstack.head is now used instead.",console.warn(t)}else e=t.toolstack.head;return e}const last_tool_eventmap=[];window.setInterval((()=>{for(const t of last_tool_eventmap){const e=t.panel;if(!e.isConnected||e.hidden){window.DEBUG&&window.DEBUG.lastToolPanel&&console.log("Disconnecting last tool panel from toolstack."),e.unlinkEvents(),e.needsRebuild=!0;break}}}),500);class LastToolPanel extends ColumnFrame{constructor(){super(),this.ignoreOnChange=!1,this.on_change=null,this._tool_id=void 0,this.useDataPathUndo=!1,this.needsRebuild=!1}init(){super.init(),this.useDataPathUndo=!1,this.rebuild()}getToolStackHead(t){let e=0===t.toolstack.length||t.toolstack.cur>=t.toolstack.length;if(e=e||t.toolstack.cur<0,e=e||t.toolstack[t.toolstack.cur].undoflag&UndoFlags$1.IS_UNDO_ROOT,!e)return t.toolstack[t.toolstack.cur]}rebuild(){let t=this.ctx;if(void 0===t)return void(this._tool_id=-1);this.needsRebuild=!1,this.clear(),this.label("Recent Command Settings");let e=this.getToolStackHead(t);if(!e)return void this.setCSS();let i=e.constructor.tooldef(),s=(void 0!==i.uiname?i.uiname:i.name,this.panel(i.uiname));this.on_change=()=>{this.ignoreOnChange||e.modalRunning||(e===t.toolstack.head?(this.ignoreOnChange=!0,t.toolstack.rerun(e),this.ignoreOnChange=!1):this.unlinkEvents())},this.buildTool(t,e,s),this.flushUpdate(),this.flushUpdate()}unlinkEvents(){for(const t of Array.from(last_tool_eventmap))t.panel!==this&&t.panel.isConnected||(t.prop.off("change",t.cb),last_tool_eventmap.remove(t),t.panel!==this&&(t.panel.needsRebuild=!0))}buildTool(t,e,i){if(!(e.flag&ToolFlags$1.PRIVATE)){this.unlinkEvents(),this.last_tool=e,i.useDataPathUndo=!1;for(let t in e.inputs){let s=e.inputs[t];if(s.flag&(PropFlags$3.PRIVATE|PropFlags$3.READ_ONLY))continue;s.on("change",this.on_change),last_tool_eventmap.push({panel:this,cb:this.on_change,prop:s});let r=`last_tool.${t}`,a=s.uiname??ToolProperty$1.makeUIName(t);i.label(a);let n=0;s.flag&PropFlags$3.SIMPLE_SLIDER||(n|=PackFlags$a.FORCE_ROLLER_SLIDER);i.prop(r,n)}this.setCSS()}}update(){super.update();let t=this.ctx;if(!t)return;let e=this.getToolStackHead(t);this.needsRebuild|=e&&(!(LastKey in e)||e[LastKey]!==this._tool_id),this.needsRebuild&&(e[LastKey]=tool_idgen++,this._tool_id=e[LastKey],this.rebuild())}static define(){return{tagname:"last-tool-panel-x"}}}UIBase$f.internalRegister(LastToolPanel);const mimeMap={".js":"application/javascript",".json":"text/json",".html":"text/html",".txt":"text/plain",".jpg":"image/jpeg",".png":"image/png",".tiff":"image/tiff",".gif":"image/gif",".bmp":"image/bitmap",".tga":"image/targa",".svg":"image/svg+xml",".xml":"text/xml",".webp":"image/webp",svg:"image/svg+xml",txt:"text/plain",html:"text/html",css:"text/css",ts:"application/typescript",py:"application/python",c:"application/c",cpp:"application/cpp",cc:"application/cpp",h:"application/c",hh:"application/cpp",hpp:"application/cpp",sh:"application/bash",mjs:"application/javascript",cjs:"application/javascript",gif:"image/gif"};var textMimes=new Set(["application/javascript","application/x-javscript","image/svg+xml","application/xml"]);function isMimeText(t){return!!t&&(!!t.startsWith("text")||textMimes.has(t))}function getExtension(t){if(!t)return"";let e=t.length;for(;e>0&&"."!==t[e];)e--;return t.slice(e,t.length).trim().toLowerCase()}function getMime(t){let e=getExtension(t);return e in mimeMap?mimeMap[e]:"application/x-octet-stream"}class PlatformAPI{static writeFile(t,e,i){throw new Error("implement me")}static resolveURL(t,e=location.href){for(e=e.trim(),t.startsWith("./")&&(t=t.slice(2,t.length).trim());t.startsWith("/");)t=t.slice(1,t.length).trim();for(;e.endsWith("/");)e=e.slice(0,e.length-1).trim();let i=["html","txt","js","php","cgi"];for(let t of i)if(t="."+t,e.endsWith(t)){let t=e.length-1;for(;t>0&&"/"!==e[t];)t--;e=e.slice(0,t).trim()}for(;e.endsWith("/");)e=e.slice(0,e.length-1).trim();t=(e+"/"+t).split("/");let s=[];for(let e=0;e<t.length;e++)".."===t[e]?s.pop():s.push(t[e]);return s.join("/")}static showOpenDialog(t,e=new FileDialogArgs){throw new Error("implement me")}static showSaveDialog(t,e,i=new FileDialogArgs){throw new Error("implement me")}static readFile(t,e){throw new Error("implement me")}}class FileDialogArgs{constructor(){this.multi=!1,this.addToRecentList=!1,this.filters=[]}}class FilePath{constructor(t,e="unnamed"){this.data=t,this.filename=e}}let promise;var platform$2;function getPlatformAsync(){return new Promise(promise?(t,e)=>{promise.then((e=>{t(e.platform)}))}:(t,e)=>{t(platform$2)})}promise=window.haveElectron?Promise.resolve().then((function(){return electron_api$1})):Promise.resolve().then((function(){return web_api})),promise.then((t=>{platform$2=t.platform,promise=void 0}));var platform$3=Object.freeze({__proto__:null,get platform(){return platform$2},getPlatformAsync:getPlatformAsync});let _nativeTheme;function getNativeTheme(){if(_nativeTheme)return _nativeTheme;let t=getElectron().remote;return t?_nativeTheme=t.nativeTheme:ipcRenderer.invoke("nativeTheme"),_nativeTheme}function getElectronVersion(){let t=navigator.userAgent,e=t.search("Electron");return t=t.slice(e+9,t.length),e=t.search(/[ \t]/),e>=0&&(t=t.slice(0,e)),t=t.trim(),t=t.split(".").map((t=>parseInt(t))),t}function getElectron(){return require("electron")}function myRequire(t){return globalThis.require(t)}function getFilename(t){let e=t.replace(/\\/g,"/"),i=e.length-1;for(;i>=0&&"/"!==e[i];)i--;return"/"===e[i]&&i++,i>0&&(e=e.slice(i,e.length).trim()),e}let _menu_init=!1,_init=!1,electron_menu_idgen=1,ipcRenderer;class ElectronMenu extends Array{constructor(t={}){super(),this._ipcId=electron_menu_idgen++;for(let e in t)this[e]=t[e]}insert(t,e){this.length++;let i=this.length-1;for(;i>t;)this[i]=this[i-1],i--;return this[t]=e,this}static setApplicationMenu(t){initElectronIpc(),ipcRenderer.invoke("set-menu-bar",t)}closePopup(){ipcRenderer.invoke("close-menu",this._ipcId)}append(t){this.push(t)}popup(t){let{x:e,y:i,callback:s}=t;s=wrapRemoteCallback("popup_menu_click",s);const{ipcRenderer:r}=require("electron");r.invoke("popup-menu",this,e,i,s)}}let callbacks={},keybase=1;function wrapRemoteCallback(t,e){return t="remote_"+t+keybase++,callbacks[t]=e,t}let ipcInit=!1;function initElectronIpc(){ipcInit||(ipcInit=!0,ipcRenderer=require("electron").ipcRenderer,ipcRenderer.on("invoke-menu-callback",((t,e,i)=>{callbacks[e].apply(void 0,i)})),ipcRenderer.on("nativeTheme",((t,e)=>{_nativeTheme=Object.assign({},e),_nativeTheme._themeSource=_nativeTheme.themeSource,Object.defineProperty(_nativeTheme,"themeSource",{get(){return this._themeSource},set(t){ipcRenderer.invoke("nativeTheme.setThemeSource",t)}})})))}class ElectronMenuItem{constructor(t){for(let e in t)this[e]=t[e];this.click&&(this.click=wrapRemoteCallback("menu_click",this.click))}}function patchDropBox(){initElectronIpc(),exports.noElectronMenus||(DropBox.prototype._onpress=function(t){if(void 0!==this._menu)return this._menu.close(),this._menu=void 0,this._pressed=!1,void this._redraw();this._build_menu();let e=buildElectronMenu(this._menu);if(this._menu.close=()=>{e.closePopup()},void 0===this._menu)return;this._menu._dropbox=this,this.dom._background=this.getDefault("BoxDepressed"),this._background=this.getDefault("BoxDepressed"),this._redraw(),this._pressed=!0,this.setCSS();let i=this._menu.onclose;this._menu.onclose=()=>{this._pressed=!1,this._redraw();let t=this._menu;t&&(this._menu=void 0,t._dropbox=void 0),i&&i.call(t)};this._menu,this.getScreen(),this.getDPI();let s=t.x,r=t.y,a=this.dom.getClientRects();s=a[0].x,r=a[0].y+Math.ceil(a[0].height),s=~~s,r=~~r,e.popup({x:s,y:r,callback:()=>{this._menu&&this._menu.onclose()}})})}let on_tick=()=>{let t=getNativeTheme();if(t){(t.shouldUseDarkColors?"dark":"light")!==exports.colorSchemeType&&(t.themeSource=exports.colorSchemeType)}};function checkInit(){window.haveElectron&&!_init&&(_init=!0,patchDropBox(),setInterval(on_tick,350))}let iconcache={};function makeIconKey(t,e,i){return t+":"+e+":"+i}function getNativeIcon(t,e=0,i=!1,s=16){let r;try{r=myRequire("./icogen.js")}catch(t){r=myRequire("./icogen.cjs")}window.icongen=r;getElectron().nativeImage;let a=getIconManager(),n=(a.findSheet(e),[]);r.GetRequiredICOImageSizes();{let e=a.findClosestSheet(s),r=a.getTileSize(e),o=document.createElement("canvas"),l=o.getContext("2d");o.width=o.height=s,i&&(l.filter="invert(100%)");let h=s/r;l.scale(h,h),a.canvasDraw({getDPI:()=>1},o,l,t,0,0,e);let c="data:image/png;base64,",d=o.toDataURL();d=d.slice(c.length,d.length),d=Buffer.from(d,"base64"),myRequire("fs").writeFileSync("./myicon2.png",d),n.push(d)}return"myicon2.png"}let map={CTRL:"Control",ALT:"Alt",SHIFT:"Shift",COMMAND:"Command"};function buildElectronHotkey(t){t=t.trim().replace(/[ \t-]+/g,"+");for(let e in map)t=t.replace(e,map[e]);return t}function buildElectronMenu(t){getElectron().remote;initElectronIpc();let e=new ElectronMenu,i=e=>{if(e._isMenu){let t=e._menu;return new ElectronMenuItem({submenu:buildElectronMenu(e._menu),label:t.getAttribute("title")})}let i=e.hotkey,s=e.icon,r=""+e.label;i=i&&"string"!=typeof i?buildElectronHotkey(i):""+i,s<0&&(s=void 0);let a={id:""+e._id,label:r,accelerator:i,icon:s?getNativeIcon(s):void 0,click:function(){t.onselect(e._id)},registerAccelerator:!1};return new ElectronMenuItem(a)};for(let s of t.items)e.append(i(s));return e}function initMenuBar(t,e=!1){if(checkInit(),!window.haveElectron)return;if(_menu_init&&!e)return;_menu_init=!0;let i=new ElectronMenu,s=new Set(["undo","redo","cut","copy","paste","delete","about","quit","open","save","load","paste","cut","zoom"]),r={};for(let t of s)r[t]=t;r=Object.assign(r,{"select all":"selectAll",file:"fileMenu",edit:"editMenu",view:"viewMenu",app:"appMenu",help:"help","zoom in":"zoomIn","zoom out":"zoomOut"});let a=t.header;for(let t of a.traverse(DropBox)){t._build_menu(),t.update(),t._build_menu();let e=t._menu;e.ctx=t.ctx,e._init(),e.update();let s={label:t._genLabel(),tooltip:t.description,submenu:buildElectronMenu(e)};i.insert(0,new ElectronMenuItem(s))}ElectronMenu.setApplicationMenu(i)}class platform$1 extends PlatformAPI{static showOpenDialog(t,e=new FileDialogArgs){console.log(e.filters);let i={defaultPath:e.defaultPath,filters:this._sanitizeFilters(e.filters??[]),properties:["openFile","showHiddenFiles","createDirectory"]};return e.multi&&i.properties.push("multiSelections"),e.addToRecentList||i.properties.push("dontAddToRecent"),initElectronIpc(),new Promise(((t,e)=>{ipcRenderer.invoke("show-open-dialog",i,wrapRemoteCallback("open-dialog",(i=>{i.canceled||i.cancelled?e("cancel"):t(i.filePaths.map((t=>new FilePath(t,getFilename(t)))))})),wrapRemoteCallback("show-open-dialog",(t=>{e(t)})))}))}static _sanitizeFilters(t){let e=[];for(let i of t){if(Array.isArray(i)){let t=i[0];i={extensions:i},t=t.replace(/\./g,"").trim().toLowerCase(),t in mimeMap&&(i.mime=mimeMap[t]),i.name=t}console.log(i.extensions),i.extensions=i.extensions.map((t=>t.startsWith(".")?t.slice(1,t.length):t)),e.push(i)}return e}static showSaveDialog(t,e,i=new FileDialogArgs){console.log(i.filters);let s={defaultPath:i.defaultPath,filters:this._sanitizeFilters(i.filters??[]),properties:["openFile","showHiddenFiles","createDirectory"]};return i.multi&&s.properties.push("multiSelections"),i.addToRecentList||s.properties.push("dontAddToRecent"),new Promise(((t,i)=>{initElectronIpc();ipcRenderer.invoke("show-save-dialog",s,wrapRemoteCallback("dialog",(s=>{if(s.canceled)i("cancel");else{let i=s.filePath,r=e();r instanceof ArrayBuffer&&(r=new Uint8Array(r)),require("fs").writeFileSync(i,r),console.log("saved file",r),t(new FilePath(i,getFilename(i)))}})),wrapRemoteCallback("dialog",(t=>{i(t)})))}))}static readFile(t,e){return new Promise(((i,s)=>{let r=require("fs");isMimeText(e)?i(r.readFileSync(t.data,"utf8")):i(r.readFileSync(t.data).buffer)}))}static writeFile(t,e,i){return new Promise(((i,s)=>{require("fs").writeFileSync(e.data,t),i(e)}))}}var electron_api$1=Object.freeze({__proto__:null,ElectronMenu:ElectronMenu,wrapRemoteCallback:wrapRemoteCallback,ElectronMenuItem:ElectronMenuItem,checkInit:checkInit,iconcache:iconcache,getNativeIcon:getNativeIcon,buildElectronHotkey:buildElectronHotkey,buildElectronMenu:buildElectronMenu,initMenuBar:initMenuBar,platform:platform$1});const SVG_URL="http://www.w3.org/2000/svg",Vector2$1=Vector2$b;class CanvasOverdraw extends UIBase$f{constructor(){super(),this.canvas=document.createElement("canvas"),this.shadow.appendChild(this.canvas),this.g=this.canvas.getContext("2d"),this.screen=void 0,this.shapes=[],this.otherChildren=[],this.font=void 0;let t=document.createElement("style");t.textContent="\n      .overdrawx {\n        pointer-events : none;\n      }\n    ",this.shadow.appendChild(t)}static define(){return{tagname:"screen-overdraw-canvas-x"}}startNode(t,e){e&&(this.screen=e,this.ctx=e.ctx),this.parentNode||t.appendChild(this),this.style.display="float",this.style["z-index"]=this.zindex_base,this.style.position="absolute",this.style.left="0px",this.style.top="0px",this.style.width="100%",this.style.height="100%",this.style["pointer-events"]="none",this.svg=document.createElementNS(SVG_URL,"svg"),this.svg.style.width="100%",this.svg.style.height="100%",this.svg.style["pointer-events"]="none",this.shadow.appendChild(this.svg)}start(t){this.screen=t,this.ctx=t.ctx,t.parentNode.appendChild(this),this.style.display="float",this.style["z-index"]=this.zindex_base,this.style.position="absolute",this.style.left="0px",this.style.top="0px",this.style.width=t.size[0]+"px",this.style.height=t.size[1]+"px",this.style["pointer-events"]="none",this.svg=document.createElementNS(SVG_URL,"svg"),this.svg.style.width="100%",this.svg.style.height="100%",this.shadow.appendChild(this.svg)}}class Overdraw extends UIBase$f{constructor(){super(),this.visibleToPick=!1,this.screen=void 0,this.shapes=[],this.otherChildren=[],this.font=void 0;let t=document.createElement("style");t.textContent="\n      .overdrawx {\n        pointer-events : none;\n      }\n    ",this.shadow.appendChild(t),this.zindex_base=1e3}startNode(t,e,i="relative"){e&&(this.screen=e,this.ctx=e.ctx),this.parentNode||t.appendChild(this),this.style["z-index"]=this.zindex_base,this.style.position=i,this.style.margin=this.style.padding="0px",this.style.width="100%",this.style.height="100%",this.style["pointer-events"]="none",this.svg=document.createElementNS(SVG_URL,"svg"),this.svg.style.width="100%",this.svg.style.height="100%",this.svg.style["pointer-events"]="none",this.shadow.appendChild(this.svg)}start(t){this.screen=t,this.ctx=t.ctx,t.parentNode.appendChild(this),this.style.display="float",this.style["z-index"]=this.zindex_base,this.style.position="absolute",this.style.left="0px",this.style.top="0px",this.style.width=t.size[0]+"px",this.style.height=t.size[1]+"px",this.style["pointer-events"]="none",this.svg=document.createElementNS(SVG_URL,"svg"),this.svg.style.width="100%",this.svg.style.height="100%",this.shadow.appendChild(this.svg)}clear(){for(let t of list$2(this.svg.childNodes))t.remove();for(let t of this.otherChildren)t.remove();this.otherChildren.length=0}drawTextBubbles(t,e,i){let s=[],r=[],a=new Vector2$1;for(let n=0;n<t.length;n++){let o,l=e[n],h=t[n];void 0!==i&&(o=i[n]),a.add(l);let c=this.text(t[n],l[0],l[1],{color:o});s.push(c);let d=c.style.font,u=/[0-9]+px/,p=d.match(u)[0];p=void 0===p?this.getDefault("DefaultText").size:parsepx$4(p);let m=measureTextBlock(this,h,void 0,void 0,p,d);c.minsize=[~~m.width,~~m.height];let f=parsepx$4(c.style.padding);c.minsize[0]+=2*f,c.minsize[1]+=2*f;let g=parsepx$4(c.style.left),_=parsepx$4(c.style.top);c.grads=new Array(4),c.params=[g,_,c.minsize[0],c.minsize[1]],c.startpos=new Vector2$1([g,_]),c.setCSS=function(){this.style.padding="0px",this.style.margin="0px",this.style.left=~~this.params[0]+"px",this.style.top=~~this.params[1]+"px",this.style.width=~~this.params[2]+"px",this.style.height=~~this.params[3]+"px"},c.setCSS(),r.push(c)}if(0!==s.length){a.mulScalar(1/s.length);for(let t=0;t<15;t++)o();for(let t of s)r.push(this.line(t.startpos,t.params));return r}function n(){let t=[0,0],e=[0,0],i=0;for(let r of s){for(let a of s){if(a===r)continue;t[0]=r.params[2],t[1]=r.params[3],e[0]=a.params[2],e[1]=a.params[3],i+=aabb_overlap_area(r.params,t,a.params,e)}i+=.25*r.startpos.vectorDistance(r.params)}return i}function o(){let t=n();if(0===t)return;let e=1e-4,i=0;for(let r of s)for(let s=0;s<r.params.length;s++){let a=r.params[s];r.params[s]+=e;let o=n();r.params[s]=a,r.grads[s]=(o-t)/e,i+=r.grads[s]**2}if(0===i)return;t/=i;for(let e of s){for(let i=0;i<e.params.length;i++)e.params[i]+=-t*e.grads[i]*.4;e.params[2]=Math.max(e.params[2],e.minsize[0]),e.params[3]=Math.max(e.params[3],e.minsize[1]),e.setCSS()}}}text(t,e,i,s={}){void 0===(s=Object.assign({},s)).font&&(void 0!==this.font?s.font=this.font:s.font=this.getDefault("DefaultText").genCSS()),s["background-color"]||(s["background-color"]="rgba(75, 75, 75, 0.75)"),s.color=s.color?s.color:"white","object"==typeof s.color&&(s.color=color2css$1(s.color)),s.padding=void 0===s.padding?"5px":s.padding,s["border-color"]=s["border-color"]?s["border-color"]:"grey",s["border-radius"]=s["border-radius"]?s["border-radius"]:"25px",s["border-width"]=void 0!==s["border-width"]?s["border-width"]:"2px","number"==typeof s["border-width"]&&(s["border-width"]=s["border-width"]+"px"),"number"==typeof s["border-radius"]&&(s["border-radius"]=s["border-radius"]+"px");let r=document.createElement("div");return r.setAttribute("class","overdrawx"),r.style.position="fixed",r.style.width="min-contents",r.style.height="min-contents",r.style["border-width"]=s["border-width"],r.style["border-radius"]="25px",r.style["pointer-events"]="none",r.style["z-index"]=this.zindex_base+1,r.style["background-color"]=s["background-color"],r.style.padding=s.padding,r.style.left=e+"px",r.style.top=i+"px",r.style.display="flex",r.style["justify-content"]="center",r.style["align-items"]="center",r.innerText=t,r.style.font=s.font,r.style.color=s.color,this.otherChildren.push(r),this.shadow.appendChild(r),r}circle(t,e,i="black",s="none"){let r=document.createElementNS(SVG_URL,"circle");return r.setAttribute("cx",t[0]),r.setAttribute("cy",t[1]),r.setAttribute("r",e),s?r.setAttribute("style",`stroke:${i};stroke-width:2;fill:${s}`):r.setAttribute("style",`stroke:${i};stroke-width:2`),this.svg.appendChild(r),r}line(t,e,i="black"){let s=document.createElementNS(SVG_URL,"line");return s.setAttribute("x1",t[0]),s.setAttribute("y1",t[1]),s.setAttribute("x2",e[0]),s.setAttribute("y2",e[1]),s.setAttribute("style",`stroke:${i};stroke-width:2`),this.svg.appendChild(s),s}rect(t,e,i="black"){let s=document.createElementNS(SVG_URL,"rect");return s.setAttribute("x",t[0]),s.setAttribute("y",t[1]),s.setAttribute("width",e[0]),s.setAttribute("height",e[1]),s.setAttribute("style",`fill:${i};stroke-width:2`),s.setColor=t=>{s.setAttribute("style",`fill:${t};stroke-width:2`)},this.svg.appendChild(s),s}end(){this.clear(),this.remove()}static define(){return{tagname:"overdraw-x",style:"overdraw"}}}UIBase$f.internalRegister(Overdraw);class TreeItem extends Container{constructor(){super(),this.treeParent=void 0,this.treeChildren=[],this.treeView=void 0,this.treeDepth=0,this.header=this.row(),this._icon1=this.header.iconbutton(Icons$2.TREE_COLLAPSE),this._icon1.iconsheet=0,this._icon1.drawButtonBG=!1,this._icon2=void 0,this._icon1.onclick=()=>{this.opened?this.close():this.open()},this.opened=!0,this._label=this.header.label("unlabeled"),this._labelText="unlabeled"}set icon(t){this._icon2?this._icon2=t:(this._icon2=UIBase$f.createElement("icon-label-x"),this._icon2.icon=t,this._icon2.iconsheet=0,this.header.insert(1,this._icon2))}get icon(){return this._icon2?this._icon2.icon:-1}open(){this._icon1.icon=Icons$2.TREE_COLLAPSE,this.opened=!0,this.treeView._open(this)}close(){this._icon1.icon=Icons$2.TREE_EXPAND,this.opened=!1,this.treeView._close(this)}set text(t){"string"==typeof t?(this._label.text=t,this._labelText=t):t instanceof HTMLElement&&(this._label.remove(),this.header.add(t),this._label=t,this._labelText=t)}get text(){return this._labelText}item(t,e={}){return e.treeParent=this,this.parentWidget.item(t,e)}init(){super.init()}static define(){return{tagname:"tree-item-x",style:"treeview"}}}UIBase$f.internalRegister(TreeItem);class TreeView extends Container{constructor(){super(),this.items=[],this.strokes=[]}init(){super.init(),this.style.display="flex",this.style["flex-direction"]="column",this.overdraw=UIBase$f.createElement("overdraw-x"),console.log(this.overdraw.startNode),this.overdraw.startNode(this),this.style.margin=this.style.padding="0px",this.updateOverdraw()}_forAllChildren(t,e){let i=t=>{e(t);for(let e of t.treeChildren)i(e)};for(let e of t.treeChildren)i(e)}_open(t){this._forAllChildren(t,(t=>{t.opened&&t.unhide()})),this._makeStrokes()}_close(t){this._forAllChildren(t,(t=>{t.hide()})),this._makeStrokes()}_makeStrokes(){if(!this.overdraw)return;for(let t of this.strokes)t.remove();this.strokes.length=0;let t=t=>t.hidden,e=this.items;if(0==e.length)return;this.overdraw.clear();let i=i=>{for(i++;i<e.length&&t(e[i]);)i++;return i},s=0;t(e[s])&&(s=i(s));let r=this.overdraw.getBoundingClientRect(),a=this.overdraw,n=function(t,e,i,s){let n=r.x,o=r.y;t-=n,e-=o,i-=n,s-=o,a.line([t,e],[i,s])};console.log("making lines",s);let o,l=this.getDefault("itemIndent"),h=this.getDefault("rowHeight"),c=t=>(t+2.2)*l+r.x;for(this.overdraw.style["z-index"]="0";s<e.length;s=i(s)){let t=this.items[s],a=i(s);if(a=a<e.length?e[a]:void 0,!t._icon1.getBoundingClientRect())continue;let l=c(t.treeDepth),d=r.y+(s+1)*h-.25*h;if(a&&a.treeDepth>t.treeDepth){let t=d+.75*h;n(l,d,l,t),n(l,t,c(a.treeDepth)-3,t)}else a&&a.treeDepth===t.treeDepth&&n(l,d,l,d+.5*h);o=t}}updateOverdraw(){let t=new MinMax(2),e=!1;for(let i of this.items){i.hidden;for(let s of i.getClientRects())t.minmax([s.x,s.y]),t.minmax([s.x+s.width,s.y+s.height]),e=!0}if(!e)return;let i=this.getClientRects()[0];if(!i)return;let s=i.left,r=i.top,a=this.overdraw;t.max[0],t.min[0],t.max[1],t.min[1];a.style.margin="0px",a.style.padding="0px",a.svg.style.margin="0px",a.style.position=UIBase$f.PositionKey,a.style.width=i.width-1+"px",a.style.height=i.height-1+"px",a.style.left=s+"px",a.style.top=r+"px"}update(){super.update(),this.updateOverdraw()}item(t,e={icon:void 0}){let i=UIBase$f.createElement("tree-item-x");this.add(i),i._init(),i.text=t,e.icon&&(i.icon=e.icon),i.treeParent=e.treeParent,i.treeView=this,i.style["max-height"]=this.getDefault("rowHeight")+"px",i.treeParent&&(i.treeParent.treeChildren.push(i),i.treeDepth=i.treeParent.treeDepth+1);let s=i.treeParent,r=1;for(;s;)s=s.treeParent,r++;return i.style["margin-left"]=r*this.getDefault("itemIndent")+"px",this.items.push(i),this.doOnce((()=>{this._makeStrokes()})),i}static define(){return{tagname:"tree-view-x",style:"treeview"}}}function startDrag(t){if(t._modal)return popModalLight(t._modal),void(t._modal=void 0);let e=!0,i=0,s=0,r={on_mousemove(r){let a=r.x,n=r.y;if(e)return i=a,s=n,void(e=!1);let o=a-i,l=n-s,h=parsepx$4(t.style.left),c=parsepx$4(t.style.top);h+=o,c+=l,console.log(h,c),t.style.left=h+"px",t.style.top=c+"px",i=a,s=n},end(){t._modal&&(popModalLight(t._modal),t._modal=void 0)},on_mouseup(t){this.end()},on_keydown(t){switch(t.keyCode){case keymap$4.Escape:case keymap$4.Return:this.end()}}};t._modal=pushModalLight(r)}UIBase$f.internalRegister(TreeView);class DragBox extends Container{constructor(){super(),this._done=!1,this.header=UIBase$f.createElement("rowframe-x"),this.contents=UIBase$f.createElement("container-x"),this.header.style["border-radius"]="20px",this.header.parentWidget=this,this.contents.parentWidget=this,this.shadow.appendChild(this.header),this.shadow.appendChild(this.contents)}init(){super.init();let t=this.header;t.ctx=this.ctx,this.contents.ctx=this.ctx,t._init(),this.contents._init(),this.style["min-width"]="350px",t.style.height="35px",t.iconbutton(Icons$2.DELETE,"Hide",(()=>{this.end()})).iconsheet=0,this.addEventListener("mousedown",(t=>{console.log("start drag"),startDrag(this),t.preventDefault()}),{capture:!1}),t.background=this.getDefault("background-color"),this.setCSS()}add(){return this.contents.add(...arguments)}prepend(t){return this.contents.prepend(t)}appendChild(t){return this.contents.appendChild(t)}col(){return this.contents.col(...arguments)}row(){return this.contents.row(...arguments)}strip(){return this.contents.strip(...arguments)}button(){return this.contents.button(...arguments)}iconbutton(){return this.contents.iconbutton(...arguments)}iconcheck(){return this.contents.iconcheck(...arguments)}tool(){return this.contents.tool(...arguments)}menu(){return this.contents.menu(...arguments)}prop(){return this.contents.prop(...arguments)}listenum(){return this.contents.listenum(...arguments)}check(){return this.contents.check(...arguments)}iconenum(){return this.contents.iconenum(...arguments)}slider(){return this.contents.slider(...arguments)}simpleslider(){return this.contents.simpleslider(...arguments)}curve(){return this.contents.curve(...arguments)}textbox(){return this.contents.textbox(...arguments)}textarea(){return this.contents.textarea(...arguments)}viewer(){return this.contents.viewer(...arguments)}panel(){return this.contents.panel(...arguments)}tabs(){return this.contents.tabs(...arguments)}table(){return this.contents.table(...arguments)}end(){this._done||(this.remove(),this._onend&&this._onend(),this.onend&&this.onend())}setCSS(){super.setCSS(),this.background=this.getDefault("background-color")}static define(){return{tagname:"drag-box-x",style:"panel"}}}UIBase$f.internalRegister(DragBox);let ignore=0,_FrameManager;function dockerdebug(){exports.DEBUG.areadocker&&console.warn(...arguments)}window.testSnapScreenVerts=function(t){let e=CTX.screen;e.unlisten(),e.on_resize([e.size[0]-75,e.size[1]],e.size),e.on_resize=e.updateSize=()=>{};let i=CTX.propsbar;i.pos[0]+=50,i.owning_sarea.loadFromPosSize(),e.regenBorders(),e.size[0]=window.innerWidth-5,e.snapScreenVerts(t)};class AreaDocker extends Container{constructor(){super(),this._last_update_key=void 0,this.mpos=new Vector2$b,this.needsRebuild=!0,this.ignoreChange=0}static define(){return{tagname:"area-docker-x",style:"areadocker"}}rebuild(){if(!this.parentWidget)return;let t=this.getArea().parentWidget;if(!t)return void(this.needsRebuild=!0);this.needsRebuild=!1,this.ignoreChange++,dockerdebug("Rebuild",this.getArea());let e=t.switcherData=saveUIData(this,"switcherTabs");this.clear();let i,s=this.tbar=this.tabs();s.onchange=this.tab_onchange.bind(this),dockerdebug(t._id,t.area?t.area._id:"(no active area)",t.editors),t.switcherData=e;for(let e of t.editors){let t=e.constructor.define(),i=t.uiname;i||(i=t.areaname||t.tagname.replace(/-x/,""),i=ToolProperty.makeUIName(i));let r=s.tab(i,e._id),a=new Vector2$b;new Vector2$b;r._tab.addEventListener("tabdragstart",(t=>{0!==t.x&&0!==t.y?(a.loadXY(t.x,t.y),this.mpos.loadXY(t.x,t.y)):a.load(this.mpos),dockerdebug("tab drag start!",a,t)})),r._tab.addEventListener("tabdragmove",(t=>{this.mpos.loadXY(t.x,t.y);let e=this.tbar.tbar.canvas.getBoundingClientRect(),i=t.x,s=t.y;(i<e.x-8||i>e.x+e.width+8||s<e.y-8||s>=e.y+e.height+8)&&(dockerdebug("tab detach!"),t.preventDefault(),this.detach(t))})),r._tab.addEventListener("tabdragend",(t=>{this.mpos.loadXY(t.x,t.y),dockerdebug("tab drag end!",t)}))}i=this.tbar.icontab(Icons$2.SMALL_PLUS,"add","Add Editor",!1).noSwitch(),dockerdebug("Add Menu Tab",i);let r=this.addicon=i._tab;r.ontabclick=t=>this.on_addclick(t),r.setAttribute("menu-button","true"),r.setAttribute("simple","true"),this.loadTabData(e),this.ignoreChange--}detach(t){this.tbar._ensureNoModal();let e=this.getArea(),i=this.ctx.screen.floatArea(e);i.size.min([300,300]),i.loadFromPosSize();let s=t?new Vector2$b([t.x,t.y]):this.mpos;dockerdebug("EVENT",t),t&&t instanceof PointerEvent?this.ctx.screen.moveAttachTool(i,s,document.body,t.pointerId):this.ctx.screen.moveAttachTool(i,s)}loadTabData(t){this.ignoreChange++,loadUIData(this,t),this.ignoreChange--}on_addclick(t){let e=new Vector2$b([t.x,t.y]);this.addicon.menu&&!this.addicon.menu.closed?this.addicon.menu.close():this.addTabMenu(t.target,e)}tab_onchange(t,e){this.ignoreChange||(dockerdebug("EVENT",e),e&&(!(e instanceof PointerEvent)||e.pointerType),this.select(t.id,e))}init(){super.init(),this.style["touch-action"]="none",this.addEventListener("pointermove",(t=>{this.mpos.loadXY(t.x,t.y)})),this.rebuild()}setCSS(){super.setCSS()}getArea(){let t=this.parentWidget,e=t,i=UIBase$f.getInternalName("screenarea-x");for(;t&&t.tagName.toLowerCase()!==i;)e=t,t=t.parentWidget;return e}flagUpdate(){return this.needsRebuild=!0,this}update(){super.update();let t=this.tbar.getActive(),e=this.getArea(),i=this.parentWidget._id;for(let t of e.parentWidget.editors)i+=t._id+":";if(i!==this._last_update_key&&(this._last_update_key=i,this.needsRebuild=!0),this.needsRebuild)this.rebuild();else{if(this.addicon){let t=this.tbar.tbar.tabs;t.indexOf(this.addicon)!==t.length-1&&this.tbar.tbar.swapTabs(this.addicon,t[t.length-1])}if(!t||t._id!==e._id){this.ignoreChange++;try{this.tbar.setActive(e._id)}catch(t){print_stack$1(t),this.needsRebuild=!0}this.ignoreChange--}window.tabs=this.tbar,this.ignoreChange=0}}select(t,e){dockerdebug("Tab Select!",t),this.ignoreChange++;let i,s=this.getArea(),r=s.parentWidget,a=saveUIData(this.tbar,"switcherTabs");for(let e of r.editors)if(e._id===t){i=e,r.switchEditor(e.constructor);break}if(i===s||!i.switcher)return;r.flushSetCSS(),r.flushUpdate(),i=r.area;let n=s.switcher.parentWidget,o=i.switcher.parentWidget,l=s.switcher.parentNode,h=i.switcher.parentNode;s.switcher=i.switcher,i.switcher=this,HTMLElement.prototype.remove.call(s.switcher),HTMLElement.prototype.remove.call(i.switcher),l instanceof UIBase$f?l.shadow.appendChild(s.switcher):l.appendChild(s.switcher),h instanceof UIBase$f?h.shadow.prepend(i.switcher):h.prepend(i.switcher),s.switcher.parentWidget=n,i.switcher.parentWidget=o,s.switcher.tbar._ensureNoModal(),i.switcher.tbar._ensureNoModal(),i.switcher.loadTabData(a),s.switcher.loadTabData(a),i.switcher.setCSS(),i.switcher.update(),e&&(e instanceof PointerEvent||e instanceof MouseEvent||e instanceof TouchEvent)&&(e.preventDefault(),e.stopPropagation(),i.switcher.tbar._startMove(void 0,e)),r.switcherData=a,this.ignoreChange--}addTabMenu(t,e){let i=t.getClientRects()[0];dockerdebug(t,t.getClientRects()),e||(e=this.ctx.screen.mpos);let s=UIBase$f.createElement("menu-x");s.closeOnMouseUp=!1,s.ctx=this.ctx,s._init();let r=Area$1.makeAreasEnum(),a=this.getArea().parentWidget;if(a){for(let t in Object.assign({},r.values)){let e=!0;for(let i of a.editors)i.constructor.define().uiname===t&&(e=!1);if(!e)continue;let i=r.iconmap[t];s.addItemExtra(t,r.values[t],void 0,i)}if(i)return dockerdebug(e[0],e[1],i.x,i.y),s.onselect=t=>{dockerdebug("menu select",t,this.getArea().parentWidget),this.addicon.menu=void 0;let e=this.getArea().parentWidget;if(e){let i,s,r=areaclasses[t];this.ignoreChange++;try{let t=saveUIData(this.tbar,"switcherTabs");e.switchEditor(r),dockerdebug("switching",r),i=e.area,i._init(),i.switcher&&(i.switcher.rebuild(),i.switcher.loadTabData(t),e.switcherData=t)}catch(t){throw print_stack$1(t),t}finally{this.ignoreChange=Math.max(this.ignoreChange-1,0)}if(dockerdebug("AREA",i.switcher,i),i.switcher){this.ignoreChange++;try{i.parentWidget=e,i.owning_sarea=e,i.switcher.parentWidget=i,i.switcher.ctx=i.ctx,i.switcher._init(),i.switcher.update(),dockerdebug("loading data",s),i.switcher.loadTabData(s),i.switcher.rebuild(),i.flushUpdate()}catch(t){throw t}finally{this.ignoreChange=Math.max(this.ignoreChange-1,0)}}}},this.addicon.menu=s,startMenu(s,e[0]-35,i.y+i.height,!1,0),s;console.warn("no rect!")}}}function makePopupArea(t,e,i={}){let s=UIBase.createElement("screenarea-x"),r=i.width||.7*e.size[0],a=i.height||.7*e.size[1],n=void 0===i.addEscapeKeyHandler||i.addEscapeKeyHandler;return s.ctx=e.ctx,s.size[0]=r,s.size[1]=a,s.pos[0]=100,s.pos[1]=100,s.pos[0]=Math.min(s.pos[0],e.size[0]-s.size[0]-2),s.pos[1]=Math.min(s.pos[1],e.size[1]-s.size[1]-2),s.switch_editor(t),s.overrideClass("popup"),s.style["background-color"]=s.getDefault("background-color"),s.style["border-radius"]=s.getDefault("border-radius")+"px",s.style["border-color"]=s.getDefault("border-color"),s.style["border-style"]=s.getDefault("border-style"),s.style["border-width"]=s.getDefault("border-width")+"px",s.flag|=AreaFlags.FLOATING|AreaFlags.INDEPENDENT,e.appendChild(s),s.setCSS(),n&&(s.on_keydown=t=>{t.keyCode===keymap$4.Escape&&e.removeArea(s)}),s.bringToFront(),s}UIBase$f.internalRegister(AreaDocker);let Area=Area$1;function list(t){let e=[];for(let i of t)e.push(i);return e}startMenuEventWrangling();let _events_started=!1;function registerToolStackGetter(t){registerToolStackGetter$1(t)}let Vector2=Vector2$b,UIBase$1=UIBase$f,styleScrollBars=styleScrollBars$1,update_stack=new Array(8192);update_stack.cur=0;let screen_idgen=0,get_screen_cb,_on_keydown;function purgeUpdateStack(){for(let t=0;t<update_stack.length;t++)update_stack[t]=void 0}class Screen extends UIBase$f{constructor(){super(),this.snapLimit=1,this.fullScreen=!0,this.globalCSS=document.createElement("style"),this.shadow.prepend(this.globalCSS),this._do_updateSize=!0,this._resize_callbacks=[],this.allBordersMovable=exports.DEBUG.allBordersMovable,this.needsBorderRegen=!0,this._popup_safe=0,this.testAllKeyMaps=!1,this.needsTabRecalc=!0,this._screen_id=screen_idgen++,this._popups=[],this._ctx=void 0,this.keymap=new KeyMap,this.size=new Vector2([window.innerWidth,window.innerHeight]),this.pos=new Vector2,this.oldpos=new Vector2,this.idgen=0,this.sareas=[],this.sareas.active=void 0,this.mpos=[0,0],this.screenborders=[],this.screenverts=[],this._vertmap={},this._edgemap={},this._idmap={},this._aabb=[new Vector2,new Vector2];let t=(t,e,i)=>{let s="mousemove"===t.type||"touchmove"===t.type||"pointermove"===t.type;if(s=s&&(t.buttons||t.touches&&t.touches.length>0),!s&&Math.random()>.9){let s=this.pickElement(e,i,{sx:1,sy:1,nodeclass:ScreenArea,mouseEvent:t});0,void 0!==s&&(s.area&&(s.area.push_ctx_active(),s.area.pop_ctx_active()),this.sareas.active=s)}this.mpos[0]=e,this.mpos[1]=i};this.shadow.addEventListener("mousemove",(e=>t(e,e.x,e.y)),{passive:!0})}get borders(){let t=this;return function*(){for(let e in t._edgemap)yield t._edgemap[e]}()}get listening(){return void 0!==this.listen_timer}get ctx(){return this._ctx}set ctx(t){this._ctx=t;let e=i=>{i instanceof UIBase$1&&(i.ctx=t);for(let t of i.childNodes)e(t);if(i.shadow)for(let t of i.shadow.childNodes)e(t)};for(let t of this.childNodes)e(t);for(let t of this.shadow.childNodes)e(t)}static fromJSON(t,e=!1){return UIBase$1.createElement(this.define().tagname).loadJSON(t,e)}static define(){return{tagname:"pathux-screen-x"}}static newSTRUCT(){return UIBase$1.createElement(this.define().tagname)}setPosSize(t,e,i,s){this.pos[0]=t,this.pos[1]=e,this.size[0]=i,this.size[1]=s,this.setCSS(),this._internalRegenAll()}setSize(t,e){this.size[0]=t,this.size[1]=e,this.setCSS(),this._internalRegenAll()}setPos(t,e){this.pos[0]=t,this.pos[1]=e,this.setCSS(),this._internalRegenAll()}init(){super.init(),this.hasAttribute("listen")&&this.listen()}mergeGlobalCSS(t){return new Promise(((e,i)=>{let s,r=()=>{let t=this.globalCSS.sheet;if(!t)return void this.doOnce(r);let e={};for(let i of t.rules)e[i.selectorText]=i;for(let i of s.rules){let s=i.selectorText;if(s in e){let t=e[s];if(!i.styleMap){for(let e in i.style){let s=Object.getOwnPropertyDescriptor(i.style,e);s&&s.writable&&(i.style[e]&&(t.style[e]=i.style[e]))}continue}for(let[e,s]of list(i.styleMap.entries())){let i="";if(Array.isArray(s)){for(let t of s)i+=" "+s;i=i.trim()}else i=(""+s).trim();t.style[e]=i,t.styleMap.set(e,s)}}else t.insertRule(i.cssText)}};if("string"==typeof t){try{s=new CSSStyleSheet}catch(t){s=void 0}if(s&&s.replaceSync)s.replaceSync(t),r();else{let e=document.createElement("style");e.textContent=t,document.body.appendChild(e);let i=()=>{e.sheet?(s=e.sheet,r(),e.remove()):this.doOnce(i)};this.doOnce(i)}}else t instanceof CSSStyleSheet?(s=t,r()):(s=t.sheet,r())}))}newScreenArea(){let t=UIBase$1.createElement("screenarea-x");return t.ctx=this.ctx,t.ctx&&t.init(),t}copy(){let t=UIBase$1.createElement(this.constructor.define().tagname);t.ctx=this.ctx,t._init();for(let e of this.sareas){let i=e.copy(t);i._ctx=this.ctx,i.screen=t,i.parentWidget=t,t.appendChild(i)}for(let e of t.sareas){e.ctx=this.ctx,e.area.ctx=this.ctx,e.area.push_ctx_active(),e._init(),e.area._init(),e.area.pop_ctx_active();for(let t of e.editors)t.ctx=this.ctx,t.push_ctx_active(),t._init(),t.pop_ctx_active()}return t.update(),t.regenBorders(),t.setCSS(),t}findScreenArea(t,e){for(let i=this.sareas.length-1;i>=0;i--){let s=this.sareas[i],r=t>=s.pos[0]&&t<=s.pos[0]+s.size[0];if(r=r&&e>=s.pos[1]&&e<=s.pos[1]+s.size[1],r)return s}}pickElement(t,e,i,s,r,a){let n;if("object"==typeof i?(r=i.nodeclass,a=i.excluded_classes):i={nodeclass:r,excluded_classes:a},this.ctx){for(let s=this._popups.length-1;s>=0;s--){let r=this._popups[s];n=n||r.pickElement(t,e,i)}return n=n||super.pickElement(t,e,i),n}console.warn("no ctx in screen")}_enterPopupSafe(){void 0===this._popup_safe&&(this._popup_safe=0),this._popup_safe++}*_allAreas(){for(let t of this.sareas)for(let e of t.editors)yield[e,e._area_id,t]}_exitPopupSafe(){this._popup_safe=Math.max(this._popup_safe-1,0)}popupMenu(t,e,i){startMenu(t,e,i);for(let e=0;e<3;e++)t.flushSetCSS(),t.flushUpdate();return t}popup(t,e,i,s=!0,r=5){let a=this._popup(...arguments);for(let t=0;t<2;t++)a.flushUpdate(),a.flushSetCSS();if(0===r)return a;let n=a.style["z-index"];a.style["z-index"]="-10";let o=()=>{let t=a.getClientRects()[0],e=this.size;t?(t.bottom>e[1]?a.style.top=e[1]-t.height-10+"px":t.top<0&&(a.style.top="10px"),t.right>e[0]?a.style.left=e[0]-t.width-10+"px":t.left<0&&(a.style.left="10px"),a.style["z-index"]=n,a.flushUpdate(),a.flushSetCSS()):this.doOnce(o)};return setTimeout(o,r),a}draggablePopup(t,e){let i=UIBase$1.createElement("drag-box-x");return i.ctx=this.ctx,i.parentWidget=this,i._init(),this._popups.push(i),i._onend=()=>{this._popups.indexOf(i)>=0&&this._popups.remove(i)},i.style["z-index"]=205,i.style.position=UIBase$1.PositionKey,i.style.left=t+"px",i.style.top=e+"px",document.body.appendChild(i),i}_popup(t,e,i,s=!0){let r,a=this.sareas.active,n=t;for(;n;){if(n instanceof ScreenArea){a=n;break}n=n.parentWidget}if("object"==typeof e){let t=e.getClientRects()[0];r=t.x,i=t.y}else r=e;r+=window.scrollX,i+=window.scrollY;let o=UIBase$1.createElement("container-x");o.ctx=this.ctx,o._init();let l=o.remove;o.remove=()=>(this._popups.indexOf(o)>=0&&this._popups.remove(o),l.apply(o,arguments)),o.overrideClass("popup"),o.background=o.getDefault("background-color"),o.style["border-radius"]=o.getDefault("border-radius")+"px",o.style["border-color"]=o.getDefault("border-color"),o.style["border-style"]=o.getDefault("border-style"),o.style["border-width"]=o.getDefault("border-width")+"px",o.style["box-shadow"]=o.getDefault("box-shadow"),o.style.position=UIBase$1.PositionKey,o.style["z-index"]="2205",o.style.left=r+"px",o.style.top=i+"px",o.style.margin="0px",o.parentWidget=this;let h,c,d;new MinMax(2),new Vector2,o.update;o.update.after((()=>{o.style["z-index"]="2205"})),document.body.appendChild(o),this.setCSS(),this._popups.push(o);let u=!1,p=()=>{this._popup_safe||u||(this.ctx.screen.removeEventListener("mousedown",c,!0),this.ctx.screen.removeEventListener("mousemove",c,{passive:!0}),this.ctx.screen.removeEventListener("mouseup",c,!0),window.removeEventListener("keydown",d),u=!0,o.remove())};o.end=p;let m=o.remove;o.remove=function(){0==arguments.length&&p(),m.apply(this,arguments)},o._ondestroy=()=>{p()};let f=time_ms(),g=time_ms();return c=(t,e,i,r=!0)=>{if(!o.isConnected)return void p();if(a&&a.area&&(a.area.push_ctx_active(),a.area.pop_ctx_active()),time_ms()-g<350)return;g=time_ms(),e=void 0===e?t.x:e,i=void 0===i?t.y:i;let n=this.pickElement(e,i,{sx:2,sy:2,excluded_classes:[ScreenBorder],mouseEvent:t});if(void 0===n)return void(s&&p());let l=!1;for(;n;){if(n===o){l=!0;break}n=n.parentWidget}l?f=time_ms():(r=!r||time_ms()-f>100,s&&r&&p())},h=t=>{let e=t.touches[0].pageX,i=t.touches[0].pageY;return c(t,e,i,!1)},d=t=>{if(o.isConnected){if(t.keyCode===keymap$4.Escape)p()}else window.removeEventListener("keydown",d)},this.ctx.screen.addEventListener("mousedown",c,!0),this.ctx.screen.addEventListener("mousemove",c,{passive:!0}),this.ctx.screen.addEventListener("mouseup",c,!0),window.addEventListener("keydown",d),this.calcTabOrder(),o}_recalcAABB(t=!0){let e=new MinMax(2);for(let t of this.screenverts)e.minmax(t);return t&&(this._aabb[0].load(e.min),this._aabb[1].load(e.max)),[new Vector2(e.min),new Vector2(e.max)]}load(){}save(){}popupArea(t){return makePopupArea(t,this)}remove(t=!0){if(this.unlisten(),t)return super.remove();HTMLElement.prototype.remove.call(this)}unlisten(){void 0!==this.listen_timer&&(window.clearInterval(this.listen_timer),this.listen_timer=void 0)}checkCSSSize(){let t=this.style.width.toLowerCase().trim(),e=this.style.height.toLowerCase().trim();t.endsWith("px")&&e.endsWith("px")&&(t=parseFloat(t.slice(0,t.length-2).trim()),e=parseFloat(e.slice(0,e.length-2).trim()),t===this.size[0]&&e===this.size[1]||(this.on_resize([this.size[0],this.size[1]],[t,e]),this.size[0]=t,this.size[1]=e))}getBoolAttribute(t,e=!1){if(!this.hasAttribute(t))return e;let i=this.getAttribute(t);return"number"==typeof i||"string"==typeof i&&(i=i.toLowerCase().trim(),i="true"===i||"1"===i||"yes"===i),!!i}updateSize(){if(this.getBoolAttribute("inherit-scale")||!this.fullScreen||!exports.autoSizeUpdate)return void this.checkCSSSize();let t=window.innerWidth,e=window.innerHeight,i=(window.outerHeight,window.innerHeight,visualViewport.scale);t=visualViewport.width*i-4,e=visualViewport.height*i-4;let s=visualViewport.offsetLeft,r=visualViewport.offsetTop;if(exports.DEBUG.customWindowSize){let i=exports.DEBUG.customWindowSize;t=i.width,e=i.height,s=0,r=0,window._DEBUG=exports.DEBUG}let a=this._calcSizeKey(t,e,s,r,devicePixelRatio,i);if(document.body.style.margin=document.body.style.padding="0px",document.body.style["transform-origin"]="top left",document.body.style.transform=`translate(${s}px,${r}px) scale(${1/i})`,a!==this._last_ckey1){this._last_ckey1=a,this.on_resize(this.size,[t,e],!1),this.on_resize(this.size,this.size,!1);visualViewport.scale;this.regenBorders(),this.setCSS(),this.completeUpdate()}}listen(t={updateSize:!0}){setWranglerScreen(this);let e=this.ctx;startEvents((()=>e.screen)),void 0===this.listen_timer&&(this._do_updateSize=void 0===t.updateSize||t.updateSize,this.listen_timer=window.setInterval((()=>{if(this.isDead())return console.log("dead screen"),void this.unlisten();this.update()}),150))}_calcSizeKey(t,e,i,s,r,a){if(6!==arguments.length)throw new Error("eek");let n="";for(let t=0;t<arguments.length;t++)n+=arguments[t].toFixed(0)+":";return n}_ondestroy(){getWranglerScreen(),this.unlisten();let t=(e,i,s)=>{e.__pass!==i?(e.__pass=i,e._forEachChildWidget((s=>{if(e!==s){t(s,i,e);try{i||s.__destroyed||(s.__destroyed=!0,s._ondestroy())}catch(t){print_stack(t),console.log("failed to exectue an ondestroy callback")}s.__destroyed=!0;try{i&&s.remove()}catch(t){print_stack(t),console.log("failed to remove element after ondestroy callback")}}}))):console.warn("CYCLE IN DOM TREE!",e,s)},e=~~(1024*Math.random()*1024);t(this,e),t(this,e+1)}destroy(){this._ondestroy()}clear(){this._ondestroy(),this.sareas=[],this.sareas.active=void 0;for(let t of list(this.childNodes))t.remove();for(let t of list(this.shadow.childNodes))t.remove()}_test_save(){let t=JSON.parse(JSON.stringify(this));console.log(JSON.stringify(this)),this.loadJSON(t)}loadJSON(t,e=!1){this.clear(),super.loadJSON();for(let e of t.sareas){let t=UIBase$1.createElement("screenarea-x");t.ctx=this.ctx,t.screen=this,this.appendChild(t),t.loadJSON(e)}this.regenBorders(),this.setCSS(),e&&window.setTimeout((()=>{this.on_resize(this.size,[window.innerWidth,window.innerHeight])}),50)}toJSON(){let t={sareas:this.sareas};return t.size=this.size,t.idgen=this.idgen,Object.assign(super.toJSON(),t)}getHotKey(t){let e=e=>{for(let i of e)if("string"==typeof i.action&&i.action.trim().startsWith(t.trim()))return i},i=e(this.keymap);if(i)return i;if(this.sareas.active&&this.sareas.active.keymap){let t=this.sareas.active.area;for(let s of t.getKeyMaps())if(i=e(s),i)return i}if(void 0===i)for(let t of this.sareas){let s=t.area;for(let t of s.getKeyMaps())if(i=e(t),i)return i}}addEventListener(t,e,i){if("resize"!==t)return super.addEventListener(t,e,i);this._resize_callbacks.push(e)}removeEventListener(t,e,i){if("resize"!==t)return super.removeEventListener(t,e,i);this._resize_callbacks.indexOf(e)>=0&&this._resize_callbacks.remove(e)}execKeyMap(t){let e=!1;if(window.DEBUG&&window.DEBUG.keymap&&console.warn("execKeyMap called",t.keyCode,document.activeElement.tagName),this.sareas.active){let i=this.sareas.active.area;if(!i)return;i.push_ctx_active();for(let s of i.getKeyMaps())if(void 0!==s&&s.handle(i.ctx,t)){e=!0;break}i.pop_ctx_active()}if(e=e||this.keymap.handle(this.ctx,t),!e&&this.testAllKeyMaps)for(let i of this.sareas){if(e)break;i.area.push_ctx_active();for(let s of i.area.getKeyMaps())if(s.handle(i.area.ctx,t)){e=!0;break}i.area.pop_ctx_active()}return e}calcTabOrder(){let t=[],e={},i=s=>{let r=s.tabIndex<0||void 0===s.tabIndex||null===s.tabIndex;r=r||!(s instanceof UIBase$1),s._id in e||s.hidden||(e[s._id]=1,r||(s.__pos=s.getClientRects()[0],s.__pos&&t.push(s)),s._forEachChildWidget((t=>{i(t)})))};for(let t of this.sareas)i(t);for(let t of this._popups)i(t);for(let e=0;e<t.length;e++){t[e].tabIndex=e+1}}drawUpdate(){void 0!==window.redraw_all&&window.redraw_all()}update(){let t=[];for(let e of this.childNodes)e instanceof ScreenArea$1&&t.push(e);for(let e of t)console.warn("moved screen area to shadow"),HTMLElement.prototype.remove.call(e),this.shadow.appendChild(e);this._do_updateSize&&this.updateSize(),this.needsTabRecalc&&(this.needsTabRecalc=!1,this.calcTabOrder());t:for(let t of this.sareas)for(let e of t._borders){if(this.isBorderMovable(e)!==e.movable){console.log("detected change in movable borders"),this.regenBorders();break t}}if(this._update_gen){let t;try{t=this._update_gen.next()}catch(t){return void(t instanceof DataPathError||(print_stack$1(t),console.log("error in update_intern tasklet")))}void 0!==t&&t.done&&(this._update_gen=void 0)}else this._update_gen=this.update_intern()}purgeUpdateStack(){this._update_gen=void 0,purgeUpdateStack()}completeSetCSS(){let t=e=>{e.setCSS(),e.packflag&PackFlags$a.NO_UPDATE||e._forEachChildWidget((e=>{t(e)}))};t(this)}completeUpdate(){for(let t of this.update_intern());}updateScrollStyling(){let t=theme.scrollbars;if(!t||!t.color)return;let e=t.color+":"+t.color2+":"+t.border+":"+t.contrast+":"+t.width;e!==this._last_scrollstyle_key&&(this._last_scrollstyle_key=e,this.mergeGlobalCSS(styleScrollBars(t.color,t.color2,t.contrast,t.width,t.border,"*")))}update_intern(){this.updateScrollStyling();let t=this._popups,e="",i=this.globalCSS.sheet;if(i){for(let t of i.rules)e+=t.cssText+"\n";window.cssText=e}let s=strhash(e);this.needsBorderRegen&&(this.needsBorderRegen=!1,this.regenBorders()),super.update();let r=this;for(let t of this.sareas)t.ctx||(t.ctx=this.ctx);return function*(){let i=update_stack;i.cur=0;function a(t){i[i.cur++]=t}function n(t){if(i.cur<0)throw new Error("Screen.update(): stack overflow!");return i[--i.cur]}let o=r.ctx,l=Symbol("pop"),h=Symbol("pop2"),c=[],d=[],u=time_ms();a(r);for(let e of t)a(e);for(;i.cur>0;){let t=n();if(void 0!==t)if(t!==l)if(t!==h){t instanceof Area&&(d.push(t),t.push_ctx_active(o,!0),a(h)),!t.hidden&&t!==r&&t instanceof UIBase$1&&(t._ctx||(t._ctx=o),t._screenStyleUpdateHash!==s&&(t._screenStyleTag.textContent=e,t._screenStyleUpdateHash=s),c.length>0&&c[c.length-1]&&(t.parentWidget=c[c.length-1]),t.update()),time_ms()-u>20&&(yield,u=time_ms());for(let e of t.childNodes)e instanceof UIBase$1&&e.packflag&PackFlags$a.NO_UPDATE||a(e);if(void 0!==t.shadow){for(let e of t.shadow.childNodes)e instanceof UIBase$1&&e.packflag&PackFlags$a.NO_UPDATE||a(e);t instanceof UIBase$1&&(t.packflag&PackFlags$a.NO_UPDATE||(c.push(t),a(l)))}}else d.pop().pop_ctx_active(o,!0);else c.pop()}}()}loadFromVerts(){let t=[0,0];for(let e of this.sareas)t[0]=e.size[0],t[1]=e.size[1],e.loadFromVerts(),e.on_resize(t),e.setCSS();this.setCSS()}collapseArea(t,e){let i;if(e)e.locked&&console.warn("Cannot remove screen border");else for(let i of t._borders){if(i.getOtherSarea(t)&&!i.locked){e=i;break}}if(console.warn("SAREA2",e,i,i!==t),e){if(i=e.getOtherSarea(t),!i)return void console.error("Error merging sarea");let s=new Vector2(t.pos).add(t.size),r=new Vector2(i.pos).add(i.size);i.pos.min(t.pos),i.size.load(s).max(r).sub(i.pos),i.loadFromPosSize()}return this.sareas.remove(t),t.remove(),this.regenScreenMesh(),this._internalRegenAll(),this}splitArea(t,e=.5,i=!0){let s,r,a=t.size[0],n=t.size[1];t.pos[0],t.size[1];return i?(s=t,void 0===s.ctx&&(s.ctx=this.ctx),r=s.copy(this),s.size[1]*=e,r.size[1]*=1-e,r.pos[1]+=n*e):(s=t,void 0===s.ctx&&(s.ctx=this.ctx),r=s.copy(this),s.size[0]*=e,r.size[0]*=1-e,r.pos[0]+=a*e),r.ctx=this.ctx,this.appendChild(r),s.on_resize(s.size),r.on_resize(r.size),this.regenBorders(),this.solveAreaConstraints(),s.setCSS(),r.setCSS(),this.setCSS(),void 0!==r.area&&r.area.onadd(),r}setCSS(){this.getBoolAttribute("inherit-scale")||(this.style.width=this.size[0]+"px",this.style.height=this.size[1]+"px"),this.style.overflow="hidden";for(let t in this._edgemap){this._edgemap[t].setCSS()}}regenScreenMesh(t=SnapLimit){this.snapLimit=t,this.regenBorders()}regenBorders_stage2(){for(let t of this.screenborders)t.halfedges=[];function t(t,e,i){for(let s of t.halfedges)if(e===s.border&&i===s.sarea)return!0;return!1}for(let e of this.screenborders){for(let t of e.sareas){let i=new ScreenHalfEdge(e,t);e.halfedges.push(i)}let i=e.horiz?1:0,s=Math.min(e.v1[i],e.v2[i]),r=Math.max(e.v1[i],e.v2[i]);for(let a of this.walkBorderLine(e)){if(e===a)continue;let n=a.v1[i]>=s&&a.v1[i]<=r;n=n||a.v2[i]>=s&&a.v2[i]<=r;for(let i of a.sareas){if(n&&!t(a,e,i)){let t=new ScreenHalfEdge(a,i);e.halfedges.push(t)}}}}for(let t of this.screenborders){let e=!0;for(let i of t.sareas)e=e&&this.isBorderMovable(t);t.movable=e}}hasBorder(t){return t._id in this._idmap}killScreenVertex(t){return this.screenverts.remove(t),delete this._edgemap[ScreenVert.hash(t,void 0,this.snapLimit)],delete this._idmap[t._id],this}freeBorder(t,e){t.sareas.indexOf(e)>=0&&t.sareas.remove(e);let i=[];for(let s of t.halfedges){s.sarea===e&&i.push([t,s]);for(let t of s.border.halfedges)t!==s&&t.sarea===e&&i.push([s.border,t])}for(let t of i)t[0].halfedges.indexOf(t[1])<0?console.warn("Double remove detected; use util.set?"):t[0].halfedges.remove(t[1]);0===t.sareas.length&&this.killBorder(t)}killBorder(t){if(console.log("killing border",t._id,t),this.screenborders.indexOf(t)<0)return console.log("unknown border",t),void t.remove();this.screenborders.remove(t);let e=[];for(let i of t.halfedges)if(i!==he2)for(let s of i.border.halfedges)s.border===t&&e.push([i.border,s]);for(let t of e)t[0].halfedges.remove(t[1]);return delete this._edgemap[ScreenBorder.hash(t.v1,t.v2)],delete this._idmap[t._id],t.v1.borders.remove(t),t.v2.borders.remove(t),0===t.v1.borders.length&&this.killScreenVertex(t.v1),0===t.v2.borders.length&&this.killScreenVertex(t.v2),t.remove(),this}regenBorders(){for(let t of this.screenborders)t.remove();this._idmap={},this.screenborders=[],this._edgemap={},this._vertmap={},this.screenverts=[];for(let t of this.sareas)t.hidden||t.makeBorders(this);for(let t in this._edgemap){this._edgemap[t].setCSS()}this.regenBorders_stage2(),this._recalcAABB();for(let t of this.screenborders)t.outer=this.isBorderOuter(t),t.movable=this.isBorderMovable(t),t.setCSS();this.updateDebugBoxes()}_get_debug_overlay(){if(!this._debug_overlay){this._debug_overlay=UIBase$1.createElement("overdraw-x"),this._debug_overlay.startNode(this,this)}return this._debug_overlay}updateDebugBoxes(){if(exports.DEBUG.screenborders){let t=this._get_debug_overlay();t.clear();for(let e of this.screenborders)t.line(e.v1,e.v2,"red");let e=[];for(let t of document.body.childNodes)t.getAttribute&&"__debug"===t.getAttribute("class")&&e.push(t);for(let t of e)t.remove();let i=(t,e,i,s,r="red")=>{t-=.5*i,e-=.5*i,t=Math.min(Math.max(t,0),this.size[0]-i),e=Math.min(Math.max(e,0),this.size[1]-i);let a=UIBase$1.createElement("div");a.setAttribute("class","__debug"),a.style.position=UIBase$1.PositionKey,a.style.left=t+"px",a.style.top=e+"px",a.style.height=i+"px",a.style.width=i+"px",a.style["z-index"]="1000",a.style["pointer-events"]="none",a.style.padding=a.style.margin="0px",a.style.display="float",a.style["background-color"]=r,document.body.appendChild(a);let n=["orange","black","white"];for(let r=2;r>=0;r--){a=UIBase$1.createElement("div"),a.setAttribute("class","__debug"),a.style.position=UIBase$1.PositionKey,a.style.left=t+"px",a.style.top=e+"px",a.style.height=i+"px",a.style.width="250px",a.style["z-index"]=""+(1005-r-1),a.style["pointer-events"]="none",a.style.color=n[r];let o=2*r;a.style["-webkit-text-stroke-width"]=o+"px",a.style["-webkit-text-stroke-color"]=n[r],a.style["text-stroke-width"]=o+"px",a.style["text-stroke-color"]=n[r],a.style.padding=a.style.margin="0px",a.style.display="float",a.style["background-color"]="rgba(0,0,0,0)",a.innerText=""+s,document.body.appendChild(a)}};for(let t of this.screenverts)i(t[0],t[1],10*t.borders.length,""+t.borders.length,"rgba(255,0,0,0.5)");for(let t of this.screenborders)for(let e of t.halfedges){let s=`${e.side}, ${t.sareas.length}, ${t.halfedges.length}`,r=new Vector2(t.v1).add(t.v2).mulScalar(.5),a=10*t.halfedges.length,n=25+.5*a,o=1&t.horiz;r[o]>e.sarea.pos[o]?r[o]-=n:r[o]+=n,i(r[0],r[1],a,s,"rgba(155,255,75,0.5)")}}}checkAreaConstraint(t,e=!1){let i=t.minSize,s=t.maxSize,r=(t._verts,0),a=0,n=(e,i,s)=>{let r=t._borders[e],a=t._borders[i],n=0;for(let i=0;i<2;i++){let s=i?a:r,o=t.borderLock&1<<e;o=o||!s.movable,o=o||this.isBorderOuter(s),o&&(n|=1<<i)}0===n?(this.moveBorder(r,.5*s),this.moveBorder(a,.5*-s)):1===n?this.moveBorder(a,-s):2===n?this.moveBorder(r,s):3===n&&(this.isBorderOuter(r)?this.isBorderOuter(a)?(this.moveBorder(r,.5*s),this.moveBorder(a,.5*-s)):this.moveBorder(a,-s):this.moveBorder(r,s))};if(void 0!==s[0]&&t.size[0]>s[0]){let e=t.size[0]-s[0];r+=Math.abs(e),a|=1,n(0,2,e)}if(void 0!==i[0]&&t.size[0]<i[0]){let e=i[0]-t.size[0];r+=Math.abs(e),a|=2,n(2,0,e)}if(void 0!==s[1]&&t.size[1]>s[1]){let e=t.size[1]-s[1];r+=Math.abs(e),a|=4,n(3,1,e)}if(void 0!==i[1]&&t.size[1]<i[1]){let e=i[1]-t.size[1];r+=Math.abs(e),a|=8,n(1,3,e)}if(t.pos[0]+t.size[0]>this.size[0]){a|=16;let e=this.size[0]-t.size[0]-t.pos[0];r+=Math.abs(e),t.floating?(t.pos[0]=this.size[0]-t.size[0],t.loadFromPosSize()):(this.moveBorder(t._borders[0],e),this.moveBorder(t._borders[2],e))}return 0!==r&&a}walkBorderLine(t){let e=new set$2,i=[t];e.add(t);let s=(t,r)=>{for(let a of r.borders)a!==t&&(a.horiz!==t.horiz||e.has(a)||(e.add(a),i.push(a),s(a,a.otherVertex(r))))};s(t,t.v1);let r=i;return i=[],s(t,t.v2),r.reverse(),r.concat(i)}moveBorderWithoutVerts(t,e){let i=t.side,s=t.sarea;switch(i){case 0:s.pos[0]+=e,s.size[0]-=e;break;case 1:s.size[1]+=e;break;case 2:s.size[0]+=e;break;case 3:s.pos[1]+=e,s.size[1]-=e}}moveBorder(t,e,i=!0){return this.moveBorderSimple(t,e,i)}moveBorderSimple(t,e,i=!0){let s=1&t.horiz,r=1^s,a=Math.min(t.v1[r],t.v2[r]),n=Math.max(t.v1[r],t.v2[r]),o=t=>t[r]>=a&&t[r]<=n,l=new set$2;for(let e of this.walkBorderLine(t)){if(i&&!o(e.v1)&&!o(e.v2))return!1;l.add(e.v1),l.add(e.v2)}for(let t of l)t[s]+=e;for(let t of l)for(let e of t.borders)for(let t of e.sareas)t.loadFromVerts();return!0}moveBorderUnused(t,e,i=!0){if(!t)return console.warn("missing border"),!1;let s=1&t.horiz,r=new set$2,a=(new set$2,1^s),n=Math.min(t.v1[a],t.v2[a]),o=Math.max(t.v1[a],t.v2[a]),l=t=>t[a]>=n&&t[a]<=o,h=!0,c=!1,d=new set$2,u=new set$2;for(let s of this.walkBorderLine(t)){if(!i){r.add(s.v1),r.add(s.v2);continue}let t=l(s.v1),a=l(s.v2);if(t&&a||(c=!0,h&&(h=!1,e=Math.max(Math.abs(e),SnapLimit)*Math.sign(e))),t||a){u.add(s);for(let t of s.sareas)d.add(new ScreenHalfEdge(s,t));r.add(s.v1),r.add(s.v2)}}for(let e of this.walkBorderLine(t))if(!u.has(e))for(let t of e.halfedges)u.remove(t.border),d.has(t)&&d.remove(t);for(let t of r){t[a]>=n&&t[a]}if(c&&i){let t=new set$2;for(let i of d)t.add(i.border),this.moveBorderWithoutVerts(i,e);for(let t of d)t.sarea.loadFromPosSize();for(let e of t){let t=e.sareas.slice(0,e.sareas.length);this.killBorder(e);for(let e of t)e.loadFromPosSize()}return d.length>0}for(let t of r)t[s]+=e;for(let e of t.sareas)e.loadFromVerts();for(let e of t.halfedges){e.sarea.loadFromVerts();for(let t of e.border.sareas){t.loadFromVerts();for(let e of t._borders)e.setCSS()}}return t.setCSS(),!0}solveAreaConstraints(t=!0){let e=!1,i=!1,s=time_ms();for(let s=0;s<10;s++){e=!1;for(let t of this.sareas)t.hidden||(e=e||this.checkAreaConstraint(t));if(i=i||e,!e)break;for(let t of this.sareas)t.loadFromVerts();this.snapScreenVerts(t)}i&&(this.snapScreenVerts(t),exports.DEBUG.areaConstraintSolver&&(s=time_ms()-s,console.log(`enforced area constraint ${s.toFixed(2)}ms`)),this._recalcAABB(),this.setCSS())}snapScreenVerts(t=!0){let e=this;function*i(){for(let t of e.screenverts){let e=0;for(let i of t.sareas)i.flag&AreaFlags.INDEPENDENT||(e=1);e&&(yield t)}}let s=new MinMax(2);for(let t of i())s.minmax(t);let r=s.min,a=s.max;if(t){let t=new Vector2(a).sub(r),e=new Vector2(this.size);e.div(t);for(let t of i())t.sub(r).mul(e);for(let t of i())t[0]+=this.pos[0],t[1]+=this.pos[1]}else{for(let t of i());[r,a]=this._recalcAABB(),this.size.load(a).sub(r)}let n=1;for(let t of this.sareas){if(t.hidden)continue;let e=new Vector2(t.size),i=new Vector2(t.pos);t.loadFromVerts(),n=n||e.vectorDistance(t.size)>1,n=n||i.vectorDistance(t.pos)>1,t.on_resize(e)}n&&(this._recalcAABB(),this.setCSS())}on_resize(t,e=this.size,i=!0){i&&(this._last_ckey1=this._calcSizeKey(e[0],e[1],this.pos[0],this.pos[1],devicePixelRatio,visualViewport.scale));let s=[e[0]/t[0],e[1]/t[1]],r=this.pos[0]-this.oldpos[0],a=this.pos[1]-this.oldpos[1];this.oldpos.load(this.pos);for(let t of this.screenverts)t[0]*=s[0],t[1]*=s[1],t[0]+=r,t[1]+=a;let n=[];for(let t of this.sareas)n.push([t.size[0],t.size[1]]),t.loadFromVerts();this.size[0]=e[0],this.size[1]=e[1],this.snapScreenVerts(),this.solveAreaConstraints(),this._recalcAABB();let o=0;for(let t of this.sareas)t.on_resize(t.size,n[o]),t.setCSS(),o++;this.regenBorders(),this.setCSS(),this.calcTabOrder(),this._fireResizeCB(t)}_fireResizeCB(t=this.size){for(let e of this._resize_callbacks)e(t)}getScreenVert(t,e="",i=!1){let s=ScreenVert.hash(t,e,this.snapLimit);if(i||!(s in this._vertmap)){let i=new ScreenVert(t,this.idgen++,e);this._vertmap[s]=i,this._idmap[i._id]=i,this.screenverts.push(i)}return this._vertmap[s]}isBorderOuter(t){let e=0;for(let i of t.halfedges)e|=1<<i.side;let i=0;for(let t=0;t<4;t++)i+=e&1<<t?1:0;let s=i<2,r=!1;for(let e of t.sareas)r=r||e.floating;if(r){let e=t.horiz?1:0;s=Math.abs(t.v1[e]-this.pos[e])<4,s=s||Math.abs(t.v1[e]-this.pos[e]-this.size[e])<4}return t.outer=s,s}isBorderMovable(t,e=5){if(this.allBordersMovable)return!0;for(let e of t.halfedges)if(e.sarea.borderLock&1<<e.side)return!1;let i=!this.isBorderOuter(t);for(let e of t.sareas)if(e.floating){i=!0;break}return i}getScreenBorder(t,e,i,s){let r=t._get_v_suffix();e instanceof ScreenVert||(e=this.getScreenVert(e,r)),i instanceof ScreenVert||(i=this.getScreenVert(i,r));let a=ScreenBorder.hash(e,i);if(!(a in this._edgemap)){let t=this._edgemap[a]=UIBase$1.createElement("screenborder-x");t._hash=a,t.screen=this,t.v1=e,t.v2=i,t._id=this.idgen++,e.borders.push(t),i.borders.push(t),t.ctx=this.ctx,this.screenborders.push(t),this.appendChild(t),t.setCSS(),this._edgemap[a]=t,this._idmap[t._id]=t}return this._edgemap[a]}minmaxArea(t,e){void 0===e&&(e=new MinMax(2));for(let i of t._borders)e.minmax(i.v1),e.minmax(i.v2);return e}areasBorder(t,e){for(let i of t._borders)for(let t of i.sareas)if(t===e)return!0;return!1}replaceArea(t,e){t!==e&&(e.pos[0]=t.pos[0],e.pos[1]=t.pos[1],e.size[0]=t.size[0],e.size[1]=t.size[1],e.floating=t.floating,e._borders=t._borders,e._verts=t._verts,this.sareas.indexOf(e)<0&&(this.sareas.push(e),this.shadow.appendChild(e)),this.sareas.active===t&&(this.sareas.active=e),this.sareas.remove(t),t.remove(),this.regenScreenMesh(),this.snapScreenVerts(),this._updateAll())}_internalRegenAll(){this.snapScreenVerts(),this._recalcAABB(),this.calcTabOrder(),this.setCSS(),this.completeUpdate(),this.completeSetCSS(),this.completeUpdate()}_updateAll(){for(let t of this.sareas)t.setCSS();this.setCSS(),this.update()}removeArea(t){if(this.sareas.indexOf(t)<0)console.warn(t,"<- Warning: tried to remove unknown area");else{this.sareas.remove(t),t.remove();for(let t=0;t<2;t++)this.snapScreenVerts(),this.regenScreenMesh();this._updateAll(),this.drawUpdate()}}appendChild(t){if(t instanceof ScreenArea){if(t.screen=this,t.ctx=this.ctx,t.parentWidget=this,this.sareas.push(t),0===t.size.dot(t.size)&&(t.size[0]=this.size[0],t.size[1]=this.size[1]),!t._has_evts){t._has_evts=!0;let e=e=>{this.sareas.active=t},i=t=>{};t.addEventListener("focus",e),t.addEventListener("mouseenter",e),t.addEventListener("blur",i),t.addEventListener("mouseleave",i)}this.regenBorders(),t.setCSS(),this.drawUpdate(),t._init()}return this.shadow.appendChild(t)}add(t){return this.appendChild(t)}hintPickerTool(){new ToolTipViewer(this).start()}removeAreaTool(t){new RemoveAreaTool(this,t).start()}moveAttachTool(t,e=this.mpos,i,s){new AreaMoveAttachTool(this,t,e).start(i,s)}splitTool(){new SplitTool(this).start()}areaDragTool(t=this.sareas.active){if(void 0===t)return void console.warn("no active screen area");let e=this.mpos;new AreaDragTool(this,this.sareas.active,e).start()}makeBorders(){for(let t of this.sareas)t.makeBorders(this)}cleanupBorders(){let t=new Set;for(let e of this.screenborders)0===e.halfedges.length&&t.add(e);for(let e of t)delete this._edgemap[e._hash],HTMLElement.prototype.remove.call(e)}mergeBlankAreas(){for(let t of this.screenborders){if(t.locked)continue;let e,i;for(let s of t.halfedges)if(!s.sarea.area){e=s.sarea,i=t.getOtherSarea(e);let r=1^t.horiz;if(e&&i&&e.size[r]!==i.size[r]&&(e=i=void 0),e&&i)break;e=void 0,i=void 0}e&&i&&e!==i&&this.collapseArea(e,t)}this.cleanupBorders()}floatArea(t){let e=t.parentWidget;if(e.floating)return e;e.editors.remove(t),delete e.editormap[t.constructor.define().areaname],e.area=void 0,HTMLElement.prototype.remove.call(t);let i=UIBase$1.createElement("screenarea-x",!0);if(i.floating=!0,i.pos=new Vector2(e.pos),i.pos.addScalar(5),i.size=new Vector2(e.size),i.editors.push(t),i.editormap[t.constructor.define().areaname]=t,i.shadow.appendChild(t),i.area=t,t.push_ctx_active(),t.pop_ctx_active(),t.pos=i.pos,t.size=i.size,t.parentWidget=i,t.owning_sarea=i,e.flushSetCSS(),e.flushUpdate(),i.flushSetCSS(),i.flushUpdate(),this.appendChild(i),e.editors.length>0){let t=e.editors[0];e.switch_editor(t.constructor),e.flushSetCSS(),e.flushUpdate()}return i.loadFromPosSize(),i.bringToFront(),this.mergeBlankAreas(),this.cleanupBorders(),i}on_keydown(t){if(checkForTextBox(this,this.mpos[0],this.mpos[1]))console.log("textbox detected");else if(haveModal()||!this.execKeyMap(t)){if(!haveModal()&&void 0!==this.sareas.active&&this.sareas.active.on_keydown){this.sareas.active;return this.sareas.active.on_keydown(t)}}else t.preventDefault()}on_keyup(t){if(!haveModal()&&void 0!==this.sareas.active&&this.sareas.active.on_keyup)return this.sareas.active.on_keyup(t)}on_keypress(t){if(!haveModal()&&void 0!==this.sareas.active&&this.sareas.active.on_keypress)return this.sareas.active.on_keypress(t)}draw(){for(let t of this.sareas)t.draw()}afterSTRUCT(){for(let t of this.sareas)t._ctx=this.ctx,t.afterSTRUCT()}loadSTRUCT(t){this.clear(),t(this),this.size=new Vector2(this.size);let e=this.sareas;this.sareas=[];for(let t of e)t.screen=this,t.parentWidget=this,this.appendChild(t);return this.regenBorders(),this.setCSS(),this.doOnce((()=>{this.loadUIData(this.uidata),this.uidata=void 0})),this}test_struct(t=_appstate){let e=[];nstructjs.manager.write_object(e,this),e=new DataView(new Uint8Array(e).buffer);let i=nstructjs.manager.read_object(e,this.constructor);i.ctx=this.ctx;for(let t of i.sareas)t.screen=i,t.ctx=this.ctx,t.area.ctx=this.ctx;let s=this.parentElement;return this.remove(),t.screen=i,s.appendChild(i),i.regenBorders(),i.update(),i.listen(),i.doOnce((()=>{i.on_resize(i.size,[window.innerWidth,window.innerHeight])})),console.log(e),i}saveUIData(){try{return saveUIData(this,"screen")}catch(t){print_stack$1(t),console.log("Failed to save UI state data")}}loadUIData(t){try{loadUIData(this,t)}catch(t){print_stack$1(t),console.log("Failed to load UI state data")}}}Screen.STRUCT="\npathux.Screen { \n  size  : vec2;\n  pos   : vec2;\n  sareas : array(pathux.ScreenArea);\n  idgen : int;\n  uidata : string | obj.saveUIData();\n}\n",nstructjs.register(Screen),UIBase$f.internalRegister(Screen),setScreenClass(Screen),_setScreenClass(Screen);let start_cbs=[],stop_cbs=[],keyboardDom=window,key_event_opts;function startEvents(t){if(get_screen_cb=t,!_events_started){_events_started=!0,_on_keydown=t=>(t.keyCode===keymap$4.Alt&&t.preventDefault(),get_screen_cb().on_keydown(t)),window.addEventListener("keydown",_on_keydown,key_event_opts);for(let t of start_cbs)t()}}function stopEvents(){window.removeEventListener("keydown",_on_keydown,key_event_opts),_on_keydown=void 0,_events_started=!1;for(let t of stop_cbs)try{t()}catch(t){print_stack$1(t)}return get_screen_cb}function setKeyboardDom(t){let e=_events_started;e&&stopEvents(),keyboardDom=t,e&&startEvents(get_screen_cb)}function setKeyboardOpts(t){key_event_opts=t}function _onEventsStart(t){start_cbs.push(t)}function _onEventsStop(t){stop_cbs.push(t)}let sidebar_hash=new HashDigest;class SideBar extends Container{constructor(){super(),this.header=this.row(),this.header.style.height="45px",this._last_resize_key=void 0,this._closed=!1,this.closeIcon=this.header.iconbutton(Icons$2.RIGHT_ARROW,"Close/Open sidebar",(()=>{console.log("click!"),this.closed=!this._closed})),this._openWidth=void 0,this.needsSetCSS=!0,this.tabbar=this.tabs("left")}saveData(){return{closed:this.closed}}loadData(t){this.closed=t.closed}set closed(t){if(!!this._closed==!!t)return;void 0===this._openWidth&&!this._closed&&t&&(this._openWidth=this.width),console.log("animate!");let e=t?50:this._openWidth;this.animate().goto("width",e,500),this.closeIcon.icon=t?Icons$2.LEFT_ARROW:Icons$2.RIGHT_ARROW,this._closed=t}get closed(){return this._closed}get width(){return parsepx$4(""+this.getAttribute("width"))}set width(t){this.setAttribute("width",t+"px"),this.update()}get height(){return parsepx$4(""+this.getAttribute("height"))}set height(t){this.setAttribute("height",t+"px"),this.update()}static define(){return{tagname:"sidebar-base-x",style:"sidebar"}}tab(t){return this.tabbar.tab(t)}init(){super.init();let t=this._closed;this._closed=!1,this.getAttribute("width")||(this.width=300),this.getAttribute("height")||(this.height=700),this.setCSS(),t&&(this.closed=!0)}setCSS(){if(!this.parentWidget)return;let t=this.parentWidget;if(!t.pos||!t.size)return;this.needsSetCSS=!1;let e=this.width,i=this.height;e=isNaN(e)?500:e,i=isNaN(i)?500:i,i=Math.min(i,t.size[1]-25),this.style.position="absolute",this.style.width=e+"px",this.style.height=i+"px",this.style["z-index"]="100",this.style.overflow="scroll",this.style["background-color"]=this.getDefault("AreaHeaderBG"),this.tabbar.style.height=i-45+"px",this.style.left=t.size[0]-e+"px"}update(){sidebar_hash.reset(),sidebar_hash.add(this.width),sidebar_hash.add(this.height);let t=sidebar_hash.get();t!==this._last_resize_key&&(this._last_resize_key=t,this.needsSetCSS=!0),this.needsSetCSS&&this.setCSS()}}UIBase$f.register(SideBar);class Editor extends Area$1{constructor(){super(),this.container=UIBase$f.createElement("container-x"),this.container.parentWidget=this,this.shadow.appendChild(this.container)}static define(){return{areaname:"areaname",tagname:"tagname-x"}}static defineAPI(t,e){return e}static registerAppMenu(t){if(this!==Editor)throw new Error("must call registerAppMenu from simple.Editor base class");this.makeMenuBar=t}static register(t){if(!t.hasOwnProperty("define"))throw new Error("missing define() method");t.hasOwnProperty("STRUCT")?t.STRUCT=nstructjs.inlineRegister(t,t.STRUCT):(t.STRUCT=nstructjs.inherit(t,this)+"\n}",nstructjs.register(t)),super.register(t)}makeSideBar(){this.sidebar&&this.sidebar.remove();let t=this.sidebar=UIBase$f.createElement("sidebar-base-x");return t.parentWidget=this,t.ctx=this.ctx,this.shadow.appendChild(t),this.ctx&&(t._init(),this.sidebar.flushSetCSS(),this.sidebar.flushUpdate()),this.sidebar}on_resize(t,e){super.on_resize(t,e),this.sidebar&&(this.ctx&&this.pos?this.sidebar.setCSS():this.sidebar.needsSetCSS=!0)}static findEditor(t){return contextWrangler.getLastArea(t)}getScreen(){return this.ctx.screen}init(){super.init(),this.makeHeader(this.container)}makeHeader(t,e=!0,i=!0){return super.makeHeader(t,e,i)}update(){super.update()}setCSS(){super.setCSS()}}let text='\n<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\n   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n   width="512"\n   height="512"\n   id="svg16099"\n   version="1.1"\n   inkscape:version="1.0 (4035a4fb49, 2020-05-01)"\n   sodipodi:docname="iconsheet.svg"\n   inkscape:export-filename="C:devallshapesrcdatafilesiconsheet16.png"\n   inkscape:export-xdpi="45"\n   inkscape:export-ydpi="45">\n  <defs\n     id="defs16101">\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1587"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1307"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1303"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1299"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1295"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1291"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1231"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1186"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1182"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4974"\n       is_visible="true" />\n    <linearGradient\n       id="linearGradient5481">\n      <stop\n         id="stop4865"\n         offset="0"\n         style="stop-color:#e66700;stop-opacity:1;" />\n      <stop\n         style="stop-color:#f47712;stop-opacity:1;"\n         offset="0.52777779"\n         id="stop4867" />\n      <stop\n         id="stop4869"\n         offset="1"\n         style="stop-color:#f8bb8a;stop-opacity:1;" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient17116-6">\n      <stop\n         id="stop4860"\n         offset="0"\n         style="stop-color:#b3a500;stop-opacity:1;" />\n      <stop\n         id="stop4862"\n         offset="1"\n         style="stop-color:#eaa500;stop-opacity:1;" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient17116">\n      <stop\n         id="stop4853"\n         offset="0"\n         style="stop-color:#b3a500;stop-opacity:1;" />\n      <stop\n         id="stop4855"\n         offset="1"\n         style="stop-color:#eaa500;stop-opacity:1;" />\n    </linearGradient>\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4290"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4286"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4122"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4118"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4194"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect3225"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect5012"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect5008"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4108"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect3264"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect5465"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4613"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4609"\n       is_visible="true" />\n    <linearGradient\n       id="linearGradient5609">\n      <stop\n         id="stop5611"\n         offset="0"\n         style="stop-color:#0089e6;stop-opacity:1;" />\n      <stop\n         style="stop-color:#1280f4;stop-opacity:1;"\n         offset="0.52777779"\n         id="stop5613" />\n      <stop\n         id="stop5615"\n         offset="1"\n         style="stop-color:#d4eefc;stop-opacity:1;" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient5481-8">\n      <stop\n         style="stop-color:#ffc700;stop-opacity:1"\n         offset="0"\n         id="stop5483" />\n      <stop\n         id="stop5491"\n         offset="0.52777779"\n         style="stop-color:#ffc700;stop-opacity:1" />\n      <stop\n         style="stop-color:#ffa41c;stop-opacity:1"\n         offset="1"\n         id="stop5485" />\n    </linearGradient>\n    <inkscape:perspective\n       sodipodi:type="inkscape:persp3d"\n       inkscape:vp_x="-108.10967 : 516.24314 : 1"\n       inkscape:vp_y="0 : 323.31882 : 0"\n       inkscape:vp_z="57.429562 : 516.24314 : 1"\n       inkscape:persp3d-origin="-25.340056 : 488.65327 : 1"\n       id="perspective18342" />\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0.0"\n       refX="0.0"\n       id="Arrow2Send"\n       style="overflow:visible;">\n      <path\n         id="path17173"\n         style="fill-rule:evenodd;stroke-width:0.62500000;stroke-linejoin:round;"\n         d="M 8.7185878,4.0337352 L -2.2072895,0.016013256 L 8.7185884,-4.0017078 C 6.9730900,-1.6296469 6.9831476,1.6157441 8.7185878,4.0337352 z "\n         transform="scale(0.3) rotate(180) translate(-2.3,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Mend"\n       orient="auto"\n       refY="0.0"\n       refX="0.0"\n       id="Arrow2Mend"\n       style="overflow:visible;">\n      <path\n         id="path17167"\n         style="fill-rule:evenodd;stroke-width:0.62500000;stroke-linejoin:round;"\n         d="M 8.7185878,4.0337352 L -2.2072895,0.016013256 L 8.7185884,-4.0017078 C 6.9730900,-1.6296469 6.9831476,1.6157441 8.7185878,4.0337352 z "\n         transform="scale(0.6) rotate(180) translate(0,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow1Send"\n       orient="auto"\n       refY="0.0"\n       refX="0.0"\n       id="Arrow1Send"\n       style="overflow:visible;">\n      <path\n         id="path17155"\n         d="M 0.0,0.0 L 5.0,-5.0 L -12.5,0.0 L 5.0,5.0 L 0.0,0.0 z "\n         style="fill-rule:evenodd;stroke:#000000;stroke-width:1.0pt;"\n         transform="scale(0.2) rotate(180) translate(6,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Lend"\n       orient="auto"\n       refY="0.0"\n       refX="0.0"\n       id="Arrow2Lend"\n       style="overflow:visible;">\n      <path\n         id="path17161"\n         style="fill-rule:evenodd;stroke-width:0.62500000;stroke-linejoin:round;"\n         d="M 8.7185878,4.0337352 L -2.2072895,0.016013256 L 8.7185884,-4.0017078 C 6.9730900,-1.6296469 6.9831476,1.6157441 8.7185878,4.0337352 z "\n         transform="scale(1.1) rotate(180) translate(1,0)" />\n    </marker>\n    <linearGradient\n       id="linearGradient17126">\n      <stop\n         style="stop-color:#008080;stop-opacity:1;"\n         offset="0"\n         id="stop17128" />\n      <stop\n         style="stop-color:#00b3b3;stop-opacity:1;"\n         offset="1"\n         id="stop17130" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient17116-6-9">\n      <stop\n         style="stop-color:#b3a500;stop-opacity:1;"\n         offset="0"\n         id="stop17118" />\n      <stop\n         style="stop-color:#eaa500;stop-opacity:1;"\n         offset="1"\n         id="stop17120" />\n    </linearGradient>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-2"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-2"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-6"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-8"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-7"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-6"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-8"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-9"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-79"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-5"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-3"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-1"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-33"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-4"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <marker\n       inkscape:stockid="Arrow2Send"\n       orient="auto"\n       refY="0"\n       refX="0"\n       id="Arrow2Send-1"\n       style="overflow:visible">\n      <path\n         inkscape:connector-curvature="0"\n         id="path17173-3"\n         style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round"\n         d="M 8.7185878,4.0337352 -2.2072895,0.01601326 8.7185884,-4.0017078 c -1.7454984,2.3720609 -1.7354408,5.6174519 -6e-7,8.035443 z"\n         transform="matrix(-0.3,0,0,-0.3,0.69,0)" />\n    </marker>\n    <linearGradient\n       inkscape:collect="always"\n       xlink:href="#linearGradient5481-5"\n       id="linearGradient5489-4"\n       x1="355.89935"\n       y1="17.125025"\n       x2="380.47559"\n       y2="17.125025"\n       gradientUnits="userSpaceOnUse" />\n    <linearGradient\n       id="linearGradient5481-5">\n      <stop\n         style="stop-color:#e66700;stop-opacity:1;"\n         offset="0"\n         id="stop5483-2" />\n      <stop\n         id="stop5491-9"\n         offset="0.52777779"\n         style="stop-color:#f47712;stop-opacity:1;" />\n      <stop\n         style="stop-color:#f8bb8a;stop-opacity:1;"\n         offset="1"\n         id="stop5485-9" />\n    </linearGradient>\n    <linearGradient\n       y2="17.125025"\n       x2="380.47559"\n       y1="17.125025"\n       x1="355.89935"\n       gradientUnits="userSpaceOnUse"\n       id="linearGradient5588"\n       xlink:href="#linearGradient5609"\n       inkscape:collect="always"\n       gradientTransform="matrix(1.2151103,0,0,1.1804992,-207.06775,536.98221)" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4108-1"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4108-4"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4108-9"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect3225-1"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect3225-4"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4122-2"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4122-7"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect1587-6"\n       is_visible="true" />\n    <inkscape:path-effect\n       effect="spiro"\n       id="path-effect4194-5"\n       is_visible="true" />\n  </defs>\n  <sodipodi:namedview\n     id="base"\n     pagecolor="#9c9c9c"\n     bordercolor="#666666"\n     borderopacity="1.0"\n     inkscape:pageopacity="0"\n     inkscape:pageshadow="2"\n     inkscape:zoom="3.8325453"\n     inkscape:cx="144.17961"\n     inkscape:cy="49.96269"\n     inkscape:document-units="px"\n     inkscape:current-layer="layer1"\n     showgrid="true"\n     inkscape:window-width="1606"\n     inkscape:window-height="962"\n     inkscape:window-x="177"\n     inkscape:window-y="71"\n     inkscape:window-maximized="0"\n     inkscape:snap-global="false"\n     inkscape:pagecheckerboard="true"\n     inkscape:document-rotation="0">\n    <inkscape:grid\n       type="xygrid"\n       id="grid16107"\n       empspacing="1"\n       visible="true"\n       enabled="true"\n       snapvisiblegridlinesonly="false"\n       spacingx="32"\n       spacingy="32"\n       dotted="false"\n       originx="0"\n       originy="0" />\n  </sodipodi:namedview>\n  <metadata\n     id="metadata16104">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <g\n     inkscape:label="Layer 1"\n     inkscape:groupmode="layer"\n     id="layer1"\n     transform="translate(0,-540.36218)">\n    <ellipse\n       style="opacity:0.79203539;fill:url(#linearGradient5588);fill-opacity:1;stroke:#3c3c3c;stroke-width:1.1393038;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1"\n       id="path3171-8"\n       cx="240.32063"\n       cy="557.19836"\n       rx="14.353489"\n       ry="14.165989" />\n    <flowRoot\n       xml:space="preserve"\n       id="flowRoot5564"\n       style="font-style:normal;font-weight:normal;line-height:0.01%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;fill:#000000;fill-opacity:1;stroke:none"\n       transform="matrix(0.64571833,0,0,0.61432912,8.6966653,558.72048)"><flowRegion\n         id="flowRegion5566"\n         style="font-family:sans-serif"><rect\n           id="rect5568"\n           width="78.749992"\n           height="72.5"\n           x="346.24997"\n           y="-21.999973"\n           style="font-family:sans-serif" /></flowRegion><flowPara\n         id="flowPara5570"\n         style="font-weight:bold;font-size:40px;line-height:1.25;font-family:sans-serif;-inkscape-font-specification:\'Sans Bold\'">?</flowPara></flowRoot>\n    <path\n       style="fill:none;stroke:#ec6900;stroke-width:4.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;marker-mid:none;marker-end:none"\n       d="m 187.1235,559.26606 c -3.71166,-5.87882 -12.04056,-10.0009 -18.86169,0.34701"\n       id="path4144-1"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc" />\n    <path\n       style="fill:#ec6900;fill-opacity:1;stroke:none;stroke-width:0.001;stroke-miterlimit:4;stroke-dasharray:none"\n       d="m 170.01417,560.40163 2.05175,2.63036 -9.89352,4.33226 2.83717,-13.08504 z"\n       id="path5370-7"\n       inkscape:connector-curvature="0" />\n    <path\n       style="fill:none;stroke:#1f9000;stroke-width:4.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;marker-mid:none;marker-end:none"\n       d="m 197.1805,559.70121 c 3.69186,-5.88365 11.97631,-10.00911 18.76103,0.3473"\n       id="path4144-1-9"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc" />\n    <path\n       style="fill:#1f9000;fill-opacity:1;stroke:none"\n       d="m 213.95021,560.59037 -2.0408,2.63252 9.84072,4.33582 -2.82203,-13.09579 z"\n       id="path5370-7-4"\n       inkscape:connector-curvature="0" />\n    <rect\n       style="fill:#000000;fill-opacity:1;stroke:none"\n       id="rect3224"\n       width="23.641272"\n       height="8.4057856"\n       x="487.73776"\n       y="552.41565" />\n    <path\n       style="fill:none;stroke:#000000;stroke-width:5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="M 498.18023,567.81152 484.7754,556.20378 498.93081,545.77569"\n       id="path4074"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="ccc" />\n    <path\n       style="fill:#000000;fill-opacity:1;stroke:none"\n       d="m 17.866009,585.82436 -0.09,-4.53232 -14.5167501,7.49748 14.5683701,7.84238 z"\n       id="path5370-5-0-6-5"\n       inkscape:connector-curvature="0" />\n    <path\n       style="fill:#000000;fill-opacity:1;stroke:none"\n       d="m 46.366429,592.31275 0.0109,4.6129 14.90287,-7.37024 -14.68289,-8.23782 z"\n       id="path5370-5-1-2"\n       inkscape:connector-curvature="0" />\n    <rect\n       style="opacity:0.94690265;fill:#000000;fill-opacity:1;stroke:none"\n       id="rect5558-3-3"\n       width="10.726034"\n       height="5.6689787"\n       x="-3.0812507"\n       y="587.85645"\n       transform="matrix(1,0,0.06880209,0.99763033,0,0)" />\n    <rect\n       style="opacity:0.94690265;fill:#000000;fill-opacity:1;stroke:none"\n       id="rect5558-1"\n       width="10.540748"\n       height="5.5710502"\n       x="-22.93788"\n       y="587.9295"\n       transform="matrix(1,0,0.06880209,0.99763033,0,0)" />\n    <path\n       style="fill:#2e2e2e;fill-opacity:1;stroke:none;stroke-width:0.685581"\n       d="m 71.46269,592.27473 0.01481,6.27371 20.268436,-10.02379 -19.969263,-11.20374 z"\n       id="path5370-5-1-2-1"\n       inkscape:connector-curvature="0" />\n    <path\n       style="fill:#2e2e2e;fill-opacity:1;stroke:none;stroke-width:0.685581"\n       d="m 108.87703,578.56977 -6.27262,0.11779 10.35514,20.10117 10.87444,-20.15049 z"\n       id="path5370-5-1-2-1-7"\n       inkscape:connector-curvature="0" />\n    <path\n       style="fill:#000000;fill-opacity:1;stroke:#363636;stroke-width:2.23946524;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 69.769603,567.95981 5.60449,-5.39601"\n       id="path5452-5-5-1-7"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc"\n       inkscape:transform-center-x="3.061478"\n       inkscape:transform-center-y="-0.63275351" />\n    <path\n       style="fill:#000000;fill-opacity:1;stroke:#363636;stroke-width:2.23946524;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 75.172083,567.8747 -5.47097,-5.53134"\n       id="path5452-5-5-1-7-4"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc"\n       inkscape:transform-center-x="3.196728"\n       inkscape:transform-center-y="-0.78552851" />\n    <path\n       style="fill:#ffe87e;fill-opacity:1;stroke:#a58000;stroke-width:1.02573335px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 36.512525,599.08328 -0.0847,-15.30469 14.76623,-0.079 1.13455,-5.3121 h 6.7663 l 0.52197,5.56549 h 2.38874 l -0.0349,15.41642 z"\n       id="path4607"\n       inkscape:path-effect="#path-effect4609"\n       inkscape:original-d="m 36.512525,599.08328 -0.0847,-15.30469 14.76623,-0.079 1.13455,-5.3121 h 6.7663 l 0.52197,5.56549 h 2.38874 l -0.0349,15.41642 z"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="ccccccccc"\n       transform="translate(-33.065965,-31.819347)" />\n    <path\n       style="fill:#dfc449;fill-opacity:1;stroke:#a58000;stroke-width:1.04236829px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 38.651325,583.64804 2.27904,-5.34039 8.11475,0.19058 1.53729,4.93611 z"\n       id="path5463"\n       inkscape:path-effect="#path-effect5465"\n       inkscape:original-d="m 38.651325,583.64804 2.27904,-5.34039 8.11475,0.19058 1.53729,4.93611 z"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="ccccc"\n       transform="translate(-33.065965,-31.819347)" />\n    <path\n       style="fill:#d7f0fb;fill-opacity:1;stroke:#4f4f4f;stroke-width:1.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;stroke-miterlimit:4;stroke-dasharray:none"\n       d="m 71.789265,599.90744 0.17512,-24.69199 h 15.41061 l 4.378,4.90337 0.17513,19.96374 z"\n       id="path3262"\n       inkscape:path-effect="#path-effect3264"\n       inkscape:original-d="m 71.789265,599.90744 0.17512,-24.69199 h 15.41061 l 4.378,4.90337 0.17513,19.96374 z"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cccccc"\n       transform="translate(-33.561281,-31.819347)" />\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 73.190225,596.58015 16.81157,-0.35024"\n       id="path4106"\n       inkscape:path-effect="#path-effect4108"\n       inkscape:original-d="m 73.190225,596.58015 16.81157,-0.35024"\n       inkscape:connector-curvature="0"\n       transform="translate(-33.561281,-31.819347)" />\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 73.540465,591.50166 16.81157,-0.35024"\n       id="path4106-7"\n       inkscape:path-effect="#path-effect4108-1"\n       inkscape:original-d="m 73.540465,591.50166 16.81157,-0.35024"\n       inkscape:connector-curvature="0"\n       transform="translate(-33.561281,-31.819347)" />\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 73.365345,586.59829 16.81157,-0.35024"\n       id="path4106-0"\n       inkscape:path-effect="#path-effect4108-4"\n       inkscape:original-d="m 73.365345,586.59829 16.81157,-0.35024"\n       inkscape:connector-curvature="0"\n       transform="translate(-33.561281,-31.819347)" />\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 73.365345,582.22027 16.81157,-0.35024"\n       id="path4106-4"\n       inkscape:path-effect="#path-effect4108-9"\n       inkscape:original-d="m 73.365345,582.22027 16.81157,-0.35024"\n       inkscape:connector-curvature="0"\n       transform="translate(-33.561281,-31.819347)" />\n    <path\n       style="fill:#ffffff;fill-opacity:1;stroke:#f1f1f1;stroke-width:4.65793133;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 103.19489,558.19446 16.18158,0.0627"\n       id="path5452-5-5-1-7-7"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc"\n       inkscape:transform-center-x="3.6534509"\n       inkscape:transform-center-y="-5.3788766" />\n    <path\n       style="fill:#ffffff;fill-opacity:1;stroke:#f4f4f4;stroke-width:4.65793133;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 111.38254,565.89244 -0.15492,-16.18101"\n       id="path5452-5-5-1-7-4-4"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc"\n       inkscape:transform-center-x="3.6340509"\n       inkscape:transform-center-y="-5.8027516" />\n    <path\n       style="fill:#ffffff;fill-opacity:1;stroke:#f1f1f1;stroke-width:4.54087734;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 135.53124,558.66024 15.77493,0.0612"\n       id="path5452-5-5-1-7-7-1"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cc"\n       inkscape:transform-center-x="3.561639"\n       inkscape:transform-center-y="-5.2436726" />\n    <path\n       style="fill:#bfbfbf;fill-opacity:1;stroke:#ffffff;stroke-width:1.39999998;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 273.79736,565.92624 4.84986,4.15066 7.44379,-12.0346 -3.26109,-1.20718 -4.82074,8.91974 -2.46038,-2.39761 z"\n       id="path1157"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="ccccccc" />\n    <path\n       style="fill:#ff9d00;fill-opacity:1;stroke:#808080;stroke-width:0.78749156px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 306.19903,566.65065 4.84985,4.15066 7.4438,-12.0346 -3.26109,-1.20718 -4.82075,8.91974 -2.46037,-2.39761 z"\n       id="path1157-6"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="ccccccc" />\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:4.85740042;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 419.41366,537.85807 12.87326,7.64338 12.79438,-7.33068"\n       id="path1585"\n       inkscape:connector-curvature="0"\n       inkscape:path-effect="#path-effect1587"\n       inkscape:original-d="m 419.41366,537.85807 12.87326,7.64338 c 4.40656,-2.37267 3.01422,-8.5404 12.79438,-7.33068"\n       sodipodi:nodetypes="ccc"\n       transform="matrix(0.82348572,0,0,0.82348572,75.604975,111.95505)" />\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:4.85740042;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 419.41366,537.85807 12.87326,7.64338 12.79438,-7.33068"\n       id="path1585-6"\n       inkscape:connector-curvature="0"\n       inkscape:path-effect="#path-effect1587-6"\n       inkscape:original-d="m 419.41366,537.85807 12.87326,7.64338 c 4.40656,-2.37267 3.01422,-8.5404 12.79438,-7.33068"\n       sodipodi:nodetypes="ccc"\n       transform="matrix(-0.82326686,0.01898429,-0.01898429,-0.82326686,829.82733,995.45395)" />\n    <path\n       style="fill:#ffffff;fill-opacity:1;stroke:#ffffff;stroke-width:1.4972775px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n       d="m 325.7796,560.88703 9.22114,7.89176 14.15308,-22.88169 -6.20039,-2.29524 -9.16581,16.95932 -4.67796,-4.55863 z"\n       id="path1157-6-7"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="ccccccc" />\n    <path\n       style="fill:#ffffff;fill-opacity:1;stroke:none"\n       d="m 338.27455,603.35315 -4.55847,-12.13972 -4.42325,4.14941 0.29119,-21.42993 14.0532,13.84869 -5.29334,1.40046 4.98485,11.66133 z"\n       id="path4192-0"\n       inkscape:path-effect="#path-effect4194-5"\n       inkscape:original-d="m 338.27455,603.35315 -4.55847,-12.13972 -4.42325,4.14941 0.29119,-21.42993 14.0532,13.84869 -5.29334,1.40046 c 11.73953,18.68506 2.52594,6.89719 4.98485,11.66133 z"\n       inkscape:connector-curvature="0"\n       sodipodi:nodetypes="cccccccc"\n       transform="rotate(-9.319008,159.52768,371.93318)" />\n    <text\n       xml:space="preserve"\n       style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:17.712px;line-height:0%;font-family:\'MV Boli\';-inkscape-font-specification:\'MV Boli\';letter-spacing:0px;word-spacing:0px;fill:#ffdc00;fill-opacity:1;stroke:none;stroke-width:1.476"\n       x="179.14906"\n       y="751.84772"\n       id="text3255-0"\n       transform="matrix(1.2141217,-0.1513943,0.23126622,0.79480305,0,0)"><tspan\n         sodipodi:role="line"\n         id="tspan3257-0"\n         x="179.14906"\n         y="751.84772"\n         style="font-size:44.4154px;line-height:1.25;stroke-width:1.476">!</tspan></text>\n    <text\n       xml:space="preserve"\n       style="font-style:normal;font-weight:normal;font-size:32.4516px;line-height:1.25;font-family:sans-serif;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.81129"\n       x="131.62856"\n       y="599.63672"\n       id="text1309"><tspan\n         sodipodi:role="line"\n         id="tspan1307"\n         x="131.62856"\n         y="599.63672"\n         style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-family:sans-serif;-inkscape-font-specification:\'sans-serif Bold\';stroke-width:0.81129">B</tspan></text>\n    <text\n       id="text1309-2"\n       y="658.43152"\n       x="153.61592"\n       style="font-style:normal;font-weight:normal;font-size:41.6588px;line-height:1.25;font-family:sans-serif;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:1.04147"\n       xml:space="preserve"\n       transform="scale(1.0962314,0.91221617)"><tspan\n         style="font-style:italic;font-variant:normal;font-weight:bold;font-stretch:normal;font-family:serif;-inkscape-font-specification:\'serif Bold Italic\';stroke-width:1.04147"\n         y="658.43152"\n         x="153.61592"\n         id="tspan1307-4"\n         sodipodi:role="line">i</tspan></text>\n    <text\n       xml:space="preserve"\n       style="font-style:normal;font-weight:normal;font-size:38.431px;line-height:1.25;font-family:sans-serif;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.960773"\n       x="264.23669"\n       y="522.23657"\n       id="text1309-0-9"\n       transform="scale(0.87011438,1.1492742)"><tspan\n         sodipodi:role="line"\n         id="tspan1307-3-4"\n         x="264.23669"\n         y="522.23657"\n         style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-family:sans-serif;-inkscape-font-specification:\'sans-serif Bold\';stroke-width:0.960773"><tspan\n           style="font-weight:normal;stroke-width:0.960773"\n           id="tspan1365">s</tspan></tspan></text>\n    <text\n       xml:space="preserve"\n       style="font-style:normal;font-weight:normal;font-size:31.7797px;line-height:1.25;font-family:sans-serif;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.794494"\n       x="195.07664"\n       y="596.5979"\n       id="text1309-0-2"\n       transform="scale(0.99519471,1.0048285)"><tspan\n         sodipodi:role="line"\n         id="tspan1307-3-1"\n         x="195.07664"\n         y="596.5979"\n         style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-family:sans-serif;-inkscape-font-specification:\'sans-serif Bold\';stroke-width:0.794494">U</tspan></text>\n    <path\n       style="fill:none;stroke:#ffffff;stroke-width:3.47724;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 194.05959,600.03363 25.702,0.14808"\n       id="path1375" />\n    <path\n       id="path1375-2"\n       d="m 227.04774,587.38832 25.63991,0.14772"\n       style="fill:none;stroke:#ffffff;stroke-width:3.46884;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       inkscape:transform-center-x="1.1856386"\n       inkscape:transform-center-y="-0.33875464" />\n    <path\n       style="fill:#ffffff;fill-opacity:1;stroke:#484848;stroke-width:1.623;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 262.93706,592.38036 0.0134,5.70131 18.41916,-9.10923 -18.14729,-10.18151 z"\n       id="path5370-5-1-2-1-4"\n       inkscape:connector-curvature="0" />\n    <path\n       inkscape:connector-curvature="0"\n       id="path5370-5-1-2-1-4-0"\n       d="m 301.44451,581.20782 -5.70129,0.0197 9.12976,18.40899 10.16128,-18.15862 z"\n       style="fill:#ffffff;fill-opacity:1;stroke:#484848;stroke-width:1.623;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />\n    <ellipse\n       style="fill:none;stroke:#242424;stroke-width:2.80047;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:20;stroke-opacity:1"\n       id="path1040"\n       ry="8.7032747"\n       rx="8.4312963"\n       cy="583.49023"\n       cx="331.71524" />\n    <path\n       style="fill:none;stroke:#242424;stroke-width:6;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 336.4644,589.47097 10.10632,10.66173"\n       id="path1042"\n       sodipodi:nodetypes="cc" />\n    <path\n       style="fill:none;stroke:#242424;stroke-width:2.17621;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 325.36075,583.26941 12.63506,0.34484"\n       id="path1044" />\n    <ellipse\n       cx="364.00839"\n       cy="584.36328"\n       rx="9.6165609"\n       ry="9.9267731"\n       id="path1040-0"\n       style="fill:none;stroke:#242424;stroke-width:3.19416;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:20;stroke-opacity:1" />\n    <path\n       sodipodi:nodetypes="cc"\n       id="path1042-6"\n       d="m 369.73697,590.7899 10.89694,10.89694"\n       style="fill:none;stroke:#242424;stroke-width:6;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />\n    <path\n       id="path1044-4"\n       d="m 357.64269,584.09303 12.63506,0.34484"\n       style="fill:none;stroke:#242424;stroke-width:2.17621;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />\n    <path\n       style="fill:none;stroke:#242424;stroke-width:2.17621;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n       d="m 363.94156,590.78154 0.20796,-12.63806"\n       id="path1044-4-9" />\n  </g>\n</svg>\n'.trim();text=btoa(text);let iconSvg="data:image/svg+xml;base64,"+text;const Icons={FOLDER:0,FILE:1,TINY_X:2,SMALL_PLUS:3,SMALL_MINUS:4,UNDO:5,REDO:6,HELP:7,ENUM_UNCHECKED:8,ENUM_CHECKED:9,LARGE_CHECK:10,CURSOR_ARROW:11,NOTE_EXCL:12,SCROLL_DOWN:13,SCROLL_UP:14,BACKSPACE:15,LEFT_ARROW:16,RIGHT_ARROW:17,UI_EXPAND:18,UI_COLLAPSE:19,BOLD:20,ITALIC:21,UNDERLINE:22,STRIKETHRU:23,TREE_EXPAND:24,TREE_COLLAPSE:25,ZOOM_OUT:26,ZOOM_IN:27};function loadDefaultIconSheet(){let t=document.createElement("img");return t.src=iconSvg,t}class FileHeader{constructor(t,e,i){this.magic=e,this.flags=i,this.version_major=t?t[0]:0,this.version_minor=t?t[1]:0,this.version_micro=t?t[2]:0,this.schema=nstructjs.write_scripts()}}FileHeader.STRUCT="\nsimple.FileHeader {\n  magic         : static_string[4];\n  version_major : short;\n  version_minor : short;\n  version_micro : short;\n  flags         : short;\n  schema        : string; \n}\n",nstructjs.register(FileHeader);class FileFull extends FileHeader{constructor(t,e,i){super(t,e,i),this.objects=[]}}FileFull.STRUCT=nstructjs.inherit(FileFull,FileHeader)+"\n  objects : array(abstract(Object));\n  screen  : abstract(Object);\n}\n",nstructjs.register(FileFull);class FileArgs{constructor(t={}){this.ext=t.ext||".data",this.magic=t.magic||"STRT",this.doScreen=void 0===t.doScreen||t.doScreen,this.resetOnLoad=void 0===t.resetOnLoad||t.resetOnLoad,this.useJSON=void 0!==t.useJSON&&t.useJSON,this.version=void 0!==t.version?t.version:0,this.fileFlags=void 0!==t.fileFlags?t.fileFlags:0,this.fromFileOp=!1}}class EmptyStruct{}function saveFile(t,e,i){void 0===e.useJSON&&(e.useJSON=t.saveFilesInJSON);let s=(e=new FileArgs(e)).version;if("number"==typeof s)if(s===Math.floor(s))s=[s,0,0];else{let t=~~s,e=~~(10*Math.fract(s));s=[t,e,100*(Math.fract(s)-e)]}let r=new FileFull(s,e.magic,e.fileFlags);e.doScreen?r.screen=t.screen:r.screen=new EmptyStruct;for(let t of i)r.objects.push(t);if(e.useJSON)return nstructjs.writeJSON(r);{let t=[];return nstructjs.writeObject(t,r),new Uint8Array(t).buffer}}function loadFile(t,e,i){let s;if(void 0===e.useJSON&&(e.useJSON=t.saveFilesInJSON),(e=new FileArgs(e)).useJSON?("string"==typeof i&&(i=JSON.parse(i)),s=nstructjs.readJSON(i,FileHeader)):(i instanceof Array&&(i=new Uint8Array(i).buffer),i instanceof Uint8Array&&(i=i.buffer),i instanceof ArrayBuffer&&(i=new DataView(i)),s=nstructjs.readObject(i,FileHeader)),s.magic!==e.magic)throw new Error("invalid file");let r,a=new nstructjs.STRUCT;if(a.parse_structs(s.schema),r=e.useJSON?a.readJSON(i,FileFull):a.readObject(i,FileFull),e.resetOnLoad&&t.reset(),e.doScreen){if(t.screen&&(t.screen.unlisten(),t.screen.remove()),r.screen.ctx=t.ctx,!(r.screen instanceof t.screenClass)){let e=UIBase$f.createElement(t.screenClass.define().tagname);e.ctx=t.ctx;for(let t of r.screen.sareas)e.appendChild(t),t.area.afterSTRUCT(),t.area.on_fileload();r.screen=e}t.screen=r.screen,document.body.appendChild(t.screen),t.screen.listen()}return r}EmptyStruct.STRUCT="\nEmptyStruct {\n}\n",nstructjs.register(EmptyStruct);class MenuBarEditor extends Editor{constructor(){super(),this.updateHeight(),this.borderLock=15,this.areaDragToolEnabled=!1,this._height=25,this.needsRebuild=!1}get height(){return this._height}set height(t){this._height=t,this.updateHeight()}static define(){return{tagname:"simple-menu-editor-x",areaname:"menu",uiname:"Menu Bar",icon:-1,flag:AreaFlags.HIDDEN|AreaFlags.NO_HEADER_CONTEXT_MENU|AreaFlags.NO_COLLAPSE|AreaFlags.NO_SWITCHER}}updateHeight(t=!1){if(!this.header)return;if(window.haveElectron)return this.maxSize[1]=this.minSize[1]=1,void electron_api.initMenuBar(this);if(void 0===this._height){let t=this.header.getClientRects()[0];t&&(this._height=t.height)}let e=t||this._height!==this.minSize[1];this.minSize[1]=this.maxSize[1]=this._height,e&&this.ctx&&this.getScreen()&&this.getScreen().solveAreaConstraints()}makeMenuBar(t){Editor.makeMenuBar&&Editor.makeMenuBar(this.ctx,t,this)}flagRebuild(){this.needsRebuild=!0}init(){super.init(),this.background=this.getDefault("AreaHeaderBG"),this.menuRow=this.header.row(),this.makeMenuBar(this.menuRow),this.doOnce((()=>{window.haveElectron&&(this.height=1,electron_api.initMenuBar(this))})),this.updateHeight(!0),this.flushUpdate()}rebuild(){this.needsRebuild=!1,this.menuRow.clear(),this.makeMenuBar(this.menuRow),this.flushUpdate()}update(){this.needsRebuild&&this.rebuild()}}function registerMenuBarEditor(){Editor.register(MenuBarEditor)}MenuBarEditor.STRUCT=nstructjs.inherit(MenuBarEditor,Editor,"MenuBarEditor")+"\n}\n";class SimpleAppNewOp extends ToolOp{static tooldef(){return{uiname:"New",toolpath:"app.new",inputs:{},undoflag:UndoFlags$1.NO_UNDO}}exec(t){_appstate.createNewFile()}}class SimpleAppSaveOp extends ToolOp{static tooldef(){return{uiname:"Save",toolpath:"app.save",inputs:{forceDialog:new BoolProperty},undoflag:UndoFlags$1.NO_UNDO}}exec(t){let e=_appstate.fileExt,i=_appstate.startArgs.saveFilesInJSON;_appstate.saveFile({doScreen:!0,useJSON:i,fromFileOp:!0}).then((t=>{platform$2.showSaveDialog("Save As",(function(){return t}),{multi:!1,addToRecentList:!0,filters:[{name:"File",mime:i?"text/json":"application/x-octet-stream",extensions:["."+e.toLowerCase()]}]}).then((t=>{_appstate.currentFileRef=t,message("File saved")})).catch((t=>{"object"==typeof t&&t.message&&(t=t.message),error("Failed to save file "+t)}))}))}}class SimpleAppOpenOp extends ToolOp{static tooldef(){return{uiname:"Open",toolpath:"app.open",inputs:{forceDialog:new BoolProperty},undoflag:UndoFlags$1.NO_UNDO}}exec(t){let e=_appstate.fileExt,i=_appstate.startArgs.saveFilesInJSON,s=i?"text/json":"application/x-octet-stream";platform$2.showOpenDialog("Open File",{multi:!1,addToRecentList:!0,filters:[{name:"File",mime:s,extensions:["."+e.toLowerCase()]}]}).then((t=>{for(let e of t)platform$2.readFile(e,s).then((t=>{console.log("got data!",t),_appstate.loadFile(t,{useJSON:i,doScreen:!0,fromFileOp:!0}).catch((t=>{error("File error: "+t.message)}))}))})).catch((e=>{t.error(e.message)}))}}function register(){ToolOp.register(SimpleAppSaveOp),ToolOp.register(SimpleAppOpenOp),ToolOp.register(SimpleAppNewOp)}const DataModelClasses=[];class DataModel{static defineAPI(t,e){return e}static register(t){t.hasOwnProperty("defineAPI"),DataModelClasses.push(t),t.hasOwnProperty("STRUCT")&&!nstructjs.isRegistered(t)&&(t.STRUCT=nstructjs.inlineRegister(t,t.STRUCT))}}class EmptyContextClass extends Context{static defineAPI(t,e){}}function GetContextClass(t){let e,i=0,s=t;for(;s;)s===Context?i=1:s===ContextOverlay&&(i=2),s=s.__proto__;if(1===i)return t;e=2===i?t:makeDerivedOverlay(t);class r extends e{constructor(t){super(t)}get screen(){return this.state.screen}get api(){return this.state.api}get toolstack(){return this.state.toolstack}get toolDefaults(){return SavedToolDefaults}get last_tool(){return this.toolstack.head}message(t,e=2500){return message(this.screen,t,e)}error(t,e=2500){return error(this.screen,t,e)}warning(t,e=2500){return warning(this.screen,t,e)}progressBar(t,e,i,s=1e3){return progbarNote(this.screen,t,e,i,s)}}return Context.register(r),class extends Context{constructor(t){super(t),this.pushOverlay(new r(t))}static defineAPI(t,e){return r.defineAPI(t,e)}}}function makeAPI(t){let e=new DataAPI;for(let t of DataModelClasses)t.defineAPI&&t.defineAPI(e,e.mapStruct(t,!0));for(let t in areaclasses)areaclasses[t].defineAPI(e,e.mapStruct(areaclasses[t],!0));if(!t.defineAPI)throw new Error("Context class should have a defineAPI static method");return t.defineAPI(e,e.mapStruct(t,!0)),e.rootContextStruct=e.mapStruct(t,e.mapStruct(t,!0)),buildToolSysAPI(e,!1,e.rootContextStruct,t,!0),e}class StartArgs{constructor(){this.singlePage=!0,this.DEBUG={},this.icons=Icons,this.iconsheet=void 0,this.iconSizes=[16,24,32,48],this.iconTileSize=32,this.iconsPerRow=16,this.theme=void 0,this.registerSaveOpenOps=!0,this.autoLoadSplineTemplates=!0,this.showPathsInToolTips=!0,this.enableThemeAutoUpdate=!1,this.addHelpPickers=!1,this.useNumSliderTextboxes=!0,this.numSliderArrowLimit=exports.numSliderArrowLimit,this.simpleNumSliders=exports.simpleNumSliders}}class SimpleScreen extends Screen{constructor(){super(),this.keymap=new KeyMap([new HotKey("Z",["CTRL"],(()=>{this.ctx.toolstack.undo(this.ctx)})),new HotKey("Z",["CTRL","SHIFT"],(()=>{this.ctx.toolstack.redo(this.ctx)}))])}static define(){return{tagname:"simple-screen-x"}}init(){this.ctx.state.startArgs.registerSaveOpenOps&&(this.keymap.add(new HotKey("S",["CTRL"],"app.save()")),this.keymap.add(new HotKey("O",["CTRL"],"app.open()")))}setCSS(){super.setCSS(),this.style.position=UIBase$f.PositionKey,this.style.left=this.pos[0]+"px",this.style.top=this.pos[1]+"px"}}UIBase$f.register(SimpleScreen);class AppState{constructor(t,e=SimpleScreen){this._ctxClass=t,t=GetContextClass(t),this.startArgs=void 0,this.currentFileRef=void 0,this.api=makeAPI(t),this.ctx=new t(this),this.ctx._state=this,this.toolstack=new ToolStack,this.screenClass=e,this.screen=void 0,this.fileMagic="STRT",this.fileVersion=[0,0,1],this._fileExt="data",this._fileExtSet=!1,this.saveFilesInJSON=!1,this.defaultEditorClass=void 0}get fileExt(){return this._fileExt}set fileExt(t){this._fileExt=t,this._fileExtSet=!0}reset(){this.toolstack.reset()}createNewFile(){console.warn("appstate.createNewFile: implement me, using default hack");let t=new this.constructor(this.ctx._ctxClass);t.api=this.api,t.ctx=this.ctx,t.startArgs=this.startArgs,t.saveFilesInJSON=this.saveFilesInJSON,t.toolstack=this.toolstack,t.toolstack.reset(),this.screen.unlisten(),this.screen.remove();for(let e in t)this[e]=t[e];this.makeScreen()}saveFileSync(t,e={}){return saveFile(this,e=new FileArgs(Object.assign({magic:this.fileMagic,version:this.fileVersion,ext:this.fileExt},e)),t)}saveFile(t,e={}){return e=new FileArgs(Object.assign({magic:this.fileMagic,version:this.fileVersion,ext:this.fileExt},e)),new Promise(((i,s)=>{i(this.saveFileSync(t,e))}))}loadFileSync(t,e={}){let i=loadFile(this,e=new FileArgs(Object.assign({magic:this.fileMagic,version:this.fileVersion,ext:this.fileExt},e)),t);if(e.doScreen){try{this.ensureMenuBar()}catch(t){console.error(t.stack),console.error(t.message),console.error("Failed to add menu bar")}this.screen.completeSetCSS(),this.screen.completeUpdate()}return i}loadFile(t,e={}){return new Promise(((i,s)=>{i(this.loadFileSync(t,e))}))}ensureMenuBar(){let t=this.screen,e=!1;for(let i of t.sareas)if(i.area instanceof MenuBarEditor){e=!0;break}if(e)return;if(!Editor.makeMenuBar)return;t.update();let i=UIBase$f.createElement("screenarea-x");t.appendChild(i);let s=(new Vector2$b).addScalar(1e17),r=(new Vector2$b).addScalar(-1e17),a=new Vector2$b;for(let e of t.sareas)e!==i&&(s.min(e.pos),a.load(e.pos).add(e.size),r.max(a));let n=(r[1]-s[1]-55)/(r[1]-s[1]);for(let e of t.sareas)e!==i&&(e.pos[1]*=n,e.size[1]*=n,e.pos[1]+=55);i.pos.zero(),i.size[0]=t.size[0],i.size[1]=55,t.regenScreenMesh(),t.snapScreenVerts(),i.switch_editor(MenuBarEditor),t.solveAreaConstraints(),t.completeSetCSS(),t.completeUpdate()}makeScreen(){this.screen&&(this.screen.unlisten(),this.screen.remove());let t=this.screen=UIBase$f.createElement(this.screenClass.define().tagname),e=UIBase$f.createElement("screenarea-x");t.ctx=this.ctx,e.ctx=this.ctx,document.body.appendChild(t);let i=this.defaultEditorClass;if(!i)for(let t in areaclasses)if(i=areaclasses[t],i!==MenuBarEditor)break;e.switch_editor(i),t.appendChild(e),t._init(),t.listen(),t.update(),t.completeSetCSS(),t.completeUpdate(),Editor.makeMenuBar&&this.ensureMenuBar()}start(t=new StartArgs){nstructjs.validateStructs();let e=new StartArgs,i=["saveFile","createNewFile","loadFile"];for(let t of i){AppState.prototype[t]===this[t]&&console.warn(`Warning: it is recommended to override .${t} when subclassing simple.AppState`)}document.body.style["touch-action"]="none",registerMenuBarEditor();for(let i in e)void 0===t[i]&&(t[i]=e[i]);t.registerSaveOpenOps&&register(),t.iconsheet||(t.iconsheet=loadDefaultIconSheet()),this.startArgs=t,exports.loadConstants(t),t.autoLoadSplineTemplates&&initSplineTemplates();let s=[],r=[];for(let e of t.iconSizes)s.push([t.iconTileSize,e]),r.push(t.iconsheet);window.iconsheet=t.iconsheet,setIconManager(new IconManager(r,s,t.iconsPerRow)),setIconMap(t.icons),t.theme&&setTheme(t.theme),document.body.style.margin="0px",document.body.style.padding="0px",t.singlePage&&(document.body.style.overflow="hidden"),this.makeScreen(),Object.defineProperty(window,"C",{get(){return this._appstate.ctx}}),nstructjs.validateStructs(),this.saveFilesInJSON&&!this._fileExtSet&&(this._fileExt="json"),this._fileExt.startsWith(".")&&(this._fileExt=this._fileExt.slice(1,this._fileExt.length).trim())}}class SimpleContext{constructor(){}static getContextClass(){let t={};console.log(t);for(let e in t)e.search("_save")>=0||e.search("_load")}}var simple=Object.freeze({__proto__:null,Menu:Menu,DataModelClasses:DataModelClasses,DataModel:DataModel,makeAPI:makeAPI,StartArgs:StartArgs,SimpleScreen:SimpleScreen,AppState:AppState,SideBar:SideBar,Editor:Editor,Icons:Icons,loadDefaultIconSheet:loadDefaultIconSheet,iconSvg:iconSvg,FileHeader:FileHeader,FileFull:FileFull,FileArgs:FileArgs,EmptyStruct:EmptyStruct,saveFile:saveFile,loadFile:loadFile,SimpleContext:SimpleContext,MenuBarEditor:MenuBarEditor,registerMenuBarEditor:registerMenuBarEditor});function getWebFilters(t=[]){let e=[];for(let i of t){let t=i.mime,s=[];for(let e of i.extensions)e="."+e,e.toLowerCase()in mimeMap&&(t=void 0!==t?t:mimeMap[e.toLowerCase()]),s.push(e);t||(t="application/x-octet-stream"),e.push({description:i.name,accept:{[t]:s}})}return e}setNotifier(ui_noteframe);class platform extends PlatformAPI{static showOpenDialog(t,e=new FileDialogArgs){let i=getWebFilters(e.filters);return new Promise(((t,s)=>{try{window.showOpenFilePicker({multiple:e.multi,types:i}).then((e=>{let i=[];for(let t of e)i.push(new FilePath(t,t.name));t(i)}))}catch(t){s(t)}}))}static writeFile(t,e,i){return(e=e.data).createWritable().then((e=>{e.write(t),e.close()}))}static showSaveDialog(t,e,i=new FileDialogArgs){if(!window.showSaveFilePicker)return this.showSaveDialog_old(...arguments);let s=getWebFilters(i.filters);return new Promise(((t,i)=>{let r,a,n;try{a=window.showSaveFilePicker({types:s})}catch(t){i(t)}a.then((t=>(n=t,r=n.name,console.log("saveHandle",n),n.createWritable()))).then((i=>{let s=e();(s instanceof Uint8Array||s instanceof DataView)&&(s=s.buffer),i.write(s),i.close();let a=new FilePath(n,r);t(a)}))}))}static showSaveDialog_old(t,e,i=new FileDialogArgs){let s=[];for(let t of i.filters){!Array.isArray(t)&&t.filters&&(t=t.filters);for(let e of t)s.push(e)}return new Promise(((t,i)=>{saveFile$1(e),window.setTimeout((()=>{t("undefined")}))}))}static readFile(t,e=""){if(""===e){let i=(e=t.filename).length-1;for(;i>0&&"."!==e[i];)i--;(e=e.slice(i,e.length).trim().toLowerCase())in mimeMap&&(e=mimeMap[e])}return new Promise(((i,s)=>{t.data.getFile().then((t=>{let s;console.log("file!",t),s=isMimeText(e)?t.text():t.arrayBuffer(),s.then((t=>{i(t)}))}))}))}}var web_api=Object.freeze({__proto__:null,getWebFilters:getWebFilters,platform:platform});export{AbstractCurve,Area$1 as Area,AreaFlags,AreaTypes,AreaWrangler,BSplineTransformOp,BaseVector,BoolProperty,BorderMask,BorderSides,BounceCurve,Button,ButtonEventBase,COLINEAR,COLINEAR_ISECT,CSSFont,CURVE_VERSION,CanvasOverdraw,Check,Check1,ClassIdSymbol,ClosestCurveRets,ClosestModes,ColorField,ColorPicker,ColorPickerButton,ColorSchemeTypes,ColumnFrame,Constraint,Container,Context,ContextFlags,ContextOverlay,Curve1D,Curve1DPoint,Curve1DProperty,Curve1DWidget,Curve1dBSplineAddOp,Curve1dBSplineDeleteOp,Curve1dBSplineLoadTemplOp,Curve1dBSplineOpBase,Curve1dBSplineResetOp,Curve1dBSplineSelectOp,CurveConstructors,CurveFlags,CurveTypeData,CustomIcon,DataAPI,DataFlags,DataList,DataPath,DataPathError,DataPathSetOp,DataStruct,DataTypes,DegreeUnit,DoubleClickHandler,DropBox,EaseCurve,ElasticCurve,ElementClasses,EnumKeyPair,EnumProperty$9 as EnumProperty,ErrorColors,EulerOrders,F32BaseVector,F64BaseVector,FEPS,FEPS_DATA,FLOAT_MAX,FLOAT_MIN,FileDialogArgs,FilePath,FlagProperty,FloatArrayProperty,FloatConstrinats,FloatProperty,FootUnit,HotKey,HueField,I16BaseVector,I32BaseVector,I8BaseVector,IconButton,IconCheck,IconLabel,IconManager,IconSheets$7 as IconSheets,Icons$2 as Icons,InchUnit,IntProperty,IntegerConstraints,IsMobile,KeyMap,LINECROSS,Label,LastToolPanel,ListIface,ListProperty,LockedContext,MacroClasses,MacroLink,Mat4Property,Mat4Stack,Matrix4$2 as Matrix4,Matrix4UI,Menu,MenuWrangler,MeterUnit,MileUnit,MinMax,ModalTabMove,ModelInterface,Note,NoteFrame,NumProperty,NumSlider,NumSliderSimple,NumSliderSimpleBase,NumSliderWithTextBox,NumberConstraints,NumberConstraintsBase,NumberSliderBase,OldButton,Overdraw,OverlayClasses,PackFlags$a as PackFlags,PackNode,PackNodeVertex,PanelFrame,ParamKey,Parser,PercentUnit,PixelUnit,PlaneOps,PlatformAPI,ProgBarNote,ProgressCircle,PropClasses,PropFlags$3 as PropFlags,PropSubTypes$3 as PropSubTypes,PropTypes$8 as PropTypes,Quat,QuatProperty,RadianUnit,RandCurve,ReportProperty,RichEditor,RichViewer,RowFrame,SQRT2,SVG_URL,SatValField,SavedToolDefaults,Screen,ScreenArea,ScreenBorder,ScreenHalfEdge,ScreenVert,SimpleBox,SimpleCurveBase,SliderDefaults,SliderWithTextbox,Solver,SplineTemplateIcons,SplineTemplates,SquareFootUnit,StringProperty,StringSetProperty,StructFlags,TabBar,TabContainer,TabItem,TableFrame,TableRow,TangentModes,TextBox,TextBoxBase,ThemeEditor,ToolClasses,ToolFlags$1 as ToolFlags,ToolMacro,ToolOp,ToolOpIface,ToolPaths,ToolProperty$1 as ToolProperty,ToolPropertyCache,ToolStack,ToolTip,TreeItem,TreeView,TwoColumnFrame,UI16BaseVector,UI32BaseVector,UI8BaseVector,UIBase$f as UIBase,UIFlags,UndoFlags$1 as UndoFlags,Unit,Units,ValueButtonBase,Vec2Property,Vec3Property,Vec4Property,VecPropertyBase,Vector2$b as Vector2,Vector3$2 as Vector3,Vector4$2 as Vector4,VectorPanel,VectorPopupButton,_NumberPropertyBase,_ensureFont,_getFont,_getFont_new,_old_isect_ray_plane,_onEventsStart,_onEventsStop,_setAreaClass,_setModalAreaClass,_setScreenClass,_setTextboxClass,_themeUpdateKey,aabb_intersect_2d,aabb_intersect_3d,aabb_isect_2d,aabb_isect_3d,aabb_isect_cylinder_3d,aabb_isect_line_2d,aabb_isect_line_3d,aabb_overlap_area,aabb_sphere_dist,aabb_sphere_isect,aabb_sphere_isect_2d,aabb_union,aabb_union_2d,angle_between_vecs,areaclasses,barycentric_v2,binomial,buildParser,buildString,buildToolOpAPI,buildToolSysAPI,calcThemeKey,calc_projection_axes,exports as cconst,checkForTextBox,circ_from_line_tan,circ_from_line_tan_2d,clip_line_w,closestPoint,closest_point_on_line,closest_point_on_quad,closest_point_on_tri,cmyk_to_rgb,colinear,colinear2d,color2css$1 as color2css,color2web,compatMap,config$1 as config,contextWrangler,controller,convert,convex_quad,copyEvent,copyTheme,corner_normal,createMenu,css2color$1 as css2color,customHandlers,customPropertyTypes,defaultDecimalPlaces,defaultRadix,dihedral_v3_sqr,dist_to_line,dist_to_line_2d,dist_to_line_sqr,dist_to_tri_v3,dist_to_tri_v3_old,dist_to_tri_v3_sqr,domEventAttrs,domTransferAttrs,dpistack,drawRoundBox,drawRoundBox2,drawText,electron_api$1 as electron_api,error,evalHermiteTable,eventWasTouch,eventdag as eventgraph,excludedKeys,expand_line,expand_rect2d,exportTheme,feps,flagThemeUpdate,genHermiteTable,gen_circle,getAreaIntName,getCurve,getDataPathToolOp,getDefault,getFieldImage,getFont,getHueField,getIconManager,getLastToolStruct,getMime,getNoteFrames,getTagPrefix,getTempProp,getVecClass,getWranglerScreen,get_boundary_winding,get_rect_lines,get_rect_points,get_tri_circ,graphGetIslands,graphPack,haveModal,hsv_to_rgb,html5_fileapi,iconSheetFromPackFlag,iconmanager$1 as iconmanager,initPage,initSimpleController,initSplineTemplates,initToolPaths,inrect_2d,internalSetTimeout,inv_sample,invertTheme,isLeftClick,isMimeText,isMouseDown,isNum,isNumber,isVecProperty,isect_ray_plane,keymap$4 as keymap,keymap_latin_1,line_isect,line_line_cross,line_line_isect,loadFile$1 as loadFile,loadPage,loadUIData,lzstring,makeCircleMesh,makeDerivedOverlay,makeIconDiv,makeVector2,makeVector3,makeVector4,marginPaddingCSSKeys,math,measureText,measureTextBlock,menuWrangler,message,mimeMap,minmax_verts,modalstack$1 as modalstack,normal_poly,normal_quad,normal_quad_old,normal_tri,noteframes,nstructjs,parseToolPath,parseValue,parseValueIntern,parseXML,parsepx$4 as parsepx,parseutil,pathDebugEvent,pathParser,platform$3 as platform,point_in_aabb,point_in_aabb_2d,point_in_hex,point_in_tri,popModalLight,popReportName,progbarNote,project,purgeUpdateStack,pushModalLight,pushPointerModal,pushReportName,quad_bilinear,registerTool,registerToolStackGetter,report,reverse_keymap,rgb_to_cmyk,rgb_to_hsv,rot2d,sample,saveFile$1 as saveFile,saveUIData,sendNote,setAreaTypes,setBaseUnit,setColorSchemeType,setContextClass,setDataPathToolOp,setDefaultUndoHandlers,setIconManager,setIconMap,setImplementationClass,setKeyboardDom,setKeyboardOpts,setMetric,setNotifier,setPropTypes,setScreenClass,setTagPrefix,setTheme,setWranglerScreen,simple,simple_tri_aabb_isect,singleMouseEvent,sliderDomAttributes,solver,startEvents,startMenu,startMenuEventWrangling,stopEvents,styleScrollBars$1 as styleScrollBars,tab_idgen,test,testToolParser,tet_volume,textMimes,theme,toolprop_abstract,tri_angles,tri_area,trilinear_co,trilinear_co2,trilinear_v3,unproject,util,validateCSSColor$1 as validateCSSColor,validateWebColor,vectormath,warning,web2color,winding,winding_axis};
//# sourceMappingURL=pathux.min.js.map
